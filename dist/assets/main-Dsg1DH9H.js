const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/gate-judge-BoK1XIvH.js","assets/chief-judge-DtBsPpo-.js","assets/vendor-signals-BzS5ZRDx.js"])))=>i.map(i=>d[i]);
var ot=Object.defineProperty;var rt=(t,e,n)=>e in t?ot(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var k=(t,e,n)=>rt(t,typeof e!="symbol"?e+"":e,n);import{s as te,o as J,g as U,d as xe,c as Y,i as ct,e as lt,f as dt,h as O,j as W,k as Re,l as Be,r as ut,m as gt,a as ft,b as mt,n as pt,p as yt,u as ht,q as bt,_ as pe}from"./gate-judge-BoK1XIvH.js";import{s as r,N as q,p as x,L as B,l as vt,a as y,t as c,m as St,Q as ye,ae as Et,O as wt,af as It,c as f,o as p,a6 as Lt,ag as w,a7 as Ct,r as b,V as he,d as ce,f as Te,a8 as V,D as De,C as $e,y as Ve,x as qe,k as Pe,a0 as $,ah as K,ai as X,n as N,aj as kt,ak as Z,al as be,S as Me,am as ve,an as At,ao as xt,$ as Se,X as Rt,a2 as Bt,ap as Tt,e as _,q as Dt,W as $t,aq as Vt,Y as Ne,ar as qt,as as Pt,at as Mt,u as Ee}from"./chief-judge-DtBsPpo-.js";import{c as se,d as Nt,u as Oe,a as Fe,b as Ot,g as Je,i as Ft}from"./results-UMVXoHr8.js";import{h as Jt,c as Ue,u as Ut,a as He,b as ze,d as _e,e as Ht,s as zt,r as we,f as _t,g as Ie,i as Ge,v as Gt,j as Wt,k as jt,l as Yt,m as Kt,n as Le,o as Xt,p as Zt}from"./settings-DnO5HGpg.js";import{c as Qt,i as en,a as Q,u as We,d as tn,b as nn}from"./timer-BmaAk6Yy.js";import{m as an}from"./vendor-signals-BzS5ZRDx.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function n(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=n(a);fetch(a.href,i)}})();async function Ce(t){const e=r.getState(),n=t.map(s=>s.id);if(n.length===1?r.deleteEntry(n[0]):r.deleteMultiple(n),n.length===1?await q.deletePhoto(n[0]):await q.deletePhotos(n),e.settings.sync&&e.raceId)for(const s of t)x.deleteEntryFromCloud(s.id,s.deviceId)}function sn(t,e){t&&(te(t,e),J(t))}function on(t,e,n,s){t&&t.querySelectorAll(e).forEach(a=>{const i=a.getAttribute(n)===s;a.classList.toggle("active",i)})}const C=new B;function rn(){document.querySelectorAll(".modal-overlay").forEach(u=>{C.add(u,"click",m=>{m.target===u&&H()})}),document.querySelectorAll('[data-action="cancel"]').forEach(u=>{C.add(u,"click",H)});const t=document.getElementById("confirm-delete-btn");t&&C.add(t,"click",dn);const e=document.getElementById("confirm-fault-delete-btn");e&&C.add(e,"click",()=>{var h;const u=document.getElementById("fault-delete-modal"),m=u?(h=U(u))==null?void 0:h.faultId:void 0;if(m){r.markFaultForDeletion(m);const S=r.getState().faultEntries.find(g=>g.id===m);S&&vt(S),xe(),y(c("faultDeleted",r.getState().currentLang),"success")}Y(u)});const n=document.getElementById("save-edit-btn");n&&C.add(n,"click",un);const s=document.getElementById("edit-bib-input");s&&St(s,3);const a=document.getElementById("edit-run-selector");a&&C.add(a,"click",u=>{const h=u.target.closest(".edit-run-btn");if(!h)return;const S=document.getElementById("edit-modal"),g=h.getAttribute("data-run")||"1";if(S){const v=U(S)||{entryId:"",entryRun:1};te(S,{...v,entryRun:parseInt(g,10)})}document.querySelectorAll(".edit-run-btn").forEach(v=>{v.classList.toggle("active",v===h)})});const i=document.getElementById("photo-viewer-close-btn");i&&C.add(i,"click",se);const o=document.getElementById("photo-viewer-close-footer-btn");o&&C.add(o,"click",se);const l=document.getElementById("photo-viewer-delete-btn");l&&C.add(l,"click",Nt);const d=document.getElementById("photo-viewer-modal");d&&C.add(d,"click",u=>{u.target===d&&se()}),ct()}function cn(t){const e=document.getElementById("edit-modal");if(!e)return;const n=t.run??1,s=document.getElementById("edit-bib-input"),a=document.getElementById("edit-status-select");s&&(s.value=t.bib||""),a&&(a.value=t.status),on(document.body,".edit-run-btn","data-run",String(n)),sn(e,{entryId:t.id,entryRun:n})}function je(t){const e=document.getElementById("confirm-modal");if(!e)return;const n=r.getState().currentLang,s=e.querySelector(".modal-title"),a=e.querySelector(".modal-text"),i=U(e)||{};if(te(e,{...i,action:t}),t==="clearAll")s&&(s.textContent=c("confirmClearAll",n)),a&&(a.textContent=c("clearAllText",n));else if(t==="deleteSelected"){const o=r.getState().selectedEntries.size,l=o===1?c("entry",n):c("entries",n);s&&(s.textContent=c("confirmDelete",n)),a&&(a.textContent=`${o} ${l} ${c("selected",n)}`)}else t==="undoAdd"?(s&&(s.textContent=c("confirmUndoAdd",n)),a&&(a.textContent=c("confirmUndoAddText",n))):(s&&(s.textContent=c("confirmDelete",n)),a&&(a.textContent=c("confirmDeleteText",n)));J(e)}function ln(t){const e=document.getElementById("confirm-modal");e&&te(e,{action:"delete",entryId:t.id}),je("delete")}async function dn(){const t=document.getElementById("confirm-modal");if(!t)return;const e=U(t),n=e==null?void 0:e.action,s=e==null?void 0:e.entryId,a=r.getState();if(n==="clearAll"){const i=[...a.entries];if(r.clearAll(),await q.clearAll(),a.settings.sync&&a.raceId)for(const o of i)x.deleteEntryFromCloud(o.id,o.deviceId);y(c("cleared",a.currentLang),"success")}else if(n==="deleteSelected"){const i=Array.from(a.selectedEntries),o=a.entries.filter(l=>i.includes(l.id));await Ce(o),y(c("deleted",a.currentLang),"success")}else if(n==="undoAdd"){const i=r.undo();if(ye(),y(c("undone",a.currentLang),"success"),i&&i.type==="ADD_ENTRY"){const o=i.data;await q.deletePhoto(o.id),a.settings.sync&&a.raceId&&x.deleteEntryFromCloud(o.id,o.deviceId)}H();return}else if(s){const i=a.entries.find(d=>d.id===s);i&&await Ce([i]);const o=a.currentLang;Et();const l={label:c("undoAction",o),callback:()=>{if(r.canUndo()){const d=r.undo();if(ye(),d&&d.type==="DELETE_ENTRY"){const u=d.data;It(u).catch(()=>{})}}}};y(c("entryDeleted",o),"success",5e3,{action:l})}wt(),H()}function un(){const t=document.getElementById("edit-modal");if(!t)return;const e=U(t),n=e==null?void 0:e.entryId;if(!n)return;const s=document.getElementById("edit-bib-input"),a=document.getElementById("edit-status-select"),i=(e==null?void 0:e.entryRun)??1;r.updateEntry(n,{bib:(s==null?void 0:s.value.padStart(3,"0"))||"",status:a==null?void 0:a.value,run:i}),y(c("saved",r.getState().currentLang),"success"),H()}function H(){const t=document.getElementById("admin-pin-modal");if(t!=null&&t.classList.contains("show")&&Jt()){Ue();const e=document.getElementById("admin-pin-verify-input");e&&(e.value="")}document.querySelectorAll(".modal-overlay").forEach(e=>{lt(e)}),dt()}const R=new B;let A=null;const P=new Set;function gn(t){return t?/^0+$/.test(t):!1}function fn(){A&&(A.destroy(),A=null);const t=p("clock-container");t&&(A=new Lt(t),A.start())}function mn(){A&&(A.destroy(),A=null)}function pn(){const t=document.querySelectorAll(".tab-btn"),e=()=>Array.from(t).filter(n=>n.style.display!=="none");t.forEach(n=>{R.add(n,"click",()=>{const s=n.getAttribute("data-view");s&&(r.setView(s),f(),t.forEach(a=>{a.setAttribute("aria-selected",a===n?"true":"false")}))}),R.add(n,"keydown",s=>{const a=s,i=e(),o=i.indexOf(n);let l=o;switch(a.key){case"ArrowLeft":case"ArrowUp":a.preventDefault(),l=o>0?o-1:i.length-1;break;case"ArrowRight":case"ArrowDown":a.preventDefault(),l=o<i.length-1?o+1:0;break;case"Home":a.preventDefault(),l=0;break;case"End":a.preventDefault(),l=i.length-1;break;default:return}if(l!==o){const d=i[l];d.focus(),d.click()}})})}function yn(){const t=p("number-pad"),e=p("bib-display");e&&t&&(e.setAttribute("aria-expanded","true"),R.add(e,"click",()=>{const n=t.classList.toggle("collapsed");e.classList.toggle("expanded",!n),e.setAttribute("aria-expanded",String(!n)),f()})),t&&R.add(t,"click",n=>{const a=n.target.closest(".num-btn");if(!a)return;const i=a.getAttribute("data-num"),o=a.getAttribute("data-action");if(i){const l=r.getState();l.bibInput.length<3&&(r.setBibInput(l.bibInput+i),f())}else if(o==="clear")r.setBibInput(""),f();else if(o==="delete"){const l=r.getState();r.setBibInput(l.bibInput.slice(0,-1)),f()}})}function hn(){const t=p("timing-points");t&&R.add(t,"click",e=>{const s=e.target.closest(".timing-point-btn");if(!s)return;const a=s.getAttribute("data-point");a&&(r.setSelectedPoint(a),f(),t.querySelectorAll(".timing-point-btn").forEach(i=>{i.setAttribute("aria-checked",i===s?"true":"false")}))})}function bn(){const t=p("run-selector");t&&R.add(t,"click",e=>{const s=e.target.closest(".run-btn");if(!s)return;const a=s.getAttribute("data-run"),i=a?parseInt(a,10):1;r.setSelectedRun(i),f(),t.querySelectorAll(".run-btn").forEach(o=>{o.setAttribute("aria-checked",o===s?"true":"false")})})}function vn(){const t=p("timestamp-btn");t&&(R.add(t,"click",async()=>{if(w.isActive()){w.exitAmbientMode(),f();return}await ke()}),R.add(document,"keydown",(e=>{var a;const n=(a=document.activeElement)==null?void 0:a.tagName,s=r.getState();if(!(n==="INPUT"||n==="TEXTAREA"||n==="SELECT")&&s.currentView==="timer"){if(/^[0-9]$/.test(e.key)){e.preventDefault(),s.bibInput.length<3&&(r.setBibInput(s.bibInput+e.key),f());return}if(e.key==="Backspace"){e.preventDefault(),r.setBibInput(s.bibInput.slice(0,-1)),f();return}if(e.key==="Delete"||e.key==="Escape"){e.preventDefault(),r.setBibInput(""),f();return}if(e.key==="s"||e.key==="S"){e.preventDefault(),r.setSelectedPoint("S"),f(),document.querySelectorAll(".timing-point-btn").forEach(i=>{i.setAttribute("aria-checked",i.getAttribute("data-point")==="S"?"true":"false")});return}if(e.key==="f"||e.key==="F"){e.preventDefault(),r.setSelectedPoint("F"),f(),document.querySelectorAll(".timing-point-btn").forEach(i=>{i.setAttribute("aria-checked",i.getAttribute("data-point")==="F"?"true":"false")});return}if(e.key==="1"&&e.altKey){e.preventDefault(),r.setSelectedRun(1),f();return}if(e.key==="2"&&e.altKey){e.preventDefault(),r.setSelectedRun(2),f();return}if(e.key===" "||e.key==="Enter"){if(e.preventDefault(),w.isActive()){w.exitAmbientMode(),f();return}ke();return}}})))}async function ke(){const t=r.getState();if(t.isRecording)return;const{entry:e}=Qt({bib:t.bibInput,point:t.selectedPoint,run:t.selectedRun,deviceId:t.deviceId,deviceName:t.deviceName,gpsService:V});r.setRecording(!0);try{if(t.settings.photoCapture){const a=e.id;Ct().then(async i=>{if(i)try{if(!r.getState().entries.some(u=>u.id===a)){b.warn("Entry was deleted before photo could be attached:",a);return}if(await q.savePhoto(a,i))r.updateEntry(a,{photo:"indexeddb"})||(b.warn("Entry deleted during photo save, removing orphaned photo:",a),await q.deletePhoto(a));else{b.warn("Photo save failed for entry:",a);const u=r.getState().currentLang;y(c("photoSaveFailed",u),"warning")}}catch(o){he("Camera","photo save/update",o,"photoError")}}).catch(i=>{if(i instanceof Error&&i.name==="PhotoTooLargeError"){const o=r.getState().currentLang;y(c("photoTooLarge",o),"warning")}else he("Camera","captureTimingPhoto",i,"photoError")})}const n=en(e,t.entries),s=gn(e.bib);if(r.addEntry(e),n?(ce(),En(e)):s?(ce(),wn(e)):(Te(),de(e)),x.broadcastEntry(e),t.settings.auto&&t.bibInput){const a=parseInt(t.bibInput,10)+1,i=t.settings.sync&&t.cloudHighestBib>0?Math.max(a,t.cloudHighestBib+1):a;r.setBibInput(String(i))}else t.bibInput?t.settings.auto||r.setBibInput(""):r.setBibInput("");In(e)}finally{r.setRecording(!1)}}function de(t){const e=p("confirmation-overlay");if(!e)return;const n=e.querySelector(".confirmation-bib"),s=e.querySelector(".confirmation-point"),a=e.querySelector(".confirmation-run"),i=e.querySelector(".confirmation-time"),o=r.getState();if(n&&(n.textContent=t.bib||"---"),s&&(s.textContent=De(t.point,o.currentLang),s.style.color=$e(t.point)),a&&t.run&&(a.textContent=Ve(t.run,o.currentLang),a.style.color=qe(t.run)),i){const d=new Date(t.timestamp);i.textContent=Pe(d)}e.dataset.point=t.point,e.classList.add("show"),Sn(t.point);const l=window.setTimeout(()=>{e.classList.remove("show"),P.delete(l)},1500);P.add(l)}function Sn(t){const e=document.getElementById("snowflake-burst");if(!e)return;e.innerHTML="";const n=t==="S"?"var(--start-color)":"var(--finish-color)",s=8;for(let a=0;a<s;a++){const i=document.createElement("span");i.className="flake",i.textContent="❄";const o=a/s*2*Math.PI,l=60+Math.random()*40,d=Math.cos(o)*l,u=Math.sin(o)*l,m=Math.random()*360;i.style.cssText=`
      --burst-x: ${d}px;
      --burst-y: ${u}px;
      --burst-rot: ${m}deg;
      color: ${n};
      font-size: ${.6+Math.random()*.6}rem;
      animation-duration: ${.6+Math.random()*.4}s;
      text-shadow: 0 0 6px ${n};
    `,i.addEventListener("animationend",()=>i.remove(),{once:!0}),e.appendChild(i)}}function En(t){const e=p("confirmation-overlay");if(!e)return;const n=e.querySelector(".confirmation-duplicate");n&&(n.style.display="flex"),de(t);const s=window.setTimeout(()=>{n&&(n.style.display="none"),P.delete(s)},2500);P.add(s)}function wn(t){const e=p("confirmation-overlay");if(!e)return;const n=e.querySelector(".confirmation-zero-bib");n&&(n.style.display="flex"),de(t);const s=window.setTimeout(()=>{n&&(n.style.display="none"),P.delete(s)},2500);P.add(s)}function In(t){const e=p("last-recorded-inline");if(!e)return;const n=e.querySelector(".bib"),s=e.querySelector(".point"),a=e.querySelector(".run"),i=e.querySelector(".time"),o=r.getState();if(n&&(n.textContent=t.bib||"---"),s&&(s.textContent=De(t.point,o.currentLang),s.style.color=$e(t.point)),a&&t.run&&(a.textContent=Ve(t.run,o.currentLang),a.style.color=qe(t.run)),i){const l=new Date(t.timestamp);i.textContent=Pe(l)}e.classList.add("visible"),e.classList.remove("pulse"),e.offsetWidth,e.classList.add("pulse")}function ue(){const t=r.getState(),e=p("bib-display"),n=e==null?void 0:e.querySelector(".bib-value");n&&(n.textContent=t.bibInput?t.bibInput.padStart(3,"0"):"---");const s=p("timestamp-btn");s&&s.classList.toggle("ready",t.bibInput.length>0)}function ge(){const t=r.getState();document.querySelectorAll(".timing-point-btn").forEach(e=>{const n=e.getAttribute("data-point")===t.selectedPoint;e.classList.toggle("active",n),e.setAttribute("aria-checked",String(n))})}function fe(){const t=r.getState();document.querySelectorAll(".run-btn").forEach(e=>{const n=e.getAttribute("data-run")===String(t.selectedRun);e.classList.toggle("active",n),e.setAttribute("aria-checked",String(n))})}function Ln(t){var e,n,s;switch(b.debug("[TimerView] Voice intent:",t.action,t.params),t.action){case"set_bib":(e=t.params)!=null&&e.bib&&(r.setBibInput(t.params.bib),ue(),f());break;case"set_point":(n=t.params)!=null&&n.point&&(r.setSelectedPoint(t.params.point),ge(),f());break;case"set_run":(s=t.params)!=null&&s.run&&(r.setSelectedRun(t.params.run),fe(),f());break;default:b.debug("[TimerView] Unhandled voice intent:",t.action)}}function Cn(){Ye(),Q()?We():(ue(),ge()),fe(),Oe(),Fe(),z(),ne(),O(),Ke(),Xe(),Ut(),He()}function kn(t){return t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}function Ye(){const t=r.getState();document.querySelectorAll(".view").forEach(s=>{s.classList.remove("active")});const e=kn(t.currentView),n=document.querySelector(`.${e}-view`);n&&n.classList.add("active"),document.querySelectorAll(".tab-btn").forEach(s=>{s.classList.toggle("active",s.getAttribute("data-view")===t.currentView)}),t.currentView==="gateJudge"&&(W(),Re(),Be(),ut())}function z(){var o,l;const t=r.getState(),e=p("sync-indicator"),n=(o=p("sync-indicator"))==null?void 0:o.querySelector(".sync-dot"),s=(l=p("sync-indicator"))==null?void 0:l.querySelector(".sync-status-text"),a=p("sync-device-count");e&&(e.style.display=t.settings.sync?"flex":"none");const i=t.currentLang;if(n){n.classList.remove("connected","error","offline","syncing"),t.syncStatus==="connected"?n.classList.add("connected"):t.syncStatus==="syncing"?n.classList.add("syncing"):t.syncStatus==="error"?n.classList.add("error"):t.syncStatus==="offline"&&n.classList.add("offline");const d=t.syncStatus==="connected"?c("syncOnline",i):t.syncStatus==="error"?c("syncError",i):t.syncStatus==="offline"?c("syncOffline",i):c("syncing",i);n.setAttribute("aria-label",d)}if(s){const d={connected:c("syncShortConnected",i),syncing:c("syncShortSyncing",i),error:c("syncShortError",i),offline:c("syncShortOff",i),disconnected:c("syncShortOff",i),connecting:c("syncShortSyncing",i)};s.textContent=d[t.syncStatus]||c(t.syncStatus,i)}if(e){const d=t.syncStatus==="connected"?`${c("syncOnline",i)}${t.cloudDeviceCount>0?` - ${t.cloudDeviceCount} ${c("devices",i)}`:""}`:t.syncStatus==="error"?c("syncError",i):t.syncStatus==="offline"?c("syncOffline",i):c("syncing",i);e.setAttribute("aria-label",d)}a&&(t.syncStatus==="connected"&&t.cloudDeviceCount>0?(a.textContent=`${t.cloudDeviceCount} ${c("syncDeviceAbbrev",i)}`,a.style.display="inline",a.classList.add("status-active")):t.syncStatus==="error"||t.syncStatus==="offline"?(a.textContent=c("syncShortOff",i),a.style.display="inline",a.classList.remove("status-active")):a.style.display="none")}function ne(){const t=r.getState(),e=p("gps-indicator"),n=e==null?void 0:e.querySelector(".gps-dot"),s=e==null?void 0:e.querySelector(".gps-status-text");if(e&&(e.style.display=t.settings.gps?"flex":"none"),n){n.classList.remove("active","searching","paused"),t.gpsStatus==="active"?n.classList.add("active"):t.gpsStatus==="searching"?n.classList.add("searching"):t.gpsStatus==="paused"&&n.classList.add("paused");const a=t.currentLang,i=t.gpsStatus==="active"||t.gpsStatus==="paused"?"gpsActive":t.gpsStatus==="searching"?"gpsSearching":"gpsInactive";n.setAttribute("aria-label",c(i,a))}if(s&&(t.gpsStatus==="active"||t.gpsStatus==="paused"?(s.textContent="GPS",s.classList.add("status-active"),s.classList.remove("status-inactive","status-searching")):t.gpsStatus==="searching"?(s.textContent="GPS...",s.classList.add("status-searching"),s.classList.remove("status-active","status-inactive")):(s.textContent="GPS Off",s.classList.add("status-inactive"),s.classList.remove("status-active","status-searching"))),e){const a=t.currentLang,i=t.gpsStatus==="active"||t.gpsStatus==="paused"?"gpsActive":t.gpsStatus==="searching"?"gpsSearching":"gpsInactive";e.setAttribute("aria-label",c(i,a))}}function Ke(){const t=r.getState(),e=p("camera-indicator");e&&(e.style.display=t.settings.photoCapture?"flex":"none")}function An(t){const e=p("voice-indicator"),n=p("voice-status-text");if(e){if(t==="inactive"){e.style.display="none";return}if(e.style.display="flex",e.classList.remove("listening","processing","confirming","offline","error"),e.classList.add(t),n){const s=r.getState().currentLang;switch(t){case"listening":n.textContent=c("voiceListening",s);break;case"processing":n.textContent=c("voiceProcessing",s);break;case"confirming":n.textContent=c("voiceConfirming",s);break;case"offline":n.textContent=c("voiceOffline",s);break;case"error":n.textContent=c("voiceError",s);break}}}}function Xe(){const t=p("undo-btn");t&&t.toggleAttribute("disabled",!r.canUndo())}const E=new B,ee=new Set;function I(t,e,n){const s=e.getBoundingClientRect();let a,i;typeof TouchEvent<"u"&&t instanceof TouchEvent&&t.touches.length>0?(a=t.touches[0].clientX-s.left,i=t.touches[0].clientY-s.top):typeof MouseEvent<"u"&&t instanceof MouseEvent?(a=t.clientX-s.left,i=t.clientY-s.top):(a=s.width/2,i=s.height/2);const o=document.createElement("span");o.classList.add("ripple"),n&&o.classList.add(`ripple-${n}`);const l=Math.max(s.width,s.height)*2;o.style.width=`${l}px`,o.style.height=`${l}px`,o.style.left=`${a-l/2}px`,o.style.top=`${i-l/2}px`,e.appendChild(o);const d=setTimeout(()=>{o.remove(),ee.delete(d)},500);ee.add(d)}function xn(){document.querySelectorAll(".num-btn").forEach(e=>{e.classList.add("ripple-container"),E.add(e,"touchstart",n=>I(n,e),{passive:!0}),E.add(e,"mousedown",n=>I(n,e))});const t=document.querySelector(".timestamp-btn");t&&(t.classList.add("ripple-container"),E.add(t,"touchstart",e=>I(e,t,"primary"),{passive:!0}),E.add(t,"mousedown",e=>I(e,t,"primary"))),document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.add("ripple-container");const n=e.getAttribute("data-point")==="S";E.add(e,"touchstart",s=>I(s,e,n?"success":"secondary"),{passive:!0}),E.add(e,"mousedown",s=>I(s,e,n?"success":"secondary"))}),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.add("ripple-container"),E.add(e,"touchstart",n=>I(n,e,"primary"),{passive:!0}),E.add(e,"mousedown",n=>I(n,e,"primary"))}),document.querySelectorAll(".action-btn").forEach(e=>{e.classList.add("ripple-container"),E.add(e,"touchstart",n=>I(n,e),{passive:!0}),E.add(e,"mousedown",n=>I(n,e))}),document.querySelectorAll(".modal-btn").forEach(e=>{e.classList.add("ripple-container");const n=e.classList.contains("primary"),s=e.classList.contains("danger"),a=n?"primary":s?"secondary":void 0;E.add(e,"touchstart",i=>I(i,e,a),{passive:!0}),E.add(e,"mousedown",i=>I(i,e,a))})}function Rn(){E.removeAll(),ee.forEach(t=>clearTimeout(t)),ee.clear()}const Ze=new B;function L(t,e){Ze.add(window,t,e)}function Bn(){L("open-edit-modal",(t=>{cn(t.detail.entry)})),L("prompt-delete",(t=>{ln(t.detail.entry)})),L("open-confirm-modal",(t=>{je(t.detail.action)})),L("request-photo-sync-warning",(async()=>{try{await zt(),we()}catch(t){b.error("Photo sync warning modal failed:",t),we()}})),L("request-race-change-dialog",(async t=>{try{const e=t,n=await _t(e.detail.type,e.detail.lang);Ie(n)}catch(e){b.error("Race change dialog failed:",e),Ie("cancel")}})),L("update-role-toggle",(()=>{Ge()})),L("request-pin-verification",(async t=>{try{const n=await Gt(t.detail.lang);be(n)}catch(e){b.error("PIN verification failed:",e),be(!1)}})),L("open-fault-edit-modal",(t=>{ft(t.detail.fault)})),L("open-mark-deletion-modal",(t=>{mt(t.detail.fault)})),L("update-inline-faults-list",(()=>{xe()})),L("update-inline-bib-selector",(()=>{pt()})),L("update-inline-gate-selector",(()=>{yt()}))}function Tn(){if(!N.isSupported()){b.debug("[VoiceMode] Not supported in this browser");return}const t="/api/v1/voice",e=window.VOICE_LLM_CONFIG,n={endpoint:(e==null?void 0:e.endpoint)||t,apiKey:(e==null?void 0:e.apiKey)||"proxy"};if(!N.initialize(n)){b.warn("[VoiceMode] Failed to initialize");return}N.onStatusChange(a=>{An(a)}),N.onAction(a=>{r.getState().deviceRole==="gateJudge"?gt(a):Ln(a)}),b.debug("[VoiceMode] Initialized successfully")}function Qe(t){const{isQuotaError:e,entryCount:n}=t.detail,s=r.getState().currentLang;e?y(c("storageNearlyFull",s),"error",Z.CRITICAL):y(c("storageError",s),"error",Z.ERROR),ce(),b.error("[Storage] saveEntries:",t.detail.message,{entryCount:n,isQuotaError:e})}function et(t){const{percent:e,critical:n}=t.detail,s=r.getState().currentLang;n?y(`${c("storageQuotaError",s)} (${e}%)`,"error",Z.CRITICAL):sessionStorage.getItem("storage-warning-shown")||(y(c("storageNearlyFull",s),"warning",Z.WARNING),sessionStorage.setItem("storage-warning-shown","true"))}function Dn(){try{$.flush()}catch(t){b.warn("Storage flush error on unload:",t)}try{mn(),tn()}catch(t){b.warn("Timer cleanup error:",t)}x.cleanup(),K.stop(),V.stop(),X.disable(),w.cleanup(),N.cleanup(),kt(),Rn(),document.querySelectorAll(".ripple").forEach(t=>t.remove()),window.removeEventListener("race-deleted",ze),window.removeEventListener("auth-expired",_e),window.removeEventListener("storage-error",Qe),window.removeEventListener("storage-warning",et),Ze.removeAll(),Ot(),Ht(),Ue()}function le(t){const e=t.currentView==="timer";e&&t.settings.gps?V.start():t.settings.gps?V.pause():V.stop(),e&&t.settings.photoCapture?K.initialize():K.stop()}const G=new B;function $n(){if(r.getState().settings.sync&&r.getState().raceId)if(Me())x.initialize();else{r.updateSettings({sync:!1});const a=document.getElementById("sync-toggle");a&&(a.checked=!1),setTimeout(()=>{const i=r.getState().currentLang;y(c("syncRequiresPin",i),"info",5e3)},500)}le(r.getState()),G.add(window,"race-deleted",ze),G.add(window,"auth-expired",_e),G.add(window,"storage-error",Qe),G.add(window,"storage-warning",et),document.addEventListener("click",ve,{once:!0}),document.addEventListener("touchstart",ve,{once:!0}),Wt();const e=r.getState();e.currentView==="timer"&&X.enable(),e.settings.ambientMode&&(w.initialize(),e.currentView==="timer"&&w.enable()),w.subscribe(a=>{document.body.classList.toggle("ambient-mode",a.isActive),a.triggeredBy?document.body.dataset.ambientTrigger=a.triggeredBy:delete document.body.dataset.ambientTrigger;const i=r.getState();i.settings.gps&&(a.isActive?V.pause():i.currentView==="timer"&&V.start())});let n=e.settings.photoCapture;const s=r.subscribe((a,i)=>{if(i.includes("settings")){const o=a.settings.photoCapture;n&&!o&&K.stop(),n=o}});window.addEventListener("beforeunload",()=>s(),{once:!0}),Tn()}const Vn={bibInput:[()=>{Q()?We():ue()}],selectedPoint:[()=>{Q()||ge()}],selectedRun:[t=>{fe(),Be(),t.currentView==="gateJudge"&&W()}],entries:[t=>{const e=Je();e&&e.setEntries(t.entries),Oe(),Fe(),t.currentView==="gateJudge"&&W()}],deviceRole:[()=>{Ge(),ht(),O()}],isJudgeReady:[()=>O()],gateAssignment:[()=>Re()],faultEntries:[t=>{t.currentView==="gateJudge"&&W()}],syncStatus:[()=>z()],cloudDeviceCount:[()=>z()],gpsStatus:[()=>{ne(),O()}],undoStack:[()=>Xe()]};function qn(t){Ye(),ne(),z(),t.currentView==="timer"?X.enable():X.disable(),t.currentView==="timer"&&t.settings.ambientMode?w.enable():w.disable();const e=Je();e&&(t.currentView==="results"?e.resume():e.pause())}function Pn(){z(),ne(),O(),Ke(),jt();const t=r.getState();t.settings.ambientMode?(w.initialize(),t.currentView==="timer"&&w.enable()):w.disable()}function Mn(t,e){e.includes("currentView")&&qn(t),e.includes("settings")&&(Pn(),le(t)),e.includes("currentView")&&!e.includes("settings")&&le(t);for(const n of e){const s=Vn[n];if(s)for(const a of s)a(t)}}let ae=!1;const ie=new B;function tt(){if(ae)return;const t=document.getElementById("offline-banner");if(t){const e=r.getState().currentLang,n=document.getElementById("offline-banner-text");n&&(n.textContent=c("offlineBanner",e)),t.classList.remove("hidden")}}function nt(){const t=document.getElementById("offline-banner");t&&t.classList.add("hidden")}function Nn(){nt(),ae=!1;const t=r.getState().currentLang;y(c("onlineRestored",t),"success",2e3)}function On(){ae=!1,tt()}function Fn(){const t=document.getElementById("offline-banner-dismiss");t&&ie.add(t,"click",()=>{ae=!0,nt()}),ie.add(window,"online",Nn),ie.add(window,"offline",On),navigator.onLine||tt()}const oe="skiTimerHasCompletedOnboarding";class Jn{constructor(){k(this,"modal");k(this,"currentStep",1);k(this,"totalSteps",6);k(this,"selectedRole","timer");k(this,"updateTranslationsCallback",null);k(this,"recentRacesDocumentHandler",null);k(this,"listeners",new B);this.modal=document.getElementById("onboarding-modal"),this.modal&&this.setupEventListeners()}setUpdateTranslationsCallback(e){this.updateTranslationsCallback=e}shouldShow(){return $.getRaw(oe)!=="true"}show(){if(!this.modal)return;this.currentStep=1,this.selectedRole="timer",this.modal.querySelectorAll(".onboarding-card").forEach((m,h)=>{m.style.display=h===0?"block":"none"});const e=document.getElementById("onboarding-race-id");e&&(e.value="");const n=document.getElementById("onboarding-pin");n&&(n.value="",n.style.display="none");const s=document.getElementById("onboarding-race-status");s&&(s.textContent="",s.className="race-status");const a=document.getElementById("onboarding-sync-toggle");a&&(a.checked=!0);const i=document.getElementById("onboarding-photo-toggle");i&&(i.checked=!1),this.modal.querySelectorAll(".role-card").forEach(m=>{const h=m.getAttribute("data-role")==="timer";m.classList.toggle("selected",h),m.setAttribute("aria-checked",String(h))});const o=document.getElementById("onboarding-gate-start"),l=document.getElementById("onboarding-gate-end");o&&(o.value="1"),l&&(l.value="10"),this.updateUI(),J(this.modal);const d=document.getElementById("onboarding-device-name");d&&(d.value=r.getState().deviceName);const u=r.getState().currentLang;this.modal.querySelectorAll(".lang-btn").forEach(m=>{const h=m.dataset.lang;m.classList.toggle("selected",h===u)})}reset(){$.remove(oe),$.flush()}setupEventListeners(){if(!this.modal)return;this.listeners.add(document,"keydown",(i=>{var o;i.key==="Escape"&&((o=this.modal)!=null&&o.classList.contains("active"))&&this.dismiss()})),this.modal.querySelectorAll(".lang-btn").forEach(i=>{this.listeners.add(i,"click",o=>{const l=o.currentTarget,d=l.dataset.lang;d&&(r.setLanguage(d),this.modal.querySelectorAll(".lang-btn").forEach(u=>u.classList.remove("selected")),l.classList.add("selected"),f(),this.updateTranslationsCallback&&this.updateTranslationsCallback(),this.updateOnboardingTranslations())})}),this.modal.querySelectorAll("[data-action]").forEach(i=>{this.listeners.add(i,"click",async o=>{const d=o.currentTarget.dataset.action;d&&(f(),await this.handleAction(d))})});const e=document.getElementById("onboarding-regenerate-name");e&&this.listeners.add(e,"click",()=>{const i=document.getElementById("onboarding-device-name");i&&(i.value=At(),f())}),this.modal.querySelectorAll(".role-card").forEach(i=>{this.listeners.add(i,"click",()=>{const o=i.getAttribute("data-role");o&&(this.selectedRole=o,this.modal.querySelectorAll(".role-card").forEach(l=>{const d=l===i;l.classList.toggle("selected",d),l.setAttribute("aria-checked",String(d))}),f())})});const n=document.getElementById("onboarding-race-id");if(n){const i=xt(()=>this.checkRaceExists(),500);this.listeners.add(n,"input",()=>{i();const o=document.getElementById("onboarding-pin");o&&(o.style.display=n.value.trim()?"block":"none")})}const s=document.getElementById("onboarding-recent-races-btn"),a=document.getElementById("onboarding-recent-races-dropdown");s&&a&&(this.listeners.add(s,"click",()=>{f(),a.style.display==="none"?(this.showRecentRacesDropdown(a,"onboarding-race-id"),s.setAttribute("aria-expanded","true")):(a.style.display="none",s.setAttribute("aria-expanded","false"))}),this.recentRacesDocumentHandler||(this.recentRacesDocumentHandler=i=>{const o=i.target;!s.contains(o)&&!a.contains(o)&&(a.style.display="none",s.setAttribute("aria-expanded","false"))},this.listeners.add(document,"click",this.recentRacesDocumentHandler)))}async showRecentRacesDropdown(e,n){const s=r.getState().currentLang;e.innerHTML=`<div class="recent-races-empty">${c("loading",s)}</div>`,e.style.display="block";let a=[];if(Me())try{a=await this.fetchRacesFromApi()}catch(i){b.warn("Failed to fetch races from API:",i),a=Se()}else a=Se();a.length===0?e.innerHTML=`<div class="recent-races-empty">${c("noRecentRaces",s)}</div>`:(e.innerHTML=Yt(a),Kt(e,a,i=>{this.selectRecentRace(i,n,e)}))}async fetchRacesFromApi(){const e=$.getRaw("skiTimerAuthToken");if(!e)return[];const n=await Rt("/api/v1/admin/races",{headers:{Authorization:`Bearer ${e}`}},5e3);if(!n.ok)throw new Error(`API error: ${n.status}`);const a=(await n.json()).races||[],i=new Date;i.setHours(0,0,0,0);const o=i.getTime(),l=a.filter(d=>d.lastUpdated&&d.lastUpdated>=o).map(d=>({raceId:d.raceId,createdAt:d.lastUpdated||Date.now(),lastUpdated:d.lastUpdated||Date.now(),entryCount:d.entryCount})).slice(0,5);return l.forEach(d=>{Bt(d.raceId,d.lastUpdated,d.entryCount)}),l}selectRecentRace(e,n,s){const a=document.getElementById(n);a&&(a.value=e.raceId,a.dispatchEvent(new Event("input",{bubbles:!0})),f()),s.style.display="none"}updateOnboardingTranslations(){if(!this.modal)return;const e=r.getState().currentLang;this.modal.querySelectorAll("[data-i18n]").forEach(n=>{const s=n.getAttribute("data-i18n");s&&(n.textContent=c(s,e))})}async handleAction(e){switch(e){case"next":await this.validateCurrentStep()&&(await this.saveCurrentStep(),r.forceSave(),this.goToStep(this.currentStep+1));break;case"back":this.currentStep>1&&this.goToStep(this.currentStep-1);break;case"skip":r.forceSave(),this.goToStep(this.currentStep+1);break;case"finish":this.complete();break;case"dismiss":this.dismiss();break}}finalize(){if(r.forceSave(),$.setRaw(oe,"true"),$.flush(),Y(this.modal),this.selectedRole==="gateJudge"){r.setView("gateJudge");const e=document.getElementById("gate-judge-tab");e&&(e.style.display="")}else r.setView("timer");this.listeners.removeAll(),this.recentRacesDocumentHandler=null}dismiss(){const e=document.getElementById("onboarding-device-name");e!=null&&e.value.trim()&&r.setDeviceName(e.value.trim()),r.setDeviceRole(this.selectedRole),this.finalize()}async validateCurrentStep(){var n,s,a,i;const e=r.getState().currentLang;switch(this.currentStep){case 2:return!0;case 3:return((n=document.getElementById("onboarding-device-name"))==null?void 0:n.value.trim())?!0:(y(c("deviceName",e),"warning"),!1);case 4:return!0;case 5:{const o=(s=document.getElementById("onboarding-race-id"))==null?void 0:s.value.trim(),l=(a=document.getElementById("onboarding-sync-toggle"))==null?void 0:a.checked;if(!o||!l)return!0;const d=(i=document.getElementById("onboarding-pin"))==null?void 0:i.value;return d.length!==4?(y(c("invalidPin",e),"warning"),!1):await this.validatePin(d)}default:return!0}}async saveCurrentStep(){var e,n,s,a,i,o;switch(this.currentStep){case 2:{r.setDeviceRole(this.selectedRole);break}case 3:{const l=(e=document.getElementById("onboarding-device-name"))==null?void 0:e.value.trim();l&&r.setDeviceName(l);break}case 4:{if(this.selectedRole==="gateJudge"){const l=parseInt(((n=document.getElementById("onboarding-gate-start"))==null?void 0:n.value)||"1",10),d=parseInt(((s=document.getElementById("onboarding-gate-end"))==null?void 0:s.value)||"10",10),u=Math.min(l,d),m=Math.max(l,d);r.setGateAssignment([u,m])}else{const l=(a=document.getElementById("onboarding-photo-toggle"))==null?void 0:a.checked;r.updateSettings({photoCapture:l})}break}case 5:{const l=(i=document.getElementById("onboarding-race-id"))==null?void 0:i.value.trim(),d=(o=document.getElementById("onboarding-sync-toggle"))==null?void 0:o.checked;l&&r.setRaceId(l);const u=d&&!!l;r.updateSettings({sync:u}),u&&x.initialize();break}}}goToStep(e){if(!(!this.modal||e<1||e>this.totalSteps)){if(this.modal.querySelectorAll(`[data-step="${this.currentStep}"]`).forEach(n=>{n.style.display="none"}),this.currentStep=e,e===4){const n=this.modal.querySelector(`[data-step="4"][data-path="${this.selectedRole}"]`);n&&(n.style.display="block")}else{const n=this.modal.querySelector(`[data-step="${e}"]:not([data-path])`);n&&(n.style.display="block")}this.updateUIForRole(),this.updateProgressDots(),e===6&&this.showSummary()}}updateUIForRole(){const e=r.getState().currentLang,n=document.getElementById("onboarding-device-name-title"),s=document.getElementById("onboarding-device-name-desc");this.selectedRole==="gateJudge"?(n&&(n.textContent=c("onboardingDeviceNameJudge",e)),s&&(s.textContent=c("onboardingDeviceNameJudgeDesc",e))):(n&&(n.textContent=c("onboardingDeviceName",e)),s&&(s.textContent=c("onboardingDeviceNameDesc",e)));const a=document.getElementById("onboarding-ready-title"),i=document.getElementById("onboarding-ready-tip"),o=document.getElementById("onboarding-finish-btn");this.selectedRole==="gateJudge"?(a&&(a.textContent=c("onboardingReadyJudge",e)),i&&(i.textContent=c("onboardingTipJudge",e)),o&&(o.textContent=c("startJudging",e))):(a&&(a.textContent=c("onboardingReady",e)),i&&(i.textContent=c("onboardingTip",e)),o&&(o.textContent=c("startTiming",e)))}updateProgressDots(){if(!this.modal)return;const e=this.modal.querySelectorAll(".progress-dot");e.forEach((s,a)=>{s.classList.remove("active","completed"),a+1===this.currentStep?s.classList.add("active"):a+1<this.currentStep&&s.classList.add("completed")});const n=this.modal.querySelector("#onboarding-progress-label");if(n){const s=e.length,a=r.getState().currentLang;n.textContent=a==="de"?`Schritt ${this.currentStep} von ${s}`:`Step ${this.currentStep} of ${s}`}}updateUI(){this.updateProgressDots(),this.updateOnboardingTranslations()}showSummary(){const e=r.getState(),n=e.currentLang,s=document.getElementById("onboarding-summary");if(s){s.innerHTML="";const a=[],i=this.selectedRole==="gateJudge"?c("roleJudgeTitle",n):c("roleTimerTitle",n);a.push({label:c("deviceRole",n),value:i,badge:"role"});const o=this.selectedRole==="gateJudge"?c("onboardingDeviceNameJudge",n):c("deviceNameLabel",n);if(a.push({label:o,value:e.deviceName}),this.selectedRole==="gateJudge"){const u=e.gateAssignment;a.push({label:c("gates",n),value:u?`${u[0]}–${u[1]}`:"—"})}else{const u=e.settings.photoCapture;a.push({label:c("photoCaptureLabel",n),value:u?c("enabled",n):c("disabled",n),badge:u?"enabled":"disabled"})}a.push({label:c("raceIdLabel",n),value:e.raceId||"—"});const l=e.settings.sync;a.push({label:c("syncStatusLabel",n),value:l?c("enabled",n):c("disabled",n),badge:l?"enabled":"disabled"});const d=document.createElement("div");d.className="onboarding-summary-list",a.forEach(({label:u,value:m,badge:h})=>{const S=document.createElement("div");S.className="onboarding-summary-row";const g=document.createElement("span");g.className="onboarding-summary-label",g.textContent=u;const v=document.createElement("span");h?v.className=`onboarding-summary-badge ${h}`:v.className="onboarding-summary-value",v.textContent=m,S.append(g,v),d.appendChild(S)}),s.appendChild(d)}}async checkRaceExists(){const e=document.getElementById("onboarding-race-id"),n=document.getElementById("onboarding-race-status");if(!e||!n)return;const s=e.value.trim(),a=r.getState().currentLang;if(!s){n.textContent="",n.className="race-status";return}n.innerHTML=`${Tt(14)} ${_(c("loading",a))}`,n.className="race-status loading";const i=await x.checkRaceExists(s);if(i.exists){const o=i.entryCount===1?c("entry",a):c("entries",a);n.innerHTML=`${Dt(14)} ${_(c("raceFound",a))} (${_(String(i.entryCount))} ${_(o)})`,n.className="race-status found"}else n.textContent=`+ ${c("raceNew",a)}`,n.className="race-status new"}async validatePin(e){try{return(await $t(e)).success}catch{const n=r.getState().currentLang;return y(`${c("networkError",n)} - ${c("pinVerifyOnline",n)}`,"warning",5e3),!0}}complete(){this.finalize(),Te(),y(c("onboardingComplete",r.getState().currentLang),"success")}}const T=new B;let D=null;function Ae(){const t=document.getElementById("app-version");t&&(t.textContent="5.21.3");const e=Le("5.21.3"),n=document.getElementById("app-version-name"),s=document.getElementById("app-version-description");e&&n&&(n.textContent=`"${e.name}"`),e&&s&&(s.textContent=e.description);const a=document.getElementById("version-info-btn");a&&T.add(a,"click",async()=>{const g=r.getState(),v=Le("5.21.3"),it=[v?`Ski Race Timer v5.21.3 "${v.name}"`:"Ski Race Timer v5.21.3",`Device: ${g.deviceName||"Unknown"}`,`Role: ${g.deviceRole}`,`Race ID: ${g.raceId||"None"}`,`Entries: ${g.entries.length}`,`Sync: ${g.settings.sync?"On":"Off"}`,`Language: ${g.currentLang.toUpperCase()}`,`User Agent: ${navigator.userAgent}`,`Screen: ${window.screen.width}x${window.screen.height}`,`Viewport: ${window.innerWidth}x${window.innerHeight}`,`Online: ${navigator.onLine}`,`Timestamp: ${new Date().toISOString()}`].join(`
`);try{await navigator.clipboard.writeText(it),y(c("debugInfoCopied",g.currentLang),"success")}catch{y(c("debugInfoCopyFailed",g.currentLang),"warning")}f()}),pn(),Q()?nn():(fn(),yn(),hn(),bn(),vn()),Ft(),Xt();const i=()=>{pe(()=>import("./gate-judge-BoK1XIvH.js").then(g=>g.t),__vite__mapDeps([0,1,2])).then(g=>g.initGateJudgeView()).catch(g=>b.error("Failed to load gateJudgeView:",g)),pe(()=>import("./chief-judge-DtBsPpo-.js").then(g=>g.au),__vite__mapDeps([1,2])).then(g=>g.initChiefJudgeToggle()).catch(g=>b.error("Failed to load chiefJudgeView:",g))},o=r.getState().deviceRole;o==="gateJudge"&&i();let l=o;an(()=>{const g=Vt.value;g!==l&&(l=g,g==="gateJudge"&&i())}),Bn(),rn(),Zt(),xn(),Fn(),r.subscribe(Mn),$n(),T.add(window,"beforeunload",Dn),Cn(),D=new Jn,D.setUpdateTranslationsCallback(()=>He()),D.shouldShow()&&D.show();const d=document.getElementById("show-tutorial-btn");d&&T.add(d,"click",()=>{D&&(D.reset(),D.show(),f())});const u=document.getElementById("keyboard-shortcuts-modal"),m=document.getElementById("show-shortcuts-btn"),h=document.getElementById("shortcuts-close-btn"),S=document.getElementById("shortcuts-done-btn");m&&u&&T.add(m,"click",()=>{J(u),f()}),h&&u&&T.add(h,"click",()=>Y(u)),S&&u&&T.add(S,"click",()=>Y(u)),T.add(document,"keydown",(g=>{if(g.key==="?"&&!bt()){const v=g.target;if(v.tagName==="INPUT"||v.tagName==="TEXTAREA"||v.tagName==="SELECT")return;g.preventDefault(),u&&J(u)}}))}let re=!1,F=[],M=null;const Un=3,Hn=1e4;function zn(){window.addEventListener("error",_n),window.addEventListener("unhandledrejection",Gn),window.addEventListener("critical-error",Wn)}function _n(t){const{message:e,error:n}=t;Ne("Global","uncaught error",n||e,void 0),at(e),st()&&me(e),t.preventDefault()}function Gn(t){const e=t.reason,n=e instanceof Error?e.message:String(e);Ne("Global","unhandled rejection",e,void 0),at(n),st()&&me(n),t.preventDefault()}function Wn(t){var s;const e=t.detail,n=((s=e==null?void 0:e.error)==null?void 0:s.message)||"Critical error occurred";qt("Global","critical error event",e==null?void 0:e.error,void 0),me(n)}function at(t){const e=Date.now();F.push({message:t,timestamp:e}),F=F.filter(n=>e-n.timestamp<Hn)}function st(){return F.length>=Un}function me(t){var a,i;if(re)return;re=!0;const e=r.getState().currentLang,n=document.createElement("div");n.id="error-boundary-overlay",n.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 24px;
  `;const s=document.createElement("div");s.style.cssText=`
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    text-align: center;
    color: #fff;
  `,s.innerHTML=`
    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
    <h2 style="margin: 0 0 8px; font-size: 1.25rem;">${c("errorOccurred",e)}</h2>
    <p style="color: #999; font-size: 0.875rem; margin: 0 0 16px;">
      ${c("errorRecoveryMessage",e)}
    </p>
    <p style="color: #666; font-size: 0.75rem; font-family: monospace; margin: 0 0 24px; word-break: break-word;">
      ${jn(t.substring(0,200))}
    </p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="error-dismiss-btn" style="
        padding: 12px 24px;
        border: 1px solid #444;
        border-radius: 8px;
        background: transparent;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${c("dismiss",e)}</button>
      <button id="error-reload-btn" style="
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #3B82F6;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${c("reload",e)}</button>
    </div>
  `,n.appendChild(s),document.body.appendChild(n),M=setTimeout(()=>{M=null;const o=document.getElementById("error-dismiss-btn");o==null||o.focus()},100),(a=document.getElementById("error-dismiss-btn"))==null||a.addEventListener("click",()=>{M!==null&&(clearTimeout(M),M=null),n.remove(),re=!1,F=[]}),(i=document.getElementById("error-reload-btn"))==null||i.addEventListener("click",()=>{window.location.reload()})}function jn(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}zn();Pt();Mt();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ae):Ae();let j=null;Ee.initialize().then(()=>{j=Ee.subscribe(t=>{document.body.classList.toggle("power-saver",t.batteryLevel!=="normal")})}).catch(()=>{});window.addEventListener("beforeunload",()=>{j&&(j(),j=null)});
