import{L as k,m as me,X as T,t as d,s as l,h as v,Y as G,Z as fe,a as y,f as K,_ as pe,a0 as ye,a1 as Q,u as P,a2 as oe,T as he,q as b,a3 as Ee,p as u,d as J,o as L,e as Ie,i as Y,V as ve,R as H,a4 as Se,a5 as X,a6 as be,a7 as ke,a8 as we}from"./chief-judge-riJEdY3M.js";import{o as S,c as E,u as xe}from"./gate-judge-BcJMKlnh.js";const ee=new k;let h=null;async function q(e,t){const n=await ye(e,t);return n.success&&z(),n}function te(e){return/^\d{4}$/.test(e)}function z(){const e=l.getState().currentLang,t=T(),n=document.getElementById("admin-pin-status"),a=document.getElementById("change-pin-btn-text");n&&(n.textContent=t?d("pinSet",e):d("pinNotSet",e)),a&&(a.textContent=t?d("changePin",e):d("setPin",e))}function Re(){const e=l.getState().currentLang,t=T(),n=document.getElementById("change-pin-modal"),a=document.getElementById("change-pin-modal-title"),i=document.getElementById("current-pin-row"),s=document.getElementById("current-pin-input"),r=document.getElementById("new-pin-input"),o=document.getElementById("confirm-pin-input");n&&(s&&(s.value=""),r&&(r.value=""),o&&(o.value=""),ce(),t?(i&&(i.style.display="block"),a&&(a.textContent=d("changePin",e))):(i&&(i.style.display="none"),a&&(a.textContent=d("setPin",e))),S(n),t&&s?s.focus():r&&r.focus())}function ce(){["current-pin-error","pin-mismatch-error","pin-format-error"].forEach(t=>{const n=document.getElementById(t);n&&(n.style.display="none")})}async function Ae(){const e=l.getState().currentLang,t=T(),n=document.getElementById("current-pin-input"),a=document.getElementById("new-pin-input"),i=document.getElementById("confirm-pin-input"),s=document.getElementById("save-pin-btn"),r=document.getElementById("current-pin-error"),o=document.getElementById("pin-mismatch-error"),c=document.getElementById("pin-format-error");ce();const m=(n==null?void 0:n.value)||"",g=(a==null?void 0:a.value)||"",p=(i==null?void 0:i.value)||"";if(!te(g)){c&&(c.style.display="block"),a&&a.focus(),v();return}if(g!==p){o&&(o.style.display="block"),i&&(i.value="",i.focus()),v();return}if(t){if(!te(m)){r&&(r.style.display="block"),n&&n.focus(),v();return}const I=(s==null?void 0:s.textContent)||"";s&&(s.disabled=!0,s.textContent=d("saving",e));try{const f=await fetch("/api/v1/admin/pin",{method:"POST",headers:{...G(),"Content-Type":"application/json"},body:JSON.stringify({currentPin:m,newPin:g})});if(f.status===401){r&&(r.style.display="block"),n&&(n.value="",n.focus()),v();return}if(!f.ok)throw new Error(`HTTP ${f.status}`);if(fe(),!(await q(g)).success){y(d("pinSyncFailed",e),"error"),v();return}const ge=document.getElementById("change-pin-modal");E(ge),y(d("pinSaved",e),"success"),K(),z()}catch(f){pe("Admin","handleSavePin",f,"pinSyncFailed"),y(d("pinSyncFailed",e),"error"),v()}finally{s&&(s.disabled=!1,s.textContent=I)}}else{const I=(s==null?void 0:s.textContent)||"";s&&(s.disabled=!0,s.textContent=d("saving",e));try{if(!(await q(g)).success){y(d("pinSyncFailed",e),"error"),v();return}const C=document.getElementById("change-pin-modal");E(C),y(d("pinSaved",e),"success"),K(),z()}finally{s&&(s.disabled=!1,s.textContent=I)}}}function W(e){return new Promise(t=>{if(T()){t(!0);return}const n=document.getElementById("admin-pin-modal"),a=document.getElementById("admin-pin-modal-title"),i=document.getElementById("admin-pin-modal-text"),s=document.getElementById("admin-pin-verify-input"),r=document.getElementById("admin-pin-error");if(!n||!s){t(!1);return}a&&(a.textContent=d("enterAdminPin",e)),i&&(i.textContent=d("enterPinToJoinRace",e)),r&&(r.style.display="none"),s.value="",h={type:"raceJoin",resolve:t},S(n),setTimeout(()=>s.focus(),100)})}function gt(e){return new Promise(t=>{const n=document.getElementById("admin-pin-modal"),a=document.getElementById("admin-pin-modal-title"),i=document.getElementById("admin-pin-modal-text"),s=document.getElementById("admin-pin-verify-input"),r=document.getElementById("admin-pin-error");if(!n||!s){t(!1);return}a&&(a.textContent=d("enterChiefJudgePin",e)),i&&(i.textContent=d("enterPinForChiefJudgeInfo",e)),r&&(r.style.display="none"),s.value="",h={type:"chiefJudge",resolve:t},S(n),setTimeout(()=>s.focus(),100)})}async function ne(){const e=document.getElementById("admin-pin-verify-input"),t=document.getElementById("admin-pin-error"),n=document.getElementById("admin-pin-modal");if(!e||!n||!h)return;const a=e.value.trim(),i=h.type==="chiefJudge"?"chiefJudge":void 0;(await q(a,i)).success?(E(n),e.value="",t&&(t.style.display="none"),h.resolve(!0),h=null):(t&&(t.style.display="block"),e.value="",e.focus(),v())}function Ce(){const e=document.getElementById("admin-pin-modal"),t=document.getElementById("admin-pin-verify-input");E(e),t&&(t.value=""),h&&(h.resolve(!1),h=null)}function mt(){return h?(h.resolve(!1),h=null,!0):!1}function O(){return h!==null}function Be(){z();const e=document.getElementById("change-pin-btn");e&&ee.add(e,"click",Re);const t=document.getElementById("save-pin-btn");t&&ee.add(t,"click",Ae),["admin-pin-verify-input","current-pin-input","new-pin-input","confirm-pin-input"].forEach(a=>{const i=document.getElementById(a);i&&me(i)})}const $=new k,re="/api/v1/admin/races";let M=null,ae=!1;function Te(){const e=document.getElementById("admin-pin-modal"),t=document.getElementById("admin-pin-verify-input"),n=document.getElementById("admin-pin-error"),a=document.getElementById("admin-pin-modal-title"),i=document.getElementById("admin-pin-modal-text"),s=l.getState().currentLang;e&&t&&n&&(t.value="",n.style.display="none",a&&(a.textContent=d("enterAdminPin",s)),i&&(i.textContent=d("enterPinText",s)),S(e),t.focus())}async function ie(){const e=document.getElementById("admin-pin-verify-input"),t=document.getElementById("admin-pin-error"),n=document.getElementById("admin-pin-modal");if(!e||!n)return;const a=e.value.trim();(await q(a)).success?(E(n),e.value="",t&&(t.style.display="none"),Pe()):(t&&(t.style.display="block"),e.value="",e.focus(),v())}function Pe(){const e=document.getElementById("race-management-modal");e&&(S(e),Z())}async function Z(){const e=document.getElementById("race-list"),t=document.getElementById("race-list-loading"),n=document.getElementById("race-list-empty"),a=l.getState().currentLang;if(e){e.setAttribute("aria-busy","true"),t&&(t.style.display="block"),n&&(n.style.display="none"),e.querySelectorAll(".race-item").forEach(i=>i.remove());try{const i=await Q(re,{headers:G()},1e4);if(!i.ok){if(i.status===401){const o=document.getElementById("race-management-modal");E(o),y(d("authError",a),"error"),P.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${i.status}`)}const r=(await i.json()).races||[];if(e.setAttribute("aria-busy","false"),t&&(t.style.display="none"),r.length===0){n&&(n.style.display="block");return}r.forEach(o=>{const c=Le(o,a);e.appendChild(c)}),ae||(ae=!0,$.add(e,"click",o=>{const m=o.target.closest(".race-delete-btn");if(!m)return;const g=m.closest("[data-race-id]"),p=g==null?void 0:g.getAttribute("data-race-id");p&&De(p)}))}catch(i){oe("Admin","loadRaceList",i,"loadError"),y(d("loadError",a),"error"),e.setAttribute("aria-busy","false"),t&&(t.style.display="none")}}}function Le(e,t){const n=document.createElement("div");n.className="race-item",n.setAttribute("data-race-id",e.raceId);const a=document.createElement("div");a.className="race-info";const i=document.createElement("span");i.className="race-id",i.textContent=e.raceId.toUpperCase();const s=document.createElement("span");s.className="race-meta";const r=e.entryCount===1?d("entry",t):d("entries",t),o=e.deviceCount===1?d("device",t):d("devices",t);s.textContent=`${e.entryCount} ${r}, ${e.deviceCount} ${o}`,a.appendChild(i),a.appendChild(s);const c=document.createElement("button");return c.className="race-delete-btn danger",c.textContent=d("delete",t),n.appendChild(a),n.appendChild(c),n}function De(e){const t=l.getState().currentLang;M=e;const n=document.getElementById("delete-race-confirm-modal"),a=document.getElementById("delete-race-confirm-text");a&&(a.textContent=`${d("confirmDeleteRaceText",t)} "${e.toUpperCase()}"?`),n&&S(n)}async function $e(){if(!M)return;const e=M,t=l.getState().currentLang,n=document.getElementById("delete-race-confirm-modal");E(n);try{const a=await Q(`${re}?raceId=${encodeURIComponent(e)}`,{method:"DELETE",headers:G()},1e4);if(!a.ok){if(a.status===401){const s=document.getElementById("race-management-modal");E(s),y(d("authError",t),"error"),P.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${a.status}`)}const i=await a.json();if(i.success)y(`${d("raceDeletedSuccess",t)} ${e.toUpperCase()}`,"success"),he(),Z();else throw new Error(i.error||d("unknownError",t))}catch(a){oe("Admin","deleteRace",a,"deleteError")}finally{M=null}}function Me(){const e=document.getElementById("manage-races-btn");e&&$.add(e,"click",Te);const t=document.getElementById("refresh-races-btn");t&&$.add(t,"click",Z);const n=document.getElementById("confirm-delete-race-btn");n&&$.add(n,"click",$e)}const F=new k;function ft(e,t){return new Promise(n=>{const a=document.getElementById("race-change-modal");if(!a){n("cancel");return}const i=a.querySelector(".modal-title"),s=a.querySelector(".modal-text"),r=document.getElementById("race-change-export-btn"),o=document.getElementById("race-change-delete-btn"),c=document.getElementById("race-change-keep-btn"),m=a.querySelector('[data-action="cancel"]');e==="synced"?(i&&(i.textContent=d("raceChangeTitle",t)),s&&(s.textContent=d("raceChangeSyncedText",t)),r&&(r.style.display=""),c&&(c.style.display="none")):(i&&(i.textContent=d("raceChangeTitle",t)),s&&(s.textContent=d("raceChangeUnsyncedText",t)),r&&(r.style.display="none"),c&&(c.style.display=""));const g=()=>{E(a),r==null||r.removeEventListener("click",p),o==null||o.removeEventListener("click",I),c==null||c.removeEventListener("click",f),m==null||m.removeEventListener("click",C)},p=()=>{g(),n("export")},I=()=>{g(),n("delete")},f=()=>{g(),n("keep")},C=()=>{g(),n("cancel")};r==null||r.addEventListener("click",p),o==null||o.addEventListener("click",I),c==null||c.addEventListener("click",f),m==null||m.addEventListener("click",C),S(a)})}function pt(e){const{raceId:t,message:n}=e.detail,a=l.getState().currentLang,i=document.getElementById("race-deleted-text");i&&(i.textContent=`${d("raceDeletedFor",a)} "${t}". ${n||d("raceDeletedText",a)}`);const s=document.getElementById("race-deleted-modal");s&&S(s),l.updateSettings({sync:!1}),l.setRaceId("");const r=document.getElementById("sync-toggle");r&&(r.checked=!1);const o=document.getElementById("race-id-input");o&&(o.value=""),v()}function yt(e){const{message:t}=e.detail,n=l.getState().currentLang;y(t||d("sessionExpired",n),"warning",5e3),W(n).then(a=>{if(a){const i=l.getState();i.settings.sync&&i.raceId&&b.initialize(),y(d("authSuccess",n),"success")}}).catch(a=>P.error("Re-auth failed:",a)),v()}async function ht(){const e=document.getElementById("photo-sync-modal");if(!e)return;const t=l.getState().currentLang,n=document.getElementById("photos-upload-count"),a=document.getElementById("photos-download-count"),i=document.getElementById("photos-total-size");n&&(n.textContent=d("loading",t)),a&&(a.textContent=d("loading",t)),i&&(i.textContent=d("loading",t)),S(e);const s=await b.getPhotoSyncStats();n&&(n.textContent=String(s.uploadCount)),a&&(a.textContent=String(s.downloadCount)),i&&(i.textContent=Ee(s.totalSize));const r=document.getElementById("photo-sync-confirm-btn");r&&(r.textContent=d("enableSync",t))}function Fe(){const e=document.getElementById("photo-sync-modal"),t=document.getElementById("photo-sync-cancel-btn"),n=document.getElementById("photo-sync-confirm-btn");t&&F.add(t,"click",()=>{E(e)}),n&&F.add(n,"click",()=>{l.updateSettings({syncPhotos:!0});const a=document.getElementById("sync-photos-toggle");a&&(a.checked=!0),E(e);const i=l.getState();i.settings.sync&&i.raceId&&b.forceRefresh(),K()}),e&&F.add(e,"click",a=>{a.target===e&&E(e)})}function Ve(){const e=document.getElementById("race-deleted-ok-btn");e&&F.add(e,"click",()=>{const t=document.getElementById("race-deleted-modal");E(t)}),Fe()}const _=new k;function Et(){Be(),Me(),Ve();const e=document.getElementById("admin-pin-verify-btn");e&&_.add(e,"click",()=>{O()?ne():ie()});const t=document.getElementById("admin-pin-verify-input");t&&_.add(t,"keydown",(a=>{a.key==="Enter"&&(O()?ne():ie())}));const n=document.getElementById("admin-pin-modal");n&&_.add(n,"click",a=>{a.target===n&&O()&&Ce()})}const Ne={"5.18":{name:"Powder Streif",description:{en:"Battery power saver for longer outdoor timing. Improved PIN security and faster voice notes.",de:"Batterieschoner für längere Zeitmessung im Freien. Verbesserte PIN-Sicherheit und schnellere Sprachnotizen.",fr:"Mode économie de batterie pour un chronométrage prolongé en extérieur. Sécurité PIN améliorée et notes vocales plus rapides."}},"5.19":{name:"Firn Lauberhorn",description:{en:"Under-the-hood reliability upgrade. Stronger server-side input validation and improved code quality.",de:"Verbesserungen unter der Haube. Stärkere serverseitige Eingabevalidierung und verbesserte Codequalität.",fr:"Amélioration de la fiabilité en interne. Validation des entrées côté serveur renforcée et qualité de code améliorée."}},"5.20":{name:"Corn Saslong",description:{en:"Offline banner, undo for deletions, reorganized settings, and standardized event cleanup across the app.",de:"Offline-Banner, Rückgängig-Funktion für Löschungen, neu organisierte Einstellungen und standardisierte Ereignisbereinigung.",fr:"Bannière hors ligne, annulation des suppressions, paramètres réorganisés et nettoyage standardisé des événements."}},"5.21":{name:"Sleet Kandahar",description:{en:"Responsive layout fixes for all screen sizes. Dial and numbers scale smoothly from iPhone SE to iPad landscape.",de:"Responsive Layout-Korrekturen für alle Bildschirmgrößen. Zifferblatt und Zahlen skalieren fließend vom iPhone SE bis iPad Querformat.",fr:"Corrections de mise en page responsive pour tous les écrans. Le cadran et les chiffres s'adaptent de l'iPhone SE à l'iPad en mode paysage."}},"5.22":{name:"Crust Stelvio",description:{en:"Signals-based reactivity, view code splitting, reduced-motion support, and 3,700+ new tests for rock-solid reliability.",de:"Signalbasierte Reaktivität, View-Code-Splitting, Reduced-Motion-Unterstützung und 3.700+ neue Tests für maximale Zuverlässigkeit.",fr:"Réactivité basée sur les signaux, découpage du code par vue, support du mouvement réduit et plus de 3 700 nouveaux tests pour une fiabilité maximale."}},"5.23":{name:"Graupel Hahnenkamm",description:{en:"Swipe-to-edit/delete in results, click-outside modal dismiss, auto-bib flash cue, and split settings effects for better performance.",de:"Wischen zum Bearbeiten/Löschen in Ergebnissen, Modal-Schließen per Klick außerhalb, Auto-Bib-Blitz-Hinweis und aufgeteilte Einstellungs-Effekte für bessere Leistung.",fr:"Glisser pour modifier/supprimer dans les résultats, fermeture des modales par clic extérieur, signal flash auto-dossard et effets de paramètres séparés pour de meilleures performances."}},"5.24":{name:"Névé Planai",description:{en:"Full French language support. Three-language UI (DE/FR/EN), French ski racing terminology, and complete documentation in French.",de:"Vollständige französische Sprachunterstützung. Dreisprachige Oberfläche (DE/FR/EN), französische Skirennsport-Terminologie und vollständige Dokumentation auf Französisch.",fr:"Support complet de la langue française. Interface trilingue (DE/FR/EN), terminologie du ski de course en français et documentation complète en français."}},"5.25":{name:"Rime Olympia",description:{en:"UI polish and design token consistency. Unified color system, 48px touch targets, accessible ARIA patterns, and cellular-optimized performance.",de:"UI-Feinschliff und einheitliche Design-Tokens. Vereinheitlichtes Farbsystem, 48px-Touchziele, barrierefreie ARIA-Muster und mobilfunkoptimierte Leistung.",fr:"Finitions UI et cohérence des tokens de design. Système de couleurs unifié, zones tactiles 48px, modèles ARIA accessibles et performances optimisées pour le réseau mobile."}},"5.26":{name:"Graupel Schladming",description:{en:"Consistent landscape layout across all views. Full-width header and tab bar, 2-column settings and gate judge, and internal grid for the radial timer.",de:"Einheitliches Querformat-Layout in allen Ansichten. Vollbreite Kopfzeile und Tab-Leiste, 2-Spalten-Einstellungen und Torrichter, internes Raster für den Radial-Timer.",fr:"Mise en page paysage cohérente dans toutes les vues. En-tête et barre d'onglets pleine largeur, paramètres et juge de porte à 2 colonnes, grille interne pour le minuteur radial."}}};function qe(e,t="en"){const n=e.split(".");if(n.length<2)return null;const a=`${n[0]}.${n[1]}`,i=Ne[a];return i?{name:i.name,description:i.description[t]||i.description.en}:null}const B=new k;function ze(){const e=u("device-name-input");e&&B.add(e,"change",()=>{l.setDeviceName(e.value.trim())}),Ue(),B.add(window,"update-role-toggle",()=>le()),Je()}function Ue(){const e=u("role-toggle");e&&B.add(e,"click",t=>{const a=t.target.closest(".role-card-setting");if(!a)return;const i=a.getAttribute("data-role");i&&i!==l.getState().deviceRole&&(l.setDeviceRole(i),le(),xe(),J(),i==="gateJudge"&&!l.getState().gateAssignment&&S(u("gate-assignment-modal")),i!=="gateJudge"&&l.getState().currentView==="gateJudge"&&l.setView("timer"))})}function le(){const e=u("role-toggle");if(!e)return;const t=l.getState();e.querySelectorAll(".role-card-setting").forEach(n=>{const i=n.getAttribute("data-role")===t.deviceRole;n.classList.toggle("active",i),n.setAttribute("aria-checked",String(i))})}function Je(){const e=u("advanced-settings-toggle"),t=u("advanced-settings-section");!e||!t||(e.setAttribute("role","button"),e.setAttribute("aria-expanded",t.classList.contains("expanded")?"true":"false"),B.add(e,"click",()=>{const n=t.classList.toggle("expanded");e.setAttribute("aria-expanded",String(n)),J()}))}function He(){const e=l.getState(),t=u("device-name-input");t&&(t.value=e.deviceName)}function Oe(){B.removeAll()}const R=new k;function _e(e){const t=u("simple-mode-toggle");t&&R.add(t,"change",()=>{l.updateSettings({simple:t.checked}),e();const i=u("admin-section");i&&(i.style.display="block")});const n=u("ambient-mode-toggle");n&&R.add(n,"change",()=>{l.updateSettings({ambientMode:n.checked})}),je();const a=u("lang-toggle");if(a){const i=s=>{s&&s!==l.getState().currentLang&&(l.setLanguage(s),window.dispatchEvent(new CustomEvent("settings-language-changed")))};R.add(a,"click",s=>{const o=s.target.getAttribute("data-lang");i(o)}),a.querySelectorAll(".lang-option").forEach(s=>{R.add(s,"keydown",r=>{const o=r;switch(o.key){case"Enter":case" ":{o.preventDefault();const c=s.getAttribute("data-lang");i(c);break}case"ArrowLeft":case"ArrowRight":{o.preventDefault();const c=Array.from(a.querySelectorAll(".lang-option")),m=c.indexOf(s);let g;o.key==="ArrowRight"?g=(m+1)%c.length:g=(m-1+c.length)%c.length;const p=c[g],I=p.getAttribute("data-lang");p.focus(),i(I);break}}})})}}function je(){const e=u("voice-mode-toggle"),t=u("voice-mode-row");if(!(!e||!t)){if(!L.isSupported()){t.style.display="none";return}e.checked=L.isActive(),R.add(e,"change",async()=>{const n=l.getState().currentLang;if(e.checked){if(!navigator.onLine){y(d("voiceOffline",n),"warning"),e.checked=!1;return}L.enable()||(y(d("voiceError",n),"error"),e.checked=!1)}else L.disable()})}}function Ke(){const e=l.getState(),{settings:t}=e,n=u("simple-mode-toggle");n&&(n.checked=t.simple);const a=u("admin-section");a&&(a.style.display="block");const i=u("ambient-mode-toggle");i&&(i.checked=t.ambientMode),de()}function de(){const e=l.getState().currentLang,t=u("lang-toggle");t&&t.querySelectorAll(".lang-option").forEach(n=>{const a=n.getAttribute("data-lang")===e;n.classList.toggle("active",a),n.setAttribute("aria-checked",String(a))})}function We(){R.removeAll()}let D=null;function Ge(e){const t=l.getState().currentLang,n=e.entryCount!==void 0?`${e.entryCount} ${d("entries",t)}`:"",a=Ie(e.raceId);return`
    <div class="recent-race-item" data-race-id="${Y(e.raceId)}" tabindex="0" role="option" aria-label="${Y(d("race",t))} ${a}${n?`, ${n}`:""}">
      <span class="recent-race-id">${a}</span>
      <span class="recent-race-meta">${n}</span>
    </div>
  `}function Qe(e){return e.map(Ge).join("")}function Ze(e,t,n){D&&D.abort(),D=new AbortController;const{signal:a}=D;e.addEventListener("click",i=>{const r=i.target.closest(".recent-race-item");if(!r)return;const o=r.getAttribute("data-race-id"),c=t.find(m=>m.raceId===o);c&&n(c)},{signal:a}),e.addEventListener("keydown",i=>{const r=i.target.closest(".recent-race-item");if(!r)return;const o=Array.from(e.querySelectorAll(".recent-race-item")),c=o.indexOf(r);switch(i.key){case"Enter":case" ":{i.preventDefault();const m=r.getAttribute("data-race-id"),g=t.find(p=>p.raceId===m);g&&n(g);break}case"ArrowDown":i.preventDefault(),c<o.length-1&&o[c+1].focus();break;case"ArrowUp":i.preventDefault(),c>0&&o[c-1].focus();break;case"Escape":i.preventDefault(),e.style.display="none";break}},{signal:a})}const w=new k;let A=null,j=0,ue={exists:null,entryCount:0},V=null,N=null;async function Ye(){return new Promise(e=>{V=e,window.dispatchEvent(new CustomEvent("request-photo-sync-warning"))})}async function se(e,t){return new Promise(n=>{N=n,window.dispatchEvent(new CustomEvent("request-race-change-dialog",{detail:{type:e,lang:t}}))})}function It(){V&&(V(),V=null)}function vt(e){N&&(N(e),N=null)}function Xe(){const e=u("sync-toggle");let t=!1;e&&w.add(e,"change",async()=>{if(t){e.checked=!e.checked;return}t=!0;try{const o=l.getState();if(e.checked&&o.raceId&&!await W(o.currentLang)){e.checked=!1;return}l.updateSettings({sync:e.checked});const c=u("sync-photos-toggle");c&&(c.disabled=!e.checked,e.checked||(c.checked=!1,l.updateSettings({syncPhotos:!1}))),e.checked&&o.raceId?b.initialize():b.cleanup()}finally{t=!1}});const n=u("sync-photos-toggle");n&&w.add(n,"change",async o=>{const c=o.target;c.checked?(o.preventDefault(),c.checked=!1,await Ye()):l.updateSettings({syncPhotos:!1})});const a=u("race-id-input");let i=!1;a&&(w.add(a,"input",()=>{A&&clearTimeout(A);const o=a.value.trim();o?A=setTimeout(()=>tt(o),500):U(null,0)}),w.add(a,"change",async()=>{if(!i){i=!0;try{const o=a.value.trim(),c=l.getState(),m=c.entries.length>0,g=c.lastSyncedRaceId!=="",p=o!==c.raceId&&o!=="";if(m&&p)if(g){const f=await se("synced",c.currentLang);if(f==="export")ve(),l.clearAll(),l.clearFaultEntries(),l.clearSyncQueue(),await H.clearAll();else if(f==="delete")l.clearAll(),l.clearFaultEntries(),l.clearSyncQueue(),await H.clearAll();else{a.value=c.raceId;return}}else{const f=await se("unsynced",c.currentLang);if(f==="delete")l.clearAll(),l.clearFaultEntries(),l.clearSyncQueue(),await H.clearAll();else if(f==="cancel"){a.value=c.raceId;return}}if(o&&!Se(o)){y(d("invalidRaceId",c.currentLang),"error"),a.value=c.raceId,v();return}if(c.settings.sync&&o&&!await W(c.currentLang)){a.value=c.raceId;return}c.settings.sync&&c.raceId&&b.cleanup();const I=o.toLowerCase();a.value=I,l.setRaceId(I),c.settings.sync&&I&&(b.initialize(),l.markCurrentRaceAsSynced())}finally{i=!1}}}));const s=u("settings-recent-races-btn"),r=u("settings-recent-races-dropdown");s&&r&&(w.add(s,"click",()=>{J(),r.style.display==="none"?(nt(r),s.setAttribute("aria-expanded","true")):(r.style.display="none",s.setAttribute("aria-expanded","false"))}),w.add(document,"click",o=>{const c=o.target;!s.contains(c)&&!r.contains(c)&&(r.style.display="none",s.setAttribute("aria-expanded","false"))}))}function et(){const e=l.getState(),{settings:t}=e,n=u("sync-toggle");n&&(n.checked=t.sync);const a=u("sync-photos-toggle");a&&(a.checked=t.syncPhotos,a.disabled=!t.sync);const i=u("race-id-input");i&&(i.value=e.raceId)}async function tt(e){const t=++j;try{const n=await b.checkRaceExists(e);if(t!==j)return;l.setRaceExistsInCloud(n.exists),U(n.exists,n.entryCount)}catch(n){if(t!==j)return;P.warn("Race exists check failed:",n),U(null,0)}}async function nt(e){const t=l.getState().currentLang;e.innerHTML=`<div class="recent-races-empty">${d("loading",t)}</div>`,e.style.display="block";let n=[];if(T())try{n=await at()}catch(a){P.warn("Failed to fetch races from API:",a),n=X()}else n=X();n.length===0?e.innerHTML=`<div class="recent-races-empty">${d("noRecentRaces",t)}</div>`:(e.innerHTML=Qe(n),Ze(e,n,a=>{it(a,e)}))}async function at(){const e=be.getRaw(ke);if(!e)return[];const t=await Q("/api/v1/admin/races",{headers:{Authorization:`Bearer ${e}`}},5e3);if(!t.ok)throw new Error(`API error: ${t.status}`);const a=(await t.json()).races||[],i=new Date;i.setHours(0,0,0,0);const s=i.getTime(),r=a.filter(o=>o.lastUpdated&&o.lastUpdated>=s).map(o=>({raceId:o.raceId,createdAt:o.lastUpdated||Date.now(),lastUpdated:o.lastUpdated||Date.now(),entryCount:o.entryCount})).slice(0,5);return r.forEach(o=>{we(o.raceId,o.lastUpdated,o.entryCount)}),r}function it(e,t){const n=u("race-id-input");n&&(n.value=e.raceId,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),J()),t.style.display="none"}function U(e,t){ue={exists:e,entryCount:t};const n=u("race-exists-indicator"),a=u("race-exists-text"),i=l.getState().currentLang;if(!(!n||!a)){if(e===null){n.style.display="none";return}if(n.style.display="inline-flex",n.classList.remove("found","new"),e)if(n.classList.add("found"),t>0){const s=t===1?d("entryInCloud",i):d("entriesInCloud",i);a.textContent=`${t} ${s}`}else a.textContent=d("raceFound",i);else n.classList.add("new"),a.textContent=d("raceNew",i)}}function st(){return ue}function ot(){A&&(clearTimeout(A),A=null),w.removeAll()}const x=new k;function St(){_e(rt),Xe(),ze(),x.add(window,"settings-language-changed",()=>{ct(),de()});const e=u("gps-toggle");e&&x.add(e,"change",()=>{l.updateSettings({gps:e.checked})});const t=u("auto-toggle");t&&x.add(t,"change",()=>{l.updateSettings({auto:t.checked})});const n=u("haptic-toggle");n&&x.add(n,"change",()=>{l.updateSettings({haptic:n.checked})});const a=u("sound-toggle");a&&x.add(a,"change",()=>{l.updateSettings({sound:a.checked})});const i=u("photo-toggle");i&&x.add(i,"change",()=>{l.updateSettings({photoCapture:i.checked})})}function bt(){const e=l.getState(),{settings:t}=e;Ke(),et(),He();const n=u("gps-toggle"),a=u("auto-toggle"),i=u("haptic-toggle"),s=u("sound-toggle"),r=u("photo-toggle");n&&(n.checked=t.gps),a&&(a.checked=t.auto),i&&(i.checked=t.haptic),s&&(s.checked=t.sound),r&&(r.checked=t.photoCapture)}function ct(){const e=l.getState().currentLang;document.documentElement.lang=e,document.querySelectorAll("[data-i18n]").forEach(a=>{const i=a.getAttribute("data-i18n");i&&(a.textContent=d(i,e))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(a=>{const i=a.getAttribute("data-i18n-placeholder");i&&(a.placeholder=d(i,e))}),document.querySelectorAll("[data-i18n-aria-label]").forEach(a=>{const i=a.getAttribute("data-i18n-aria-label");i&&a.setAttribute("aria-label",d(i,e))});const t=st();U(t.exists,t.entryCount);const n=document.getElementById("app-version-description");if(n){const a=qe("5.26.0",l.getState().currentLang);n.textContent=(a==null?void 0:a.description)??""}}function rt(){document.querySelectorAll("[data-advanced]").forEach(n=>{n.style.display=""});const t=document.querySelector('[data-point="S"]');t&&(t.style.display=""),lt()}function lt(){const e=l.getState().settings,t=document.documentElement;e.glassEffects?(t.classList.remove("no-glass-effects"),document.querySelectorAll(".glass-enable-target").forEach(n=>{n.classList.add("glass-enabled")})):(t.classList.add("no-glass-effects"),document.querySelectorAll(".glass-enabled").forEach(n=>{n.classList.remove("glass-enabled")})),t.classList.add("no-motion-effects"),e.outdoorMode?t.classList.add("outdoor-mode"):t.classList.remove("outdoor-mode")}function kt(){ot(),We(),Oe(),x.removeAll()}export{yt as a,rt as b,O as c,mt as d,ct as e,kt as f,ft as g,pt as h,vt as i,le as j,lt as k,Qe as l,Ze as m,qe as n,St as o,Et as p,It as r,ht as s,bt as u,gt as v};
