var ht=Object.defineProperty;var mt=(n,e,t)=>e in n?ht(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var h=(n,e,t)=>mt(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const r of o.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();function gt(n){const e=Date.now(),t=crypto.randomUUID().slice(0,8);return`${n}-${e}-${t}`}const W=["swift","bold","cool","fast","keen","wild","calm","warm","bright","sharp","quick","brave","fresh","grand","prime","clear","snow","ice","frost","peak","alpine","polar","winter","crisp"],J=["fox","bear","wolf","hawk","eagle","tiger","lion","deer","pine","oak","cedar","birch","maple","spruce","aspen","willow","peak","ridge","slope","trail","summit","valley","glacier","cliff"];function Pe(n){return n.charAt(0).toUpperCase()+n.slice(1)}function ft(){const n=W[Math.floor(Math.random()*W.length)],e=J[Math.floor(Math.random()*J.length)],t=Math.floor(Math.random()*100);return`dev_${n}-${e}-${t}`}function me(){const n=W[Math.floor(Math.random()*W.length)],e=J[Math.floor(Math.random()*J.length)],t=Math.floor(Math.random()*100);return`${Pe(n)} ${Pe(e)} ${t}`}const K=2,pt=["S","F"],yt=["ok","dns","dnf","dsq"];function U(n){if(!n||typeof n!="object")return!1;const e=n;return!(typeof e.id!="string"&&typeof e.id!="number"||typeof e.id=="string"&&e.id.length===0||typeof e.id=="number"&&e.id<=0||e.bib!==void 0&&typeof e.bib!="string"||typeof e.bib=="string"&&e.bib.length>10||!pt.includes(e.point)||!e.timestamp||typeof e.timestamp!="string"||isNaN(Date.parse(e.timestamp))||e.status&&!yt.includes(e.status))}function Et(n){if(!n||typeof n!="object")return!1;const e=n;return!(!U(e.entry)||typeof e.retryCount!="number"||e.retryCount<0||typeof e.lastAttempt!="number"||e.lastAttempt<0)}function Oe(n){return!n||typeof n!="string"||n.length>50?!1:/^[a-zA-Z0-9_-]+$/.test(n)}function vt(n){return!n||typeof n!="string"?!1:n.startsWith("dev_")&&n.length>4}function Q(n,e=100){return!n||typeof n!="string"?"":n.slice(0,e).replace(/[<>"'&]/g,"").replace(/[\x00-\x1F\x7F]/g,"")}function St(n,e){if(!U(n))return null;const t=n;return{id:(typeof t.id=="number",String(t.id)),bib:Q(t.bib,10),point:t.point,timestamp:t.timestamp,status:t.status||"ok",deviceId:Q(t.deviceId||e,50),deviceName:Q(t.deviceName||"Unknown Device",100),syncedAt:t.syncedAt,photo:t.photo,gpsCoords:t.gpsCoords}}function It(n,e){const t={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!1,simple:!0,photoCapture:!1};if(!n||typeof n!="object")return{version:K,entries:[],settings:t,deviceId:e,deviceName:me(),raceId:"",syncQueue:[]};const s=n;let i=[];Array.isArray(s.entries)&&(i=s.entries.map(a=>St(a,e)).filter(a=>a!==null));let o=t;if(s.settings&&typeof s.settings=="object"){const a=s.settings;o={auto:typeof a.auto=="boolean"?a.auto:t.auto,haptic:typeof a.haptic=="boolean"?a.haptic:t.haptic,sound:typeof a.sound=="boolean"?a.sound:t.sound,sync:typeof a.sync=="boolean"?a.sync:t.sync,syncPhotos:typeof a.syncPhotos=="boolean"?a.syncPhotos:t.syncPhotos,gps:typeof a.gps=="boolean"?a.gps:t.gps,simple:typeof a.simple=="boolean"?a.simple:t.simple,photoCapture:typeof a.photoCapture=="boolean"?a.photoCapture:t.photoCapture}}let r=[];return Array.isArray(s.syncQueue)&&(r=s.syncQueue.filter(Et)),{version:K,entries:i,settings:o,deviceId:vt(s.deviceId)?s.deviceId:e,deviceName:Q(s.deviceName,100)||me(),raceId:Oe(s.raceId)?s.raceId:"",syncQueue:r,lastExport:typeof s.lastExport=="number"?s.lastExport:void 0}}const E={ENTRIES:"skiTimerEntries",SETTINGS:"skiTimerSettings",LANG:"skiTimerLang",DEVICE_ID:"skiTimerDeviceId",DEVICE_NAME:"skiTimerDeviceName",RACE_ID:"skiTimerRaceId",LAST_SYNCED_RACE_ID:"skiTimerLastSyncedRaceId",SYNC_QUEUE:"skiTimerSyncQueue",SCHEMA_VERSION:"skiTimerSchemaVersion"},Te={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!1,simple:!0,photoCapture:!1},bt=50;class wt{constructor(){h(this,"state");h(this,"listeners",new Set);h(this,"saveTimeout",null);h(this,"isNotifying",!1);h(this,"pendingNotifications",[]);this.state=this.loadInitialState()}loadInitialState(){let e=localStorage.getItem(E.DEVICE_ID);e||(e=ft(),localStorage.setItem(E.DEVICE_ID,e));const t=localStorage.getItem(E.ENTRIES),s=localStorage.getItem(E.SETTINGS),i=localStorage.getItem(E.SYNC_QUEUE);let o=[],r=Te,a=[];try{if(t){const f=JSON.parse(t);Array.isArray(f)&&(o=f.filter(p=>U(p)))}}catch(f){console.error("Failed to parse entries:",f)}try{if(s){const f=JSON.parse(s);r={...Te,...f}}}catch(f){console.error("Failed to parse settings:",f)}try{if(i){const f=JSON.parse(i);Array.isArray(f)&&(a=f)}}catch(f){console.error("Failed to parse sync queue:",f)}const l=localStorage.getItem(E.LANG)||"de";let u=localStorage.getItem(E.DEVICE_NAME);u||(u=me(),localStorage.setItem(E.DEVICE_NAME,u));const m=localStorage.getItem(E.RACE_ID)||"",g=localStorage.getItem(E.LAST_SYNCED_RACE_ID)||"";return{currentView:"timer",currentLang:l,bibInput:"",selectedPoint:"F",selectMode:!1,selectedEntries:new Set,isRecording:!1,lastRecordedEntry:null,entries:o,undoStack:[],redoStack:[],settings:r,deviceId:e,deviceName:u,raceId:m,lastSyncedRaceId:g,syncStatus:"disconnected",syncQueue:a,connectedDevices:new Map,cloudDeviceCount:0,cloudHighestBib:0,raceExistsInCloud:null,gpsEnabled:r.gps,gpsAccuracy:null,gpsStatus:"inactive",cameraReady:!1,cameraError:null}}getState(){return this.state}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e){if(this.pendingNotifications.push(e),!this.isNotifying){this.isNotifying=!0;try{for(;this.pendingNotifications.length>0;){const t=this.pendingNotifications.shift(),s=Array.from(this.listeners);for(const i of s)try{i(this.state,t)}catch(o){console.error("State listener error:",o)}}}finally{this.isNotifying=!1}}}setState(e,t=!0){const s=Object.keys(e);this.state={...this.state,...e},this.notify(s),t&&this.scheduleSave()}scheduleSave(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveToStorage(),100)}saveToStorage(){try{this.checkStorageQuota();const e=this.state.entries.map(t=>t.photo&&t.photo!=="indexeddb"&&t.photo.length>20?{...t,photo:"indexeddb"}:t);localStorage.setItem(E.ENTRIES,JSON.stringify(e)),localStorage.setItem(E.SETTINGS,JSON.stringify(this.state.settings)),localStorage.setItem(E.LANG,this.state.currentLang),localStorage.setItem(E.DEVICE_NAME,this.state.deviceName),localStorage.setItem(E.RACE_ID,this.state.raceId),localStorage.setItem(E.LAST_SYNCED_RACE_ID,this.state.lastSyncedRaceId),localStorage.setItem(E.SYNC_QUEUE,JSON.stringify(this.state.syncQueue)),localStorage.setItem(E.SCHEMA_VERSION,String(K))}catch(e){console.error("Failed to save to storage:",e),this.dispatchStorageError(e)}}async checkStorageQuota(){var e;if((e=navigator.storage)!=null&&e.estimate)try{const{usage:t,quota:s}=await navigator.storage.estimate();if(s&&t){const i=t/s;i>.9&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t,quota:s,percent:Math.round(i*100)}}))}}catch(t){console.warn("Could not check storage quota:",t)}}dispatchStorageError(e){window.dispatchEvent(new CustomEvent("storage-error",{detail:{message:e.message,isQuotaError:e.name==="QuotaExceededError"||e.message.includes("quota")||e.message.includes("storage"),entryCount:this.state.entries.length}}))}pushUndo(e){const t=[...this.state.undoStack,e];t.length>bt&&t.shift(),this.setState({undoStack:t,redoStack:[]},!1)}addEntry(e){const t=[...this.state.entries,e];this.pushUndo({type:"ADD_ENTRY",data:e,timestamp:Date.now()}),this.setState({entries:t,lastRecordedEntry:e,isRecording:!1}),this.state.settings.sync&&this.state.raceId&&this.addToSyncQueue(e)}deleteEntry(e){const t=this.state.entries.find(i=>i.id===e);if(!t)return;this.pushUndo({type:"DELETE_ENTRY",data:t,timestamp:Date.now()});const s=this.state.entries.filter(i=>i.id!==e);this.setState({entries:s})}deleteMultiple(e){const t=this.state.entries.filter(i=>e.includes(i.id));if(t.length===0)return;this.pushUndo({type:"DELETE_MULTIPLE",data:t,timestamp:Date.now()});const s=this.state.entries.filter(i=>!e.includes(i.id));this.setState({entries:s,selectMode:!1,selectedEntries:new Set})}clearAll(){this.state.entries.length!==0&&(this.pushUndo({type:"CLEAR_ALL",data:[...this.state.entries],timestamp:Date.now()}),this.setState({entries:[],selectMode:!1,selectedEntries:new Set}))}updateEntry(e,t){const s=this.state.entries.findIndex(a=>a.id===e);if(s===-1)return;const i=this.state.entries[s],o={...i,...t};this.pushUndo({type:"UPDATE_ENTRY",data:i,timestamp:Date.now()});const r=[...this.state.entries];r[s]=o,this.setState({entries:r})}canUndo(){return this.state.undoStack.length>0}canRedo(){return this.state.redoStack.length>0}undo(){if(!this.canUndo())return null;const e=[...this.state.undoStack],t=e.pop(),s=[...this.state.redoStack,t];let i=[...this.state.entries],o=null;switch(t.type){case"ADD_ENTRY":{const r=t.data;i=i.filter(a=>a.id!==r.id),o=r;break}case"DELETE_ENTRY":{const r=t.data;i.push(r),i.sort((a,l)=>new Date(a.timestamp).getTime()-new Date(l.timestamp).getTime()),o=r;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const r=t.data;i=[...i,...r],i.sort((a,l)=>new Date(a.timestamp).getTime()-new Date(l.timestamp).getTime()),o=r;break}case"UPDATE_ENTRY":{const r=t.data,a=i.findIndex(l=>l.id===r.id);a!==-1&&(i[a]=r),o=r;break}}return this.setState({entries:i,undoStack:e,redoStack:s}),o?{type:t.type,data:o}:null}redo(){if(!this.canRedo())return null;const e=[...this.state.redoStack],t=e.pop(),s=[...this.state.undoStack,t];let i=[...this.state.entries],o=null;switch(t.type){case"ADD_ENTRY":{const r=t.data;i.push(r),i.sort((a,l)=>new Date(a.timestamp).getTime()-new Date(l.timestamp).getTime()),o=r;break}case"DELETE_ENTRY":{const r=t.data;i=i.filter(a=>a.id!==r.id),o=r;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const r=t.data,a=new Set(r.map(l=>l.id));i=i.filter(l=>!a.has(l.id)),o=r;break}case"UPDATE_ENTRY":{const r=t.data,a=i.findIndex(l=>l.id===r.id);a!==-1&&(i[a]=r),o=r;break}}return this.setState({entries:i,undoStack:s,redoStack:e}),o}addToSyncQueue(e){const t={entry:e,retryCount:0,lastAttempt:0},s=[...this.state.syncQueue,t];this.setState({syncQueue:s})}removeFromSyncQueue(e){const t=this.state.syncQueue.filter(s=>s.entry.id!==e);this.setState({syncQueue:t})}updateSyncQueueItem(e,t){const s=this.state.syncQueue.map(i=>i.entry.id===e?{...i,...t}:i);this.setState({syncQueue:s})}clearSyncQueue(){this.setState({syncQueue:[]})}setView(e){this.setState({currentView:e},!1)}setLanguage(e){this.setState({currentLang:e})}setBibInput(e){const t=e.replace(/\D/g,"").slice(0,3);this.setState({bibInput:t},!1)}setSelectedPoint(e){this.setState({selectedPoint:e},!1)}setSelectMode(e){this.setState({selectMode:e,selectedEntries:e?this.state.selectedEntries:new Set},!1)}toggleEntrySelection(e){const t=new Set(this.state.selectedEntries);t.has(e)?t.delete(e):t.add(e),this.setState({selectedEntries:t,selectMode:t.size>0},!1)}selectAllEntries(){const e=new Set(this.state.entries.map(t=>t.id));this.setState({selectedEntries:e,selectMode:!0},!1)}clearSelection(){this.setState({selectedEntries:new Set,selectMode:!1},!1)}setRecording(e){this.setState({isRecording:e},!1)}updateSettings(e){const t={...this.state.settings,...e};this.setState({settings:t})}toggleSetting(e){const t={...this.state.settings};t[e]=!t[e],this.setState({settings:t})}setSyncStatus(e){this.setState({syncStatus:e},!1)}setRaceId(e){e!==this.state.raceId?this.setState({raceId:e,undoStack:[],redoStack:[]}):this.setState({raceId:e})}setLastSyncedRaceId(e){this.setState({lastSyncedRaceId:e})}markCurrentRaceAsSynced(){this.setState({lastSyncedRaceId:this.state.raceId})}setDeviceName(e){this.setState({deviceName:e})}addConnectedDevice(e){const t=new Map(this.state.connectedDevices);t.set(e.id,e),this.setState({connectedDevices:t},!1)}removeConnectedDevice(e){const t=new Map(this.state.connectedDevices);t.delete(e),this.setState({connectedDevices:t},!1)}setCloudDeviceCount(e){this.setState({cloudDeviceCount:e},!1)}setCloudHighestBib(e){this.setState({cloudHighestBib:e},!1)}setRaceExistsInCloud(e){this.setState({raceExistsInCloud:e},!1)}setGpsStatus(e,t){this.setState({gpsStatus:e,gpsAccuracy:t??null},!1)}setCameraReady(e,t){this.setState({cameraReady:e,cameraError:t??null},!1)}mergeCloudEntries(e,t=[]){let s=0;const i=new Set(this.state.entries.map(a=>`${a.id}-${a.deviceId}`)),o=new Set(t),r=[];for(const a of e){if(!U(a)||a.deviceId===this.state.deviceId)continue;const l=`${a.id}:${a.deviceId}`;if(o.has(l)||o.has(a.id))continue;const u=`${a.id}-${a.deviceId}`;i.has(u)||(r.push(a),i.add(u),s++)}if(r.length>0){const a=[...this.state.entries,...r];a.sort((l,u)=>new Date(l.timestamp).getTime()-new Date(u.timestamp).getTime()),this.setState({entries:a})}return s}removeDeletedCloudEntries(e){const t=new Set(e);let s=0;const i=this.state.entries.filter(o=>{const r=`${o.id}:${o.deviceId}`;return t.has(r)||t.has(o.id)?(s++,!1):!0});return s>0&&this.setState({entries:i}),s}exportData(){return JSON.stringify({version:K,entries:this.state.entries,settings:this.state.settings,deviceId:this.state.deviceId,deviceName:this.state.deviceName,raceId:this.state.raceId,exportedAt:new Date().toISOString()},null,2)}importData(e){try{const t=JSON.parse(e),s=It(t,this.state.deviceId),i=new Set(this.state.entries.map(r=>r.id)),o=s.entries.filter(r=>!i.has(r.id));if(o.length>0){const r=[...this.state.entries,...o];r.sort((a,l)=>new Date(a.timestamp).getTime()-new Date(l.timestamp).getTime()),this.setState({entries:r})}return{success:!0,entriesImported:o.length}}catch(t){return{success:!1,entriesImported:0,error:String(t)}}}}const c=new wt;function qe(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),s=String(n.getSeconds()).padStart(2,"0"),i=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${s}.${i}`}function Ct(n,e="de"){const t={weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"};return n.toLocaleDateString(e==="de"?"de-DE":"en-US",t)}function Pt(n,e=3){return String(n).padStart(e,"0")}function M(n){const e=document.createElement("div");return e.textContent=String(n),e.innerHTML}function Tt(n){return{S:"var(--success)",F:"var(--secondary)"}[n]||"var(--text-secondary)"}function se(n,e="de"){return{en:{S:"Start",F:"Finish"},de:{S:"Start",F:"Ziel"}}[e][n]}function kt(n,e){let t;return(...s)=>{clearTimeout(t),t=setTimeout(()=>n(...s),e)}}const ke={en:{timer:"Timer",results:"Results",settings:"Settings",start:"Start",finish:"Finish",bib:"Bib",point:"Point",time:"Record time",lastRecorded:"Last recorded",status:"Status",noEntries:"No entries recorded",search:"Search by bib...",filter:"Filter",all:"All",total:"Total",racers:"Racers",finished:"Finished",fastest:"Fastest",average:"Average",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Delete Entry",confirmDeleteText:"Are you sure you want to delete this entry?",confirmClearAll:"Clear All Results",clearAllText:"This will delete all recorded entries. This action cannot be undone.",delete:"Delete",cancel:"Cancel",close:"Close",save:"Save",edit:"Edit",undo:"Undo",export:"Export",clearAll:"Clear All",selectAll:"Select All",deleteSelected:"Delete Selected",connected:"Connected",connecting:"Connecting...",syncing:"Syncing...",offline:"Offline",syncError:"Sync error",syncReceived:"Synced from cloud",raceId:"Race ID",invalidRaceId:"Invalid Race ID. Use letters, numbers, hyphens, underscores only.",deviceName:"Time Keeper ID",cloudSync:"Cloud Sync",syncStatus:"Sync Status",pendingSync:"pending sync",saved:"Saved",deleted:"Deleted",cleared:"All entries cleared",undone:"Undone",copied:"Copied to clipboard",duplicateWarning:"Duplicate entry detected",exported:"Exported successfully",gps:"GPS",gpsActive:"GPS Active",gpsSearching:"Searching for GPS...",gpsInactive:"GPS Inactive",gpsAccuracy:"Accuracy",simpleMode:"Simple Mode",fullMode:"Full Mode",autoIncrement:"Auto-increment Bib",hapticFeedback:"Haptic Feedback",soundFeedback:"Sound Feedback",language:"Language",backup:"Backup",restore:"Restore",importData:"Import Data",exportData:"Export Data",simpleModeDesc:"Simplified interface for basic timing",cloudSyncDesc:"Sync with other devices",gpsDesc:"Use GPS for accurate timestamps",autoIncrementDesc:"Increase bib number after recording",photoCaptureDesc:"Capture photo on timestamp",hapticFeedbackDesc:"Vibration on actions",soundFeedbackDesc:"Audio confirmation",photoCapture:"Photo Capture",photoCaptured:"Photo captured",photoError:"Photo capture failed",viewPhoto:"View Photo",deletePhoto:"Delete Photo",photoFor:"Photo for Bib",noPhotoAvailable:"No photo available",photoDeleted:"Photo deleted",raceChangeTitle:"Change Race",raceChangeSyncedText:"You have results from another race. Export or delete them before switching?",raceChangeUnsyncedText:"You have existing results. Keep them or delete before switching?",keepResults:"Keep",version:"Version",devices:"Devices",entries:"entries",selected:"selected",raceFound:"Race found",raceNew:"New race",entriesInCloud:"entries in cloud",photoTooLarge:"Photo too large for sync",syncedEntriesFromCloud:"Synced {count} entries from cloud",crossDeviceDuplicate:"Duplicate: Bib {bib} {point} already recorded by {device}",syncPhotos:"Sync Photos",syncPhotosDesc:"Share photos across devices via cloud",syncPhotosWarning:"Enable Photo Sync",syncPhotosWarningText:"Enabling photo sync will transfer the following data:",photosToUpload:"Photos to upload",photosToDownload:"Photos to download",totalDataVolume:"Total data volume",enableSync:"Enable Sync",noPhotosToSync:"No photos to sync",admin:"Admin",adminPin:"Race Management PIN",adminPinDesc:"Required to manage and sync races",manageRaces:"Manage Races",manageRacesDesc:"View and delete synced races",manage:"Manage",enterAdminPin:"Enter Race Management PIN",enterPinText:"Enter your PIN to access race management.",enterPinToJoinRace:"Enter your PIN to join this race.",syncRequiresPin:"Sync disabled. Enable sync and enter PIN to reconnect.",incorrectPin:"Incorrect PIN",verify:"Verify",setPinFirst:"Please set a Race Management PIN first",pinSaved:"PIN saved",pinCleared:"PIN cleared",pinNotSet:"Not set",pinSet:"PIN set",setPin:"Set PIN",changePin:"Change PIN",currentPin:"Current PIN",newPin:"New PIN (4 digits)",confirmPin:"Confirm PIN",pinMismatch:"PINs do not match",pinFormatError:"PIN must be exactly 4 digits",loading:"Loading...",noRaces:"No active races",refresh:"Refresh",raceDeleted:"Race Deleted",raceDeletedText:"This race has been deleted by an administrator.",raceDeletedFor:"Race deleted:",raceDeletedSuccess:"Race deleted:",confirmDeleteRace:"Delete Race",confirmDeleteRaceText:"Are you sure you want to delete race",loadError:"Failed to load races",deleteError:"Failed to delete race",entry:"entry",device:"device",storageError:"Failed to save data - check storage",storageQuotaError:"Storage full! Export data immediately",storageWarning:"Storage almost full",networkError:"Network error - check connection",connectionFailed:"Connection failed",serverUnavailable:"Server unavailable",rateLimitError:"Too many requests - please wait",authError:"Authentication failed",syncFailed:"Sync failed",pinSyncFailed:"PIN not synced to cloud",cameraError:"Camera error",cameraPermissionDenied:"Camera access denied",gpsError:"GPS error",gpsPermissionDenied:"GPS access denied",gpsUnavailable:"GPS unavailable",unknownError:"Unknown error"},de:{timer:"Timer",results:"Ergebnisse",settings:"Einstellungen",start:"Start",finish:"Ziel",bib:"Startnr.",point:"Punkt",time:"Zeit erfassen",lastRecorded:"Zuletzt erfasst",status:"Status",noEntries:"Keine Einträge vorhanden",search:"Startnr. suchen...",filter:"Filter",all:"Alle",total:"Gesamt",racers:"Fahrer",finished:"Im Ziel",fastest:"Schnellste",average:"Durchschnitt",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Eintrag löschen",confirmDeleteText:"Möchten Sie diesen Eintrag wirklich löschen?",confirmClearAll:"Alle löschen",clearAllText:"Alle Einträge werden gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.",delete:"Löschen",cancel:"Abbrechen",close:"Schließen",save:"Speichern",edit:"Bearbeiten",undo:"Rückgängig",export:"Exportieren",clearAll:"Alle löschen",selectAll:"Alle auswählen",deleteSelected:"Ausgewählte löschen",connected:"Verbunden",connecting:"Verbinde...",syncing:"Synchronisiere...",offline:"Offline",syncError:"Sync-Fehler",syncReceived:"Von Cloud synchronisiert",raceId:"Rennen-ID",invalidRaceId:"Ungültige Rennen-ID. Nur Buchstaben, Zahlen, Bindestriche, Unterstriche.",deviceName:"Zeitnehmer-ID",cloudSync:"Cloud-Sync",syncStatus:"Sync-Status",pendingSync:"ausstehend",saved:"Gespeichert",deleted:"Gelöscht",cleared:"Alle Einträge gelöscht",undone:"Rückgängig gemacht",copied:"In Zwischenablage kopiert",duplicateWarning:"Doppelter Eintrag erkannt",exported:"Erfolgreich exportiert",gps:"GPS",gpsActive:"GPS Aktiv",gpsSearching:"GPS wird gesucht...",gpsInactive:"GPS Inaktiv",gpsAccuracy:"Genauigkeit",simpleMode:"Einfacher Modus",fullMode:"Erweiterter Modus",autoIncrement:"Auto-Inkrement",hapticFeedback:"Haptisches Feedback",soundFeedback:"Ton-Feedback",language:"Sprache",backup:"Sichern",restore:"Wiederherstellen",importData:"Daten importieren",exportData:"Daten exportieren",simpleModeDesc:"Vereinfachte Oberfläche für einfache Zeitmessung",cloudSyncDesc:"Mit anderen Geräten synchronisieren",gpsDesc:"GPS für genaue Zeitstempel verwenden",autoIncrementDesc:"Startnummer nach Erfassung erhöhen",photoCaptureDesc:"Foto bei Zeiterfassung aufnehmen",hapticFeedbackDesc:"Vibration bei Aktionen",soundFeedbackDesc:"Akustische Bestätigung",photoCapture:"Foto aufnehmen",photoCaptured:"Foto aufgenommen",photoError:"Foto-Aufnahme fehlgeschlagen",viewPhoto:"Foto anzeigen",deletePhoto:"Foto löschen",photoFor:"Foto für Startnr.",noPhotoAvailable:"Kein Foto verfügbar",photoDeleted:"Foto gelöscht",raceChangeTitle:"Rennen wechseln",raceChangeSyncedText:"Es gibt Ergebnisse von einem anderen Rennen. Exportieren oder löschen?",raceChangeUnsyncedText:"Es gibt bestehende Ergebnisse. Behalten oder löschen?",keepResults:"Behalten",version:"Version",devices:"Geräte",entries:"Einträge",selected:"ausgewählt",raceFound:"Rennen gefunden",raceNew:"Neues Rennen",entriesInCloud:"Einträge in der Cloud",photoTooLarge:"Foto zu groß für Sync",syncedEntriesFromCloud:"{count} Einträge aus Cloud synchronisiert",crossDeviceDuplicate:"Duplikat: Startnr. {bib} {point} bereits von {device} erfasst",syncPhotos:"Fotos synchronisieren",syncPhotosDesc:"Fotos über Cloud mit anderen Geräten teilen",syncPhotosWarning:"Foto-Sync aktivieren",syncPhotosWarningText:"Aktivierung der Foto-Synchronisierung überträgt folgende Daten:",photosToUpload:"Fotos hochzuladen",photosToDownload:"Fotos herunterzuladen",totalDataVolume:"Gesamtes Datenvolumen",enableSync:"Sync aktivieren",noPhotosToSync:"Keine Fotos zu synchronisieren",admin:"Admin",adminPin:"Rennverwaltungs-PIN",adminPinDesc:"Erforderlich für Verwaltung und Sync",manageRaces:"Rennen verwalten",manageRacesDesc:"Synchronisierte Rennen anzeigen und löschen",manage:"Verwalten",enterAdminPin:"Rennverwaltungs-PIN eingeben",enterPinText:"Geben Sie Ihre PIN ein, um die Rennverwaltung zu öffnen.",enterPinToJoinRace:"Geben Sie Ihre PIN ein, um diesem Rennen beizutreten.",syncRequiresPin:"Sync deaktiviert. Aktivieren Sie Sync und geben Sie die PIN ein.",incorrectPin:"Falsche PIN",verify:"Bestätigen",setPinFirst:"Bitte zuerst Rennverwaltungs-PIN festlegen",pinSaved:"PIN gespeichert",pinCleared:"PIN gelöscht",pinNotSet:"Nicht gesetzt",pinSet:"PIN gesetzt",setPin:"PIN setzen",changePin:"PIN ändern",currentPin:"Aktuelle PIN",newPin:"Neue PIN (4 Ziffern)",confirmPin:"PIN bestätigen",pinMismatch:"PINs stimmen nicht überein",pinFormatError:"PIN muss genau 4 Ziffern haben",loading:"Laden...",noRaces:"Keine aktiven Rennen",refresh:"Aktualisieren",raceDeleted:"Rennen gelöscht",raceDeletedText:"Dieses Rennen wurde von einem Administrator gelöscht.",raceDeletedFor:"Rennen gelöscht:",raceDeletedSuccess:"Rennen gelöscht:",confirmDeleteRace:"Rennen löschen",confirmDeleteRaceText:"Möchten Sie das Rennen wirklich löschen",loadError:"Fehler beim Laden der Rennen",deleteError:"Fehler beim Löschen des Rennens",entry:"Eintrag",device:"Gerät",storageError:"Speichern fehlgeschlagen - Speicher prüfen",storageQuotaError:"Speicher voll! Daten sofort exportieren",storageWarning:"Speicher fast voll",networkError:"Netzwerkfehler - Verbindung prüfen",connectionFailed:"Verbindung fehlgeschlagen",serverUnavailable:"Server nicht erreichbar",rateLimitError:"Zu viele Anfragen - bitte warten",authError:"Authentifizierung fehlgeschlagen",syncFailed:"Synchronisierung fehlgeschlagen",pinSyncFailed:"PIN nicht in Cloud gespeichert",cameraError:"Kamerafehler",cameraPermissionDenied:"Kamerazugriff verweigert",gpsError:"GPS-Fehler",gpsPermissionDenied:"GPS-Zugriff verweigert",gpsUnavailable:"GPS nicht verfügbar",unknownError:"Unbekannter Fehler"}};function d(n,e="de"){return ke[e][n]||ke.en[n]||n}const w={CRITICAL:"critical",ERROR:"error",WARNING:"warning",INFO:"info"},z={CRITICAL:8e3,ERROR:5e3,WARNING:4e3,INFO:3e3};function Lt(n){return`[${n.component}] ${n.operation}`}function xt(n){return n instanceof Error?n.message:typeof n=="string"?n:"Unknown error"}function Ve(n){const e=Lt(n),t=n.error?xt(n.error):"No error details",s={code:n.code,message:t,timestamp:new Date().toISOString(),...n.metadata};switch(n.severity){case w.CRITICAL:case w.ERROR:console.error(`${e}:`,t,s);break;case w.WARNING:console.warn(`${e}:`,t,s);break;case w.INFO:console.log(`${e}:`,t,s);break}if(n.userMessageKey){const i=c.getState().currentLang,o=d(n.userMessageKey,i),r=At(n.severity),a=z[n.severity.toUpperCase()]||z.ERROR;y(o,r,a)}n.severity===w.CRITICAL&&window.dispatchEvent(new CustomEvent("critical-error",{detail:n}))}function At(n){switch(n){case w.CRITICAL:case w.ERROR:return"error";case w.WARNING:return"warning";case w.INFO:return"info";default:return"error"}}function He(n,e,t,s){Ve({component:n,operation:e,severity:w.ERROR,error:t,userMessageKey:s})}function Ge(n,e,t,s){Ve({component:n,operation:e,severity:w.WARNING,error:t,userMessageKey:s})}const Rt=1e4;class Dt extends Error{constructor(e,t){super(`Request to ${e} timed out after ${t}ms`),this.name="FetchTimeoutError"}}async function L(n,e={},t=Rt){const s=new AbortController,i=setTimeout(()=>s.abort(),t);try{return await fetch(n,{...e,signal:s.signal})}catch(o){throw o instanceof Error&&o.name==="AbortError"?new Dt(n,t):o}finally{clearTimeout(i)}}const Bt={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},Nt=.8,q=1280,V=720,Le=200;class Mt{constructor(){h(this,"stream",null);h(this,"videoElement",null);h(this,"canvasElement",null);h(this,"isInitialized",!1)}async initialize(){if(this.isInitialized)return!0;try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not available");return this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.canvasElement=document.createElement("canvas"),this.canvasElement.width=q,this.canvasElement.height=V,this.stream=await navigator.mediaDevices.getUserMedia(Bt),this.videoElement.srcObject=this.stream,await new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))}),this.isInitialized=!0,c.setCameraReady(!0),console.log("Camera initialized successfully"),!0}catch(e){const t=e instanceof Error?e.message:"Camera initialization failed";return console.error("Camera initialization error:",t),c.setCameraReady(!1,t),!1}}async capturePhoto(){if(!this.isInitialized||!this.videoElement||!this.canvasElement)return console.warn("Camera not initialized"),null;try{const e=this.canvasElement.getContext("2d");if(!e)throw new Error("Could not get canvas context");const t=this.videoElement.videoWidth,s=this.videoElement.videoHeight;let i=t,o=s;if(i>q){const m=q/i;i=q,o=Math.round(o*m)}if(o>V){const m=V/o;o=V,i=Math.round(i*m)}this.canvasElement.width=i,this.canvasElement.height=o,e.drawImage(this.videoElement,0,0,i,o);const r=new Date().toISOString();e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,o-30,i,30),e.fillStyle="#ffffff",e.font="14px monospace",e.fillText(r,10,o-10);const l=this.canvasElement.toDataURL("image/jpeg",Nt).split(",")[1],u=Math.round(l.length/1024);return console.log(`Photo captured: ${u}KB`),u>Le?(console.warn(`Photo too large (${u}KB > ${Le}KB limit), discarding`),null):l}catch(e){return console.error("Photo capture error:",e),null}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null,this.videoElement.remove(),this.videoElement=null),this.isInitialized=!1,c.setCameraReady(!1),console.log("Camera stopped")}isReady(){return this.isInitialized}getError(){return c.getState().cameraError}async toggle(e){return e?this.initialize():(this.stop(),!0)}}const R=new Mt;async function Ft(){return!c.getState().settings.photoCapture||!R.isReady()&&!await R.initialize()?null:R.capturePhoto()}const $t="ski-timer-photos",_t=1,S="photos";class Ut{constructor(){h(this,"db",null);h(this,"initPromise",null)}async initialize(){return this.initPromise?this.initPromise:(this.initPromise=new Promise(e=>{if(!window.indexedDB){console.warn("IndexedDB not supported - photo storage disabled"),e(!1);return}const t=indexedDB.open($t,_t);t.onerror=()=>{console.error("IndexedDB open error:",t.error),e(!1)},t.onsuccess=()=>{this.db=t.result,console.log("Photo storage initialized"),e(!0)},t.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(S)||(i.createObjectStore(S,{keyPath:"entryId"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("Photo store created"))}}),this.initPromise)}async savePhoto(e,t){return!this.db&&!await this.initialize()?!1:new Promise(s=>{if(!this.db){s(!1);return}try{const o=this.db.transaction([S],"readwrite").objectStore(S),r={entryId:e,photo:t,timestamp:Date.now()},a=o.put(r);a.onsuccess=()=>{console.log(`Photo saved for entry ${e}`),s(!0)},a.onerror=()=>{console.error("Photo save error:",a.error),s(!1)}}catch(i){console.error("Photo save transaction error:",i),s(!1)}})}async getPhoto(e){return!this.db&&!await this.initialize()?null:new Promise(t=>{if(!this.db){t(null);return}try{const o=this.db.transaction([S],"readonly").objectStore(S).get(e);o.onsuccess=()=>{const r=o.result;t((r==null?void 0:r.photo)||null)},o.onerror=()=>{console.error("Photo get error:",o.error),t(null)}}catch(s){console.error("Photo get transaction error:",s),t(null)}})}async deletePhoto(e){return!this.db&&!await this.initialize()?!1:new Promise(t=>{if(!this.db){t(!1);return}try{const o=this.db.transaction([S],"readwrite").objectStore(S).delete(e);o.onsuccess=()=>{console.log(`Photo deleted for entry ${e}`),t(!0)},o.onerror=()=>{console.error("Photo delete error:",o.error),t(!1)}}catch(s){console.error("Photo delete transaction error:",s),t(!1)}})}async hasPhoto(e){return await this.getPhoto(e)!==null}async clearAll(){return!this.db&&!await this.initialize()?!1:new Promise(e=>{if(!this.db){e(!1);return}try{const i=this.db.transaction([S],"readwrite").objectStore(S).clear();i.onsuccess=()=>{console.log("All photos cleared"),e(!0)},i.onerror=()=>{console.error("Photo clear error:",i.error),e(!1)}}catch(t){console.error("Photo clear transaction error:",t),e(!1)}})}async deletePhotos(e){for(const t of e)await this.deletePhoto(t)}async getStorageUsage(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{used:e.usage||0,quota:e.quota||0}}catch{return null}return null}async getPhotoCount(){return!this.db&&!await this.initialize()?0:new Promise(e=>{if(!this.db){e(0);return}try{const i=this.db.transaction([S],"readonly").objectStore(S).count();i.onsuccess=()=>{e(i.result)},i.onerror=()=>{e(0)}}catch{e(0)}})}}const T=new Ut,F="/api/sync",ie="skiTimerAuthToken";function $(){const n=localStorage.getItem(ie);return n?{Authorization:`Bearer ${n}`}:{}}function B(){return!!localStorage.getItem(ie)}function zt(n){localStorage.setItem(ie,n)}function Qe(){localStorage.removeItem(ie)}async function je(n){try{const e=await fetch("/api/auth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:n})}),t=await e.json();return e.ok?t.token?(zt(t.token),{success:!0,token:t.token,isNewPin:t.isNewPin}):{success:!1,error:"No token received"}:{success:!1,error:t.error||"Authentication failed"}}catch(e){return console.error("Token exchange error:",e),{success:!1,error:"Network error"}}}const xe=5e3,Ae=3e4,Ot=5,qt=2e3,Vt=1e4,H=8e3;class Ht{constructor(){h(this,"pollInterval",null);h(this,"queueInterval",null);h(this,"broadcastChannel",null);h(this,"consecutiveErrors",0);h(this,"lastSyncTimestamp",0);h(this,"isProcessingQueue",!1)}initialize(){const e=c.getState();if(!e.settings.sync||!e.raceId){this.cleanup();return}this.initBroadcastChannel(e.raceId),this.startPolling(),this.startQueueProcessor(),this.pushLocalEntries(),c.setSyncStatus("connecting"),console.log("Sync service initialized for race:",e.raceId)}initBroadcastChannel(e){try{this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(`ski-timer-${e}`),this.broadcastChannel.onmessage=t=>{const{type:s,data:i}=t.data;if(s==="entry"&&U(i))c.mergeCloudEntries([i]);else if(s==="presence"){const o=i;c.addConnectedDevice(o)}}}catch(t){console.warn("BroadcastChannel not supported:",t)}}broadcastEntry(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"entry",data:e})}catch(t){console.error("Broadcast error:",t)}}broadcastPresence(){const e=c.getState();if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"presence",data:{id:e.deviceId,name:e.deviceName,lastSeen:Date.now()}})}catch(t){console.error("Presence broadcast error:",t)}}startPolling(){this.pollInterval&&clearInterval(this.pollInterval),this.fetchCloudEntries();const e=this.consecutiveErrors>2?Ae:xe;this.pollInterval=setInterval(()=>this.fetchCloudEntries(),e)}adjustPollingInterval(e){e?(this.consecutiveErrors=0,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),xe))):(this.consecutiveErrors++,this.consecutiveErrors>2&&this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),Ae)))}async processCloudPhotos(e){const t=c.getState(),s=[];for(const i of e)i.photo&&i.photo!=="indexeddb"&&i.photo.length>20?t.settings.syncPhotos?await T.savePhoto(i.id,i.photo)?s.push({...i,photo:"indexeddb"}):s.push({...i,photo:void 0}):s.push({...i,photo:void 0}):s.push(i);return s}async fetchCloudEntries(){const e=c.getState();if(!e.settings.sync||!e.raceId)return;const t=e.syncStatus;(t==="connected"||t==="connecting")&&c.setSyncStatus("syncing");try{const s=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),i=await L(`${F}?${s}`,{headers:$()},H);if(i.status===401){let l;try{l=await i.json()}catch{l={}}if(l.expired){Qe(),c.setSyncStatus("disconnected"),window.dispatchEvent(new CustomEvent("auth-expired",{detail:{message:"Session expired. Please re-enter your PIN."}})),this.cleanup();return}throw new Error(`HTTP ${i.status}: ${l.error||"Unauthorized"}`)}if(!i.ok)throw new Error(`HTTP ${i.status}`);let o;try{o=await i.json()}catch{throw new Error("Invalid response format")}if(!o||typeof o!="object")throw new Error("Invalid data structure");if(o.deleted){console.log("Race was deleted by admin, dispatching race-deleted event"),window.dispatchEvent(new CustomEvent("race-deleted",{detail:{raceId:e.raceId,deletedAt:o.deletedAt,message:o.message}})),this.cleanup();return}const r=Array.isArray(o.entries)?o.entries:[],a=Array.isArray(o.deletedIds)?o.deletedIds:[];if(c.setSyncStatus("connected"),typeof o.deviceCount=="number"&&c.setCloudDeviceCount(o.deviceCount),typeof o.highestBib=="number"&&c.setCloudHighestBib(o.highestBib),a.length>0&&c.removeDeletedCloudEntries(a),r.length>0){const l=await this.processCloudPhotos(r),u=c.mergeCloudEntries(l,a);if(u>0){const m=c.getState().currentLang;this.showSyncToast(d("syncedEntriesFromCloud",m).replace("{count}",String(u)))}}this.lastSyncTimestamp=o.lastUpdated||Date.now(),this.adjustPollingInterval(!0)}catch(s){console.error("Cloud sync fetch error:",s);const i=s instanceof Error?s.message:"Unknown error";(s instanceof Error?s.name:"")==="FetchTimeoutError"||i.includes("timed out")||i.includes("500")||i.includes("503")?c.setSyncStatus("error"):i.includes("Failed to fetch")||i.includes("NetworkError")?c.setSyncStatus("offline"):c.setSyncStatus("error"),this.adjustPollingInterval(!1)}}async deleteEntryFromCloud(e,t){const s=c.getState();if(!s.settings.sync||!s.raceId)return!1;try{const i=await L(`${F}?raceId=${encodeURIComponent(s.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json",...$()},body:JSON.stringify({entryId:e,deviceId:t||s.deviceId,deviceName:s.deviceName})},H);if(!i.ok)throw new Error(`HTTP ${i.status}`);return!0}catch(i){return console.error("Cloud sync delete error:",i),!1}}async sendEntryToCloud(e){const t=c.getState();if(!t.settings.sync||!t.raceId)return!1;try{let s={...e};if(t.settings.syncPhotos&&e.photo==="indexeddb"){const o=await T.getPhoto(e.id);o?s={...e,photo:o}:s={...e,photo:void 0}}else e.photo&&(s={...e,photo:void 0});const i=await L(`${F}?raceId=${encodeURIComponent(t.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json",...$()},body:JSON.stringify({entry:s,deviceId:t.deviceId,deviceName:t.deviceName})},H);if(!i.ok)throw new Error(`HTTP ${i.status}`);try{const o=await i.json(),r=c.getState().currentLang;if(o.photoSkipped&&this.showSyncToast(d("photoTooLarge",r),"warning"),o.crossDeviceDuplicate){const a=o.crossDeviceDuplicate,l=se(a.point,r);this.showSyncToast(d("crossDeviceDuplicate",r).replace("{bib}",a.bib).replace("{point}",l).replace("{device}",a.deviceName),"warning",5e3),window.dispatchEvent(new CustomEvent("cross-device-duplicate",{detail:a}))}typeof o.deviceCount=="number"&&c.setCloudDeviceCount(o.deviceCount),typeof o.highestBib=="number"&&c.setCloudHighestBib(o.highestBib)}catch{}return c.removeFromSyncQueue(e.id),!0}catch(s){return console.error("Cloud sync send error:",s),!1}}async pushLocalEntries(){const e=c.getState();if(!(!e.settings.sync||!e.raceId)){console.log("Pushing",e.entries.length,"local entries to cloud");for(const t of e.entries)t.deviceId===e.deviceId&&!t.syncedAt&&await this.sendEntryToCloud(t)}}startQueueProcessor(){this.queueInterval&&clearInterval(this.queueInterval),this.queueInterval=setInterval(()=>this.processQueue(),Vt)}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{const e=c.getState();if(!e.settings.sync||!e.raceId||e.syncQueue.length===0)return;const t=Date.now();for(const s of e.syncQueue){if(s.retryCount>=Ot){console.warn("Max retries exceeded for entry:",s.entry.id),c.removeFromSyncQueue(s.entry.id);continue}const i=qt*Math.pow(2,s.retryCount);if(t-s.lastAttempt<i)continue;await this.sendEntryToCloud(s.entry)||c.updateSyncQueueItem(s.entry.id,{retryCount:s.retryCount+1,lastAttempt:t,error:"Failed to sync"})}}finally{this.isProcessingQueue=!1}}}showSyncToast(e,t="success",s){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:e,type:t,duration:s}}))}cleanup(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null),this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),this.consecutiveErrors=0,c.setSyncStatus("disconnected"),console.log("Sync service cleaned up")}async forceRefresh(){await this.fetchCloudEntries()}getQueueLength(){return c.getState().syncQueue.length}getLastSyncTime(){return this.lastSyncTimestamp}async checkRaceExists(e){if(!e)return{exists:!1,entryCount:0};try{const t=await L(`${F}?raceId=${encodeURIComponent(e)}&checkOnly=true`,{headers:$()},5e3);if(!t.ok)return{exists:!1,entryCount:0};const s=await t.json();return{exists:s.exists===!0,entryCount:typeof s.entryCount=="number"?s.entryCount:0}}catch(t){return console.error("Check race exists error:",t),{exists:!1,entryCount:0}}}async getPhotoSyncStats(){const e=c.getState();let t=0,s=0,i=0,o=0;for(const r of e.entries)if(r.photo==="indexeddb"&&r.deviceId===e.deviceId){const a=await T.getPhoto(r.id);a&&(t++,s+=a.length)}if(e.settings.sync&&e.raceId)try{const r=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),a=await L(`${F}?${r}`,{headers:$()},H);if(a.ok){const l=await a.json(),u=Array.isArray(l.entries)?l.entries:[];for(const m of u)if(m.photo&&m.photo!=="indexeddb"&&m.photo.length>20&&m.deviceId!==e.deviceId){const g=e.entries.find(f=>f.id===m.id&&f.deviceId===m.deviceId);(!g||!g.photo)&&(i++,o+=m.photo.length)}}}catch(r){console.warn("Failed to fetch cloud entries for photo stats:",r)}return{uploadCount:t,uploadSize:s,downloadCount:i,downloadSize:o,totalSize:s+o}}}const v=new Ht,Re={enableHighAccuracy:!0,timeout:1e4,maximumAge:1e3},Gt=10,Qt=30;class jt{constructor(){h(this,"watchId",null);h(this,"lastPosition",null)}start(){if(this.watchId!==null)return!0;if(!navigator.geolocation)return console.error("Geolocation not supported"),c.setGpsStatus("inactive"),!1;c.setGpsStatus("searching");try{return this.watchId=navigator.geolocation.watchPosition(e=>this.handlePosition(e),e=>this.handleError(e),Re),console.log("GPS watching started"),!0}catch(e){return console.error("Failed to start GPS:",e),c.setGpsStatus("inactive"),!1}}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.lastPosition=null,c.setGpsStatus("inactive"),console.log("GPS watching stopped")}handlePosition(e){this.lastPosition=e;const t=e.coords.accuracy;c.setGpsStatus("active",t),console.log(`GPS position: ${t.toFixed(1)}m accuracy`)}handleError(e){switch(console.error("GPS error:",e.message),e.code){case e.PERMISSION_DENIED:c.setGpsStatus("inactive"),this.stop();break;case e.POSITION_UNAVAILABLE:c.setGpsStatus("searching");break;case e.TIMEOUT:c.setGpsStatus("searching");break}}getPosition(){return this.lastPosition}getCoordinates(){if(this.lastPosition)return{latitude:this.lastPosition.coords.latitude,longitude:this.lastPosition.coords.longitude,accuracy:this.lastPosition.coords.accuracy}}getTimestamp(){var e;return((e=this.lastPosition)==null?void 0:e.timestamp)??null}getAccuracyStatus(){if(!this.lastPosition)return"unknown";const e=this.lastPosition.coords.accuracy;return e<=Gt?"good":e<=Qt?"fair":"poor"}isActive(){return this.watchId!==null&&this.lastPosition!==null}toggle(e){return e?this.start():(this.stop(),!0)}async requestPosition(){return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{this.lastPosition=t,e(t)},()=>e(null),Re)}):null}}const oe=new jt;let de=null;function Ye(){if(!de)try{de=new(window.AudioContext||window.webkitAudioContext)}catch(n){return console.warn("AudioContext not available:",n),null}return de}function O(n){if(c.getState().settings.haptic&&navigator.vibrate)try{navigator.vibrate(n)}catch(t){console.warn("Vibration failed:",t)}}function re(n=880,e=100){if(!c.getState().settings.sound)return;const s=Ye();if(s)try{const i=s.createOscillator(),o=s.createGain();i.connect(o),o.connect(s.destination),i.frequency.value=n,i.type="sine",o.gain.setValueAtTime(.3,s.currentTime),o.gain.exponentialRampToValueAtTime(.01,s.currentTime+e/1e3),i.start(s.currentTime),i.stop(s.currentTime+e/1e3)}catch(i){console.warn("Sound playback failed:",i)}}function ye(){O(20),re(880,100)}function b(){O([50,50,50]),re(440,200)}function _(){O(10)}function Ee(){O([30,30,30]),re(330,150)}function Yt(){O([20,20]),re(660,100)}async function De(){const n=Ye();if(n&&n.state==="suspended")try{await n.resume()}catch(e){console.warn("Failed to resume audio:",e)}}class Wt{constructor(e){h(this,"container");h(this,"timeElement");h(this,"dateElement");h(this,"dateRow");h(this,"lastTimeStr","");h(this,"animationId",null);h(this,"isRunning",!1);h(this,"tick",()=>{if(this.isRunning){try{const e=new Date,t=qe(e);if(t!==this.lastTimeStr&&(this.updateDigits(t),this.lastTimeStr=t),e.getSeconds()===0||!this.dateElement.textContent){const i=c.getState();this.dateElement.textContent=Ct(e,i.currentLang)}}catch(e){console.error("Clock tick error:",e)}this.animationId=requestAnimationFrame(this.tick)}});this.container=e,this.container.innerHTML="",this.timeElement=this.createTimeElement(),this.dateRow=this.createDateRow(),this.dateElement=this.dateRow.querySelector(".clock-date"),this.container.appendChild(this.timeElement),this.container.appendChild(this.dateRow),this.moveTimingPointsToDateRow()}moveTimingPointsToDateRow(){const e=document.getElementById("timing-points");e&&this.dateRow&&this.dateRow.appendChild(e)}createTimeElement(){const e=document.createElement("div");e.className="clock-time",e.setAttribute("role","timer"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Current time"),e.style.cssText=`
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(32px, 10vw, 48px);
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    `;for(let t=0;t<12;t++){const s=document.createElement("span");s.className="clock-digit",s.dataset.index=String(t),e.appendChild(s)}return e}createDateRow(){const e=document.createElement("div");e.className="clock-date-row",e.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      padding: 0 8px;
      width: 100%;
    `;const t=document.createElement("div");return t.className="clock-date",t.style.cssText=`
      font-size: 0.875rem;
      color: var(--text-secondary);
    `,e.appendChild(t),e}start(){this.isRunning||(this.isRunning=!0,this.tick())}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}updateDigits(e){const t=this.timeElement.querySelectorAll(".clock-digit");for(let s=0;s<e.length&&s<t.length;s++){const i=t[s],o=e[s];i.textContent!==o&&(i.textContent=o,i.style.transform="scale(1.02)",requestAnimationFrame(()=>{i.style.transform="scale(1)"}))}}getCurrentTime(){return this.lastTimeStr}getTimestamp(){const e=oe.getTimestamp();return e?new Date(e):new Date}destroy(){this.stop(),this.container.innerHTML=""}}const A=72,Be=5,Jt=16;class Kt{constructor(e){h(this,"container");h(this,"scrollContainer");h(this,"contentContainer");h(this,"entries",[]);h(this,"filteredEntries",[]);h(this,"visibleItems",new Map);h(this,"scrollTop",0);h(this,"containerHeight",0);h(this,"options");h(this,"unsubscribe",null);this.options=e,this.container=e.container,this.scrollContainer=document.createElement("div"),this.scrollContainer.className="virtual-scroll-container",this.scrollContainer.style.cssText=`
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    `,this.contentContainer=document.createElement("div"),this.contentContainer.className="virtual-scroll-content",this.contentContainer.style.position="relative",this.scrollContainer.appendChild(this.contentContainer),this.container.appendChild(this.scrollContainer);const t=kt(()=>this.onScroll(),Jt);this.scrollContainer.addEventListener("scroll",t,{passive:!0}),new ResizeObserver(()=>{this.containerHeight=this.scrollContainer.clientHeight,this.render()}).observe(this.scrollContainer),this.unsubscribe=c.subscribe((i,o)=>{(o.includes("entries")||o.includes("selectedEntries"))&&this.setEntries(i.entries)}),this.containerHeight=this.scrollContainer.clientHeight}setEntries(e){for(const t of e){const s=this.entries.find(i=>i.id===t.id);if(s&&(s.bib!==t.bib||s.point!==t.point||s.status!==t.status||s.photo!==t.photo)){const o=this.visibleItems.get(t.id);o&&(o.remove(),this.visibleItems.delete(t.id))}}this.entries=e,this.applyFilters()}applyFilters(e,t,s){let i=[...this.entries];if(e){const o=e.toLowerCase();i=i.filter(r=>{var a;return r.bib.toLowerCase().includes(o)||((a=r.deviceName)==null?void 0:a.toLowerCase().includes(o))})}t&&t!=="all"&&(i=i.filter(o=>o.point===t)),s&&s!=="all"&&(i=i.filter(o=>o.status===s)),i.sort((o,r)=>{const a=parseInt(o.bib,10)||0;return(parseInt(r.bib,10)||0)-a}),this.filteredEntries=i,this.updateContentHeight(),this.render()}updateContentHeight(){const e=this.filteredEntries.length*A;this.contentContainer.style.height=`${e}px`}onScroll(){this.scrollTop=this.scrollContainer.scrollTop,this.render()}render(){if(this.filteredEntries.length===0){this.renderEmpty();return}const e=this.contentContainer.querySelector(".empty-state");e&&e.remove();const t=Math.max(0,Math.floor(this.scrollTop/A)-Be),s=Math.min(this.filteredEntries.length,Math.ceil((this.scrollTop+this.containerHeight)/A)+Be),i=c.getState(),o=new Set;for(let r=t;r<s;r++){const a=this.filteredEntries[r];o.add(a.id);let l=this.visibleItems.get(a.id);const u=i.selectedEntries.has(a.id);l||(l=this.createItem(a),this.visibleItems.set(a.id,l),this.contentContainer.appendChild(l)),l.style.transform=`translateY(${r*A}px)`,l.classList.toggle("selected",u)}for(const[r,a]of this.visibleItems)o.has(r)||(a.remove(),this.visibleItems.delete(r))}createItem(e){const t=document.createElement("div");t.className="result-item",t.setAttribute("role","listitem"),t.setAttribute("data-entry-id",e.id),t.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${A}px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 12px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    `;const s=new Date(e.timestamp),i=qe(s),o=Pt(e.bib||"---"),r=Tt(e.point);t.innerHTML=`
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 50px;">
        ${M(o)}
      </div>
      <div class="result-point" style="padding: 4px 8px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; background: ${r}20; color: ${r};">
        ${M(e.point)}
      </div>
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
        <div class="result-time" style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); font-size: 0.875rem;">
          ${M(i)}
        </div>
        ${e.deviceName?`
          <div class="result-device" style="font-size: 0.7rem; color: var(--text-tertiary);">
            ${M(e.deviceName)}
          </div>
        `:""}
      </div>
      ${e.status!=="ok"?`
        <span class="result-status" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--error); color: white;">
          ${M(e.status.toUpperCase())}
        </span>
      `:""}
      ${e.photo?`
        <button class="result-photo-btn" aria-label="View photo" style="background: none; border: none; color: var(--primary); padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/>
            <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
          </svg>
        </button>
      `:""}
      <button class="result-delete" aria-label="Delete entry" style="background: none; border: none; color: var(--error); padding: 8px; cursor: pointer; opacity: 0.7;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    `,t.querySelector(".result-delete").addEventListener("click",u=>{var m,g;u.stopPropagation(),(g=(m=this.options).onItemDelete)==null||g.call(m,e)});const l=t.querySelector(".result-photo-btn");return l&&l.addEventListener("click",u=>{var m,g;u.stopPropagation(),(g=(m=this.options).onViewPhoto)==null||g.call(m,e)}),t.addEventListener("click",u=>{var m,g;(g=(m=this.options).onItemClick)==null||g.call(m,e,u)}),t.addEventListener("touchstart",()=>{t.style.background="var(--surface-elevated)"},{passive:!0}),t.addEventListener("touchend",()=>{t.style.background="var(--surface)"},{passive:!0}),t}renderEmpty(){for(const t of this.visibleItems.values())t.remove();this.visibleItems.clear();const e=c.getState();this.contentContainer.innerHTML=`
      <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: var(--text-secondary);">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 16px; opacity: 0.5;">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <span id="empty-state-text">${d("noEntries",e.currentLang)}</span>
      </div>
    `}scrollToTop(){this.scrollContainer.scrollTo({top:0,behavior:"smooth"})}scrollToEntry(e){const t=this.filteredEntries.findIndex(s=>s.id===e);if(t!==-1){const s=t*A;this.scrollContainer.scrollTo({top:s,behavior:"smooth"})}}getVisibleCount(){return this.filteredEntries.length}destroy(){this.unsubscribe&&this.unsubscribe(),this.visibleItems.clear(),this.container.innerHTML=""}}const Zt=3e3;class Xt{constructor(){h(this,"container");h(this,"queue",[]);h(this,"isShowing",!1);this.container=this.createContainer(),document.body.appendChild(this.container),window.addEventListener("show-toast",e=>{this.show(e.detail.message,{type:e.detail.type,duration:e.detail.duration})})}createContainer(){const e=document.createElement("div");return e.id="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.style.cssText=`
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    `,e}show(e,t={}){this.queue.push({message:e,options:t}),this.isShowing||this.processQueue()}processQueue(){if(this.queue.length===0){this.isShowing=!1;return}this.isShowing=!0;const{message:e,options:t}=this.queue.shift(),s=t.duration||Zt,i=t.type||"info",o=this.createToast(e,i);this.container.appendChild(o),requestAnimationFrame(()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),setTimeout(()=>{o.style.opacity="0",o.style.transform="translateY(10px)",setTimeout(()=>{o.remove(),this.processQueue()},200)},s)}createToast(e,t){const s=document.createElement("div");s.className=`toast toast-${t}`;const i={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--primary)"},o={success:'<path d="M20 6L9 17l-5-5"/>',error:'<path d="M18 6L6 18M6 6l12 12"/>',warning:'<path d="M12 9v4M12 17h.01"/>',info:'<path d="M12 16v-4M12 8h.01"/>'};return s.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border-left: 3px solid ${i[t]};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 0.875rem;
      color: var(--text-primary);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: auto;
      max-width: 90vw;
    `,s.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${i[t]}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        ${o[t]}
      </svg>
      <span>${this.escapeHtml(e)}</span>
    `,s}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}clear(){this.queue=[],this.container.innerHTML="",this.isShowing=!1}}let ue=null;function We(){return ue||(ue=new Xt),ue}function y(n,e="info",t){We().show(n,{type:e,duration:t})}const G=80,Ne=2.5;class en{constructor(e){h(this,"container");h(this,"indicator");h(this,"onRefresh");h(this,"startY",0);h(this,"currentY",0);h(this,"isPulling",!1);h(this,"isRefreshing",!1);h(this,"scrollableParent",null);h(this,"onTouchStart",e=>{var s;this.isRefreshing||(((s=this.scrollableParent)==null?void 0:s.scrollTop)??0)>0||(this.startY=e.touches[0].clientY,this.isPulling=!0)});h(this,"onTouchMove",e=>{var i;if(!this.isPulling||this.isRefreshing)return;if((((i=this.scrollableParent)==null?void 0:i.scrollTop)??0)>0){this.isPulling=!1;return}this.currentY=e.touches[0].clientY;const s=(this.currentY-this.startY)/Ne;s>0&&(e.preventDefault(),this.updateIndicator(s))});h(this,"onTouchEnd",async()=>{if(!this.isPulling)return;const e=(this.currentY-this.startY)/Ne;this.isPulling=!1,e>=G&&!this.isRefreshing?await this.triggerRefresh():this.resetIndicator()});this.container=e.container,this.onRefresh=e.onRefresh,this.indicator=this.createIndicator(),this.container.insertBefore(this.indicator,this.container.firstChild),this.scrollableParent=this.findScrollableParent(this.container),this.bindEvents()}createIndicator(){const e=document.createElement("div");e.className="pull-indicator",e.style.cssText=`
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: transform 0.2s;
      pointer-events: none;
      z-index: 100;
    `,e.innerHTML=`
      <div class="pull-indicator-content" style="display: flex; align-items: center; gap: 8px;">
        <svg class="pull-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
        <span class="pull-text">Pull to refresh</span>
      </div>
      <div class="pull-spinner" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      </div>
    `;const t=document.createElement("style");return t.textContent=`
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(t),e}findScrollableParent(e){let t=e.parentElement;for(;t;){const s=getComputedStyle(t);if(s.overflowY==="auto"||s.overflowY==="scroll")return t;t=t.parentElement}return null}bindEvents(){this.container.addEventListener("touchstart",this.onTouchStart,{passive:!0}),this.container.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.container.addEventListener("touchend",this.onTouchEnd,{passive:!0})}updateIndicator(e){const t=Math.min(e,G*1.5);this.indicator.style.transform=`translateY(${t}px)`;const s=Math.min(e/G,1),i=this.indicator.querySelector(".pull-icon"),o=this.indicator.querySelector(".pull-text");i&&(i.style.transform=`rotate(${s*180}deg)`),o&&(o.textContent=s>=1?"Release to refresh":"Pull to refresh")}async triggerRefresh(){this.isRefreshing=!0;const e=this.indicator.querySelector(".pull-indicator-content"),t=this.indicator.querySelector(".pull-spinner");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.indicator.style.transform=`translateY(${G}px)`;try{await this.onRefresh()}finally{this.isRefreshing=!1,e&&(e.style.display="flex"),t&&(t.style.display="none"),this.resetIndicator()}}resetIndicator(){this.indicator.style.transform="translateY(0)";const e=this.indicator.querySelector(".pull-icon");e&&(e.style.transform="rotate(0deg)")}destroy(){this.container.removeEventListener("touchstart",this.onTouchStart),this.container.removeEventListener("touchmove",this.onTouchMove),this.container.removeEventListener("touchend",this.onTouchEnd),this.indicator.remove()}}var tn="@vercel/speed-insights",nn="1.3.1",sn=()=>{window.si||(window.si=function(...e){(window.siq=window.siq||[]).push(e)})};function on(){return typeof window<"u"}function rn(){try{const n="production"}catch{}return"production"}function Je(){return rn()==="development"}function an(n){return n.scriptSrc?n.scriptSrc:Je()?"https://va.vercel-scripts.com/v1/speed-insights/script.debug.js":n.dsn?"https://va.vercel-scripts.com/v1/speed-insights/script.js":n.basePath?`${n.basePath}/speed-insights/script.js`:"/_vercel/speed-insights/script.js"}function cn(n={}){var e;if(!on()||n.route===null)return null;sn();const t=an(n);if(document.head.querySelector(`script[src*="${t}"]`))return null;n.beforeSend&&((e=window.si)==null||e.call(window,"beforeSend",n.beforeSend));const s=document.createElement("script");return s.src=t,s.defer=!0,s.dataset.sdkn=tn+(n.framework?`/${n.framework}`:""),s.dataset.sdkv=nn,n.sampleRate&&(s.dataset.sampleRate=n.sampleRate.toString()),n.route&&(s.dataset.route=n.route),n.endpoint?s.dataset.endpoint=n.endpoint:n.basePath&&(s.dataset.endpoint=`${n.basePath}/speed-insights/vitals`),n.dsn&&(s.dataset.dsn=n.dsn),Je()&&n.debug===!1&&(s.dataset.debug="false"),s.onerror=()=>{console.log(`[Vercel Speed Insights] Failed to load script from ${t}. Please check if any content blockers are enabled and try again.`)},document.head.appendChild(s),{setRoute:i=>{s.dataset.route=i??void 0}}}cn();const Ke="/api/admin/races",ln="skiTimerAuthToken";function ve(){const n=localStorage.getItem(ln);return n?{Authorization:`Bearer ${n}`}:{}}async function ae(n){const e=await je(n);return e.success&&ne(),e}function C(n){!n||!n.classList.contains("show")||(n.classList.add("closing"),setTimeout(()=>{n.classList.remove("show","closing")},150))}function I(n,e,t){const s=e.getBoundingClientRect();let i,o;n instanceof TouchEvent&&n.touches.length>0?(i=n.touches[0].clientX-s.left,o=n.touches[0].clientY-s.top):n instanceof MouseEvent?(i=n.clientX-s.left,o=n.clientY-s.top):(i=s.width/2,o=s.height/2);const r=document.createElement("span");r.classList.add("ripple"),t&&r.classList.add(`ripple-${t}`);const a=Math.max(s.width,s.height)*2;r.style.width=`${a}px`,r.style.height=`${a}px`,r.style.left=`${i-a/2}px`,r.style.top=`${o-a/2}px`,e.appendChild(r);const l=setTimeout(()=>{r.remove(),Z.delete(l)},500);Z.add(l)}function dn(){document.querySelectorAll(".num-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>I(t,e),{passive:!0}),e.addEventListener("mousedown",t=>I(t,e))});const n=document.querySelector(".timestamp-btn");n&&(n.classList.add("ripple-container"),n.addEventListener("touchstart",e=>I(e,n,"primary"),{passive:!0}),n.addEventListener("mousedown",e=>I(e,n,"primary"))),document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.add("ripple-container");const t=e.getAttribute("data-point")==="S";e.addEventListener("touchstart",s=>I(s,e,t?"success":"secondary"),{passive:!0}),e.addEventListener("mousedown",s=>I(s,e,t?"success":"secondary"))}),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>I(t,e,"primary"),{passive:!0}),e.addEventListener("mousedown",t=>I(t,e,"primary"))}),document.querySelectorAll(".action-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>I(t,e),{passive:!0}),e.addEventListener("mousedown",t=>I(t,e))}),document.querySelectorAll(".modal-btn").forEach(e=>{e.classList.add("ripple-container");const t=e.classList.contains("primary"),s=e.classList.contains("danger"),i=t?"primary":s?"secondary":void 0;e.addEventListener("touchstart",o=>I(o,e,i),{passive:!0}),e.addEventListener("mousedown",o=>I(o,e,i))})}let k=null,D=null;const Z=new Set;function Me(){const n=document.getElementById("app-version");n&&(n.textContent="3.0.0"),un(),hn(),mn(),gn(),fn(),En(),Sn(),In(),$n(),dn(),c.subscribe(xn);const e=c.getState().settings;if(e.gps&&oe.start(),e.sync&&c.getState().raceId)if(B())v.initialize();else{c.updateSettings({sync:!1});const t=document.getElementById("sync-toggle");t&&(t.checked=!1),setTimeout(()=>{const s=c.getState().currentLang;y(d("syncRequiresPin",s),"info",5e3)},500)}e.photoCapture&&R.initialize(),window.addEventListener("race-deleted",On),window.addEventListener("auth-expired",qn),window.addEventListener("storage-error",Qn),window.addEventListener("storage-warning",jn),document.addEventListener("click",De,{once:!0}),document.addEventListener("touchstart",De,{once:!0}),window.addEventListener("beforeunload",Yn),dt(),An(),console.log("Ski Race Timer initialized")}function un(){k&&(k.destroy(),k=null);const n=document.getElementById("clock-container");n&&(k=new Wt(n),k.start())}function hn(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-view");t&&(c.setView(t),_())})})}function mn(){const n=document.getElementById("number-pad");n&&n.addEventListener("click",e=>{const s=e.target.closest(".num-btn");if(!s)return;const i=s.getAttribute("data-num"),o=s.getAttribute("data-action");if(i){const r=c.getState();r.bibInput.length<3&&(c.setBibInput(r.bibInput+i),_())}else if(o==="clear")c.setBibInput(""),_();else if(o==="delete"){const r=c.getState();c.setBibInput(r.bibInput.slice(0,-1)),_()}})}function gn(){const n=document.getElementById("timing-points");n&&n.addEventListener("click",e=>{const s=e.target.closest(".timing-point-btn");if(!s)return;const i=s.getAttribute("data-point");i&&(c.setSelectedPoint(i),_())})}function fn(){const n=document.getElementById("timestamp-btn");n&&(n.addEventListener("click",async()=>{await Fe()}),document.addEventListener("keydown",e=>{e.key==="Enter"&&c.getState().currentView==="timer"&&(e.preventDefault(),Fe())}))}async function Fe(){const n=c.getState();if(n.isRecording)return;const e=new Date().toISOString(),t=oe.getCoordinates();c.setRecording(!0);try{const s={id:gt(n.deviceId),bib:n.bibInput?n.bibInput.padStart(3,"0"):"",point:n.selectedPoint,timestamp:e,status:"ok",deviceId:n.deviceId,deviceName:n.deviceName,gpsCoords:t};if(n.settings.photoCapture){const o=s.id;Ft().then(async r=>{if(r){if(!c.getState().entries.some(m=>m.id===o)){console.warn("Entry was deleted before photo could be attached:",o);return}await T.savePhoto(o,r)&&c.getState().entries.some(g=>g.id===o)&&c.updateEntry(o,{photo:"indexeddb"})}}).catch(r=>{Ge("Camera","captureTimingPhoto",r,"photoError")})}const i=s.bib&&n.entries.some(o=>o.bib===s.bib&&o.point===s.point);if(c.addEntry(s),i?(b(),pn(s)):(ye(),Ze(s)),v.broadcastEntry(s),n.settings.auto&&n.bibInput&&n.selectedPoint==="F"){const o=parseInt(n.bibInput,10)+1,r=n.settings.sync&&n.cloudHighestBib>0?Math.max(o,n.cloudHighestBib+1):o;c.setBibInput(String(r))}else n.bibInput&&n.settings.auto||c.setBibInput("");yn(s)}finally{c.setRecording(!1)}}function Ze(n){const e=document.getElementById("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-bib"),s=e.querySelector(".confirmation-point"),i=e.querySelector(".confirmation-time");if(t&&(t.textContent=n.bib||"---"),s){const o=c.getState();s.textContent=se(n.point,o.currentLang),s.style.color=te(n.point)}if(i){const o=new Date(n.timestamp);i.textContent=Se(o)}e.dataset.point=n.point,e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},1500)}function pn(n){const e=document.getElementById("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-duplicate");t&&(t.style.display="flex"),Ze(n),setTimeout(()=>{t&&(t.style.display="none")},2500)}function yn(n){const e=document.getElementById("last-recorded");if(!e)return;const t=e.querySelector(".bib"),s=e.querySelector(".point"),i=e.querySelector(".time");if(t&&(t.textContent=n.bib||"---"),s){const o=c.getState();s.textContent=se(n.point,o.currentLang),s.style.background=`${te(n.point)}20`,s.style.color=te(n.point)}if(i){const o=new Date(n.timestamp);i.textContent=Se(o)}e.classList.add("visible")}function $e(n,e){return console.log("showRaceChangeDialog called:",{type:n,lang:e}),new Promise(t=>{const s=document.getElementById("race-change-modal");if(console.log("Modal element:",s),!s){console.log("Modal not found!"),t("cancel");return}const i=s.querySelector(".modal-title"),o=s.querySelector(".modal-text"),r=document.getElementById("race-change-export-btn"),a=document.getElementById("race-change-delete-btn"),l=document.getElementById("race-change-keep-btn"),u=s.querySelector('[data-action="cancel"]');n==="synced"?(i&&(i.textContent=d("raceChangeTitle",e)),o&&(o.textContent=d("raceChangeSyncedText",e)),r&&(r.style.display=""),l&&(l.style.display="none")):(i&&(i.textContent=d("raceChangeTitle",e)),o&&(o.textContent=d("raceChangeUnsyncedText",e)),r&&(r.style.display="none"),l&&(l.style.display=""));const m=()=>{C(s),r==null||r.removeEventListener("click",g),a==null||a.removeEventListener("click",f),l==null||l.removeEventListener("click",p),u==null||u.removeEventListener("click",N)},g=()=>{m(),t("export")},f=()=>{m(),t("delete")},p=()=>{m(),t("keep")},N=()=>{m(),t("cancel")};r==null||r.addEventListener("click",g),a==null||a.addEventListener("click",f),l==null||l.addEventListener("click",p),u==null||u.addEventListener("click",N),console.log("Adding show class to modal"),s.classList.add("show"),console.log("Modal classes after add:",s.classList.toString())})}function En(){const n=document.getElementById("results-list");if(!n)return;D=new Kt({container:n,onItemClick:r=>bn(r),onItemDelete:r=>wn(r),onItemSelect:(r,a)=>{c.toggleEntrySelection(r.id)},onViewPhoto:r=>Tn(r)});const e=c.getState();D.setEntries(e.entries),ce();const t=document.querySelector(".results-view");t&&new en({container:t,onRefresh:async()=>{await v.forceRefresh(),y(d("syncReceived",c.getState().currentLang),"success")}});const s=document.getElementById("search-input");if(s){let r;s.addEventListener("input",()=>{clearTimeout(r),r=setTimeout(()=>{he()},300)})}const i=document.getElementById("filter-point"),o=document.getElementById("filter-status");i&&i.addEventListener("change",he),o&&o.addEventListener("change",he),vn()}function vn(){const n=document.getElementById("clear-all-btn");n&&n.addEventListener("click",()=>{const i=c.getState();if(i.entries.length===0){y(d("noEntries",i.currentLang),"info");return}ge("clearAll")});const e=document.getElementById("undo-btn");e&&e.addEventListener("click",()=>{if(c.canUndo()){const i=c.undo();Yt(),y(d("undone",c.getState().currentLang),"success");const o=c.getState();if(i&&i.type==="ADD_ENTRY"&&o.settings.sync&&o.raceId){const r=i.data;v.deleteEntryFromCloud(r.id,r.deviceId)}}});const t=document.getElementById("export-btn");t&&t.addEventListener("click",Xe);const s=document.getElementById("delete-selected-btn");s&&s.addEventListener("click",()=>{c.getState().selectedEntries.size>0&&ge("deleteSelected")})}function he(){if(!D)return;const n=document.getElementById("search-input"),e=document.getElementById("filter-point"),t=document.getElementById("filter-status");D.applyFilters((n==null?void 0:n.value)||"",(e==null?void 0:e.value)||"all",(t==null?void 0:t.value)||"all"),ce()}function Sn(){const n=document.getElementById("simple-mode-toggle");n&&n.addEventListener("change",()=>{c.updateSettings({simple:n.checked}),dt();const g=document.getElementById("admin-section");g&&(g.style.display=n.checked?"none":"block")});const e=document.getElementById("gps-toggle");e&&e.addEventListener("change",()=>{c.updateSettings({gps:e.checked}),oe.toggle(e.checked)});const t=document.getElementById("sync-toggle");t&&t.addEventListener("change",async()=>{const g=c.getState();if(t.checked&&g.raceId&&!await pe(g.currentLang)){t.checked=!1;return}c.updateSettings({sync:t.checked});const f=document.getElementById("sync-photos-toggle");f&&(f.disabled=!t.checked,t.checked||(f.checked=!1,c.updateSettings({syncPhotos:!1}))),t.checked&&g.raceId?v.initialize():v.cleanup()});const s=document.getElementById("sync-photos-toggle");s&&s.addEventListener("change",async g=>{const f=g.target;f.checked?(g.preventDefault(),f.checked=!1,await Hn()):c.updateSettings({syncPhotos:!1})});const i=document.getElementById("auto-toggle");i&&i.addEventListener("change",()=>{c.updateSettings({auto:i.checked})});const o=document.getElementById("haptic-toggle");o&&o.addEventListener("change",()=>{c.updateSettings({haptic:o.checked})});const r=document.getElementById("sound-toggle");r&&r.addEventListener("change",()=>{c.updateSettings({sound:r.checked})});const a=document.getElementById("photo-toggle");a&&a.addEventListener("change",()=>{c.updateSettings({photoCapture:a.checked}),R.toggle(a.checked)});const l=document.getElementById("lang-toggle");l&&l.addEventListener("click",g=>{const p=g.target.getAttribute("data-lang");p&&p!==c.getState().currentLang&&(c.setLanguage(p),lt(),ct())});const u=document.getElementById("race-id-input");if(u){let g;u.addEventListener("input",()=>{clearTimeout(g);const f=u.value.trim();f?g=setTimeout(()=>Dn(f),500):Ie(null,0)}),u.addEventListener("change",async()=>{const f=u.value.trim(),p=c.getState(),N=p.entries.length>0,we=p.lastSyncedRaceId!=="",Ce=f!==p.raceId&&f!=="";if(console.log("Race ID change:",{newRaceId:f,currentRaceId:p.raceId,hasEntries:N,wasPreviouslySynced:we,isChangingRace:Ce,entriesCount:p.entries.length}),N&&Ce)if(we){const x=await $e("synced",p.currentLang);if(x==="export")Xe(),c.clearAll();else if(x==="delete")c.clearAll();else{u.value=p.raceId;return}}else{const x=await $e("unsynced",p.currentLang);if(x==="delete")c.clearAll();else if(x==="cancel"){u.value=p.raceId;return}}if(f&&!Oe(f)){y(d("invalidRaceId",p.currentLang),"error"),u.value=p.raceId,b();return}if(p.settings.sync&&f&&!await pe(p.currentLang)){u.value=p.raceId;return}p.settings.sync&&p.raceId&&v.cleanup();const le=f.toLowerCase();u.value=le,c.setRaceId(le),p.settings.sync&&le&&(v.initialize(),c.markCurrentRaceAsSynced())})}const m=document.getElementById("device-name-input");m&&m.addEventListener("change",()=>{c.setDeviceName(m.value.trim())})}function In(){document.querySelectorAll(".modal-overlay").forEach(a=>{a.addEventListener("click",l=>{l.target===a&&X()})}),document.querySelectorAll('[data-action="cancel"]').forEach(a=>{a.addEventListener("click",X)});const n=document.getElementById("confirm-delete-btn");n&&n.addEventListener("click",Cn);const e=document.getElementById("save-edit-btn");e&&e.addEventListener("click",Pn);const t=document.getElementById("edit-bib-input");t&&t.addEventListener("input",()=>{t.value=t.value.replace(/[^0-9]/g,"").slice(0,3)});const s=document.getElementById("photo-viewer-close-btn");s&&s.addEventListener("click",j);const i=document.getElementById("photo-viewer-close-footer-btn");i&&i.addEventListener("click",j);const o=document.getElementById("photo-viewer-delete-btn");o&&o.addEventListener("click",kn);const r=document.getElementById("photo-viewer-modal");r&&r.addEventListener("click",a=>{a.target===r&&j()})}function bn(n){const e=document.getElementById("edit-modal");if(!e)return;e.setAttribute("data-entry-id",n.id);const t=document.getElementById("edit-bib-input"),s=document.getElementById("edit-status-select");t&&(t.value=n.bib||""),s&&(s.value=n.status),e.classList.add("show")}function ge(n){const e=document.getElementById("confirm-modal");if(!e)return;const t=c.getState().currentLang,s=e.querySelector(".modal-title"),i=e.querySelector(".modal-text");if(e.setAttribute("data-action",n),n==="clearAll")s&&(s.textContent=d("confirmClearAll",t)),i&&(i.textContent=d("clearAllText",t));else if(n==="deleteSelected"){const o=c.getState().selectedEntries.size;s&&(s.textContent=d("confirmDelete",t)),i&&(i.textContent=`${o} ${d("entries",t)} ${d("selected",t)}`)}else s&&(s.textContent=d("confirmDelete",t)),i&&(i.textContent=d("confirmDeleteText",t));e.classList.add("show")}function wn(n){const e=document.getElementById("confirm-modal");e&&e.setAttribute("data-entry-id",n.id),ge("delete")}async function Cn(){const n=document.getElementById("confirm-modal");if(!n)return;const e=n.getAttribute("data-action"),t=n.getAttribute("data-entry-id"),s=c.getState();if(e==="clearAll"){const i=[...s.entries];if(c.clearAll(),await T.clearAll(),s.settings.sync&&s.raceId)for(const o of i)v.deleteEntryFromCloud(o.id,o.deviceId);y(d("cleared",s.currentLang),"success")}else if(e==="deleteSelected"){const i=Array.from(s.selectedEntries),o=s.entries.filter(r=>i.includes(r.id));if(c.deleteMultiple(i),await T.deletePhotos(i),s.settings.sync&&s.raceId)for(const r of o)v.deleteEntryFromCloud(r.id,r.deviceId);y(d("deleted",s.currentLang),"success")}else if(t){const i=s.entries.find(o=>o.id===t);c.deleteEntry(t),await T.deletePhoto(t),s.settings.sync&&s.raceId&&i&&v.deleteEntryFromCloud(i.id,i.deviceId),y(d("deleted",s.currentLang),"success")}Ee(),X()}function Pn(){const n=document.getElementById("edit-modal");if(!n)return;const e=n.getAttribute("data-entry-id");if(!e)return;const t=document.getElementById("edit-bib-input"),s=document.getElementById("edit-status-select");c.updateEntry(e,{bib:(t==null?void 0:t.value.padStart(3,"0"))||"",status:s==null?void 0:s.value}),y(d("saved",c.getState().currentLang),"success"),X()}function X(){document.querySelectorAll(".modal-overlay.show").forEach(n=>{C(n)})}let ee=null;async function Tn(n){const e=document.getElementById("photo-viewer-modal");if(!e||!n.photo)return;ee=n.id;const t=document.getElementById("photo-viewer-image"),s=document.getElementById("photo-viewer-bib"),i=document.getElementById("photo-viewer-point"),o=document.getElementById("photo-viewer-time");if(t)if(n.photo==="indexeddb"){t.src="";const r=await T.getPhoto(n.id);if(r)t.src=`data:image/jpeg;base64,${r}`;else{console.warn("Photo not found in IndexedDB for entry:",n.id);return}}else t.src=`data:image/jpeg;base64,${n.photo}`;if(s&&(s.textContent=n.bib||"---"),i){const r=c.getState();i.textContent=se(n.point,r.currentLang);const a=te(n.point);i.style.background=a,i.style.color="var(--background)"}if(o){const r=new Date(n.timestamp);o.textContent=Se(r)}e.classList.add("show")}function j(){const n=document.getElementById("photo-viewer-modal");C(n),ee=null}async function kn(){if(!ee)return;const n=c.getState(),e=ee;await T.deletePhoto(e),c.updateEntry(e,{photo:void 0}),j(),y(d("photoDeleted",n.currentLang),"success"),Ee()}function Ln(n){const e=new Date(n),t=e.getHours().toString().padStart(2,"0"),s=e.getMinutes().toString().padStart(2,"0"),i=e.getSeconds().toString().padStart(2,"0"),o=Math.floor(e.getMilliseconds()/10).toString().padStart(2,"0");return`${t}:${s}:${i},${o}`}function _e(n){return n?(/^[=+\-@]/.test(n)&&(n="'"+n),/[";,\n\r]/.test(n)?`"${n.replace(/"/g,'""')}"`:n):""}function Xe(){const n=c.getState();if(n.entries.length===0){y(d("noEntries",n.currentLang),"info");return}const e=["Startnummer","Messpunkt","Zeit","Status","Gerät"],t=n.entries.map(a=>[_e(a.bib),a.point==="S"?"ST":"FT",Ln(a.timestamp),a.status.toUpperCase(),_e(a.deviceName||"")]),s=[e.join(";"),...t.map(a=>a.join(";"))].join(`
`),i=new Blob([s],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(i),r=document.createElement("a");r.href=o,r.download=`race-horology-${new Date().toISOString().slice(0,10)}.csv`,r.click(),URL.revokeObjectURL(o),y(d("exported",n.currentLang),"success")}function xn(n,e){e.includes("currentView")&&et(),e.includes("bibInput")&&tt(),e.includes("selectedPoint")&&nt(),e.includes("entries")&&(D&&D.setEntries(n.entries),ce(),st()),(e.includes("syncStatus")||e.includes("settings")||e.includes("cloudDeviceCount"))&&it(),(e.includes("gpsStatus")||e.includes("settings"))&&ot(),e.includes("settings")&&rt(),e.includes("undoStack")&&at()}function An(){et(),tt(),nt(),ce(),st(),it(),ot(),rt(),at(),Rn(),lt()}function et(){const n=c.getState();document.querySelectorAll(".view").forEach(t=>{t.classList.remove("active")});const e=document.querySelector(`.${n.currentView}-view`);e&&e.classList.add("active"),document.querySelectorAll(".tab-btn").forEach(t=>{t.classList.toggle("active",t.getAttribute("data-view")===n.currentView)})}function tt(){const n=c.getState(),e=document.querySelector(".bib-value");e&&(e.textContent=n.bibInput?n.bibInput.padStart(3,"0"):"---");const t=document.getElementById("timestamp-btn");t&&t.classList.toggle("ready",n.bibInput.length>0)}function nt(){const n=c.getState();document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-point")===n.selectedPoint)})}function ce(){const e=c.getState().entries,t=e.length,s=new Set(e.map(l=>l.bib)).size,i=e.filter(l=>l.point==="F"&&l.status==="ok").length,o=document.getElementById("stat-total"),r=document.getElementById("stat-racers"),a=document.getElementById("stat-finished");o&&(o.textContent=String(t)),r&&(r.textContent=String(s)),a&&(a.textContent=String(i))}function st(){const n=document.getElementById("entry-count-badge");if(n){const e=c.getState().entries.length;n.textContent=String(e),n.style.display=e>0?"inline":"none"}}function it(){const n=c.getState(),e=document.getElementById("sync-indicator"),t=document.querySelector(".sync-dot"),s=document.querySelector(".sync-status-text"),i=document.getElementById("sync-device-count");e&&(e.style.display=n.settings.sync?"flex":"none"),t&&(t.classList.remove("connected","error","offline","syncing"),n.syncStatus==="connected"?t.classList.add("connected"):n.syncStatus==="syncing"?t.classList.add("syncing"):n.syncStatus==="error"?t.classList.add("error"):n.syncStatus==="offline"&&t.classList.add("offline")),s&&(s.textContent=d(n.syncStatus,n.currentLang)),i&&(n.syncStatus==="connected"&&n.cloudDeviceCount>0?(i.textContent=`(${n.cloudDeviceCount})`,i.style.display="inline"):i.style.display="none")}function ot(){const n=c.getState(),e=document.getElementById("gps-indicator"),t=document.querySelector(".gps-dot"),s=document.querySelector(".gps-status-text");e&&(e.style.display=n.settings.gps?"flex":"none"),t&&(t.classList.remove("active","searching"),n.gpsStatus==="active"?t.classList.add("active"):n.gpsStatus==="searching"&&t.classList.add("searching")),s&&(s.textContent="GPS")}function rt(){const n=c.getState(),e=document.getElementById("timestamp-btn");e&&e.classList.toggle("photo-enabled",n.settings.photoCapture)}function at(){const n=document.getElementById("undo-btn");n&&n.toggleAttribute("disabled",!c.canUndo())}function Rn(){const n=c.getState(),{settings:e}=n,t=document.getElementById("simple-mode-toggle"),s=document.getElementById("gps-toggle"),i=document.getElementById("sync-toggle"),o=document.getElementById("auto-toggle"),r=document.getElementById("haptic-toggle"),a=document.getElementById("sound-toggle"),l=document.getElementById("photo-toggle");t&&(t.checked=e.simple);const u=document.getElementById("admin-section");u&&(u.style.display=e.simple?"none":"block"),s&&(s.checked=e.gps),i&&(i.checked=e.sync),o&&(o.checked=e.auto),r&&(r.checked=e.haptic),a&&(a.checked=e.sound),l&&(l.checked=e.photoCapture);const m=document.getElementById("sync-photos-toggle");m&&(m.checked=e.syncPhotos,m.disabled=!e.sync);const g=document.getElementById("race-id-input");g&&(g.value=n.raceId);const f=document.getElementById("device-name-input");f&&(f.value=n.deviceName),ct()}function ct(){const n=c.getState().currentLang,e=document.getElementById("lang-toggle");e&&e.querySelectorAll(".lang-option").forEach(t=>{t.classList.toggle("active",t.getAttribute("data-lang")===n)})}function lt(){const n=c.getState().currentLang;document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.getAttribute("data-i18n");t&&(e.textContent=d(t,n))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const t=e.getAttribute("data-i18n-placeholder");t&&(e.placeholder=d(t,n))}),Ie(fe.exists,fe.entryCount)}function dt(){const n=c.getState().settings;document.querySelectorAll("[data-advanced]").forEach(s=>{s.style.display=n.simple?"none":""});const t=document.querySelector('[data-point="S"]');t&&(t.style.display=n.simple?"none":""),n.simple&&c.setSelectedPoint("F")}function te(n){return{S:"var(--success)",F:"var(--secondary)"}[n]}function Se(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),s=String(n.getSeconds()).padStart(2,"0"),i=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${s}.${i}`}let fe={exists:null,entryCount:0};async function Dn(n){const e=await v.checkRaceExists(n);c.setRaceExistsInCloud(e.exists),Ie(e.exists,e.entryCount)}function Ie(n,e){fe={exists:n,entryCount:e};const t=document.getElementById("race-exists-indicator"),s=document.getElementById("race-exists-text"),i=c.getState().currentLang;if(!(!t||!s)){if(n===null){t.style.display="none";return}t.style.display="inline-flex",t.classList.remove("found","new"),n?(t.classList.add("found"),s.textContent=e>0?`${e} ${d("entriesInCloud",i)}`:d("raceFound",i)):(t.classList.add("new"),s.textContent=d("raceNew",i))}}const Bn="1111";let Y=null;async function Nn(){if(B()){console.log("Auth token already exists");return}const n=await ae(Bn);n.success?n.isNewPin?console.log("Default admin PIN initialized"):console.log("Authenticated with default PIN"):console.log("Custom PIN is set, manual authentication required")}function Mn(n){return/^\d{4}$/.test(n)}function Fn(n){n.addEventListener("input",()=>{n.value=n.value.replace(/[^0-9]/g,"")})}function ne(){const n=c.getState().currentLang,e=B(),t=document.getElementById("admin-pin-status"),s=document.getElementById("change-pin-btn-text");t&&(t.textContent=d(e?"pinSet":"pinNotSet",n)),s&&(s.textContent=d(e?"changePin":"setPin",n))}function $n(){Nn().then(()=>{ne()}),ne();const n=document.getElementById("change-pin-btn");n&&n.addEventListener("click",_n);const e=document.getElementById("save-pin-btn");e&&e.addEventListener("click",Un),["admin-pin-verify-input","current-pin-input","new-pin-input","confirm-pin-input"].forEach(m=>{const g=document.getElementById(m);g&&Fn(g)});const s=document.getElementById("manage-races-btn");s&&s.addEventListener("click",Wn);const i=document.getElementById("admin-pin-verify-btn");i&&i.addEventListener("click",()=>{P?ze():Ue()});const o=document.getElementById("admin-pin-verify-input");o&&o.addEventListener("keydown",m=>{m.key==="Enter"&&(P?ze():Ue())});const r=document.getElementById("admin-pin-modal");r&&r.addEventListener("click",m=>{m.target===r&&P&&Jn()});const a=document.getElementById("race-deleted-ok-btn");a&&a.addEventListener("click",()=>{const m=document.getElementById("race-deleted-modal");C(m)});const l=document.getElementById("refresh-races-btn");l&&l.addEventListener("click",be);const u=document.getElementById("confirm-delete-race-btn");u&&u.addEventListener("click",es),Gn()}function _n(){const n=c.getState().currentLang,e=B(),t=document.getElementById("change-pin-modal"),s=document.getElementById("change-pin-modal-title"),i=document.getElementById("current-pin-row"),o=document.getElementById("current-pin-input"),r=document.getElementById("new-pin-input"),a=document.getElementById("confirm-pin-input");t&&(o&&(o.value=""),r&&(r.value=""),a&&(a.value=""),ut(),e?(i&&(i.style.display="block"),s&&(s.textContent=d("changePin",n))):(i&&(i.style.display="none"),s&&(s.textContent=d("setPin",n))),t.classList.add("show"),e&&o?o.focus():r&&r.focus())}function ut(){["current-pin-error","pin-mismatch-error","pin-format-error"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="none")})}async function Un(){const n=c.getState().currentLang,e=B(),t=document.getElementById("current-pin-input"),s=document.getElementById("new-pin-input"),i=document.getElementById("confirm-pin-input"),o=document.getElementById("current-pin-error"),r=document.getElementById("pin-mismatch-error"),a=document.getElementById("pin-format-error");if(ut(),e){const g=(t==null?void 0:t.value)||"";if(!(await je(g)).success){o&&(o.style.display="block"),t&&(t.value="",t.focus()),b();return}}const l=(s==null?void 0:s.value)||"",u=(i==null?void 0:i.value)||"";if(!Mn(l)){a&&(a.style.display="block"),s&&s.focus(),b();return}if(l!==u){r&&(r.style.display="block"),i&&(i.value="",i.focus()),b();return}const m=await zn(l);try{const g=await fetch("/api/admin/pin",{method:"POST",headers:{...ve(),"Content-Type":"application/json"},body:JSON.stringify({pinHash:m})});if(!g.ok)throw new Error(`HTTP ${g.status}`);if(Qe(),!(await ae(l)).success){y(d("pinSyncFailed",n),"error"),b();return}const p=document.getElementById("change-pin-modal");C(p),y(d("pinSaved",n),"success"),ye(),ne()}catch(g){Ge("Admin","handleSavePin",g,"pinSyncFailed"),y(d("pinSyncFailed",n),"error"),b()}}async function zn(n){const t=new TextEncoder().encode(n),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map(o=>o.toString(16).padStart(2,"0")).join("")}function On(n){const{raceId:e,message:t}=n.detail,s=c.getState().currentLang,i=document.getElementById("race-deleted-text");i&&(i.textContent=`${d("raceDeletedFor",s)} "${e}". ${t||d("raceDeletedText",s)}`);const o=document.getElementById("race-deleted-modal");o&&o.classList.add("show"),c.updateSettings({sync:!1}),c.setRaceId("");const r=document.getElementById("sync-toggle");r&&(r.checked=!1);const a=document.getElementById("race-id-input");a&&(a.value=""),b()}function qn(n){const{message:e}=n.detail,t=c.getState().currentLang;y(e||"Session expired. Please re-enter your PIN.","warning",5e3),pe(t).then(s=>{if(s){const i=c.getState();i.settings.sync&&i.raceId&&v.initialize(),y("Authentication successful","success")}}),b()}function Vn(n){if(n===0)return"0 B";const e=1024,t=["B","KB","MB","GB"],s=Math.floor(Math.log(n)/Math.log(e));return parseFloat((n/Math.pow(e,s)).toFixed(1))+" "+t[s]}async function Hn(){const n=document.getElementById("photo-sync-modal");if(!n)return;const e=c.getState().currentLang,t=document.getElementById("photos-upload-count"),s=document.getElementById("photos-download-count"),i=document.getElementById("photos-total-size");t&&(t.textContent=d("loading",e)),s&&(s.textContent=d("loading",e)),i&&(i.textContent=d("loading",e)),n.classList.add("show");const o=await v.getPhotoSyncStats();t&&(t.textContent=String(o.uploadCount)),s&&(s.textContent=String(o.downloadCount)),i&&(i.textContent=Vn(o.totalSize));const r=document.getElementById("photo-sync-confirm-btn");if(r){const a=o.uploadCount>0||o.downloadCount>0;r.textContent=d("enableSync",e)}}function Gn(){const n=document.getElementById("photo-sync-modal"),e=document.getElementById("photo-sync-cancel-btn"),t=document.getElementById("photo-sync-confirm-btn");e&&e.addEventListener("click",()=>{n&&n.classList.remove("show")}),t&&t.addEventListener("click",()=>{c.updateSettings({syncPhotos:!0});const s=document.getElementById("sync-photos-toggle");s&&(s.checked=!0),n&&n.classList.remove("show");const i=c.getState();i.settings.sync&&i.raceId&&v.forceRefresh(),ye()}),n&&n.addEventListener("click",s=>{s.target===n&&n.classList.remove("show")})}function Qn(n){const{isQuotaError:e,entryCount:t}=n.detail,s=c.getState().currentLang;e?y(d("storageQuotaError",s),"error",z.CRITICAL):y(d("storageError",s),"error",z.ERROR),b(),console.error("[Storage] saveEntries:",n.detail.message,{entryCount:t,isQuotaError:e})}function jn(n){const{percent:e}=n.detail,t=c.getState().currentLang;sessionStorage.getItem("storage-warning-shown")||(y(`${d("storageWarning",t)} (${e}%)`,"warning",z.WARNING),sessionStorage.setItem("storage-warning-shown","true"))}function Yn(){if(k){try{k.destroy()}catch(n){console.warn("Clock cleanup error:",n)}k=null}v.cleanup(),R.stop();for(const n of Z)clearTimeout(n);Z.clear(),document.querySelectorAll(".ripple").forEach(n=>n.remove())}function Wn(){const n=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input"),t=document.getElementById("admin-pin-error"),s=document.getElementById("admin-pin-modal-title"),i=document.getElementById("admin-pin-modal-text"),o=c.getState().currentLang;n&&e&&t&&(e.value="",t.style.display="none",s&&(s.textContent=d("enterAdminPin",o)),i&&(i.textContent=d("enterPinText",o)),n.classList.add("show"),e.focus())}async function Ue(){const n=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),t=document.getElementById("admin-pin-modal");if(!n||!t)return;const s=n.value.trim();(await ae(s)).success?(C(t),n.value="",e&&(e.style.display="none"),Kn()):(e&&(e.style.display="block"),n.value="",n.focus(),b())}let P=null;function pe(n){return new Promise(e=>{if(B()){e(!0);return}const t=document.getElementById("admin-pin-modal"),s=document.getElementById("admin-pin-modal-title"),i=document.getElementById("admin-pin-modal-text"),o=document.getElementById("admin-pin-verify-input"),r=document.getElementById("admin-pin-error");if(!t||!o){e(!1);return}s&&(s.textContent=d("enterAdminPin",n)),i&&(i.textContent=d("enterPinToJoinRace",n)),r&&(r.style.display="none"),o.value="",P=e,t.classList.add("show"),setTimeout(()=>o.focus(),100)})}async function ze(){const n=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),t=document.getElementById("admin-pin-modal");if(!n||!t||!P)return;const s=n.value.trim();(await ae(s)).success?(C(t),n.value="",e&&(e.style.display="none"),P(!0),P=null):(e&&(e.style.display="block"),n.value="",n.focus(),b())}function Jn(){const n=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input");C(n),e&&(e.value=""),P&&(P(!1),P=null)}function Kn(){const n=document.getElementById("race-management-modal");n&&(n.classList.add("show"),be())}async function be(){const n=document.getElementById("race-list"),e=document.getElementById("race-list-loading"),t=document.getElementById("race-list-empty"),s=c.getState().currentLang;if(n){e&&(e.style.display="block"),t&&(t.style.display="none"),n.querySelectorAll(".race-item").forEach(i=>i.remove());try{const i=await L(Ke,{headers:ve()},1e4);if(!i.ok){if(i.status===401){const a=document.getElementById("race-management-modal");C(a),y(d("authError",s),"error"),console.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${i.status}`)}const r=(await i.json()).races||[];if(e&&(e.style.display="none"),r.length===0){t&&(t.style.display="block");return}r.forEach(a=>{const l=Zn(a,s);n.appendChild(l)})}catch(i){He("Admin","loadRaceList",i,"loadError"),e&&(e.style.display="none")}}}function Zn(n,e){const t=document.createElement("div");t.className="race-item",t.setAttribute("data-race-id",n.raceId);const s=document.createElement("div");s.className="race-info";const i=document.createElement("span");i.className="race-id",i.textContent=n.raceId.toUpperCase();const o=document.createElement("span");o.className="race-meta";const r=n.entryCount===1?d("entry",e):d("entries",e),a=n.deviceCount===1?d("device",e):d("devices",e);o.textContent=`${n.entryCount} ${r}, ${n.deviceCount} ${a}`,s.appendChild(i),s.appendChild(o);const l=document.createElement("button");return l.className="race-delete-btn danger",l.textContent=d("delete",e),l.addEventListener("click",()=>Xn(n.raceId)),t.appendChild(s),t.appendChild(l),t}function Xn(n){const e=c.getState().currentLang;Y=n;const t=document.getElementById("delete-race-confirm-modal"),s=document.getElementById("delete-race-confirm-text");s&&(s.textContent=`${d("confirmDeleteRaceText",e)} "${n.toUpperCase()}"?`),t&&t.classList.add("show")}async function es(){if(!Y)return;const n=Y,e=c.getState().currentLang,t=document.getElementById("delete-race-confirm-modal");C(t);try{const s=await L(`${Ke}?raceId=${encodeURIComponent(n)}`,{method:"DELETE",headers:ve()},1e4);if(!s.ok){if(s.status===401){const o=document.getElementById("race-management-modal");C(o),y(d("authError",e),"error"),console.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${s.status}`)}const i=await s.json();if(i.success)y(`${d("raceDeletedSuccess",e)} ${n.toUpperCase()}`,"success"),Ee(),be();else throw new Error(i.error||d("unknownError",e))}catch(s){He("Admin","deleteRace",s,"deleteError")}finally{Y=null}}We();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Me):Me();"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const n=await navigator.serviceWorker.register("/sw.js");console.log("Service Worker registered:",n.scope),n.addEventListener("updatefound",()=>{const e=n.installing;e&&e.addEventListener("statechange",()=>{e.state==="installed"&&navigator.serviceWorker.controller&&console.log("New version available")})})}catch(n){console.error("Service Worker registration failed:",n)}});document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&console.log("App resumed")});window.addEventListener("online",()=>{console.log("App is online")});window.addEventListener("offline",()=>{console.log("App is offline")});window.addEventListener("beforeunload",()=>{});console.log("Ski Race Timer v3.0.0");
