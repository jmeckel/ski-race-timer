import{u as A,L as k,m as ue,W as B,t as d,s as l,h as v,X as j,Y as ge,a as p,f as W,Z as fe,_ as me,a0 as Z,a1 as ie,R as pe,q as b,a2 as ye,p as u,d as z,o as D,e as he,i as Q,V as Ee,Q as J,a3 as ve,a4 as Y,a5 as Ie,a6 as Se,a7 as be}from"./chief-judge-DzOMKuKA.js";import{o as I,c as h,u as ke}from"./gate-judge-KS1_pNnj.js";const X=new k;let y=null;async function V(e,t){const n=await me(e,t);return n.success&&T(),n}async function we(){B()}function ee(e){return/^\d{4}$/.test(e)}function T(){const e=l.getState().currentLang,t=B(),n=document.getElementById("admin-pin-status"),a=document.getElementById("change-pin-btn-text");n&&(n.textContent=t?d("pinSet",e):d("pinNotSet",e)),a&&(a.textContent=t?d("changePin",e):d("setPin",e))}function Re(){const e=l.getState().currentLang,t=B(),n=document.getElementById("change-pin-modal"),a=document.getElementById("change-pin-modal-title"),i=document.getElementById("current-pin-row"),o=document.getElementById("current-pin-input"),c=document.getElementById("new-pin-input"),s=document.getElementById("confirm-pin-input");n&&(o&&(o.value=""),c&&(c.value=""),s&&(s.value=""),oe(),t?(i&&(i.style.display="block"),a&&(a.textContent=d("changePin",e))):(i&&(i.style.display="none"),a&&(a.textContent=d("setPin",e))),I(n),t&&o?o.focus():c&&c.focus())}function oe(){["current-pin-error","pin-mismatch-error","pin-format-error"].forEach(t=>{const n=document.getElementById(t);n&&(n.style.display="none")})}async function xe(){const e=l.getState().currentLang,t=B(),n=document.getElementById("current-pin-input"),a=document.getElementById("new-pin-input"),i=document.getElementById("confirm-pin-input"),o=document.getElementById("save-pin-btn"),c=document.getElementById("current-pin-error"),s=document.getElementById("pin-mismatch-error"),r=document.getElementById("pin-format-error");oe();const g=(n==null?void 0:n.value)||"",f=(a==null?void 0:a.value)||"",S=(i==null?void 0:i.value)||"";if(!ee(f)){r&&(r.style.display="block"),a&&a.focus(),v();return}if(f!==S){s&&(s.style.display="block"),i&&(i.value="",i.focus()),v();return}if(t){if(!ee(g)){c&&(c.style.display="block"),n&&n.focus(),v();return}const E=(o==null?void 0:o.textContent)||"";o&&(o.disabled=!0,o.textContent=d("saving",e));try{const m=await fetch("/api/v1/admin/pin",{method:"POST",headers:{...j(),"Content-Type":"application/json"},body:JSON.stringify({currentPin:g,newPin:f})});if(m.status===401){c&&(c.style.display="block"),n&&(n.value="",n.focus()),v();return}if(!m.ok)throw new Error(`HTTP ${m.status}`);if(ge(),!(await V(f)).success){p(d("pinSyncFailed",e),"error"),v();return}const de=document.getElementById("change-pin-modal");h(de),p(d("pinSaved",e),"success"),W(),T()}catch(m){fe("Admin","handleSavePin",m,"pinSyncFailed"),p(d("pinSyncFailed",e),"error"),v()}finally{o&&(o.disabled=!1,o.textContent=E)}}else{const E=(o==null?void 0:o.textContent)||"";o&&(o.disabled=!0,o.textContent=d("saving",e));try{if(!(await V(f)).success){p(d("pinSyncFailed",e),"error"),v();return}const P=document.getElementById("change-pin-modal");h(P),p(d("pinSaved",e),"success"),W(),T()}finally{o&&(o.disabled=!1,o.textContent=E)}}}function K(e){return new Promise(t=>{if(B()){t(!0);return}const n=document.getElementById("admin-pin-modal"),a=document.getElementById("admin-pin-modal-title"),i=document.getElementById("admin-pin-modal-text"),o=document.getElementById("admin-pin-verify-input"),c=document.getElementById("admin-pin-error");if(!n||!o){t(!1);return}a&&(a.textContent=d("enterAdminPin",e)),i&&(i.textContent=d("enterPinToJoinRace",e)),c&&(c.style.display="none"),o.value="",y={type:"raceJoin",resolve:t},I(n),setTimeout(()=>o.focus(),100)})}function ut(e){return new Promise(t=>{const n=document.getElementById("admin-pin-modal"),a=document.getElementById("admin-pin-modal-title"),i=document.getElementById("admin-pin-modal-text"),o=document.getElementById("admin-pin-verify-input"),c=document.getElementById("admin-pin-error");if(!n||!o){t(!1);return}a&&(a.textContent=d("enterChiefJudgePin",e)),i&&(i.textContent=d("enterPinForChiefJudgeInfo",e)),c&&(c.style.display="none"),o.value="",y={type:"chiefJudge",resolve:t},I(n),setTimeout(()=>o.focus(),100)})}async function te(){const e=document.getElementById("admin-pin-verify-input"),t=document.getElementById("admin-pin-error"),n=document.getElementById("admin-pin-modal");if(!e||!n||!y)return;const a=e.value.trim(),i=y.type==="chiefJudge"?"chiefJudge":void 0;(await V(a,i)).success?(h(n),e.value="",t&&(t.style.display="none"),y.resolve(!0),y=null):(t&&(t.style.display="block"),e.value="",e.focus(),v())}function Ce(){const e=document.getElementById("admin-pin-modal"),t=document.getElementById("admin-pin-verify-input");h(e),t&&(t.value=""),y&&(y.resolve(!1),y=null)}function gt(){return y?(y.resolve(!1),y=null,!0):!1}function U(){return y!==null}function Ae(){we().then(()=>{T()}).catch(a=>{A.error("Failed to initialize admin PIN:",a)}),T();const e=document.getElementById("change-pin-btn");e&&X.add(e,"click",Re);const t=document.getElementById("save-pin-btn");t&&X.add(t,"click",xe),["admin-pin-verify-input","current-pin-input","new-pin-input","confirm-pin-input"].forEach(a=>{const i=document.getElementById(a);i&&ue(i)})}const H=new k,se="/api/v1/admin/races";let $=null;function Be(){const e=document.getElementById("admin-pin-modal"),t=document.getElementById("admin-pin-verify-input"),n=document.getElementById("admin-pin-error"),a=document.getElementById("admin-pin-modal-title"),i=document.getElementById("admin-pin-modal-text"),o=l.getState().currentLang;e&&t&&n&&(t.value="",n.style.display="none",a&&(a.textContent=d("enterAdminPin",o)),i&&(i.textContent=d("enterPinText",o)),I(e),t.focus())}async function ne(){const e=document.getElementById("admin-pin-verify-input"),t=document.getElementById("admin-pin-error"),n=document.getElementById("admin-pin-modal");if(!e||!n)return;const a=e.value.trim();(await V(a)).success?(h(n),e.value="",t&&(t.style.display="none"),Pe()):(t&&(t.style.display="block"),e.value="",e.focus(),v())}function Pe(){const e=document.getElementById("race-management-modal");e&&(I(e),G())}async function G(){const e=document.getElementById("race-list"),t=document.getElementById("race-list-loading"),n=document.getElementById("race-list-empty"),a=l.getState().currentLang;if(e){e.setAttribute("aria-busy","true"),t&&(t.style.display="block"),n&&(n.style.display="none"),e.querySelectorAll(".race-item").forEach(i=>i.remove());try{const i=await Z(se,{headers:j()},1e4);if(!i.ok){if(i.status===401){const s=document.getElementById("race-management-modal");h(s),p(d("authError",a),"error"),A.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${i.status}`)}const c=(await i.json()).races||[];if(e.setAttribute("aria-busy","false"),t&&(t.style.display="none"),c.length===0){n&&(n.style.display="block");return}c.forEach(s=>{const r=Te(s,a);e.appendChild(r)})}catch(i){ie("Admin","loadRaceList",i,"loadError"),p(d("loadError",a),"error"),e.setAttribute("aria-busy","false"),t&&(t.style.display="none")}}}function Te(e,t){const n=document.createElement("div");n.className="race-item",n.setAttribute("data-race-id",e.raceId);const a=document.createElement("div");a.className="race-info";const i=document.createElement("span");i.className="race-id",i.textContent=e.raceId.toUpperCase();const o=document.createElement("span");o.className="race-meta";const c=e.entryCount===1?d("entry",t):d("entries",t),s=e.deviceCount===1?d("device",t):d("devices",t);o.textContent=`${e.entryCount} ${c}, ${e.deviceCount} ${s}`,a.appendChild(i),a.appendChild(o);const r=document.createElement("button");return r.className="race-delete-btn danger",r.textContent=d("delete",t),r.addEventListener("click",()=>Le(e.raceId)),n.appendChild(a),n.appendChild(r),n}function Le(e){const t=l.getState().currentLang;$=e;const n=document.getElementById("delete-race-confirm-modal"),a=document.getElementById("delete-race-confirm-text");a&&(a.textContent=`${d("confirmDeleteRaceText",t)} "${e.toUpperCase()}"?`),n&&I(n)}async function De(){if(!$)return;const e=$,t=l.getState().currentLang,n=document.getElementById("delete-race-confirm-modal");h(n);try{const a=await Z(`${se}?raceId=${encodeURIComponent(e)}`,{method:"DELETE",headers:j()},1e4);if(!a.ok){if(a.status===401){const o=document.getElementById("race-management-modal");h(o),p(d("authError",t),"error"),A.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${a.status}`)}const i=await a.json();if(i.success)p(`${d("raceDeletedSuccess",t)} ${e.toUpperCase()}`,"success"),pe(),G();else throw new Error(i.error||d("unknownError",t))}catch(a){ie("Admin","deleteRace",a,"deleteError")}finally{$=null}}function $e(){const e=document.getElementById("manage-races-btn");e&&H.add(e,"click",Be);const t=document.getElementById("refresh-races-btn");t&&H.add(t,"click",G);const n=document.getElementById("confirm-delete-race-btn");n&&H.add(n,"click",De)}const M=new k;function ft(e,t){return new Promise(n=>{const a=document.getElementById("race-change-modal");if(!a){n("cancel");return}const i=a.querySelector(".modal-title"),o=a.querySelector(".modal-text"),c=document.getElementById("race-change-export-btn"),s=document.getElementById("race-change-delete-btn"),r=document.getElementById("race-change-keep-btn"),g=a.querySelector('[data-action="cancel"]');e==="synced"?(i&&(i.textContent=d("raceChangeTitle",t)),o&&(o.textContent=d("raceChangeSyncedText",t)),c&&(c.style.display=""),r&&(r.style.display="none")):(i&&(i.textContent=d("raceChangeTitle",t)),o&&(o.textContent=d("raceChangeUnsyncedText",t)),c&&(c.style.display="none"),r&&(r.style.display=""));const f=()=>{h(a),c==null||c.removeEventListener("click",S),s==null||s.removeEventListener("click",E),r==null||r.removeEventListener("click",m),g==null||g.removeEventListener("click",P)},S=()=>{f(),n("export")},E=()=>{f(),n("delete")},m=()=>{f(),n("keep")},P=()=>{f(),n("cancel")};c==null||c.addEventListener("click",S),s==null||s.addEventListener("click",E),r==null||r.addEventListener("click",m),g==null||g.addEventListener("click",P),I(a)})}function mt(e){const{raceId:t,message:n}=e.detail,a=l.getState().currentLang,i=document.getElementById("race-deleted-text");i&&(i.textContent=`${d("raceDeletedFor",a)} "${t}". ${n||d("raceDeletedText",a)}`);const o=document.getElementById("race-deleted-modal");o&&I(o),l.updateSettings({sync:!1}),l.setRaceId("");const c=document.getElementById("sync-toggle");c&&(c.checked=!1);const s=document.getElementById("race-id-input");s&&(s.value=""),v()}function pt(e){const{message:t}=e.detail,n=l.getState().currentLang;p(t||d("sessionExpired",n),"warning",5e3),K(n).then(a=>{if(a){const i=l.getState();i.settings.sync&&i.raceId&&b.initialize(),p(d("authSuccess",n),"success")}}).catch(a=>A.error("Re-auth failed:",a)),v()}async function yt(){const e=document.getElementById("photo-sync-modal");if(!e)return;const t=l.getState().currentLang,n=document.getElementById("photos-upload-count"),a=document.getElementById("photos-download-count"),i=document.getElementById("photos-total-size");n&&(n.textContent=d("loading",t)),a&&(a.textContent=d("loading",t)),i&&(i.textContent=d("loading",t)),I(e);const o=await b.getPhotoSyncStats();n&&(n.textContent=String(o.uploadCount)),a&&(a.textContent=String(o.downloadCount)),i&&(i.textContent=ye(o.totalSize));const c=document.getElementById("photo-sync-confirm-btn");c&&(c.textContent=d("enableSync",t))}function Me(){const e=document.getElementById("photo-sync-modal"),t=document.getElementById("photo-sync-cancel-btn"),n=document.getElementById("photo-sync-confirm-btn");t&&M.add(t,"click",()=>{h(e)}),n&&M.add(n,"click",()=>{l.updateSettings({syncPhotos:!0});const a=document.getElementById("sync-photos-toggle");a&&(a.checked=!0),h(e);const i=l.getState();i.settings.sync&&i.raceId&&b.forceRefresh(),W()}),e&&M.add(e,"click",a=>{a.target===e&&h(e)})}function Ne(){const e=document.getElementById("race-deleted-ok-btn");e&&M.add(e,"click",()=>{const t=document.getElementById("race-deleted-modal");h(t)}),Me()}const _=new k;function ht(){Ae(),$e(),Ne();const e=document.getElementById("admin-pin-verify-btn");e&&_.add(e,"click",()=>{U()?te():ne()});const t=document.getElementById("admin-pin-verify-input");t&&_.add(t,"keydown",(a=>{a.key==="Enter"&&(U()?te():ne())}));const n=document.getElementById("admin-pin-modal");n&&_.add(n,"click",a=>{a.target===n&&U()&&Ce()})}const Fe={"5.18":{name:"Powder Streif",description:{en:"Battery power saver for longer outdoor timing. Improved PIN security and faster voice notes.",de:"Batterieschoner für längere Zeitmessung im Freien. Verbesserte PIN-Sicherheit und schnellere Sprachnotizen.",fr:"Mode économie de batterie pour un chronométrage prolongé en extérieur. Sécurité PIN améliorée et notes vocales plus rapides."}},"5.19":{name:"Firn Lauberhorn",description:{en:"Under-the-hood reliability upgrade. Stronger server-side input validation and improved code quality.",de:"Verbesserungen unter der Haube. Stärkere serverseitige Eingabevalidierung und verbesserte Codequalität.",fr:"Amélioration de la fiabilité en interne. Validation des entrées côté serveur renforcée et qualité de code améliorée."}},"5.20":{name:"Corn Saslong",description:{en:"Offline banner, undo for deletions, reorganized settings, and standardized event cleanup across the app.",de:"Offline-Banner, Rückgängig-Funktion für Löschungen, neu organisierte Einstellungen und standardisierte Ereignisbereinigung.",fr:"Bannière hors ligne, annulation des suppressions, paramètres réorganisés et nettoyage standardisé des événements."}},"5.21":{name:"Sleet Kandahar",description:{en:"Responsive layout fixes for all screen sizes. Dial and numbers scale smoothly from iPhone SE to iPad landscape.",de:"Responsive Layout-Korrekturen für alle Bildschirmgrößen. Zifferblatt und Zahlen skalieren fließend vom iPhone SE bis iPad Querformat.",fr:"Corrections de mise en page responsive pour tous les écrans. Le cadran et les chiffres s'adaptent de l'iPhone SE à l'iPad en mode paysage."}},"5.22":{name:"Crust Stelvio",description:{en:"Signals-based reactivity, view code splitting, reduced-motion support, and 3,700+ new tests for rock-solid reliability.",de:"Signalbasierte Reaktivität, View-Code-Splitting, Reduced-Motion-Unterstützung und 3.700+ neue Tests für maximale Zuverlässigkeit.",fr:"Réactivité basée sur les signaux, découpage du code par vue, support du mouvement réduit et plus de 3 700 nouveaux tests pour une fiabilité maximale."}},"5.23":{name:"Graupel Hahnenkamm",description:{en:"Swipe-to-edit/delete in results, click-outside modal dismiss, auto-bib flash cue, and split settings effects for better performance.",de:"Wischen zum Bearbeiten/Löschen in Ergebnissen, Modal-Schließen per Klick außerhalb, Auto-Bib-Blitz-Hinweis und aufgeteilte Einstellungs-Effekte für bessere Leistung.",fr:"Glisser pour modifier/supprimer dans les résultats, fermeture des modales par clic extérieur, signal flash auto-dossard et effets de paramètres séparés pour de meilleures performances."}},"5.24":{name:"Névé Planai",description:{en:"Full French language support. Three-language UI (DE/FR/EN), French ski racing terminology, and complete documentation in French.",de:"Vollständige französische Sprachunterstützung. Dreisprachige Oberfläche (DE/FR/EN), französische Skirennsport-Terminologie und vollständige Dokumentation auf Französisch.",fr:"Support complet de la langue française. Interface trilingue (DE/FR/EN), terminologie du ski de course en français et documentation complète en français."}}};function Ve(e){const t=e.split(".");if(t.length<2)return null;const n=`${t[0]}.${t[1]}`,a=Fe[n];if(!a)return null;const i=l.getState().currentLang;return{name:a.name,description:a.description[i]||a.description.en}}const L=new k;function qe(){const e=u("device-name-input");e&&L.add(e,"change",()=>{l.setDeviceName(e.value.trim())}),ze(),L.add(window,"update-role-toggle",()=>ce()),Je()}function ze(){const e=u("role-toggle");e&&L.add(e,"click",t=>{const a=t.target.closest(".role-card-setting");if(!a)return;const i=a.getAttribute("data-role");i&&i!==l.getState().deviceRole&&(l.setDeviceRole(i),ce(),ke(),z(),i==="gateJudge"&&!l.getState().gateAssignment&&I(u("gate-assignment-modal")),i!=="gateJudge"&&l.getState().currentView==="gateJudge"&&l.setView("timer"))})}function ce(){const e=u("role-toggle");if(!e)return;const t=l.getState();e.querySelectorAll(".role-card-setting").forEach(n=>{const i=n.getAttribute("data-role")===t.deviceRole;n.classList.toggle("active",i),n.setAttribute("aria-checked",String(i))})}function Je(){const e=u("advanced-settings-toggle"),t=u("advanced-settings-section");!e||!t||(e.setAttribute("role","button"),e.setAttribute("aria-expanded",t.classList.contains("expanded")?"true":"false"),L.add(e,"click",()=>{const n=t.classList.toggle("expanded");e.setAttribute("aria-expanded",String(n)),z()}))}function Ue(){const e=l.getState(),t=u("device-name-input");t&&(t.value=e.deviceName)}function He(){L.removeAll()}const x=new k;function _e(e){const t=u("simple-mode-toggle");t&&x.add(t,"change",()=>{l.updateSettings({simple:t.checked}),e();const i=u("admin-section");i&&(i.style.display="block")});const n=u("ambient-mode-toggle");n&&x.add(n,"change",()=>{l.updateSettings({ambientMode:n.checked})}),Oe();const a=u("lang-toggle");if(a){const i=o=>{o&&o!==l.getState().currentLang&&(l.setLanguage(o),window.dispatchEvent(new CustomEvent("settings-language-changed")))};x.add(a,"click",o=>{const s=o.target.getAttribute("data-lang");i(s)}),a.querySelectorAll(".lang-option").forEach(o=>{x.add(o,"keydown",c=>{const s=c;switch(s.key){case"Enter":case" ":{s.preventDefault();const r=o.getAttribute("data-lang");i(r);break}case"ArrowLeft":case"ArrowRight":{s.preventDefault();const r=Array.from(a.querySelectorAll(".lang-option")),g=r.indexOf(o);let f;s.key==="ArrowRight"?f=(g+1)%r.length:f=(g-1+r.length)%r.length;const S=r[f],E=S.getAttribute("data-lang");S.focus(),i(E);break}}})})}}function Oe(){const e=u("voice-mode-toggle"),t=u("voice-mode-row");if(!(!e||!t)){if(!D.isSupported()){t.style.display="none";return}e.checked=D.isActive(),x.add(e,"change",async()=>{const n=l.getState().currentLang;if(e.checked){if(!navigator.onLine){p(d("voiceOffline",n),"warning"),e.checked=!1;return}D.enable()||(p(d("voiceError",n),"error"),e.checked=!1)}else D.disable()})}}function We(){const e=l.getState(),{settings:t}=e,n=u("simple-mode-toggle");n&&(n.checked=t.simple);const a=u("admin-section");a&&(a.style.display="block");const i=u("ambient-mode-toggle");i&&(i.checked=t.ambientMode),re()}function re(){const e=l.getState().currentLang,t=u("lang-toggle");t&&t.querySelectorAll(".lang-option").forEach(n=>{const a=n.getAttribute("data-lang")===e;n.classList.toggle("active",a),n.setAttribute("aria-checked",String(a))})}function Ke(){x.removeAll()}function je(e){const t=l.getState().currentLang,n=e.entryCount!==void 0?`${e.entryCount} ${d("entries",t)}`:"",a=he(e.raceId);return`
    <div class="recent-race-item" data-race-id="${Q(e.raceId)}" tabindex="0" role="option" aria-label="${Q(d("race",t))} ${a}${n?`, ${n}`:""}">
      <span class="recent-race-id">${a}</span>
      <span class="recent-race-meta">${n}</span>
    </div>
  `}function Ze(e){return e.map(je).join("")}function Ge(e,t,n){const a=e.querySelectorAll(".recent-race-item");a.forEach((i,o)=>{i.addEventListener("click",()=>{const c=t[o];c&&n(c)}),i.addEventListener("keydown",c=>{const s=c,r=Array.from(a);switch(s.key){case"Enter":case" ":{s.preventDefault();const g=t[o];g&&n(g);break}case"ArrowDown":s.preventDefault(),o<r.length-1&&r[o+1].focus();break;case"ArrowUp":s.preventDefault(),o>0&&r[o-1].focus();break;case"Escape":s.preventDefault(),e.style.display="none";break}})})}const w=new k;let C=null,O=0,le={exists:null,entryCount:0},N=null,F=null;async function Qe(){return new Promise(e=>{N=e,window.dispatchEvent(new CustomEvent("request-photo-sync-warning"))})}async function ae(e,t){return new Promise(n=>{F=n,window.dispatchEvent(new CustomEvent("request-race-change-dialog",{detail:{type:e,lang:t}}))})}function Et(){N&&(N(),N=null)}function vt(e){F&&(F(e),F=null)}function Ye(){const e=u("sync-toggle");let t=!1;e&&w.add(e,"change",async()=>{if(t){e.checked=!e.checked;return}t=!0;try{const s=l.getState();if(e.checked&&s.raceId&&!await K(s.currentLang)){e.checked=!1;return}l.updateSettings({sync:e.checked});const r=u("sync-photos-toggle");r&&(r.disabled=!e.checked,e.checked||(r.checked=!1,l.updateSettings({syncPhotos:!1}))),e.checked&&s.raceId?b.initialize():b.cleanup()}finally{t=!1}});const n=u("sync-photos-toggle");n&&w.add(n,"change",async s=>{const r=s.target;r.checked?(s.preventDefault(),r.checked=!1,await Qe()):l.updateSettings({syncPhotos:!1})});const a=u("race-id-input");let i=!1;a&&(w.add(a,"input",()=>{C&&clearTimeout(C);const s=a.value.trim();s?C=setTimeout(()=>et(s),500):q(null,0)}),w.add(a,"change",async()=>{if(!i){i=!0;try{const s=a.value.trim(),r=l.getState(),g=r.entries.length>0,f=r.lastSyncedRaceId!=="",S=s!==r.raceId&&s!=="";if(g&&S)if(f){const m=await ae("synced",r.currentLang);if(m==="export")Ee(),l.clearAll(),l.clearFaultEntries(),await J.clearAll();else if(m==="delete")l.clearAll(),l.clearFaultEntries(),await J.clearAll();else{a.value=r.raceId;return}}else{const m=await ae("unsynced",r.currentLang);if(m==="delete")l.clearAll(),l.clearFaultEntries(),await J.clearAll();else if(m==="cancel"){a.value=r.raceId;return}}if(s&&!ve(s)){p(d("invalidRaceId",r.currentLang),"error"),a.value=r.raceId,v();return}if(r.settings.sync&&s&&!await K(r.currentLang)){a.value=r.raceId;return}r.settings.sync&&r.raceId&&b.cleanup();const E=s.toLowerCase();a.value=E,l.setRaceId(E),r.settings.sync&&E&&(b.initialize(),l.markCurrentRaceAsSynced())}finally{i=!1}}}));const o=u("settings-recent-races-btn"),c=u("settings-recent-races-dropdown");o&&c&&(w.add(o,"click",()=>{z(),c.style.display==="none"?(tt(c),o.setAttribute("aria-expanded","true")):(c.style.display="none",o.setAttribute("aria-expanded","false"))}),w.add(document,"click",s=>{const r=s.target;!o.contains(r)&&!c.contains(r)&&(c.style.display="none",o.setAttribute("aria-expanded","false"))}))}function Xe(){const e=l.getState(),{settings:t}=e,n=u("sync-toggle");n&&(n.checked=t.sync);const a=u("sync-photos-toggle");a&&(a.checked=t.syncPhotos,a.disabled=!t.sync);const i=u("race-id-input");i&&(i.value=e.raceId)}async function et(e){const t=++O;try{const n=await b.checkRaceExists(e);if(t!==O)return;l.setRaceExistsInCloud(n.exists),q(n.exists,n.entryCount)}catch(n){if(t!==O)return;A.warn("Race exists check failed:",n),q(null,0)}}async function tt(e){const t=l.getState().currentLang;e.innerHTML=`<div class="recent-races-empty">${d("loading",t)}</div>`,e.style.display="block";let n=[];if(B())try{n=await nt()}catch(a){A.warn("Failed to fetch races from API:",a),n=Y()}else n=Y();n.length===0?e.innerHTML=`<div class="recent-races-empty">${d("noRecentRaces",t)}</div>`:(e.innerHTML=Ze(n),Ge(e,n,a=>{at(a,e)}))}async function nt(){const e=Ie.getRaw(Se);if(!e)return[];const t=await Z("/api/v1/admin/races",{headers:{Authorization:`Bearer ${e}`}},5e3);if(!t.ok)throw new Error(`API error: ${t.status}`);const a=(await t.json()).races||[],i=new Date;i.setHours(0,0,0,0);const o=i.getTime(),c=a.filter(s=>s.lastUpdated&&s.lastUpdated>=o).map(s=>({raceId:s.raceId,createdAt:s.lastUpdated||Date.now(),lastUpdated:s.lastUpdated||Date.now(),entryCount:s.entryCount})).slice(0,5);return c.forEach(s=>{be(s.raceId,s.lastUpdated,s.entryCount)}),c}function at(e,t){const n=u("race-id-input");n&&(n.value=e.raceId,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),z()),t.style.display="none"}function q(e,t){le={exists:e,entryCount:t};const n=u("race-exists-indicator"),a=u("race-exists-text"),i=l.getState().currentLang;if(!(!n||!a)){if(e===null){n.style.display="none";return}if(n.style.display="inline-flex",n.classList.remove("found","new"),e)if(n.classList.add("found"),t>0){const o=t===1?d("entryInCloud",i):d("entriesInCloud",i);a.textContent=`${t} ${o}`}else a.textContent=d("raceFound",i);else n.classList.add("new"),a.textContent=d("raceNew",i)}}function it(){return le}function ot(){C&&(clearTimeout(C),C=null),w.removeAll()}const R=new k;function It(){_e(ct),Ye(),qe(),R.add(window,"settings-language-changed",()=>{st(),re()});const e=u("gps-toggle");e&&R.add(e,"change",()=>{l.updateSettings({gps:e.checked})});const t=u("auto-toggle");t&&R.add(t,"change",()=>{l.updateSettings({auto:t.checked})});const n=u("haptic-toggle");n&&R.add(n,"change",()=>{l.updateSettings({haptic:n.checked})});const a=u("sound-toggle");a&&R.add(a,"change",()=>{l.updateSettings({sound:a.checked})});const i=u("photo-toggle");i&&R.add(i,"change",()=>{l.updateSettings({photoCapture:i.checked})})}function St(){const e=l.getState(),{settings:t}=e;We(),Xe(),Ue();const n=u("gps-toggle"),a=u("auto-toggle"),i=u("haptic-toggle"),o=u("sound-toggle"),c=u("photo-toggle");n&&(n.checked=t.gps),a&&(a.checked=t.auto),i&&(i.checked=t.haptic),o&&(o.checked=t.sound),c&&(c.checked=t.photoCapture)}function st(){const e=l.getState().currentLang;document.documentElement.lang=e,document.querySelectorAll("[data-i18n]").forEach(a=>{const i=a.getAttribute("data-i18n");i&&(a.textContent=d(i,e))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(a=>{const i=a.getAttribute("data-i18n-placeholder");i&&(a.placeholder=d(i,e))}),document.querySelectorAll("[data-i18n-aria-label]").forEach(a=>{const i=a.getAttribute("data-i18n-aria-label");i&&a.setAttribute("aria-label",d(i,e))});const t=it();q(t.exists,t.entryCount);const n=document.getElementById("app-version-description");if(n){const a=Ve("5.24.2");n.textContent=(a==null?void 0:a.description)??""}}function ct(){document.querySelectorAll("[data-advanced]").forEach(n=>{n.style.display=""});const t=document.querySelector('[data-point="S"]');t&&(t.style.display=""),rt()}function rt(){const e=l.getState().settings,t=document.documentElement;e.glassEffects?(t.classList.remove("no-glass-effects"),document.querySelectorAll(".glass-enable-target").forEach(n=>{n.classList.add("glass-enabled")})):(t.classList.add("no-glass-effects"),document.querySelectorAll(".glass-enabled").forEach(n=>{n.classList.remove("glass-enabled")})),t.classList.add("no-motion-effects"),e.outdoorMode?t.classList.add("outdoor-mode"):t.classList.remove("outdoor-mode")}function bt(){ot(),Ke(),He(),R.removeAll()}export{st as a,mt as b,gt as c,pt as d,bt as e,ft as f,vt as g,U as h,ce as i,ct as j,rt as k,Ze as l,Ge as m,Ve as n,It as o,ht as p,Et as r,yt as s,St as u,ut as v};
