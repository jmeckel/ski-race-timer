var Vt=Object.defineProperty;var Ht=(n,e,t)=>e in n?Vt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>Ht(n,typeof e!="symbol"?e+"":e,t);import{b as w,c as Gt,m as W}from"./vendor-signals-BA-R9xnX.js";const Xe={en:{timer:"Timer",results:"Results",settings:"Settings",start:"Start",finish:"Finish",startShort:"S",finishShort:"F",bib:"Bib",point:"Point",run:"Run",run1:"R1",run2:"R2",runLabel1:"Run 1",runLabel2:"Run 2",time:"Record time",lastRecorded:"Last recorded",lastRecordedShort:"Last:",advancedSettings:"Advanced Settings",status:"Status",noEntries:"No entries recorded",noEntriesHint:"Record times on the Timer tab",search:"Search by bib...",searchResults:"Search results",filter:"Filter",all:"All",total:"Total",racers:"Racers",finished:"Finished",entriesRecorded:"entries recorded",fastest:"Fastest",average:"Average",timeEntry:"time",timeEntries:"times",faultEntry:"fault",faultEntries:"faults",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Delete Entry",confirmDeleteText:"Are you sure you want to delete this entry?",confirmDeleteFault:"Delete this fault?",confirmClearAll:"Clear All Results",clearAllText:"This will delete all recorded entries. This action cannot be undone.",confirmUndoAdd:"Undo Recording",confirmUndoAddText:"This will delete the recorded entry. Continue?",delete:"Delete",cancel:"Cancel",close:"Close",back:"Back",save:"Save",saving:"Saving...",edit:"Edit",undo:"Undo",export:"Export",clearAll:"Clear All",selectAll:"Select All",deleteSelected:"Delete Selected",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Synced from cloud",raceId:"Race ID",invalidRaceId:"Invalid Race ID. Use letters, numbers, hyphens, underscores only.",deviceName:"Time Keeper ID",cloudSync:"Cloud Sync",syncStatus:"Sync Status",pendingSync:"pending sync",raceSetup:"Race Setup",raceSetupDesc:"Required for multi-device timing and syncing.",firstGateLabel:"First gate",saved:"Saved",deleted:"Deleted",cleared:"All entries cleared",undone:"Undone",copied:"Copied to clipboard",debugInfoCopied:"Debug info copied to clipboard",debugInfoCopyFailed:"Tap and hold to copy debug info",duplicateWarning:"Duplicate entry detected",zeroBibWarning:"Bib 000 - verify entry",exported:"Exported successfully",gps:"GPS",gpsActive:"GPS Active",gpsSearching:"Searching for GPS...",gpsInactive:"GPS Inactive",gpsAccuracy:"Accuracy",settingsRaceSetup:"Race Setup",settingsTimingGroup:"Timing",settingsSyncGroup:"Sync",settingsFeedbackGroup:"Feedback",settingsDisplayGroup:"Display",simpleMode:"Simple Mode",fullMode:"Full Mode",autoIncrement:"Auto-increment Bib",hapticFeedback:"Haptic Feedback",soundFeedback:"Sound Feedback",language:"Language",advancedSettingsHint:"These options can affect timing accuracy. Change only if needed.",simpleModeDesc:"Simplified interface for basic timing",cloudSyncDesc:"Sync with other devices",gpsDesc:"Use GPS for accurate timestamps",autoIncrementDesc:"Increase bib number after recording",photoCaptureDesc:"Capture photo on timestamp",hapticFeedbackDesc:"Vibration on actions",soundFeedbackDesc:"Audio confirmation",ambientMode:"Ambient Mode",ambientModeDesc:"Auto-dim after 30s inactivity",photoCapture:"Photo Capture",photoCaptured:"Photo captured",photoError:"Photo capture failed",photoSaveFailed:"Photo storage failed",viewPhoto:"View Photo",deletePhoto:"Delete Photo",photoFor:"Photo for Bib",noPhotoAvailable:"No photo available",photoDeleted:"Photo deleted",raceChangeTitle:"Change Race",raceChangeSyncedText:"You have results from another race. Export or delete them before switching?",raceChangeUnsyncedText:"You have existing results. Keep them or delete before switching?",keepResults:"Keep",version:"Version",devices:"Devices",entries:"entries",selected:"selected",raceFound:"Race found",raceNew:"New race",entryInCloud:"entry in cloud",entriesInCloud:"entries in cloud",photoTooLarge:"Photo too large for sync",syncedEntriesFromCloud:"Synced {count} entries from cloud",syncedFaultsFromCloud:"Synced {count} faults from cloud",crossDeviceDuplicate:"Duplicate: Bib {bib} {point} already recorded by {device}",syncPhotos:"Sync Photos",syncPhotosDesc:"Share photos across devices via cloud",syncPhotosWarning:"Enable Photo Sync",syncPhotosWarningText:"Enabling photo sync will transfer the following data:",photosToUpload:"Photos to upload",photosToDownload:"Photos to download",totalDataVolume:"Total data volume",enableSync:"Enable Sync",noPhotosToSync:"No photos to sync",admin:"Admin",adminPin:"Race Management PIN",adminPinDesc:"Required to manage and sync races",manageRaces:"Manage Races",manageRacesDesc:"View and delete synced races",manage:"Manage",enterAdminPin:"Enter Race Management PIN",enterPinText:"Enter your PIN to access race management.",enterPinToJoinRace:"Enter your PIN to join this race.",enterPinForChiefJudge:"Enter your PIN to access Chief Judge mode.",enterChiefJudgePin:"Enter Chief Judge PIN",enterPinForChiefJudgeInfo:"Chief Judge mode requires a separate PIN. First use sets the PIN.",syncRequiresPin:"Sync disabled. Enable sync and enter PIN to reconnect.",incorrectPin:"Incorrect PIN",verify:"Verify",setPinFirst:"Please set a Race Management PIN first",pinSaved:"PIN saved",pinCleared:"PIN cleared",pinNotSet:"Not set",pinSet:"PIN set",setPin:"Set PIN",changePin:"Change PIN",currentPin:"Current PIN",newPin:"New PIN (4 digits)",confirmPin:"Confirm PIN",pinMismatch:"PINs do not match",pinFormatError:"PIN must be exactly 4 digits",loading:"Loading...",noRaces:"No active races",noRacesHint:"Create one in Settings",cleanRunHint:"Clean run so far",refresh:"Refresh",raceDeleted:"Race Deleted",raceDeletedText:"This race has been deleted by an administrator.",raceDeletedFor:"Race deleted:",raceDeletedSuccess:"Race deleted:",confirmDeleteRace:"Delete Race",confirmDeleteRaceText:"Are you sure you want to delete race",loadError:"Failed to load races. Check your connection and try again.",deleteError:"Failed to delete race",entry:"entry",device:"device",storageError:"Failed to save data - check storage",storageQuotaError:"Storage full! Export data immediately",storageWarning:"Storage almost full",storageNearlyFull:"Storage nearly full. Export data and clear old entries.",networkError:"Network error - check connection",connectionFailed:"Connection failed",serverUnavailable:"Server unavailable",rateLimitError:"Too many requests - please wait",authError:"Authentication failed. Try re-entering your PIN.",syncFailed:"Sync failed",pinSyncFailed:"PIN not synced to cloud",cameraError:"Camera error",cameraPermissionDenied:"Camera access denied",gpsError:"GPS error",gpsPermissionDenied:"GPS access denied",gpsUnavailable:"GPS unavailable",wakeLockFailed:"Screen may dim during timing",wakeLockIdleTimeout:"Screen will dim to save battery. Tap to keep awake.",unknownError:"Unknown error",onboardingWelcome:"Welcome to CHRONO",onboardingWelcomeDesc:"GPS-synchronized timing for ski races",getStarted:"Get Started",skipSetup:"Skip",onboardingRole:"What's Your Role?",onboardingRoleDesc:"Choose how you'll be helping at the race",roleTimerTitle:"Timer",roleTimerDesc:"You will record start and finish times",roleJudgeTitle:"Gate Judge",roleJudgeDesc:"You will record gate faults (Torrichter)",onboardingDeviceName:"Name Your Timer",onboardingDeviceNameDesc:"This identifies your device when syncing",onboardingDeviceNameJudge:"Your Name",onboardingDeviceNameJudgeDesc:"This identifies you as the gate judge",onboardingPhoto:"Photo Documentation",onboardingPhotoDesc:"Automatically capture a photo when recording each timestamp. Useful for verifying bib numbers and resolving disputes.",enablePhotoCapture:"Enable Photo Capture",photoCaptureLabel:"Photo Capture",onboardingGates:"Your Gate Assignment",onboardingGatesDesc:"Enter the gate numbers you'll be watching. You can change this later.",onboardingRaceSetup:"Join a Race",onboardingRaceSetupDesc:"Enter a race ID to sync with other timers",skipForNow:"Skip for now",onboardingReady:"Ready to Time!",onboardingReadyJudge:"Ready to Judge!",onboardingTip:"Tap the big blue button to record timestamps",onboardingTipJudge:"Tap a racer's bib to record a fault",startTiming:"Start Timing",startJudging:"Start Judging",continue:"Continue",deviceNameLabel:"Device Name",raceIdLabel:"Race ID",syncStatusLabel:"Cloud Sync",enabled:"Enabled",disabled:"Disabled",showTutorial:"Show Tutorial",showTutorialDesc:"Run the setup wizard again",show:"Show",onboardingComplete:"Setup complete!",invalidPin:"PIN must be 4 digits",recentRaces:"Recent Races",noRecentRaces:"No races from today",errorOccurred:"Something went wrong",errorRecoveryMessage:"The app encountered an error. You can dismiss this and continue, or reload the app.",dismiss:"Dismiss",reload:"Reload",updateAvailable:"Update available! Reload to get the latest version.",operationFailed:"Operation failed. Please try again.",raceIdPlaceholder:"RACE-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Photo for bib",gateJudge:"Gate Judge",gateJudgeTab:"Gate",deviceRole:"Device Role",deviceRoleDesc:"Timer records times, Gate Judge records faults",roleTimer:"Timer",roleGateJudge:"Gate Judge",gateAssignment:"Gate Assignment",noGateAssignment:"No gate assignment. Please set your gate range first.",gates:"Gates",gatesFrom:"From",gatesTo:"To",firstGateColor:"Color of first gate",colorRed:"Red",colorBlue:"Blue",changeGates:"Change",otherJudges:"Other judges:",activeBibs:"On Course",noBibsOnCourse:"No racers on course",recordFault:"Record Fault",faultType:"Fault Type",faultMG:"Missed Gate",faultSTR:"Straddling",faultBR:"Binding Release",faultMGShort:"MG",faultSTRShort:"STR",faultBRShort:"BR",orEnterManually:"or enter:",faultRecorded:"Fault recorded",signalReady:"Ready",judgeReady:"Ready for race!",judgeNotReady:"Ready status cleared",faultDeleted:"Fault deleted",recordedFaults:"Recorded Faults",selectBib:"Select Bib",selectGate:"Gate",gate:"Gate",noFaults:"No faults recorded",faultsFor:"Faults for",faultSummary:"Fault Summary",penaltyTime:"Penalty",faultCount:"faults",markOk:"Mark OK",saveFault:"Save Fault",selectFaultType:"Please select a fault type",gateOutOfRange:"Gate is outside assigned range",flt:"FLT",statusFlt:"Fault Penalty",chiefJudge:"Chief Judge",noFaultsRecorded:"No faults recorded",finalize:"Finalize",finalized:"Finalized",chiefJudgeMode:"Chief Judge Mode",chiefJudgeModeEnabled:"Chief Judge mode enabled",chiefJudgeModeDisabled:"Chief Judge mode disabled",racersWithFaults:"Racers with faults",penaltyMode:"+Time",gateJudges:"Gate Judges",noJudgesConnected:"No gate judges connected",summary:"Summary",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"No faults to export",copiedToClipboard:"Copied to clipboard",gateJudgeCard:"Gate Judge Card",race:"Race",date:"Date",gateJudgeLabel:"Gate Judge",runLabel:"Run",noFaultsEntered:"No faults entered",signature:"Signature",legend:"Legend",missedGateLegend:"Missed",straddlingLegend:"Straddling",bindingLegend:"Binding",gateFaults:"Gate Faults",penaltyLabel:"PENALTY",faultSummaryTitle:"GATE FAULT SUMMARY",faults:"Faults",penalty:"Penalty",sec:"sec",generated:"Generated",editFault:"Edit Fault",versionHistory:"Version History",restoreVersion:"Restore Selected Version",currentVersion:"Current",originalVersion:"Original",restored:"Restored",versionRestored:"Version restored",markForDeletion:"Mark for Deletion",markForDeletionText:"This fault will be marked for deletion and requires Chief Judge approval to permanently delete.",markedForDeletion:"Marked for deletion",deletionPending:"Deletion pending",pendingDeletions:"Pending Deletions",approveDeletion:"Approve Deletion",rejectDeletion:"Reject Deletion",deletionMarkedBy:"Marked by",deletionApproved:"Deletion approved",deletionRejected:"Deletion rejected",cannotEditPendingDeletion:"Cannot edit fault pending deletion",voiceMode:"Voice Mode",voiceModeDesc:"Hands-free voice commands (requires internet)",voiceListening:"Listening...",voiceProcessing:"Processing...",voiceConfirming:"Confirm?",voiceOffline:"Voice unavailable offline",voiceNotSupported:"Voice not supported in this browser",voicePermissionDenied:"Microphone access denied",voiceOK:"OK",voiceRecorded:"Recorded",voiceNotUnderstood:"Not understood",voiceCancelled:"Cancelled",voiceError:"Voice error",voiceApiKeyRequired:"API key required for voice mode",pullToRefresh:"Pull to refresh",releaseToRefresh:"Release to refresh",synced:"Synced",syncingStatus:"Syncing...",gateAssignmentInstructions:"Enter the gate range you are responsible for:",readySuffix:" - Ready",viewPhotoLabel:"View photo",editEntryLabel:"Edit entry",deleteEntryLabel:"Delete entry",editFaultLabel:"Edit fault",deleteFaultLabel:"Delete fault",deleteLabel:"Delete",gateNumberLabel:"Gate",numberLabel:"Number",currentTime:"Current time",pinVerifyOnline:"PIN will be verified when online",addNote:"Add Note",done:"Done",recordNote:"Record Note",listening:"Listening...",noteSaved:"Note saved",noteDeleted:"Note deleted",noteCharCount:"characters",voiceNoteUnsupported:"Voice input not supported in this browser",voiceNoteError:"Voice input error",typeNote:"Type or speak your note...",hasNote:"Has note",noteTextLabel:"Note text",recordVoiceNoteLabel:"Record voice note",syncOnline:"Sync online",syncOffline:"Offline",syncShortConnected:"Sync",syncShortSyncing:"Sync...",syncShortError:"Error",syncShortOff:"Off",syncDeviceAbbrev:"dev",sessionExpired:"Session expired. Please re-enter your PIN.",authSuccess:"Authentication successful",keyboardShortcuts:"Keyboard Shortcuts",keyboardShortcutsDesc:"Show all keyboard shortcuts",shortcutSection_timer:"Timer",shortcutSection_gateJudge:"Gate Judge",shortcutSection_results:"Results",shortcutSection_global:"Global",shortcut_enterDigit:"Enter bib digit",shortcut_selectStart:"Select Start",shortcut_selectFinish:"Select Finish",shortcut_selectRun1:"Select Run 1",shortcut_selectRun2:"Select Run 2",shortcut_recordTime:"Record timestamp",shortcut_clearBib:"Clear bib",shortcut_deleteLastDigit:"Delete last digit",shortcut_missedGate:"Missed Gate",shortcut_straddled:"Straddled",shortcut_broken:"Broken gate",shortcut_selectGate:"Select gate",shortcut_navigateBtns:"Navigate buttons",shortcut_confirmSelection:"Confirm selection",shortcut_navigateItems:"Navigate items",shortcut_editItem:"Edit item",shortcut_deleteItem:"Delete item",shortcut_moveTab:"Move between tabs",shortcut_closeModal:"Close modal",shortcut_navigateInComponent:"Navigate in component",shortcut_showShortcuts:"Show shortcuts",offlineBanner:"You are offline. Times will be saved locally.",onlineRestored:"Back online",entryDeleted:"Entry deleted",undoAction:"Undo",multiDeviceDuplicate:"Multi-device",duplicateDevices:"{count} devices",duplicateCount:"{count} duplicates"},de:{timer:"Timer",results:"Ergebnisse",settings:"Einstellungen",start:"Start",finish:"Ziel",startShort:"S",finishShort:"Z",bib:"Startnr.",point:"Punkt",run:"Lauf",run1:"L1",run2:"L2",runLabel1:"Lauf 1",runLabel2:"Lauf 2",time:"Zeit erfassen",lastRecorded:"Zuletzt erfasst",lastRecordedShort:"Letzter:",advancedSettings:"Erweiterte Einstellungen",status:"Status",noEntries:"Keine Einträge vorhanden",noEntriesHint:"Zeiten im Timer-Tab aufnehmen",search:"Startnr. suchen...",searchResults:"Ergebnisse durchsuchen",filter:"Filter",all:"Alle",total:"Gesamt",racers:"Fahrer",finished:"Im Ziel",entriesRecorded:"Einträge erfasst",fastest:"Schnellste",average:"Durchschnitt",timeEntry:"Zeit",timeEntries:"Zeiten",faultEntry:"Fehler",faultEntries:"Fehler",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Eintrag löschen",confirmDeleteText:"Möchten Sie diesen Eintrag wirklich löschen?",confirmDeleteFault:"Diesen Fehler löschen?",confirmClearAll:"Alle löschen",clearAllText:"Alle Einträge werden gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.",confirmUndoAdd:"Erfassung rückgängig",confirmUndoAddText:"Der erfasste Eintrag wird gelöscht. Fortfahren?",delete:"Löschen",cancel:"Abbrechen",close:"Schließen",back:"Zurück",save:"Speichern",saving:"Speichern...",edit:"Bearbeiten",undo:"Rückgängig",export:"Exportieren",clearAll:"Alle löschen",selectAll:"Alle auswählen",deleteSelected:"Ausgewählte löschen",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Von Cloud synchronisiert",raceId:"Rennen-ID",invalidRaceId:"Ungültige Rennen-ID. Nur Buchstaben, Zahlen, Bindestriche, Unterstriche.",deviceName:"Zeitnehmer-ID",cloudSync:"Cloud-Sync",syncStatus:"Sync-Status",pendingSync:"ausstehend",raceSetup:"Rennen einrichten",raceSetupDesc:"Erforderlich für Timing und Sync über mehrere Geräte.",firstGateLabel:"Erstes Tor",saved:"Gespeichert",deleted:"Gelöscht",cleared:"Alle Einträge gelöscht",undone:"Rückgängig gemacht",copied:"In Zwischenablage kopiert",debugInfoCopied:"Debug-Info in Zwischenablage kopiert",debugInfoCopyFailed:"Lange drücken um Debug-Info zu kopieren",duplicateWarning:"Doppelter Eintrag erkannt",zeroBibWarning:"Startnr. 000 - Eintrag prüfen",exported:"Erfolgreich exportiert",gps:"GPS",gpsActive:"GPS Aktiv",gpsSearching:"GPS wird gesucht...",gpsInactive:"GPS Inaktiv",gpsAccuracy:"Genauigkeit",settingsRaceSetup:"Rennen einrichten",settingsTimingGroup:"Zeitmessung",settingsSyncGroup:"Synchronisation",settingsFeedbackGroup:"Rückmeldung",settingsDisplayGroup:"Anzeige",simpleMode:"Einfacher Modus",fullMode:"Erweiterter Modus",autoIncrement:"Startnr. automatisch",hapticFeedback:"Vibration",soundFeedback:"Signalton",language:"Sprache",advancedSettingsHint:"Diese Optionen beeinflussen die Zeitmessung. Nur bei Bedarf ändern.",simpleModeDesc:"Vereinfachte Oberfläche für einfache Zeitmessung",cloudSyncDesc:"Mit anderen Geräten synchronisieren",gpsDesc:"GPS für genaue Zeitstempel verwenden",autoIncrementDesc:"Startnr. nach Erfassung erhöhen",photoCaptureDesc:"Foto bei Zeiterfassung aufnehmen",hapticFeedbackDesc:"Vibration bei Aktionen",soundFeedbackDesc:"Akustische Bestätigung",ambientMode:"Ruhemodus",ambientModeDesc:"Nach 30s Inaktivität abdunkeln",photoCapture:"Foto aufnehmen",photoCaptured:"Foto aufgenommen",photoError:"Foto-Aufnahme fehlgeschlagen",photoSaveFailed:"Foto-Speicherung fehlgeschlagen",viewPhoto:"Foto anzeigen",deletePhoto:"Foto löschen",photoFor:"Foto für Startnr.",noPhotoAvailable:"Kein Foto verfügbar",photoDeleted:"Foto gelöscht",raceChangeTitle:"Rennen wechseln",raceChangeSyncedText:"Es gibt Ergebnisse von einem anderen Rennen. Exportieren oder löschen?",raceChangeUnsyncedText:"Es gibt bestehende Ergebnisse. Behalten oder löschen?",keepResults:"Behalten",version:"Version",devices:"Geräte",entries:"Einträge",selected:"ausgewählt",raceFound:"Rennen gefunden",raceNew:"Neues Rennen",entryInCloud:"Eintrag in der Cloud",entriesInCloud:"Einträge in der Cloud",photoTooLarge:"Foto zu groß für Sync",syncedEntriesFromCloud:"{count} Einträge aus Cloud synchronisiert",syncedFaultsFromCloud:"{count} Torfehler aus Cloud synchronisiert",crossDeviceDuplicate:"Duplikat: Startnr. {bib} {point} bereits von {device} erfasst",syncPhotos:"Fotos synchronisieren",syncPhotosDesc:"Fotos über Cloud mit anderen Geräten teilen",syncPhotosWarning:"Foto-Sync aktivieren",syncPhotosWarningText:"Aktivierung der Foto-Synchronisierung überträgt folgende Daten:",photosToUpload:"Fotos hochzuladen",photosToDownload:"Fotos herunterzuladen",totalDataVolume:"Gesamtes Datenvolumen",enableSync:"Sync aktivieren",noPhotosToSync:"Keine Fotos zu synchronisieren",admin:"Admin",adminPin:"Rennverwaltungs-PIN",adminPinDesc:"Erforderlich für Verwaltung und Sync",manageRaces:"Rennen verwalten",manageRacesDesc:"Synchronisierte Rennen anzeigen und löschen",manage:"Verwalten",enterAdminPin:"Rennverwaltungs-PIN eingeben",enterPinText:"Geben Sie Ihre PIN ein, um die Rennverwaltung zu öffnen.",enterPinToJoinRace:"Geben Sie Ihre PIN ein, um diesem Rennen beizutreten.",enterPinForChiefJudge:"Geben Sie Ihre PIN ein, um die Obmann-Ansicht zu öffnen.",enterChiefJudgePin:"Obmann-PIN eingeben",enterPinForChiefJudgeInfo:"Der Obmann-Modus erfordert eine separate PIN. Erste Eingabe setzt die PIN.",syncRequiresPin:"Sync deaktiviert. Aktivieren Sie Sync und geben Sie die PIN ein.",incorrectPin:"Falsche PIN",verify:"Bestätigen",setPinFirst:"Bitte zuerst Rennverwaltungs-PIN festlegen",pinSaved:"PIN gespeichert",pinCleared:"PIN gelöscht",pinNotSet:"Nicht gesetzt",pinSet:"PIN gesetzt",setPin:"PIN setzen",changePin:"PIN ändern",currentPin:"Aktuelle PIN",newPin:"Neue PIN (4 Ziffern)",confirmPin:"PIN bestätigen",pinMismatch:"PINs stimmen nicht überein",pinFormatError:"PIN muss genau 4 Ziffern haben",loading:"Laden...",noRaces:"Keine aktiven Rennen",noRacesHint:"In Einstellungen erstellen",cleanRunHint:"Bisher fehlerfreie Fahrt",refresh:"Aktualisieren",raceDeleted:"Rennen gelöscht",raceDeletedText:"Dieses Rennen wurde von einem Administrator gelöscht.",raceDeletedFor:"Rennen gelöscht:",raceDeletedSuccess:"Rennen gelöscht:",confirmDeleteRace:"Rennen löschen",confirmDeleteRaceText:"Möchten Sie das Rennen wirklich löschen",loadError:"Fehler beim Laden der Rennen. Verbindung prüfen und erneut versuchen.",deleteError:"Fehler beim Löschen des Rennens",entry:"Eintrag",device:"Gerät",storageError:"Speichern fehlgeschlagen - Speicher prüfen",storageQuotaError:"Speicher voll! Daten sofort exportieren",storageWarning:"Speicher fast voll",storageNearlyFull:"Speicher fast voll. Daten exportieren und alte Einträge löschen.",networkError:"Netzwerkfehler - Verbindung prüfen",connectionFailed:"Verbindung fehlgeschlagen",serverUnavailable:"Server nicht erreichbar",rateLimitError:"Zu viele Anfragen - bitte warten",authError:"Authentifizierung fehlgeschlagen. PIN erneut eingeben.",syncFailed:"Synchronisierung fehlgeschlagen",pinSyncFailed:"PIN nicht in Cloud gespeichert",cameraError:"Kamerafehler",cameraPermissionDenied:"Kamerazugriff verweigert",gpsError:"GPS-Fehler",gpsPermissionDenied:"GPS-Zugriff verweigert",gpsUnavailable:"GPS nicht verfügbar",wakeLockFailed:"Bildschirm kann während Zeitmessung abdunkeln",wakeLockIdleTimeout:"Bildschirm wird gedimmt um Akku zu sparen. Tippen zum Wachhalten.",unknownError:"Unbekannter Fehler",onboardingWelcome:"Willkommen bei CHRONO",onboardingWelcomeDesc:"GPS-synchronisierte Zeitmessung für Skirennen",getStarted:"Los geht's",skipSetup:"Überspringen",onboardingRole:"Was ist deine Aufgabe?",onboardingRoleDesc:"Wähle aus, wie du beim Rennen hilfst",roleTimerTitle:"Zeitnehmer",roleTimerDesc:"Du erfasst Start- und Zielzeiten",roleJudgeTitle:"Torrichter",roleJudgeDesc:"Du erfasst Torfehler",onboardingDeviceName:"Timer benennen",onboardingDeviceNameDesc:"Dieser Name identifiziert dein Gerät beim Synchronisieren",onboardingDeviceNameJudge:"Dein Name",onboardingDeviceNameJudgeDesc:"Dies identifiziert dich als Torrichter",onboardingPhoto:"Foto-Dokumentation",onboardingPhotoDesc:"Automatisch ein Foto bei jeder Zeiterfassung aufnehmen. Nützlich zur Überprüfung von Startnr. und bei Unstimmigkeiten.",enablePhotoCapture:"Foto-Aufnahme aktivieren",photoCaptureLabel:"Foto-Aufnahme",onboardingGates:"Deine Tor-Zuweisung",onboardingGatesDesc:"Gib die Tornummern ein, die du beobachtest. Du kannst dies später ändern.",onboardingRaceSetup:"Rennen beitreten",onboardingRaceSetupDesc:"Gib eine Rennen-ID ein um mit anderen Timern zu synchronisieren",skipForNow:"Vorerst überspringen",onboardingReady:"Bereit zur Zeitmessung!",onboardingReadyJudge:"Bereit als Torrichter!",onboardingTip:"Tippe auf den großen blauen Button um Zeiten zu erfassen",onboardingTipJudge:"Tippe auf eine Startnr. um einen Fehler zu erfassen",startTiming:"Zeitmessung starten",startJudging:"Starten",continue:"Weiter",deviceNameLabel:"Gerätename",raceIdLabel:"Rennen-ID",syncStatusLabel:"Cloud-Sync",enabled:"Aktiviert",disabled:"Deaktiviert",showTutorial:"Tutorial anzeigen",showTutorialDesc:"Setup-Assistenten erneut starten",show:"Anzeigen",onboardingComplete:"Einrichtung abgeschlossen!",invalidPin:"PIN muss 4 Ziffern haben",recentRaces:"Letzte Rennen",noRecentRaces:"Keine Rennen von heute",errorOccurred:"Ein Fehler ist aufgetreten",errorRecoveryMessage:"Die App hat einen Fehler festgestellt. Sie können diesen Hinweis schließen und fortfahren, oder die App neu laden.",dismiss:"Schließen",reload:"Neu laden",updateAvailable:"Update verfügbar! Neu laden für die neueste Version.",operationFailed:"Vorgang fehlgeschlagen. Bitte erneut versuchen.",raceIdPlaceholder:"RENNEN-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Foto für Startnr.",gateJudge:"Torrichter",gateJudgeTab:"Tor",deviceRole:"Geräte-Rolle",deviceRoleDesc:"Timer erfasst Zeiten, Torrichter erfasst Fehler",roleTimer:"Zeitnehmer",roleGateJudge:"Torrichter",gateAssignment:"Tor-Zuweisung",noGateAssignment:"Keine Tor-Zuweisung. Bitte zuerst den Torbereich festlegen.",gates:"Tore",gatesFrom:"Von",gatesTo:"Bis",firstGateColor:"Farbe des ersten Tors",colorRed:"Rot",colorBlue:"Blau",changeGates:"Ändern",otherJudges:"Andere Torrichter:",activeBibs:"Auf der Strecke",noBibsOnCourse:"Keine Fahrer auf der Strecke",recordFault:"Fehler erfassen",faultType:"Fehlerart",faultMG:"Tor ausgelassen",faultSTR:"Einfädler",faultBR:"Bindung offen",faultMGShort:"TF",faultSTRShort:"EF",faultBRShort:"BO",orEnterManually:"oder eingeben:",faultRecorded:"Fehler erfasst",signalReady:"Bereit",judgeReady:"Bereit für Rennen!",judgeNotReady:"Bereit-Status zurückgesetzt",faultDeleted:"Fehler gelöscht",recordedFaults:"Erfasste Fehler",selectBib:"Startnr. wählen",selectGate:"Tor",gate:"Tor",noFaults:"Keine Fehler erfasst",faultsFor:"Fehler für",faultSummary:"Fehler-Übersicht",penaltyTime:"Strafzeit",faultCount:"Fehler",markOk:"OK markieren",saveFault:"Fehler speichern",selectFaultType:"Bitte Fehlerart wählen",gateOutOfRange:"Tor liegt außerhalb des zugewiesenen Bereichs",flt:"SZT",statusFlt:"Strafzeit",chiefJudge:"Obmann",noFaultsRecorded:"Keine Fehler erfasst",finalize:"Bestätigen",finalized:"Bestätigt",chiefJudgeMode:"Obmann-Ansicht",chiefJudgeModeEnabled:"Obmann-Ansicht aktiviert",chiefJudgeModeDisabled:"Obmann-Ansicht deaktiviert",racersWithFaults:"Fahrer mit Fehlern",penaltyMode:"+Zeit",gateJudges:"Torrichter",noJudgesConnected:"Keine Torrichter verbunden",summary:"Übersicht",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"Keine Fehler zum Exportieren",copiedToClipboard:"In Zwischenablage kopiert",gateJudgeCard:"Torrichterkarte",race:"Rennen",date:"Datum",gateJudgeLabel:"Torrichter",runLabel:"Lauf",noFaultsEntered:"Keine Fehler erfasst",signature:"Unterschrift",legend:"Legende",missedGateLegend:"Ausgelassen",straddlingLegend:"Einfädler",bindingLegend:"Bindung",gateFaults:"Torfehler",penaltyLabel:"STRAFZEIT",faultSummaryTitle:"ZUSAMMENFASSUNG TORFEHLER",faults:"Fehler",penalty:"Strafzeit",sec:"Sek",generated:"Erstellt",editFault:"Fehler bearbeiten",versionHistory:"Versionshistorie",restoreVersion:"Version wiederherstellen",currentVersion:"Aktuell",originalVersion:"Original",restored:"Wiederhergestellt",versionRestored:"Version wiederhergestellt",markForDeletion:"Zum Löschen markieren",markForDeletionText:"Dieser Fehler wird zum Löschen markiert und benötigt die Genehmigung des Obmanns für die endgültige Löschung.",markedForDeletion:"Zum Löschen markiert",deletionPending:"Löschung ausstehend",pendingDeletions:"Ausstehende Löschungen",approveDeletion:"Löschung genehmigen",rejectDeletion:"Löschung ablehnen",deletionMarkedBy:"Markiert von",deletionApproved:"Löschung genehmigt",deletionRejected:"Löschung abgelehnt",cannotEditPendingDeletion:"Fehler mit ausstehender Löschung kann nicht bearbeitet werden",voiceMode:"Sprachsteuerung",voiceModeDesc:"Freihändige Sprachbefehle (Internet erforderlich)",voiceListening:"Höre zu...",voiceProcessing:"Verarbeite...",voiceConfirming:"Bestätigen?",voiceOffline:"Sprache offline nicht verfügbar",voiceNotSupported:"Spracheingabe in diesem Browser nicht unterstützt",voicePermissionDenied:"Mikrofonzugriff verweigert",voiceOK:"OK",voiceRecorded:"Erfasst",voiceNotUnderstood:"Nicht verstanden",voiceCancelled:"Abgebrochen",voiceError:"Sprachfehler",voiceApiKeyRequired:"API-Schlüssel für Sprachsteuerung erforderlich",pullToRefresh:"Zum Aktualisieren ziehen",releaseToRefresh:"Loslassen zum Aktualisieren",synced:"Synchronisiert",syncingStatus:"Synchronisiere...",gateAssignmentInstructions:"Gib den Torbereich ein, für den du verantwortlich bist:",readySuffix:" - Bereit",viewPhotoLabel:"Foto anzeigen",editEntryLabel:"Eintrag bearbeiten",deleteEntryLabel:"Eintrag löschen",editFaultLabel:"Fehler bearbeiten",deleteFaultLabel:"Fehler löschen",deleteLabel:"Löschen",gateNumberLabel:"Tor",numberLabel:"Zahl",currentTime:"Aktuelle Uhrzeit",pinVerifyOnline:"PIN wird online überprüft",addNote:"Notiz hinzufügen",done:"Fertig",recordNote:"Notiz aufnehmen",listening:"Höre zu...",noteSaved:"Notiz gespeichert",noteDeleted:"Notiz gelöscht",noteCharCount:"Zeichen",voiceNoteUnsupported:"Spracheingabe in diesem Browser nicht unterstützt",voiceNoteError:"Spracheingabe-Fehler",typeNote:"Notiz eintippen oder sprechen...",hasNote:"Hat Notiz",noteTextLabel:"Notiztext",recordVoiceNoteLabel:"Sprachnotiz aufnehmen",syncOnline:"Sync online",syncOffline:"Offline",syncShortConnected:"Sync",syncShortSyncing:"Sync...",syncShortError:"Fehler",syncShortOff:"Aus",syncDeviceAbbrev:"G",sessionExpired:"Sitzung abgelaufen. Bitte PIN erneut eingeben.",authSuccess:"Authentifizierung erfolgreich",keyboardShortcuts:"Tastenkürzel",keyboardShortcutsDesc:"Alle Tastenkürzel anzeigen",shortcutSection_timer:"Timer",shortcutSection_gateJudge:"Torrichter",shortcutSection_results:"Ergebnisse",shortcutSection_global:"Allgemein",shortcut_enterDigit:"Startnr.-Ziffer eingeben",shortcut_selectStart:"Start wählen",shortcut_selectFinish:"Ziel wählen",shortcut_selectRun1:"Lauf 1 wählen",shortcut_selectRun2:"Lauf 2 wählen",shortcut_recordTime:"Zeitstempel erfassen",shortcut_clearBib:"Startnr. löschen",shortcut_deleteLastDigit:"Letzte Ziffer löschen",shortcut_missedGate:"Tor ausgelassen",shortcut_straddled:"Einfädler",shortcut_broken:"Bindung offen",shortcut_selectGate:"Tor wählen",shortcut_navigateBtns:"Buttons navigieren",shortcut_confirmSelection:"Auswahl bestätigen",shortcut_navigateItems:"Einträge navigieren",shortcut_editItem:"Eintrag bearbeiten",shortcut_deleteItem:"Eintrag löschen",shortcut_moveTab:"Zwischen Tabs wechseln",shortcut_closeModal:"Dialog schließen",shortcut_navigateInComponent:"In Komponente navigieren",shortcut_showShortcuts:"Tastenkürzel anzeigen",offlineBanner:"Offline. Zeiten werden lokal gespeichert.",onlineRestored:"Wieder online",entryDeleted:"Eintrag gelöscht",undoAction:"Rückgängig",multiDeviceDuplicate:"Mehrere Geräte",duplicateDevices:"{count} Geräte",duplicateCount:"{count} Duplikate"},fr:{timer:"Chrono",results:"Résultats",settings:"Paramètres",start:"Départ",finish:"Arrivée",startShort:"D",finishShort:"A",bib:"Dossard",point:"Point",run:"Manche",run1:"M1",run2:"M2",runLabel1:"Manche 1",runLabel2:"Manche 2",time:"Enregistrer le temps",lastRecorded:"Dernier enregistré",lastRecordedShort:"Dernier :",advancedSettings:"Paramètres avancés",status:"Statut",noEntries:"Aucune entrée enregistrée",noEntriesHint:"Enregistrez des temps dans l'onglet Chrono",search:"Rechercher par dossard...",searchResults:"Résultats de recherche",filter:"Filtrer",all:"Tous",total:"Total",racers:"Coureurs",finished:"À l'arrivée",entriesRecorded:"entrées enregistrées",fastest:"Plus rapide",average:"Moyenne",timeEntry:"temps",timeEntries:"temps",faultEntry:"faute",faultEntries:"fautes",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Supprimer l'entrée",confirmDeleteText:"Voulez-vous vraiment supprimer cette entrée ?",confirmDeleteFault:"Supprimer cette faute ?",confirmClearAll:"Tout effacer",clearAllText:"Toutes les entrées seront supprimées. Cette action est irréversible.",confirmUndoAdd:"Annuler l'enregistrement",confirmUndoAddText:"L'entrée enregistrée sera supprimée. Continuer ?",delete:"Supprimer",cancel:"Annuler",close:"Fermer",back:"Retour",save:"Enregistrer",saving:"Enregistrement...",edit:"Modifier",undo:"Annuler",export:"Exporter",clearAll:"Tout effacer",selectAll:"Tout sélectionner",deleteSelected:"Supprimer la sélection",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Synchronisé depuis le cloud",raceId:"ID de course",invalidRaceId:"ID de course invalide. Utilisez uniquement lettres, chiffres, tirets et underscores.",deviceName:"ID du chronométreur",cloudSync:"Sync cloud",syncStatus:"État de la sync",pendingSync:"sync en attente",raceSetup:"Configuration de course",raceSetupDesc:"Requis pour le chronométrage multi-appareils et la synchronisation.",firstGateLabel:"Première porte",saved:"Enregistré",deleted:"Supprimé",cleared:"Toutes les entrées effacées",undone:"Annulé",copied:"Copié dans le presse-papiers",debugInfoCopied:"Infos de débogage copiées dans le presse-papiers",debugInfoCopyFailed:"Appuyez longuement pour copier les infos de débogage",duplicateWarning:"Doublon détecté",zeroBibWarning:"Dossard 000 - vérifiez l'entrée",exported:"Exporté avec succès",gps:"GPS",gpsActive:"GPS actif",gpsSearching:"Recherche GPS...",gpsInactive:"GPS inactif",gpsAccuracy:"Précision",settingsRaceSetup:"Configuration de course",settingsTimingGroup:"Chronométrage",settingsSyncGroup:"Synchronisation",settingsFeedbackGroup:"Retour",settingsDisplayGroup:"Affichage",simpleMode:"Mode simplifié",fullMode:"Mode complet",autoIncrement:"Dossard auto-incrémenté",hapticFeedback:"Retour haptique",soundFeedback:"Retour sonore",language:"Langue",advancedSettingsHint:"Ces options peuvent affecter la précision du chronométrage. Modifier uniquement si nécessaire.",simpleModeDesc:"Interface simplifiée pour un chronométrage basique",cloudSyncDesc:"Synchroniser avec d'autres appareils",gpsDesc:"Utiliser le GPS pour des horodatages précis",autoIncrementDesc:"Augmenter le numéro de dossard après l'enregistrement",photoCaptureDesc:"Capturer une photo à l'enregistrement du temps",hapticFeedbackDesc:"Vibration lors des actions",soundFeedbackDesc:"Confirmation sonore",ambientMode:"Mode veille",ambientModeDesc:"Atténuer après 30s d'inactivité",photoCapture:"Capture photo",photoCaptured:"Photo capturée",photoError:"Échec de la capture photo",photoSaveFailed:"Échec de la sauvegarde photo",viewPhoto:"Voir la photo",deletePhoto:"Supprimer la photo",photoFor:"Photo pour dossard",noPhotoAvailable:"Aucune photo disponible",photoDeleted:"Photo supprimée",raceChangeTitle:"Changer de course",raceChangeSyncedText:"Vous avez des résultats d'une autre course. Les exporter ou les supprimer avant de changer ?",raceChangeUnsyncedText:"Vous avez des résultats existants. Les garder ou les supprimer avant de changer ?",keepResults:"Garder",version:"Version",devices:"Appareils",entries:"entrées",selected:"sélectionné(s)",raceFound:"Course trouvée",raceNew:"Nouvelle course",entryInCloud:"entrée dans le cloud",entriesInCloud:"entrées dans le cloud",photoTooLarge:"Photo trop volumineuse pour la sync",syncedEntriesFromCloud:"{count} entrées synchronisées depuis le cloud",syncedFaultsFromCloud:"{count} fautes synchronisées depuis le cloud",crossDeviceDuplicate:"Doublon : Dossard {bib} {point} déjà enregistré par {device}",syncPhotos:"Synchroniser les photos",syncPhotosDesc:"Partager les photos entre appareils via le cloud",syncPhotosWarning:"Activer la sync des photos",syncPhotosWarningText:"L'activation de la synchronisation des photos transférera les données suivantes :",photosToUpload:"Photos à envoyer",photosToDownload:"Photos à télécharger",totalDataVolume:"Volume total de données",enableSync:"Activer la sync",noPhotosToSync:"Aucune photo à synchroniser",admin:"Admin",adminPin:"PIN de gestion des courses",adminPinDesc:"Requis pour gérer et synchroniser les courses",manageRaces:"Gérer les courses",manageRacesDesc:"Afficher et supprimer les courses synchronisées",manage:"Gérer",enterAdminPin:"Entrez le PIN de gestion des courses",enterPinText:"Entrez votre PIN pour accéder à la gestion des courses.",enterPinToJoinRace:"Entrez votre PIN pour rejoindre cette course.",enterPinForChiefJudge:"Entrez votre PIN pour accéder au mode Directeur de course.",enterChiefJudgePin:"Entrez le PIN Directeur de course",enterPinForChiefJudgeInfo:"Le mode Directeur de course nécessite un PIN séparé. La première saisie définit le PIN.",syncRequiresPin:"Sync désactivée. Activez la sync et entrez le PIN pour vous reconnecter.",incorrectPin:"PIN incorrect",verify:"Vérifier",setPinFirst:"Veuillez d'abord définir un PIN de gestion des courses",pinSaved:"PIN enregistré",pinCleared:"PIN effacé",pinNotSet:"Non défini",pinSet:"PIN défini",setPin:"Définir le PIN",changePin:"Changer le PIN",currentPin:"PIN actuel",newPin:"Nouveau PIN (4 chiffres)",confirmPin:"Confirmer le PIN",pinMismatch:"Les PIN ne correspondent pas",pinFormatError:"Le PIN doit comporter exactement 4 chiffres",loading:"Chargement...",noRaces:"Aucune course active",noRacesHint:"Créez-en une dans les Paramètres",cleanRunHint:"Manche sans faute jusqu'ici",refresh:"Actualiser",raceDeleted:"Course supprimée",raceDeletedText:"Cette course a été supprimée par un administrateur.",raceDeletedFor:"Course supprimée :",raceDeletedSuccess:"Course supprimée :",confirmDeleteRace:"Supprimer la course",confirmDeleteRaceText:"Voulez-vous vraiment supprimer la course",loadError:"Échec du chargement des courses. Vérifiez votre connexion et réessayez.",deleteError:"Échec de la suppression de la course",entry:"entrée",device:"appareil",storageError:"Échec de la sauvegarde - vérifiez le stockage",storageQuotaError:"Stockage plein ! Exportez les données immédiatement",storageWarning:"Stockage presque plein",storageNearlyFull:"Stockage presque plein. Exportez les données et supprimez les anciennes entrées.",networkError:"Erreur réseau - vérifiez la connexion",connectionFailed:"Connexion échouée",serverUnavailable:"Serveur indisponible",rateLimitError:"Trop de requêtes - veuillez patienter",authError:"Authentification échouée. Veuillez ressaisir votre PIN.",syncFailed:"Synchronisation échouée",pinSyncFailed:"PIN non synchronisé avec le cloud",cameraError:"Erreur caméra",cameraPermissionDenied:"Accès à la caméra refusé",gpsError:"Erreur GPS",gpsPermissionDenied:"Accès GPS refusé",gpsUnavailable:"GPS indisponible",wakeLockFailed:"L'écran peut s'éteindre pendant le chronométrage",wakeLockIdleTimeout:"L'écran va s'atténuer pour économiser la batterie. Touchez pour maintenir l'écran actif.",unknownError:"Erreur inconnue",onboardingWelcome:"Bienvenue sur CHRONO",onboardingWelcomeDesc:"Chronométrage synchronisé par GPS pour les courses de ski",getStarted:"C'est parti",skipSetup:"Passer",onboardingRole:"Quel est votre rôle ?",onboardingRoleDesc:"Choisissez comment vous aiderez à la course",roleTimerTitle:"Chronométreur",roleTimerDesc:"Vous enregistrerez les temps de départ et d'arrivée",roleJudgeTitle:"Juge de porte",roleJudgeDesc:"Vous enregistrerez les fautes de porte",onboardingDeviceName:"Nommez votre chronomètre",onboardingDeviceNameDesc:"Ce nom identifie votre appareil lors de la synchronisation",onboardingDeviceNameJudge:"Votre nom",onboardingDeviceNameJudgeDesc:"Ceci vous identifie en tant que juge de porte",onboardingPhoto:"Documentation photo",onboardingPhotoDesc:"Capturer automatiquement une photo à chaque enregistrement de temps. Utile pour vérifier les numéros de dossard et résoudre les litiges.",enablePhotoCapture:"Activer la capture photo",photoCaptureLabel:"Capture photo",onboardingGates:"Votre affectation de portes",onboardingGatesDesc:"Entrez les numéros de portes que vous surveillerez. Vous pourrez les modifier plus tard.",onboardingRaceSetup:"Rejoindre une course",onboardingRaceSetupDesc:"Entrez un ID de course pour synchroniser avec d'autres chronométreurs",skipForNow:"Passer pour le moment",onboardingReady:"Prêt à chronométrer !",onboardingReadyJudge:"Prêt à juger !",onboardingTip:"Appuyez sur le grand bouton bleu pour enregistrer les temps",onboardingTipJudge:"Appuyez sur le dossard d'un coureur pour enregistrer une faute",startTiming:"Démarrer le chronométrage",startJudging:"Commencer à juger",continue:"Continuer",deviceNameLabel:"Nom de l'appareil",raceIdLabel:"ID de course",syncStatusLabel:"Sync cloud",enabled:"Activé",disabled:"Désactivé",showTutorial:"Afficher le tutoriel",showTutorialDesc:"Relancer l'assistant de configuration",show:"Afficher",onboardingComplete:"Configuration terminée !",invalidPin:"Le PIN doit comporter 4 chiffres",recentRaces:"Courses récentes",noRecentRaces:"Aucune course aujourd'hui",errorOccurred:"Une erreur s'est produite",errorRecoveryMessage:"L'application a rencontré une erreur. Vous pouvez ignorer cet avis et continuer, ou recharger l'application.",dismiss:"Ignorer",reload:"Recharger",updateAvailable:"Mise à jour disponible ! Rechargez pour obtenir la dernière version.",operationFailed:"Opération échouée. Veuillez réessayer.",raceIdPlaceholder:"COURSE-001",deviceNamePlaceholder:"Chrono 1",photoForBib:"Photo pour dossard",gateJudge:"Juge de porte",gateJudgeTab:"Porte",deviceRole:"Rôle de l'appareil",deviceRoleDesc:"Le chronométreur enregistre les temps, le juge de porte enregistre les fautes",roleTimer:"Chronométreur",roleGateJudge:"Juge de porte",gateAssignment:"Affectation de portes",noGateAssignment:"Aucune affectation de portes. Veuillez d'abord définir votre zone de portes.",gates:"Portes",gatesFrom:"De",gatesTo:"À",firstGateColor:"Couleur de la première porte",colorRed:"Rouge",colorBlue:"Bleu",changeGates:"Modifier",otherJudges:"Autres juges :",activeBibs:"Sur la piste",noBibsOnCourse:"Aucun coureur sur la piste",recordFault:"Enregistrer une faute",faultType:"Type de faute",faultMG:"Porte manquée",faultSTR:"Enfourché",faultBR:"Fixation ouverte",faultMGShort:"PM",faultSTRShort:"ENF",faultBRShort:"FO",orEnterManually:"ou saisir :",faultRecorded:"Faute enregistrée",signalReady:"Prêt",judgeReady:"Prêt pour la course !",judgeNotReady:"Statut prêt effacé",faultDeleted:"Faute supprimée",recordedFaults:"Fautes enregistrées",selectBib:"Sélectionner le dossard",selectGate:"Porte",gate:"Porte",noFaults:"Aucune faute enregistrée",faultsFor:"Fautes pour",faultSummary:"Résumé des fautes",penaltyTime:"Pénalité",faultCount:"fautes",markOk:"Marquer OK",saveFault:"Enregistrer la faute",selectFaultType:"Veuillez sélectionner un type de faute",gateOutOfRange:"La porte est en dehors de la zone assignée",flt:"PEN",statusFlt:"Pénalité de faute",chiefJudge:"Directeur de course",noFaultsRecorded:"Aucune faute enregistrée",finalize:"Valider",finalized:"Validé",chiefJudgeMode:"Mode Directeur de course",chiefJudgeModeEnabled:"Mode Directeur de course activé",chiefJudgeModeDisabled:"Mode Directeur de course désactivé",racersWithFaults:"Coureurs avec fautes",penaltyMode:"+Temps",gateJudges:"Juges de porte",noJudgesConnected:"Aucun juge de porte connecté",summary:"Résumé",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"Aucune faute à exporter",copiedToClipboard:"Copié dans le presse-papiers",gateJudgeCard:"Carte de juge de porte",race:"Course",date:"Date",gateJudgeLabel:"Juge de porte",runLabel:"Manche",noFaultsEntered:"Aucune faute enregistrée",signature:"Signature",legend:"Légende",missedGateLegend:"Manquée",straddlingLegend:"Enfourché",bindingLegend:"Fixation",gateFaults:"Fautes de porte",penaltyLabel:"PÉNALITÉ",faultSummaryTitle:"RÉSUMÉ DES FAUTES DE PORTE",faults:"Fautes",penalty:"Pénalité",sec:"sec",generated:"Généré",editFault:"Modifier la faute",versionHistory:"Historique des versions",restoreVersion:"Restaurer la version sélectionnée",currentVersion:"Actuelle",originalVersion:"Originale",restored:"Restaurée",versionRestored:"Version restaurée",markForDeletion:"Marquer pour suppression",markForDeletionText:"Cette faute sera marquée pour suppression et nécessite l'approbation du Directeur de course pour être définitivement supprimée.",markedForDeletion:"Marquée pour suppression",deletionPending:"Suppression en attente",pendingDeletions:"Suppressions en attente",approveDeletion:"Approuver la suppression",rejectDeletion:"Rejeter la suppression",deletionMarkedBy:"Marquée par",deletionApproved:"Suppression approuvée",deletionRejected:"Suppression rejetée",cannotEditPendingDeletion:"Impossible de modifier une faute en attente de suppression",voiceMode:"Mode vocal",voiceModeDesc:"Commandes vocales mains libres (Internet requis)",voiceListening:"Écoute...",voiceProcessing:"Traitement...",voiceConfirming:"Confirmer ?",voiceOffline:"Voix indisponible hors ligne",voiceNotSupported:"Voix non supportée dans ce navigateur",voicePermissionDenied:"Accès au microphone refusé",voiceOK:"OK",voiceRecorded:"Enregistré",voiceNotUnderstood:"Non compris",voiceCancelled:"Annulé",voiceError:"Erreur vocale",voiceApiKeyRequired:"Clé API requise pour le mode vocal",pullToRefresh:"Tirez pour actualiser",releaseToRefresh:"Relâchez pour actualiser",synced:"Synchronisé",syncingStatus:"Synchronisation...",gateAssignmentInstructions:"Entrez la zone de portes dont vous êtes responsable :",readySuffix:" - Prêt",viewPhotoLabel:"Voir la photo",editEntryLabel:"Modifier l'entrée",deleteEntryLabel:"Supprimer l'entrée",editFaultLabel:"Modifier la faute",deleteFaultLabel:"Supprimer la faute",deleteLabel:"Supprimer",gateNumberLabel:"Porte",numberLabel:"Numéro",currentTime:"Heure actuelle",pinVerifyOnline:"Le PIN sera vérifié une fois en ligne",addNote:"Ajouter une note",done:"Terminé",recordNote:"Enregistrer une note",listening:"Écoute...",noteSaved:"Note enregistrée",noteDeleted:"Note supprimée",noteCharCount:"caractères",voiceNoteUnsupported:"Saisie vocale non supportée dans ce navigateur",voiceNoteError:"Erreur de saisie vocale",typeNote:"Tapez ou dictez votre note...",hasNote:"A une note",noteTextLabel:"Texte de la note",recordVoiceNoteLabel:"Enregistrer une note vocale",syncOnline:"Sync en ligne",syncOffline:"Hors ligne",syncShortConnected:"Sync",syncShortSyncing:"Sync...",syncShortError:"Erreur",syncShortOff:"Off",syncDeviceAbbrev:"app",sessionExpired:"Session expirée. Veuillez ressaisir votre PIN.",authSuccess:"Authentification réussie",keyboardShortcuts:"Raccourcis clavier",keyboardShortcutsDesc:"Afficher tous les raccourcis clavier",shortcutSection_timer:"Chrono",shortcutSection_gateJudge:"Juge de porte",shortcutSection_results:"Résultats",shortcutSection_global:"Général",shortcut_enterDigit:"Entrer un chiffre de dossard",shortcut_selectStart:"Sélectionner Départ",shortcut_selectFinish:"Sélectionner Arrivée",shortcut_selectRun1:"Sélectionner Manche 1",shortcut_selectRun2:"Sélectionner Manche 2",shortcut_recordTime:"Enregistrer le temps",shortcut_clearBib:"Effacer le dossard",shortcut_deleteLastDigit:"Supprimer le dernier chiffre",shortcut_missedGate:"Porte manquée",shortcut_straddled:"Enfourché",shortcut_broken:"Fixation ouverte",shortcut_selectGate:"Sélectionner la porte",shortcut_navigateBtns:"Naviguer entre les boutons",shortcut_confirmSelection:"Confirmer la sélection",shortcut_navigateItems:"Naviguer entre les éléments",shortcut_editItem:"Modifier l'élément",shortcut_deleteItem:"Supprimer l'élément",shortcut_moveTab:"Changer d'onglet",shortcut_closeModal:"Fermer la modale",shortcut_navigateInComponent:"Naviguer dans le composant",shortcut_showShortcuts:"Afficher les raccourcis",offlineBanner:"Vous êtes hors ligne. Les temps seront sauvegardés localement.",onlineRestored:"De retour en ligne",entryDeleted:"Entrée supprimée",undoAction:"Annuler",multiDeviceDuplicate:"Multi-appareils",duplicateDevices:"{count} appareils",duplicateCount:"{count} doublons"}};function p(n,e="de"){const t=Xe[e],i=Xe.en;return t[n]||i[n]||n}const d={debug:()=>{},log:()=>{},info:()=>{},warn:console.warn.bind(console),error:console.error.bind(console)},Ut=.3,Jt=.15,jt=.05;class qt{constructor(){c(this,"battery",null);c(this,"isInitialized",!1);c(this,"callbacks",new Set);c(this,"currentStatus",{level:1,charging:!0,batteryLevel:"normal"});c(this,"levelChangeHandler",null);c(this,"chargingChangeHandler",null)}isSupported(){return"getBattery"in navigator}async initialize(){if(this.isInitialized)return!0;if(!this.isSupported())return!1;try{return this.battery=await navigator.getBattery(),this.isInitialized=!0,this.updateStatus(),this.levelChangeHandler=()=>this.updateStatus(),this.chargingChangeHandler=()=>this.updateStatus(),this.battery.addEventListener("levelchange",this.levelChangeHandler),this.battery.addEventListener("chargingchange",this.chargingChangeHandler),!0}catch(e){return d.warn("Failed to initialize battery service:",e),!1}}updateStatus(){if(!this.battery)return;const e=this.battery.level,t=this.battery.charging;let i="normal";t||(e<=jt?i="critical":e<=Jt?i="low":e<=Ut&&(i="medium"));const r={level:e,charging:t,batteryLevel:i},s=this.currentStatus.level!==r.level||this.currentStatus.charging!==r.charging||this.currentStatus.batteryLevel!==r.batteryLevel;this.currentStatus=r,s&&this.notifySubscribers()}notifySubscribers(){for(const e of this.callbacks)try{e(this.currentStatus)}catch(t){d.error("Battery callback error:",t)}}subscribe(e){return this.callbacks.add(e),e(this.currentStatus),()=>{this.callbacks.delete(e)}}getStatus(){return{...this.currentStatus}}isLowBattery(){return this.currentStatus.batteryLevel==="low"||this.currentStatus.batteryLevel==="critical"}isCriticalBattery(){return this.currentStatus.batteryLevel==="critical"}isCharging(){return this.currentStatus.charging}getLevelPercent(){return Math.round(this.currentStatus.level*100)}cleanup(){this.battery&&(this.levelChangeHandler&&(this.battery.removeEventListener("levelchange",this.levelChangeHandler),this.levelChangeHandler=null),this.chargingChangeHandler&&(this.battery.removeEventListener("chargingchange",this.chargingChangeHandler),this.chargingChangeHandler=null),this.battery=null),this.callbacks.clear(),this.isInitialized=!1}}const A=new qt;class Qt{constructor(){c(this,"isInitialized",!1);c(this,"isEnabled",!1);c(this,"isAmbientActive",!1);c(this,"triggeredBy",null);c(this,"lastActivityTimestamp",Date.now());c(this,"inactivityCheckId",null);c(this,"batteryUnsubscribe",null);c(this,"callbacks",new Set);c(this,"lastExitTimestamp",0);c(this,"activityHandler",null);c(this,"INACTIVITY_THRESHOLD_MS",3e4)}initialize(){this.isInitialized||(this.isInitialized=!0,this.batteryUnsubscribe=A.subscribe(e=>{e.batteryLevel==="critical"&&!e.charging&&this.isEnabled&&this.enterAmbientMode("battery"),e.charging&&this.isAmbientActive&&this.triggeredBy==="battery"&&this.exitAmbientMode()}),this.activityHandler=()=>this.resetInactivityTimer(),document.addEventListener("touchstart",this.activityHandler,{passive:!0}),document.addEventListener("click",this.activityHandler,{passive:!0}),document.addEventListener("keydown",this.activityHandler,{passive:!0}))}cleanup(){this.disable(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.activityHandler&&(document.removeEventListener("touchstart",this.activityHandler),document.removeEventListener("click",this.activityHandler),document.removeEventListener("keydown",this.activityHandler),this.activityHandler=null),this.callbacks.clear(),this.isInitialized=!1}enable(){this.isEnabled||(this.isEnabled=!0,this.lastActivityTimestamp=Date.now(),this.startInactivityMonitor(),A.isCriticalBattery()&&this.enterAmbientMode("battery"))}disable(){this.isEnabled&&(this.isEnabled=!1,this.stopInactivityMonitor(),this.isAmbientActive&&this.exitAmbientMode())}isActive(){return this.isAmbientActive}getState(){return{isActive:this.isAmbientActive,triggeredBy:this.triggeredBy}}subscribe(e){return this.callbacks.add(e),e(this.getState()),()=>{this.callbacks.delete(e)}}exitAmbientMode(){this.isAmbientActive&&(this.isAmbientActive=!1,this.triggeredBy=null,this.lastActivityTimestamp=Date.now(),this.lastExitTimestamp=Date.now(),this.notifySubscribers(),d.debug("[Ambient] Exited ambient mode"))}wasRecentlyExited(){return Date.now()-this.lastExitTimestamp<500}resetInactivityTimer(){this.lastActivityTimestamp=Date.now(),this.isAmbientActive&&this.exitAmbientMode()}enterAmbientMode(e){this.isAmbientActive||!this.isEnabled||(this.isAmbientActive=!0,this.triggeredBy=e,this.notifySubscribers(),d.debug(`[Ambient] Entered ambient mode (trigger: ${e})`))}startInactivityMonitor(){this.inactivityCheckId===null&&(this.inactivityCheckId=setInterval(()=>{if(!this.isEnabled)return;Date.now()-this.lastActivityTimestamp>=this.INACTIVITY_THRESHOLD_MS&&!this.isAmbientActive&&this.enterAmbientMode("inactivity")},5e3))}stopInactivityMonitor(){this.inactivityCheckId!==null&&(clearInterval(this.inactivityCheckId),this.inactivityCheckId=null)}notifySubscribers(){const e=this.getState();for(const t of this.callbacks)try{t(e)}catch(i){d.error("[Ambient] Callback error:",i)}}}const Os=new Qt,Wt=typeof requestIdleCallback=="function"?n=>requestIdleCallback(n):n=>setTimeout(n,50),et=typeof cancelIdleCallback=="function"?n=>cancelIdleCallback(n):n=>clearTimeout(n);class Yt{constructor(){c(this,"cache",new Map);c(this,"pendingWrites",new Map);c(this,"flushId",null)}get(e){if(this.cache.has(e)){const t=this.cache.get(e);try{return JSON.parse(t)}catch{return null}}try{const t=localStorage.getItem(e);return t===null?null:(this.cache.set(e,t),JSON.parse(t))}catch{return null}}set(e,t){const i=JSON.stringify(t);this.cache.set(e,i),this.pendingWrites.set(e,i),this.scheduleFlush()}remove(e){this.cache.delete(e),this.pendingWrites.set(e,null),this.scheduleFlush()}setRaw(e,t){this.cache.set(e,t),this.pendingWrites.set(e,t),this.scheduleFlush()}getRaw(e){if(this.cache.has(e))return this.cache.get(e);try{const t=localStorage.getItem(e);return t!==null&&this.cache.set(e,t),t}catch{return null}}scheduleFlush(){this.flushId===null&&(this.flushId=Wt(()=>this.flush()))}flush(){this.flushId!==null&&(et(this.flushId),this.flushId=null);const e=new Map(this.pendingWrites);this.pendingWrites.clear();let t=null;for(const[i,r]of e)try{r===null?localStorage.removeItem(i):localStorage.setItem(i,r)}catch(s){d.error(`Storage write failed for key "${i}":`,s),t===null&&(t=s)}if(t!==null)throw t}hasPendingWrites(){return this.pendingWrites.size>0}clearCache(){this.cache.clear(),this.pendingWrites.clear(),this.flushId!==null&&(et(this.flushId),this.flushId=null)}}const b=new Yt,Ee=2;function Kt(n){const e=new Uint8Array(Math.ceil(n/2));return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("").slice(0,n)}function zs(n){var i;const e=Date.now(),t=((i=crypto.randomUUID)==null?void 0:i.call(crypto).slice(0,8))??Kt(8);return`${n}-${e}-${t}`}const Ie=["swift","bold","cool","fast","keen","wild","calm","warm","bright","sharp","quick","brave","fresh","grand","prime","clear","snow","ice","frost","peak","alpine","polar","winter","crisp"],Te=["fox","bear","wolf","hawk","eagle","tiger","lion","deer","pine","oak","cedar","birch","maple","spruce","aspen","willow","peak","ridge","slope","trail","summit","valley","glacier","cliff"];function tt(n){return n.charAt(0).toUpperCase()+n.slice(1)}function Zt(){const n=Ie[Math.floor(Math.random()*Ie.length)],e=Te[Math.floor(Math.random()*Te.length)],t=Math.floor(Math.random()*100);return`dev_${n}-${e}-${t}`}function Fe(){const n=Ie[Math.floor(Math.random()*Ie.length)],e=Te[Math.floor(Math.random()*Te.length)],t=Math.floor(Math.random()*100);return`${tt(n)} ${tt(e)} ${t}`}const Xt=20;function ze(n){return n==="indexeddb"}function Ve(n){return!!n&&n!=="indexeddb"&&n.length>Xt}const nt=5*1024*1024,en=80;function tn(){let n=0;try{for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);if(t){const i=localStorage.getItem(t);n+=(t.length+((i==null?void 0:i.length)??0))*2}}}catch{}return n}function Rt(){const n=tn(),e=Math.round(n/nt*100),t=e>=en;return{usageBytes:n,estimatedQuota:nt,usagePercent:e,warning:t}}function Vs(){const{usageBytes:n,usagePercent:e}=Rt(),t=(n/1024).toFixed(1);d.debug(`[Storage] localStorage usage: ${t} KB (${e}% of ~5MB)`)}const nn=["S","F"],rn=["ok","dns","dnf","dsq","flt"],kt=["MG","STR","BR"],sn=50,an=10;function on(n){return!n||typeof n!="string"||n.length>sn?!1:/^[a-zA-Z0-9_-]+$/.test(n)}function le(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"&&typeof e.id!="number"||typeof e.id=="string"&&e.id.length===0||typeof e.id=="number"&&e.id<=0||e.bib!==void 0&&typeof e.bib!="string"||typeof e.bib=="string"&&e.bib.length>an||!nn.includes(e.point)||!e.timestamp||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||e.status!==void 0&&!rn.includes(e.status)||e.deviceId!==void 0&&typeof e.deviceId!="string"||e.deviceName!==void 0&&typeof e.deviceName!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||e.syncedAt<0||!Number.isFinite(e.syncedAt))||e.photo!==void 0&&typeof e.photo!="string"||e.timeSource!==void 0&&e.timeSource!=="gps"&&e.timeSource!=="system"||e.gpsTimestamp!==void 0&&(typeof e.gpsTimestamp!="number"||!Number.isFinite(e.gpsTimestamp)))return!1;if(e.gpsCoords!==void 0){if(typeof e.gpsCoords!="object"||e.gpsCoords===null)return!1;const t=e.gpsCoords;if(typeof t.latitude!="number"||!Number.isFinite(t.latitude)||typeof t.longitude!="number"||!Number.isFinite(t.longitude)||typeof t.accuracy!="number"||!Number.isFinite(t.accuracy)||t.accuracy<0)return!1}return!0}function cn(n){return!n||typeof n!="string"?!1:n.startsWith("dev_")&&n.length>4}function At(n){return typeof n=="number"&&Number.isInteger(n)&&n>=1}const ln=["create","edit","restore"];function un(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.version!="number"||!Number.isInteger(e.version)||e.version<1||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||typeof e.editedBy!="string"||e.editedBy.length>100||typeof e.editedByDeviceId!="string"||e.editedByDeviceId.length>100||!ln.includes(e.changeType)||!e.data||typeof e.data!="object")return!1;const t=e.data;return!(typeof t.id!="string"||typeof t.bib!="string"||t.bib.length>10||!At(t.run)||typeof t.gateNumber!="number"||!Number.isInteger(t.gateNumber)||t.gateNumber<0||!kt.includes(t.faultType)||typeof t.timestamp!="string"||Number.isNaN(Date.parse(t.timestamp))||typeof t.deviceId!="string"||typeof t.deviceName!="string"||t.deviceName.length>100||!Array.isArray(t.gateRange)||t.gateRange.length!==2||typeof t.gateRange[0]!="number"||typeof t.gateRange[1]!="number"||!Number.isInteger(t.gateRange[0])||!Number.isInteger(t.gateRange[1])||e.changeDescription!==void 0&&typeof e.changeDescription!="string"||typeof e.changeDescription=="string"&&e.changeDescription.length>500)}function dn(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"||e.id.length===0||typeof e.bib!="string"||e.bib.length>10||typeof e.deviceId!="string"||typeof e.deviceName!="string"||e.deviceName.length>100||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||!At(e.run)||typeof e.gateNumber!="number"||!Number.isInteger(e.gateNumber)||e.gateNumber<0||!kt.includes(e.faultType)||!Array.isArray(e.gateRange)||e.gateRange.length!==2||typeof e.gateRange[0]!="number"||typeof e.gateRange[1]!="number"||!Number.isInteger(e.gateRange[0])||!Number.isInteger(e.gateRange[1])||typeof e.currentVersion!="number"||!Number.isInteger(e.currentVersion)||e.currentVersion<1||!Array.isArray(e.versionHistory))return!1;for(const t of e.versionHistory)if(!un(t))return!1;return!(typeof e.markedForDeletion!="boolean"||e.markedForDeletionAt!==void 0&&(typeof e.markedForDeletionAt!="string"||Number.isNaN(Date.parse(e.markedForDeletionAt)))||e.deletionApprovedAt!==void 0&&(typeof e.deletionApprovedAt!="string"||Number.isNaN(Date.parse(e.deletionApprovedAt)))||e.markedForDeletionBy!==void 0&&typeof e.markedForDeletionBy!="string"||e.markedForDeletionByDeviceId!==void 0&&typeof e.markedForDeletionByDeviceId!="string"||e.deletionApprovedBy!==void 0&&typeof e.deletionApprovedBy!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||!Number.isFinite(e.syncedAt)))}function hn(n){if(!dn(n))return null;const e=n,t=e.versionHistory.map(i=>({...i,editedBy:k(i.editedBy,100),editedByDeviceId:k(i.editedByDeviceId,100),changeDescription:i.changeDescription?k(i.changeDescription,500):void 0,data:{...i.data,bib:k(i.data.bib,10),deviceId:k(i.data.deviceId,100),deviceName:k(i.data.deviceName,100)}}));return{...e,bib:k(e.bib,10),deviceId:k(e.deviceId,100),deviceName:k(e.deviceName,100),markedForDeletionBy:e.markedForDeletionBy?k(e.markedForDeletionBy,100):void 0,markedForDeletionByDeviceId:e.markedForDeletionByDeviceId?k(e.markedForDeletionByDeviceId,100):void 0,deletionApprovedBy:e.deletionApprovedBy?k(e.deletionApprovedBy,100):void 0,versionHistory:t}}function gn(n){if(!n||typeof n!="object")return!1;const e=n;return!(!le(e.entry)||typeof e.retryCount!="number"||e.retryCount<0||typeof e.lastAttempt!="number"||e.lastAttempt<0)}function k(n,e=100){return!n||typeof n!="string"?"":n.slice(0,e).replace(/[<>"'&]/g,"").replace(/[\x00-\x1F\x7F]/g,"")}function fn(n,e){if(!le(n))return null;const t=n;return{id:(typeof t.id=="number",String(t.id)),bib:k(t.bib,10),point:t.point,run:t.run??1,timestamp:t.timestamp,status:t.status||"ok",deviceId:k(t.deviceId||e,50),deviceName:k(t.deviceName||"Unknown Device",100),syncedAt:t.syncedAt,photo:t.photo,gpsCoords:t.gpsCoords}}function pn(n,e){const t={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};if(!n||typeof n!="object")return{version:Ee,entries:[],settings:t,deviceId:e,deviceName:Fe(),raceId:"",syncQueue:[]};const i=n;let r=[];Array.isArray(i.entries)&&(r=i.entries.map(o=>fn(o,e)).filter(o=>o!==null));let s=t;if(i.settings&&typeof i.settings=="object"){const o=i.settings;s={auto:typeof o.auto=="boolean"?o.auto:t.auto,haptic:typeof o.haptic=="boolean"?o.haptic:t.haptic,sound:typeof o.sound=="boolean"?o.sound:t.sound,sync:typeof o.sync=="boolean"?o.sync:t.sync,syncPhotos:typeof o.syncPhotos=="boolean"?o.syncPhotos:t.syncPhotos,gps:typeof o.gps=="boolean"?o.gps:t.gps,simple:typeof o.simple=="boolean"?o.simple:t.simple,photoCapture:typeof o.photoCapture=="boolean"?o.photoCapture:t.photoCapture,motionEffects:typeof o.motionEffects=="boolean"?o.motionEffects:t.motionEffects,glassEffects:typeof o.glassEffects=="boolean"?o.glassEffects:t.glassEffects,outdoorMode:typeof o.outdoorMode=="boolean"?o.outdoorMode:t.outdoorMode,ambientMode:typeof o.ambientMode=="boolean"?o.ambientMode:t.ambientMode}}let a=[];return Array.isArray(i.syncQueue)&&(a=i.syncQueue.filter(gn)),{version:Ee,entries:r,settings:s,deviceId:cn(i.deviceId)?i.deviceId:e,deviceName:k(i.deviceName,100)||Fe(),raceId:on(i.raceId)?i.raceId:"",syncQueue:a,lastExport:typeof i.lastExport=="number"?i.lastExport:void 0}}function Hs(n,e){n.addEventListener("input",()=>{n.value=n.value.replace(/[^0-9]/g,""),e!==void 0&&(n.value=n.value.slice(0,e))})}const mn=50;function yn(n,e,t,i){const r=[...n,e],s=fe(t,{type:"ADD_ENTRY",data:e,timestamp:Date.now()});return{entries:r,undoStack:s,redoStack:[]}}function vn(n,e,t,i){const r=n.find(a=>a.id===e);if(!r)return null;const s=fe(t,{type:"DELETE_ENTRY",data:r,timestamp:Date.now()});return{entries:n.filter(a=>a.id!==e),undoStack:s,redoStack:[]}}function bn(n,e,t,i){const r=n.filter(a=>e.includes(a.id));if(r.length===0)return null;const s=fe(t,{type:"DELETE_MULTIPLE",data:r,timestamp:Date.now()});return{entries:n.filter(a=>!e.includes(a.id)),undoStack:s,redoStack:[]}}function Sn(n,e,t){if(n.length===0)return null;const i=fe(e,{type:"CLEAR_ALL",data:[...n],timestamp:Date.now()});return{entries:[],undoStack:i,redoStack:[]}}function wn(n,e,t,i,r){const s=n.findIndex(g=>g.id===e);if(s===-1)return null;const a=n[s],o={...a,...t},u=fe(i,{type:"UPDATE_ENTRY",data:a,newData:o,timestamp:Date.now()}),h=[...n];return h[s]=o,{entries:h,undoStack:u,redoStack:[]}}function fe(n,e){const t=[...n,e];return t.length>mn&&t.shift(),t}function En(n,e,t){if(e.length===0)return{entries:n,undoStack:e,redoStack:t,result:null};const i=[...e],r=i.pop(),s=[...t,r];let a=[...n],o=null;switch(r.type){case"ADD_ENTRY":{const u=r.data;a=a.filter(h=>h.id!==u.id),o=u;break}case"DELETE_ENTRY":{const u=r.data;a.push(u),a.sort((h,g)=>new Date(h.timestamp).getTime()-new Date(g.timestamp).getTime()),o=u;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const u=r.data;a=[...a,...u],a.sort((h,g)=>new Date(h.timestamp).getTime()-new Date(g.timestamp).getTime()),o=u;break}case"UPDATE_ENTRY":{const u=r.data,h=a.findIndex(g=>g.id===u.id);h!==-1&&(a[h]=u),o=u;break}}return{entries:a,undoStack:i,redoStack:s,result:o?{type:r.type,data:o}:null}}function In(n,e,t){if(t.length===0)return{entries:n,undoStack:e,redoStack:t,result:null};const i=[...t],r=i.pop(),s=[...e,r];let a=[...n],o=null;switch(r.type){case"ADD_ENTRY":{const u=r.data;a.push(u),a.sort((h,g)=>new Date(h.timestamp).getTime()-new Date(g.timestamp).getTime()),o=u;break}case"DELETE_ENTRY":{const u=r.data;a=a.filter(h=>h.id!==u.id),o=u;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const u=r.data,h=new Set(u.map(g=>g.id));a=a.filter(g=>!h.has(g.id)),o=u;break}case"UPDATE_ENTRY":{const u=r.data,h=r.newData,g=a.findIndex(f=>f.id===u.id);g!==-1&&h&&(a[g]=h),o=h||u;break}}return{entries:a,undoStack:s,redoStack:i,result:o}}function Tn(n,e){const t={entry:e,retryCount:0,lastAttempt:0};return[...n,t]}function Cn(n,e){return n.filter(t=>t.entry.id!==e)}function Rn(n,e,t){return n.map(i=>i.entry.id===e?{...i,...t}:i)}function kn(n,e,t,i){let r=0;const s=new Set(n.map(u=>`${u.id}-${u.deviceId}`)),a=new Set(t),o=[];for(const u of e){if(!le(u)||u.deviceId===i)continue;const h=`${u.id}:${u.deviceId}`;if(a.has(h)||a.has(u.id))continue;const g=`${u.id}-${u.deviceId}`;s.has(g)||(o.push({...u,run:u.run??1}),s.add(g),r++)}if(o.length>0){const u=[...n,...o];return u.sort((h,g)=>new Date(h.timestamp).getTime()-new Date(g.timestamp).getTime()),{entries:u,addedCount:r}}return{entries:n,addedCount:r}}function An(n,e){const t=new Set(e);let i=0;return{entries:n.filter(s=>{const a=`${s.id}:${s.deviceId}`;return t.has(a)||t.has(s.id)?(i++,!1):!0}),removedCount:i}}const it=50;function He(n){return{id:n.id,bib:n.bib,run:n.run,gateNumber:n.gateNumber,faultType:n.faultType,timestamp:n.timestamp,deviceId:n.deviceId,deviceName:n.deviceName,gateRange:n.gateRange,syncedAt:n.syncedAt,notes:n.notes,notesSource:n.notesSource,notesTimestamp:n.notesTimestamp}}function Ce(n,e,t,i,r,s){return{version:n,timestamp:new Date().toISOString(),editedBy:i,editedByDeviceId:r,changeType:e,data:t,changeDescription:s}}function Ge(n,e){const t=[...n||[],e];return t.length>it?t.slice(-it):t}function Dn(n,e){const t=Ce(1,"create",He(e),e.deviceName,e.deviceId),i={...e,currentVersion:1,versionHistory:[t],markedForDeletion:!1};return[...n,i]}function Pn(n,e){return n.filter(t=>t.id!==e)}function Ln(n,e,t){const i=n.findIndex(s=>s.id===e);if(i===-1)return null;const r=[...n];return r[i]={...r[i],...t},r}function Fn(n,e,t,i,r,s){const a=n.findIndex(y=>y.id===e);if(a===-1)return null;const o=n[a];if(o.markedForDeletion)return null;const u=o.currentVersion+1,h={...o,...t},g=Ce(u,"edit",He(h),i,r,s),f=[...n];return f[a]={...h,currentVersion:u,versionHistory:Ge(o.versionHistory,g)},f}function Nn(n,e,t,i,r){var f;const s=n.findIndex(y=>y.id===e);if(s===-1)return null;const a=n[s];if(a.markedForDeletion)return null;const o=(f=a.versionHistory)==null?void 0:f.find(y=>y.version===t);if(!o)return null;const u=a.currentVersion+1,h=Ce(u,"restore",{...o.data},i,r,`Restored to version ${t}`),g=[...n];return g[s]={...a,bib:o.data.bib,run:o.data.run,gateNumber:o.data.gateNumber,faultType:o.data.faultType,notes:o.data.notes,notesSource:o.data.notesSource,notesTimestamp:o.data.notesTimestamp,currentVersion:u,versionHistory:Ge(a.versionHistory,h)},g}function Mn(n,e,t,i){const r=n.findIndex(a=>a.id===e);if(r===-1)return null;const s=[...n];return s[r]={...s[r],markedForDeletion:!0,markedForDeletionAt:new Date().toISOString(),markedForDeletionBy:t,markedForDeletionByDeviceId:i},s}function xn(n,e,t){const i=n.find(s=>s.id===e);if(!i||!i.markedForDeletion)return{faultEntries:n,approvedFault:null};const r={...i,deletionApprovedAt:new Date().toISOString(),deletionApprovedBy:t};return{faultEntries:n.filter(s=>s.id!==e),approvedFault:r}}function $n(n,e,t,i){const r=n.findIndex(h=>h.id===e);if(r===-1)return null;const s=n[r],a=s.currentVersion+1,o=Ce(a,"edit",He(s),t,i,"Deletion rejected by Chief Judge"),u=[...n];return u[r]={...u[r],markedForDeletion:!1,markedForDeletionAt:void 0,markedForDeletionBy:void 0,markedForDeletionByDeviceId:void 0,currentVersion:a,versionHistory:Ge(s.versionHistory,o)},u}function Bn(n){return n.filter(e=>e.markedForDeletion)}function _n(n,e,t){return n.filter(i=>i.bib===e&&i.run===t)}function On(n,e){const t=n.findIndex(r=>r.id===e);if(t===-1)return n;const i=[...n];return i[t]={...i[t],syncedAt:Date.now()},i}function zn(n,e,t,i){let r=0,s=0;const a=new Map(n.map(g=>[`${g.id}-${g.deviceId}`,g])),o=new Set(t),u=[],h=[];for(const g of e){const f=hn(g);if(!f){d.warn("Skipping invalid fault from cloud:",g);continue}if(f.deviceId===i)continue;const y=`${f.id}:${f.deviceId}`;if(o.has(y)||o.has(f.id))continue;const v=`${f.id}-${f.deviceId}`,m=a.get(v);if(m){const E=f.currentVersion||1,C=m.currentVersion||1;(E>C||f.markedForDeletion!==m.markedForDeletion)&&(h.push(f),s++)}else u.push(f),r++}if(u.length>0||h.length>0){let g=[...n];for(const f of h){const y=`${f.id}-${f.deviceId}`,v=g.findIndex(m=>`${m.id}-${m.deviceId}`===y);v!==-1&&(g[v]=f)}return g=[...g,...u],g.sort((f,y)=>new Date(f.timestamp).getTime()-new Date(y.timestamp).getTime()),{faultEntries:g,addedCount:r+s}}return{faultEntries:n,addedCount:0}}function Vn(n,e){const t=new Set(e);let i=0;return{faultEntries:n.filter(s=>{const a=`${s.id}:${s.deviceId}`;return t.has(a)||t.has(s.id)?(i++,!1):!0}),removedCount:i}}function Hn(n){return{deviceRole:n}}function Gn(n){return{gateAssignment:n}}function Un(n){return{firstGateColor:n}}function Jn(n,e,t){if(!e)return t;const[i]=e;return(n-i)%2===0?t:t==="red"?"blue":"red"}function jn(n){return{selectedFaultBib:n}}function qn(n){return{isJudgeReady:n}}function Qn(n){return{isJudgeReady:!n}}function Wn(n){return{isChiefJudgeView:n}}function Yn(n){return{isChiefJudgeView:!n}}function Kn(n,e,t){const i=`${n}-${e}`,r=new Set(t);return r.add(i),{finalizedRacers:r}}function Zn(n,e,t){const i=`${n}-${e}`,r=new Set(t);return r.delete(i),{finalizedRacers:r}}function Xn(n,e,t){const i=`${n}-${e}`;return t.has(i)}function ei(){return{finalizedRacers:new Set}}function ti(n){return{penaltySeconds:Math.max(0,Math.min(60,n))}}function ni(n){return{usePenaltyMode:n}}function ii(n,e){const t=n.filter(a=>a.point==="S"&&a.run===e),i=n.filter(a=>a.point==="F"&&a.run===e),r=new Set(i.map(a=>a.bib)),s=new Set(t.filter(a=>!r.has(a.bib)).map(a=>a.bib));return Array.from(s).sort((a,o)=>parseInt(a,10)-parseInt(o,10))}const rt={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};function ri(n,e){return{...n,...e}}function si(n,e){return{...n,[e]:!n[e]}}function ai(n){return{syncStatus:n}}function oi(n,e){return{raceId:n,clearUndoRedo:n!==e}}function ci(n){return{lastSyncedRaceId:n}}function li(n){return{deviceName:n}}const ui=12e4;function di(n,e){const t=Date.now(),i=new Map;for(const[r,s]of e)t-s.lastSeen<ui&&i.set(r,s);return i.set(n.id,n),{connectedDevices:i}}function hi(n,e){const t=new Map(e);return t.delete(n),{connectedDevices:t}}function gi(n){return{cloudDeviceCount:n}}function fi(n){return{cloudHighestBib:n}}function pi(n){return{raceExistsInCloud:n}}function mi(n){return{currentView:n}}function yi(n){return{currentLang:n}}function vi(n){return{bibInput:n.replace(/\D/g,"").slice(0,3)}}function bi(n){return{selectedPoint:n}}function Si(n){return{selectedRun:n}}function wi(n,e){return{selectMode:n,selectedEntries:n?e:new Set}}function Ei(n,e){const t=new Set(e);return t.has(n)?t.delete(n):t.add(n),{selectedEntries:t,selectMode:t.size>0}}function Ii(n){return{selectedEntries:new Set(n),selectMode:!0}}function Ti(){return{selectedEntries:new Set,selectMode:!1}}function Ci(n){return{isRecording:n}}const T={ENTRIES:"skiTimerEntries",SETTINGS:"skiTimerSettings",LANG:"skiTimerLang",DEVICE_ID:"skiTimerDeviceId",DEVICE_NAME:"skiTimerDeviceName",RACE_ID:"skiTimerRaceId",LAST_SYNCED_RACE_ID:"skiTimerLastSyncedRaceId",SYNC_QUEUE:"skiTimerSyncQueue",SCHEMA_VERSION:"skiTimerSchemaVersion",DEVICE_ROLE:"skiTimerDeviceRole",GATE_ASSIGNMENT:"skiTimerGateAssignment",FIRST_GATE_COLOR:"skiTimerFirstGateColor",FAULT_ENTRIES:"skiTimerFaultEntries"},Ri=["entries","settings","currentLang","deviceName","raceId","lastSyncedRaceId","syncQueue","deviceRole","gateAssignment","firstGateColor","faultEntries"];function de(n,e,t){try{const i=b.getRaw(n);if(!i)return e;const r=JSON.parse(i);return t?t(r):r}catch(i){return d.error(`Failed to parse ${n}:`,i),e}}class ki{constructor(){c(this,"state");c(this,"$state");c(this,"saveTimeout",null);c(this,"dirtySlices",new Set);this.state=this.loadInitialState(),this.$state=Gt(this.state)}loadInitialState(){let e=b.getRaw(T.DEVICE_ID);e||(e=Zt(),b.setRaw(T.DEVICE_ID,e),b.flush());const t=de(T.ENTRIES,[],m=>Array.isArray(m)?m.filter(E=>le(E)).map(E=>({...E,run:E.run??1})):[]),i=de(T.SETTINGS,rt,m=>({...rt,...m})),r=de(T.SYNC_QUEUE,[],m=>Array.isArray(m)?m:[]),s=b.getRaw(T.LANG)||"de";let a=b.getRaw(T.DEVICE_NAME);a||(a=Fe(),b.setRaw(T.DEVICE_NAME,a),b.flush());const o=b.getRaw(T.RACE_ID)||"",u=b.getRaw(T.LAST_SYNCED_RACE_ID)||"",h=b.getRaw(T.DEVICE_ROLE)||"timer",g=de(T.GATE_ASSIGNMENT,null,m=>Array.isArray(m)&&m.length===2?m:null),f=b.getRaw(T.FIRST_GATE_COLOR),y=f==="red"||f==="blue"?f:"red",v=de(T.FAULT_ENTRIES,[],m=>Array.isArray(m)?m:[]);return{currentView:h==="gateJudge"?"gateJudge":"timer",currentLang:s,bibInput:"",selectedPoint:"F",selectedRun:1,selectMode:!1,selectedEntries:new Set,isRecording:!1,lastRecordedEntry:null,entries:t,deviceRole:h,gateAssignment:g,firstGateColor:y,faultEntries:v,selectedFaultBib:"",isJudgeReady:!1,isChiefJudgeView:!1,finalizedRacers:new Set,penaltySeconds:5,usePenaltyMode:!0,undoStack:[],redoStack:[],settings:i,deviceId:e,deviceName:a,raceId:o,lastSyncedRaceId:u,syncStatus:"disconnected",syncQueue:r,connectedDevices:new Map,cloudDeviceCount:0,cloudHighestBib:0,raceExistsInCloud:null,gpsEnabled:i.gps,gpsAccuracy:null,gpsStatus:"inactive",cameraReady:!1,cameraError:null}}getState(){return this.$state.value}setState(e,t=!0){if(this.state={...this.state,...e},this.$state.value=this.state,t){for(const i of Object.keys(e))this.dirtySlices.add(i);this.scheduleSave()}}scheduleSave(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveToStorage(),100)}forceSave(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null);for(const e of Ri)this.dirtySlices.add(e);this.saveToStorage()}saveToStorage(){const e=this.dirtySlices;if(this.dirtySlices=new Set,e.size!==0)try{if(this.checkStorageQuota(),e.has("entries")){const i=this.state.entries.map(r=>Ve(r.photo)?{...r,photo:"indexeddb"}:r);b.setRaw(T.ENTRIES,JSON.stringify(i))}e.has("settings")&&b.setRaw(T.SETTINGS,JSON.stringify(this.state.settings)),e.has("currentLang")&&b.setRaw(T.LANG,this.state.currentLang),e.has("deviceName")&&b.setRaw(T.DEVICE_NAME,this.state.deviceName),e.has("raceId")&&b.setRaw(T.RACE_ID,this.state.raceId),e.has("lastSyncedRaceId")&&b.setRaw(T.LAST_SYNCED_RACE_ID,this.state.lastSyncedRaceId),e.has("syncQueue")&&b.setRaw(T.SYNC_QUEUE,JSON.stringify(this.state.syncQueue)),e.has("deviceRole")&&b.setRaw(T.DEVICE_ROLE,this.state.deviceRole),e.has("gateAssignment")&&(this.state.gateAssignment?b.setRaw(T.GATE_ASSIGNMENT,JSON.stringify(this.state.gateAssignment)):b.remove(T.GATE_ASSIGNMENT)),e.has("firstGateColor")&&b.setRaw(T.FIRST_GATE_COLOR,this.state.firstGateColor),e.has("faultEntries")&&b.setRaw(T.FAULT_ENTRIES,JSON.stringify(this.state.faultEntries)),(e.has("entries")||e.has("settings"))&&b.setRaw(T.SCHEMA_VERSION,String(Ee)),b.flush();const t=Rt();t.warning&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t.usageBytes,quota:t.estimatedQuota,percent:t.usagePercent,critical:t.usagePercent>90}}))}catch(t){d.error("Failed to save to storage:",t),this.dispatchStorageError(t)}}async checkStorageQuota(){var e;if((e=navigator.storage)!=null&&e.estimate)try{const{usage:t,quota:i}=await navigator.storage.estimate();if(i&&t){const r=t/i;r>.75&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t,quota:i,percent:Math.round(r*100),critical:r>.9}}))}}catch(t){d.warn("Could not check storage quota:",t)}}dispatchStorageError(e){window.dispatchEvent(new CustomEvent("storage-error",{detail:{message:e.message,isQuotaError:e.name==="QuotaExceededError"||e.message.includes("quota")||e.message.includes("storage"),entryCount:this.state.entries.length}}))}addEntry(e){const t=yn(this.state.entries,e,this.state.undoStack,this.state.redoStack);this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack,lastRecordedEntry:e,isRecording:!1}),this.state.settings.sync&&this.state.raceId&&this.addToSyncQueue(e)}deleteEntry(e){const t=vn(this.state.entries,e,this.state.undoStack,this.state.redoStack);t&&this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack})}deleteMultiple(e){const t=bn(this.state.entries,e,this.state.undoStack,this.state.redoStack);t&&this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack,selectMode:!1,selectedEntries:new Set})}clearAll(){const e=Sn(this.state.entries,this.state.undoStack,this.state.redoStack);e&&this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack,selectMode:!1,selectedEntries:new Set})}updateEntry(e,t){const i=wn(this.state.entries,e,t,this.state.undoStack,this.state.redoStack);return i?(this.setState({entries:i.entries,undoStack:i.undoStack,redoStack:i.redoStack}),!0):!1}canUndo(){return this.state.undoStack.length>0}canRedo(){return this.state.redoStack.length>0}peekUndo(){return this.canUndo()?this.state.undoStack[this.state.undoStack.length-1]??null:null}undo(){const e=En(this.state.entries,this.state.undoStack,this.state.redoStack);return this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack}),e.result}redo(){const e=In(this.state.entries,this.state.undoStack,this.state.redoStack);return this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack}),e.result}addToSyncQueue(e){const t=Tn(this.state.syncQueue,e);this.setState({syncQueue:t})}removeFromSyncQueue(e){const t=Cn(this.state.syncQueue,e);this.setState({syncQueue:t})}updateSyncQueueItem(e,t){const i=Rn(this.state.syncQueue,e,t);this.setState({syncQueue:i})}clearSyncQueue(){this.setState({syncQueue:[]})}setView(e){this.setState(mi(e),!1)}setLanguage(e){this.setState(yi(e))}setBibInput(e){this.setState(vi(e),!1)}setSelectedPoint(e){this.setState(bi(e),!1)}setSelectedRun(e){this.setState(Si(e),!1)}setSelectMode(e){this.setState(wi(e,this.state.selectedEntries),!1)}toggleEntrySelection(e){this.setState(Ei(e,this.state.selectedEntries),!1)}selectAllEntries(){this.setState(Ii(this.state.entries.map(e=>e.id)),!1)}clearSelection(){this.setState(Ti(),!1)}setRecording(e){this.setState(Ci(e),!1)}setDeviceRole(e){this.setState(Hn(e))}setGateAssignment(e){this.setState(Gn(e))}setFirstGateColor(e){this.setState(Un(e))}getGateColor(e){return Jn(e,this.state.gateAssignment,this.state.firstGateColor)}setSelectedFaultBib(e){this.setState(jn(e),!1)}setJudgeReady(e){this.setState(qn(e))}toggleJudgeReady(){this.setState(Qn(this.state.isJudgeReady))}setChiefJudgeView(e){this.setState(Wn(e),!1)}toggleChiefJudgeView(){this.setState(Yn(this.state.isChiefJudgeView),!1)}finalizeRacer(e,t){this.setState(Kn(e,t,this.state.finalizedRacers),!1)}unfinalizeRacer(e,t){this.setState(Zn(e,t,this.state.finalizedRacers),!1)}isRacerFinalized(e,t){return Xn(e,t,this.state.finalizedRacers)}clearFinalizedRacers(){this.setState(ei(),!1)}setPenaltySeconds(e){this.setState(ti(e),!1)}setUsePenaltyMode(e){this.setState(ni(e),!1)}getActiveBibs(e){return ii(this.state.entries,e)}addFaultEntry(e){const t=Dn(this.state.faultEntries,e);this.setState({faultEntries:t})}deleteFaultEntry(e){const t=Pn(this.state.faultEntries,e);this.setState({faultEntries:t})}updateFaultEntry(e,t){const i=Ln(this.state.faultEntries,e,t);return i?(this.setState({faultEntries:i}),!0):!1}updateFaultEntryWithHistory(e,t,i){const r=Fn(this.state.faultEntries,e,t,this.state.deviceName,this.state.deviceId,i);return r?(this.setState({faultEntries:r}),!0):!1}restoreFaultVersion(e,t){const i=Nn(this.state.faultEntries,e,t,this.state.deviceName,this.state.deviceId);return i?(this.setState({faultEntries:i}),!0):!1}markFaultForDeletion(e){const t=Mn(this.state.faultEntries,e,this.state.deviceName,this.state.deviceId);return t?(this.setState({faultEntries:t}),!0):!1}approveFaultDeletion(e){const t=xn(this.state.faultEntries,e,this.state.deviceName);return t.approvedFault&&this.setState({faultEntries:t.faultEntries}),t.approvedFault}rejectFaultDeletion(e){const t=$n(this.state.faultEntries,e,this.state.deviceName,this.state.deviceId);return t?(this.setState({faultEntries:t}),!0):!1}getPendingDeletions(){return Bn(this.state.faultEntries)}clearFaultEntries(){this.setState({faultEntries:[]})}getFaultsForBib(e,t){return _n(this.state.faultEntries,e,t)}mergeFaultsFromCloud(e,t=[]){const i=zn(this.state.faultEntries,e,t,this.state.deviceId);return i.addedCount>0&&this.setState({faultEntries:i.faultEntries}),i.addedCount}removeDeletedCloudFaults(e){const t=Vn(this.state.faultEntries,e);return t.removedCount>0&&this.setState({faultEntries:t.faultEntries}),t.removedCount}markFaultSynced(e){const t=On(this.state.faultEntries,e);this.setState({faultEntries:t})}updateSettings(e){const t=ri(this.state.settings,e);this.setState({settings:t})}toggleSetting(e){const t=si(this.state.settings,e);this.setState({settings:t})}setSyncStatus(e){this.setState(ai(e),!1)}setRaceId(e){const t=oi(e,this.state.raceId);t.clearUndoRedo?this.setState({raceId:t.raceId,undoStack:[],redoStack:[]}):this.setState({raceId:t.raceId})}setLastSyncedRaceId(e){this.setState(ci(e))}markCurrentRaceAsSynced(){this.setState({lastSyncedRaceId:this.state.raceId})}setDeviceName(e){this.setState(li(e))}addConnectedDevice(e){this.setState(di(e,this.state.connectedDevices),!1)}removeConnectedDevice(e){this.setState(hi(e,this.state.connectedDevices),!1)}setCloudDeviceCount(e){this.setState(gi(e),!1)}setCloudHighestBib(e){this.setState(fi(e),!1)}setRaceExistsInCloud(e){this.setState(pi(e),!1)}setGpsStatus(e,t){this.setState({gpsStatus:e,gpsAccuracy:t??null},!1)}setCameraReady(e,t){this.setState({cameraReady:e,cameraError:t??null},!1)}mergeCloudEntries(e,t=[]){const i=kn(this.state.entries,e,t,this.state.deviceId);return i.addedCount>0&&this.setState({entries:i.entries}),i.addedCount}removeDeletedCloudEntries(e){const t=An(this.state.entries,e);return t.removedCount>0&&this.setState({entries:t.entries}),t.removedCount}exportData(){return JSON.stringify({version:Ee,entries:this.state.entries,settings:this.state.settings,deviceId:this.state.deviceId,deviceName:this.state.deviceName,raceId:this.state.raceId,exportedAt:new Date().toISOString()},null,2)}importData(e){try{const t=JSON.parse(e),i=pn(t,this.state.deviceId),r=new Set(this.state.entries.map(a=>a.id)),s=i.entries.filter(a=>!r.has(a.id));if(s.length>0){const a=[...this.state.entries,...s];a.sort((o,u)=>new Date(o.timestamp).getTime()-new Date(u.timestamp).getTime()),this.setState({entries:a})}return{success:!0,entriesImported:s.length}}catch(t){return{success:!1,entriesImported:0,error:String(t)}}}}const l=new ki,st=w(()=>l.$state.value.entries),Ai=w(()=>l.$state.value.settings),Gs=w(()=>l.$state.value.syncStatus);w(()=>l.$state.value.currentLang);const Us=w(()=>l.$state.value.gpsStatus),Ae=w(()=>l.$state.value.deviceRole),ye=w(()=>l.$state.value.faultEntries);w(()=>l.$state.value.entries.length);const Js=w(()=>l.$state.value.cloudDeviceCount),js=w(()=>l.$state.value.currentView),qs=w(()=>l.$state.value.bibInput),Qs=w(()=>l.$state.value.selectedPoint),Ws=w(()=>l.$state.value.selectedRun),Ys=w(()=>l.$state.value.undoStack),Di=w(()=>l.$state.value.isJudgeReady),Pi=w(()=>l.$state.value.gateAssignment),at=w(()=>l.$state.value.isChiefJudgeView),ot=w(()=>l.$state.value.penaltySeconds),ct=w(()=>l.$state.value.usePenaltyMode),Ks=w(()=>l.$state.value.selectedEntries);w(()=>l.$state.value.syncStatus==="syncing");const Zs=w(()=>l.$state.value.settings.sync),Xs=w(()=>l.$state.value.settings.syncPhotos),ea=w(()=>l.$state.value.settings.gps),ta=w(()=>l.$state.value.settings.photoCapture),na=w(()=>l.$state.value.settings.glassEffects),ia=w(()=>l.$state.value.settings.outdoorMode),ra=w(()=>l.$state.value.settings.ambientMode);w(()=>{const n=l.$state.value;return n.entries.some(e=>!e.syncedAt)||n.syncQueue.length>0});w(()=>{const n=l.$state.value.entries;return{run1:n.filter(e=>e.run===1),run2:n.filter(e=>e.run===2)}});const lt={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},Li={video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}},audio:!1},Fi=.8,ve=1280,be=720,ut=200,Ni=5e3,dt=3,Mi=12e4;class xi{constructor(){c(this,"stream",null);c(this,"videoElement",null);c(this,"canvasElement",null);c(this,"cameraState","stopped");c(this,"visibilityHandler",null);c(this,"pendingVisibilityChange",null);c(this,"previewElement",null);c(this,"ownsVideoElement",!1);c(this,"resumingStartedAt",null);c(this,"reinitRetryCount",0);c(this,"idleTimeoutId",null)}createVideoElement(){if(this.previewElement)return this.ownsVideoElement=!1,this.previewElement;const e=document.createElement("video");return e.setAttribute("autoplay",""),e.setAttribute("playsinline",""),e.style.position="absolute",e.style.left="-9999px",e.style.top="-9999px",document.body.appendChild(e),this.ownsVideoElement=!0,e}waitForVideoReady(){return new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))})}async initialize(){if(this.cameraState==="ready")return!0;if(this.cameraState==="initializing")return!1;this.cameraState="initializing",this.reinitRetryCount=0;try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not available");if(A.isCriticalBattery())return d.debug("[Camera] Critical battery, skipping initialization"),this.cameraState="stopped",l.setCameraReady(!1,"Camera disabled on critical battery"),!1;this.videoElement=this.createVideoElement(),this.canvasElement=document.createElement("canvas"),this.canvasElement.width=ve,this.canvasElement.height=be;const e=A.isLowBattery()?Li:lt;return this.stream=await navigator.mediaDevices.getUserMedia(e),this.videoElement.srcObject=this.stream,await this.waitForVideoReady(),this.pendingVisibilityChange==="hidden"?(this.pendingVisibilityChange=null,this.pauseCamera(),!1):(this.cameraState="ready",l.setCameraReady(!0),this.resetIdleTimeout(),this.visibilityHandler||(this.visibilityHandler=()=>this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.visibilityHandler)),!0)}catch(e){const t=e instanceof Error?e.message:"Camera initialization failed";return d.error("Camera initialization error:",t),this.cameraState="stopped",l.setCameraReady(!1,t),!1}}handleVisibilityChange(){document.hidden?this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange="hidden":this.cameraState==="ready"&&this.pauseCamera():this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange=null:this.cameraState==="paused"&&this.reinitializeCamera()}pauseCamera(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.videoElement&&(this.videoElement.srcObject=null)),this.cameraState="paused",l.setCameraReady(!1)}async reinitializeCamera(){if(this.cameraState==="resuming")if(this.resumingStartedAt&&Date.now()-this.resumingStartedAt>Ni)d.warn("Camera stuck in resuming state, resetting for retry"),this.cameraState="paused",this.resumingStartedAt=null;else return;if(this.reinitRetryCount>=dt){d.warn(`Camera reinit failed after ${dt} attempts, giving up`),this.cameraState="stopped",this.resumingStartedAt=null,l.setCameraReady(!1,"Camera reinitialization failed");return}this.cameraState="resuming",this.resumingStartedAt=Date.now(),this.reinitRetryCount++;try{if(this.videoElement||(this.videoElement=this.createVideoElement()),this.stream=await navigator.mediaDevices.getUserMedia(lt),this.videoElement.srcObject=this.stream,await this.waitForVideoReady(),this.pendingVisibilityChange==="hidden"){this.pendingVisibilityChange=null,this.resumingStartedAt=null,this.pauseCamera();return}this.cameraState="ready",this.resumingStartedAt=null,this.reinitRetryCount=0,l.setCameraReady(!0),this.resetIdleTimeout()}catch(e){d.error("Failed to reinitialize camera:",e),this.cameraState="stopped",this.resumingStartedAt=null}}async capturePhoto(){if(this.cameraState!=="ready"||!this.videoElement||!this.canvasElement)return d.warn("Camera not ready for capture"),null;this.resetIdleTimeout();try{const e=this.canvasElement.getContext("2d");if(!e)throw new Error("Could not get canvas context");const t=this.videoElement.videoWidth,i=this.videoElement.videoHeight;let r=t,s=i;if(r>ve){const g=ve/r;r=ve,s=Math.round(s*g)}if(s>be){const g=be/s;s=be,r=Math.round(r*g)}this.canvasElement.width=r,this.canvasElement.height=s,e.drawImage(this.videoElement,0,0,r,s);const a=new Date().toISOString();e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,s-30,r,30),e.fillStyle="#ffffff",e.font="14px monospace",e.fillText(a,10,s-10);const u=this.canvasElement.toDataURL("image/jpeg",Fi).split(",")[1]??null;if(!u)return null;const h=Math.round(u.length/1024);if(h>ut){const g=new Error(`Photo too large (${h}KB > ${ut}KB limit)`);throw g.name="PhotoTooLargeError",g}return u}catch(e){return d.error("Photo capture error:",e),null}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null,this.ownsVideoElement&&(this.videoElement.remove(),this.videoElement=null)),this.canvasElement=null,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.pendingVisibilityChange=null,this.resumingStartedAt=null,this.clearIdleTimeout(),this.cameraState="stopped",l.setCameraReady(!1)}isReady(){return this.cameraState==="ready"}setPreviewElement(e){if(this.previewElement=e,!e){this.videoElement&&!this.ownsVideoElement&&(this.videoElement.srcObject=null,this.videoElement=null);return}this.videoElement!==e&&(this.videoElement&&this.ownsVideoElement&&this.videoElement.remove(),this.videoElement=e,this.ownsVideoElement=!1),this.stream&&(this.videoElement.srcObject=this.stream,this.videoElement.play().catch(()=>null))}getVideoElement(){return this.videoElement}getError(){return l.getState().cameraError}resetIdleTimeout(){this.clearIdleTimeout(),this.idleTimeoutId=setTimeout(()=>{this.cameraState==="ready"&&(d.debug("[Camera] Idle timeout, pausing stream to save battery"),this.pauseCamera())},Mi)}clearIdleTimeout(){this.idleTimeoutId!==null&&(clearTimeout(this.idleTimeoutId),this.idleTimeoutId=null)}async toggle(e){return e?this.initialize():(this.stop(),!0)}}const De=new xi;async function sa(){return!l.getState().settings.photoCapture||!De.isReady()&&!await De.initialize()?null:De.capturePhoto()}let O=null,Y=null;const $i=5e3;function Dt(){if(!O)try{O=new(window.AudioContext||window.webkitAudioContext)}catch(n){return d.warn("AudioContext not available:",n),null}return O}function Bi(){Y!==null&&clearTimeout(Y),Y=window.setTimeout(()=>{O&&O.state==="running"&&O.suspend().catch(()=>{}),Y=null},$i)}function _i(n){const{batteryLevel:e}=A.getStatus();if(e==="critical")return null;const t=e==="low"?.5:e==="medium"?.75:1;return t===1?n:typeof n=="number"?Math.round(n*t):n.map(i=>Math.round(i*t))}function ee(n){if(!l.getState().settings.haptic)return;const t=_i(n);if(t!==null&&navigator.vibrate)try{navigator.vibrate(t)}catch(i){d.warn("Vibration failed:",i)}}function Re(n=880,e=100){if(!l.getState().settings.sound)return;const i=Dt();if(i){i.state==="suspended"&&i.resume().catch(()=>{}),Bi();try{const r=i.createOscillator(),s=i.createGain();r.connect(s),s.connect(i.destination),r.frequency.value=n,r.type="sine",s.gain.setValueAtTime(.3,i.currentTime),s.gain.exponentialRampToValueAtTime(.01,i.currentTime+e/1e3),r.start(i.currentTime),r.stop(i.currentTime+e/1e3)}catch(r){d.warn("Sound playback failed:",r)}}}function pe(){ee(40),Re(880,100)}function aa(){ee([60,40,60]),Re(440,200)}function Z(){ee(30)}function oa(){ee(10)}function ca(){ee(20)}function Oi(){ee([40,30,40]),Re(330,150)}function la(){ee([35,35]),Re(660,100)}function ua(){Y!==null&&(clearTimeout(Y),Y=null),O&&(O.close().catch(()=>{}),O=null)}async function da(){const n=Dt();if(n&&n.state==="suspended")try{await n.resume()}catch(e){d.warn("Failed to resume audio:",e)}}const zi={enableHighAccuracy:!0,timeout:1e4,maximumAge:3e4},Vi={enableHighAccuracy:!1,timeout:15e3,maximumAge:3e4},ht={enableHighAccuracy:!1,timeout:3e4,maximumAge:12e4},Hi=10,Gi=30;class Ui{constructor(){c(this,"watchId",null);c(this,"lastPosition",null);c(this,"visibilityHandler",null);c(this,"wasActiveBeforeHidden",!1);c(this,"batteryUnsubscribe",null);c(this,"usingLowPowerMode",!1);c(this,"dutyCycleIntervalId",null);c(this,"isDutyCycling",!1);c(this,"pausedByView",!1);c(this,"timeOffset",null)}getGpsOptions(){const e=A.isLowBattery();return this.usingLowPowerMode=e,e?Vi:zi}startDutyCycling(){this.isDutyCycling||(this.isDutyCycling=!0,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),d.debug("[GPS] Starting duty cycling (60s interval)"),this.dutyCycleIntervalId=setInterval(()=>{navigator.geolocation.getCurrentPosition(e=>this.handlePosition(e),e=>this.handleError(e),ht)},6e4),navigator.geolocation.getCurrentPosition(e=>this.handlePosition(e),e=>this.handleError(e),ht))}stopDutyCycling(){this.dutyCycleIntervalId!==null&&(clearInterval(this.dutyCycleIntervalId),this.dutyCycleIntervalId=null),this.isDutyCycling=!1}start(){if(this.watchId!==null||this.isDutyCycling)return!0;if(!navigator.geolocation)return d.error("Geolocation not supported"),l.setGpsStatus("inactive"),!1;this.pausedByView=!1,l.setGpsStatus("searching");try{const e=this.getGpsOptions();return this.watchId=navigator.geolocation.watchPosition(t=>this.handlePosition(t),t=>this.handleError(t),e),this.visibilityHandler||(this.visibilityHandler=()=>{if(document.hidden)this.wasActiveBeforeHidden=this.watchId!==null||this.isDutyCycling,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.wasActiveBeforeHidden&&l.setGpsStatus("inactive");else if(this.wasActiveBeforeHidden&&!this.pausedByView)if(l.setGpsStatus("searching"),A.isCriticalBattery())this.startDutyCycling();else{const t=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(i=>this.handlePosition(i),i=>this.handleError(i),t)}},document.addEventListener("visibilitychange",this.visibilityHandler)),this.batteryUnsubscribe||(this.batteryUnsubscribe=A.subscribe(()=>{if(this.watchId===null&&!this.isDutyCycling)return;const t=A.isCriticalBattery();if(t&&!this.isDutyCycling){d.debug("[GPS] Switching to duty-cycle mode (critical battery)"),this.startDutyCycling();return}if(!t&&this.isDutyCycling){d.debug("[GPS] Resuming continuous GPS from duty-cycle mode"),this.stopDutyCycling();const s=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(a=>this.handlePosition(a),a=>this.handleError(a),s);return}if(this.watchId===null)return;const i=A.isLowBattery();if(i===this.usingLowPowerMode)return;d.debug(`[GPS] Switching to ${i?"low-power":"high-accuracy"} mode`),navigator.geolocation.clearWatch(this.watchId);const r=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(s=>this.handlePosition(s),s=>this.handleError(s),r)})),!0}catch(e){return d.error("Failed to start GPS:",e),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),l.setGpsStatus("inactive"),!1}}pause(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.pausedByView=!0,this.wasActiveBeforeHidden=!1,l.setGpsStatus(this.lastPosition?"paused":"inactive")}resume(){if(this.pausedByView){if(this.pausedByView=!1,document.hidden){this.wasActiveBeforeHidden=!0;return}this.start()}}isPaused(){return this.pausedByView}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasActiveBeforeHidden=!1,this.pausedByView=!1,this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.lastPosition=null,this.timeOffset=null,l.setGpsStatus("inactive")}handlePosition(e){this.lastPosition=e;const t=e.timestamp-Date.now();Math.abs(t)>500&&d.warn(`[GPS] Clock offset ${t}ms - system clock may be inaccurate`),this.timeOffset=t;const i=e.coords.accuracy;l.setGpsStatus("active",i)}handleError(e){d.error("GPS error:",e.message),e.code===e.PERMISSION_DENIED?(l.setGpsStatus("inactive"),this.stop()):l.setGpsStatus("searching")}getPosition(){return this.lastPosition}getCoordinates(){if(this.lastPosition)return{latitude:this.lastPosition.coords.latitude,longitude:this.lastPosition.coords.longitude,accuracy:this.lastPosition.coords.accuracy}}getTimestamp(){var e;return((e=this.lastPosition)==null?void 0:e.timestamp)??null}getTimeOffset(){return this.timeOffset}getAccuracyStatus(){if(!this.lastPosition)return"unknown";const e=this.lastPosition.coords.accuracy;return e<=Hi?"good":e<=Gi?"fair":"poor"}isActive(){return(this.watchId!==null||this.isDutyCycling)&&this.lastPosition!==null}toggle(e){return e?this.start():(this.stop(),!0)}async requestPosition(){return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{this.lastPosition=t,e(t)},()=>e(null),this.getGpsOptions())}):null}}const Ji=new Ui,ji=`You are a voice command processor for a ski race timing app.
Parse the user's spoken command and return a structured JSON response.

Context provided:
- role: "timer" (sets bib/point/run) or "gateJudge" (records faults)
- language: User's language (de/en)
- activeBibs: Racers currently on course (gate judge only)
- gateRange: Gates this judge is watching [start, end]
- pendingConfirmation: If set, user is responding to a confirmation prompt

For TIMER role, recognize:
- Bib numbers: spoken digits or number words (e.g., "forty-five" = 45, "fünfundvierzig" = 45)
- Timing point: "Start" / "Ziel" / "Finish"
- Run selection: "Lauf 1/2", "Run 1/2", "erster Lauf", "zweiter Lauf"
NOTE: Timer role does NOT support recording timestamps via voice (latency too high for timing)

For GATE JUDGE role, recognize:
- Fault recording with bib + gate + type
- Fault types: MG (missed gate/ausgelassen), STR (straddling/eingefädelt), BR (binding release/Bindung offen)
- Ready status: "Bereit", "Ready", "Fertig"
- Confirmation: "Ja", "Yes", "Correct", "Richtig", "Stimmt"
- Cancellation: "Nein", "No", "Cancel", "Abbrechen", "Falsch"

Return ONLY valid JSON (no markdown, no explanation):
{
  "action": "record_fault" | "set_bib" | "set_gate" | "set_point" | "set_run" | "toggle_ready" | "confirm" | "cancel" | "unknown",
  "confidence": 0.0-1.0,
  "params": {
    "bib": "string (3 digits, zero-padded)",
    "gate": number,
    "faultType": "MG" | "STR" | "BR",
    "point": "S" | "F",
    "run": number (positive integer, typically 1 or 2)
  },
  "confirmationNeeded": boolean,
  "confirmationPrompt": "string (spoken confirmation request in user's language)"
}

IMPORTANT:
- For gate judge faults, set confirmationNeeded=true with a clear prompt
- Confirmation prompts should be in the user's language
- If user tries to record time via voice, return action="unknown" (voice timing disabled)
- If unsure, set action="unknown" with low confidence`,qi={model:"claude-3-haiku-20240307",maxTokens:256};function Qi(n){return n.includes("/api/v1/voice")}async function Wi(n,e,t){const{endpoint:i,apiKey:r,model:s,maxTokens:a}={...qi,...t};if(!i)throw new Error("LLM endpoint is required");if(Qi(i))return Yi(n,e,i);if(!r)throw new Error("API key is required for direct LLM calls");return Ki(n,e,i,r,s,a)}async function Yi(n,e,t){try{const i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcript:n,context:e})});if(!i.ok){const s=await i.text();throw d.error("[LLMProvider] Proxy error:",i.status,s),new Error(`Proxy error: ${i.status}`)}const r=await i.json();if(r.success&&r.intent)return d.debug("[LLMProvider] Proxy intent:",r.intent),r.intent;throw new Error("Invalid proxy response")}catch(i){return d.error("[LLMProvider] Proxy processing error:",i),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function Ki(n,e,t,i,r,s){var u;const o=`Context: ${JSON.stringify({role:e.role,language:e.language,currentRun:e.currentRun,activeBibs:e.activeBibs,gateRange:e.gateRange,pendingConfirmation:e.pendingConfirmation?{action:e.pendingConfirmation.action,params:e.pendingConfirmation.params}:null})}

Transcript: "${n}"`;try{const h=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:r,max_tokens:s,system:ji,messages:[{role:"user",content:o}]})});if(!h.ok){const m=await h.text();throw d.error("[LLMProvider] API error:",h.status,m),new Error(`LLM API error: ${h.status}`)}const g=await h.json();let f="";if(g.content&&Array.isArray(g.content)?f=((u=g.content[0])==null?void 0:u.text)||"":typeof g.content=="string"&&(f=g.content),!f)throw new Error("Empty response from LLM");let y=f.trim();y.startsWith("```")&&(y=y.replace(/```json?\n?/g,"").replace(/```$/g,"").trim());const v=JSON.parse(y);if(!v.action||typeof v.confidence!="number")throw new Error("Invalid intent structure");return d.debug("[LLMProvider] Parsed intent:",v),v}catch(h){return d.error("[LLMProvider] Processing error:",h),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function Zi(n,e,t,i=5e3){const r=new Promise((s,a)=>{setTimeout(()=>a(new Error("LLM request timeout")),i)});return Promise.race([Wi(n,e,t),r]).catch(s=>(d.warn("[LLMProvider] Timeout or error:",s),{action:"unknown",confidence:0,confirmationNeeded:!1}))}const Xi="ski-timer-photos",er=1,M="photos",tr=3,nr=5e3;class ir{constructor(){c(this,"db",null);c(this,"initPromise",null);c(this,"saveQueue",[]);c(this,"activeSaves",0)}async initialize(){return this.initPromise?this.initPromise:(this.initPromise=new Promise(e=>{if(!window.indexedDB){d.warn("IndexedDB not supported - photo storage disabled"),e(!1);return}const t=indexedDB.open(Xi,er);t.onerror=()=>{d.error("IndexedDB open error:",t.error),e(!1)},t.onsuccess=()=>{this.db=t.result,e(!0)},t.onupgradeneeded=i=>{const r=i.target.result;r.objectStoreNames.contains(M)||r.createObjectStore(M,{keyPath:"entryId"}).createIndex("timestamp","timestamp",{unique:!1})}}),this.initPromise)}async savePhoto(e,t){return new Promise(i=>{this.saveQueue.push({entryId:e,photoBase64:t,resolve:i}),this.processQueue()})}processQueue(){for(;this.saveQueue.length>0&&this.activeSaves<tr;){const e=this.saveQueue.shift();this.activeSaves++,this.doSavePhotoWithTimeout(e.entryId,e.photoBase64).then(t=>{e.resolve(t)}).catch(()=>{e.resolve(!1)}).finally(()=>{this.activeSaves--,this.processQueue()})}}async doSavePhotoWithTimeout(e,t){return Promise.race([this.doSavePhoto(e,t),new Promise((i,r)=>setTimeout(()=>r(new Error("Photo save timeout")),nr))])}async doSavePhoto(e,t){return!this.db&&!await this.initialize()?!1:new Promise(i=>{if(!this.db){i(!1);return}try{const s=this.db.transaction([M],"readwrite").objectStore(M),a={entryId:e,photo:t,timestamp:Date.now()},o=s.put(a);o.onsuccess=()=>{i(!0)},o.onerror=()=>{d.error("Photo save error:",o.error),i(!1)}}catch(r){d.error("Photo save transaction error:",r),i(!1)}})}async getPhoto(e){return!this.db&&!await this.initialize()?null:new Promise(t=>{if(!this.db){t(null);return}try{const s=this.db.transaction([M],"readonly").objectStore(M).get(e);s.onsuccess=()=>{const a=s.result;t((a==null?void 0:a.photo)||null)},s.onerror=()=>{d.error("Photo get error:",s.error),t(null)}}catch(i){d.error("Photo get transaction error:",i),t(null)}})}async deletePhoto(e){return!this.db&&!await this.initialize()?!1:new Promise(t=>{if(!this.db){t(!1);return}try{const s=this.db.transaction([M],"readwrite").objectStore(M).delete(e);s.onsuccess=()=>{t(!0)},s.onerror=()=>{d.error("Photo delete error:",s.error),t(!1)}}catch(i){d.error("Photo delete transaction error:",i),t(!1)}})}async hasPhoto(e){return await this.getPhoto(e)!==null}async clearAll(){return!this.db&&!await this.initialize()?!1:new Promise(e=>{if(!this.db){e(!1);return}try{const r=this.db.transaction([M],"readwrite").objectStore(M).clear();r.onsuccess=()=>{e(!0)},r.onerror=()=>{d.error("Photo clear error:",r.error),e(!1)}}catch(t){d.error("Photo clear transaction error:",t),e(!1)}})}async deletePhotos(e){for(const t of e)await this.deletePhoto(t)}async getStorageUsage(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{used:e.usage||0,quota:e.quota||0}}catch{return null}return null}async getPhotoCount(){return!this.db&&!await this.initialize()?0:new Promise(e=>{if(!this.db){e(0);return}try{const r=this.db.transaction([M],"readonly").objectStore(M).count();r.onsuccess=()=>{e(r.result)},r.onerror=()=>{e(0)}}catch{e(0)}})}close(){this.db&&(this.db.close(),this.db=null,this.initPromise=null)}}const he=new ir;class rr{constructor(){c(this,"synth",null);c(this,"voice",null);c(this,"voicesLoaded",!1);typeof window<"u"&&"speechSynthesis"in window&&(this.synth=window.speechSynthesis,this.loadVoices())}isSupported(){return this.synth!==null}loadVoices(){if(!this.synth)return;this.synth.getVoices().length>0?(this.voicesLoaded=!0,this.selectVoiceForLanguage(l.getState().currentLang)):this.synth.addEventListener("voiceschanged",()=>{this.voicesLoaded=!0,this.selectVoiceForLanguage(l.getState().currentLang)},{once:!0})}selectVoiceForLanguage(e){if(!this.synth)return;const t=this.synth.getVoices(),i=e;this.voice=t.find(r=>r.lang.startsWith(i)&&r.name.toLowerCase().includes("female"))||t.find(r=>r.lang.startsWith(i))||t.find(r=>r.lang.startsWith("en"))||null,this.voice&&d.debug("[SpeechSynthesis] Selected voice:",this.voice.name,this.voice.lang)}setLanguage(e){this.voicesLoaded&&this.selectVoiceForLanguage(e)}speak(e,t){return new Promise((i,r)=>{if(!this.synth){r(new Error("Speech synthesis not supported"));return}this.synth.cancel();const s=new SpeechSynthesisUtterance(e);this.voice&&(s.voice=this.voice),s.rate=(t==null?void 0:t.rate)??1.1,s.pitch=(t==null?void 0:t.pitch)??1,s.volume=1,s.onend=()=>i(),s.onerror=a=>{a.error==="interrupted"?i():(d.warn("[SpeechSynthesis] Error:",a.error),r(new Error(a.error)))},this.synth.speak(s)})}sayOK(){return this.speak("OK",{rate:1.2})}sayRecorded(){const e=l.getState().currentLang;return this.speak(p("voiceRecorded",e),{rate:1.1})}sayNotUnderstood(){const e=l.getState().currentLang;return this.speak(p("voiceNotUnderstood",e),{rate:1})}cancel(){var e;(e=this.synth)==null||e.cancel()}}const U=new rr,x={CRITICAL:"critical",ERROR:"error",WARNING:"warning",INFO:"info"},gt={CRITICAL:8e3,ERROR:5e3,WARNING:4e3,INFO:3e3};function sr(n){return`[${n.component}] ${n.operation}`}function ar(n){return n instanceof Error?n.message:typeof n=="string"?n:"Unknown error"}function Ue(n){const e=sr(n),t=n.error?ar(n.error):"No error details",i={code:n.code,message:t,timestamp:new Date().toISOString(),...n.metadata};switch(n.severity){case x.CRITICAL:case x.ERROR:console.error(`${e}:`,t,i);break;case x.WARNING:console.warn(`${e}:`,t,i);break;case x.INFO:console.log(`${e}:`,t,i);break}if(n.userMessageKey){const r=l.getState().currentLang,s=p(n.userMessageKey,r),a=or(n.severity),o=gt[n.severity.toUpperCase()]||gt.ERROR;L(s,a,o)}n.severity===x.CRITICAL&&window.dispatchEvent(new CustomEvent("critical-error",{detail:n}))}function or(n){switch(n){case x.CRITICAL:case x.ERROR:return"error";case x.WARNING:return"warning";case x.INFO:return"info";default:return"error"}}function ha(n,e,t,i){Ue({component:n,operation:e,severity:x.ERROR,error:t,userMessageKey:i})}function ga(n,e,t,i){Ue({component:n,operation:e,severity:x.WARNING,error:t,userMessageKey:i})}function fa(n,e,t,i){Ue({component:n,operation:e,severity:x.CRITICAL,error:t,userMessageKey:i})}const cr=1e4;class lr extends Error{constructor(e,t){super(`Request to ${e} timed out after ${t}ms`),this.name="FetchTimeoutError"}}async function z(n,e={},t=cr){const i=new AbortController,r=setTimeout(()=>i.abort(),t);try{return await fetch(n,{...e,signal:i.signal})}catch(s){throw s instanceof Error&&s.name==="AbortError"?new lr(n,t):s}finally{clearTimeout(r)}}const ke="skiTimerAuthToken";function V(){const n=b.getRaw(ke);return n?{Authorization:`Bearer ${n}`}:{}}function pa(){const n=b.getRaw(ke);if(!n)return!1;try{const e=n.split(".");if(e.length===3){const t=JSON.parse(atob(e[1]));if(t.exp&&t.exp*1e3<Date.now())return!1}}catch{}return!0}function ur(n){b.setRaw(ke,n),b.flush()}function dr(){b.remove(ke),b.flush()}const hr=1e4;async function ma(n,e){const t=new AbortController,i=setTimeout(()=>t.abort(),hr);try{const r=await fetch("/api/v1/auth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:n,role:e}),signal:t.signal});clearTimeout(i);const s=await r.json();return r.ok?s.token?(ur(s.token),{success:!0,token:s.token,isNewPin:s.isNewPin}):{success:!1,error:"No token received"}:{success:!1,error:s.error||"Authentication failed"}}catch(r){return clearTimeout(i),r instanceof Error&&r.name==="AbortError"?(d.error("Token exchange timeout"),{success:!1,error:"Request timeout"}):(d.error("Token exchange error:",r),{success:!1,error:"Network error"})}}function gr(n="Session expired. Please re-enter your PIN."){window.dispatchEvent(new CustomEvent("auth-expired",{detail:{message:n}}))}class fr{constructor(){c(this,"broadcastChannel",null)}initialize(e){if(typeof BroadcastChannel>"u"){d.info("BroadcastChannel not supported - cross-tab sync disabled (graceful degradation)");return}try{this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(`ski-timer-${e}`),this.broadcastChannel.onmessage=t=>{try{const{type:i,data:r}=t.data||{};if(i==="entry"&&le(r))l.mergeCloudEntries([r]);else if(i==="presence")r&&typeof r.id=="string"&&typeof r.name=="string"&&typeof r.lastSeen=="number"&&l.addConnectedDevice(r);else if(i==="fault"){const s=r;s!=null&&s.id&&l.mergeFaultsFromCloud([s])}else if(i==="fault-deleted"){const s=r;s&&l.markFaultForDeletion(s)}}catch(i){d.error("Error processing broadcast message:",i)}}}catch(t){d.warn("BroadcastChannel initialization failed:",t)}}broadcastEntry(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"entry",data:e})}catch(t){d.error("Broadcast error:",t)}}broadcastPresence(){const e=l.getState();if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"presence",data:{id:e.deviceId,name:e.deviceName,lastSeen:Date.now()}})}catch(t){d.error("Presence broadcast error:",t)}}broadcastFault(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"fault",data:e})}catch(t){d.error("Fault broadcast error:",t)}}broadcastFaultDeletion(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"fault-deleted",data:e})}catch(t){d.error("Fault deletion broadcast error:",t)}}cleanup(){if(this.broadcastChannel){try{this.broadcastChannel.close()}catch{}this.broadcastChannel=null}}}const se=new fr,pr={en:"en-US",de:"de-DE",fr:"fr-FR"};function q(n){return pr[n]}function mr(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),i=String(n.getSeconds()).padStart(2,"0"),r=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${i}.${r}`}function yr(n,e="de"){const t={weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"};return n.toLocaleDateString(q(e),t)}function ya(n,e=3){return String(n).padStart(e,"0")}function D(n){const e=document.createElement("div");return e.textContent=String(n),e.innerHTML}function I(n){return D(n).replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function va(n){return{S:"var(--start-color)",F:"var(--finish-color)"}[n]||"var(--text-secondary)"}function vr(n,e="de"){return{en:{S:"Start",F:"Finish"},de:{S:"Start",F:"Ziel"},fr:{S:"Départ",F:"Arrivée"}}[e][n]}const br={de:"L",en:"R",fr:"M"};function ba(n,e="de"){return`${br[e]}${n}`}function Sa(n){return n===1?"var(--primary)":n===2?"var(--warning)":"var(--text-secondary)"}function Je(n,e){return{MG:p("faultMGShort",e),STR:p("faultSTRShort",e),BR:p("faultBRShort",e)}[n]||n}function wa(n){return n<1024?`${n} B`:n<1024*1024?`${(n/1024).toFixed(1)} KB`:`${(n/(1024*1024)).toFixed(1)} MB`}function Ea(n,e){let t;return(...i)=>{clearTimeout(t),t=setTimeout(()=>n(...i),e)}}const Pt="skiTimerRecentRaces",Sr=50;function Lt(){try{return b.get(Pt)??[]}catch{return[]}}function wr(n,e,t){try{const i=Lt(),r=n.toLowerCase(),s=i.findIndex(o=>o.raceId.toLowerCase()===r);s>=0?(i[s].lastUpdated=e,t!==void 0&&(i[s].entryCount=t)):i.unshift({raceId:n,createdAt:Date.now(),lastUpdated:e,entryCount:t}),i.sort((o,u)=>u.lastUpdated-o.lastUpdated);const a=i.slice(0,Sr);b.set(Pt,a)}catch(i){d.error("Failed to save recent race:",i)}}function Ia(n=5){const e=Lt(),t=new Date;t.setHours(0,0,0,0);const i=t.getTime();return e.filter(r=>r.createdAt>=i||r.lastUpdated>=i).slice(0,n)}const ce="/api/v1/sync",je="/api/v1/faults",Ft=15e3,ft=3e4,Er=5,Ir=2e3,Tr=1e4,Q=8e3,Nt=10,Cr=[15e3,2e4,3e4,45e3,6e4],Mt=6,pt=[2e4,3e4,45e3,6e4,9e4],Rr=4,mt=[3e4,45e3,6e4,9e4,12e4],yt=[3e4,6e4],vt=3,bt=3e5,kr=[3e4,45e3,6e4,9e4,12e4],Ar=3e4,Dr=3e4,St=6e4,wt=3e4,Pr={normal:{intervals:Cr,threshold:Mt,baseInterval:Ft},medium:{intervals:pt,threshold:Rr,baseInterval:pt[0]},low:{intervals:mt,threshold:vt,baseInterval:mt[0]},critical:{intervals:yt,threshold:vt,baseInterval:yt[0]}};function Lr(n){const e=n instanceof Error?n.message:"";return(n instanceof Error?n.name:"")==="FetchTimeoutError"||e.includes("timed out")||e.includes("500")||e.includes("503")?"error":e.includes("Failed to fetch")||e.includes("NetworkError")?"offline":"error"}let S=null,ae=0,re=null;function Fr(n){S=n}function Nr(){return ae}async function Mr(n){const e=l.getState(),t=[];for(const i of n)if(Ve(i.photo))if(e.settings.syncPhotos){if(await he.hasPhoto(i.id)){t.push({...i,photo:"indexeddb"});continue}await he.savePhoto(i.id,i.photo)?t.push({...i,photo:"indexeddb"}):(d.warn("Sync: Photo storage failed for entry:",i.id),t.push({...i,photo:void 0}))}else t.push({...i,photo:void 0});else t.push(i);return t}async function Et(){const n=l.getState();if(!(!n.settings.sync||!n.raceId)){if(re)return re;re=xr();try{await re}finally{re=null}}}async function xr(){const n=l.getState(),e=n.syncStatus;(e==="connected"||e==="connecting")&&l.setSyncStatus("syncing");try{const t=new URLSearchParams({raceId:n.raceId,deviceId:n.deviceId,deviceName:n.deviceName});ae>0&&t.set("since",String(ae));const i=await z(`${ce}?${t}`,{headers:{"Accept-Encoding":"gzip, deflate",...V()}},Q);if(i.status===401){let h={};try{h=await i.json()}catch{h={}}if(h.expired){dr(),l.setSyncStatus("disconnected"),gr(),S==null||S.onCleanup();return}throw new Error(`HTTP ${i.status}: ${h.error||"Unauthorized"}`)}if(!i.ok)throw new Error(`HTTP ${i.status}`);let r;try{r=await i.json()}catch{throw new Error("Invalid response format")}if(!r||typeof r!="object")throw new Error("Invalid data structure");if(r.deleted){window.dispatchEvent(new CustomEvent("race-deleted",{detail:{raceId:n.raceId,deletedAt:r.deletedAt,message:r.message}})),S==null||S.onCleanup();return}const a=(Array.isArray(r.entries)?r.entries:[]).filter(h=>le(h)?!0:(d.warn("Skipping invalid entry from cloud:",h),!1)),o=Array.isArray(r.deletedIds)?r.deletedIds.filter(h=>typeof h=="string"&&h.length>0):[];l.setSyncStatus("connected"),typeof r.deviceCount=="number"&&l.setCloudDeviceCount(r.deviceCount),typeof r.highestBib=="number"&&l.setCloudHighestBib(r.highestBib);let u=!1;if(o.length>0&&(l.removeDeletedCloudEntries(o),u=!0),a.length>0){const h=await Mr(a),g=l.mergeCloudEntries(h,o);if(g>0){u=!0;const f=l.getState().currentLang;S==null||S.showToast(p("syncedEntriesFromCloud",f).replace("{count}",String(g)))}}ae=r.lastUpdated||Date.now(),n.raceId&&wr(n.raceId,ae,a.length),await(S==null?void 0:S.fetchFaults()),S==null||S.onPollingAdjust(!0,u)}catch(t){d.error("Cloud sync fetch error:",t),l.setSyncStatus(Lr(t)),S==null||S.onPollingAdjust(!1)}}async function $r(n,e){const t=l.getState();if(!t.settings.sync||!t.raceId)return!1;try{const i=await z(`${ce}?raceId=${encodeURIComponent(t.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...V()},body:JSON.stringify({entryId:n,deviceId:e||t.deviceId,deviceName:t.deviceName})},Q);if(!i.ok)throw new Error(`HTTP ${i.status}`);return!0}catch(i){return d.error("Cloud sync delete error:",i),!1}}async function Ne(n){const e=l.getState();if(!e.settings.sync||!e.raceId)return!1;try{let t={...n};if(e.settings.syncPhotos&&ze(n.photo)){const r=await he.getPhoto(n.id);r?t={...n,photo:r}:t={...n,photo:void 0}}else n.photo&&(t={...n,photo:void 0});const i=await z(`${ce}?raceId=${encodeURIComponent(e.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...V()},body:JSON.stringify({entry:t,deviceId:e.deviceId,deviceName:e.deviceName})},Q);if(!i.ok)throw new Error(`HTTP ${i.status}`);try{const r=await i.json(),s=l.getState().currentLang;if(r.photoSkipped&&(S==null||S.showToast(p("photoTooLarge",s),"warning")),r.crossDeviceDuplicate){const a=r.crossDeviceDuplicate,o=vr(a.point,s);S==null||S.showToast(p("crossDeviceDuplicate",s).replace("{bib}",a.bib).replace("{point}",o).replace("{device}",a.deviceName),"warning",5e3),window.dispatchEvent(new CustomEvent("cross-device-duplicate",{detail:a}))}typeof r.deviceCount=="number"&&l.setCloudDeviceCount(r.deviceCount),typeof r.highestBib=="number"&&l.setCloudHighestBib(r.highestBib)}catch(r){d.warn("Failed to parse send response body:",r)}return l.removeFromSyncQueue(n.id),S==null||S.onResetFastPolling(),!0}catch(t){return d.error("Cloud sync send error:",t),!1}}async function Br(n){const e=new Map,t=l.getState();if(!t.settings.sync||!t.raceId||n.length===0){for(const r of n)e.set(r.id,!1);return e}const i=n.slice(0,Nt);try{const r=[];for(const o of i){let u={...o};if(t.settings.syncPhotos&&ze(o.photo)){const h=await he.getPhoto(o.id);h?u={...o,photo:h}:u={...o,photo:void 0}}else o.photo&&(u={...o,photo:void 0});r.push(u)}const s=await z(`${ce}?raceId=${encodeURIComponent(t.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...V()},body:JSON.stringify({entries:r,deviceId:t.deviceId,deviceName:t.deviceName})},Q);if(!s.ok)throw new Error(`HTTP ${s.status}`);const a=await s.json();if(Array.isArray(a.results))for(const o of a.results)e.set(String(o.entryId),o.success===!0);for(const o of i)e.get(o.id)===!0&&l.removeFromSyncQueue(o.id);return typeof a.deviceCount=="number"&&l.setCloudDeviceCount(a.deviceCount),typeof a.highestBib=="number"&&l.setCloudHighestBib(a.highestBib),S==null||S.onResetFastPolling(),e}catch(r){d.error("Cloud sync batch send error:",r);for(const s of i)e.set(s.id,!1);return e}}async function _r(){const n=l.getState();if(!(!n.settings.sync||!n.raceId))for(const e of n.entries)e.deviceId===n.deviceId&&!e.syncedAt&&await Ne(e)}function Or(){S=null,ae=0,re=null}let j=null,qe=[];function zr(n){j=n}function Vr(n){const e=l.getState();qe=n.filter(t=>t.deviceId!==e.deviceId)}function Hr(){return qe}async function Gr(){const n=l.getState();if(!(!n.settings.sync||!n.raceId))try{const e=new URLSearchParams({raceId:n.raceId,deviceId:n.deviceId,deviceName:n.deviceName});n.deviceRole==="gateJudge"&&n.gateAssignment&&(e.set("gateStart",String(n.gateAssignment[0])),e.set("gateEnd",String(n.gateAssignment[1])),e.set("isReady",String(n.isJudgeReady)),e.set("firstGateColor",n.firstGateColor));const t=await z(`${je}?${e}`,{headers:{"Accept-Encoding":"gzip, deflate",...V()}},Q);if(!t.ok){if(t.status===401)return;throw new Error(`HTTP ${t.status}`)}const i=await t.json();if(!i||typeof i!="object")throw new Error("Invalid fault data structure");const r=Array.isArray(i.faults)?i.faults:[],s=Array.isArray(i.deletedIds)?i.deletedIds.filter(a=>typeof a=="string"):[];if(s.length>0&&l.removeDeletedCloudFaults(s),r.length>0){const a=l.mergeFaultsFromCloud(r,s);if(a>0){const o=l.getState().currentLang;j==null||j.showToast(p("syncedFaultsFromCloud",o).replace("{count}",String(a)))}}Array.isArray(i.gateAssignments)&&Vr(i.gateAssignments)}catch(e){d.error("Fault sync fetch error:",e),window.dispatchEvent(new CustomEvent("fault-sync-error",{detail:{error:e instanceof Error?e.message:"Unknown error"}}))}}async function xt(n){const e=l.getState();if(!e.settings.sync||!e.raceId)return!1;try{const t=await z(`${je}?raceId=${encodeURIComponent(e.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...V()},body:JSON.stringify({fault:n,deviceId:e.deviceId,deviceName:e.deviceName,gateRange:e.gateAssignment,isReady:e.isJudgeReady,firstGateColor:e.firstGateColor})},Q);if(!t.ok)throw new Error(`HTTP ${t.status}`);return l.markFaultSynced(n.id),j==null||j.onResetFastPolling(),!0}catch(t){return d.error("Fault sync send error:",t),!1}}async function Ur(n,e,t){const i=l.getState();if(!i.settings.sync||!i.raceId)return!1;try{const r=await z(`${je}?raceId=${encodeURIComponent(i.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...V()},body:JSON.stringify({faultId:n,deviceId:e||i.deviceId,deviceName:i.deviceName,approvedBy:t||i.deviceName})},Q);if(!r.ok)throw new Error(`HTTP ${r.status}`);return!0}catch(r){return d.error("Fault sync delete error:",r),!1}}async function Jr(){const n=l.getState();if(!(!n.settings.sync||!n.raceId))for(const e of n.faultEntries)e.deviceId===n.deviceId&&!e.syncedAt&&await xt(e)}function jr(){j=null,qe=[]}class qr{constructor(){c(this,"isMetered",!1);c(this,"currentQuality","good");c(this,"networkChangeHandler",null);c(this,"onlineHandler",null);c(this,"offlineHandler",null);c(this,"changeListeners",new Set);c(this,"qualityListeners",new Set)}getConnection(){return navigator.connection}initialize(){this.currentQuality=navigator.onLine?"good":"offline";const e=this.getConnection();e&&(this.updateNetworkState(e),this.networkChangeHandler||(this.networkChangeHandler=()=>{const t=this.isMetered,i=this.currentQuality;this.updateNetworkState(e),t!==this.isMetered&&this.notifyListeners(),i!==this.currentQuality&&this.notifyQualityListeners()},e.addEventListener("change",this.networkChangeHandler)))}updateNetworkState(e){this.isMetered=e.saveData===!0||e.type==="cellular"||e.effectiveType==="slow-2g"||e.effectiveType==="2g",this.currentQuality=this.detectConnectionQuality(e)}detectConnectionQuality(e){return navigator.onLine?e&&(e.effectiveType==="2g"||e.effectiveType==="slow-2g"||e.saveData)?"slow":"good":"offline"}isMeteredConnection(){return this.isMetered}getConnectionQuality(){return this.currentQuality}onMeteredChange(e){return this.changeListeners.add(e),()=>{this.changeListeners.delete(e)}}onQualityChange(e){return this.qualityListeners.add(e),()=>{this.qualityListeners.delete(e)}}notifyListeners(){for(const e of this.changeListeners)e(this.isMetered)}notifyQualityListeners(){for(const e of this.qualityListeners)e(this.currentQuality)}registerOnlineHandlers(e,t){this.onlineHandler=()=>{const i=this.currentQuality,r=this.getConnection();this.currentQuality=this.detectConnectionQuality(r),i!==this.currentQuality&&this.notifyQualityListeners(),e()},this.offlineHandler=()=>{const i=this.currentQuality;this.currentQuality="offline",i!==this.currentQuality&&this.notifyQualityListeners(),t()},window.addEventListener("online",this.onlineHandler),window.addEventListener("offline",this.offlineHandler)}cleanup(){const e=this.getConnection();this.networkChangeHandler&&e&&(e.removeEventListener("change",this.networkChangeHandler),this.networkChangeHandler=null),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.offlineHandler&&(window.removeEventListener("offline",this.offlineHandler),this.offlineHandler=null),this.changeListeners.clear(),this.qualityListeners.clear()}}const K=new qr;class Qr{constructor(){c(this,"pollInterval",null);c(this,"consecutiveErrors",0);c(this,"consecutiveNoChanges",0);c(this,"currentIdleLevel",0);c(this,"currentBatteryLevel","normal");c(this,"currentBatteryRawLevel",1);c(this,"currentConnectionQuality","good");c(this,"isTabHidden",!1);c(this,"batteryUnsubscribe",null);c(this,"meteredUnsubscribe",null);c(this,"qualityUnsubscribe",null);c(this,"isAdjustingInterval",!1);c(this,"currentPollingIntervalMs",0);c(this,"pollCallback",null)}initialize(e){this.pollCallback=e,this.batteryUnsubscribe=A.subscribe(t=>{const i=this.currentBatteryLevel,r=this.currentBatteryRawLevel;this.currentBatteryLevel=t.batteryLevel,this.currentBatteryRawLevel=t.level;const s=r>=.05&&t.level<.05||r<.05&&t.level>=.05;(i!==t.batteryLevel||s)&&this.pollInterval&&this.applyBatteryAwarePolling()}),this.meteredUnsubscribe=K.onMeteredChange(()=>{this.pollInterval&&this.applyBatteryAwarePolling()}),this.currentConnectionQuality=K.getConnectionQuality(),this.qualityUnsubscribe=K.onQualityChange(t=>{const i=this.currentConnectionQuality;this.currentConnectionQuality=t,i!==t&&this.pollInterval&&this.applyBatteryAwarePolling()})}start(){this.currentPollingIntervalMs=0,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.pollCallback&&this.pollCallback();const e=this.consecutiveErrors>2?ft:Ft;this.setPollingInterval(e)}stop(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.currentPollingIntervalMs=0}isPolling(){return this.pollInterval!==null}getPollingConfig(){const e=K.isMeteredConnection();return this.currentConnectionQuality==="offline"?{intervals:[St],threshold:1,baseInterval:St}:this.isTabHidden?{intervals:[wt],threshold:1,baseInterval:wt}:this.currentBatteryRawLevel<.05&&!A.isCharging()?{intervals:[bt],threshold:1,baseInterval:bt}:this.currentConnectionQuality==="slow"||e?{intervals:kr,threshold:Mt,baseInterval:this.currentConnectionQuality==="slow"?Dr:Ar}:Pr[this.currentBatteryLevel]}setPollingInterval(e){this.currentPollingIntervalMs===e&&this.pollInterval||(this.pollInterval&&clearInterval(this.pollInterval),this.currentPollingIntervalMs=e,this.pollCallback&&(this.pollInterval=setInterval(this.pollCallback,e)))}applyBatteryAwarePolling(){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{const e=this.getPollingConfig();if(!e.intervals||e.intervals.length===0){this.setPollingInterval(e.baseInterval);return}this.currentIdleLevel=Math.min(Math.max(0,this.currentIdleLevel),e.intervals.length-1);const t=this.consecutiveNoChanges<e.threshold?e.baseInterval:e.intervals[this.currentIdleLevel];this.setPollingInterval(t)}finally{this.isAdjustingInterval=!1}}}adjustPollingInterval(e,t=!1){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{if(!e){this.consecutiveErrors++,this.consecutiveErrors>2&&this.pollInterval&&this.setPollingInterval(ft);return}this.consecutiveErrors=0;const i=this.getPollingConfig();if(!i.intervals||i.intervals.length===0){this.pollInterval&&this.setPollingInterval(i.baseInterval);return}if(t)this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval&&this.setPollingInterval(i.baseInterval);else if(this.consecutiveNoChanges++,this.consecutiveNoChanges>=i.threshold){const r=Math.min(Math.max(0,this.currentIdleLevel+1),i.intervals.length-1);r!==this.currentIdleLevel&&(this.currentIdleLevel=r,this.pollInterval&&this.setPollingInterval(i.intervals[this.currentIdleLevel]))}}finally{this.isAdjustingInterval=!1}}}resetToFastPolling(){if(this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval){const e=this.getPollingConfig();this.setPollingInterval(e.baseInterval)}}setTabHidden(e){this.isTabHidden!==e&&(this.isTabHidden=e,this.pollInterval&&(e?this.applyBatteryAwarePolling():(this.pollCallback&&this.pollCallback(),this.applyBatteryAwarePolling())))}cleanup(){this.stop(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.meteredUnsubscribe&&(this.meteredUnsubscribe(),this.meteredUnsubscribe=null),this.qualityUnsubscribe&&(this.qualityUnsubscribe(),this.qualityUnsubscribe=null),this.pollCallback=null,this.consecutiveErrors=0,this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.isTabHidden=!1,this.currentConnectionQuality="good"}}const B=new Qr;class Wr{constructor(){c(this,"queueInterval",null);c(this,"isProcessingQueue",!1);c(this,"sendEntryCallback",null);c(this,"sendBatchCallback",null)}initialize(e){this.sendEntryCallback=e}initializeBatch(e){this.sendBatchCallback=e}start(){this.queueInterval&&clearInterval(this.queueInterval),this.queueInterval=setInterval(()=>this.processQueue(),Tr)}stop(){this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null)}isProcessing(){return this.queueInterval!==null}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{const e=l.getState();if(!e.settings.sync||!e.raceId||e.syncQueue.length===0)return;if(!this.sendEntryCallback){d.warn("Queue processor: No send callback configured");return}const t=Date.now(),i=[],r=[];for(const s of e.syncQueue){if(s.retryCount>=Er){d.warn("Max retries exceeded for entry:",s.entry.id),r.push(s.entry.id);continue}const a=Ir*2**s.retryCount;if(!(t-s.lastAttempt<a)&&(i.push({entry:s.entry,retryCount:s.retryCount}),i.length>=Nt))break}for(const s of r)l.removeFromSyncQueue(s);if(i.length===0)return;if(i.length>=2&&this.sendBatchCallback){const s=i.map(o=>o.entry),a=await this.sendBatchCallback(s);for(const o of i)a.get(o.entry.id)!==!0&&l.updateSyncQueueItem(o.entry.id,{retryCount:o.retryCount+1,lastAttempt:t,error:"Failed to sync"})}else for(const s of i)await this.sendEntryCallback(s.entry)||l.updateSyncQueueItem(s.entry.id,{retryCount:s.retryCount+1,lastAttempt:t,error:"Failed to sync"})}finally{this.isProcessingQueue=!1}}}getQueueLength(){return l.getState().syncQueue.length}cleanup(){this.stop(),this.sendEntryCallback=null,this.sendBatchCallback=null}}const J=new Wr;class Yr{constructor(){c(this,"visibilityHandler",null);c(this,"wasQueueProcessingBeforeHidden",!1)}initialize(){const e=l.getState();if(!e.settings.sync||!e.raceId){this.cleanup();return}this.initializeModules(),se.initialize(e.raceId),K.initialize(),B.start(),J.start();try{_r()}catch(t){d.error("Failed to push local entries during sync init:",t)}try{Jr()}catch(t){d.error("Failed to push local faults during sync init:",t)}this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(B.setTabHidden(!0),this.wasQueueProcessingBeforeHidden=J.isProcessing(),J.stop()):(B.setTabHidden(!1),this.wasQueueProcessingBeforeHidden&&J.start())},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.visibilityHandler()),A.initialize(),K.registerOnlineHandlers(()=>{l.getState().syncStatus==="offline"&&(l.setSyncStatus("connecting"),B.start())},()=>{l.setSyncStatus("offline")}),navigator.onLine?l.setSyncStatus("connecting"):l.setSyncStatus("offline")}initializeModules(){B.initialize(()=>{Et()}),J.initialize(Ne),J.initializeBatch(Br),Fr({onPollingAdjust:(e,t)=>{B.adjustPollingInterval(e,t)},onResetFastPolling:()=>{B.resetToFastPolling()},onCleanup:()=>this.cleanup(),showToast:(e,t,i)=>this.showSyncToast(e,t,i),fetchFaults:()=>Gr()}),zr({onResetFastPolling:()=>{B.resetToFastPolling()},showToast:(e,t,i)=>this.showSyncToast(e,t,i)})}showSyncToast(e,t="success",i){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:e,type:t,duration:i}}))}cleanup(){B.cleanup(),J.cleanup(),se.cleanup(),K.cleanup(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasQueueProcessingBeforeHidden=!1,Or(),jr(),l.setSyncStatus("disconnected")}async forceRefresh(){await Et()}getQueueLength(){return J.getQueueLength()}getLastSyncTime(){return Nr()}broadcastEntry(e){se.broadcastEntry(e)}broadcastPresence(){se.broadcastPresence()}resetToFastPolling(){B.resetToFastPolling()}sendEntryToCloud(e){return Ne(e)}deleteEntryFromCloud(e,t){return $r(e,t)}sendFaultToCloud(e){return xt(e)}async deleteFaultFromCloud(e,t,i){return Ur(e,t,i)}getOtherGateAssignments(){return Hr()}async checkRaceExists(e){if(!e)return{exists:!1,entryCount:0};try{const t=await z(`${ce}?raceId=${encodeURIComponent(e)}&checkOnly=true`,{headers:{"Accept-Encoding":"gzip, deflate",...V()}},5e3);if(!t.ok)return{exists:!1,entryCount:0};const i=await t.json();return{exists:i.exists===!0,entryCount:typeof i.entryCount=="number"?i.entryCount:0}}catch(t){return d.error("Check race exists error:",t),{exists:!1,entryCount:0}}}async getPhotoSyncStats(){const e=l.getState();let t=0,i=0,r=0,s=0;for(const a of e.entries)if(ze(a.photo)&&a.deviceId===e.deviceId){const o=await he.getPhoto(a.id);o&&(t++,i+=o.length)}if(e.settings.sync&&e.raceId)try{const a=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),o=await z(`${ce}?${a}`,{headers:{"Accept-Encoding":"gzip, deflate",...V()}},Q);if(o.ok){const u=await o.json(),h=Array.isArray(u.entries)?u.entries:[];for(const g of h)if(Ve(g.photo)&&g.deviceId!==e.deviceId){const f=e.entries.find(y=>y.id===g.id&&y.deviceId===g.deviceId);(!f||!f.photo)&&(r++,s+=g.photo.length)}}}catch(a){d.warn("Failed to fetch cloud entries for photo stats:",a)}return{uploadCount:t,uploadSize:i,downloadCount:r,downloadSize:s,totalSize:i+s}}}const ge=new Yr;async function Ta(n){const e=l.getState();ge.broadcastEntry(n),e.settings.sync&&e.raceId&&(await ge.sendEntryToCloud(n)||l.addToSyncQueue(n))}async function Kr(n){const e=l.getState();se.broadcastFault(n),e.settings.sync&&e.raceId&&await ge.sendFaultToCloud(n)}async function Zr(n){const e=l.getState();return se.broadcastFaultDeletion(n.id),e.settings.sync&&e.raceId?ge.deleteFaultFromCloud(n.id,n.deviceId,n.markedForDeletionBy):!0}class Xr{constructor(){c(this,"recognition",null);c(this,"llmConfig",null);c(this,"isEnabled",!1);c(this,"isPaused",!1);c(this,"isOnline",typeof navigator<"u"?navigator.onLine:!0);c(this,"pendingIntent",null);c(this,"status","inactive");c(this,"confirmationTimeout",null);c(this,"restartTimeout",null);c(this,"stateCallbacks",new Set);c(this,"actionCallbacks",new Set);c(this,"CONFIRMATION_TIMEOUT_MS",1e4);c(this,"LLM_TIMEOUT_MS",5e3);c(this,"RESTART_DELAY_MS",500);c(this,"handleOnline",()=>{var e;if(this.isOnline=!0,this.isEnabled){this.setStatus("listening");try{(e=this.recognition)==null||e.start()}catch{}}});c(this,"handleOffline",()=>{var e;this.isOnline=!1,this.isEnabled&&(this.setStatus("offline"),(e=this.recognition)==null||e.stop())})}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(e){if(!this.isSupported())return d.warn("[Voice] Speech Recognition not supported"),!1;if(!U.isSupported())return d.warn("[Voice] Speech Synthesis not supported"),!1;this.llmConfig=e;const t=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new t,this.recognition.continuous=!0,this.recognition.interimResults=!1,this.updateRecognitionLanguage(),this.setupRecognitionHandlers(),window.addEventListener("online",this.handleOnline),window.addEventListener("offline",this.handleOffline),d.debug("[Voice] Initialized successfully"),!0}updateRecognitionLanguage(){if(!this.recognition)return;const e=l.getState().currentLang;this.recognition.lang=q(e),U.setLanguage(e)}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{d.debug("[Voice] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{const t=e.results[e.resultIndex];if(t.isFinal){const i=t[0].transcript.trim();d.debug("[Voice] Transcript:",i),this.processTranscript(i)}},this.recognition.onerror=e=>{switch(d.warn("[Voice] Recognition error:",e.error),e.error){case"network":this.setStatus("offline");break;case"not-allowed":case"service-not-allowed":this.setStatus("error"),this.disable();break;case"no-speech":case"audio-capture":break;case"aborted":return;default:this.setStatus("error")}},this.recognition.onend=()=>{d.debug("[Voice] Recognition ended"),this.isEnabled&&this.isOnline&&!this.isPaused&&this.status!=="error"&&this.scheduleRestart()})}scheduleRestart(){this.restartTimeout&&clearTimeout(this.restartTimeout),this.restartTimeout=setTimeout(()=>{var e;if(this.isEnabled&&this.isOnline&&!this.isPaused)try{(e=this.recognition)==null||e.start()}catch{}},this.RESTART_DELAY_MS)}async processTranscript(e){if(!e||!this.llmConfig)return;this.setStatus("processing");const t=l.getState(),i={role:t.deviceRole,language:t.currentLang,currentRun:t.selectedRun,activeBibs:t.deviceRole==="gateJudge"?this.getActiveBibs(t.selectedRun):void 0,gateRange:t.gateAssignment||void 0,pendingConfirmation:this.pendingIntent||void 0};try{const r=await Zi(e,i,this.llmConfig,this.LLM_TIMEOUT_MS);await this.handleIntent(r)}catch(r){d.error("[Voice] Processing error:",r),this.setStatus("error"),await U.sayNotUnderstood(),this.setStatus("listening")}}getActiveBibs(e){const t=l.getState(),i=new Set,r=new Set;for(const s of t.entries)s.run===e&&(s.point==="S"?i.add(s.bib):s.point==="F"&&r.add(s.bib));return Array.from(i).filter(s=>!r.has(s))}async handleIntent(e){if(this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.pendingIntent&&(e.action==="confirm"||e.action==="cancel")){if(e.action==="confirm")this.executeIntent(this.pendingIntent),await U.sayRecorded();else{const t=l.getState().currentLang;await U.speak(p("voiceCancelled",t))}this.pendingIntent=null,this.setStatus("listening");return}if(e.action==="unknown"||e.confidence<.5){await U.sayNotUnderstood(),this.setStatus("listening");return}if(e.confirmationNeeded&&e.confirmationPrompt){this.pendingIntent=e,this.setStatus("confirming"),await U.speak(e.confirmationPrompt),this.confirmationTimeout=setTimeout(()=>{this.pendingIntent&&(d.debug("[Voice] Confirmation timeout"),this.pendingIntent=null,this.setStatus("listening"))},this.CONFIRMATION_TIMEOUT_MS);return}this.executeIntent(e),this.setStatus("listening")}executeIntent(e){d.debug("[Voice] Executing intent:",e.action);for(const t of this.actionCallbacks)t(e)}setStatus(e){if(this.status!==e){this.status=e;for(const t of this.stateCallbacks)t(e)}}enable(){if(!this.recognition||!this.llmConfig)return d.warn("[Voice] Not initialized"),!1;if(!this.isOnline)return this.setStatus("offline"),!1;this.isEnabled=!0,this.updateRecognitionLanguage();try{return this.recognition.start(),!0}catch(e){return d.warn("[Voice] Failed to start recognition:",e),this.setStatus("error"),!1}}disable(){var e;this.isEnabled=!1,this.isPaused=!1,this.pendingIntent=null,this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.stop()}catch{}U.cancel(),this.setStatus("inactive")}pause(){var e;if(!(!this.isEnabled||this.isPaused)){this.isPaused=!0,this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.abort()}catch{}d.debug("[Voice] Paused")}}resume(){!this.isEnabled||!this.isPaused||(this.isPaused=!1,this.isOnline&&this.status!=="error"&&this.scheduleRestart(),d.debug("[Voice] Resumed"))}getStatus(){return this.status}isActive(){return this.isEnabled}onStatusChange(e){return this.stateCallbacks.add(e),()=>this.stateCallbacks.delete(e)}onAction(e){return this.actionCallbacks.add(e),()=>this.actionCallbacks.delete(e)}isPausedState(){return this.isPaused}cleanup(){this.disable(),this.stateCallbacks.clear(),this.actionCallbacks.clear(),window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),this.recognition=null,this.llmConfig=null}}const Ca=new Xr;class es{constructor(){c(this,"recognition",null);c(this,"status","idle");c(this,"isDestroyed",!1);c(this,"statusCallbacks",new Set);c(this,"transcriptCallbacks",new Set);c(this,"MAX_DURATION_MS",3e4);c(this,"recordingTimeout",null)}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(){if(this.recognition)return!0;if(!this.isSupported())return d.warn("[VoiceNote] Speech Recognition not supported"),this.setStatus("unsupported"),!1;const e=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new e,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.setupRecognitionHandlers(),this.updateLanguage(),d.debug("[VoiceNote] Initialized successfully"),!0}updateLanguage(){if(!this.recognition)return;const e=l.getState().currentLang;this.recognition.lang=q(e)}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{d.debug("[VoiceNote] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{let t="",i="";for(let r=e.resultIndex;r<e.results.length;r++){const s=e.results[r];s.isFinal?i+=s[0].transcript:t+=s[0].transcript}t&&this.notifyTranscript(t,!1),i&&this.notifyTranscript(i,!0)},this.recognition.onerror=e=>{switch(d.warn("[VoiceNote] Recognition error:",e.error),e.error){case"not-allowed":case"service-not-allowed":this.setStatus("error");break;case"no-speech":case"audio-capture":this.setStatus("idle");break;case"aborted":this.setStatus("idle");break;default:this.setStatus("error")}this.clearRecordingTimeout()},this.recognition.onend=()=>{d.debug("[VoiceNote] Recognition ended"),this.clearRecordingTimeout(),this.status==="listening"&&this.setStatus("idle")})}start(){var e;if(this.isDestroyed||!this.initialize())return!1;this.updateLanguage();try{return(e=this.recognition)==null||e.start(),this.recordingTimeout=setTimeout(()=>{d.debug("[VoiceNote] Max duration reached, stopping"),this.stop()},this.MAX_DURATION_MS),!0}catch(t){return d.warn("[VoiceNote] Failed to start:",t),this.setStatus("error"),!1}}stop(){var e;this.clearRecordingTimeout();try{(e=this.recognition)==null||e.stop()}catch{}this.setStatus("idle")}abort(){var e;this.clearRecordingTimeout();try{(e=this.recognition)==null||e.abort()}catch{}this.setStatus("idle")}clearRecordingTimeout(){this.recordingTimeout&&(clearTimeout(this.recordingTimeout),this.recordingTimeout=null)}setStatus(e){if(this.status!==e){this.status=e;for(const t of this.statusCallbacks)try{t(e)}catch(i){d.error("[VoiceNote] Status callback error:",i)}}}notifyTranscript(e,t){for(const i of this.transcriptCallbacks)try{i(e,t)}catch(r){d.error("[VoiceNote] Transcript callback error:",r)}}getStatus(){return this.status}isRecording(){return this.status==="listening"}onStatusChange(e){return this.statusCallbacks.add(e),()=>this.statusCallbacks.delete(e)}onTranscript(e){return this.transcriptCallbacks.add(e),()=>this.transcriptCallbacks.delete(e)}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.abort(),this.statusCallbacks.clear(),this.transcriptCallbacks.clear(),this.recognition=null)}}const Ra=new es,ts=600*1e3,ns=60*1e3;class is{constructor(){c(this,"wakeLock",null);c(this,"isEnabled",!1);c(this,"visibilityHandler",null);c(this,"lastInteraction",Date.now());c(this,"idleCheckInterval",null);c(this,"interactionHandler",null)}isSupported(){return"wakeLock"in navigator}async enable(){return this.isSupported()?this.isEnabled?!0:(this.isEnabled=!0,this.lastInteraction=Date.now(),this.visibilityHandler||(this.visibilityHandler=()=>{!document.hidden&&this.isEnabled&&!this.wakeLock&&this.requestWakeLock()},document.addEventListener("visibilitychange",this.visibilityHandler)),this.startIdleTracking(),this.requestWakeLock()):!1}async disable(){this.isEnabled=!1,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.stopIdleTracking(),await this.releaseWakeLock()}resetIdleTimer(){this.lastInteraction=Date.now(),this.isEnabled&&!this.wakeLock&&this.requestWakeLock()}startIdleTracking(){this.interactionHandler||(this.interactionHandler=()=>this.resetIdleTimer(),document.addEventListener("touchstart",this.interactionHandler,{passive:!0}),document.addEventListener("mousedown",this.interactionHandler),document.addEventListener("keydown",this.interactionHandler)),this.idleCheckInterval===null&&(this.idleCheckInterval=setInterval(()=>this.checkIdle(),ns))}stopIdleTracking(){this.interactionHandler&&(document.removeEventListener("touchstart",this.interactionHandler),document.removeEventListener("mousedown",this.interactionHandler),document.removeEventListener("keydown",this.interactionHandler),this.interactionHandler=null),this.idleCheckInterval!==null&&(clearInterval(this.idleCheckInterval),this.idleCheckInterval=null)}checkIdle(){if(!this.isEnabled)return;if(Date.now()-this.lastInteraction>=ts&&this.wakeLock){d.debug("[WakeLock] Idle timeout reached, releasing wake lock"),this.releaseWakeLock();const t=l.getState().currentLang;L(p("wakeLockIdleTimeout",t),"warning",5e3)}}async requestWakeLock(){if(!this.isSupported()||this.wakeLock)return!!this.wakeLock;if(A.isCriticalBattery())return d.debug("[WakeLock] Critical battery, skipping wake lock request"),!1;try{return this.wakeLock=await navigator.wakeLock.request("screen"),this.wakeLock.addEventListener("release",()=>{this.wakeLock=null}),!0}catch(e){const t=e instanceof Error?e.message:"Unknown error";d.warn("Wake Lock request failed:",t),this.wakeLock=null;const i=l.getState().currentLang;return L(p("wakeLockFailed",i),"warning",2e3),!1}}async releaseWakeLock(){if(this.wakeLock){try{await this.wakeLock.release()}catch(e){d.warn("Wake Lock release error:",e)}this.wakeLock=null}}isActive(){return this.wakeLock!==null}isWakeLockEnabled(){return this.isEnabled}}const ka=new is,Pe=new Map;function Aa(n){return Pe.has(n)||Pe.set(n,document.getElementById(n)),Pe.get(n)}function Qe(n=18){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`}function rs(n=14){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="9" y1="11" x2="9" y2="17"/><line x1="15" y1="11" x2="15" y2="17"/></svg>`}function We(n=18){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`}function Me(n=16,e=2.5){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${e}"><path d="M20 6L9 17l-5-5"/></svg>`}function ss(n=16,e=2){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${e}"><path d="M18 6L6 18M6 6l12 12"/></svg>`}function Da(n=16,e=!1){return`<svg class="group-chevron" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true" style="flex-shrink: 0; transition: transform 0.2s; ${e?"transform: rotate(90deg);":""}"><path d="M9 18l6-6-6-6"/></svg>`}function as(n=12){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>`}function os(n=18){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>`}function $t(n=12){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 9v4M12 17h.01"/><circle cx="12" cy="12" r="10"/></svg>`}function cs(n=14){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`}function Pa(n=16){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2v6l4 4-4 4v6h12v-6l-4-4 4-4V2H6z"/></svg>`}function La(n){return`<button class="${n.className||"result-edit-btn"}" aria-label="${I(n.ariaLabel)}" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; opacity: 0.7;">${We(n.size||18)}</button>`}function Fa(n){return`<button class="${n.className||"result-delete"}" aria-label="${I(n.ariaLabel)}" style="background: none; border: none; color: var(--error); padding: 6px; cursor: pointer; opacity: 0.7;">${Qe(n.size||18)}</button>`}function Na(n){return`<button class="result-photo-btn" aria-label="${I(n)}" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">${os()}</button>`}function Ma(n){return`<span class="result-duplicate-badge" title="${I(p("multiDeviceDuplicate",n))}" aria-label="${I(p("multiDeviceDuplicate",n))}">${as()} ${D(p("multiDeviceDuplicate",n))}</span>`}function xa(n){var s;const{faults:e,lang:t}=n;if(e.length===0)return"";const i=e.map(a=>`T${a.gateNumber} (${Je(a.faultType,t)})`).join(", "),r=e.length>1?`${e.length}× ${p("flt",t)}`:`T${((s=e[0])==null?void 0:s.gateNumber)||"?"}`;return`<span class="result-fault-badge" title="${I(i)}" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">${D(r)}</span>`}const ls={dns:"#8899aa",dnf:"#ffd700",dsq:"#ff4757",flt:"#ffd700"};function $a(n,e="",t="0.65rem"){const i=ls[n.toLowerCase()]||e||"#ef4444";return`<span class="result-status" style="padding: 3px 10px; border-radius: 999px; font-family: var(--font-mono); font-size: ${t}; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; background: color-mix(in srgb, ${i} 10%, transparent); color: ${i}; border: 1px solid color-mix(in srgb, ${i} 15%, transparent);">${D(n)}</span>`}function Ba(n="0.7rem"){return`<span class="deletion-pending-status" style="display: flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: var(--radius); font-size: ${n}; font-weight: 600; background: var(--error); color: white;">${$t()} DEL</span>`}function _a(n,e){return`<span class="result-run" data-advanced style="padding: 2px 8px; border-radius: 999px; font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; text-align: center; background: color-mix(in srgb, ${e} 10%, transparent); color: ${e}; border: 1px solid color-mix(in srgb, ${e} 15%, transparent);">${D(n)}</span>`}function Oa(n,e,t="",i=""){return`<div class="result-point" style="padding: 3px 8px; border-radius: 999px; font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600; letter-spacing: 0.05em; text-align: center; text-transform: uppercase; background: color-mix(in srgb, ${e} 10%, transparent); color: ${e}; border: 1px solid color-mix(in srgb, ${e} 15%, transparent);">${D(n)}</div>`}function za(n,e){return`<span class="result-run" style="padding: 2px 8px; border-radius: 999px; font-family: var(--font-mono); font-size: 0.65rem; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; background: color-mix(in srgb, ${e} 10%, transparent); color: ${e}; border: 1px solid color-mix(in srgb, ${e} 15%, transparent);">${D(n)}</span>`}const It=0,us=1,ds=3,hs=7;class Va{constructor(e){c(this,"container");c(this,"timeElement");c(this,"dateElement");c(this,"dateRow");c(this,"lastTimeStr","");c(this,"animationId",null);c(this,"isRunning",!1);c(this,"visibilityHandler",null);c(this,"frameSkipCount",It);c(this,"currentFrame",0);c(this,"batteryUnsubscribe",null);c(this,"isDestroyed",!1);c(this,"cachedDigits",[]);c(this,"tickCallbacks",new Set);c(this,"tick",()=>{if(this.isRunning)try{if(this.currentFrame++,this.frameSkipCount===0||this.currentFrame%(this.frameSkipCount+1)===0){const t=new Date,i=mr(t);if(i!==this.lastTimeStr&&(this.updateDigits(i),this.lastTimeStr=i,this.tickCallbacks.size>0)){const s=i.substring(0,2),a=i.substring(3,5),o=i.substring(6,8),u=i.substring(9,12);for(const h of this.tickCallbacks)try{h(s,a,o,u)}catch(g){d.error("Clock tick callback error:",g)}}if(t.getSeconds()===0||!this.dateElement.textContent){const s=l.getState();this.dateElement.textContent=yr(t,s.currentLang)}}this.animationId=requestAnimationFrame(this.tick)}catch(e){if(d.error("Clock tick error:",e),this.animationId===null)try{this.animationId=requestAnimationFrame(this.tick)}catch(t){d.error("Clock RAF scheduling failed:",t),setTimeout(()=>{this.isRunning&&this.animationId===null&&this.tick()},16)}}});this.container=e,this.container.innerHTML="",this.timeElement=this.createTimeElement(),this.dateRow=this.createDateRow(),this.dateElement=this.dateRow.querySelector(".clock-date"),this.container.appendChild(this.timeElement),this.container.appendChild(this.dateRow),this.cachedDigits=Array.from(this.timeElement.querySelectorAll(".clock-digit")),this.moveTimingPointsToDateRow()}moveTimingPointsToDateRow(){const e=document.querySelector(".timing-controls");e&&this.dateRow&&this.dateRow.appendChild(e)}createTimeElement(){const e=document.createElement("div");e.className="clock-time",e.setAttribute("role","timer"),e.setAttribute("aria-live","polite");const t=l.getState().currentLang;e.setAttribute("aria-label",p("currentTime",t)),e.style.cssText=`
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(32px, 10vw, 48px);
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      text-shadow: 0 0 40px rgba(56, 189, 248, 0.3);
    `;for(let i=0;i<12;i++){const r=document.createElement("span");r.className="clock-digit",r.dataset.index=String(i),e.appendChild(r)}return e}createDateRow(){const e=document.createElement("div");e.className="clock-date-row",e.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      padding: 0 8px;
      width: 100%;
    `;const t=document.createElement("div");return t.className="clock-date",t.style.cssText=`
      font-size: 0.875rem;
      color: var(--text-secondary);
    `,e.appendChild(t),e}start(){this.isRunning||(this.isRunning=!0,this.tick(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null):this.isRunning&&this.animationId===null&&this.tick()},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)),this.batteryUnsubscribe||A.initialize().then(()=>{this.batteryUnsubscribe=A.subscribe(e=>{this.updateFrameSkipFromBattery(e.batteryLevel)})}).catch(e=>d.debug("Battery API unavailable:",e)))}updateFrameSkipFromBattery(e){switch(e){case"critical":this.frameSkipCount=hs;break;case"low":this.frameSkipCount=ds;break;case"medium":this.frameSkipCount=us;break;default:this.frameSkipCount=It}}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null)}updateDigits(e){for(let t=0;t<e.length&&t<this.cachedDigits.length;t++){const i=this.cachedDigits[t],r=e[t];i.textContent!==r&&(i.textContent=r,i.style.transform="scale(1.02)",requestAnimationFrame(()=>{i.style.transform="scale(1)"}))}}getCurrentTime(){return this.lastTimeStr}getTimestamp(){const e=Ji.getTimestamp();return e?new Date(e):new Date}onTick(e){return this.tickCallbacks.add(e),()=>{this.tickCallbacks.delete(e)}}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.stop(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.tickCallbacks.clear(),this.container.innerHTML="")}}class Ye{constructor(){c(this,"listeners",[])}add(e,t,i,r){e.addEventListener(t,i,r),this.listeners.push([e,t,i,r])}removeAll(){for(const[e,t,i,r]of this.listeners)e.removeEventListener(t,i,r);this.listeners=[]}get count(){return this.listeners.length}}const Se=80,Tt=2.5;class Ha{constructor(e){c(this,"container");c(this,"indicator");c(this,"styleElement",null);c(this,"onRefresh");c(this,"startY",0);c(this,"currentY",0);c(this,"isPulling",!1);c(this,"isRefreshing",!1);c(this,"scrollableParent",null);c(this,"listeners",new Ye);c(this,"onTouchStart",e=>{var i;this.isRefreshing||(((i=this.scrollableParent)==null?void 0:i.scrollTop)??0)>0||(this.startY=e.touches[0].clientY,this.isPulling=!0)});c(this,"onTouchMove",e=>{var t;if(!(!this.isPulling||this.isRefreshing))try{if((((t=this.scrollableParent)==null?void 0:t.scrollTop)??0)>0){this.isPulling=!1;return}this.currentY=e.touches[0].clientY;const r=(this.currentY-this.startY)/Tt;r>0&&(e.preventDefault(),this.updateIndicator(r))}catch(i){d.error("PullToRefresh move error:",i),this.isPulling=!1,this.resetIndicator()}});c(this,"onTouchEnd",async()=>{if(!this.isPulling||this.isRefreshing)return;const e=(this.currentY-this.startY)/Tt;this.isPulling=!1,e>=Se?(this.isRefreshing=!0,await this.triggerRefresh()):this.resetIndicator()});this.container=e.container,this.onRefresh=e.onRefresh,this.indicator=this.createIndicator(),this.container.insertBefore(this.indicator,this.container.firstChild),this.scrollableParent=e.scrollElement??this.findScrollableParent(this.container)??this.findScrollableChild(this.container),this.bindEvents()}createIndicator(){const e=document.createElement("div");e.className="pull-indicator",e.style.cssText=`
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: transform 0.2s;
      pointer-events: none;
      z-index: 100;
    `;const t=l.getState().currentLang;return e.innerHTML=`
      <div class="pull-indicator-content" style="display: flex; align-items: center; gap: 8px;">
        <svg class="pull-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
        <span class="pull-text">${p("pullToRefresh",t)}</span>
      </div>
      <div class="pull-spinner" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      </div>
    `,this.styleElement=document.createElement("style"),this.styleElement.textContent=`
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(this.styleElement),e}findScrollableParent(e){let t=e.parentElement;for(;t;){const i=getComputedStyle(t);if(i.overflowY==="auto"||i.overflowY==="scroll")return t;t=t.parentElement}return null}findScrollableChild(e){const t=e.querySelectorAll("*");for(const i of t)if(i instanceof HTMLElement){const r=getComputedStyle(i);if(r.overflowY==="auto"||r.overflowY==="scroll")return i}return null}bindEvents(){this.listeners.add(this.container,"touchstart",this.onTouchStart,{passive:!0}),this.listeners.add(this.container,"touchmove",this.onTouchMove,{passive:!1}),this.listeners.add(this.container,"touchend",this.onTouchEnd,{passive:!0})}updateIndicator(e){const t=Math.min(e,Se*1.5);this.indicator.style.transform=`translateY(${t}px)`;const i=Math.min(e/Se,1),r=this.indicator.querySelector(".pull-icon"),s=this.indicator.querySelector(".pull-text");if(r&&(r.style.transform=`rotate(${i*180}deg)`),s){const a=l.getState().currentLang;s.textContent=i>=1?p("releaseToRefresh",a):p("pullToRefresh",a)}}async triggerRefresh(){const e=this.indicator.querySelector(".pull-indicator-content"),t=this.indicator.querySelector(".pull-spinner");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.indicator.style.transform=`translateY(${Se}px)`;try{await this.onRefresh()}catch(i){d.error("PullToRefresh callback error:",i)}finally{this.isRefreshing=!1,e&&(e.style.display="flex"),t&&(t.style.display="none"),this.resetIndicator()}}resetIndicator(){this.indicator.style.transform="translateY(0)";const e=this.indicator.querySelector(".pull-icon");e&&(e.style.transform="rotate(0deg)")}destroy(){this.isRefreshing=!1,this.isPulling=!1,this.listeners.removeAll(),this.indicator.remove(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}}const ie=64,gs=.35;class Ga{constructor(e){c(this,"element");c(this,"wrapper");c(this,"leftAction");c(this,"rightAction");c(this,"options");c(this,"startX",0);c(this,"startY",0);c(this,"currentX",0);c(this,"startTime",0);c(this,"isHorizontalSwipe",null);c(this,"pointerId",null);c(this,"suppressClickUntil",0);c(this,"pendingActionTimeoutId",null);c(this,"usePointerEvents",typeof window<"u"&&"PointerEvent"in window);c(this,"listeners",new Ye);c(this,"onTouchStart",e=>{this.startGesture(e.touches[0].clientX,e.touches[0].clientY)});c(this,"onTouchMove",e=>{this.moveGesture(e.touches[0].clientX,e.touches[0].clientY,e)});c(this,"onTouchEnd",()=>{this.endGesture()});c(this,"onPointerDown",e=>{var t,i;e.pointerType==="mouse"&&e.button!==0||(this.pointerId=e.pointerId,(i=(t=this.wrapper).setPointerCapture)==null||i.call(t,e.pointerId),this.startGesture(e.clientX,e.clientY))});c(this,"onPointerMove",e=>{this.pointerId===e.pointerId&&this.moveGesture(e.clientX,e.clientY,e)});c(this,"onPointerUp",e=>{var t,i;this.pointerId===e.pointerId&&(this.pointerId=null,(i=(t=this.wrapper).hasPointerCapture)!=null&&i.call(t,e.pointerId)&&this.wrapper.releasePointerCapture(e.pointerId),this.endGesture())});c(this,"onPointerCancel",e=>{var t,i;this.pointerId===e.pointerId&&(this.pointerId=null,(i=(t=this.wrapper).hasPointerCapture)!=null&&i.call(t,e.pointerId)&&this.wrapper.releasePointerCapture(e.pointerId),this.reset())});c(this,"onClickCapture",e=>{Date.now()<this.suppressClickUntil&&(e.preventDefault(),e.stopPropagation())});this.options=e,this.element=e.element,this.wrapper=this.createWrapper(),this.leftAction=this.createLeftAction(),this.rightAction=this.createRightAction(),this.setupDOM(),this.bindEvents()}createWrapper(){const e=document.createElement("div");return e.className="swipe-content",e.style.cssText=`
      position: relative;
      height: 100%;
      transform: translateX(0);
      transition: transform 0.2s ease-out;
      background: inherit;
      z-index: 1;
      touch-action: pan-y;
      user-select: none;
      -webkit-user-select: none;
    `,e}createLeftAction(){const e=document.createElement("div");return e.className="swipe-action swipe-action-left",e.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: ${ie}px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      color: white;
      font-weight: 600;
      z-index: 0;
    `,e.innerHTML=this.options.leftContent||We(24),e}createRightAction(){const e=document.createElement("div");return e.className="swipe-action swipe-action-right",e.style.cssText=`
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: ${ie}px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--error);
      color: white;
      font-weight: 600;
      z-index: 0;
    `,e.innerHTML=this.options.rightContent||Qe(24),e}setupDOM(){const e=this.element.style;for(e.display&&(this.wrapper.style.display=e.display),e.alignItems&&(this.wrapper.style.alignItems=e.alignItems),e.justifyContent&&(this.wrapper.style.justifyContent=e.justifyContent),e.gap&&(this.wrapper.style.gap=e.gap),e.gridTemplateColumns&&(this.wrapper.style.gridTemplateColumns=e.gridTemplateColumns),e.gridTemplateRows&&(this.wrapper.style.gridTemplateRows=e.gridTemplateRows),e.gridTemplateAreas&&(this.wrapper.style.gridTemplateAreas=e.gridTemplateAreas),e.gridAutoFlow&&(this.wrapper.style.gridAutoFlow=e.gridAutoFlow),this.wrapper.style.width="100%",e.padding&&(this.wrapper.style.padding=e.padding,e.padding="0"),e.display&&(e.display="block"),e.gridTemplateColumns&&(e.gridTemplateColumns=""),e.gridTemplateRows&&(e.gridTemplateRows=""),e.gridTemplateAreas&&(e.gridTemplateAreas=""),e.gridAutoFlow&&(e.gridAutoFlow=""),e.gap&&(e.gap="");this.element.firstChild;)this.wrapper.appendChild(this.element.firstChild);const t=this.element.style.position;(!t||t==="static")&&(this.element.style.position="relative"),this.element.style.overflow="hidden",this.element.appendChild(this.leftAction),this.element.appendChild(this.rightAction),this.element.appendChild(this.wrapper)}bindEvents(){this.usePointerEvents?(this.listeners.add(this.wrapper,"pointerdown",this.onPointerDown,{passive:!0}),this.listeners.add(this.wrapper,"pointermove",this.onPointerMove,{passive:!1}),this.listeners.add(this.wrapper,"pointerup",this.onPointerUp,{passive:!0}),this.listeners.add(this.wrapper,"pointercancel",this.onPointerCancel,{passive:!0})):(this.listeners.add(this.wrapper,"touchstart",this.onTouchStart,{passive:!0}),this.listeners.add(this.wrapper,"touchmove",this.onTouchMove,{passive:!1}),this.listeners.add(this.wrapper,"touchend",this.onTouchEnd,{passive:!0})),this.listeners.add(this.wrapper,"click",this.onClickCapture,{capture:!0})}startGesture(e,t){this.startX=e,this.startY=t,this.currentX=0,this.startTime=Date.now(),this.isHorizontalSwipe=null,this.wrapper.style.transition="none"}moveGesture(e,t,i){const r=e-this.startX,s=t-this.startY;if(this.isHorizontalSwipe===null&&(Math.abs(r)>10||Math.abs(s)>10)&&(this.isHorizontalSwipe=Math.abs(r)>Math.abs(s)),!this.isHorizontalSwipe)return;i.preventDefault();const a=ie*1.2;this.currentX=Math.max(-a,Math.min(a,r)),this.wrapper.style.transform=`translateX(${this.currentX}px)`}endGesture(){if(!this.isHorizontalSwipe){this.wrapper.style.transition="transform 0.2s ease-out";return}const e=Math.max(Date.now()-this.startTime,1),t=Math.abs(this.currentX)/e,i=Math.abs(this.currentX)>=24&&t>gs;this.wrapper.style.transition="transform 0.2s ease-out",Math.abs(this.currentX)>10&&(this.suppressClickUntil=Date.now()+300),this.pendingActionTimeoutId!==null&&(clearTimeout(this.pendingActionTimeoutId),this.pendingActionTimeoutId=null),Math.abs(this.currentX)>=ie||i?this.currentX<0&&this.options.onSwipeLeft?(this.wrapper.style.transform=`translateX(-${ie}px)`,this.pendingActionTimeoutId=window.setTimeout(()=>{var r,s;this.pendingActionTimeoutId=null,(s=(r=this.options).onSwipeLeft)==null||s.call(r),this.reset()},200)):this.currentX>0&&this.options.onSwipeRight?(this.wrapper.style.transform=`translateX(${ie}px)`,this.pendingActionTimeoutId=window.setTimeout(()=>{var r,s;this.pendingActionTimeoutId=null,(s=(r=this.options).onSwipeRight)==null||s.call(r),this.reset()},200)):this.reset():this.reset()}reset(){this.wrapper.style.transition="transform 0.2s ease-out",this.wrapper.style.transform="translateX(0)",this.currentX=0}destroy(){for(this.pendingActionTimeoutId!==null&&(clearTimeout(this.pendingActionTimeoutId),this.pendingActionTimeoutId=null),this.listeners.removeAll();this.wrapper.firstChild;)this.element.appendChild(this.wrapper.firstChild);this.wrapper.remove(),this.leftAction.remove(),this.rightAction.remove()}}const fs=3e3,ps=1e3,ms=5;class ys{constructor(){c(this,"container");c(this,"queue",[]);c(this,"isShowing",!1);c(this,"toastEventListener");c(this,"lastCopyTime",0);c(this,"isDestroyed",!1);this.container=this.createContainer(),document.body.appendChild(this.container),this.toastEventListener=(e=>{this.show(e.detail.message,{type:e.detail.type,duration:e.detail.duration})}),window.addEventListener("show-toast",this.toastEventListener)}createContainer(){const e=document.createElement("div");return e.id="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.style.cssText=`
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    `,e}show(e,t={}){for(;this.queue.length>=ms;){const i=this.queue.findIndex(r=>!r.options.action);if(i>=0)this.queue.splice(i,1);else break}this.queue.push({message:e,options:t}),this.isShowing||this.processQueue()}processQueue(){if(this.queue.length===0){this.isShowing=!1;return}this.isShowing=!0;const{message:e,options:t}=this.queue.shift(),i=t.duration||fs,r=t.type||"info",s=this.createToast(e,r,t.action);this.container.appendChild(s),requestAnimationFrame(()=>{s.style.opacity="1",s.style.transform="translateY(0)"});let a=!1;const o=()=>{a||(a=!0,s.style.opacity="0",s.style.transform="translateY(10px)",setTimeout(()=>{s.remove(),this.processQueue()},200))};s._dismiss=o,setTimeout(o,i)}createToast(e,t,i){const r=document.createElement("div");r.className=`toast toast-${t}`;const s={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--primary)"},a={success:'<path d="M20 6L9 17l-5-5"/>',error:'<path d="M18 6L6 18M6 6l12 12"/>',warning:'<path d="M12 9v4M12 17h.01"/>',info:'<path d="M12 16v-4M12 8h.01"/>'};if(r.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border-left: 3px solid ${s[t]};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 0.875rem;
      color: var(--text-primary);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: auto;
      max-width: 90vw;
    `,r.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${s[t]}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        ${a[t]}
      </svg>
      <span>${D(e)}</span>
    `,i){const o=document.createElement("button");o.textContent=i.label,o.setAttribute("aria-label",i.label),o.style.cssText=`
        background: none;
        border: 1px solid ${s[t]};
        color: ${s[t]};
        padding: 2px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        margin-left: 4px;
        white-space: nowrap;
      `,o.addEventListener("click",u=>{u.stopPropagation(),u.preventDefault(),i.callback();const h=r._dismiss;h&&h()}),r.appendChild(o)}else r.addEventListener("click",o=>{o.stopPropagation(),o.preventDefault(),this.copyToClipboard(e)});return r.addEventListener("mousedown",o=>o.stopPropagation()),r.addEventListener("touchstart",o=>o.stopPropagation(),{passive:!0}),r}async copyToClipboard(e){const t=Date.now(),i=t-this.lastCopyTime>ps;this.lastCopyTime=t;try{await navigator.clipboard.writeText(e),i&&this.show(p("copied",l.getState().currentLang),{type:"success",duration:1500})}catch{}}clear(){this.queue=[],this.container.innerHTML="",this.isShowing=!1}destroy(){this.isDestroyed||(this.isDestroyed=!0,window.removeEventListener("show-toast",this.toastEventListener),this.clear(),this.container.remove())}}let oe=null;function Bt(){return oe||(oe=new ys),oe}function L(n,e="info",t,i){Bt().show(n,{type:e,duration:t,action:i==null?void 0:i.action})}function Ua(){Bt().clear()}function Ja(){oe&&(oe.destroy(),oe=null)}function vs(n){const e=new Date(n);let t=e.getHours(),i=e.getMinutes(),r=e.getSeconds(),s=Math.round(e.getMilliseconds()/10);return s>=100&&(s=0,r++,r>=60&&(r=0,i++),i>=60&&(i=0,t++),t>=24&&(t=0)),`${String(t).padStart(2,"0")}:${String(i).padStart(2,"0")}:${String(r).padStart(2,"0")},${String(s).padStart(2,"0")}`}function N(n){const e=["=","+","-","@","|","	","\r",`
`];let t=n;return e.some(i=>t.startsWith(i))&&(t=`'${t}`),/^[+]?0x/i.test(t)&&(t=`'${t}`),t.includes('"')&&(t=t.replace(/"/g,'""')),(t.includes(";")||t.includes('"')||t.includes(`
`)||t.includes("|"))&&(t=`"${t}"`),t}function bs(n){const e=new Date(n),t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return`${t}-${i}-${r}`}function Ss(n){return n==="S"?"ST":"FT"}function Le(n,e){var i;return((i={ok:{en:"OK",de:"OK",fr:"OK"},dns:{en:"DNS",de:"DNS",fr:"DNS"},dnf:{en:"DNF",de:"DNF",fr:"DNF"},dsq:{en:"DSQ",de:"DSQ",fr:"DSQ"},flt:{en:"FLT",de:"SZT",fr:"PEN"}}[n])==null?void 0:i[e])||n.toUpperCase()}function ws(n){return n.length===0?"":n.sort((e,t)=>e.gateNumber-t.gateNumber).map(e=>`T${e.gateNumber}(${e.faultType})`).join(",")}function Es(){const n=l.getState(),e=n.entries,t=n.faultEntries,i=n.currentLang;if(e.length===0){L(p("noEntries",i),"warning");return}try{const r=[...e].sort((m,E)=>new Date(m.timestamp).getTime()-new Date(E.timestamp).getTime()),s=t.length>0,a=s?"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Torstrafzeit;Torfehler;Datum":"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Datum",o=r.map(m=>{const E=N(m.bib),C=m.run??1,R=Ss(m.point),F=vs(m.timestamp),H=N(m.deviceName||m.deviceId),$=N(bs(m.timestamp)),G=m.point==="F"?t.filter(ne=>ne.bib===m.bib&&ne.run===C):[];let te;if(m.point==="F"&&G.length>0?te=n.usePenaltyMode?Le("flt",i):Le("dsq",i):te=Le(m.status,i),s){const ne=G.length>0&&n.usePenaltyMode?G.length*n.penaltySeconds:0,P=ws(G);return`${E};${N(String(C))};${N(R)};${N(F)};${N(te)};${H};${N(String(ne))};${N(P)};${$}`}else return`${E};${N(String(C))};${N(R)};${N(F)};${N(te)};${H};${$}`}),u=[a,...o].join(`
`),h=new Blob([u],{type:"text/csv;charset=utf-8;"}),g=URL.createObjectURL(h),f=document.createElement("a");f.href=g;const y=new Date().toISOString().split("T")[0],v=n.raceId||"race";f.download=`${v}_${y}.csv`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(g),pe(),L(p("exported",i),"success")}catch(r){d.error("CSV export failed:",r),L(p("operationFailed",i),"error")}}function xe(n,e="csv"){const t=new Date().toISOString().split("T")[0];return`${n.replace(/[^a-zA-Z0-9-_]/g,"_")||"race"}_${t}.${e}`}function Is(){const n=l.getState(),e=n.currentLang,t=n.faultEntries,i=n.raceId||"RACE";if(t.length===0){L(p("noFaultsToExport",e),"warning");return}const r=new Map;for(const f of t){const y=`${f.bib}-${f.run}`;r.has(y)||r.set(y,[]),r.get(y).push(f)}const s=[];s.push(`📋 ${p("gateFaults",e)} - ${i}`),s.push("");const a=Array.from(r.entries()).filter(([f])=>f.endsWith("-1")),o=Array.from(r.entries()).filter(([f])=>f.endsWith("-2")),u=(f,y)=>{const[v]=f.split("-"),m=v.padStart(3,"0"),E=y.sort((R,F)=>R.gateNumber-F.gateNumber).map(R=>`T${R.gateNumber}`).join("+"),C=y.map(R=>R.faultType).join(", ");if(n.usePenaltyMode){const R=y.length*n.penaltySeconds;return`#${m}: ${E} (${C}) → +${R}s`}else return`#${m}: ${E} (${C})`};a.length>0&&(s.push(`🏁 ${p("runLabel",e)} 1:`),n.usePenaltyMode?s.push(`🟡 ${p("penaltyLabel",e)}:`):s.push(`🔴 ${p("dsq",e)}:`),a.sort((f,y)=>parseInt(f[0].split("-")[0],10)-parseInt(y[0].split("-")[0],10)).forEach(([f,y])=>{s.push(u(f,y))}),s.push("")),o.length>0&&(s.push(`🏁 ${p("runLabel",e)} 2:`),n.usePenaltyMode?s.push(`🟡 ${p("penaltyLabel",e)}:`):s.push(`🔴 ${p("dsq",e)}:`),o.sort((f,y)=>parseInt(f[0].split("-")[0],10)-parseInt(y[0].split("-")[0],10)).forEach(([f,y])=>{s.push(u(f,y))}),s.push(""));const h=new Date;s.push(`📅 ${h.toLocaleDateString(q(e))} ${h.toLocaleTimeString(q(e),{hour:"2-digit",minute:"2-digit"})}`);const g=s.join(`
`);navigator.clipboard?navigator.clipboard.writeText(g).then(()=>{pe(),L(p("copiedToClipboard",e),"success")}).catch(()=>{$e(g,xe(`${i}_WhatsApp`,"txt"))}):$e(g,xe(`${i}_WhatsApp`,"txt"))}function Ts(){const n=l.getState(),e=n.currentLang,t=n.faultEntries,i=n.raceId||"RACE";if(t.length===0){L(p("noFaultsToExport",e),"warning");return}const r=new Map;for(const f of t){const y=`${f.bib}-${f.run}`;r.has(y)||r.set(y,[]),r.get(y).push(f)}const s=[],a="══════════════════════════════════════════════════════",o=Array.from(r.entries()).filter(([f])=>f.endsWith("-1")),u=Array.from(r.entries()).filter(([f])=>f.endsWith("-2")),h=(f,y)=>{f.length!==0&&(s.push(`${p("faultSummaryTitle",e)} - ${p("runLabel",e)} ${y}`),s.push(a),s.push(`${p("bib",e).substring(0,7).padEnd(7)} │ ${p("faults",e).padEnd(16)} │ ${p("penalty",e).padStart(9)} │ Status`),s.push("────────┼──────────────────┼───────────┼────────"),f.sort((v,m)=>parseInt(v[0].split("-")[0],10)-parseInt(m[0].split("-")[0],10)).forEach(([v,m])=>{const[E]=v.split("-"),C=E.padStart(5),R=m.sort(($,G)=>$.gateNumber-G.gateNumber).map($=>`T${$.gateNumber}(${$.faultType})`).join(", ").padEnd(16);let F,H;n.usePenaltyMode?(F=`${m.length*n.penaltySeconds} ${p("sec",e)}`.padStart(9),H=p("flt",e)):(F="-".padStart(9),H=p("dsq",e)),s.push(`  ${C}   │ ${R} │ ${F} │ ${H}`)}),s.push(""))};s.push(`${i} - ${new Date().toLocaleDateString(q(e))}`),s.push(""),h(o,1),h(u,2),s.push(a),s.push(`${p("generated",e)}: ${new Date().toLocaleString(q(e))}`);const g=s.join(`
`);$e(g,xe(`${i}_${p("summary",e)}`,"txt")),pe(),L(p("exported",e),"success")}function $e(n,e){const t=new Blob([n],{type:"text/plain;charset=utf-8;"}),i=URL.createObjectURL(t),r=document.createElement("a");r.href=i,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i)}const X=new Ye,Be=[];let we=null;async function Cs(n){return new Promise(e=>{we=e,window.dispatchEvent(new CustomEvent("request-pin-verification",{detail:{lang:n}}))})}function Rs(n){we&&(we(n),we=null)}function ks(n){window.dispatchEvent(new CustomEvent("open-fault-edit-modal",{detail:{fault:n}}))}function As(n){window.dispatchEvent(new CustomEvent("open-mark-deletion-modal",{detail:{fault:n}}))}function Ds(){window.dispatchEvent(new CustomEvent("update-inline-faults-list"))}function Ct(){window.dispatchEvent(new CustomEvent("update-inline-bib-selector"))}function Ps(){window.dispatchEvent(new CustomEvent("update-inline-gate-selector"))}function Ls(){const n=document.getElementById("chief-judge-toggle-btn");n&&(X.add(n,"click",async()=>{const e=l.getState(),t=e.currentLang;if(e.isChiefJudgeView){l.toggleChiefJudgeView(),Oe(),Z(),L(p("chiefJudgeModeDisabled",t),"info");return}e.settings.sync&&e.raceId&&!await Cs(t)||(l.toggleChiefJudgeView(),Oe(),Z(),L(p("chiefJudgeModeEnabled",t),"info"))}),_e(),Be.push(W(()=>{Ai.value,ye.value,_e()}),W(()=>{ye.value,ot.value,ct.value,at.value&&(ue(),me())}),W(()=>{ot.value,ct.value,Ke()}),W(()=>{st.value,ye.value,Di.value,at.value&&Ze()}),W(()=>{ye.value,Ae.value==="gateJudge"&&(Ds(),Ct())}),W(()=>{st.value,Ae.value==="gateJudge"&&Ct()}),W(()=>{Pi.value,Ae.value==="gateJudge"&&Ps()})),Ns(),Fs())}function Fs(){const n=document.getElementById("export-csv-btn");n&&X.add(n,"click",()=>{Z(),Es()});const e=document.getElementById("export-summary-btn");e&&X.add(e,"click",()=>{Z(),Ts()});const t=document.getElementById("export-whatsapp-btn");t&&X.add(t,"click",()=>{Z(),Is()})}function Ns(){const n=document.getElementById("penalty-mode-toggle");n&&X.add(n,"click",t=>{const i=t.target.closest(".penalty-mode-btn");if(!i)return;const r=i.getAttribute("data-mode");r==="penalty"?l.setUsePenaltyMode(!0):r==="dsq"&&l.setUsePenaltyMode(!1),Z()});const e=document.getElementById("penalty-seconds-selector");e&&X.add(e,"click",t=>{const i=t.target.closest(".penalty-adj-btn");if(!i)return;const r=i.getAttribute("data-adj"),a=l.getState().penaltySeconds;r==="+1"?l.setPenaltySeconds(a+1):r==="-1"&&l.setPenaltySeconds(a-1),Z()}),Ke()}function Ke(){const n=l.getState(),e=document.getElementById("penalty-config-row"),t=document.getElementById("penalty-seconds-value"),i=document.getElementById("penalty-mode-toggle");e&&e.classList.toggle("dsq-mode",!n.usePenaltyMode),t&&(t.textContent=String(n.penaltySeconds)),i&&i.querySelectorAll(".penalty-mode-btn").forEach(s=>{const a=s.getAttribute("data-mode"),o=a==="penalty"&&n.usePenaltyMode||a==="dsq"&&!n.usePenaltyMode;s.classList.toggle("active",o),s.setAttribute("aria-pressed",String(o))})}function _e(){const n=document.getElementById("chief-judge-toggle-row");if(!n)return;const t=l.getState().settings.sync;n.style.display=t?"block":"none"}function Oe(){const n=l.getState(),e=document.querySelector(".results-view"),t=document.getElementById("chief-judge-toggle-btn");!e||!t||(t.classList.toggle("active",n.isChiefJudgeView),t.setAttribute("aria-pressed",String(n.isChiefJudgeView)),e.classList.toggle("chief-mode",n.isChiefJudgeView),n.isChiefJudgeView&&(ue(),me(),Ze()))}function Ze(){const n=document.getElementById("judges-overview-list"),e=document.getElementById("judges-overview-count"),t=document.getElementById("judges-overview-empty");if(!n||!e)return;const i=ge.getOtherGateAssignments(),r=l.getState(),s=[...i];if(r.deviceRole==="gateJudge"&&r.gateAssignment&&s.push({deviceId:r.deviceId,deviceName:r.deviceName,gateStart:r.gateAssignment[0],gateEnd:r.gateAssignment[1],lastSeen:Date.now(),isReady:r.isJudgeReady}),e.textContent=String(s.length),t&&(t.style.display=s.length===0?"block":"none"),n.querySelectorAll(".judge-card").forEach(u=>u.remove()),s.length===0)return;s.sort((u,h)=>u.gateStart-h.gateStart);const o=s.map(u=>`
    <div class="judge-card${u.isReady?" ready":""}">
      <span class="judge-ready-indicator"></span>
      <span class="judge-name" title="${I(u.deviceName)}">${D(u.deviceName)}</span>
      <span class="judge-gates">${u.gateStart}–${u.gateEnd}</span>
    </div>
  `).join("");t?t.insertAdjacentHTML("beforebegin",o):n.innerHTML=o}function ue(){const n=document.getElementById("fault-summary-list"),e=document.getElementById("fault-summary-count"),t=document.getElementById("chief-empty-state");if(!n||!e)return;const i=l.getState(),r=i.currentLang,s=i.faultEntries,a=new Map;for(const v of s){const m=`${v.bib}-${v.run}`;a.has(m)||a.set(m,[]),a.get(m).push(v)}if(e.textContent=String(a.size),t&&(t.style.display=a.size===0?"flex":"none"),a.size===0){n.querySelectorAll(".fault-summary-card").forEach(m=>m.remove());return}const o=[],u=Array.from(a.entries()).sort((v,m)=>{const[E]=v,[C]=m,R=parseInt(E.split("-")[0],10)||0,F=parseInt(C.split("-")[0],10)||0;return R-F});for(const[v,m]of u){const[E,C]=v.split("-"),R=parseInt(C,10),F=l.isRacerFinalized(E,R),H=m.filter(P=>!P.markedForDeletion),$=i.usePenaltyMode?H.length*i.penaltySeconds:0,G=m.map(P=>{const _=P.markedForDeletion,Ot=_&&P.markedForDeletionBy?`${p("deletionPending",r)} (${P.markedForDeletionBy})`:"",zt=P.notes&&P.notes.length>0;return`
        <div class="fault-entry-row${_?" marked-for-deletion":""}" data-fault-id="${I(P.id)}">
          <div class="fault-gate-info">
            <span class="fault-gate-num${_?" strikethrough":""}">${p("gate",r)} ${D(String(P.gateNumber))}</span>
            <span class="fault-type-badge${_?" marked":""}">${Je(P.faultType,r)}</span>
            ${zt?`<span class="fault-note-icon" title="${I(p("hasNote",r))}" aria-label="${I(p("hasNote",r))}">${cs(14)}</span>`:""}
            ${_?`<span class="deletion-pending-badge" title="${I(Ot)}">${$t(14)}</span>`:""}
          </div>
          <span class="fault-judge-name">${D(P.deviceName)}</span>
          <div class="fault-row-actions">
            <button class="fault-row-btn edit-fault-btn" data-fault-id="${I(P.id)}" title="${I(p("edit",r))}" aria-label="${I(p("edit",r))}" ${_?"disabled":""}>
              ${We(14)}
            </button>
            <button class="fault-row-btn delete-fault-btn" data-fault-id="${I(P.id)}" title="${I(p(_?"rejectDeletion":"markForDeletion",r))}" aria-label="${I(p(_?"rejectDeletion":"markForDeletion",r))}">
              ${_?rs(14):Qe(14)}
            </button>
          </div>
        </div>
      `}).join(""),te=F?`<div class="finalized-badge">
           ${Me(16,2.5)}
           ${p("finalized",r)}
         </div>`:`<button class="finalize-btn" data-bib="${I(E)}" data-run="${I(String(R))}">
           ${Me(16)}
           ${p("finalize",r)}
         </button>`,ne=i.usePenaltyMode?`<span class="fault-card-penalty">+${$}s</span>
         <span class="fault-card-result flt">${p("flt",r)}</span>`:`<span class="fault-card-result dsq">${p("dsq",r)}</span>`;o.push(`
      <div class="fault-summary-card${F?" finalized":""}" data-bib="${I(E)}" data-run="${I(String(R))}">
        <div class="fault-card-header">
          <span class="fault-card-bib">#${D(E.padStart(3,"0"))}</span>
          <div class="fault-card-status">
            ${ne}
          </div>
        </div>
        <div class="fault-card-body">
          ${G}
        </div>
        <div class="fault-card-actions">
          ${te}
        </div>
      </div>
    `)}n.querySelectorAll(".fault-summary-card").forEach(v=>v.remove()),t?t.insertAdjacentHTML("beforebegin",o.join("")):n.innerHTML=o.join(""),n.querySelectorAll(".finalize-btn").forEach(v=>{v.addEventListener("click",xs)}),n.querySelectorAll(".edit-fault-btn").forEach(v=>{v.addEventListener("click",m=>{m.stopPropagation();const E=v.dataset.faultId;if(E){const C=l.getState().faultEntries.find(R=>R.id===E);C&&ks(C)}})}),n.querySelectorAll(".delete-fault-btn").forEach(v=>{v.addEventListener("click",m=>{m.stopPropagation();const E=v.dataset.faultId;if(E){const C=l.getState().faultEntries.find(R=>R.id===E);C&&(C.markedForDeletion?_t(C):As(C))}})})}function _t(n){if(l.rejectFaultDeletion(n.id)){const t=l.getState().faultEntries.find(r=>r.id===n.id);t&&Kr(t);const i=l.getState().currentLang;L(p("deletionRejected",i),"success"),pe(),ue(),me()}}function Ms(n){const e=l.approveFaultDeletion(n.id);if(e){Zr(e);const t=l.getState().currentLang;L(p("deletionApproved",t),"success"),Oi(),ue(),me()}}function me(){const n=document.getElementById("pending-deletions-section"),e=document.getElementById("pending-deletions-list"),t=document.getElementById("pending-deletions-count");if(!n||!e||!t)return;const i=l.getPendingDeletions(),s=l.getState().currentLang;if(t.textContent=String(i.length),n.style.display=i.length>0?"block":"none",i.length===0){e.innerHTML="";return}const a=i.map(o=>{const u=o.markedForDeletionAt?new Date(o.markedForDeletionAt).toLocaleTimeString(q(s),{hour:"2-digit",minute:"2-digit"}):"";return`
      <div class="pending-deletion-item" data-fault-id="${I(o.id)}">
        <div class="pending-deletion-info">
          <span class="pending-deletion-fault">
            #${D(o.bib.padStart(3,"0"))} T${D(String(o.gateNumber))} (${Je(o.faultType,s)}) - ${p(o.run===1?"run1":"run2",s)}
          </span>
          <span class="pending-deletion-meta">
            ${p("deletionMarkedBy",s)}: ${D(o.markedForDeletionBy||"?")} (${D(u)})
          </span>
        </div>
        <div class="pending-deletion-actions">
          <button class="pending-deletion-btn approve" data-fault-id="${I(o.id)}" title="${I(p("approveDeletion",s))}" aria-label="${I(p("approveDeletion",s))}">
            ${Me(16,2.5)}
          </button>
          <button class="pending-deletion-btn reject" data-fault-id="${I(o.id)}" title="${I(p("rejectDeletion",s))}" aria-label="${I(p("rejectDeletion",s))}">
            ${ss(16)}
          </button>
        </div>
      </div>
    `}).join("");e.innerHTML=a,e.querySelectorAll(".pending-deletion-btn.approve").forEach(o=>{o.addEventListener("click",u=>{u.stopPropagation();const h=o.dataset.faultId;if(h){const g=i.find(f=>f.id===h);g&&Ms(g)}})}),e.querySelectorAll(".pending-deletion-btn.reject").forEach(o=>{o.addEventListener("click",u=>{u.stopPropagation();const h=o.dataset.faultId;if(h){const g=i.find(f=>f.id===h);g&&_t(g)}})})}function xs(n){const e=n.currentTarget,t=e.dataset.bib,i=e.dataset.run;if(!t||!i)return;const r=parseInt(i,10);l.finalizeRacer(t,r),pe();const s=l.getState();L(`#${t.padStart(3,"0")} ${p("finalized",s.currentLang)}`,"success"),ue()}function $s(){for(const n of Be)n();Be.length=0,X.removeAll()}const ja=Object.freeze(Object.defineProperty({__proto__:null,cleanupChiefJudgeView:$s,initChiefJudgeToggle:Ls,resolvePinVerification:Rs,updateChiefJudgeToggleVisibility:_e,updateChiefJudgeView:Oe,updateFaultSummaryPanel:ue,updateJudgesOverview:Ze,updatePenaltyConfigUI:Ke,updatePendingDeletionsPanel:me},Symbol.toStringTag,{value:"Module"}));export{st as $,Da as A,Ma as B,_a as C,va as D,vr as E,xa as F,$a as G,Na as H,Oa as I,za as J,La as K,Ye as L,Fa as M,Ba as N,Os as O,Ks as P,ye as Q,ze as R,Ga as S,he as T,Oi as U,Ha as V,Es as W,la as X,pa as Y,V as Z,dr as _,L as a,ga as a0,ma as a1,z as a2,ha as a3,wa as a4,on as a5,Ia as a6,b as a7,ke as a8,wr as a9,Ys as aA,Zs as aB,Xs as aC,ea as aD,ta as aE,na as aF,ia as aG,ra as aH,Fe as aI,Ea as aJ,Pa as aK,fa as aL,Vs as aM,Bt as aN,ja as aO,oa as aa,ca as ab,zs as ac,Va as ad,sa as ae,Ji as af,Ai as ag,Gs as ah,Js as ai,Us as aj,Ua as ak,Ta as al,De as am,ka as an,Ja as ao,gt as ap,Rs as aq,ua as ar,da as as,qs as at,Qs as au,Ws as av,js as aw,Ae as ax,Di as ay,Pi as az,Je as b,Kr as c,Z as d,D as e,pe as f,q as g,aa as h,I as i,cs as j,Qe as k,mr as l,Hs as m,Zr as n,Ca as o,Aa as p,ge as q,Me as r,l as s,p as t,d as u,Ra as v,A as w,ya as x,Sa as y,ba as z};
