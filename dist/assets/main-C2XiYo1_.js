var yi=Object.defineProperty;var vi=(n,e,t)=>e in n?yi(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var h=(n,e,t)=>vi(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function bi(n){const e=Date.now(),t=crypto.randomUUID().slice(0,8);return`${n}-${e}-${t}`}const Ye=["swift","bold","cool","fast","keen","wild","calm","warm","bright","sharp","quick","brave","fresh","grand","prime","clear","snow","ice","frost","peak","alpine","polar","winter","crisp"],Qe=["fox","bear","wolf","hawk","eagle","tiger","lion","deer","pine","oak","cedar","birch","maple","spruce","aspen","willow","peak","ridge","slope","trail","summit","valley","glacier","cliff"];function sn(n){return n.charAt(0).toUpperCase()+n.slice(1)}function Si(){const n=Ye[Math.floor(Math.random()*Ye.length)],e=Qe[Math.floor(Math.random()*Qe.length)],t=Math.floor(Math.random()*100);return`dev_${n}-${e}-${t}`}function Ke(){const n=Ye[Math.floor(Math.random()*Ye.length)],e=Qe[Math.floor(Math.random()*Qe.length)],t=Math.floor(Math.random()*100);return`${sn(n)} ${sn(e)} ${t}`}const Ze=2,Ei=["S","F"],wi=["ok","dns","dnf","dsq","flt"],xn=["MG","STR","BR"],Dn=[1,2],Ii=["create","edit","restore"];function be(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"&&typeof e.id!="number"||typeof e.id=="string"&&e.id.length===0||typeof e.id=="number"&&e.id<=0||e.bib!==void 0&&typeof e.bib!="string"||typeof e.bib=="string"&&e.bib.length>10||!Ei.includes(e.point)||!e.timestamp||typeof e.timestamp!="string"||isNaN(Date.parse(e.timestamp))||e.status!==void 0&&!wi.includes(e.status)||e.deviceId!==void 0&&typeof e.deviceId!="string"||e.deviceName!==void 0&&typeof e.deviceName!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||e.syncedAt<0||!Number.isFinite(e.syncedAt))||e.photo!==void 0&&typeof e.photo!="string")return!1;if(e.gpsCoords!==void 0){if(typeof e.gpsCoords!="object"||e.gpsCoords===null)return!1;const t=e.gpsCoords;if(typeof t.latitude!="number"||!Number.isFinite(t.latitude)||typeof t.longitude!="number"||!Number.isFinite(t.longitude)||typeof t.accuracy!="number"||!Number.isFinite(t.accuracy)||t.accuracy<0)return!1}return!0}function Ci(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.version!="number"||!Number.isInteger(e.version)||e.version<1||typeof e.timestamp!="string"||isNaN(Date.parse(e.timestamp))||typeof e.editedBy!="string"||e.editedBy.length>100||typeof e.editedByDeviceId!="string"||e.editedByDeviceId.length>100||!Ii.includes(e.changeType)||!e.data||typeof e.data!="object")return!1;const t=e.data;return!(typeof t.id!="string"||typeof t.bib!="string"||t.bib.length>10||!Dn.includes(t.run)||typeof t.gateNumber!="number"||!Number.isInteger(t.gateNumber)||t.gateNumber<0||!xn.includes(t.faultType)||typeof t.timestamp!="string"||isNaN(Date.parse(t.timestamp))||typeof t.deviceId!="string"||typeof t.deviceName!="string"||t.deviceName.length>100||!Array.isArray(t.gateRange)||t.gateRange.length!==2||typeof t.gateRange[0]!="number"||typeof t.gateRange[1]!="number"||!Number.isInteger(t.gateRange[0])||!Number.isInteger(t.gateRange[1])||e.changeDescription!==void 0&&typeof e.changeDescription!="string"||typeof e.changeDescription=="string"&&e.changeDescription.length>500)}function Li(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"||e.id.length===0||typeof e.bib!="string"||e.bib.length>10||typeof e.deviceId!="string"||typeof e.deviceName!="string"||e.deviceName.length>100||typeof e.timestamp!="string"||isNaN(Date.parse(e.timestamp))||!Dn.includes(e.run)||typeof e.gateNumber!="number"||!Number.isInteger(e.gateNumber)||e.gateNumber<0||!xn.includes(e.faultType)||!Array.isArray(e.gateRange)||e.gateRange.length!==2||typeof e.gateRange[0]!="number"||typeof e.gateRange[1]!="number"||!Number.isInteger(e.gateRange[0])||!Number.isInteger(e.gateRange[1])||typeof e.currentVersion!="number"||!Number.isInteger(e.currentVersion)||e.currentVersion<1||!Array.isArray(e.versionHistory))return!1;for(const t of e.versionHistory)if(!Ci(t))return!1;return!(typeof e.markedForDeletion!="boolean"||e.markedForDeletionAt!==void 0&&(typeof e.markedForDeletionAt!="string"||isNaN(Date.parse(e.markedForDeletionAt)))||e.deletionApprovedAt!==void 0&&(typeof e.deletionApprovedAt!="string"||isNaN(Date.parse(e.deletionApprovedAt)))||e.markedForDeletionBy!==void 0&&typeof e.markedForDeletionBy!="string"||e.markedForDeletionByDeviceId!==void 0&&typeof e.markedForDeletionByDeviceId!="string"||e.deletionApprovedBy!==void 0&&typeof e.deletionApprovedBy!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||!Number.isFinite(e.syncedAt)))}function Ti(n){if(!Li(n))return null;const e=n,t=e.versionHistory.map(i=>({...i,editedBy:N(i.editedBy,100),editedByDeviceId:N(i.editedByDeviceId,100),changeDescription:i.changeDescription?N(i.changeDescription,500):void 0,data:{...i.data,bib:N(i.data.bib,10),deviceId:N(i.data.deviceId,100),deviceName:N(i.data.deviceName,100)}}));return{...e,bib:N(e.bib,10),deviceId:N(e.deviceId,100),deviceName:N(e.deviceName,100),markedForDeletionBy:e.markedForDeletionBy?N(e.markedForDeletionBy,100):void 0,markedForDeletionByDeviceId:e.markedForDeletionByDeviceId?N(e.markedForDeletionByDeviceId,100):void 0,deletionApprovedBy:e.deletionApprovedBy?N(e.deletionApprovedBy,100):void 0,versionHistory:t}}function ki(n){if(!n||typeof n!="object")return!1;const e=n;return!(!be(e.entry)||typeof e.retryCount!="number"||e.retryCount<0||typeof e.lastAttempt!="number"||e.lastAttempt<0)}function Pn(n){return!n||typeof n!="string"||n.length>50?!1:/^[a-zA-Z0-9_-]+$/.test(n)}function Ri(n){return!n||typeof n!="string"?!1:n.startsWith("dev_")&&n.length>4}function N(n,e=100){return!n||typeof n!="string"?"":n.slice(0,e).replace(/[<>"'&]/g,"").replace(/[\x00-\x1F\x7F]/g,"")}function Ai(n,e){if(!be(n))return null;const t=n;return{id:(typeof t.id=="number",String(t.id)),bib:N(t.bib,10),point:t.point,run:t.run??1,timestamp:t.timestamp,status:t.status||"ok",deviceId:N(t.deviceId||e,50),deviceName:N(t.deviceName||"Unknown Device",100),syncedAt:t.syncedAt,photo:t.photo,gpsCoords:t.gpsCoords}}function xi(n,e){const t={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};if(!n||typeof n!="object")return{version:Ze,entries:[],settings:t,deviceId:e,deviceName:Ke(),raceId:"",syncQueue:[]};const i=n;let s=[];Array.isArray(i.entries)&&(s=i.entries.map(o=>Ai(o,e)).filter(o=>o!==null));let r=t;if(i.settings&&typeof i.settings=="object"){const o=i.settings;r={auto:typeof o.auto=="boolean"?o.auto:t.auto,haptic:typeof o.haptic=="boolean"?o.haptic:t.haptic,sound:typeof o.sound=="boolean"?o.sound:t.sound,sync:typeof o.sync=="boolean"?o.sync:t.sync,syncPhotos:typeof o.syncPhotos=="boolean"?o.syncPhotos:t.syncPhotos,gps:typeof o.gps=="boolean"?o.gps:t.gps,simple:typeof o.simple=="boolean"?o.simple:t.simple,photoCapture:typeof o.photoCapture=="boolean"?o.photoCapture:t.photoCapture,motionEffects:typeof o.motionEffects=="boolean"?o.motionEffects:t.motionEffects,glassEffects:typeof o.glassEffects=="boolean"?o.glassEffects:t.glassEffects,outdoorMode:typeof o.outdoorMode=="boolean"?o.outdoorMode:t.outdoorMode,ambientMode:typeof o.ambientMode=="boolean"?o.ambientMode:t.ambientMode}}let a=[];return Array.isArray(i.syncQueue)&&(a=i.syncQueue.filter(ki)),{version:Ze,entries:s,settings:r,deviceId:Ri(i.deviceId)?i.deviceId:e,deviceName:N(i.deviceName,100)||Ke(),raceId:Pn(i.raceId)?i.raceId:"",syncQueue:a,lastExport:typeof i.lastExport=="number"?i.lastExport:void 0}}function rt(n,e){n.addEventListener("input",()=>{n.value=n.value.replace(/[^0-9]/g,""),e!==void 0&&(n.value=n.value.slice(0,e))})}const p={debug:()=>{},log:()=>{},info:()=>{},warn:console.warn.bind(console),error:console.error.bind(console)},A={ENTRIES:"skiTimerEntries",SETTINGS:"skiTimerSettings",LANG:"skiTimerLang",DEVICE_ID:"skiTimerDeviceId",DEVICE_NAME:"skiTimerDeviceName",RACE_ID:"skiTimerRaceId",LAST_SYNCED_RACE_ID:"skiTimerLastSyncedRaceId",SYNC_QUEUE:"skiTimerSyncQueue",SCHEMA_VERSION:"skiTimerSchemaVersion",DEVICE_ROLE:"skiTimerDeviceRole",GATE_ASSIGNMENT:"skiTimerGateAssignment",FIRST_GATE_COLOR:"skiTimerFirstGateColor",FAULT_ENTRIES:"skiTimerFaultEntries"},rn={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0},Di=50,an=50,on=100;function mt(n){return{id:n.id,bib:n.bib,run:n.run,gateNumber:n.gateNumber,faultType:n.faultType,timestamp:n.timestamp,deviceId:n.deviceId,deviceName:n.deviceName,gateRange:n.gateRange,syncedAt:n.syncedAt}}function He(n,e,t,i,s,r){return{version:n,timestamp:new Date().toISOString(),editedBy:i,editedByDeviceId:s,changeType:e,data:t,changeDescription:r}}function pt(n,e){const t=[...n||[],e];return t.length>an?t.slice(-an):t}class Pi{constructor(){h(this,"state");h(this,"listeners",new Set);h(this,"saveTimeout",null);h(this,"isNotifying",!1);h(this,"pendingNotifications",[]);h(this,"listenerErrorCallback",null);h(this,"failedListenerCount",0);this.state=this.loadInitialState()}loadInitialState(){let e=localStorage.getItem(A.DEVICE_ID);e||(e=Si(),localStorage.setItem(A.DEVICE_ID,e));const t=localStorage.getItem(A.ENTRIES),i=localStorage.getItem(A.SETTINGS),s=localStorage.getItem(A.SYNC_QUEUE);let r=[],a=rn,o=[];try{if(t){const b=JSON.parse(t);Array.isArray(b)&&(r=b.filter(w=>be(w)).map(w=>({...w,run:w.run??1})))}}catch(b){p.error("Failed to parse entries:",b)}try{if(i){const b=JSON.parse(i);a={...rn,...b}}}catch(b){p.error("Failed to parse settings:",b)}try{if(s){const b=JSON.parse(s);Array.isArray(b)&&(o=b)}}catch(b){p.error("Failed to parse sync queue:",b)}const l=localStorage.getItem(A.LANG)||"de";let g=localStorage.getItem(A.DEVICE_NAME);g||(g=Ke(),localStorage.setItem(A.DEVICE_NAME,g));const u=localStorage.getItem(A.RACE_ID)||"",f=localStorage.getItem(A.LAST_SYNCED_RACE_ID)||"",y=localStorage.getItem(A.DEVICE_ROLE)||"timer";let v=null,S="red",C=[];try{const b=localStorage.getItem(A.GATE_ASSIGNMENT);if(b){const R=JSON.parse(b);Array.isArray(R)&&R.length===2&&(v=R)}const w=localStorage.getItem(A.FIRST_GATE_COLOR);(w==="red"||w==="blue")&&(S=w)}catch(b){p.error("Failed to parse gate assignment:",b)}try{const b=localStorage.getItem(A.FAULT_ENTRIES);if(b){const w=JSON.parse(b);Array.isArray(w)&&(C=w)}}catch(b){p.error("Failed to parse fault entries:",b)}return{currentView:y==="gateJudge"?"gateJudge":"timer",currentLang:l,bibInput:"",selectedPoint:"F",selectedRun:1,selectMode:!1,selectedEntries:new Set,isRecording:!1,lastRecordedEntry:null,entries:r,deviceRole:y,gateAssignment:v,firstGateColor:S,faultEntries:C,selectedFaultBib:"",isJudgeReady:!1,isChiefJudgeView:!1,finalizedRacers:new Set,penaltySeconds:5,usePenaltyMode:!0,undoStack:[],redoStack:[],settings:a,deviceId:e,deviceName:g,raceId:u,lastSyncedRaceId:f,syncStatus:"disconnected",syncQueue:o,connectedDevices:new Map,cloudDeviceCount:0,cloudHighestBib:0,raceExistsInCloud:null,gpsEnabled:a.gps,gpsAccuracy:null,gpsStatus:"inactive",cameraReady:!1,cameraError:null}}getState(){return this.state}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e){if(this.pendingNotifications.length>0){const t=this.pendingNotifications[this.pendingNotifications.length-1],i=new Set([...t.keys,...e]);if(t.keys=Array.from(i),t.stateSnapshot=this.state,this.isNotifying)return}else this.pendingNotifications.push({keys:e,stateSnapshot:this.state});if(this.pendingNotifications.length>on&&p.warn(`Notification queue exceeded ${on} - possible infinite loop`),!this.isNotifying){this.isNotifying=!0;try{for(;this.pendingNotifications.length>0;){const{keys:t,stateSnapshot:i}=this.pendingNotifications.shift(),s=Array.from(this.listeners);for(const r of s)try{r(i,t)}catch(a){if(p.error("State listener error:",a),this.failedListenerCount++,this.listenerErrorCallback)try{this.listenerErrorCallback(a,r)}catch{}}}}finally{this.isNotifying=!1}}}onListenerError(e){this.listenerErrorCallback=e}getListenerFailureCount(){return this.failedListenerCount}setState(e,t=!0){const i=Object.keys(e);this.state={...this.state,...e},this.notify(i),t&&this.scheduleSave()}scheduleSave(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveToStorage(),100)}forceSave(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null),this.saveToStorage()}saveToStorage(){try{this.checkStorageQuota();const e=this.state.entries.map(t=>t.photo&&t.photo!=="indexeddb"&&t.photo.length>20?{...t,photo:"indexeddb"}:t);localStorage.setItem(A.ENTRIES,JSON.stringify(e)),localStorage.setItem(A.SETTINGS,JSON.stringify(this.state.settings)),localStorage.setItem(A.LANG,this.state.currentLang),localStorage.setItem(A.DEVICE_NAME,this.state.deviceName),localStorage.setItem(A.RACE_ID,this.state.raceId),localStorage.setItem(A.LAST_SYNCED_RACE_ID,this.state.lastSyncedRaceId),localStorage.setItem(A.SYNC_QUEUE,JSON.stringify(this.state.syncQueue)),localStorage.setItem(A.SCHEMA_VERSION,String(Ze)),localStorage.setItem(A.DEVICE_ROLE,this.state.deviceRole),this.state.gateAssignment?localStorage.setItem(A.GATE_ASSIGNMENT,JSON.stringify(this.state.gateAssignment)):localStorage.removeItem(A.GATE_ASSIGNMENT),localStorage.setItem(A.FIRST_GATE_COLOR,this.state.firstGateColor),localStorage.setItem(A.FAULT_ENTRIES,JSON.stringify(this.state.faultEntries))}catch(e){p.error("Failed to save to storage:",e),this.dispatchStorageError(e)}}async checkStorageQuota(){var e;if((e=navigator.storage)!=null&&e.estimate)try{const{usage:t,quota:i}=await navigator.storage.estimate();if(i&&t){const s=t/i;s>.9&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t,quota:i,percent:Math.round(s*100)}}))}}catch(t){p.warn("Could not check storage quota:",t)}}dispatchStorageError(e){window.dispatchEvent(new CustomEvent("storage-error",{detail:{message:e.message,isQuotaError:e.name==="QuotaExceededError"||e.message.includes("quota")||e.message.includes("storage"),entryCount:this.state.entries.length}}))}pushUndo(e){const t=[...this.state.undoStack,e];t.length>Di&&t.shift(),this.setState({undoStack:t,redoStack:[]},!1)}addEntry(e){const t=[...this.state.entries,e];this.pushUndo({type:"ADD_ENTRY",data:e,timestamp:Date.now()}),this.setState({entries:t,lastRecordedEntry:e,isRecording:!1}),this.state.settings.sync&&this.state.raceId&&this.addToSyncQueue(e)}deleteEntry(e){const t=this.state.entries.find(s=>s.id===e);if(!t)return;this.pushUndo({type:"DELETE_ENTRY",data:t,timestamp:Date.now()});const i=this.state.entries.filter(s=>s.id!==e);this.setState({entries:i})}deleteMultiple(e){const t=this.state.entries.filter(s=>e.includes(s.id));if(t.length===0)return;this.pushUndo({type:"DELETE_MULTIPLE",data:t,timestamp:Date.now()});const i=this.state.entries.filter(s=>!e.includes(s.id));this.setState({entries:i,selectMode:!1,selectedEntries:new Set})}clearAll(){this.state.entries.length!==0&&(this.pushUndo({type:"CLEAR_ALL",data:[...this.state.entries],timestamp:Date.now()}),this.setState({entries:[],selectMode:!1,selectedEntries:new Set}))}updateEntry(e,t){const i=this.state.entries.findIndex(o=>o.id===e);if(i===-1)return!1;const s=this.state.entries[i],r={...s,...t};this.pushUndo({type:"UPDATE_ENTRY",data:s,newData:r,timestamp:Date.now()});const a=[...this.state.entries];return a[i]=r,this.setState({entries:a}),!0}canUndo(){return this.state.undoStack.length>0}canRedo(){return this.state.redoStack.length>0}peekUndo(){return this.canUndo()?this.state.undoStack[this.state.undoStack.length-1]:null}undo(){if(!this.canUndo())return null;const e=[...this.state.undoStack],t=e.pop(),i=[...this.state.redoStack,t];let s=[...this.state.entries],r=null;switch(t.type){case"ADD_ENTRY":{const a=t.data;s=s.filter(o=>o.id!==a.id),r=a;break}case"DELETE_ENTRY":{const a=t.data;s.push(a),s.sort((o,l)=>new Date(o.timestamp).getTime()-new Date(l.timestamp).getTime()),r=a;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const a=t.data;s=[...s,...a],s.sort((o,l)=>new Date(o.timestamp).getTime()-new Date(l.timestamp).getTime()),r=a;break}case"UPDATE_ENTRY":{const a=t.data,o=s.findIndex(l=>l.id===a.id);o!==-1&&(s[o]=a),r=a;break}}return this.setState({entries:s,undoStack:e,redoStack:i}),r?{type:t.type,data:r}:null}redo(){if(!this.canRedo())return null;const e=[...this.state.redoStack],t=e.pop(),i=[...this.state.undoStack,t];let s=[...this.state.entries],r=null;switch(t.type){case"ADD_ENTRY":{const a=t.data;s.push(a),s.sort((o,l)=>new Date(o.timestamp).getTime()-new Date(l.timestamp).getTime()),r=a;break}case"DELETE_ENTRY":{const a=t.data;s=s.filter(o=>o.id!==a.id),r=a;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const a=t.data,o=new Set(a.map(l=>l.id));s=s.filter(l=>!o.has(l.id)),r=a;break}case"UPDATE_ENTRY":{const a=t.data,o=t.newData,l=s.findIndex(g=>g.id===a.id);l!==-1&&o&&(s[l]=o),r=o||a;break}}return this.setState({entries:s,undoStack:i,redoStack:e}),r}addToSyncQueue(e){const t={entry:e,retryCount:0,lastAttempt:0},i=[...this.state.syncQueue,t];this.setState({syncQueue:i})}removeFromSyncQueue(e){const t=this.state.syncQueue.filter(i=>i.entry.id!==e);this.setState({syncQueue:t})}updateSyncQueueItem(e,t){const i=this.state.syncQueue.map(s=>s.entry.id===e?{...s,...t}:s);this.setState({syncQueue:i})}clearSyncQueue(){this.setState({syncQueue:[]})}setView(e){this.setState({currentView:e},!1)}setLanguage(e){this.setState({currentLang:e})}setBibInput(e){const t=e.replace(/\D/g,"").slice(0,3);this.setState({bibInput:t},!1)}setSelectedPoint(e){this.setState({selectedPoint:e},!1)}setSelectedRun(e){this.setState({selectedRun:e},!1)}setSelectMode(e){this.setState({selectMode:e,selectedEntries:e?this.state.selectedEntries:new Set},!1)}toggleEntrySelection(e){const t=new Set(this.state.selectedEntries);t.has(e)?t.delete(e):t.add(e),this.setState({selectedEntries:t,selectMode:t.size>0},!1)}selectAllEntries(){const e=new Set(this.state.entries.map(t=>t.id));this.setState({selectedEntries:e,selectMode:!0},!1)}clearSelection(){this.setState({selectedEntries:new Set,selectMode:!1},!1)}setRecording(e){this.setState({isRecording:e},!1)}setDeviceRole(e){this.setState({deviceRole:e})}setGateAssignment(e){this.setState({gateAssignment:e})}setFirstGateColor(e){this.setState({firstGateColor:e})}getGateColor(e){const{gateAssignment:t,firstGateColor:i}=this.state;if(!t)return i;const[s]=t;return(e-s)%2===0?i:i==="red"?"blue":"red"}setSelectedFaultBib(e){this.setState({selectedFaultBib:e},!1)}setJudgeReady(e){this.setState({isJudgeReady:e})}toggleJudgeReady(){this.setState({isJudgeReady:!this.state.isJudgeReady})}setChiefJudgeView(e){this.setState({isChiefJudgeView:e},!1)}toggleChiefJudgeView(){this.setState({isChiefJudgeView:!this.state.isChiefJudgeView},!1)}finalizeRacer(e,t){const i=`${e}-${t}`,s=new Set(this.state.finalizedRacers);s.add(i),this.setState({finalizedRacers:s},!1)}unfinalizeRacer(e,t){const i=`${e}-${t}`,s=new Set(this.state.finalizedRacers);s.delete(i),this.setState({finalizedRacers:s},!1)}isRacerFinalized(e,t){const i=`${e}-${t}`;return this.state.finalizedRacers.has(i)}clearFinalizedRacers(){this.setState({finalizedRacers:new Set},!1)}setPenaltySeconds(e){this.setState({penaltySeconds:Math.max(0,Math.min(60,e))},!1)}setUsePenaltyMode(e){this.setState({usePenaltyMode:e},!1)}addFaultEntry(e){const t=He(1,"create",mt(e),e.deviceName,e.deviceId),i={...e,currentVersion:1,versionHistory:[t],markedForDeletion:!1},s=[...this.state.faultEntries,i];this.setState({faultEntries:s})}deleteFaultEntry(e){const t=this.state.faultEntries.filter(i=>i.id!==e);this.setState({faultEntries:t})}updateFaultEntry(e,t){const i=this.state.faultEntries.findIndex(r=>r.id===e);if(i===-1)return!1;const s=[...this.state.faultEntries];return s[i]={...s[i],...t},this.setState({faultEntries:s}),!0}updateFaultEntryWithHistory(e,t,i){const s=this.state.faultEntries.findIndex(u=>u.id===e);if(s===-1)return!1;const r=this.state.faultEntries[s];if(r.markedForDeletion)return!1;const a=r.currentVersion+1,o={...r,...t},l=He(a,"edit",mt(o),this.state.deviceName,this.state.deviceId,i),g=[...this.state.faultEntries];return g[s]={...o,currentVersion:a,versionHistory:pt(r.versionHistory,l)},this.setState({faultEntries:g}),!0}restoreFaultVersion(e,t){var g;const i=this.state.faultEntries.findIndex(u=>u.id===e);if(i===-1)return!1;const s=this.state.faultEntries[i];if(s.markedForDeletion)return!1;const r=(g=s.versionHistory)==null?void 0:g.find(u=>u.version===t);if(!r)return!1;const a=s.currentVersion+1,o=He(a,"restore",{...r.data},this.state.deviceName,this.state.deviceId,`Restored to version ${t}`),l=[...this.state.faultEntries];return l[i]={...s,bib:r.data.bib,run:r.data.run,gateNumber:r.data.gateNumber,faultType:r.data.faultType,currentVersion:a,versionHistory:pt(s.versionHistory,o)},this.setState({faultEntries:l}),!0}markFaultForDeletion(e){const t=this.state.faultEntries.findIndex(s=>s.id===e);if(t===-1)return!1;const i=[...this.state.faultEntries];return i[t]={...i[t],markedForDeletion:!0,markedForDeletionAt:new Date().toISOString(),markedForDeletionBy:this.state.deviceName,markedForDeletionByDeviceId:this.state.deviceId},this.setState({faultEntries:i}),!0}approveFaultDeletion(e){const t=this.state.faultEntries.find(r=>r.id===e);if(!t||!t.markedForDeletion)return null;const i={...t,deletionApprovedAt:new Date().toISOString(),deletionApprovedBy:this.state.deviceName},s=this.state.faultEntries.filter(r=>r.id!==e);return this.setState({faultEntries:s}),i}rejectFaultDeletion(e){const t=this.state.faultEntries.findIndex(o=>o.id===e);if(t===-1)return!1;const i=this.state.faultEntries[t],s=i.currentVersion+1,r=He(s,"edit",mt(i),this.state.deviceName,this.state.deviceId,"Deletion rejected by Chief Judge"),a=[...this.state.faultEntries];return a[t]={...a[t],markedForDeletion:!1,markedForDeletionAt:void 0,markedForDeletionBy:void 0,markedForDeletionByDeviceId:void 0,currentVersion:s,versionHistory:pt(i.versionHistory,r)},this.setState({faultEntries:a}),!0}getPendingDeletions(){return this.state.faultEntries.filter(e=>e.markedForDeletion)}clearFaultEntries(){this.setState({faultEntries:[]})}getFaultsForBib(e,t){return this.state.faultEntries.filter(i=>i.bib===e&&i.run===t)}mergeFaultsFromCloud(e,t=[]){let i=0,s=0;const r=new Map(this.state.faultEntries.map(g=>[`${g.id}-${g.deviceId}`,g])),a=new Set(t),o=[],l=[];for(const g of e){const u=Ti(g);if(!u){p.warn("Skipping invalid fault from cloud:",g);continue}if(u.deviceId===this.state.deviceId)continue;const f=`${u.id}:${u.deviceId}`;if(a.has(f)||a.has(u.id))continue;const y=`${u.id}-${u.deviceId}`,v=r.get(y);if(v){const S=u.currentVersion||1,C=v.currentVersion||1;(S>C||u.markedForDeletion!==v.markedForDeletion)&&(l.push(u),s++)}else o.push(u),i++}if(o.length>0||l.length>0){let g=[...this.state.faultEntries];for(const u of l){const f=`${u.id}-${u.deviceId}`,y=g.findIndex(v=>`${v.id}-${v.deviceId}`===f);y!==-1&&(g[y]=u)}g=[...g,...o],g.sort((u,f)=>new Date(u.timestamp).getTime()-new Date(f.timestamp).getTime()),this.setState({faultEntries:g})}return i+s}removeDeletedCloudFaults(e){const t=new Set(e);let i=0;const s=this.state.faultEntries.filter(r=>{const a=`${r.id}:${r.deviceId}`;return t.has(a)||t.has(r.id)?(i++,!1):!0});return i>0&&this.setState({faultEntries:s}),i}markFaultSynced(e){const t=this.state.faultEntries.findIndex(i=>i.id===e);if(t!==-1){const i=[...this.state.faultEntries];i[t]={...i[t],syncedAt:Date.now()},this.setState({faultEntries:i})}}getActiveBibs(e){const t=this.state.entries,i=t.filter(o=>o.point==="S"&&o.run===e),s=t.filter(o=>o.point==="F"&&o.run===e),r=new Set(s.map(o=>o.bib)),a=new Set(i.filter(o=>!r.has(o.bib)).map(o=>o.bib));return Array.from(a).sort((o,l)=>parseInt(o,10)-parseInt(l,10))}updateSettings(e){const t={...this.state.settings,...e};this.setState({settings:t})}toggleSetting(e){const t={...this.state.settings};t[e]=!t[e],this.setState({settings:t})}setSyncStatus(e){this.setState({syncStatus:e},!1)}setRaceId(e){e!==this.state.raceId?this.setState({raceId:e,undoStack:[],redoStack:[]}):this.setState({raceId:e})}setLastSyncedRaceId(e){this.setState({lastSyncedRaceId:e})}markCurrentRaceAsSynced(){this.setState({lastSyncedRaceId:this.state.raceId})}setDeviceName(e){this.setState({deviceName:e})}addConnectedDevice(e){const t=new Map(this.state.connectedDevices);t.set(e.id,e),this.setState({connectedDevices:t},!1)}removeConnectedDevice(e){const t=new Map(this.state.connectedDevices);t.delete(e),this.setState({connectedDevices:t},!1)}setCloudDeviceCount(e){this.setState({cloudDeviceCount:e},!1)}setCloudHighestBib(e){this.setState({cloudHighestBib:e},!1)}setRaceExistsInCloud(e){this.setState({raceExistsInCloud:e},!1)}setGpsStatus(e,t){this.setState({gpsStatus:e,gpsAccuracy:t??null},!1)}setCameraReady(e,t){this.setState({cameraReady:e,cameraError:t??null},!1)}mergeCloudEntries(e,t=[]){let i=0;const s=new Set(this.state.entries.map(o=>`${o.id}-${o.deviceId}`)),r=new Set(t),a=[];for(const o of e){if(!be(o)||o.deviceId===this.state.deviceId)continue;const l=`${o.id}:${o.deviceId}`;if(r.has(l)||r.has(o.id))continue;const g=`${o.id}-${o.deviceId}`;s.has(g)||(a.push({...o,run:o.run??1}),s.add(g),i++)}if(a.length>0){const o=[...this.state.entries,...a];o.sort((l,g)=>new Date(l.timestamp).getTime()-new Date(g.timestamp).getTime()),this.setState({entries:o})}return i}removeDeletedCloudEntries(e){const t=new Set(e);let i=0;const s=this.state.entries.filter(r=>{const a=`${r.id}:${r.deviceId}`;return t.has(a)||t.has(r.id)?(i++,!1):!0});return i>0&&this.setState({entries:s}),i}exportData(){return JSON.stringify({version:Ze,entries:this.state.entries,settings:this.state.settings,deviceId:this.state.deviceId,deviceName:this.state.deviceName,raceId:this.state.raceId,exportedAt:new Date().toISOString()},null,2)}importData(e){try{const t=JSON.parse(e),i=xi(t,this.state.deviceId),s=new Set(this.state.entries.map(a=>a.id)),r=i.entries.filter(a=>!s.has(a.id));if(r.length>0){const a=[...this.state.entries,...r];a.sort((o,l)=>new Date(o.timestamp).getTime()-new Date(l.timestamp).getTime()),this.setState({entries:a})}return{success:!0,entriesImported:r.length}}catch(t){return{success:!1,entriesImported:0,error:String(t)}}}}const c=new Pi;function oe(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),i=String(n.getSeconds()).padStart(2,"0"),s=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${i}.${s}`}function Bi(n,e="de"){const t={weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"};return n.toLocaleDateString(e==="de"?"de-DE":"en-US",t)}function yt(n,e=3){return String(n).padStart(e,"0")}function k(n){const e=document.createElement("div");return e.textContent=String(n),e.innerHTML}function Re(n){return{S:"var(--success)",F:"var(--secondary)"}[n]||"var(--text-secondary)"}function ce(n,e="de"){return{en:{S:"Start",F:"Finish"},de:{S:"Start",F:"Ziel"}}[e][n]}function Ce(n,e="de"){return{en:{1:"R1",2:"R2"},de:{1:"L1",2:"L2"}}[e][n]}function Le(n){return{1:"var(--primary)",2:"var(--warning)"}[n]||"var(--text-secondary)"}function Fi(n){return n<1024?`${n} B`:n<1024*1024?`${(n/1024).toFixed(1)} KB`:`${(n/(1024*1024)).toFixed(1)} MB`}const cn={en:{timer:"Timer",results:"Results",settings:"Settings",start:"Start",finish:"Finish",bib:"Bib",point:"Point",run:"Run",run1:"R1",run2:"R2",time:"Record time",lastRecorded:"Last recorded",lastRecordedShort:"Last:",advancedSettings:"Advanced Settings",status:"Status",noEntries:"No entries recorded",noEntriesHint:"Record times on the Timer tab",search:"Search by bib...",filter:"Filter",all:"All",total:"Total",racers:"Racers",finished:"Finished",fastest:"Fastest",average:"Average",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Delete Entry",confirmDeleteText:"Are you sure you want to delete this entry?",confirmDeleteFault:"Delete this fault?",confirmClearAll:"Clear All Results",clearAllText:"This will delete all recorded entries. This action cannot be undone.",confirmUndoAdd:"Undo Recording",confirmUndoAddText:"This will delete the recorded entry. Continue?",delete:"Delete",cancel:"Cancel",close:"Close",back:"Back",save:"Save",edit:"Edit",undo:"Undo",export:"Export",clearAll:"Clear All",selectAll:"Select All",deleteSelected:"Delete Selected",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Synced from cloud",raceId:"Race ID",invalidRaceId:"Invalid Race ID. Use letters, numbers, hyphens, underscores only.",deviceName:"Time Keeper ID",cloudSync:"Cloud Sync",syncStatus:"Sync Status",pendingSync:"pending sync",saved:"Saved",deleted:"Deleted",cleared:"All entries cleared",undone:"Undone",copied:"Copied to clipboard",debugInfoCopied:"Debug info copied to clipboard",debugInfoCopyFailed:"Tap and hold to copy debug info",duplicateWarning:"Duplicate entry detected",zeroBibWarning:"Bib 000 - verify entry",exported:"Exported successfully",gps:"GPS",gpsActive:"GPS Active",gpsSearching:"Searching for GPS...",gpsInactive:"GPS Inactive",gpsAccuracy:"Accuracy",simpleMode:"Simple Mode",fullMode:"Full Mode",autoIncrement:"Auto-increment Bib",hapticFeedback:"Haptic Feedback",soundFeedback:"Sound Feedback",language:"Language",simpleModeDesc:"Simplified interface for basic timing",cloudSyncDesc:"Sync with other devices",gpsDesc:"Use GPS for accurate timestamps",autoIncrementDesc:"Increase bib number after recording",photoCaptureDesc:"Capture photo on timestamp",hapticFeedbackDesc:"Vibration on actions",soundFeedbackDesc:"Audio confirmation",ambientMode:"Ambient Mode",ambientModeDesc:"Auto-dim after 30s inactivity",photoCapture:"Photo Capture",photoCaptured:"Photo captured",photoError:"Photo capture failed",photoSaveFailed:"Photo storage failed",viewPhoto:"View Photo",deletePhoto:"Delete Photo",photoFor:"Photo for Bib",noPhotoAvailable:"No photo available",photoDeleted:"Photo deleted",raceChangeTitle:"Change Race",raceChangeSyncedText:"You have results from another race. Export or delete them before switching?",raceChangeUnsyncedText:"You have existing results. Keep them or delete before switching?",keepResults:"Keep",version:"Version",devices:"Devices",entries:"entries",selected:"selected",raceFound:"Race found",raceNew:"New race",entryInCloud:"entry in cloud",entriesInCloud:"entries in cloud",photoTooLarge:"Photo too large for sync",syncedEntriesFromCloud:"Synced {count} entries from cloud",syncedFaultsFromCloud:"Synced {count} faults from cloud",crossDeviceDuplicate:"Duplicate: Bib {bib} {point} already recorded by {device}",syncPhotos:"Sync Photos",syncPhotosDesc:"Share photos across devices via cloud",syncPhotosWarning:"Enable Photo Sync",syncPhotosWarningText:"Enabling photo sync will transfer the following data:",photosToUpload:"Photos to upload",photosToDownload:"Photos to download",totalDataVolume:"Total data volume",enableSync:"Enable Sync",noPhotosToSync:"No photos to sync",admin:"Admin",adminPin:"Race Management PIN",adminPinDesc:"Required to manage and sync races",manageRaces:"Manage Races",manageRacesDesc:"View and delete synced races",manage:"Manage",enterAdminPin:"Enter Race Management PIN",enterPinText:"Enter your PIN to access race management.",enterPinToJoinRace:"Enter your PIN to join this race.",enterPinForChiefJudge:"Enter your PIN to access Chief Judge mode.",enterChiefJudgePin:"Enter Chief Judge PIN",enterPinForChiefJudgeInfo:"Chief Judge mode requires a separate PIN. First use sets the PIN.",syncRequiresPin:"Sync disabled. Enable sync and enter PIN to reconnect.",incorrectPin:"Incorrect PIN",verify:"Verify",setPinFirst:"Please set a Race Management PIN first",pinSaved:"PIN saved",pinCleared:"PIN cleared",pinNotSet:"Not set",pinSet:"PIN set",setPin:"Set PIN",changePin:"Change PIN",currentPin:"Current PIN",newPin:"New PIN (4 digits)",confirmPin:"Confirm PIN",pinMismatch:"PINs do not match",pinFormatError:"PIN must be exactly 4 digits",loading:"Loading...",noRaces:"No active races",noRacesHint:"Create one in Settings",cleanRunHint:"Clean run so far",refresh:"Refresh",raceDeleted:"Race Deleted",raceDeletedText:"This race has been deleted by an administrator.",raceDeletedFor:"Race deleted:",raceDeletedSuccess:"Race deleted:",confirmDeleteRace:"Delete Race",confirmDeleteRaceText:"Are you sure you want to delete race",loadError:"Failed to load races. Check your connection and try again.",deleteError:"Failed to delete race",entry:"entry",device:"device",storageError:"Failed to save data - check storage",storageQuotaError:"Storage full! Export data immediately",storageWarning:"Storage almost full",networkError:"Network error - check connection",connectionFailed:"Connection failed",serverUnavailable:"Server unavailable",rateLimitError:"Too many requests - please wait",authError:"Authentication failed. Try re-entering your PIN.",syncFailed:"Sync failed",pinSyncFailed:"PIN not synced to cloud",cameraError:"Camera error",cameraPermissionDenied:"Camera access denied",gpsError:"GPS error",gpsPermissionDenied:"GPS access denied",gpsUnavailable:"GPS unavailable",unknownError:"Unknown error",onboardingWelcome:"Welcome to Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronized timing for ski races",getStarted:"Get Started",onboardingRole:"What's Your Role?",onboardingRoleDesc:"Choose how you'll be helping at the race",roleTimerTitle:"Timer",roleTimerDesc:"Record start and finish times",roleJudgeTitle:"Gate Judge",roleJudgeDesc:"Record gate faults (Torrichter)",onboardingDeviceName:"Name Your Timer",onboardingDeviceNameDesc:"This identifies your device when syncing",onboardingDeviceNameJudge:"Your Name",onboardingDeviceNameJudgeDesc:"This identifies you as the gate judge",onboardingPhoto:"Photo Documentation",onboardingPhotoDesc:"Automatically capture a photo when recording each timestamp. Useful for verifying bib numbers and resolving disputes.",enablePhotoCapture:"Enable Photo Capture",photoCaptureLabel:"Photo Capture",onboardingGates:"Your Gate Assignment",onboardingGatesDesc:"Enter the gate numbers you'll be watching. You can change this later.",onboardingRaceSetup:"Join a Race",onboardingRaceSetupDesc:"Enter a race ID to sync with other timers",skipForNow:"Skip for now",onboardingReady:"Ready to Time!",onboardingReadyJudge:"Ready to Judge!",onboardingTip:"Tap the big blue button to record timestamps",onboardingTipJudge:"Tap a racer's bib to record a fault",startTiming:"Start Timing",startJudging:"Start Judging",continue:"Continue",deviceNameLabel:"Device Name",raceIdLabel:"Race ID",syncStatusLabel:"Cloud Sync",enabled:"Enabled",disabled:"Disabled",showTutorial:"Show Tutorial",showTutorialDesc:"Run the setup wizard again",show:"Show",onboardingComplete:"Setup complete!",invalidPin:"PIN must be 4 digits",recentRaces:"Recent Races",noRecentRaces:"No races from today",errorOccurred:"Something went wrong",errorRecoveryMessage:"The app encountered an error. You can dismiss this and continue, or reload the app.",dismiss:"Dismiss",reload:"Reload",updateAvailable:"Update available! Reload to get the latest version.",operationFailed:"Operation failed. Please try again.",raceIdPlaceholder:"RACE-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Photo for bib",gateJudge:"Gate Judge",gateJudgeTab:"Gate",deviceRole:"Device Role",deviceRoleDesc:"Timer records times, Gate Judge records faults",roleTimer:"Timer",roleGateJudge:"Gate Judge",gateAssignment:"Gate Assignment",gates:"Gates",gatesFrom:"From",gatesTo:"To",firstGateColor:"Color of first gate",colorRed:"Red",colorBlue:"Blue",changeGates:"Change",otherJudges:"Other judges:",activeBibs:"On Course",noBibsOnCourse:"No racers on course",recordFault:"Record Fault",faultType:"Fault Type",faultMG:"Missed Gate",faultSTR:"Straddling",faultBR:"Binding Release",faultMGShort:"MG",faultSTRShort:"STR",faultBRShort:"BR",orEnterManually:"or enter:",faultRecorded:"Fault recorded",signalReady:"Ready",judgeReady:"Ready for race!",judgeNotReady:"Ready status cleared",faultDeleted:"Fault deleted",recordedFaults:"Recorded Faults",selectBib:"Select Bib",selectGate:"Gate",gate:"Gate",noFaults:"No faults recorded",faultsFor:"Faults for",faultSummary:"Fault Summary",penaltyTime:"Penalty",faultCount:"faults",markOk:"Mark OK",saveFault:"Save Fault",selectFaultType:"Please select a fault type",gateOutOfRange:"Gate is outside assigned range",flt:"FLT",statusFlt:"Fault Penalty",chiefJudge:"Chief Judge",noFaultsRecorded:"No faults recorded",finalize:"Finalize",finalized:"Finalized",chiefJudgeMode:"Chief Judge Mode",chiefJudgeModeEnabled:"Chief Judge mode enabled",chiefJudgeModeDisabled:"Chief Judge mode disabled",racersWithFaults:"Racers with faults",penaltyMode:"+Time",gateJudges:"Gate Judges",noJudgesConnected:"No gate judges connected",summary:"Summary",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"No faults to export",copiedToClipboard:"Copied to clipboard",gateJudgeCard:"Gate Judge Card",race:"Race",date:"Date",gateJudgeLabel:"Gate Judge",runLabel:"Run",noFaultsEntered:"No faults entered",signature:"Signature",legend:"Legend",missedGateLegend:"Missed",straddlingLegend:"Straddling",bindingLegend:"Binding",gateFaults:"Gate Faults",penaltyLabel:"PENALTY",faultSummaryTitle:"GATE FAULT SUMMARY",faults:"Faults",penalty:"Penalty",sec:"sec",generated:"Generated",editFault:"Edit Fault",versionHistory:"Version History",restoreVersion:"Restore Selected Version",currentVersion:"Current",originalVersion:"Original",restored:"Restored",versionRestored:"Version restored",markForDeletion:"Mark for Deletion",markForDeletionText:"This fault will be marked for deletion and requires Chief Judge approval to permanently delete.",markedForDeletion:"Marked for deletion",deletionPending:"Deletion pending",pendingDeletions:"Pending Deletions",approveDeletion:"Approve Deletion",rejectDeletion:"Reject Deletion",deletionMarkedBy:"Marked by",deletionApproved:"Deletion approved",deletionRejected:"Deletion rejected",cannotEditPendingDeletion:"Cannot edit fault pending deletion",voiceMode:"Voice Mode",voiceModeDesc:"Hands-free voice commands (requires internet)",voiceListening:"Listening...",voiceProcessing:"Processing...",voiceConfirming:"Confirm?",voiceOffline:"Voice unavailable offline",voiceNotSupported:"Voice not supported in this browser",voicePermissionDenied:"Microphone access denied",voiceOK:"OK",voiceRecorded:"Recorded",voiceNotUnderstood:"Not understood",voiceCancelled:"Cancelled",voiceError:"Voice error",voiceApiKeyRequired:"API key required for voice mode"},de:{timer:"Timer",results:"Ergebnisse",settings:"Einstellungen",start:"Start",finish:"Ziel",bib:"Startnummer",point:"Punkt",run:"Lauf",run1:"L1",run2:"L2",time:"Zeit erfassen",lastRecorded:"Zuletzt erfasst",lastRecordedShort:"Letzter:",advancedSettings:"Erweiterte Einstellungen",status:"Status",noEntries:"Keine Einträge vorhanden",noEntriesHint:"Zeiten im Timer-Tab aufnehmen",search:"Startnr. suchen...",filter:"Filter",all:"Alle",total:"Gesamt",racers:"Fahrer",finished:"Im Ziel",fastest:"Schnellste",average:"Durchschnitt",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Eintrag löschen",confirmDeleteText:"Möchten Sie diesen Eintrag wirklich löschen?",confirmDeleteFault:"Diesen Fehler löschen?",confirmClearAll:"Alle löschen",clearAllText:"Alle Einträge werden gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.",confirmUndoAdd:"Erfassung rückgängig",confirmUndoAddText:"Der erfasste Eintrag wird gelöscht. Fortfahren?",delete:"Löschen",cancel:"Abbrechen",close:"Schließen",back:"Zurück",save:"Speichern",edit:"Bearbeiten",undo:"Rückgängig",export:"Exportieren",clearAll:"Alle löschen",selectAll:"Alle auswählen",deleteSelected:"Ausgewählte löschen",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Von Cloud synchronisiert",raceId:"Rennen-ID",invalidRaceId:"Ungültige Rennen-ID. Nur Buchstaben, Zahlen, Bindestriche, Unterstriche.",deviceName:"Zeitnehmer-ID",cloudSync:"Cloud-Sync",syncStatus:"Sync-Status",pendingSync:"ausstehend",saved:"Gespeichert",deleted:"Gelöscht",cleared:"Alle Einträge gelöscht",undone:"Rückgängig gemacht",copied:"In Zwischenablage kopiert",debugInfoCopied:"Debug-Info in Zwischenablage kopiert",debugInfoCopyFailed:"Lange drücken um Debug-Info zu kopieren",duplicateWarning:"Doppelter Eintrag erkannt",zeroBibWarning:"Startnr. 000 - Eintrag prüfen",exported:"Erfolgreich exportiert",gps:"GPS",gpsActive:"GPS Aktiv",gpsSearching:"GPS wird gesucht...",gpsInactive:"GPS Inaktiv",gpsAccuracy:"Genauigkeit",simpleMode:"Einfacher Modus",fullMode:"Erweiterter Modus",autoIncrement:"Startnr. automatisch",hapticFeedback:"Vibration",soundFeedback:"Signalton",language:"Sprache",simpleModeDesc:"Vereinfachte Oberfläche für einfache Zeitmessung",cloudSyncDesc:"Mit anderen Geräten synchronisieren",gpsDesc:"GPS für genaue Zeitstempel verwenden",autoIncrementDesc:"Startnummer nach Erfassung erhöhen",photoCaptureDesc:"Foto bei Zeiterfassung aufnehmen",hapticFeedbackDesc:"Vibration bei Aktionen",soundFeedbackDesc:"Akustische Bestätigung",ambientMode:"Ruhemodus",ambientModeDesc:"Nach 30s Inaktivität abdunkeln",photoCapture:"Foto aufnehmen",photoCaptured:"Foto aufgenommen",photoError:"Foto-Aufnahme fehlgeschlagen",photoSaveFailed:"Foto-Speicherung fehlgeschlagen",viewPhoto:"Foto anzeigen",deletePhoto:"Foto löschen",photoFor:"Foto für Startnr.",noPhotoAvailable:"Kein Foto verfügbar",photoDeleted:"Foto gelöscht",raceChangeTitle:"Rennen wechseln",raceChangeSyncedText:"Es gibt Ergebnisse von einem anderen Rennen. Exportieren oder löschen?",raceChangeUnsyncedText:"Es gibt bestehende Ergebnisse. Behalten oder löschen?",keepResults:"Behalten",version:"Version",devices:"Geräte",entries:"Einträge",selected:"ausgewählt",raceFound:"Rennen gefunden",raceNew:"Neues Rennen",entryInCloud:"Eintrag in der Cloud",entriesInCloud:"Einträge in der Cloud",photoTooLarge:"Foto zu groß für Sync",syncedEntriesFromCloud:"{count} Einträge aus Cloud synchronisiert",syncedFaultsFromCloud:"{count} Torfehler aus Cloud synchronisiert",crossDeviceDuplicate:"Duplikat: Startnr. {bib} {point} bereits von {device} erfasst",syncPhotos:"Fotos synchronisieren",syncPhotosDesc:"Fotos über Cloud mit anderen Geräten teilen",syncPhotosWarning:"Foto-Sync aktivieren",syncPhotosWarningText:"Aktivierung der Foto-Synchronisierung überträgt folgende Daten:",photosToUpload:"Fotos hochzuladen",photosToDownload:"Fotos herunterzuladen",totalDataVolume:"Gesamtes Datenvolumen",enableSync:"Sync aktivieren",noPhotosToSync:"Keine Fotos zu synchronisieren",admin:"Admin",adminPin:"Rennverwaltungs-PIN",adminPinDesc:"Erforderlich für Verwaltung und Sync",manageRaces:"Rennen verwalten",manageRacesDesc:"Synchronisierte Rennen anzeigen und löschen",manage:"Verwalten",enterAdminPin:"Rennverwaltungs-PIN eingeben",enterPinText:"Geben Sie Ihre PIN ein, um die Rennverwaltung zu öffnen.",enterPinToJoinRace:"Geben Sie Ihre PIN ein, um diesem Rennen beizutreten.",enterPinForChiefJudge:"Geben Sie Ihre PIN ein, um die Obmann-Ansicht zu öffnen.",enterChiefJudgePin:"Obmann-PIN eingeben",enterPinForChiefJudgeInfo:"Der Obmann-Modus erfordert eine separate PIN. Erste Eingabe setzt die PIN.",syncRequiresPin:"Sync deaktiviert. Aktivieren Sie Sync und geben Sie die PIN ein.",incorrectPin:"Falsche PIN",verify:"Bestätigen",setPinFirst:"Bitte zuerst Rennverwaltungs-PIN festlegen",pinSaved:"PIN gespeichert",pinCleared:"PIN gelöscht",pinNotSet:"Nicht gesetzt",pinSet:"PIN gesetzt",setPin:"PIN setzen",changePin:"PIN ändern",currentPin:"Aktuelle PIN",newPin:"Neue PIN (4 Ziffern)",confirmPin:"PIN bestätigen",pinMismatch:"PINs stimmen nicht überein",pinFormatError:"PIN muss genau 4 Ziffern haben",loading:"Laden...",noRaces:"Keine aktiven Rennen",noRacesHint:"In Einstellungen erstellen",cleanRunHint:"Bisher fehlerfreie Fahrt",refresh:"Aktualisieren",raceDeleted:"Rennen gelöscht",raceDeletedText:"Dieses Rennen wurde von einem Administrator gelöscht.",raceDeletedFor:"Rennen gelöscht:",raceDeletedSuccess:"Rennen gelöscht:",confirmDeleteRace:"Rennen löschen",confirmDeleteRaceText:"Möchten Sie das Rennen wirklich löschen",loadError:"Fehler beim Laden der Rennen. Verbindung prüfen und erneut versuchen.",deleteError:"Fehler beim Löschen des Rennens",entry:"Eintrag",device:"Gerät",storageError:"Speichern fehlgeschlagen - Speicher prüfen",storageQuotaError:"Speicher voll! Daten sofort exportieren",storageWarning:"Speicher fast voll",networkError:"Netzwerkfehler - Verbindung prüfen",connectionFailed:"Verbindung fehlgeschlagen",serverUnavailable:"Server nicht erreichbar",rateLimitError:"Zu viele Anfragen - bitte warten",authError:"Authentifizierung fehlgeschlagen. PIN erneut eingeben.",syncFailed:"Synchronisierung fehlgeschlagen",pinSyncFailed:"PIN nicht in Cloud gespeichert",cameraError:"Kamerafehler",cameraPermissionDenied:"Kamerazugriff verweigert",gpsError:"GPS-Fehler",gpsPermissionDenied:"GPS-Zugriff verweigert",gpsUnavailable:"GPS nicht verfügbar",unknownError:"Unbekannter Fehler",onboardingWelcome:"Willkommen bei Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronisierte Zeitmessung für Skirennen",getStarted:"Los geht's",onboardingRole:"Was ist deine Aufgabe?",onboardingRoleDesc:"Wähle aus, wie du beim Rennen hilfst",roleTimerTitle:"Zeitnehmer",roleTimerDesc:"Start- und Zielzeiten erfassen",roleJudgeTitle:"Torrichter",roleJudgeDesc:"Torfehler erfassen",onboardingDeviceName:"Timer benennen",onboardingDeviceNameDesc:"Dieser Name identifiziert dein Gerät beim Synchronisieren",onboardingDeviceNameJudge:"Dein Name",onboardingDeviceNameJudgeDesc:"Dies identifiziert dich als Torrichter",onboardingPhoto:"Foto-Dokumentation",onboardingPhotoDesc:"Automatisch ein Foto bei jeder Zeiterfassung aufnehmen. Nützlich zur Überprüfung von Startnummern und bei Unstimmigkeiten.",enablePhotoCapture:"Foto-Aufnahme aktivieren",photoCaptureLabel:"Foto-Aufnahme",onboardingGates:"Deine Tor-Zuweisung",onboardingGatesDesc:"Gib die Tornummern ein, die du beobachtest. Du kannst dies später ändern.",onboardingRaceSetup:"Rennen beitreten",onboardingRaceSetupDesc:"Gib eine Rennen-ID ein um mit anderen Timern zu synchronisieren",skipForNow:"Vorerst überspringen",onboardingReady:"Bereit zur Zeitmessung!",onboardingReadyJudge:"Bereit als Torrichter!",onboardingTip:"Tippe auf den großen blauen Button um Zeiten zu erfassen",onboardingTipJudge:"Tippe auf eine Startnummer um einen Fehler zu erfassen",startTiming:"Zeitmessung starten",startJudging:"Starten",continue:"Weiter",deviceNameLabel:"Gerätename",raceIdLabel:"Rennen-ID",syncStatusLabel:"Cloud-Sync",enabled:"Aktiviert",disabled:"Deaktiviert",showTutorial:"Tutorial anzeigen",showTutorialDesc:"Setup-Assistenten erneut starten",show:"Anzeigen",onboardingComplete:"Einrichtung abgeschlossen!",invalidPin:"PIN muss 4 Ziffern haben",recentRaces:"Letzte Rennen",noRecentRaces:"Keine Rennen von heute",errorOccurred:"Ein Fehler ist aufgetreten",errorRecoveryMessage:"Die App hat einen Fehler festgestellt. Sie können diesen Hinweis schließen und fortfahren, oder die App neu laden.",dismiss:"Schließen",reload:"Neu laden",updateAvailable:"Update verfügbar! Neu laden für die neueste Version.",operationFailed:"Vorgang fehlgeschlagen. Bitte erneut versuchen.",raceIdPlaceholder:"RENNEN-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Foto für Startnr.",gateJudge:"Torrichter",gateJudgeTab:"Tor",deviceRole:"Geräte-Rolle",deviceRoleDesc:"Timer erfasst Zeiten, Torrichter erfasst Fehler",roleTimer:"Zeitnehmer",roleGateJudge:"Torrichter",gateAssignment:"Tor-Zuweisung",gates:"Tore",gatesFrom:"Von",gatesTo:"Bis",firstGateColor:"Farbe des ersten Tors",colorRed:"Rot",colorBlue:"Blau",changeGates:"Ändern",otherJudges:"Andere Torrichter:",activeBibs:"Auf der Strecke",noBibsOnCourse:"Keine Fahrer auf der Strecke",recordFault:"Fehler erfassen",faultType:"Fehlerart",faultMG:"Tor ausgelassen",faultSTR:"Einfädler",faultBR:"Bindung offen",faultMGShort:"TF",faultSTRShort:"EF",faultBRShort:"BO",orEnterManually:"oder eingeben:",faultRecorded:"Fehler erfasst",signalReady:"Bereit",judgeReady:"Bereit für Rennen!",judgeNotReady:"Bereit-Status zurückgesetzt",faultDeleted:"Fehler gelöscht",recordedFaults:"Erfasste Fehler",selectBib:"Startnr. wählen",selectGate:"Tor",gate:"Tor",noFaults:"Keine Fehler erfasst",faultsFor:"Fehler für",faultSummary:"Fehler-Übersicht",penaltyTime:"Strafzeit",faultCount:"Fehler",markOk:"OK markieren",saveFault:"Fehler speichern",selectFaultType:"Bitte Fehlerart wählen",gateOutOfRange:"Tor liegt außerhalb des zugewiesenen Bereichs",flt:"STR",statusFlt:"Strafzeit",chiefJudge:"Obmann",noFaultsRecorded:"Keine Fehler erfasst",finalize:"Bestätigen",finalized:"Bestätigt",chiefJudgeMode:"Obmann-Ansicht",chiefJudgeModeEnabled:"Obmann-Ansicht aktiviert",chiefJudgeModeDisabled:"Obmann-Ansicht deaktiviert",racersWithFaults:"Fahrer mit Fehlern",penaltyMode:"+Zeit",gateJudges:"Torrichter",noJudgesConnected:"Keine Torrichter verbunden",summary:"Übersicht",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"Keine Fehler zum Exportieren",copiedToClipboard:"In Zwischenablage kopiert",gateJudgeCard:"Torrichterkarte",race:"Rennen",date:"Datum",gateJudgeLabel:"Torrichter",runLabel:"Lauf",noFaultsEntered:"Keine Fehler erfasst",signature:"Unterschrift",legend:"Legende",missedGateLegend:"Ausgelassen",straddlingLegend:"Einfädler",bindingLegend:"Bindung",gateFaults:"Torfehler",penaltyLabel:"STRAFZEIT",faultSummaryTitle:"ZUSAMMENFASSUNG TORFEHLER",faults:"Fehler",penalty:"Strafzeit",sec:"Sek",generated:"Erstellt",editFault:"Fehler bearbeiten",versionHistory:"Versionshistorie",restoreVersion:"Version wiederherstellen",currentVersion:"Aktuell",originalVersion:"Original",restored:"Wiederhergestellt",versionRestored:"Version wiederhergestellt",markForDeletion:"Zum Löschen markieren",markForDeletionText:"Dieser Fehler wird zum Löschen markiert und benötigt die Genehmigung des Obmanns für die endgültige Löschung.",markedForDeletion:"Zum Löschen markiert",deletionPending:"Löschung ausstehend",pendingDeletions:"Ausstehende Löschungen",approveDeletion:"Löschung genehmigen",rejectDeletion:"Löschung ablehnen",deletionMarkedBy:"Markiert von",deletionApproved:"Löschung genehmigt",deletionRejected:"Löschung abgelehnt",cannotEditPendingDeletion:"Fehler mit ausstehender Löschung kann nicht bearbeitet werden",voiceMode:"Sprachsteuerung",voiceModeDesc:"Freihändige Sprachbefehle (Internet erforderlich)",voiceListening:"Höre zu...",voiceProcessing:"Verarbeite...",voiceConfirming:"Bestätigen?",voiceOffline:"Sprache offline nicht verfügbar",voiceNotSupported:"Spracheingabe in diesem Browser nicht unterstützt",voicePermissionDenied:"Mikrofonzugriff verweigert",voiceOK:"OK",voiceRecorded:"Erfasst",voiceNotUnderstood:"Nicht verstanden",voiceCancelled:"Abgebrochen",voiceError:"Sprachfehler",voiceApiKeyRequired:"API-Schlüssel für Sprachsteuerung erforderlich"}};function d(n,e="de"){return cn[e][n]||cn.en[n]||n}const _={CRITICAL:"critical",ERROR:"error",WARNING:"warning",INFO:"info"},Ae={CRITICAL:8e3,ERROR:5e3,WARNING:4e3,INFO:3e3};function Ni(n){return`[${n.component}] ${n.operation}`}function $i(n){return n instanceof Error?n.message:typeof n=="string"?n:"Unknown error"}function Ot(n){const e=Ni(n),t=n.error?$i(n.error):"No error details",i={code:n.code,message:t,timestamp:new Date().toISOString(),...n.metadata};switch(n.severity){case _.CRITICAL:case _.ERROR:console.error(`${e}:`,t,i);break;case _.WARNING:console.warn(`${e}:`,t,i);break;case _.INFO:console.log(`${e}:`,t,i);break}if(n.userMessageKey){const s=c.getState().currentLang,r=d(n.userMessageKey,s),a=Mi(n.severity),o=Ae[n.severity.toUpperCase()]||Ae.ERROR;E(r,a,o)}n.severity===_.CRITICAL&&window.dispatchEvent(new CustomEvent("critical-error",{detail:n}))}function Mi(n){switch(n){case _.CRITICAL:case _.ERROR:return"error";case _.WARNING:return"warning";case _.INFO:return"info";default:return"error"}}function at(n,e,t,i){Ot({component:n,operation:e,severity:_.ERROR,error:t,userMessageKey:i})}function Rt(n,e,t,i){Ot({component:n,operation:e,severity:_.WARNING,error:t,userMessageKey:i})}function Hi(n,e,t,i){Ot({component:n,operation:e,severity:_.CRITICAL,error:t,userMessageKey:i})}const Vi=1e4;class Oi extends Error{constructor(e,t){super(`Request to ${e} timed out after ${t}ms`),this.name="FetchTimeoutError"}}async function J(n,e={},t=Vi){const i=new AbortController,s=setTimeout(()=>i.abort(),t);try{return await fetch(n,{...e,signal:i.signal})}catch(r){throw r instanceof Error&&r.name==="AbortError"?new Oi(n,t):r}finally{clearTimeout(s)}}const vt=new Map;function m(n){return vt.has(n)||vt.set(n,document.getElementById(n)),vt.get(n)}const ln={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},zi=.8,Ve=1280,Oe=720,dn=200;class Gi{constructor(){h(this,"stream",null);h(this,"videoElement",null);h(this,"canvasElement",null);h(this,"cameraState","stopped");h(this,"visibilityHandler",null);h(this,"pendingVisibilityChange",null);h(this,"previewElement",null);h(this,"ownsVideoElement",!1)}async initialize(){if(this.cameraState==="ready")return!0;if(this.cameraState==="initializing")return!1;this.cameraState="initializing";try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not available");return this.previewElement?(this.videoElement=this.previewElement,this.ownsVideoElement=!1):(this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.ownsVideoElement=!0),this.canvasElement=document.createElement("canvas"),this.canvasElement.width=Ve,this.canvasElement.height=Oe,this.stream=await navigator.mediaDevices.getUserMedia(ln),this.videoElement.srcObject=this.stream,await new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))}),this.pendingVisibilityChange==="hidden"?(this.pendingVisibilityChange=null,this.pauseCamera(),!1):(this.cameraState="ready",c.setCameraReady(!0),this.visibilityHandler||(this.visibilityHandler=()=>this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.visibilityHandler)),!0)}catch(e){const t=e instanceof Error?e.message:"Camera initialization failed";return p.error("Camera initialization error:",t),this.cameraState="stopped",c.setCameraReady(!1,t),!1}}handleVisibilityChange(){document.hidden?this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange="hidden":this.cameraState==="ready"&&this.pauseCamera():this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange=null:this.cameraState==="paused"&&this.reinitializeCamera()}pauseCamera(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.videoElement&&(this.videoElement.srcObject=null)),this.cameraState="paused",c.setCameraReady(!1)}async reinitializeCamera(){if(this.cameraState!=="resuming"){this.cameraState="resuming";try{if(this.videoElement||(this.previewElement?(this.videoElement=this.previewElement,this.ownsVideoElement=!1):(this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.ownsVideoElement=!0)),this.stream=await navigator.mediaDevices.getUserMedia(ln),this.videoElement.srcObject=this.stream,await new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))}),this.pendingVisibilityChange==="hidden"){this.pendingVisibilityChange=null,this.pauseCamera();return}this.cameraState="ready",c.setCameraReady(!0)}catch(e){p.error("Failed to reinitialize camera:",e),this.cameraState="stopped"}}}async capturePhoto(){if(this.cameraState!=="ready"||!this.videoElement||!this.canvasElement)return p.warn("Camera not ready for capture"),null;try{const e=this.canvasElement.getContext("2d");if(!e)throw new Error("Could not get canvas context");const t=this.videoElement.videoWidth,i=this.videoElement.videoHeight;let s=t,r=i;if(s>Ve){const u=Ve/s;s=Ve,r=Math.round(r*u)}if(r>Oe){const u=Oe/r;r=Oe,s=Math.round(s*u)}this.canvasElement.width=s,this.canvasElement.height=r,e.drawImage(this.videoElement,0,0,s,r);const a=new Date().toISOString();e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,r-30,s,30),e.fillStyle="#ffffff",e.font="14px monospace",e.fillText(a,10,r-10);const l=this.canvasElement.toDataURL("image/jpeg",zi).split(",")[1],g=Math.round(l.length/1024);if(g>dn){const u=new Error(`Photo too large (${g}KB > ${dn}KB limit)`);throw u.name="PhotoTooLargeError",u}return l}catch(e){return p.error("Photo capture error:",e),null}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null,this.ownsVideoElement&&(this.videoElement.remove(),this.videoElement=null)),this.canvasElement&&(this.canvasElement=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.pendingVisibilityChange=null,this.cameraState="stopped",c.setCameraReady(!1)}isReady(){return this.cameraState==="ready"}setPreviewElement(e){if(this.previewElement=e,!e){this.videoElement&&!this.ownsVideoElement&&(this.videoElement.srcObject=null,this.videoElement=null);return}this.videoElement!==e&&(this.videoElement&&this.ownsVideoElement&&this.videoElement.remove(),this.videoElement=e,this.ownsVideoElement=!1),this.stream&&(this.videoElement.srcObject=this.stream,this.videoElement.play().catch(()=>null))}getVideoElement(){return this.videoElement}getError(){return c.getState().cameraError}async toggle(e){return e?this.initialize():(this.stop(),!0)}}const fe=new Gi;async function Ui(){return!c.getState().settings.photoCapture||!fe.isReady()&&!await fe.initialize()?null:fe.capturePhoto()}const Ji="ski-timer-photos",_i=1,G="photos",qi=3,ji=5e3;class Wi{constructor(){h(this,"db",null);h(this,"initPromise",null);h(this,"saveQueue",[]);h(this,"activeSaves",0)}async initialize(){return this.initPromise?this.initPromise:(this.initPromise=new Promise(e=>{if(!window.indexedDB){p.warn("IndexedDB not supported - photo storage disabled"),e(!1);return}const t=indexedDB.open(Ji,_i);t.onerror=()=>{p.error("IndexedDB open error:",t.error),e(!1)},t.onsuccess=()=>{this.db=t.result,e(!0)},t.onupgradeneeded=i=>{const s=i.target.result;s.objectStoreNames.contains(G)||s.createObjectStore(G,{keyPath:"entryId"}).createIndex("timestamp","timestamp",{unique:!1})}}),this.initPromise)}async savePhoto(e,t){return new Promise(i=>{this.saveQueue.push({entryId:e,photoBase64:t,resolve:i}),this.processQueue()})}processQueue(){for(;this.saveQueue.length>0&&this.activeSaves<qi;){const e=this.saveQueue.shift();this.activeSaves++,this.doSavePhotoWithTimeout(e.entryId,e.photoBase64).then(t=>{e.resolve(t)}).catch(()=>{e.resolve(!1)}).finally(()=>{this.activeSaves--,this.processQueue()})}}async doSavePhotoWithTimeout(e,t){return Promise.race([this.doSavePhoto(e,t),new Promise((i,s)=>setTimeout(()=>s(new Error("Photo save timeout")),ji))])}async doSavePhoto(e,t){return!this.db&&!await this.initialize()?!1:new Promise(i=>{if(!this.db){i(!1);return}try{const r=this.db.transaction([G],"readwrite").objectStore(G),a={entryId:e,photo:t,timestamp:Date.now()},o=r.put(a);o.onsuccess=()=>{i(!0)},o.onerror=()=>{p.error("Photo save error:",o.error),i(!1)}}catch(s){p.error("Photo save transaction error:",s),i(!1)}})}async getPhoto(e){return!this.db&&!await this.initialize()?null:new Promise(t=>{if(!this.db){t(null);return}try{const r=this.db.transaction([G],"readonly").objectStore(G).get(e);r.onsuccess=()=>{const a=r.result;t((a==null?void 0:a.photo)||null)},r.onerror=()=>{p.error("Photo get error:",r.error),t(null)}}catch(i){p.error("Photo get transaction error:",i),t(null)}})}async deletePhoto(e){return!this.db&&!await this.initialize()?!1:new Promise(t=>{if(!this.db){t(!1);return}try{const r=this.db.transaction([G],"readwrite").objectStore(G).delete(e);r.onsuccess=()=>{t(!0)},r.onerror=()=>{p.error("Photo delete error:",r.error),t(!1)}}catch(i){p.error("Photo delete transaction error:",i),t(!1)}})}async hasPhoto(e){return await this.getPhoto(e)!==null}async clearAll(){return!this.db&&!await this.initialize()?!1:new Promise(e=>{if(!this.db){e(!1);return}try{const s=this.db.transaction([G],"readwrite").objectStore(G).clear();s.onsuccess=()=>{e(!0)},s.onerror=()=>{p.error("Photo clear error:",s.error),e(!1)}}catch(t){p.error("Photo clear transaction error:",t),e(!1)}})}async deletePhotos(e){for(const t of e)await this.deletePhoto(t)}async getStorageUsage(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{used:e.usage||0,quota:e.quota||0}}catch{return null}return null}async getPhotoCount(){return!this.db&&!await this.initialize()?0:new Promise(e=>{if(!this.db){e(0);return}try{const s=this.db.transaction([G],"readonly").objectStore(G).count();s.onsuccess=()=>{e(s.result)},s.onerror=()=>{e(0)}}catch{e(0)}})}close(){this.db&&(this.db.close(),this.db=null,this.initPromise=null)}}const V=new Wi,Yi=.2,Qi=.1;class Ki{constructor(){h(this,"battery",null);h(this,"isInitialized",!1);h(this,"callbacks",new Set);h(this,"currentStatus",{level:1,charging:!0,batteryLevel:"normal"});h(this,"levelChangeHandler",null);h(this,"chargingChangeHandler",null)}isSupported(){return"getBattery"in navigator}async initialize(){if(this.isInitialized)return!0;if(!this.isSupported())return!1;try{return this.battery=await navigator.getBattery(),this.isInitialized=!0,this.updateStatus(),this.levelChangeHandler=()=>this.updateStatus(),this.chargingChangeHandler=()=>this.updateStatus(),this.battery.addEventListener("levelchange",this.levelChangeHandler),this.battery.addEventListener("chargingchange",this.chargingChangeHandler),!0}catch(e){return p.warn("Failed to initialize battery service:",e),!1}}updateStatus(){if(!this.battery)return;const e=this.battery.level,t=this.battery.charging;let i="normal";t||(e<=Qi?i="critical":e<=Yi&&(i="low"));const s={level:e,charging:t,batteryLevel:i},r=this.currentStatus.level!==s.level||this.currentStatus.charging!==s.charging||this.currentStatus.batteryLevel!==s.batteryLevel;this.currentStatus=s,r&&this.notifySubscribers()}notifySubscribers(){for(const e of this.callbacks)try{e(this.currentStatus)}catch(t){p.error("Battery callback error:",t)}}subscribe(e){return this.callbacks.add(e),e(this.currentStatus),()=>{this.callbacks.delete(e)}}getStatus(){return{...this.currentStatus}}isLowBattery(){return this.currentStatus.batteryLevel==="low"||this.currentStatus.batteryLevel==="critical"}isCriticalBattery(){return this.currentStatus.batteryLevel==="critical"}isCharging(){return this.currentStatus.charging}getLevelPercent(){return Math.round(this.currentStatus.level*100)}cleanup(){this.battery&&(this.levelChangeHandler&&(this.battery.removeEventListener("levelchange",this.levelChangeHandler),this.levelChangeHandler=null),this.chargingChangeHandler&&(this.battery.removeEventListener("chargingchange",this.chargingChangeHandler),this.chargingChangeHandler=null),this.battery=null),this.callbacks.clear(),this.isInitialized=!1}}const Se=new Ki,Bn="skiTimerRecentRaces",Zi=10;function Fn(){try{const n=localStorage.getItem(Bn);return n?JSON.parse(n):[]}catch{return[]}}function zt(n,e,t){try{const i=Fn(),s=n.toLowerCase(),r=i.findIndex(o=>o.raceId.toLowerCase()===s);r>=0?(i[r].lastUpdated=e,t!==void 0&&(i[r].entryCount=t)):i.unshift({raceId:n,createdAt:Date.now(),lastUpdated:e,entryCount:t}),i.sort((o,l)=>l.lastUpdated-o.lastUpdated);const a=i.slice(0,Zi);localStorage.setItem(Bn,JSON.stringify(a))}catch(i){p.error("Failed to save recent race:",i)}}function Xe(n=5){const e=Fn(),t=new Date;t.setHours(0,0,0,0);const i=t.getTime();return e.filter(s=>s.createdAt>=i||s.lastUpdated>=i).slice(0,n)}const Fe="skiTimerAuthToken";function j(){const n=localStorage.getItem(Fe);return n?{Authorization:`Bearer ${n}`}:{}}function ne(){return!!localStorage.getItem(Fe)}function Xi(n){localStorage.setItem(Fe,n)}function Nn(){localStorage.removeItem(Fe)}async function $n(n,e){try{const t=await fetch("/api/v1/auth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:n,role:e})}),i=await t.json();return t.ok?i.token?(Xi(i.token),{success:!0,token:i.token,isNewPin:i.isNewPin}):{success:!1,error:"No token received"}:{success:!1,error:i.error||"Authentication failed"}}catch(t){return p.error("Token exchange error:",t),{success:!1,error:"Network error"}}}function es(n="Session expired. Please re-enter your PIN."){window.dispatchEvent(new CustomEvent("auth-expired",{detail:{message:n}}))}const Ie="/api/v1/sync",bt="/api/v1/faults",un=5e3,gn=3e4,ts=5,ns=2e3,is=1e4,ie=8e3,ss=[5e3,1e4,15e3,2e4,3e4],fn=6,hn=[1e4,2e4,3e4,45e3,6e4],mn=[3e4,45e3,6e4],pn=3,rs=[1e4,15e3,2e4,3e4],as=1e4;class os{constructor(){h(this,"pollInterval",null);h(this,"queueInterval",null);h(this,"broadcastChannel",null);h(this,"consecutiveErrors",0);h(this,"lastSyncTimestamp",0);h(this,"isProcessingQueue",!1);h(this,"visibilityHandler",null);h(this,"wasPollingBeforeHidden",!1);h(this,"wasQueueProcessingBeforeHidden",!1);h(this,"consecutiveNoChanges",0);h(this,"currentIdleLevel",0);h(this,"currentBatteryLevel","normal");h(this,"batteryUnsubscribe",null);h(this,"isAdjustingInterval",!1);h(this,"isMeteredConnection",!1);h(this,"networkChangeHandler",null);h(this,"onlineHandler",null);h(this,"offlineHandler",null);h(this,"otherGateAssignments",[])}initialize(){const e=c.getState();if(!e.settings.sync||!e.raceId){this.cleanup();return}this.initBroadcastChannel(e.raceId),this.startPolling(),this.startQueueProcessor(),this.pushLocalEntries(),this.pushLocalFaults(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(this.wasPollingBeforeHidden=this.pollInterval!==null,this.wasQueueProcessingBeforeHidden=this.queueInterval!==null,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null)):(this.wasPollingBeforeHidden&&this.startPolling(),this.wasQueueProcessingBeforeHidden&&this.startQueueProcessor())},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.visibilityHandler()),this.batteryUnsubscribe||Se.initialize().then(()=>{this.batteryUnsubscribe=Se.subscribe(t=>{const i=this.currentBatteryLevel;this.currentBatteryLevel=t.batteryLevel,i!==t.batteryLevel&&this.pollInterval&&this.applyBatteryAwarePolling()})}),this.initNetworkMonitoring(),this.onlineHandler||(this.onlineHandler=()=>{c.getState().syncStatus==="offline"&&(c.setSyncStatus("connecting"),this.startPolling())},window.addEventListener("online",this.onlineHandler)),this.offlineHandler||(this.offlineHandler=()=>{c.setSyncStatus("offline")},window.addEventListener("offline",this.offlineHandler)),navigator.onLine?c.setSyncStatus("connecting"):c.setSyncStatus("offline")}initBroadcastChannel(e){try{this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(`ski-timer-${e}`),this.broadcastChannel.onmessage=t=>{const{type:i,data:s}=t.data;if(i==="entry"&&be(s))c.mergeCloudEntries([s]);else if(i==="presence"){const r=s;c.addConnectedDevice(r)}}}catch(t){p.warn("BroadcastChannel not supported:",t)}}broadcastEntry(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"entry",data:e})}catch(t){p.error("Broadcast error:",t)}}broadcastPresence(){const e=c.getState();if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"presence",data:{id:e.deviceId,name:e.deviceName,lastSeen:Date.now()}})}catch(t){p.error("Presence broadcast error:",t)}}initNetworkMonitoring(){const e=navigator.connection;e&&(this.updateNetworkState(e),this.networkChangeHandler||(this.networkChangeHandler=()=>{const t=this.isMeteredConnection;this.updateNetworkState(e),t!==this.isMeteredConnection&&this.pollInterval&&this.applyBatteryAwarePolling()},e.addEventListener("change",this.networkChangeHandler)))}updateNetworkState(e){this.isMeteredConnection=e.saveData===!0||e.type==="cellular"||e.effectiveType==="slow-2g"||e.effectiveType==="2g"}startPolling(){this.pollInterval&&clearInterval(this.pollInterval),this.fetchCloudEntries();const e=this.consecutiveErrors>2?gn:un;this.pollInterval=setInterval(()=>this.fetchCloudEntries(),e)}getPollingConfig(){return this.currentBatteryLevel==="critical"?{intervals:mn,threshold:pn,baseInterval:mn[0]}:this.isMeteredConnection?{intervals:rs,threshold:fn,baseInterval:as}:this.currentBatteryLevel==="low"?{intervals:hn,threshold:pn,baseInterval:hn[0]}:{intervals:ss,threshold:fn,baseInterval:un}}setPollingInterval(e){this.pollInterval&&clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),e)}applyBatteryAwarePolling(){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{const e=this.getPollingConfig();this.currentIdleLevel=Math.min(this.currentIdleLevel,e.intervals.length-1);const t=this.consecutiveNoChanges<e.threshold?e.baseInterval:e.intervals[this.currentIdleLevel];this.setPollingInterval(t)}finally{this.isAdjustingInterval=!1}}}adjustPollingInterval(e,t=!1){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{if(!e){this.consecutiveErrors++,this.consecutiveErrors>2&&this.pollInterval&&this.setPollingInterval(gn);return}this.consecutiveErrors=0;const i=this.getPollingConfig();if(t)this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval&&this.setPollingInterval(i.baseInterval);else if(this.consecutiveNoChanges++,this.consecutiveNoChanges>=i.threshold){const s=Math.min(this.currentIdleLevel+1,i.intervals.length-1);s!==this.currentIdleLevel&&(this.currentIdleLevel=s,this.pollInterval&&this.setPollingInterval(i.intervals[this.currentIdleLevel]))}}finally{this.isAdjustingInterval=!1}}}resetToFastPolling(){if(this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval){const e=this.getPollingConfig();this.setPollingInterval(e.baseInterval)}}async processCloudPhotos(e){const t=c.getState(),i=[];for(const s of e)s.photo&&s.photo!=="indexeddb"&&s.photo.length>20?t.settings.syncPhotos?await V.savePhoto(s.id,s.photo)?i.push({...s,photo:"indexeddb"}):(p.warn("Sync: Photo storage failed for entry:",s.id),i.push({...s,photo:void 0})):i.push({...s,photo:void 0}):i.push(s);return i}async fetchCloudEntries(){const e=c.getState();if(!e.settings.sync||!e.raceId)return;const t=e.syncStatus;(t==="connected"||t==="connecting")&&c.setSyncStatus("syncing");try{const i=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),s=await J(`${Ie}?${i}`,{headers:j()},ie);if(s.status===401){let u;try{u=await s.json()}catch{u={}}if(u.expired){Nn(),c.setSyncStatus("disconnected"),es(),this.cleanup();return}throw new Error(`HTTP ${s.status}: ${u.error||"Unauthorized"}`)}if(!s.ok)throw new Error(`HTTP ${s.status}`);let r;try{r=await s.json()}catch{throw new Error("Invalid response format")}if(!r||typeof r!="object")throw new Error("Invalid data structure");if(r.deleted){window.dispatchEvent(new CustomEvent("race-deleted",{detail:{raceId:e.raceId,deletedAt:r.deletedAt,message:r.message}})),this.cleanup();return}const o=(Array.isArray(r.entries)?r.entries:[]).filter(u=>be(u)?!0:(p.warn("Skipping invalid entry from cloud:",u),!1)),l=Array.isArray(r.deletedIds)?r.deletedIds.filter(u=>typeof u=="string"&&u.length>0):[];c.setSyncStatus("connected"),typeof r.deviceCount=="number"&&c.setCloudDeviceCount(r.deviceCount),typeof r.highestBib=="number"&&c.setCloudHighestBib(r.highestBib);let g=!1;if(l.length>0&&(c.removeDeletedCloudEntries(l),g=!0),o.length>0){const u=await this.processCloudPhotos(o),f=c.mergeCloudEntries(u,l);if(f>0){g=!0;const y=c.getState().currentLang;this.showSyncToast(d("syncedEntriesFromCloud",y).replace("{count}",String(f)))}}this.lastSyncTimestamp=r.lastUpdated||Date.now(),e.raceId&&zt(e.raceId,this.lastSyncTimestamp,o.length),await this.fetchCloudFaults(),this.adjustPollingInterval(!0,g)}catch(i){p.error("Cloud sync fetch error:",i);const s=i instanceof Error?i.message:"Unknown error";(i instanceof Error?i.name:"")==="FetchTimeoutError"||s.includes("timed out")||s.includes("500")||s.includes("503")?c.setSyncStatus("error"):s.includes("Failed to fetch")||s.includes("NetworkError")?c.setSyncStatus("offline"):c.setSyncStatus("error"),this.adjustPollingInterval(!1)}}async deleteEntryFromCloud(e,t){const i=c.getState();if(!i.settings.sync||!i.raceId)return!1;try{const s=await J(`${Ie}?raceId=${encodeURIComponent(i.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json",...j()},body:JSON.stringify({entryId:e,deviceId:t||i.deviceId,deviceName:i.deviceName})},ie);if(!s.ok)throw new Error(`HTTP ${s.status}`);return!0}catch(s){return p.error("Cloud sync delete error:",s),!1}}async sendEntryToCloud(e){const t=c.getState();if(!t.settings.sync||!t.raceId)return!1;try{let i={...e};if(t.settings.syncPhotos&&e.photo==="indexeddb"){const r=await V.getPhoto(e.id);r?i={...e,photo:r}:i={...e,photo:void 0}}else e.photo&&(i={...e,photo:void 0});const s=await J(`${Ie}?raceId=${encodeURIComponent(t.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json",...j()},body:JSON.stringify({entry:i,deviceId:t.deviceId,deviceName:t.deviceName})},ie);if(!s.ok)throw new Error(`HTTP ${s.status}`);try{const r=await s.json(),a=c.getState().currentLang;if(r.photoSkipped&&this.showSyncToast(d("photoTooLarge",a),"warning"),r.crossDeviceDuplicate){const o=r.crossDeviceDuplicate,l=ce(o.point,a);this.showSyncToast(d("crossDeviceDuplicate",a).replace("{bib}",o.bib).replace("{point}",l).replace("{device}",o.deviceName),"warning",5e3),window.dispatchEvent(new CustomEvent("cross-device-duplicate",{detail:o}))}typeof r.deviceCount=="number"&&c.setCloudDeviceCount(r.deviceCount),typeof r.highestBib=="number"&&c.setCloudHighestBib(r.highestBib)}catch{}return c.removeFromSyncQueue(e.id),this.resetToFastPolling(),!0}catch(i){return p.error("Cloud sync send error:",i),!1}}async pushLocalEntries(){const e=c.getState();if(!(!e.settings.sync||!e.raceId))for(const t of e.entries)t.deviceId===e.deviceId&&!t.syncedAt&&await this.sendEntryToCloud(t)}startQueueProcessor(){this.queueInterval&&clearInterval(this.queueInterval),this.queueInterval=setInterval(()=>this.processQueue(),is)}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{const e=c.getState();if(!e.settings.sync||!e.raceId||e.syncQueue.length===0)return;const t=Date.now();for(const i of e.syncQueue){if(i.retryCount>=ts){p.warn("Max retries exceeded for entry:",i.entry.id),c.removeFromSyncQueue(i.entry.id);continue}const s=ns*Math.pow(2,i.retryCount);if(t-i.lastAttempt<s)continue;await this.sendEntryToCloud(i.entry)||c.updateSyncQueueItem(i.entry.id,{retryCount:i.retryCount+1,lastAttempt:t,error:"Failed to sync"})}}finally{this.isProcessingQueue=!1}}}showSyncToast(e,t="success",i){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:e,type:t,duration:i}}))}cleanup(){if(this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null),this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasPollingBeforeHidden=!1,this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.networkChangeHandler){const e=navigator.connection;e&&e.removeEventListener("change",this.networkChangeHandler),this.networkChangeHandler=null}this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.offlineHandler&&(window.removeEventListener("offline",this.offlineHandler),this.offlineHandler=null),this.consecutiveErrors=0,this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.currentBatteryLevel="normal",this.isMeteredConnection=!1,c.setSyncStatus("disconnected")}async forceRefresh(){await this.fetchCloudEntries()}getQueueLength(){return c.getState().syncQueue.length}getLastSyncTime(){return this.lastSyncTimestamp}async checkRaceExists(e){if(!e)return{exists:!1,entryCount:0};try{const t=await J(`${Ie}?raceId=${encodeURIComponent(e)}&checkOnly=true`,{headers:j()},5e3);if(!t.ok)return{exists:!1,entryCount:0};const i=await t.json();return{exists:i.exists===!0,entryCount:typeof i.entryCount=="number"?i.entryCount:0}}catch(t){return p.error("Check race exists error:",t),{exists:!1,entryCount:0}}}async getPhotoSyncStats(){const e=c.getState();let t=0,i=0,s=0,r=0;for(const a of e.entries)if(a.photo==="indexeddb"&&a.deviceId===e.deviceId){const o=await V.getPhoto(a.id);o&&(t++,i+=o.length)}if(e.settings.sync&&e.raceId)try{const a=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),o=await J(`${Ie}?${a}`,{headers:j()},ie);if(o.ok){const l=await o.json(),g=Array.isArray(l.entries)?l.entries:[];for(const u of g)if(u.photo&&u.photo!=="indexeddb"&&u.photo.length>20&&u.deviceId!==e.deviceId){const f=e.entries.find(y=>y.id===u.id&&y.deviceId===u.deviceId);(!f||!f.photo)&&(s++,r+=u.photo.length)}}}catch(a){p.warn("Failed to fetch cloud entries for photo stats:",a)}return{uploadCount:t,uploadSize:i,downloadCount:s,downloadSize:r,totalSize:i+r}}async fetchCloudFaults(){const e=c.getState();if(!(!e.settings.sync||!e.raceId))try{const t=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName});e.deviceRole==="gateJudge"&&e.gateAssignment&&(t.set("gateStart",String(e.gateAssignment[0])),t.set("gateEnd",String(e.gateAssignment[1])),t.set("isReady",String(e.isJudgeReady)),t.set("firstGateColor",e.firstGateColor));const i=await J(`${bt}?${t}`,{headers:j()},ie);if(!i.ok){if(i.status===401)return;throw new Error(`HTTP ${i.status}`)}const s=await i.json();if(!s||typeof s!="object")throw new Error("Invalid fault data structure");const r=Array.isArray(s.faults)?s.faults:[],a=Array.isArray(s.deletedIds)?s.deletedIds.filter(o=>typeof o=="string"):[];if(a.length>0&&c.removeDeletedCloudFaults(a),r.length>0){const o=c.mergeFaultsFromCloud(r,a);if(o>0){const l=c.getState().currentLang;this.showSyncToast(d("syncedFaultsFromCloud",l).replace("{count}",String(o)))}}Array.isArray(s.gateAssignments)&&this.updateGateAssignments(s.gateAssignments)}catch(t){p.error("Fault sync fetch error:",t)}}async sendFaultToCloud(e){const t=c.getState();if(!t.settings.sync||!t.raceId)return!1;try{const i=await J(`${bt}?raceId=${encodeURIComponent(t.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json",...j()},body:JSON.stringify({fault:e,deviceId:t.deviceId,deviceName:t.deviceName,gateRange:t.gateAssignment,isReady:t.isJudgeReady,firstGateColor:t.firstGateColor})},ie);if(!i.ok)throw new Error(`HTTP ${i.status}`);return c.markFaultSynced(e.id),this.resetToFastPolling(),!0}catch(i){return p.error("Fault sync send error:",i),!1}}async deleteFaultFromCloud(e,t,i){const s=c.getState();if(!s.settings.sync||!s.raceId)return!1;try{const r=await J(`${bt}?raceId=${encodeURIComponent(s.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json",...j()},body:JSON.stringify({faultId:e,deviceId:t||s.deviceId,deviceName:s.deviceName,approvedBy:i||s.deviceName})},ie);if(!r.ok)throw new Error(`HTTP ${r.status}`);return!0}catch(r){return p.error("Fault sync delete error:",r),!1}}async pushLocalFaults(){const e=c.getState();if(!(!e.settings.sync||!e.raceId))for(const t of e.faultEntries)t.deviceId===e.deviceId&&!t.syncedAt&&await this.sendFaultToCloud(t)}updateGateAssignments(e){const t=c.getState();this.otherGateAssignments=e.filter(i=>i.deviceId!==t.deviceId)}getOtherGateAssignments(){return this.otherGateAssignments}}const D=new os;async function le(n){const e=c.getState();e.settings.sync&&e.raceId&&await D.sendFaultToCloud(n)}async function Gt(n){return D.deleteFaultFromCloud(n.id,n.deviceId,n.deletionApprovedBy)}const St={enableHighAccuracy:!0,timeout:1e4,maximumAge:1e3},cs=10,ls=30;class ds{constructor(){h(this,"watchId",null);h(this,"lastPosition",null);h(this,"visibilityHandler",null);h(this,"wasActiveBeforeHidden",!1)}start(){if(this.watchId!==null)return!0;if(!navigator.geolocation)return p.error("Geolocation not supported"),c.setGpsStatus("inactive"),!1;c.setGpsStatus("searching");try{return this.watchId=navigator.geolocation.watchPosition(e=>this.handlePosition(e),e=>this.handleError(e),St),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(this.wasActiveBeforeHidden=this.watchId!==null,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null,c.setGpsStatus("inactive"))):this.wasActiveBeforeHidden&&(c.setGpsStatus("searching"),this.watchId=navigator.geolocation.watchPosition(e=>this.handlePosition(e),e=>this.handleError(e),St))},document.addEventListener("visibilitychange",this.visibilityHandler)),!0}catch(e){return p.error("Failed to start GPS:",e),c.setGpsStatus("inactive"),!1}}pause(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.wasActiveBeforeHidden=!1,c.setGpsStatus(this.lastPosition?"paused":"inactive")}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasActiveBeforeHidden=!1,this.lastPosition=null,c.setGpsStatus("inactive")}handlePosition(e){this.lastPosition=e;const t=e.coords.accuracy;c.setGpsStatus("active",t)}handleError(e){switch(p.error("GPS error:",e.message),e.code){case e.PERMISSION_DENIED:c.setGpsStatus("inactive"),this.stop();break;case e.POSITION_UNAVAILABLE:c.setGpsStatus("searching");break;case e.TIMEOUT:c.setGpsStatus("searching");break}}getPosition(){return this.lastPosition}getCoordinates(){if(this.lastPosition)return{latitude:this.lastPosition.coords.latitude,longitude:this.lastPosition.coords.longitude,accuracy:this.lastPosition.coords.accuracy}}getTimestamp(){var e;return((e=this.lastPosition)==null?void 0:e.timestamp)??null}getAccuracyStatus(){if(!this.lastPosition)return"unknown";const e=this.lastPosition.coords.accuracy;return e<=cs?"good":e<=ls?"fair":"poor"}isActive(){return this.watchId!==null&&this.lastPosition!==null}toggle(e){return e?this.start():(this.stop(),!0)}async requestPosition(){return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{this.lastPosition=t,e(t)},()=>e(null),St)}):null}}const he=new ds;class us{constructor(){h(this,"wakeLock",null);h(this,"isEnabled",!1);h(this,"visibilityHandler",null)}isSupported(){return"wakeLock"in navigator}async enable(){return this.isSupported()?this.isEnabled?!0:(this.isEnabled=!0,this.visibilityHandler||(this.visibilityHandler=()=>{!document.hidden&&this.isEnabled&&!this.wakeLock&&this.requestWakeLock()},document.addEventListener("visibilitychange",this.visibilityHandler)),this.requestWakeLock()):!1}async disable(){this.isEnabled=!1,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),await this.releaseWakeLock()}async requestWakeLock(){if(!this.isSupported()||this.wakeLock)return!!this.wakeLock;try{return this.wakeLock=await navigator.wakeLock.request("screen"),this.wakeLock.addEventListener("release",()=>{this.wakeLock=null}),!0}catch(e){const t=e instanceof Error?e.message:"Unknown error";return p.warn("Wake Lock request failed:",t),this.wakeLock=null,!1}}async releaseWakeLock(){if(this.wakeLock){try{await this.wakeLock.release()}catch(e){p.warn("Wake Lock release error:",e)}this.wakeLock=null}}isActive(){return this.wakeLock!==null}isWakeLockEnabled(){return this.isEnabled}}const et=new us;class gs{constructor(){h(this,"isInitialized",!1);h(this,"isEnabled",!1);h(this,"isAmbientActive",!1);h(this,"triggeredBy",null);h(this,"lastActivityTimestamp",Date.now());h(this,"animationFrameId",null);h(this,"batteryUnsubscribe",null);h(this,"callbacks",new Set);h(this,"activityHandler",null);h(this,"INACTIVITY_THRESHOLD_MS",3e4)}initialize(){this.isInitialized||(this.isInitialized=!0,this.batteryUnsubscribe=Se.subscribe(e=>{e.batteryLevel==="critical"&&!e.charging&&this.isEnabled&&this.enterAmbientMode("battery"),e.charging&&this.isAmbientActive&&this.triggeredBy==="battery"&&this.exitAmbientMode()}),this.activityHandler=()=>this.resetInactivityTimer(),document.addEventListener("touchstart",this.activityHandler,{passive:!0}),document.addEventListener("click",this.activityHandler,{passive:!0}),document.addEventListener("keydown",this.activityHandler,{passive:!0}))}cleanup(){this.disable(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.activityHandler&&(document.removeEventListener("touchstart",this.activityHandler),document.removeEventListener("click",this.activityHandler),document.removeEventListener("keydown",this.activityHandler),this.activityHandler=null),this.callbacks.clear(),this.isInitialized=!1}enable(){this.isEnabled||(this.isEnabled=!0,this.lastActivityTimestamp=Date.now(),this.startInactivityMonitor(),Se.isCriticalBattery()&&this.enterAmbientMode("battery"))}disable(){this.isEnabled&&(this.isEnabled=!1,this.stopInactivityMonitor(),this.isAmbientActive&&this.exitAmbientMode())}isActive(){return this.isAmbientActive}getState(){return{isActive:this.isAmbientActive,triggeredBy:this.triggeredBy}}subscribe(e){return this.callbacks.add(e),e(this.getState()),()=>{this.callbacks.delete(e)}}exitAmbientMode(){this.isAmbientActive&&(this.isAmbientActive=!1,this.triggeredBy=null,this.lastActivityTimestamp=Date.now(),this.notifySubscribers(),p.debug("[Ambient] Exited ambient mode"))}resetInactivityTimer(){this.lastActivityTimestamp=Date.now(),this.isAmbientActive}enterAmbientMode(e){this.isAmbientActive||!this.isEnabled||(this.isAmbientActive=!0,this.triggeredBy=e,this.notifySubscribers(),p.debug(`[Ambient] Entered ambient mode (trigger: ${e})`))}startInactivityMonitor(){if(this.animationFrameId!==null)return;const e=()=>{if(!this.isEnabled){this.animationFrameId=null;return}Date.now()-this.lastActivityTimestamp>=this.INACTIVITY_THRESHOLD_MS&&!this.isAmbientActive&&this.enterAmbientMode("inactivity"),this.animationFrameId=requestAnimationFrame(e)};this.animationFrameId=requestAnimationFrame(e)}stopInactivityMonitor(){this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}notifySubscribers(){const e=this.getState();for(const t of this.callbacks)try{t(e)}catch(i){p.error("[Ambient] Callback error:",i)}}}const z=new gs;let Et=null;function Mn(){if(!Et)try{Et=new(window.AudioContext||window.webkitAudioContext)}catch(n){return p.warn("AudioContext not available:",n),null}return Et}function Ne(n){if(c.getState().settings.haptic&&navigator.vibrate)try{navigator.vibrate(n)}catch(t){p.warn("Vibration failed:",t)}}function ot(n=880,e=100){if(!c.getState().settings.sound)return;const i=Mn();if(i)try{const s=i.createOscillator(),r=i.createGain();s.connect(r),r.connect(i.destination),s.frequency.value=n,s.type="sine",r.gain.setValueAtTime(.3,i.currentTime),r.gain.exponentialRampToValueAtTime(.01,i.currentTime+e/1e3),s.start(i.currentTime),s.stop(i.currentTime+e/1e3)}catch(s){p.warn("Sound playback failed:",s)}}function H(){Ne(40),ot(880,100)}function F(){Ne([60,40,60]),ot(440,200)}function I(){Ne(30)}function ct(){Ne([40,30,40]),ot(330,150)}function Hn(){Ne([35,35]),ot(660,100)}async function yn(){const n=Mn();if(n&&n.state==="suspended")try{await n.resume()}catch(e){p.warn("Failed to resume audio:",e)}}class fs{constructor(){h(this,"synth",null);h(this,"voice",null);h(this,"voicesLoaded",!1);typeof window<"u"&&"speechSynthesis"in window&&(this.synth=window.speechSynthesis,this.loadVoices())}isSupported(){return this.synth!==null}loadVoices(){if(!this.synth)return;this.synth.getVoices().length>0?(this.voicesLoaded=!0,this.selectVoiceForLanguage(c.getState().currentLang)):this.synth.addEventListener("voiceschanged",()=>{this.voicesLoaded=!0,this.selectVoiceForLanguage(c.getState().currentLang)},{once:!0})}selectVoiceForLanguage(e){if(!this.synth)return;const t=this.synth.getVoices(),i=e==="de"?"de":"en";this.voice=t.find(s=>s.lang.startsWith(i)&&s.name.toLowerCase().includes("female"))||t.find(s=>s.lang.startsWith(i))||t.find(s=>s.lang.startsWith("en"))||null,this.voice&&p.debug("[SpeechSynthesis] Selected voice:",this.voice.name,this.voice.lang)}setLanguage(e){this.voicesLoaded&&this.selectVoiceForLanguage(e)}speak(e,t){return new Promise((i,s)=>{if(!this.synth){s(new Error("Speech synthesis not supported"));return}this.synth.cancel();const r=new SpeechSynthesisUtterance(e);this.voice&&(r.voice=this.voice),r.rate=(t==null?void 0:t.rate)??1.1,r.pitch=(t==null?void 0:t.pitch)??1,r.volume=1,r.onend=()=>i(),r.onerror=a=>{a.error==="interrupted"?i():(p.warn("[SpeechSynthesis] Error:",a.error),s(new Error(a.error)))},this.synth.speak(r)})}sayOK(){return this.speak("OK",{rate:1.2})}sayRecorded(){const t=c.getState().currentLang==="de"?"Erfasst":"Recorded";return this.speak(t,{rate:1.1})}sayNotUnderstood(){const t=c.getState().currentLang==="de"?"Nicht verstanden":"Not understood";return this.speak(t,{rate:1})}cancel(){var e;(e=this.synth)==null||e.cancel()}}const X=new fs,hs=`You are a voice command processor for a ski race timing app.
Parse the user's spoken command and return a structured JSON response.

Context provided:
- role: "timer" (sets bib/point/run) or "gateJudge" (records faults)
- language: User's language (de/en)
- activeBibs: Racers currently on course (gate judge only)
- gateRange: Gates this judge is watching [start, end]
- pendingConfirmation: If set, user is responding to a confirmation prompt

For TIMER role, recognize:
- Bib numbers: spoken digits or number words (e.g., "forty-five" = 45, "fünfundvierzig" = 45)
- Timing point: "Start" / "Ziel" / "Finish"
- Run selection: "Lauf 1/2", "Run 1/2", "erster Lauf", "zweiter Lauf"
NOTE: Timer role does NOT support recording timestamps via voice (latency too high for timing)

For GATE JUDGE role, recognize:
- Fault recording with bib + gate + type
- Fault types: MG (missed gate/ausgelassen), STR (straddling/eingefädelt), BR (binding release/Bindung offen)
- Ready status: "Bereit", "Ready", "Fertig"
- Confirmation: "Ja", "Yes", "Correct", "Richtig", "Stimmt"
- Cancellation: "Nein", "No", "Cancel", "Abbrechen", "Falsch"

Return ONLY valid JSON (no markdown, no explanation):
{
  "action": "record_fault" | "set_bib" | "set_gate" | "set_point" | "set_run" | "toggle_ready" | "confirm" | "cancel" | "unknown",
  "confidence": 0.0-1.0,
  "params": {
    "bib": "string (3 digits, zero-padded)",
    "gate": number,
    "faultType": "MG" | "STR" | "BR",
    "point": "S" | "F",
    "run": 1 | 2
  },
  "confirmationNeeded": boolean,
  "confirmationPrompt": "string (spoken confirmation request in user's language)"
}

IMPORTANT:
- For gate judge faults, set confirmationNeeded=true with a clear prompt
- Confirmation prompts should be in the user's language
- If user tries to record time via voice, return action="unknown" (voice timing disabled)
- If unsure, set action="unknown" with low confidence`,ms={model:"claude-3-haiku-20240307",maxTokens:256};function ps(n){return n.includes("/api/v1/voice")}async function ys(n,e,t){const{endpoint:i,apiKey:s,model:r,maxTokens:a}={...ms,...t};if(!i)throw new Error("LLM endpoint is required");if(ps(i))return vs(n,e,i);if(!s)throw new Error("API key is required for direct LLM calls");return bs(n,e,i,s,r,a)}async function vs(n,e,t){try{const i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcript:n,context:e})});if(!i.ok){const r=await i.text();throw p.error("[LLMProvider] Proxy error:",i.status,r),new Error(`Proxy error: ${i.status}`)}const s=await i.json();if(s.success&&s.intent)return p.debug("[LLMProvider] Proxy intent:",s.intent),s.intent;throw new Error("Invalid proxy response")}catch(i){return p.error("[LLMProvider] Proxy processing error:",i),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function bs(n,e,t,i,s,r){var l;const o=`Context: ${JSON.stringify({role:e.role,language:e.language,currentRun:e.currentRun,activeBibs:e.activeBibs,gateRange:e.gateRange,pendingConfirmation:e.pendingConfirmation?{action:e.pendingConfirmation.action,params:e.pendingConfirmation.params}:null})}

Transcript: "${n}"`;try{const g=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:s,max_tokens:r,system:hs,messages:[{role:"user",content:o}]})});if(!g.ok){const S=await g.text();throw p.error("[LLMProvider] API error:",g.status,S),new Error(`LLM API error: ${g.status}`)}const u=await g.json();let f="";if(u.content&&Array.isArray(u.content)?f=((l=u.content[0])==null?void 0:l.text)||"":typeof u.content=="string"&&(f=u.content),!f)throw new Error("Empty response from LLM");let y=f.trim();y.startsWith("```")&&(y=y.replace(/```json?\n?/g,"").replace(/```$/g,"").trim());const v=JSON.parse(y);if(!v.action||typeof v.confidence!="number")throw new Error("Invalid intent structure");return p.debug("[LLMProvider] Parsed intent:",v),v}catch(g){return p.error("[LLMProvider] Processing error:",g),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function Ss(n,e,t,i=5e3){const s=new Promise((r,a)=>{setTimeout(()=>a(new Error("LLM request timeout")),i)});return Promise.race([ys(n,e,t),s]).catch(r=>(p.warn("[LLMProvider] Timeout or error:",r),{action:"unknown",confidence:0,confirmationNeeded:!1}))}class Es{constructor(){h(this,"recognition",null);h(this,"llmConfig",null);h(this,"isEnabled",!1);h(this,"isOnline",typeof navigator<"u"?navigator.onLine:!0);h(this,"pendingIntent",null);h(this,"status","inactive");h(this,"confirmationTimeout",null);h(this,"restartTimeout",null);h(this,"stateCallbacks",new Set);h(this,"actionCallbacks",new Set);h(this,"CONFIRMATION_TIMEOUT_MS",1e4);h(this,"LLM_TIMEOUT_MS",5e3);h(this,"RESTART_DELAY_MS",100);h(this,"handleOnline",()=>{var e;if(this.isOnline=!0,this.isEnabled){this.setStatus("listening");try{(e=this.recognition)==null||e.start()}catch{}}});h(this,"handleOffline",()=>{var e;this.isOnline=!1,this.isEnabled&&(this.setStatus("offline"),(e=this.recognition)==null||e.stop())})}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(e){if(!this.isSupported())return p.warn("[Voice] Speech Recognition not supported"),!1;if(!X.isSupported())return p.warn("[Voice] Speech Synthesis not supported"),!1;this.llmConfig=e;const t=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new t,this.recognition.continuous=!0,this.recognition.interimResults=!1,this.updateRecognitionLanguage(),this.setupRecognitionHandlers(),window.addEventListener("online",this.handleOnline),window.addEventListener("offline",this.handleOffline),p.debug("[Voice] Initialized successfully"),!0}updateRecognitionLanguage(){if(!this.recognition)return;const e=c.getState().currentLang;this.recognition.lang=e==="de"?"de-DE":"en-US",X.setLanguage(e)}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{p.debug("[Voice] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{const t=e.results[e.resultIndex];if(t.isFinal){const i=t[0].transcript.trim();p.debug("[Voice] Transcript:",i),this.processTranscript(i)}},this.recognition.onerror=e=>{switch(p.warn("[Voice] Recognition error:",e.error),e.error){case"network":this.setStatus("offline");break;case"not-allowed":case"service-not-allowed":this.setStatus("error"),this.disable();break;case"no-speech":case"audio-capture":break;case"aborted":return;default:this.setStatus("error")}},this.recognition.onend=()=>{p.debug("[Voice] Recognition ended"),this.isEnabled&&this.isOnline&&this.status!=="error"&&this.scheduleRestart()})}scheduleRestart(){this.restartTimeout&&clearTimeout(this.restartTimeout),this.restartTimeout=setTimeout(()=>{var e;if(this.isEnabled&&this.isOnline)try{(e=this.recognition)==null||e.start()}catch{}},this.RESTART_DELAY_MS)}async processTranscript(e){if(!e||!this.llmConfig)return;this.setStatus("processing");const t=c.getState(),i={role:t.deviceRole,language:t.currentLang,currentRun:t.selectedRun,activeBibs:t.deviceRole==="gateJudge"?this.getActiveBibs(t.selectedRun):void 0,gateRange:t.gateAssignment||void 0,pendingConfirmation:this.pendingIntent||void 0};try{const s=await Ss(e,i,this.llmConfig,this.LLM_TIMEOUT_MS);await this.handleIntent(s)}catch(s){p.error("[Voice] Processing error:",s),this.setStatus("error"),await X.sayNotUnderstood(),this.setStatus("listening")}}getActiveBibs(e){const t=c.getState(),i=new Set,s=new Set;for(const r of t.entries)r.run===e&&(r.point==="S"?i.add(r.bib):r.point==="F"&&s.add(r.bib));return Array.from(i).filter(r=>!s.has(r))}async handleIntent(e){if(this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.pendingIntent&&(e.action==="confirm"||e.action==="cancel")){if(e.action==="confirm")this.executeIntent(this.pendingIntent),await X.sayRecorded();else{const t=c.getState().currentLang;await X.speak(t==="de"?"Abgebrochen":"Cancelled")}this.pendingIntent=null,this.setStatus("listening");return}if(e.action==="unknown"||e.confidence<.5){await X.sayNotUnderstood(),this.setStatus("listening");return}if(e.confirmationNeeded&&e.confirmationPrompt){this.pendingIntent=e,this.setStatus("confirming"),await X.speak(e.confirmationPrompt),this.confirmationTimeout=setTimeout(()=>{this.pendingIntent&&(p.debug("[Voice] Confirmation timeout"),this.pendingIntent=null,this.setStatus("listening"))},this.CONFIRMATION_TIMEOUT_MS);return}this.executeIntent(e),this.setStatus("listening")}executeIntent(e){p.debug("[Voice] Executing intent:",e.action);for(const t of this.actionCallbacks)t(e)}setStatus(e){if(this.status!==e){this.status=e;for(const t of this.stateCallbacks)t(e)}}enable(){if(!this.recognition||!this.llmConfig)return p.warn("[Voice] Not initialized"),!1;if(!this.isOnline)return this.setStatus("offline"),!1;this.isEnabled=!0,this.updateRecognitionLanguage();try{return this.recognition.start(),!0}catch(e){return p.warn("[Voice] Failed to start recognition:",e),this.setStatus("error"),!1}}disable(){var e;this.isEnabled=!1,this.pendingIntent=null,this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.stop()}catch{}X.cancel(),this.setStatus("inactive")}getStatus(){return this.status}isActive(){return this.isEnabled}onStatusChange(e){return this.stateCallbacks.add(e),()=>this.stateCallbacks.delete(e)}onAction(e){return this.actionCallbacks.add(e),()=>this.actionCallbacks.delete(e)}cleanup(){this.disable(),this.stateCallbacks.clear(),this.actionCallbacks.clear(),window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),this.recognition=null,this.llmConfig=null}}const K=new Es,vn=0,ws=1,Is=3;class Cs{constructor(e){h(this,"container");h(this,"timeElement");h(this,"dateElement");h(this,"dateRow");h(this,"lastTimeStr","");h(this,"animationId",null);h(this,"isRunning",!1);h(this,"visibilityHandler",null);h(this,"frameSkipCount",vn);h(this,"currentFrame",0);h(this,"batteryUnsubscribe",null);h(this,"tick",()=>{if(this.isRunning)try{if(this.currentFrame++,this.frameSkipCount===0||this.currentFrame%(this.frameSkipCount+1)===0){const t=new Date,i=oe(t);if(i!==this.lastTimeStr&&(this.updateDigits(i),this.lastTimeStr=i),t.getSeconds()===0||!this.dateElement.textContent){const r=c.getState();this.dateElement.textContent=Bi(t,r.currentLang)}}this.animationId=requestAnimationFrame(this.tick)}catch(e){p.error("Clock tick error:",e);try{this.animationId=requestAnimationFrame(this.tick)}catch(t){p.error("Clock RAF scheduling failed:",t),setTimeout(()=>{this.isRunning&&this.tick()},16)}}});this.container=e,this.container.innerHTML="",this.timeElement=this.createTimeElement(),this.dateRow=this.createDateRow(),this.dateElement=this.dateRow.querySelector(".clock-date"),this.container.appendChild(this.timeElement),this.container.appendChild(this.dateRow),this.moveTimingPointsToDateRow()}moveTimingPointsToDateRow(){const e=document.querySelector(".timing-controls");e&&this.dateRow&&this.dateRow.appendChild(e)}createTimeElement(){const e=document.createElement("div");e.className="clock-time",e.setAttribute("role","timer"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Current time"),e.style.cssText=`
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(32px, 10vw, 48px);
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      text-shadow: 0 0 40px rgba(56, 189, 248, 0.3);
    `;for(let t=0;t<12;t++){const i=document.createElement("span");i.className="clock-digit",i.dataset.index=String(t),e.appendChild(i)}return e}createDateRow(){const e=document.createElement("div");e.className="clock-date-row",e.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      padding: 0 8px;
      width: 100%;
    `;const t=document.createElement("div");return t.className="clock-date",t.style.cssText=`
      font-size: 0.875rem;
      color: var(--text-secondary);
    `,e.appendChild(t),e}start(){this.isRunning||(this.isRunning=!0,this.tick(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null):this.isRunning&&this.animationId===null&&this.tick()},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)),this.batteryUnsubscribe||Se.initialize().then(()=>{this.batteryUnsubscribe=Se.subscribe(e=>{this.updateFrameSkipFromBattery(e.batteryLevel)})}))}updateFrameSkipFromBattery(e){switch(this.frameSkipCount,e){case"critical":this.frameSkipCount=Is;break;case"low":this.frameSkipCount=ws;break;default:this.frameSkipCount=vn}}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null)}updateDigits(e){const t=this.timeElement.querySelectorAll(".clock-digit");for(let i=0;i<e.length&&i<t.length;i++){const s=t[i],r=e[i];s.textContent!==r&&(s.textContent=r,s.style.transform="scale(1.02)",requestAnimationFrame(()=>{s.style.transform="scale(1)"}))}}getCurrentTime(){return this.lastTimeStr}getTimestamp(){const e=he.getTimestamp();return e?new Date(e):new Date}destroy(){this.stop(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.container.innerHTML=""}}const de=72,ue=56,ge=72,bn=5,Ls=16,Ts=100;class ks{constructor(e){h(this,"container");h(this,"scrollContainer");h(this,"contentContainer");h(this,"entries",[]);h(this,"groups",[]);h(this,"expandedGroups",new Set);h(this,"visibleItems",new Map);h(this,"scrollTop",0);h(this,"containerHeight",0);h(this,"options");h(this,"unsubscribe",null);h(this,"resizeObserver",null);h(this,"scrollHandler",null);h(this,"scrollDebounceTimeout",null);h(this,"resizeDebounceTimeout",null);h(this,"isPaused",!1);h(this,"needsRefreshOnResume",!1);this.options=e,this.container=e.container,this.scrollContainer=document.createElement("div"),this.scrollContainer.className="virtual-scroll-container",this.scrollContainer.style.cssText=`
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    `,this.contentContainer=document.createElement("div"),this.contentContainer.className="virtual-scroll-content",this.contentContainer.style.position="relative",this.scrollContainer.appendChild(this.contentContainer),this.container.appendChild(this.scrollContainer),this.scrollHandler=()=>{this.scrollDebounceTimeout!==null&&clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=setTimeout(()=>{this.scrollDebounceTimeout=null;try{this.onScroll()}catch(t){p.error("VirtualList scroll error:",t)}},Ls)},this.scrollContainer.addEventListener("scroll",this.scrollHandler,{passive:!0}),this.resizeObserver=new ResizeObserver(()=>{this.resizeDebounceTimeout!==null&&clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=setTimeout(()=>{this.resizeDebounceTimeout=null;try{this.containerHeight=this.scrollContainer.clientHeight,this.render()}catch(t){p.error("VirtualList resize error:",t)}},Ts)}),this.resizeObserver.observe(this.scrollContainer),this.unsubscribe=c.subscribe((t,i)=>{(i.includes("entries")||i.includes("selectedEntries")||i.includes("faultEntries"))&&this.setEntries(t.entries)}),this.containerHeight=this.scrollContainer.clientHeight}setEntries(e){this.entries=e,this.applyFilters()}applyFilters(e,t,i){var o;const s=c.getState();let r=[...this.entries];if(e){const l=e.toLowerCase();r=r.filter(g=>{var u;return g.bib.toLowerCase().includes(l)||((u=g.deviceName)==null?void 0:u.toLowerCase().includes(l))})}t&&t!=="all"&&(r=r.filter(l=>l.point===t)),i&&i!=="all"&&(r=r.filter(l=>l.status===i));const a=new Map;for(const l of r){const g=l.run??1,u=`${l.bib}-${g}`;a.has(u)||a.set(u,{id:u,bib:l.bib,run:g,entries:[],faults:[],isMultiItem:!1,latestTimestamp:l.timestamp});const f=a.get(u);f.entries.push(l),new Date(l.timestamp)>new Date(f.latestTimestamp)&&(f.latestTimestamp=l.timestamp)}for(const l of s.faultEntries){const g=`${l.bib}-${l.run}`;if(e){const f=e.toLowerCase();if(!l.bib.toLowerCase().includes(f)&&!((o=l.deviceName)!=null&&o.toLowerCase().includes(f)))continue}if(t&&t!=="all"||i&&i!=="all"&&i!=="dsq"&&i!=="flt")continue;a.has(g)||a.set(g,{id:g,bib:l.bib,run:l.run,entries:[],faults:[],isMultiItem:!1,latestTimestamp:l.timestamp});const u=a.get(g);u.faults.push(l),new Date(l.timestamp)>new Date(u.latestTimestamp)&&(u.latestTimestamp=l.timestamp)}for(const l of a.values()){const g=l.entries.length+l.faults.length;l.isMultiItem=g>1}this.groups=Array.from(a.values()).sort((l,g)=>{const u=parseInt(l.bib,10)||0;return(parseInt(g.bib,10)||0)-u});for(const l of this.visibleItems.values())l.remove();this.visibleItems.clear(),this.updateContentHeight(),this.render()}toggleGroup(e){this.expandedGroups.has(e)?this.expandedGroups.delete(e):this.expandedGroups.add(e);for(const t of this.visibleItems.values())t.remove();this.visibleItems.clear(),this.updateContentHeight(),this.render()}updateContentHeight(){let e=0;for(const t of this.groups)if(!t.isMultiItem)e+=de;else if(this.expandedGroups.has(t.id)){const i=t.entries.length+t.faults.length;e+=ge+i*ue}else e+=ge;this.contentContainer.style.height=`${e}px`}getGroupPosition(e){let t=0;for(let i=0;i<e&&i<this.groups.length;i++)t+=this.getGroupHeight(this.groups[i]);return t}getGroupHeight(e){if(!e.isMultiItem)return de;if(this.expandedGroups.has(e.id)){const t=e.entries.length+e.faults.length;return ge+t*ue}return ge}onScroll(){this.scrollTop=this.scrollContainer.scrollTop,this.render()}render(){if(this.groups.length===0){this.renderEmpty();return}const e=this.contentContainer.querySelector(".empty-state");e&&e.remove(),c.getState();const t=new Set,i=this.scrollTop,s=this.scrollTop+this.containerHeight;let r=0;for(let a=0;a<this.groups.length;a++){const o=this.groups[a],l=this.getGroupHeight(o);r+l>=i-bn*de&&r<=s+bn*de&&(o.isMultiItem?this.expandedGroups.has(o.id)?this.renderExpandedGroup(o,r,t):this.renderCollapsedGroup(o,r,t):this.renderSingleItem(o,r,t)),r+=l}for(const[a,o]of this.visibleItems)t.has(a)||(o.remove(),this.visibleItems.delete(a))}renderSingleItem(e,t,i){const s=`single-${e.id}`;i.add(s);let r=this.visibleItems.get(s);if(!r){if(e.entries.length>0)r=this.createEntryItem(e.entries[0],e.faults);else if(e.faults.length>0)r=this.createFaultOnlyItem(e);else return;this.visibleItems.set(s,r),this.contentContainer.appendChild(r)}r.style.transform=`translateY(${t}px)`}renderCollapsedGroup(e,t,i){const s=`header-${e.id}`;i.add(s);let r=this.visibleItems.get(s);r||(r=this.createGroupHeader(e,!1),this.visibleItems.set(s,r),this.contentContainer.appendChild(r)),r.style.transform=`translateY(${t}px)`}renderExpandedGroup(e,t,i){const s=`header-${e.id}`;i.add(s);let r=this.visibleItems.get(s);r||(r=this.createGroupHeader(e,!0),this.visibleItems.set(s,r),this.contentContainer.appendChild(r)),r.style.transform=`translateY(${t}px)`;let a=t+ge;for(let o=0;o<e.entries.length;o++){const l=e.entries[o],g=`sub-entry-${l.id}`;i.add(g);let u=this.visibleItems.get(g);u||(u=this.createSubEntryItem(l),this.visibleItems.set(g,u),this.contentContainer.appendChild(u)),u.style.transform=`translateY(${a}px)`,a+=ue}for(let o=0;o<e.faults.length;o++){const l=e.faults[o],g=`sub-fault-${l.id}`;i.add(g);let u=this.visibleItems.get(g);u||(u=this.createSubFaultItem(l),this.visibleItems.set(g,u),this.contentContainer.appendChild(u)),u.style.transform=`translateY(${a}px)`,a+=ue}}createGroupHeader(e,t){const i=document.createElement("div");i.className=`result-group-header ${t?"expanded":""}`,i.setAttribute("data-group-id",e.id),i.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${ge}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 4px;
      gap: 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    `;const s=yt(e.bib||"---"),a=c.getState().currentLang,o=Le(e.run),l=Ce(e.run,a),g=e.entries.length,u=e.faults.length,f=u>0,y=[];g>0&&y.push(`${g} ${g===1?"time":"times"}`),u>0&&y.push(`${u} ${u===1?"fault":"faults"}`);const v=y.join(", "),S=`
      <svg class="group-chevron" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="flex-shrink: 0; transition: transform 0.2s; ${t?"transform: rotate(90deg);":""}">
        <path d="M9 18l6-6-6-6"/>
      </svg>
    `;return i.innerHTML=`
      ${S}
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 44px; text-align: right;">
        ${k(s)}
      </div>
      <div style="min-width: 48px;"></div>
      <span class="result-run" data-advanced style="padding: 4px 6px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; min-width: 36px; text-align: center; background: ${o}20; color: ${o};">${k(l)}</span>
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0;">
        <div class="result-summary" style="font-size: 0.875rem; color: var(--text-secondary);">
          ${k(v)}
        </div>
      </div>
      ${f?`
        <span class="result-fault-badge" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">
          ${u}× FLT
        </span>
      `:""}
    `,i.addEventListener("click",()=>{this.toggleGroup(e.id)}),i.addEventListener("touchstart",()=>{i.style.background="var(--surface-elevated)"},{passive:!0}),i.addEventListener("touchend",()=>{i.style.background="var(--surface)"},{passive:!0}),i}createEntryItem(e,t){const i=document.createElement("div");i.className="result-item",i.setAttribute("role","listitem"),i.setAttribute("data-entry-id",e.id),i.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${de}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 4px;
      gap: 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    `;const s=new Date(e.timestamp),r=oe(s),a=yt(e.bib||"---"),l=c.getState().currentLang,g=Re(e.point),u=ce(e.point,l),f=e.run??1,y=Le(f),v=Ce(f,l),C=t.length>0?`
      <span class="result-fault-badge" title="${k(t.map(L=>`T${L.gateNumber} (${L.faultType})`).join(", "))}" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">
        ${t.length>1?`${t.length}× FLT`:`T${t[0].gateNumber}`}
      </span>
    `:"";i.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 44px; text-align: right;">
        ${k(a)}
      </div>
      <div class="result-point" style="padding: 4px 6px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; min-width: 48px; text-align: center; background: ${g}20; color: ${g};">
        ${k(u)}
      </div>
      <span class="result-run" data-advanced style="padding: 4px 6px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; min-width: 36px; text-align: center; background: ${y}20; color: ${y};">${k(v)}</span>
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0;">
        <div class="result-time" style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); font-size: 0.875rem;">
          ${k(r)}
        </div>
        ${e.deviceName?`
          <div class="result-device" style="font-size: 0.7rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${k(e.deviceName)}
          </div>
        `:""}
      </div>
      ${C}
      ${e.status!=="ok"?`
        <span class="result-status" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--error); color: white;">
          ${k(e.status.toUpperCase())}
        </span>
      `:""}
      ${e.photo?`
        <button class="result-photo-btn" aria-label="View photo" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/>
            <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
          </svg>
        </button>
      `:""}
      <button class="result-edit-btn" aria-label="Edit entry" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; opacity: 0.7;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
      </button>
      <button class="result-delete" aria-label="Delete entry" style="background: none; border: none; color: var(--error); padding: 6px; cursor: pointer; opacity: 0.7;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    `,i.querySelector(".result-edit-btn").addEventListener("click",L=>{var T,x;L.stopPropagation(),(x=(T=this.options).onItemClick)==null||x.call(T,e,L)}),i.querySelector(".result-delete").addEventListener("click",L=>{var T,x;L.stopPropagation(),(x=(T=this.options).onItemDelete)==null||x.call(T,e)});const R=i.querySelector(".result-photo-btn");return R&&R.addEventListener("click",L=>{var T,x;L.stopPropagation(),(x=(T=this.options).onViewPhoto)==null||x.call(T,e)}),i.addEventListener("click",L=>{var T,x;(x=(T=this.options).onItemClick)==null||x.call(T,e,L)}),i.addEventListener("touchstart",()=>{i.style.background="var(--surface-elevated)"},{passive:!0}),i.addEventListener("touchend",()=>{i.style.background="var(--surface)"},{passive:!0}),i}createFaultOnlyItem(e){var w,R;const t=document.createElement("div"),i=e.faults,s=i.some(L=>L.markedForDeletion);t.className=`result-item fault-only-item${s?" marked-for-deletion":""}`,t.setAttribute("role","listitem"),t.setAttribute("data-fault-id",e.id),t.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${de}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 4px;
      gap: 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      border-left: 3px solid ${s?"var(--error)":"var(--warning)"};
      ${s?"opacity: 0.6;":""}
      cursor: pointer;
    `;const r=yt(e.bib||"---"),a=c.getState(),o=a.currentLang,l=Le(e.run),g=Ce(e.run,o),u=i.sort((L,T)=>L.gateNumber-T.gateNumber).map(L=>`T${L.gateNumber} (${L.faultType})${L.markedForDeletion?" ⚠":""}`).join(", "),f=`
      <span class="result-fault-badge" title="${k(u)}" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">
        ${i.length>1?`${i.length}× FLT`:`T${((w=i[0])==null?void 0:w.gateNumber)||"?"}`}
      </span>
    `,y=a.usePenaltyMode?d("flt",o):"DSQ",v=a.usePenaltyMode?"var(--warning)":"var(--error)",S=s?`
      <span class="deletion-pending-status" style="display: flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--error); color: white;">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M12 9v4M12 17h.01"/>
          <circle cx="12" cy="12" r="10"/>
        </svg>
        DEL
      </span>
    `:"";t.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 44px; text-align: right; ${s?"text-decoration: line-through; opacity: 0.6;":""}">
        ${k(r)}
      </div>
      <div class="result-point" style="padding: 4px 6px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; min-width: 48px; text-align: center; background: var(--warning)20; color: var(--warning);">
        ${d("gate",o)}
      </div>
      <span class="result-run" data-advanced style="padding: 4px 6px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; min-width: 36px; text-align: center; background: ${l}20; color: ${l};">${k(g)}</span>
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0;">
        <div class="result-fault-details" style="font-size: 0.8rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ${s?"text-decoration: line-through; opacity: 0.6;":""}">
          ${k(u)}
        </div>
        ${(R=i[0])!=null&&R.deviceName?`
          <div class="result-device" style="font-size: 0.7rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${k(i[0].deviceName)}
          </div>
        `:""}
      </div>
      ${S}
      ${s?"":f}
      ${s?"":`
        <span class="result-status" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: ${v}; color: ${v==="var(--warning)"?"#000":"white"};">
          ${k(y)}
        </span>
      `}
      <button class="result-edit-btn" aria-label="Edit fault" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; opacity: 0.7;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
      </button>
      <button class="result-delete fault-delete-btn" aria-label="Delete fault" style="background: none; border: none; color: var(--error); padding: 6px; cursor: pointer; opacity: 0.7;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    `;const C=t.querySelector(".result-edit-btn");C&&i.length>0&&C.addEventListener("click",L=>{L.stopPropagation();const T=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:i[0]}});t.dispatchEvent(T)});const b=t.querySelector(".fault-delete-btn");return b&&i.length>0&&b.addEventListener("click",L=>{L.stopPropagation();const T=new CustomEvent("fault-delete-request",{bubbles:!0,detail:{fault:i[0]}});t.dispatchEvent(T)}),t.addEventListener("click",L=>{const T=L.target;if(!(T.closest(".fault-delete-btn")||T.closest(".result-edit-btn"))&&i.length>0){const x=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:i[0]}});t.dispatchEvent(x)}}),t.addEventListener("touchstart",()=>{t.style.background="var(--surface-elevated)"},{passive:!0}),t.addEventListener("touchend",()=>{t.style.background="var(--surface)"},{passive:!0}),t}createSubEntryItem(e){const t=document.createElement("div");t.className="result-sub-item entry-sub-item",t.setAttribute("data-entry-id",e.id),t.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${ue}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 24px;
      gap: 8px;
      background: var(--surface-elevated);
      border-bottom: 1px solid var(--background);
      cursor: pointer;
      transition: background 0.2s;
    `;const i=new Date(e.timestamp),s=oe(i),a=c.getState().currentLang,o=Re(e.point),l=ce(e.point,a);return t.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div style="min-width: 44px;"></div>
      <div class="result-point" style="padding: 4px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; min-width: 48px; text-align: center; background: ${o}20; color: ${o};">
        ${k(l)}
      </div>
      <div style="min-width: 36px;"></div>
      <div class="result-info" style="flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0;">
        <div class="result-time" style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); font-size: 0.85rem;">
          ${k(s)}
        </div>
        ${e.deviceName?`
          <div class="result-device" style="font-size: 0.65rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${k(e.deviceName)}
          </div>
        `:""}
      </div>
      ${e.status!=="ok"?`
        <span class="result-status" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.65rem; font-weight: 600; background: var(--error); color: white;">
          ${k(e.status.toUpperCase())}
        </span>
      `:""}
      <button class="result-edit-btn" aria-label="Edit entry" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; opacity: 0.7;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
      </button>
      <button class="result-delete" aria-label="Delete entry" style="background: none; border: none; color: var(--error); padding: 6px; cursor: pointer; opacity: 0.7;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    `,t.querySelector(".result-edit-btn").addEventListener("click",f=>{var y,v;f.stopPropagation(),(v=(y=this.options).onItemClick)==null||v.call(y,e,f)}),t.querySelector(".result-delete").addEventListener("click",f=>{var y,v;f.stopPropagation(),(v=(y=this.options).onItemDelete)==null||v.call(y,e)}),t.addEventListener("click",f=>{var y,v;(v=(y=this.options).onItemClick)==null||v.call(y,e,f)}),t.addEventListener("touchstart",()=>{t.style.background="var(--surface)"},{passive:!0}),t.addEventListener("touchend",()=>{t.style.background="var(--surface-elevated)"},{passive:!0}),t}createSubFaultItem(e){const t=document.createElement("div"),i=e.markedForDeletion;t.className=`result-sub-item fault-sub-item${i?" marked-for-deletion":""}`,t.setAttribute("data-fault-id",e.id),t.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${ue}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 24px;
      gap: 8px;
      background: var(--surface-elevated);
      border-bottom: 1px solid var(--background);
      border-left: 3px solid ${i?"var(--error)":"var(--warning)"};
      ${i?"opacity: 0.6;":""}
      cursor: pointer;
      transition: background 0.2s;
    `,c.getState().currentLang;const r=c.getGateColor(e.gateNumber),a=r==="red"?"#ef4444":"#3b82f6";return t.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div style="min-width: 44px;"></div>
      <div class="result-point" style="padding: 4px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; min-width: 48px; text-align: center; background: var(--warning)20; color: var(--warning);">
        T${e.gateNumber}
      </div>
      <div style="min-width: 36px; display: flex; align-items: center; justify-content: center;">
        <div style="width: 8px; height: 8px; border-radius: 50%; background: ${a};" title="${r}"></div>
      </div>
      <div class="result-info" style="flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0;">
        <span style="font-size: 0.85rem; color: var(--text-secondary); ${i?"text-decoration: line-through;":""}">
          ${k(e.faultType)}
        </span>
        ${e.deviceName?`
          <span style="font-size: 0.65rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${k(e.deviceName)}
          </span>
        `:""}
      </div>
      ${i?`
        <span class="deletion-pending-status" style="display: flex; align-items: center; gap: 4px; padding: 2px 6px; border-radius: var(--radius); font-size: 0.65rem; font-weight: 600; background: var(--error); color: white;">
          DEL
        </span>
      `:""}
      <button class="result-edit-btn" aria-label="Edit fault" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; opacity: 0.7;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
      </button>
      <button class="result-delete fault-delete-btn" aria-label="Delete fault" style="background: none; border: none; color: var(--error); padding: 6px; cursor: pointer; opacity: 0.7;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    `,t.querySelector(".result-edit-btn").addEventListener("click",g=>{g.stopPropagation();const u=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:e}});t.dispatchEvent(u)}),t.querySelector(".fault-delete-btn").addEventListener("click",g=>{g.stopPropagation();const u=new CustomEvent("fault-delete-request",{bubbles:!0,detail:{fault:e}});t.dispatchEvent(u)}),t.addEventListener("click",()=>{const g=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:e}});t.dispatchEvent(g)}),t.addEventListener("touchstart",()=>{t.style.background="var(--surface)"},{passive:!0}),t.addEventListener("touchend",()=>{t.style.background="var(--surface-elevated)"},{passive:!0}),t}renderEmpty(){for(const t of this.visibleItems.values())t.remove();this.visibleItems.clear();const e=c.getState();this.contentContainer.innerHTML=`
      <div class="empty-state">
        <span class="empty-icon">⏱️</span>
        <span>${d("noEntries",e.currentLang)}</span>
        <span class="empty-subtitle">${d("noEntriesHint",e.currentLang)}</span>
      </div>
    `}pause(){this.isPaused=!0}resume(){this.isPaused=!1,this.needsRefreshOnResume&&(this.needsRefreshOnResume=!1,this.render())}scrollToTop(){this.scrollContainer.scrollTo({top:0,behavior:"smooth"})}scrollToEntry(e){const t=String(e),i=this.groups.find(r=>r.entries.some(a=>a.id===t));if(!i)return;let s=0;for(const r of this.groups){if(r.id===i.id)break;s+=this.getGroupHeight(r)}i.isMultiItem&&(this.expandedGroups.add(i.id),this.render()),this.scrollContainer.scrollTo({top:s,behavior:"smooth"})}getVisibleCount(){return this.groups.reduce((e,t)=>e+t.entries.length,0)}destroy(){this.scrollHandler&&this.scrollContainer.removeEventListener("scroll",this.scrollHandler),this.scrollDebounceTimeout!==null&&clearTimeout(this.scrollDebounceTimeout),this.resizeDebounceTimeout!==null&&clearTimeout(this.resizeDebounceTimeout),this.resizeObserver&&this.resizeObserver.disconnect(),this.unsubscribe&&this.unsubscribe(),this.scrollContainer.remove()}}const Rs=3e3;class As{constructor(){h(this,"container");h(this,"queue",[]);h(this,"isShowing",!1);h(this,"toastEventListener");this.container=this.createContainer(),document.body.appendChild(this.container),this.toastEventListener=e=>{this.show(e.detail.message,{type:e.detail.type,duration:e.detail.duration})},window.addEventListener("show-toast",this.toastEventListener)}createContainer(){const e=document.createElement("div");return e.id="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.style.cssText=`
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    `,e}show(e,t={}){this.queue.push({message:e,options:t}),this.isShowing||this.processQueue()}processQueue(){if(this.queue.length===0){this.isShowing=!1;return}this.isShowing=!0;const{message:e,options:t}=this.queue.shift(),i=t.duration||Rs,s=t.type||"info",r=this.createToast(e,s);this.container.appendChild(r),requestAnimationFrame(()=>{r.style.opacity="1",r.style.transform="translateY(0)"}),setTimeout(()=>{r.style.opacity="0",r.style.transform="translateY(10px)",setTimeout(()=>{r.remove(),this.processQueue()},200)},i)}createToast(e,t){const i=document.createElement("div");i.className=`toast toast-${t}`;const s={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--primary)"},r={success:'<path d="M20 6L9 17l-5-5"/>',error:'<path d="M18 6L6 18M6 6l12 12"/>',warning:'<path d="M12 9v4M12 17h.01"/>',info:'<path d="M12 16v-4M12 8h.01"/>'};return i.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border-left: 3px solid ${s[t]};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 0.875rem;
      color: var(--text-primary);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: auto;
      max-width: 90vw;
    `,i.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${s[t]}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        ${r[t]}
      </svg>
      <span>${this.escapeHtml(e)}</span>
    `,i}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}clear(){this.queue=[],this.container.innerHTML="",this.isShowing=!1}destroy(){window.removeEventListener("show-toast",this.toastEventListener),this.clear(),this.container.remove()}}let me=null;function Vn(){return me||(me=new As),me}function E(n,e="info",t){Vn().show(n,{type:e,duration:t})}function xs(){me&&(me.destroy(),me=null)}const ze=80,Sn=2.5;class Ds{constructor(e){h(this,"container");h(this,"indicator");h(this,"onRefresh");h(this,"startY",0);h(this,"currentY",0);h(this,"isPulling",!1);h(this,"isRefreshing",!1);h(this,"scrollableParent",null);h(this,"onTouchStart",e=>{var i;this.isRefreshing||(((i=this.scrollableParent)==null?void 0:i.scrollTop)??0)>0||(this.startY=e.touches[0].clientY,this.isPulling=!0)});h(this,"onTouchMove",e=>{var t;if(!(!this.isPulling||this.isRefreshing))try{if((((t=this.scrollableParent)==null?void 0:t.scrollTop)??0)>0){this.isPulling=!1;return}this.currentY=e.touches[0].clientY;const s=(this.currentY-this.startY)/Sn;s>0&&(e.preventDefault(),this.updateIndicator(s))}catch(i){p.error("PullToRefresh move error:",i),this.isPulling=!1,this.resetIndicator()}});h(this,"onTouchEnd",async()=>{if(!this.isPulling||this.isRefreshing)return;const e=(this.currentY-this.startY)/Sn;this.isPulling=!1,e>=ze?(this.isRefreshing=!0,await this.triggerRefresh()):this.resetIndicator()});this.container=e.container,this.onRefresh=e.onRefresh,this.indicator=this.createIndicator(),this.container.insertBefore(this.indicator,this.container.firstChild),this.scrollableParent=e.scrollElement??this.findScrollableParent(this.container)??this.findScrollableChild(this.container),this.bindEvents()}createIndicator(){const e=document.createElement("div");e.className="pull-indicator",e.style.cssText=`
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: transform 0.2s;
      pointer-events: none;
      z-index: 100;
    `,e.innerHTML=`
      <div class="pull-indicator-content" style="display: flex; align-items: center; gap: 8px;">
        <svg class="pull-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
        <span class="pull-text">Pull to refresh</span>
      </div>
      <div class="pull-spinner" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      </div>
    `;const t=document.createElement("style");return t.textContent=`
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(t),e}findScrollableParent(e){let t=e.parentElement;for(;t;){const i=getComputedStyle(t);if(i.overflowY==="auto"||i.overflowY==="scroll")return t;t=t.parentElement}return null}findScrollableChild(e){const t=e.querySelectorAll("*");for(const i of t)if(i instanceof HTMLElement){const s=getComputedStyle(i);if(s.overflowY==="auto"||s.overflowY==="scroll")return i}return null}bindEvents(){this.container.addEventListener("touchstart",this.onTouchStart,{passive:!0}),this.container.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.container.addEventListener("touchend",this.onTouchEnd,{passive:!0})}updateIndicator(e){const t=Math.min(e,ze*1.5);this.indicator.style.transform=`translateY(${t}px)`;const i=Math.min(e/ze,1),s=this.indicator.querySelector(".pull-icon"),r=this.indicator.querySelector(".pull-text");s&&(s.style.transform=`rotate(${i*180}deg)`),r&&(r.textContent=i>=1?"Release to refresh":"Pull to refresh")}async triggerRefresh(){const e=this.indicator.querySelector(".pull-indicator-content"),t=this.indicator.querySelector(".pull-spinner");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.indicator.style.transform=`translateY(${ze}px)`;try{await this.onRefresh()}catch(i){p.error("PullToRefresh callback error:",i)}finally{this.isRefreshing=!1,e&&(e.style.display="flex"),t&&(t.style.display="none"),this.resetIndicator()}}resetIndicator(){this.indicator.style.transform="translateY(0)";const e=this.indicator.querySelector(".pull-icon");e&&(e.style.transform="rotate(0deg)")}destroy(){this.container.removeEventListener("touchstart",this.onTouchStart),this.container.removeEventListener("touchmove",this.onTouchMove),this.container.removeEventListener("touchend",this.onTouchEnd),this.indicator.remove()}}function At(n){const e=n.currentView==="timer";e&&n.settings.gps?he.start():n.settings.gps?he.pause():he.stop(),e&&n.settings.photoCapture?fe.initialize():fe.stop()}var Ps="@vercel/speed-insights",Bs="1.3.1",Fs=()=>{window.si||(window.si=function(...e){(window.siq=window.siq||[]).push(e)})};function Ns(){return typeof window<"u"}function $s(){try{const n="production"}catch{}return"production"}function On(){return $s()==="development"}function Ms(n){return n.scriptSrc?n.scriptSrc:On()?"https://va.vercel-scripts.com/v1/speed-insights/script.debug.js":n.dsn?"https://va.vercel-scripts.com/v1/speed-insights/script.js":n.basePath?`${n.basePath}/speed-insights/script.js`:"/_vercel/speed-insights/script.js"}function Hs(n={}){var e;if(!Ns()||n.route===null)return null;Fs();const t=Ms(n);if(document.head.querySelector(`script[src*="${t}"]`))return null;n.beforeSend&&((e=window.si)==null||e.call(window,"beforeSend",n.beforeSend));const i=document.createElement("script");return i.src=t,i.defer=!0,i.dataset.sdkn=Ps+(n.framework?`/${n.framework}`:""),i.dataset.sdkv=Bs,n.sampleRate&&(i.dataset.sampleRate=n.sampleRate.toString()),n.route&&(i.dataset.route=n.route),n.endpoint?i.dataset.endpoint=n.endpoint:n.basePath&&(i.dataset.endpoint=`${n.basePath}/speed-insights/vitals`),n.dsn&&(i.dataset.dsn=n.dsn),On()&&n.debug===!1&&(i.dataset.debug="false"),i.onerror=()=>{console.log(`[Vercel Speed Insights] Failed to load script from ${t}. Please check if any content blockers are enabled and try again.`)},document.head.appendChild(i),{setRoute:s=>{i.dataset.route=s??void 0}}}function Vs(n){const e=n.entryCount!==void 0?`${n.entryCount} entries`:"",t=k(n.raceId);return`
    <div class="recent-race-item" data-race-id="${t}">
      <span class="recent-race-id">${t}</span>
      <span class="recent-race-meta">${e}</span>
    </div>
  `}function zn(n){return n.map(Vs).join("")}function Gn(n,e,t){n.querySelectorAll(".recent-race-item").forEach((i,s)=>{i.addEventListener("click",()=>{const r=e[s];r&&t(r)})})}const Os=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(","),tt=new WeakMap;function Un(n){return Array.from(n.querySelectorAll(Os)).filter(e=>!e.hasAttribute("disabled")&&e.tabIndex!==-1)}function zs(n){const e=Un(n);if(e.length>0){e[0].focus();return}n.hasAttribute("tabindex")||n.setAttribute("tabindex","-1"),n.focus()}function Gs(n){const e=t=>{if(t.key==="Escape"){P(n);return}if(t.key!=="Tab")return;const i=Un(n);if(i.length===0){t.preventDefault();return}const s=i[0],r=i[i.length-1],a=document.activeElement;if(t.shiftKey){(!a||a===s||a===n)&&(t.preventDefault(),r.focus());return}a===r&&(t.preventDefault(),s.focus())};n.addEventListener("keydown",e),tt.set(n,{previousFocus:document.activeElement,keydownHandler:e})}function Us(n){const e=tt.get(n);if(!e)return;n.removeEventListener("keydown",e.keydownHandler),tt.delete(n);const t=e.previousFocus;t&&typeof t.focus=="function"&&t.focus()}function P(n){!n||!n.classList.contains("show")||(n.classList.add("closing"),setTimeout(()=>{n.classList.remove("show","closing"),Us(n)},150))}function B(n){if(!n)return;n.hasAttribute("role")||n.setAttribute("role","dialog"),n.setAttribute("aria-modal","true");const e=n.classList.contains("show");n.classList.add("show"),tt.has(n)||Gs(n),e||setTimeout(()=>zs(n),0)}function Js(){document.querySelectorAll(".modal-overlay.show").forEach(n=>{P(n)})}const wt="skiTimerHasCompletedOnboarding";function _s(n,e){let t=null;return(...i)=>{t&&clearTimeout(t),t=setTimeout(()=>n(...i),e)}}class qs{constructor(){h(this,"modal");h(this,"currentStep",1);h(this,"totalSteps",6);h(this,"selectedRole","timer");h(this,"updateTranslationsCallback",null);h(this,"recentRacesDocumentHandler",null);this.modal=document.getElementById("onboarding-modal"),this.modal&&this.setupEventListeners()}setUpdateTranslationsCallback(e){this.updateTranslationsCallback=e}shouldShow(){return localStorage.getItem(wt)!=="true"}show(){if(!this.modal)return;this.currentStep=1,this.selectedRole="timer",this.modal.querySelectorAll(".onboarding-card").forEach((u,f)=>{u.style.display=f===0?"block":"none"});const e=document.getElementById("onboarding-race-id");e&&(e.value="");const t=document.getElementById("onboarding-pin");t&&(t.value="",t.style.display="none");const i=document.getElementById("onboarding-race-status");i&&(i.textContent="",i.className="race-status");const s=document.getElementById("onboarding-sync-toggle");s&&(s.checked=!0);const r=document.getElementById("onboarding-photo-toggle");r&&(r.checked=!1),this.modal.querySelectorAll(".role-card").forEach(u=>{u.classList.toggle("selected",u.getAttribute("data-role")==="timer")});const a=document.getElementById("onboarding-gate-start"),o=document.getElementById("onboarding-gate-end");a&&(a.value="1"),o&&(o.value="10"),this.updateUI(),B(this.modal);const l=document.getElementById("onboarding-device-name");l&&(l.value=c.getState().deviceName);const g=c.getState().currentLang;this.modal.querySelectorAll(".lang-btn").forEach(u=>{const f=u.dataset.lang;u.classList.toggle("selected",f===g)})}reset(){localStorage.removeItem(wt)}setupEventListeners(){if(!this.modal)return;this.modal.querySelectorAll(".lang-btn").forEach(r=>{r.addEventListener("click",a=>{const o=a.currentTarget,l=o.dataset.lang;l&&(c.setLanguage(l),this.modal.querySelectorAll(".lang-btn").forEach(g=>g.classList.remove("selected")),o.classList.add("selected"),I(),this.updateTranslationsCallback&&this.updateTranslationsCallback(),this.updateOnboardingTranslations())})}),this.modal.querySelectorAll("[data-action]").forEach(r=>{r.addEventListener("click",async a=>{const l=a.currentTarget.dataset.action;l&&(I(),await this.handleAction(l))})});const e=document.getElementById("onboarding-regenerate-name");e&&e.addEventListener("click",()=>{const r=document.getElementById("onboarding-device-name");r&&(r.value=Ke(),I())}),this.modal.querySelectorAll(".role-card").forEach(r=>{r.addEventListener("click",()=>{const a=r.getAttribute("data-role");a&&(this.selectedRole=a,this.modal.querySelectorAll(".role-card").forEach(o=>o.classList.remove("selected")),r.classList.add("selected"),I())})});const t=document.getElementById("onboarding-race-id");if(t){const r=_s(()=>this.checkRaceExists(),500);t.addEventListener("input",()=>{r();const a=document.getElementById("onboarding-pin");a&&(a.style.display=t.value.trim()?"block":"none")})}const i=document.getElementById("onboarding-recent-races-btn"),s=document.getElementById("onboarding-recent-races-dropdown");i&&s&&(i.addEventListener("click",()=>{I(),s.style.display==="none"?this.showRecentRacesDropdown(s,"onboarding-race-id"):s.style.display="none"}),this.recentRacesDocumentHandler||(this.recentRacesDocumentHandler=r=>{const a=r.target;!i.contains(a)&&!s.contains(a)&&(s.style.display="none")},document.addEventListener("click",this.recentRacesDocumentHandler)))}async showRecentRacesDropdown(e,t){const i=c.getState().currentLang;e.innerHTML=`<div class="recent-races-empty">${d("loading",i)}</div>`,e.style.display="block";let s=[];if(ne())try{s=await this.fetchRacesFromApi()}catch(r){p.warn("Failed to fetch races from API:",r),s=Xe()}else s=Xe();s.length===0?e.innerHTML=`<div class="recent-races-empty">${d("noRecentRaces",i)}</div>`:(e.innerHTML=zn(s),Gn(e,s,r=>{this.selectRecentRace(r,t,e)}))}async fetchRacesFromApi(){const e=localStorage.getItem("skiTimerAuthToken");if(!e)return[];const t=await J("/api/v1/admin/races",{headers:{Authorization:`Bearer ${e}`}},5e3);if(!t.ok)throw new Error(`API error: ${t.status}`);const s=(await t.json()).races||[],r=new Date;r.setHours(0,0,0,0);const a=r.getTime(),o=s.filter(l=>l.lastUpdated&&l.lastUpdated>=a).map(l=>({raceId:l.raceId,createdAt:l.lastUpdated||Date.now(),lastUpdated:l.lastUpdated||Date.now(),entryCount:l.entryCount})).slice(0,5);return o.forEach(l=>{zt(l.raceId,l.lastUpdated,l.entryCount)}),o}selectRecentRace(e,t,i){const s=document.getElementById(t);s&&(s.value=e.raceId,s.dispatchEvent(new Event("input",{bubbles:!0})),I()),i.style.display="none"}updateOnboardingTranslations(){if(!this.modal)return;const e=c.getState().currentLang;this.modal.querySelectorAll("[data-i18n]").forEach(t=>{const i=t.getAttribute("data-i18n");i&&(t.textContent=d(i,e))})}async handleAction(e){switch(e){case"next":await this.validateCurrentStep()&&(await this.saveCurrentStep(),c.forceSave(),this.goToStep(this.currentStep+1));break;case"back":this.currentStep>1&&this.goToStep(this.currentStep-1);break;case"skip":c.forceSave(),this.goToStep(this.currentStep+1);break;case"finish":this.complete();break}}async validateCurrentStep(){var t,i,s,r;const e=c.getState().currentLang;switch(this.currentStep){case 2:return!0;case 3:return((t=document.getElementById("onboarding-device-name"))==null?void 0:t.value.trim())?!0:(E(d("deviceName",e),"warning"),!1);case 4:return!0;case 5:{const a=(i=document.getElementById("onboarding-race-id"))==null?void 0:i.value.trim(),o=(s=document.getElementById("onboarding-sync-toggle"))==null?void 0:s.checked;if(!a||!o)return!0;const l=(r=document.getElementById("onboarding-pin"))==null?void 0:r.value;return l.length!==4?(E(d("invalidPin",e),"warning"),!1):await this.validatePin(l)}default:return!0}}async saveCurrentStep(){var e,t,i,s,r,a;switch(this.currentStep){case 2:{c.setDeviceRole(this.selectedRole);break}case 3:{const o=(e=document.getElementById("onboarding-device-name"))==null?void 0:e.value.trim();o&&c.setDeviceName(o);break}case 4:{if(this.selectedRole==="gateJudge"){const o=parseInt(((t=document.getElementById("onboarding-gate-start"))==null?void 0:t.value)||"1",10),l=parseInt(((i=document.getElementById("onboarding-gate-end"))==null?void 0:i.value)||"10",10),g=Math.min(o,l),u=Math.max(o,l);c.setGateAssignment([g,u])}else{const o=(s=document.getElementById("onboarding-photo-toggle"))==null?void 0:s.checked;c.updateSettings({photoCapture:o})}break}case 5:{const o=(r=document.getElementById("onboarding-race-id"))==null?void 0:r.value.trim(),l=(a=document.getElementById("onboarding-sync-toggle"))==null?void 0:a.checked;o&&c.setRaceId(o);const g=l&&!!o;c.updateSettings({sync:g}),g&&D.initialize();break}}}goToStep(e){if(!(!this.modal||e<1||e>this.totalSteps)){if(this.modal.querySelectorAll(`[data-step="${this.currentStep}"]`).forEach(t=>{t.style.display="none"}),this.currentStep=e,e===4){const t=this.modal.querySelector(`[data-step="4"][data-path="${this.selectedRole}"]`);t&&(t.style.display="block")}else{const t=this.modal.querySelector(`[data-step="${e}"]:not([data-path])`);t&&(t.style.display="block")}this.updateUIForRole(),this.updateProgressDots(),e===6&&this.showSummary()}}updateUIForRole(){const e=c.getState().currentLang,t=document.getElementById("onboarding-device-name-title"),i=document.getElementById("onboarding-device-name-desc");this.selectedRole==="gateJudge"?(t&&(t.textContent=d("onboardingDeviceNameJudge",e)),i&&(i.textContent=d("onboardingDeviceNameJudgeDesc",e))):(t&&(t.textContent=d("onboardingDeviceName",e)),i&&(i.textContent=d("onboardingDeviceNameDesc",e)));const s=document.getElementById("onboarding-ready-title"),r=document.getElementById("onboarding-ready-tip"),a=document.getElementById("onboarding-finish-btn");this.selectedRole==="gateJudge"?(s&&(s.textContent=d("onboardingReadyJudge",e)),r&&(r.textContent=d("onboardingTipJudge",e)),a&&(a.textContent=d("startJudging",e))):(s&&(s.textContent=d("onboardingReady",e)),r&&(r.textContent=d("onboardingTip",e)),a&&(a.textContent=d("startTiming",e)))}updateProgressDots(){if(!this.modal)return;this.modal.querySelectorAll(".progress-dot").forEach((t,i)=>{t.classList.remove("active","completed"),i+1===this.currentStep?t.classList.add("active"):i+1<this.currentStep&&t.classList.add("completed")})}updateUI(){this.updateProgressDots(),this.updateOnboardingTranslations()}showSummary(){const e=c.getState(),t=e.currentLang,i=document.getElementById("onboarding-summary");if(i){i.innerHTML="";const s=[];if(s.push([d("deviceRole",t),this.selectedRole==="gateJudge"?d("roleJudgeTitle",t):d("roleTimerTitle",t)]),s.push([this.selectedRole==="gateJudge"?d("onboardingDeviceNameJudge",t):d("deviceNameLabel",t),e.deviceName]),this.selectedRole==="gateJudge"){const r=e.gateAssignment;s.push([d("gates",t),r?`${r[0]}–${r[1]}`:"—"])}else s.push([d("photoCaptureLabel",t),e.settings.photoCapture?d("enabled",t):d("disabled",t)]);s.push([d("raceIdLabel",t),e.raceId||"—"]),s.push([d("syncStatusLabel",t),e.settings.sync?d("enabled",t):d("disabled",t)]),s.forEach(([r,a])=>{const o=document.createElement("div");o.className="onboarding-summary-item";const l=document.createElement("span");l.textContent=r;const g=document.createElement("strong");g.textContent=a,o.append(l,g),i.appendChild(o)})}}async checkRaceExists(){const e=document.getElementById("onboarding-race-id"),t=document.getElementById("onboarding-race-status");if(!e||!t)return;const i=e.value.trim();if(!i){t.textContent="",t.className="race-status";return}const s=await D.checkRaceExists(i),r=c.getState().currentLang;if(s.exists){const a=s.entryCount===1?d("entry",r):d("entries",r);t.textContent=`✓ ${d("raceFound",r)} (${s.entryCount} ${a})`,t.className="race-status found"}else t.textContent=`+ ${d("raceNew",r)}`,t.className="race-status new"}async validatePin(e){try{return(await $n(e)).success}catch{return!0}}complete(){if(c.forceSave(),localStorage.setItem(wt,"true"),P(this.modal),this.selectedRole==="gateJudge"){c.setView("gateJudge");const e=document.getElementById("gate-judge-tab");e&&(e.style.display="")}else c.setView("timer");H(),E(d("onboardingComplete",c.getState().currentLang),"success"),this.recentRacesDocumentHandler&&(document.removeEventListener("click",this.recentRacesDocumentHandler),this.recentRacesDocumentHandler=null)}}const nt=new Set;function U(n,e,t){const i=e.getBoundingClientRect();let s,r;typeof TouchEvent<"u"&&n instanceof TouchEvent&&n.touches.length>0?(s=n.touches[0].clientX-i.left,r=n.touches[0].clientY-i.top):typeof MouseEvent<"u"&&n instanceof MouseEvent?(s=n.clientX-i.left,r=n.clientY-i.top):(s=i.width/2,r=i.height/2);const a=document.createElement("span");a.classList.add("ripple"),t&&a.classList.add(`ripple-${t}`);const o=Math.max(i.width,i.height)*2;a.style.width=`${o}px`,a.style.height=`${o}px`,a.style.left=`${s-o/2}px`,a.style.top=`${r-o/2}px`,e.appendChild(a);const l=setTimeout(()=>{a.remove(),nt.delete(l)},500);nt.add(l)}function js(){document.querySelectorAll(".num-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>U(t,e),{passive:!0}),e.addEventListener("mousedown",t=>U(t,e))});const n=document.querySelector(".timestamp-btn");n&&(n.classList.add("ripple-container"),n.addEventListener("touchstart",e=>U(e,n,"primary"),{passive:!0}),n.addEventListener("mousedown",e=>U(e,n,"primary"))),document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.add("ripple-container");const t=e.getAttribute("data-point")==="S";e.addEventListener("touchstart",i=>U(i,e,t?"success":"secondary"),{passive:!0}),e.addEventListener("mousedown",i=>U(i,e,t?"success":"secondary"))}),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>U(t,e,"primary"),{passive:!0}),e.addEventListener("mousedown",t=>U(t,e,"primary"))}),document.querySelectorAll(".action-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>U(t,e),{passive:!0}),e.addEventListener("mousedown",t=>U(t,e))}),document.querySelectorAll(".modal-btn").forEach(e=>{e.classList.add("ripple-container");const t=e.classList.contains("primary"),i=e.classList.contains("danger"),s=t?"primary":i?"secondary":void 0;e.addEventListener("touchstart",r=>U(r,e,s),{passive:!0}),e.addEventListener("mousedown",r=>U(r,e,s))})}function Ws(){nt.forEach(n=>clearTimeout(n)),nt.clear()}let ee=null;function Ys(n){return n?/^0+$/.test(n):!1}function Qs(){ee&&(ee.destroy(),ee=null);const n=m("clock-container");n&&(ee=new Cs(n),ee.start())}function Ks(){ee&&(ee.destroy(),ee=null)}function Zs(){const n=document.querySelectorAll(".tab-btn");n.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-view");t&&(c.setView(t),I(),n.forEach(i=>{i.setAttribute("aria-selected",i===e?"true":"false")}))})})}function Xs(){const n=m("number-pad"),e=m("bib-display");e&&n&&(e.setAttribute("aria-expanded","true"),e.addEventListener("click",()=>{const t=n.classList.toggle("collapsed");e.classList.toggle("expanded",!t),e.setAttribute("aria-expanded",String(!t)),I()})),n&&n.addEventListener("click",t=>{const s=t.target.closest(".num-btn");if(!s)return;const r=s.getAttribute("data-num"),a=s.getAttribute("data-action");if(r){const o=c.getState();o.bibInput.length<3&&(c.setBibInput(o.bibInput+r),I())}else if(a==="clear")c.setBibInput(""),I();else if(a==="delete"){const o=c.getState();c.setBibInput(o.bibInput.slice(0,-1)),I()}})}function er(){const n=m("timing-points");n&&n.addEventListener("click",e=>{const i=e.target.closest(".timing-point-btn");if(!i)return;const s=i.getAttribute("data-point");s&&(c.setSelectedPoint(s),I(),n.querySelectorAll(".timing-point-btn").forEach(r=>{r.setAttribute("aria-checked",r===i?"true":"false")}))})}function tr(){const n=m("run-selector");n&&n.addEventListener("click",e=>{const i=e.target.closest(".run-btn");if(!i)return;const s=i.getAttribute("data-run"),r=s?parseInt(s,10):1;c.setSelectedRun(r),I(),n.querySelectorAll(".run-btn").forEach(a=>{a.setAttribute("aria-checked",a===i?"true":"false")})})}function nr(){const n=m("timestamp-btn");n&&(n.addEventListener("click",async()=>{if(z.isActive()){z.exitAmbientMode(),I();return}await En()}),document.addEventListener("keydown",e=>{var s;const t=(s=document.activeElement)==null?void 0:s.tagName,i=c.getState();if(!(t==="INPUT"||t==="TEXTAREA"||t==="SELECT")&&i.currentView==="timer"){if(/^[0-9]$/.test(e.key)){e.preventDefault(),i.bibInput.length<3&&(c.setBibInput(i.bibInput+e.key),I());return}if(e.key==="Backspace"){e.preventDefault(),c.setBibInput(i.bibInput.slice(0,-1)),I();return}if(e.key==="Delete"||e.key==="Escape"){e.preventDefault(),c.setBibInput(""),I();return}if(e.key==="s"||e.key==="S"){e.preventDefault(),c.setSelectedPoint("S"),I(),document.querySelectorAll(".timing-point-btn").forEach(r=>{r.setAttribute("aria-checked",r.getAttribute("data-point")==="S"?"true":"false")});return}if(e.key==="f"||e.key==="F"){e.preventDefault(),c.setSelectedPoint("F"),I(),document.querySelectorAll(".timing-point-btn").forEach(r=>{r.setAttribute("aria-checked",r.getAttribute("data-point")==="F"?"true":"false")});return}if(e.key==="1"&&e.altKey){e.preventDefault(),c.setSelectedRun(1),I();return}if(e.key==="2"&&e.altKey){e.preventDefault(),c.setSelectedRun(2),I();return}if(e.key===" "||e.key==="Enter"){if(e.preventDefault(),z.isActive()){z.exitAmbientMode(),I();return}En();return}}}))}async function En(){const n=c.getState();if(n.isRecording)return;const e=new Date().toISOString(),t=he.getCoordinates();c.setRecording(!0);try{const i={id:bi(n.deviceId),bib:n.bibInput?n.bibInput.padStart(3,"0"):"",point:n.selectedPoint,run:n.selectedRun,timestamp:e,status:"ok",deviceId:n.deviceId,deviceName:n.deviceName,gpsCoords:t};if(n.settings.photoCapture){const a=i.id;Ui().then(async o=>{if(o)try{if(!c.getState().entries.some(f=>f.id===a)){p.warn("Entry was deleted before photo could be attached:",a);return}if(await V.savePhoto(a,o))c.updateEntry(a,{photo:"indexeddb"})||(p.warn("Entry deleted during photo save, removing orphaned photo:",a),await V.deletePhoto(a));else{p.warn("Photo save failed for entry:",a);const f=c.getState().currentLang;E(d("photoSaveFailed",f),"warning")}}catch(l){Rt("Camera","photo save/update",l,"photoError")}}).catch(o=>{if(o instanceof Error&&o.name==="PhotoTooLargeError"){const l=c.getState().currentLang;E(d("photoTooLarge",l),"warning")}else Rt("Camera","captureTimingPhoto",o,"photoError")})}const s=i.bib&&n.entries.some(a=>a.bib===i.bib&&a.point===i.point&&(a.run??1)===i.run),r=Ys(i.bib);if(c.addEntry(i),s?(F(),sr(i)):r?(F(),rr(i)):(H(),Ut(i)),D.broadcastEntry(i),n.settings.auto&&n.bibInput){const a=parseInt(n.bibInput,10)+1,o=n.settings.sync&&n.cloudHighestBib>0?Math.max(a,n.cloudHighestBib+1):a;c.setBibInput(String(o))}else n.bibInput&&n.settings.auto||c.setBibInput("");ar(i)}finally{c.setRecording(!1)}}function Ut(n){const e=m("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-bib"),i=e.querySelector(".confirmation-point"),s=e.querySelector(".confirmation-run"),r=e.querySelector(".confirmation-time"),a=c.getState();if(t&&(t.textContent=n.bib||"---"),i&&(i.textContent=ce(n.point,a.currentLang),i.style.color=Re(n.point)),s&&n.run&&(s.textContent=Ce(n.run,a.currentLang),s.style.color=Le(n.run)),r){const o=new Date(n.timestamp);r.textContent=oe(o)}e.dataset.point=n.point,e.classList.add("show"),ir(n.point),setTimeout(()=>{e.classList.remove("show")},1500)}function ir(n){const e=document.getElementById("snowflake-burst");if(!e)return;e.innerHTML="";const t=n==="S"?"var(--start-color)":"var(--finish-color)",i=8;for(let s=0;s<i;s++){const r=document.createElement("span");r.className="flake",r.textContent="❄";const a=s/i*2*Math.PI,o=60+Math.random()*40,l=Math.cos(a)*o,g=Math.sin(a)*o,u=Math.random()*360;r.style.cssText=`
      --burst-x: ${l}px;
      --burst-y: ${g}px;
      --burst-rot: ${u}deg;
      color: ${t};
      font-size: ${.6+Math.random()*.6}rem;
      animation-duration: ${.6+Math.random()*.4}s;
      text-shadow: 0 0 6px ${t};
    `,r.addEventListener("animationend",()=>r.remove(),{once:!0}),e.appendChild(r)}}function sr(n){const e=m("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-duplicate");t&&(t.style.display="flex"),Ut(n),setTimeout(()=>{t&&(t.style.display="none")},2500)}function rr(n){const e=m("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-zero-bib");t&&(t.style.display="flex"),Ut(n),setTimeout(()=>{t&&(t.style.display="none")},2500)}function ar(n){const e=m("last-recorded-inline");if(!e)return;const t=e.querySelector(".bib"),i=e.querySelector(".point"),s=e.querySelector(".run"),r=e.querySelector(".time"),a=c.getState();if(t&&(t.textContent=n.bib||"---"),i&&(i.textContent=ce(n.point,a.currentLang),i.style.color=Re(n.point)),s&&n.run&&(s.textContent=Ce(n.run,a.currentLang),s.style.color=Le(n.run)),r){const o=new Date(n.timestamp);r.textContent=oe(o)}e.classList.add("visible"),e.classList.remove("pulse"),e.offsetWidth,e.classList.add("pulse")}function Jt(){const n=c.getState(),e=m("bib-display"),t=e==null?void 0:e.querySelector(".bib-value");t&&(t.textContent=n.bibInput?n.bibInput.padStart(3,"0"):"---");const i=m("timestamp-btn");i&&i.classList.toggle("ready",n.bibInput.length>0)}function _t(){const n=c.getState();document.querySelectorAll(".timing-point-btn").forEach(e=>{const t=e.getAttribute("data-point")===n.selectedPoint;e.classList.toggle("active",t),e.setAttribute("aria-checked",String(t))})}function qt(){const n=c.getState();document.querySelectorAll(".run-btn").forEach(e=>{const t=e.getAttribute("data-run")===String(n.selectedRun);e.classList.toggle("active",t),e.setAttribute("aria-checked",String(t))})}function or(n){var e,t,i;switch(p.debug("[TimerView] Voice intent:",n.action,n.params),n.action){case"set_bib":(e=n.params)!=null&&e.bib&&(c.setBibInput(n.params.bib),Jt(),I());break;case"set_point":(t=n.params)!=null&&t.point&&(c.setSelectedPoint(n.params.point),_t(),I());break;case"set_run":(i=n.params)!=null&&i.run&&(c.setSelectedRun(n.params.run),qt(),I());break;default:p.debug("[TimerView] Unhandled voice intent:",n.action)}}let it=null;async function cr(n){const e=document.getElementById("photo-viewer-modal");if(!e||!n.photo)return;it=n.id;const t=document.getElementById("photo-viewer-image"),i=document.getElementById("photo-viewer-bib"),s=document.getElementById("photo-viewer-point"),r=document.getElementById("photo-viewer-time"),o=c.getState().currentLang;if(t){const l=ce(n.point,o);if(t.alt=`${d("photoForBib",o)} ${n.bib||"---"} - ${l}`,n.photo==="indexeddb"){t.src="";const g=await V.getPhoto(n.id);if(g)t.src=`data:image/jpeg;base64,${g}`;else{p.warn("Photo not found in IndexedDB for entry:",n.id);return}}else t.src=`data:image/jpeg;base64,${n.photo}`}if(i&&(i.textContent=n.bib||"---"),s){s.textContent=ce(n.point,o);const l=Re(n.point);s.style.background=l,s.style.color="var(--background)"}if(r){const l=new Date(n.timestamp);r.textContent=oe(l)}B(e)}function Je(){const n=document.getElementById("photo-viewer-modal");P(n),it=null}async function lr(){if(!it)return;const n=c.getState(),e=it;await V.deletePhoto(e),c.updateEntry(e,{photo:void 0}),Je(),E(d("photoDeleted",n.currentLang),"success"),ct()}function dr(n){const e=new Date(n),t=e.getHours().toString().padStart(2,"0"),i=e.getMinutes().toString().padStart(2,"0"),s=e.getSeconds().toString().padStart(2,"0"),r=Math.round(e.getMilliseconds()/10).toString().padStart(2,"0");return`${t}:${i}:${s},${r}`}function wn(n){const e=["=","+","-","@","|","	","\r",`
`];let t=n;return e.some(i=>t.startsWith(i))&&(t=`'${t}`),/^[+]?0x/i.test(t)&&(t=`'${t}`),t.includes('"')&&(t=t.replace(/"/g,'""')),(t.includes(";")||t.includes('"')||t.includes(`
`)||t.includes("|"))&&(t=`"${t}"`),t}function ur(n){return n==="S"?"ST":"FT"}function It(n,e){var i;return((i={ok:{en:"OK",de:"OK"},dns:{en:"DNS",de:"DNS"},dnf:{en:"DNF",de:"DNF"},dsq:{en:"DSQ",de:"DSQ"},flt:{en:"FLT",de:"STR"}}[n])==null?void 0:i[e])||n.toUpperCase()}function gr(n){return n.length===0?"":n.sort((e,t)=>e.gateNumber-t.gateNumber).map(e=>`T${e.gateNumber}(${e.faultType})`).join(",")}function jt(){const n=c.getState(),e=n.entries,t=n.faultEntries,i=n.currentLang;if(e.length===0){E(d("noEntries",i),"warning");return}const s=[...e].sort((S,C)=>new Date(S.timestamp).getTime()-new Date(C.timestamp).getTime()),r=t.length>0,a=r?"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Torstrafzeit;Torfehler":"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät",o=s.map(S=>{const C=wn(S.bib),b=S.run??1,w=ur(S.point),R=dr(S.timestamp),L=wn(S.deviceName||S.deviceId),T=S.point==="F"?t.filter(O=>O.bib===S.bib&&O.run===b):[];let x;if(S.point==="F"&&T.length>0?x=n.usePenaltyMode?It("flt",i):It("dsq",i):x=It(S.status,i),r){const O=T.length>0&&n.usePenaltyMode?T.length*n.penaltySeconds:0,ht=gr(T);return`${C};${b};${w};${R};${x};${L};${O};${ht}`}else return`${C};${b};${w};${R};${x};${L}`}),l=[a,...o].join(`
`),g=new Blob([l],{type:"text/csv;charset=utf-8;"}),u=URL.createObjectURL(g),f=document.createElement("a");f.href=u;const y=new Date().toISOString().split("T")[0],v=n.raceId||"race";f.download=`${v}_${y}.csv`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(u),H(),E(d("exported",i),"success")}function xt(n,e="csv"){const t=new Date().toISOString().split("T")[0];return`${n.replace(/[^a-zA-Z0-9-_]/g,"_")||"race"}_${t}.${e}`}function fr(){const n=c.getState(),e=n.currentLang,t=n.faultEntries,i=n.raceId||"RACE";if(t.length===0){E(d("noFaultsToExport",e),"warning");return}const s=new Map;for(const f of t){const y=`${f.bib}-${f.run}`;s.has(y)||s.set(y,[]),s.get(y).push(f)}const r=[];r.push(`📋 ${d("gateFaults",e)} - ${i}`),r.push("");const a=Array.from(s.entries()).filter(([f])=>f.endsWith("-1")),o=Array.from(s.entries()).filter(([f])=>f.endsWith("-2")),l=(f,y)=>{const[v]=f.split("-"),S=v.padStart(3,"0"),C=y.sort((w,R)=>w.gateNumber-R.gateNumber).map(w=>`T${w.gateNumber}`).join("+"),b=y.map(w=>w.faultType).join(", ");if(n.usePenaltyMode){const w=y.length*n.penaltySeconds;return`#${S}: ${C} (${b}) → +${w}s`}else return`#${S}: ${C} (${b})`};a.length>0&&(r.push(`🏁 ${d("runLabel",e)} 1:`),n.usePenaltyMode?r.push(`🟡 ${d("penaltyLabel",e)}:`):r.push("🔴 DSQ:"),a.sort((f,y)=>parseInt(f[0].split("-")[0])-parseInt(y[0].split("-")[0])).forEach(([f,y])=>{r.push(l(f,y))}),r.push("")),o.length>0&&(r.push(`🏁 ${d("runLabel",e)} 2:`),n.usePenaltyMode?r.push(`🟡 ${d("penaltyLabel",e)}:`):r.push("🔴 DSQ:"),o.sort((f,y)=>parseInt(f[0].split("-")[0])-parseInt(y[0].split("-")[0])).forEach(([f,y])=>{r.push(l(f,y))}),r.push(""));const g=new Date;r.push(`📅 ${g.toLocaleDateString(e==="de"?"de-DE":"en-US")} ${g.toLocaleTimeString(e==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"})}`);const u=r.join(`
`);navigator.clipboard?navigator.clipboard.writeText(u).then(()=>{H(),E(d("copiedToClipboard",e),"success")}).catch(()=>{Dt(u,xt(`${i}_WhatsApp`,"txt"))}):Dt(u,xt(`${i}_WhatsApp`,"txt"))}function hr(){const n=c.getState(),e=n.currentLang,t=n.faultEntries,i=n.raceId||"RACE";if(t.length===0){E(d("noFaultsToExport",e),"warning");return}const s=new Map;for(const f of t){const y=`${f.bib}-${f.run}`;s.has(y)||s.set(y,[]),s.get(y).push(f)}const r=[],a="══════════════════════════════════════════════════════",o=Array.from(s.entries()).filter(([f])=>f.endsWith("-1")),l=Array.from(s.entries()).filter(([f])=>f.endsWith("-2")),g=(f,y)=>{f.length!==0&&(r.push(`${d("faultSummaryTitle",e)} - ${d("runLabel",e)} ${y}`),r.push(a),r.push(`${d("bib",e).substring(0,7).padEnd(7)} │ ${d("faults",e).padEnd(16)} │ ${d("penalty",e).padStart(9)} │ Status`),r.push("────────┼──────────────────┼───────────┼────────"),f.sort((v,S)=>parseInt(v[0].split("-")[0])-parseInt(S[0].split("-")[0])).forEach(([v,S])=>{const[C]=v.split("-"),b=C.padStart(5),w=S.sort((T,x)=>T.gateNumber-x.gateNumber).map(T=>`T${T.gateNumber}(${T.faultType})`).join(", ").padEnd(16);let R,L;n.usePenaltyMode?(R=`${S.length*n.penaltySeconds} ${d("sec",e)}`.padStart(9),L=d("flt",e)):(R="-".padStart(9),L="DSQ"),r.push(`  ${b}   │ ${w} │ ${R} │ ${L}`)}),r.push(""))};r.push(`${i} - ${new Date().toLocaleDateString(e==="de"?"de-DE":"en-US")}`),r.push(""),g(o,1),g(l,2),r.push(a),r.push(`${d("generated",e)}: ${new Date().toLocaleString(e==="de"?"de-DE":"en-US")}`);const u=r.join(`
`);Dt(u,xt(`${i}_${d("summary",e)}`,"txt")),H(),E(d("exported",e),"success")}function Dt(n,e){const t=new Blob([n],{type:"text/plain;charset=utf-8;"}),i=URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}let Ct=null,Pt=null,Bt=null,Ge=null,se=null,Ue=null;function lt(n,e){return{MG:d("faultMGShort",e),STR:d("faultSTRShort",e),BR:d("faultBRShort",e)}[n]||n}function mr(n){Ct=n.verifyPinForChiefJudge,Pt=n.openFaultEditModal,Bt=n.openMarkDeletionModal,Ge=n.updateInlineFaultsList,se=n.updateInlineBibSelector,Ue=n.updateInlineGateSelector;const e=document.getElementById("chief-judge-toggle-btn");e&&(e.addEventListener("click",async()=>{const t=c.getState(),i=t.currentLang;if(t.isChiefJudgeView){c.toggleChiefJudgeView(),Cn(),I(),E(d("chiefJudgeModeDisabled",i),"info");return}t.settings.sync&&t.raceId&&Ct&&!await Ct(i)||(c.toggleChiefJudgeView(),Cn(),I(),E(d("chiefJudgeModeEnabled",i),"info"))}),In(),c.subscribe((t,i)=>{(i.includes("settings")||i.includes("faultEntries"))&&In(),(i.includes("faultEntries")||i.includes("penaltySeconds")||i.includes("usePenaltyMode"))&&t.isChiefJudgeView&&($e(),dt()),(i.includes("penaltySeconds")||i.includes("usePenaltyMode"))&&Jn(),(i.includes("entries")||i.includes("faultEntries")||i.includes("isJudgeReady"))&&t.isChiefJudgeView&&_n(),i.includes("faultEntries")&&t.deviceRole==="gateJudge"&&(Ge==null||Ge(),se==null||se()),i.includes("entries")&&t.deviceRole==="gateJudge"&&(se==null||se()),i.includes("gateAssignment")&&t.deviceRole==="gateJudge"&&(Ue==null||Ue())}),yr(),pr())}function pr(){const n=document.getElementById("export-csv-btn");n&&n.addEventListener("click",()=>{I(),jt()});const e=document.getElementById("export-summary-btn");e&&e.addEventListener("click",()=>{I(),hr()});const t=document.getElementById("export-whatsapp-btn");t&&t.addEventListener("click",()=>{I(),fr()})}function yr(){const n=document.getElementById("penalty-mode-toggle");n&&n.addEventListener("click",t=>{const i=t.target.closest(".penalty-mode-btn");if(!i)return;const s=i.getAttribute("data-mode");s==="penalty"?c.setUsePenaltyMode(!0):s==="dsq"&&c.setUsePenaltyMode(!1),I()});const e=document.getElementById("penalty-seconds-selector");e&&e.addEventListener("click",t=>{const i=t.target.closest(".penalty-adj-btn");if(!i)return;const s=i.getAttribute("data-adj"),a=c.getState().penaltySeconds;s==="+1"?c.setPenaltySeconds(a+1):s==="-1"&&c.setPenaltySeconds(a-1),I()}),Jn()}function Jn(){const n=c.getState(),e=document.getElementById("penalty-config-row"),t=document.getElementById("penalty-seconds-value"),i=document.getElementById("penalty-mode-toggle");e&&e.classList.toggle("dsq-mode",!n.usePenaltyMode),t&&(t.textContent=String(n.penaltySeconds)),i&&i.querySelectorAll(".penalty-mode-btn").forEach(r=>{const a=r.getAttribute("data-mode"),o=a==="penalty"&&n.usePenaltyMode||a==="dsq"&&!n.usePenaltyMode;r.classList.toggle("active",o)})}function In(){const n=document.getElementById("chief-judge-toggle-row");if(!n)return;const t=c.getState().settings.sync;n.style.display=t?"block":"none"}function Cn(){const n=c.getState(),e=document.querySelector(".results-view"),t=document.getElementById("chief-judge-toggle-btn");!e||!t||(t.classList.toggle("active",n.isChiefJudgeView),e.classList.toggle("chief-mode",n.isChiefJudgeView),n.isChiefJudgeView&&($e(),dt(),_n()))}function _n(){const n=document.getElementById("judges-overview-list"),e=document.getElementById("judges-overview-count"),t=document.getElementById("judges-overview-empty");if(!n||!e)return;const i=D.getOtherGateAssignments(),s=c.getState(),r=[...i];if(s.deviceRole==="gateJudge"&&s.gateAssignment&&r.push({deviceId:s.deviceId,deviceName:s.deviceName,gateStart:s.gateAssignment[0],gateEnd:s.gateAssignment[1],lastSeen:Date.now(),isReady:s.isJudgeReady}),e.textContent=String(r.length),t&&(t.style.display=r.length===0?"block":"none"),n.querySelectorAll(".judge-card").forEach(l=>l.remove()),r.length===0)return;r.sort((l,g)=>l.gateStart-g.gateStart);const o=r.map(l=>`
    <div class="judge-card${l.isReady?" ready":""}">
      <span class="judge-ready-indicator"></span>
      <span class="judge-name" title="${k(l.deviceName)}">${k(l.deviceName)}</span>
      <span class="judge-gates">${l.gateStart}–${l.gateEnd}</span>
    </div>
  `).join("");t?t.insertAdjacentHTML("beforebegin",o):n.innerHTML=o}function $e(){const n=document.getElementById("fault-summary-list"),e=document.getElementById("fault-summary-count"),t=document.getElementById("chief-empty-state");if(!n||!e)return;const i=c.getState(),s=i.currentLang,r=i.faultEntries,a=new Map;for(const v of r){const S=`${v.bib}-${v.run}`;a.has(S)||a.set(S,[]),a.get(S).push(v)}if(e.textContent=String(a.size),t&&(t.style.display=a.size===0?"flex":"none"),a.size===0){n.querySelectorAll(".fault-summary-card").forEach(S=>S.remove());return}const o=[],l=Array.from(a.entries()).sort((v,S)=>{const[C]=v,[b]=S,w=parseInt(C.split("-")[0],10)||0,R=parseInt(b.split("-")[0],10)||0;return w-R});for(const[v,S]of l){const[C,b]=v.split("-"),w=parseInt(b,10),R=c.isRacerFinalized(C,w),L=S.filter(q=>!q.markedForDeletion),T=i.usePenaltyMode?L.length*i.penaltySeconds:0,x=S.map(q=>{const Z=q.markedForDeletion,pi=Z&&q.markedForDeletionBy?`${d("deletionPending",s)} (${q.markedForDeletionBy})`:"";return`
        <div class="fault-entry-row${Z?" marked-for-deletion":""}" data-fault-id="${q.id}">
          <div class="fault-gate-info">
            <span class="fault-gate-num${Z?" strikethrough":""}">${d("gate",s)} ${q.gateNumber}</span>
            <span class="fault-type-badge${Z?" marked":""}">${lt(q.faultType,s)}</span>
            ${Z?`<span class="deletion-pending-badge" title="${pi}">⚠</span>`:""}
          </div>
          <span class="fault-judge-name">${k(q.deviceName)}</span>
          <div class="fault-row-actions">
            <button class="fault-row-btn edit-fault-btn" data-fault-id="${q.id}" title="${d("edit",s)}" ${Z?"disabled":""}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
            <button class="fault-row-btn delete-fault-btn" data-fault-id="${q.id}" title="${d(Z?"rejectDeletion":"markForDeletion",s)}">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                ${Z?'<path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="9" y1="11" x2="9" y2="17"/><line x1="15" y1="11" x2="15" y2="17"/>':'<path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>'}
              </svg>
            </button>
          </div>
        </div>
      `}).join(""),O=R?`<div class="finalized-badge">
           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
             <path d="M20 6L9 17l-5-5"/>
           </svg>
           ${d("finalized",s)}
         </div>`:`<button class="finalize-btn" data-bib="${C}" data-run="${w}">
           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
             <path d="M20 6L9 17l-5-5"/>
           </svg>
           ${d("finalize",s)}
         </button>`,ht=i.usePenaltyMode?`<span class="fault-card-penalty">+${T}s</span>
         <span class="fault-card-result flt">${d("flt",s)}</span>`:'<span class="fault-card-result dsq">DSQ</span>';o.push(`
      <div class="fault-summary-card${R?" finalized":""}" data-bib="${C}" data-run="${w}">
        <div class="fault-card-header">
          <span class="fault-card-bib">#${C.padStart(3,"0")}</span>
          <div class="fault-card-status">
            ${ht}
          </div>
        </div>
        <div class="fault-card-body">
          ${x}
        </div>
        <div class="fault-card-actions">
          ${O}
        </div>
      </div>
    `)}n.querySelectorAll(".fault-summary-card").forEach(v=>v.remove()),t?t.insertAdjacentHTML("beforebegin",o.join("")):n.innerHTML=o.join(""),n.querySelectorAll(".finalize-btn").forEach(v=>{v.addEventListener("click",br)}),n.querySelectorAll(".edit-fault-btn").forEach(v=>{v.addEventListener("click",S=>{S.stopPropagation();const C=v.dataset.faultId;if(C&&Pt){const b=c.getState().faultEntries.find(w=>w.id===C);b&&Pt(b)}})}),n.querySelectorAll(".delete-fault-btn").forEach(v=>{v.addEventListener("click",S=>{S.stopPropagation();const C=v.dataset.faultId;if(C){const b=c.getState().faultEntries.find(w=>w.id===C);b&&(b.markedForDeletion?qn(b):Bt&&Bt(b))}})})}function qn(n){if(c.rejectFaultDeletion(n.id)){const t=c.getState().faultEntries.find(s=>s.id===n.id);t&&le(t);const i=c.getState().currentLang;E(d("deletionRejected",i),"success"),H(),$e(),dt()}}function vr(n){const e=c.approveFaultDeletion(n.id);if(e){Gt(e);const t=c.getState().currentLang;E(d("deletionApproved",t),"success"),ct(),$e(),dt()}}function dt(){const n=document.getElementById("pending-deletions-section"),e=document.getElementById("pending-deletions-list"),t=document.getElementById("pending-deletions-count");if(!n||!e||!t)return;const i=c.getPendingDeletions(),r=c.getState().currentLang;if(t.textContent=String(i.length),n.style.display=i.length>0?"block":"none",i.length===0){e.innerHTML="";return}const a=i.map(o=>{const l=o.markedForDeletionAt?new Date(o.markedForDeletionAt).toLocaleTimeString(r==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"}):"";return`
      <div class="pending-deletion-item" data-fault-id="${o.id}">
        <div class="pending-deletion-info">
          <span class="pending-deletion-fault">
            #${o.bib.padStart(3,"0")} T${o.gateNumber} (${lt(o.faultType,r)}) - ${d(o.run===1?"run1":"run2",r)}
          </span>
          <span class="pending-deletion-meta">
            ${d("deletionMarkedBy",r)}: ${o.markedForDeletionBy||"?"} (${l})
          </span>
        </div>
        <div class="pending-deletion-actions">
          <button class="pending-deletion-btn approve" data-fault-id="${o.id}" title="${d("approveDeletion",r)}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
          </button>
          <button class="pending-deletion-btn reject" data-fault-id="${o.id}" title="${d("rejectDeletion",r)}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
          </button>
        </div>
      </div>
    `}).join("");e.innerHTML=a,e.querySelectorAll(".pending-deletion-btn.approve").forEach(o=>{o.addEventListener("click",l=>{l.stopPropagation();const g=o.dataset.faultId;if(g){const u=i.find(f=>f.id===g);u&&vr(u)}})}),e.querySelectorAll(".pending-deletion-btn.reject").forEach(o=>{o.addEventListener("click",l=>{l.stopPropagation();const g=o.dataset.faultId;if(g){const u=i.find(f=>f.id===g);u&&qn(u)}})})}function br(n){const e=n.currentTarget,t=e.dataset.bib,i=e.dataset.run;if(!t||!i)return;const s=parseInt(i,10);c.finalizeRacer(t,s),H();const r=c.getState();E(`#${t.padStart(3,"0")} ${d("finalized",r.currentLang)}`,"success"),$e()}let $=null,Ee="",pe=0,Te=null;function jn(n){const e=c.getState(),t=c.getActiveBibs(e.selectedRun),i=document.getElementById("fault-bib-selector");i&&(i.innerHTML=t.map(o=>`
      <button class="fault-bib-btn ${o===n?"selected":""}" data-bib="${o}">${o}</button>
    `).join(""),i.querySelectorAll(".fault-bib-btn").forEach(o=>{o.addEventListener("click",()=>{i.querySelectorAll(".fault-bib-btn").forEach(g=>g.classList.remove("selected")),o.classList.add("selected");const l=document.getElementById("fault-bib-input");l&&(l.value=""),c.setSelectedFaultBib(o.getAttribute("data-bib")||"")})}));const s=document.getElementById("fault-bib-input");s&&(s.value=n||"",s.addEventListener("input",()=>{i==null||i.querySelectorAll(".fault-bib-btn").forEach(o=>o.classList.remove("selected")),c.setSelectedFaultBib(s.value.padStart(3,"0"))})),n?c.setSelectedFaultBib(n):c.setSelectedFaultBib("");const r=document.getElementById("fault-gate-selector");if(r&&e.gateAssignment){const[o,l]=e.gateAssignment;let g="";for(let u=o;u<=l;u++){const y=c.getGateColor(u)==="red"?"gate-red":"gate-blue";g+=`<button class="fault-gate-btn ${y}" data-gate="${u}">${u}</button>`}r.innerHTML=g,r.querySelectorAll(".fault-gate-btn").forEach(u=>{u.addEventListener("click",()=>{r.querySelectorAll(".fault-gate-btn").forEach(f=>f.classList.remove("selected")),u.classList.add("selected")})})}const a=document.getElementById("fault-type-buttons");a&&a.querySelectorAll(".fault-type-btn").forEach(o=>{o.classList.remove("selected")}),B(document.getElementById("fault-modal"))}function Sr(){const n=document.getElementById("fault-type-buttons");n&&n.addEventListener("click",t=>{const s=t.target.closest(".fault-type-btn");if(!s)return;s.getAttribute("data-fault")&&(n.querySelectorAll(".fault-type-btn").forEach(a=>a.classList.remove("selected")),s.classList.add("selected"),I())});const e=document.getElementById("save-fault-btn");e&&e.addEventListener("click",()=>{const t=document.querySelector("#fault-type-buttons .fault-type-btn.selected");if(!t){const s=c.getState().currentLang;E(d("selectFaultType",s),"warning");return}const i=t.getAttribute("data-fault");i&&Er(i)})}function Er(n){const e=c.getState();let t=e.selectedFaultBib;if(!t){const l=document.getElementById("fault-bib-input");t=(l==null?void 0:l.value.padStart(3,"0"))||""}if(!t){const l=e.currentLang;E(d("selectBib",l),"warning");return}const i=document.querySelector("#fault-gate-selector .fault-gate-btn.selected"),s=i?parseInt(i.getAttribute("data-gate")||"0",10):0;if(!s){const l=e.currentLang;E(d("selectGate",l),"warning");return}const r={id:`fault-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,bib:t,run:e.selectedRun,gateNumber:s,faultType:n,timestamp:new Date().toISOString(),deviceId:e.deviceId,deviceName:e.deviceName,gateRange:e.gateAssignment||[1,1]};c.addFaultEntry(r),F();const a=c.getState().faultEntries.find(l=>l.id===r.id);a&&(le(a),Wt(a)),P(document.getElementById("fault-modal")),te();const o=e.currentLang;E(d("faultRecorded",o),"success")}function wr(n,e,t){const i=c.getState();if(i.gateAssignment){const[l,g]=i.gateAssignment;if(e<l||e>g){const u=i.currentLang;E(d("gateOutOfRange",u),"warning");return}}const s=n.padStart(3,"0"),r={id:`fault-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,bib:s,run:i.selectedRun,gateNumber:e,faultType:t,timestamp:new Date().toISOString(),deviceId:i.deviceId,deviceName:i.deviceName,gateRange:i.gateAssignment||[1,1]};c.addFaultEntry(r),F();const a=c.getState().faultEntries.find(l=>l.id===r.id);a&&(le(a),Wt(a)),te();const o=i.currentLang;E(d("faultRecorded",o),"success")}function Wt(n){const e=document.getElementById("fault-confirmation-overlay");if(!e)return;const t=e.querySelector(".fault-confirmation-bib"),i=e.querySelector(".fault-confirmation-gate"),s=e.querySelector(".fault-confirmation-type"),r=c.getState();t&&(t.textContent=n.bib),i&&(i.textContent=`${d("gate",r.currentLang)} ${n.gateNumber}`),s&&(s.textContent=lt(n.faultType,r.currentLang)),e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},1500)}function Ir(){const n=document.getElementById("save-fault-edit-btn");n&&n.addEventListener("click",Cr);const e=document.getElementById("restore-version-btn");e&&e.addEventListener("click",Lr);const t=document.getElementById("fault-edit-bib-input");t&&rt(t,3);const i=document.getElementById("fault-edit-run-selector");i&&i.addEventListener("click",r=>{const o=r.target.closest(".edit-run-btn");o&&i.querySelectorAll(".edit-run-btn").forEach(l=>{l.classList.toggle("active",l===o)})});const s=document.getElementById("confirm-mark-deletion-btn");s&&s.addEventListener("click",Tr)}function Wn(n){if(n.markedForDeletion){const u=c.getState().currentLang;E(d("cannotEditPendingDeletion",u),"warning");return}const e=document.getElementById("fault-edit-modal");if(!e)return;$=n.id;const i=c.getState().currentLang,s=document.getElementById("fault-edit-bib-input"),r=document.getElementById("fault-edit-gate-input"),a=document.getElementById("fault-edit-type-select"),o=document.getElementById("fault-edit-gate-range"),l=document.getElementById("fault-version-select");s&&(s.value=n.bib||""),r&&(r.value=String(n.gateNumber)),a&&(a.value=n.faultType),o&&n.gateRange&&(o.textContent=`(${d("gates",i)} ${n.gateRange[0]}-${n.gateRange[1]})`);const g=document.getElementById("fault-edit-run-selector");if(g&&g.querySelectorAll(".edit-run-btn").forEach(u=>{const f=u.getAttribute("data-run");u.classList.toggle("active",f===String(n.run))}),l){l.innerHTML="";const u=document.createElement("option");u.value=String(n.currentVersion||1),u.textContent=`v${n.currentVersion||1} - ${d("currentVersion",i)}`,l.appendChild(u);const y=[...n.versionHistory||[]].sort((v,S)=>S.version-v.version).filter(v=>v.version!==n.currentVersion);for(const v of y){const S=document.createElement("option");S.value=String(v.version);const b=new Date(v.timestamp).toLocaleTimeString(i==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"}),w=v.changeType==="create"?d("originalVersion",i):v.changeType==="restore"?d("restored",i):v.editedBy;S.textContent=`v${v.version} - ${w} (${b})`,l.appendChild(S)}}B(e)}function Cr(){if(!$)return;const n=c.getState(),e=n.faultEntries.find(C=>C.id===$);if(!e)return;const t=document.getElementById("fault-edit-bib-input"),i=document.getElementById("fault-edit-gate-input"),s=document.getElementById("fault-edit-type-select"),r=document.getElementById("fault-edit-run-selector"),a=(t==null?void 0:t.value.padStart(3,"0"))||e.bib,o=parseInt((i==null?void 0:i.value)||String(e.gateNumber),10),l=(s==null?void 0:s.value)||e.faultType,g=n.currentLang;e.gateRange&&(o<e.gateRange[0]||o>e.gateRange[1])&&E(d("gateOutOfRange",g),"warning");const u=r==null?void 0:r.querySelector(".edit-run-btn.active"),f=u?parseInt(u.getAttribute("data-run")||"1",10):e.run,y=[];a!==e.bib&&y.push(`bib: ${e.bib} → ${a}`),o!==e.gateNumber&&y.push(`gate: ${e.gateNumber} → ${o}`),l!==e.faultType&&y.push(`type: ${e.faultType} → ${l}`),f!==e.run&&y.push(`run: ${e.run} → ${f}`);const v=y.length>0?y.join(", "):void 0;if(c.updateFaultEntryWithHistory($,{bib:a,gateNumber:o,faultType:l,run:f},v)){const C=c.getState().faultEntries.find(b=>b.id===$);C&&le(C),E(d("saved",g),"success"),H()}P(document.getElementById("fault-edit-modal")),$=null}function Lr(){if(!$)return;const n=document.getElementById("fault-version-select"),e=parseInt((n==null?void 0:n.value)||"0",10);if(!e)return;const t=c.getState(),i=t.faultEntries.find(r=>r.id===$);if(i&&e===i.currentVersion)return;if(c.restoreFaultVersion($,e)){const r=c.getState().faultEntries.find(o=>o.id===$);r&&le(r);const a=t.currentLang;E(d("versionRestored",a),"success"),H(),P(document.getElementById("fault-edit-modal")),$=null}}function Yn(n){const e=document.getElementById("mark-deletion-modal");if(!e)return;$=n.id;const i=c.getState().currentLang,s=document.getElementById("mark-deletion-details");s&&(s.innerHTML=`
      <div>#${n.bib.padStart(3,"0")} T${n.gateNumber} (${lt(n.faultType,i)}) - ${d(n.run===1?"run1":"run2",i)}</div>
    `),B(e)}function Tr(){if(!$)return;if(c.markFaultForDeletion($)){const e=c.getState().faultEntries.find(i=>i.id===$);e&&le(e);const t=c.getState().currentLang;E(d("markedForDeletion",t),"info"),I()}P(document.getElementById("mark-deletion-modal")),$=null}function te(){const n=document.getElementById("active-bibs-list"),e=document.getElementById("no-active-bibs");if(!n)return;const t=c.getState(),i=c.getActiveBibs(t.selectedRun);if(n.querySelectorAll(".active-bib-card").forEach(a=>a.remove()),i.length===0){e&&(e.style.display="");return}e&&(e.style.display="none");const s=new Map;t.entries.forEach(a=>{a.point==="S"&&a.run===t.selectedRun&&s.set(a.bib,new Date(a.timestamp))}),[...i].sort((a,o)=>{var u,f;const l=((u=s.get(a))==null?void 0:u.getTime())||0;return(((f=s.get(o))==null?void 0:f.getTime())||0)-l}).forEach(a=>{const o=s.get(a),l=c.getFaultsForBib(a,t.selectedRun),g=l.length>0,u=document.createElement("div");u.className=`active-bib-card${g?" has-fault":""}`,u.setAttribute("data-bib",a),u.setAttribute("role","listitem");const f=o?oe(o):"--:--:--";u.innerHTML=`
      <div class="bib-card-info">
        <span class="bib-card-number">${k(a)}</span>
        <span class="bib-card-time">${k(f)}</span>
        ${g?`<span class="bib-fault-indicator">${l.length} ${d("faultCount",t.currentLang)}</span>`:""}
      </div>
      <div class="bib-card-actions">
        <button class="bib-action-btn fault" data-action="fault">${d("faultMGShort",t.currentLang)}</button>
        <button class="bib-action-btn ok" data-action="ok">${d("ok",t.currentLang)}</button>
      </div>
    `,u.addEventListener("click",y=>{const S=y.target.closest(".bib-action-btn");if(S){const C=S.getAttribute("data-action");C==="fault"?(I(),jn(a)):C==="ok"&&(I(),E(d("ok",t.currentLang),"success",1e3))}}),n.appendChild(u)})}function Me(){const n=document.getElementById("gate-judge-faults-list"),e=document.getElementById("inline-fault-count"),t=document.getElementById("no-faults-recorded-inline");if(!n)return;const i=c.getState(),s=i.faultEntries.filter(a=>a.run===i.selectedRun&&!a.markedForDeletion);if(e&&(e.textContent=String(s.length),e.setAttribute("data-count",String(s.length))),n.querySelectorAll(".gate-judge-fault-item").forEach(a=>a.remove()),s.length===0){t&&(t.style.display="");return}t&&(t.style.display="none"),[...s].sort((a,o)=>new Date(o.timestamp).getTime()-new Date(a.timestamp).getTime()).forEach(a=>{const o=c.getGateColor(a.gateNumber),l=document.createElement("div");l.className="gate-judge-fault-item",l.setAttribute("data-fault-id",a.id),l.innerHTML=`
      <div class="gate-judge-fault-info">
        <span class="gate-judge-fault-bib">${k(a.bib)}</span>
        <div class="gate-judge-fault-details">
          <span class="gate-judge-fault-gate ${o}">T${a.gateNumber}</span>
          <span class="gate-judge-fault-type">${k(a.faultType)}</span>
        </div>
      </div>
      <button class="gate-judge-fault-delete" aria-label="Delete">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18"/>
          <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6"/>
          <path d="M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    `;const g=l.querySelector(".gate-judge-fault-delete");g&&g.addEventListener("click",u=>{u.stopPropagation(),I(),Dr(a)}),n.appendChild(l)})}function Yt(){const n=document.getElementById("inline-bib-selector");if(!n)return;const e=c.getState(),t=c.getActiveBibs(e.selectedRun);n.innerHTML="",t.slice(0,6).forEach(s=>{const r=document.createElement("button");r.className="inline-bib-btn",r.setAttribute("data-bib",s),r.textContent=s,s===Ee&&r.classList.add("selected"),r.addEventListener("click",()=>{I(),kr(s)}),n.appendChild(r)})}function kr(n){Ee=n,document.querySelectorAll("#inline-bib-selector .inline-bib-btn").forEach(t=>{t.classList.toggle("selected",t.getAttribute("data-bib")===n)});const e=document.getElementById("inline-bib-input");e&&(e.value=n),we()}function Qn(){const n=document.getElementById("inline-gate-selector");if(!n)return;const e=c.getState(),[t,i]=e.gateAssignment||[1,10];n.innerHTML="";for(let s=t;s<=i;s++){const r=c.getGateColor(s),a=document.createElement("button");a.className=`inline-gate-btn ${r}`,a.setAttribute("data-gate",String(s)),a.textContent=String(s),s===pe&&a.classList.add("selected"),a.addEventListener("click",()=>{I(),Rr(s)}),n.appendChild(a)}}function Rr(n){pe=n,document.querySelectorAll("#inline-gate-selector .inline-gate-btn").forEach(e=>{e.classList.toggle("selected",e.getAttribute("data-gate")===String(n))}),we()}function Ar(){const n=document.getElementById("inline-bib-input");n&&(rt(n,3),n.addEventListener("input",()=>{n.value&&(Ee=n.value.padStart(3,"0"),document.querySelectorAll("#inline-bib-selector .inline-bib-btn").forEach(i=>{i.classList.remove("selected")}),we())}));const e=document.getElementById("inline-fault-types");e&&e.addEventListener("click",i=>{const r=i.target.closest(".inline-fault-type-btn");if(!r)return;I(),Te=r.getAttribute("data-fault"),e.querySelectorAll(".inline-fault-type-btn").forEach(o=>{o.classList.toggle("selected",o===r)}),we()});const t=document.getElementById("inline-save-fault-btn");t&&t.addEventListener("click",()=>{xr()})}function we(){const n=document.getElementById("inline-save-fault-btn");if(n){const e=Ee&&pe>0&&Te;n.disabled=!e}}function xr(){const n=c.getState();if(!Ee){E(d("selectBib",n.currentLang),"warning");return}if(!pe){E(d("selectGate",n.currentLang),"warning");return}if(!Te){E(d("selectFaultType",n.currentLang),"warning");return}const e={id:`fault-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,bib:Ee,run:n.selectedRun,gateNumber:pe,faultType:Te,timestamp:new Date().toISOString(),deviceId:n.deviceId,deviceName:n.deviceName,gateRange:n.gateAssignment||[1,1]};c.addFaultEntry(e),F();const t=c.getState().faultEntries.find(i=>i.id===e.id);t&&(le(t),Wt(t)),pe=0,Te=null,document.querySelectorAll("#inline-gate-selector .inline-gate-btn").forEach(i=>{i.classList.remove("selected")}),document.querySelectorAll("#inline-fault-types .inline-fault-type-btn").forEach(i=>{i.classList.remove("selected")}),Me(),Yt(),we(),E(d("faultRecorded",n.currentLang),"success")}function Dr(n){const e=document.getElementById("fault-delete-modal");if(!e){c.markFaultForDeletion(n.id);const r=c.getState().faultEntries.find(a=>a.id===n.id);r&&Gt(r),Me(),E(d("faultDeleted",c.getState().currentLang),"success");return}e.setAttribute("data-fault-id",n.id);const t=c.getState(),i=c.getGateColor(n.gateNumber),s=e.querySelector(".delete-fault-info");s&&(s.innerHTML=`
      <strong>#${k(n.bib)}</strong> -
      <span class="fault-gate ${i}">T${n.gateNumber}</span>
      (${k(n.faultType)}) -
      ${d("run1",t.currentLang).replace("1",String(n.run))}
    `),B(e)}function st(){Me(),Yt(),Qn(),we()}let Ft=null;function Pr(n){Ft=n}function Qt(){const n=m("timer-tab"),e=m("gate-judge-tab"),t=document.querySelector(".tab-bar"),s=c.getState().deviceRole==="gateJudge";n&&(n.style.display=s?"none":""),e&&(e.style.display=s?"":"none"),t&&t.classList.toggle("gate-judge-mode",s)}function Br(){Ft&&Ft(),Qt();const n=m("gate-change-btn");n&&n.addEventListener("click",()=>{I(),Fr()});const e=m("gate-judge-run-selector");e&&e.addEventListener("click",s=>{const a=s.target.closest(".run-btn");if(!a)return;const o=a.getAttribute("data-run"),l=o?parseInt(o,10):1;c.setSelectedRun(l),I(),e.querySelectorAll(".run-btn").forEach(g=>{g.classList.toggle("active",g===a),g.setAttribute("aria-checked",g===a?"true":"false")}),te(),st()});const t=m("record-fault-btn");t&&t.addEventListener("click",()=>{I(),jn()});const i=m("ready-toggle-btn");i&&(i.addEventListener("click",()=>{const s=c.getState(),r=!s.isJudgeReady;c.setJudgeReady(r),H(),Nt();const a=s.currentLang;E(d(r?"judgeReady":"judgeNotReady",a),"success")}),Nt()),Nr(),Sr(),Ar(),st(),ut()}function Fr(){const n=c.getState(),e=m("gate-start-input"),t=m("gate-end-input");e&&t&&(n.gateAssignment?(e.value=String(n.gateAssignment[0]),t.value=String(n.gateAssignment[1])):(e.value="1",t.value="10"));const i=m("gate-color-selector");i&&i.querySelectorAll(".gate-color-btn").forEach(s=>{const r=s.getAttribute("data-color");s.classList.toggle("active",r===n.firstGateColor)}),B(m("gate-assignment-modal"))}function Nr(){const n=m("gate-color-selector");n&&n.addEventListener("click",t=>{const i=t.target.closest(".gate-color-btn");i&&(n.querySelectorAll(".gate-color-btn").forEach(s=>s.classList.remove("active")),i.classList.add("active"),I())});const e=m("save-gate-assignment-btn");e&&e.addEventListener("click",()=>{const t=m("gate-start-input"),i=m("gate-end-input");if(!t||!i)return;const s=parseInt(t.value,10)||1,r=parseInt(i.value,10)||10,a=Math.min(s,r),o=Math.max(s,r),l=document.querySelector("#gate-color-selector .gate-color-btn.active"),g=(l==null?void 0:l.getAttribute("data-color"))||"red";c.setGateAssignment([a,o]),c.setFirstGateColor(g),ut(),P(m("gate-assignment-modal")),H();const u=c.getState().currentLang;E(d("saved",u),"success")})}function ut(){const n=m("gate-range-display");if(!n)return;const e=c.getState();e.gateAssignment?n.textContent=`${e.gateAssignment[0]}–${e.gateAssignment[1]}`:n.textContent="--",$r()}function $r(){const n=m("other-judges-coverage"),e=m("other-judges-list");if(!n||!e)return;if(!c.getState().settings.sync){n.style.display="none";return}const i=D.getOtherGateAssignments();if(i.length===0){n.style.display="none";return}n.style.display="flex",e.innerHTML=i.map(s=>`
    <div class="coverage-badge ${s.isReady?"ready":""}" title="${k(s.deviceName)}${s.isReady?" - Ready":""}">
      ${s.isReady?'<span class="ready-check">✓</span>':""}
      <span class="device-name">${k(s.deviceName.slice(0,15))}</span>
      <span class="gate-range">${s.gateStart}–${s.gateEnd}</span>
    </div>
  `).join(""),Mr(i),ye()}function Nt(){const n=m("ready-toggle-btn");if(!n)return;const e=c.getState();n.classList.toggle("ready",e.isJudgeReady)}function Mr(n){const e=m("judges-ready-indicator"),t=m("judges-ready-count");if(!e||!t)return;const i=c.getState();if(!i.settings.sync){e.style.display="none";return}const s=n||D.getOtherGateAssignments();let r=s.length,a=s.filter(o=>o.isReady).length;if(i.deviceRole==="gateJudge"&&i.gateAssignment&&(r++,i.isJudgeReady&&a++),r===0){e.style.display="none";return}e.style.display="flex",t.textContent=`${a}/${r}`,e.classList.toggle("all-ready",a===r&&r>0)}function ye(){const n=m("gps-indicator"),e=m("judge-ready-indicator");if(!e)return;const t=c.getState(),i=t.deviceRole==="gateJudge";if(n&&(n.style.display=!i&&t.settings.gps?"flex":"none"),!i){e.style.display="none";return}e.style.display="flex";const s=D.getOtherGateAssignments();let r=s.length,a=s.filter(o=>o.isReady).length;t.gateAssignment&&(r++,t.isJudgeReady&&a++),e.classList.remove("none-ready","some-ready","all-ready"),r===0||a===0?e.classList.add("none-ready"):a===r?e.classList.add("all-ready"):e.classList.add("some-ready")}function Kt(){const n=c.getState(),e=m("gate-judge-run-selector");e&&e.querySelectorAll(".run-btn").forEach(t=>{const i=t.getAttribute("data-run")===String(n.selectedRun);t.classList.toggle("active",i),t.setAttribute("aria-checked",String(i))})}function Hr(n){var e,t,i,s;switch(p.debug("[GateJudgeView] Voice intent:",n.action,n.params),n.action){case"record_fault":(e=n.params)!=null&&e.bib&&((t=n.params)==null?void 0:t.gate)!==void 0&&((i=n.params)!=null&&i.faultType)&&wr(n.params.bib,n.params.gate,n.params.faultType);break;case"toggle_ready":{const r=c.getState(),a=!r.isJudgeReady;c.setJudgeReady(a),H(),Nt();const o=r.currentLang;E(d(a?"judgeReady":"judgeNotReady",o),"success");break}case"set_run":(s=n.params)!=null&&s.run&&(c.setSelectedRun(n.params.run),Kt(),te(),st(),I());break;default:p.debug("[GateJudgeView] Unhandled voice intent:",n.action)}}const Kn="/api/v1/admin/races",Vr="1111";let _e=null,M=null;async function xe(n,e){const t=await $n(n,e);return t.success&&De(),t}function Or(n,e){return new Promise(t=>{const i=document.getElementById("race-change-modal");if(!i){t("cancel");return}const s=i.querySelector(".modal-title"),r=i.querySelector(".modal-text"),a=document.getElementById("race-change-export-btn"),o=document.getElementById("race-change-delete-btn"),l=document.getElementById("race-change-keep-btn"),g=i.querySelector('[data-action="cancel"]');n==="synced"?(s&&(s.textContent=d("raceChangeTitle",e)),r&&(r.textContent=d("raceChangeSyncedText",e)),a&&(a.style.display=""),l&&(l.style.display="none")):(s&&(s.textContent=d("raceChangeTitle",e)),r&&(r.textContent=d("raceChangeUnsyncedText",e)),a&&(a.style.display="none"),l&&(l.style.display=""));const u=()=>{P(i),a==null||a.removeEventListener("click",f),o==null||o.removeEventListener("click",y),l==null||l.removeEventListener("click",v),g==null||g.removeEventListener("click",S)},f=()=>{u(),t("export")},y=()=>{u(),t("delete")},v=()=>{u(),t("keep")},S=()=>{u(),t("cancel")};a==null||a.addEventListener("click",f),o==null||o.addEventListener("click",y),l==null||l.addEventListener("click",v),g==null||g.addEventListener("click",S),B(i)})}async function zr(){ne()||await xe(Vr)}function Ln(n){return/^\d{4}$/.test(n)}function De(){const n=c.getState().currentLang,e=ne(),t=document.getElementById("admin-pin-status"),i=document.getElementById("change-pin-btn-text");t&&(t.textContent=d(e?"pinSet":"pinNotSet",n)),i&&(i.textContent=d(e?"changePin":"setPin",n))}function Gr(){zr().then(()=>{De()}),De();const n=document.getElementById("change-pin-btn");n&&n.addEventListener("click",Ur);const e=document.getElementById("save-pin-btn");e&&e.addEventListener("click",Jr),["admin-pin-verify-input","current-pin-input","new-pin-input","confirm-pin-input"].forEach(u=>{const f=document.getElementById(u);f&&rt(f)});const i=document.getElementById("manage-races-btn");i&&i.addEventListener("click",jr);const s=document.getElementById("admin-pin-verify-btn");s&&s.addEventListener("click",()=>{M?kn():Tn()});const r=document.getElementById("admin-pin-verify-input");r&&r.addEventListener("keydown",u=>{u.key==="Enter"&&(M?kn():Tn())});const a=document.getElementById("admin-pin-modal");a&&a.addEventListener("click",u=>{u.target===a&&M&&Yr()});const o=document.getElementById("race-deleted-ok-btn");o&&o.addEventListener("click",()=>{const u=document.getElementById("race-deleted-modal");P(u)});const l=document.getElementById("refresh-races-btn");l&&l.addEventListener("click",Zt);const g=document.getElementById("confirm-delete-race-btn");g&&g.addEventListener("click",Xr),qr()}function Ur(){const n=c.getState().currentLang,e=ne(),t=document.getElementById("change-pin-modal"),i=document.getElementById("change-pin-modal-title"),s=document.getElementById("current-pin-row"),r=document.getElementById("current-pin-input"),a=document.getElementById("new-pin-input"),o=document.getElementById("confirm-pin-input");t&&(r&&(r.value=""),a&&(a.value=""),o&&(o.value=""),Zn(),e?(s&&(s.style.display="block"),i&&(i.textContent=d("changePin",n))):(s&&(s.style.display="none"),i&&(i.textContent=d("setPin",n))),B(t),e&&r?r.focus():a&&a.focus())}function Zn(){["current-pin-error","pin-mismatch-error","pin-format-error"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="none")})}async function Jr(){const n=c.getState().currentLang,e=ne(),t=document.getElementById("current-pin-input"),i=document.getElementById("new-pin-input"),s=document.getElementById("confirm-pin-input"),r=document.getElementById("current-pin-error"),a=document.getElementById("pin-mismatch-error"),o=document.getElementById("pin-format-error");Zn();const l=(t==null?void 0:t.value)||"",g=(i==null?void 0:i.value)||"",u=(s==null?void 0:s.value)||"";if(!Ln(g)){o&&(o.style.display="block"),i&&i.focus(),F();return}if(g!==u){a&&(a.style.display="block"),s&&(s.value="",s.focus()),F();return}if(e){if(!Ln(l)){r&&(r.style.display="block"),t&&t.focus(),F();return}try{const f=await fetch("/api/v1/admin/pin",{method:"POST",headers:{...j(),"Content-Type":"application/json"},body:JSON.stringify({currentPin:l,newPin:g})});if(f.status===401){r&&(r.style.display="block"),t&&(t.value="",t.focus()),F();return}if(!f.ok)throw new Error(`HTTP ${f.status}`);if(Nn(),!(await xe(g)).success){E(d("pinSyncFailed",n),"error"),F();return}const v=document.getElementById("change-pin-modal");P(v),E(d("pinSaved",n),"success"),H(),De()}catch(f){Rt("Admin","handleSavePin",f,"pinSyncFailed"),E(d("pinSyncFailed",n),"error"),F()}}else{if(!(await xe(g)).success){E(d("pinSyncFailed",n),"error"),F();return}const y=document.getElementById("change-pin-modal");P(y),E(d("pinSaved",n),"success"),H(),De()}}function Xn(n){const{raceId:e,message:t}=n.detail,i=c.getState().currentLang,s=document.getElementById("race-deleted-text");s&&(s.textContent=`${d("raceDeletedFor",i)} "${e}". ${t||d("raceDeletedText",i)}`);const r=document.getElementById("race-deleted-modal");r&&B(r),c.updateSettings({sync:!1}),c.setRaceId("");const a=document.getElementById("sync-toggle");a&&(a.checked=!1);const o=document.getElementById("race-id-input");o&&(o.value=""),F()}function ei(n){const{message:e}=n.detail,t=c.getState().currentLang;E(e||"Session expired. Please re-enter your PIN.","warning",5e3),$t(t).then(i=>{if(i){const s=c.getState();s.settings.sync&&s.raceId&&D.initialize(),E("Authentication successful","success")}}),F()}async function _r(){const n=document.getElementById("photo-sync-modal");if(!n)return;const e=c.getState().currentLang,t=document.getElementById("photos-upload-count"),i=document.getElementById("photos-download-count"),s=document.getElementById("photos-total-size");t&&(t.textContent=d("loading",e)),i&&(i.textContent=d("loading",e)),s&&(s.textContent=d("loading",e)),B(n);const r=await D.getPhotoSyncStats();t&&(t.textContent=String(r.uploadCount)),i&&(i.textContent=String(r.downloadCount)),s&&(s.textContent=Fi(r.totalSize));const a=document.getElementById("photo-sync-confirm-btn");a&&(a.textContent=d("enableSync",e))}function qr(){const n=document.getElementById("photo-sync-modal"),e=document.getElementById("photo-sync-cancel-btn"),t=document.getElementById("photo-sync-confirm-btn");e&&e.addEventListener("click",()=>{n&&n.classList.remove("show")}),t&&t.addEventListener("click",()=>{c.updateSettings({syncPhotos:!0});const i=document.getElementById("sync-photos-toggle");i&&(i.checked=!0),n&&n.classList.remove("show");const s=c.getState();s.settings.sync&&s.raceId&&D.forceRefresh(),H()}),n&&n.addEventListener("click",i=>{i.target===n&&n.classList.remove("show")})}function jr(){const n=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input"),t=document.getElementById("admin-pin-error"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),r=c.getState().currentLang;n&&e&&t&&(e.value="",t.style.display="none",i&&(i.textContent=d("enterAdminPin",r)),s&&(s.textContent=d("enterPinText",r)),B(n),e.focus())}async function Tn(){const n=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),t=document.getElementById("admin-pin-modal");if(!n||!t)return;const i=n.value.trim();(await xe(i)).success?(P(t),n.value="",e&&(e.style.display="none"),Qr()):(e&&(e.style.display="block"),n.value="",n.focus(),F())}function $t(n){return new Promise(e=>{if(ne()){e(!0);return}const t=document.getElementById("admin-pin-modal"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),r=document.getElementById("admin-pin-verify-input"),a=document.getElementById("admin-pin-error");if(!t||!r){e(!1);return}i&&(i.textContent=d("enterAdminPin",n)),s&&(s.textContent=d("enterPinToJoinRace",n)),a&&(a.style.display="none"),r.value="",M={type:"raceJoin",resolve:e},B(t),setTimeout(()=>r.focus(),100)})}function Wr(n){return new Promise(e=>{const t=document.getElementById("admin-pin-modal"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),r=document.getElementById("admin-pin-verify-input"),a=document.getElementById("admin-pin-error");if(!t||!r){e(!1);return}i&&(i.textContent=d("enterChiefJudgePin",n)),s&&(s.textContent=d("enterPinForChiefJudgeInfo",n)),a&&(a.style.display="none"),r.value="",M={type:"chiefJudge",resolve:e},B(t),setTimeout(()=>r.focus(),100)})}async function kn(){const n=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),t=document.getElementById("admin-pin-modal");if(!n||!t||!M)return;const i=n.value.trim(),s=M.type==="chiefJudge"?"chiefJudge":void 0;(await xe(i,s)).success?(P(t),n.value="",e&&(e.style.display="none"),M.resolve(!0),M=null):(e&&(e.style.display="block"),n.value="",n.focus(),F())}function Yr(){const n=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input");P(n),e&&(e.value=""),M&&(M.resolve(!1),M=null)}function Qr(){const n=document.getElementById("race-management-modal");n&&(B(n),Zt())}async function Zt(){const n=document.getElementById("race-list"),e=document.getElementById("race-list-loading"),t=document.getElementById("race-list-empty"),i=c.getState().currentLang;if(n){n.setAttribute("aria-busy","true"),e&&(e.style.display="block"),t&&(t.style.display="none"),n.querySelectorAll(".race-item").forEach(s=>s.remove());try{const s=await J(Kn,{headers:j()},1e4);if(!s.ok){if(s.status===401){const o=document.getElementById("race-management-modal");P(o),E(d("authError",i),"error"),p.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${s.status}`)}const a=(await s.json()).races||[];if(n.setAttribute("aria-busy","false"),e&&(e.style.display="none"),a.length===0){t&&(t.style.display="block");return}a.forEach(o=>{const l=Kr(o,i);n.appendChild(l)})}catch(s){at("Admin","loadRaceList",s,"loadError"),E(d("loadError",i),"error"),n.setAttribute("aria-busy","false"),e&&(e.style.display="none")}}}function Kr(n,e){const t=document.createElement("div");t.className="race-item",t.setAttribute("data-race-id",n.raceId);const i=document.createElement("div");i.className="race-info";const s=document.createElement("span");s.className="race-id",s.textContent=n.raceId.toUpperCase();const r=document.createElement("span");r.className="race-meta";const a=n.entryCount===1?d("entry",e):d("entries",e),o=n.deviceCount===1?d("device",e):d("devices",e);r.textContent=`${n.entryCount} ${a}, ${n.deviceCount} ${o}`,i.appendChild(s),i.appendChild(r);const l=document.createElement("button");return l.className="race-delete-btn danger",l.textContent=d("delete",e),l.addEventListener("click",()=>Zr(n.raceId)),t.appendChild(i),t.appendChild(l),t}function Zr(n){const e=c.getState().currentLang;_e=n;const t=document.getElementById("delete-race-confirm-modal"),i=document.getElementById("delete-race-confirm-text");i&&(i.textContent=`${d("confirmDeleteRaceText",e)} "${n.toUpperCase()}"?`),t&&B(t)}async function Xr(){if(!_e)return;const n=_e,e=c.getState().currentLang,t=document.getElementById("delete-race-confirm-modal");P(t);try{const i=await J(`${Kn}?raceId=${encodeURIComponent(n)}`,{method:"DELETE",headers:j()},1e4);if(!i.ok){if(i.status===401){const r=document.getElementById("race-management-modal");P(r),E(d("authError",e),"error"),p.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${i.status}`)}const s=await i.json();if(s.success)E(`${d("raceDeletedSuccess",e)} ${n.toUpperCase()}`,"success"),ct(),Zt();else throw new Error(s.error||d("unknownError",e))}catch(i){at("Admin","deleteRace",i,"deleteError")}finally{_e=null}}function ti(){return M?(M.resolve(!1),M=null,!0):!1}function ea(){return M!==null}let ae=null,Y=null,Mt=[],qe=null,je=null,W=null;function ta(n){qe=n.openEditModal,je=n.promptDelete,W=n.openConfirmModal}function Q(n,e,t){n&&(n.addEventListener(e,t),Mt.push({element:n,event:e,handler:t}))}function ni(){for(const{element:n,event:e,handler:t}of Mt)n==null||n.removeEventListener(e,t);Mt=[]}function ii(){return ae}function na(){ni(),Y&&(clearTimeout(Y),Y=null);const n=m("results-list");if(!n)return;ae=new ks({container:n,onItemClick:a=>qe==null?void 0:qe(a),onItemDelete:a=>je==null?void 0:je(a),onItemSelect:(a,o)=>{c.toggleEntrySelection(a.id)},onViewPhoto:a=>cr(a)}),Q(n,"fault-edit-request",a=>{var l;const o=(l=a.detail)==null?void 0:l.fault;o&&Wn(o)}),Q(n,"fault-delete-request",a=>{var l;const o=(l=a.detail)==null?void 0:l.fault;o&&Yn(o)});const e=c.getState();ae.setEntries(e.entries),gt();const t=document.querySelector(".results-view");t&&new Ds({container:t,onRefresh:async()=>{await D.forceRefresh(),E(d("syncReceived",c.getState().currentLang),"success")}});const i=m("search-input");i&&Q(i,"input",()=>{Y&&clearTimeout(Y),Y=setTimeout(()=>{Lt()},300)});const s=m("filter-point"),r=m("filter-status");Q(s,"change",Lt),Q(r,"change",Lt),ia(),e.currentView!=="results"&&ae&&ae.pause()}function ia(){Q(m("clear-all-btn"),"click",()=>{const n=c.getState();if(n.entries.length===0){E(d("noEntries",n.currentLang),"info");return}W==null||W("clearAll")}),Q(m("undo-btn"),"click",()=>{if(c.canUndo()){const n=c.peekUndo();if(n&&n.type==="ADD_ENTRY")W==null||W("undoAdd");else{const e=c.undo();Hn(),E(d("undone",c.getState().currentLang),"success");const t=c.getState();if(e&&e.type==="ADD_ENTRY"&&t.settings.sync&&t.raceId){const i=e.data;D.deleteEntryFromCloud(i.id,i.deviceId)}}}}),Q(m("export-btn"),"click",jt),Q(m("delete-selected-btn"),"click",()=>{c.getState().selectedEntries.size>0&&(W==null||W("deleteSelected"))}),mr({verifyPinForChiefJudge:Wr,openFaultEditModal:Wn,openMarkDeletionModal:Yn,updateInlineFaultsList:Me,updateInlineBibSelector:Yt,updateInlineGateSelector:Qn})}function Lt(){if(!ae)return;const n=m("search-input"),e=m("filter-point"),t=m("filter-status");ae.applyFilters((n==null?void 0:n.value)||"",(e==null?void 0:e.value)||"all",(t==null?void 0:t.value)||"all"),gt()}function gt(){const e=c.getState().entries,t=e.length,i=new Set(e.map(l=>l.bib)).size,s=new Set(e.filter(l=>l.point==="F"&&l.status==="ok").map(l=>l.bib)).size,r=m("stat-total"),a=m("stat-racers"),o=m("stat-finished");r&&(r.textContent=String(t)),a&&(a.textContent=String(i)),o&&(o.textContent=String(s))}function si(){const n=m("entry-count-badge");if(n){const e=c.getState().entries.length;n.textContent=String(e),n.style.display=e>0?"inline":"none"}}function sa(){Y&&(clearTimeout(Y),Y=null),ni()}let ve=null,Rn=0,Tt=null,Ht={exists:null,entryCount:0},Vt=null,We=null;function ra(n){Vt=n.showPhotoSyncWarningModal,We=n.showRaceChangeDialog}function aa(){const n=m("simple-mode-toggle");n&&n.addEventListener("change",()=>{c.updateSettings({simple:n.checked}),ai();const b=m("admin-section");b&&(b.style.display="block")});const e=m("gps-toggle");e&&e.addEventListener("change",()=>{c.updateSettings({gps:e.checked})});const t=m("sync-toggle");let i=!1;t&&t.addEventListener("change",async()=>{if(i){t.checked=!t.checked;return}i=!0;try{const b=c.getState();if(t.checked&&b.raceId&&!await $t(b.currentLang)){t.checked=!1;return}c.updateSettings({sync:t.checked});const w=m("sync-photos-toggle");w&&(w.disabled=!t.checked,t.checked||(w.checked=!1,c.updateSettings({syncPhotos:!1}))),t.checked&&b.raceId?D.initialize():D.cleanup()}finally{i=!1}});const s=m("sync-photos-toggle");s&&s.addEventListener("change",async b=>{const w=b.target;w.checked?(b.preventDefault(),w.checked=!1,Vt&&await Vt()):c.updateSettings({syncPhotos:!1})});const r=m("auto-toggle");r&&r.addEventListener("change",()=>{c.updateSettings({auto:r.checked})});const a=m("haptic-toggle");a&&a.addEventListener("change",()=>{c.updateSettings({haptic:a.checked})});const o=m("sound-toggle");o&&o.addEventListener("change",()=>{c.updateSettings({sound:o.checked})});const l=m("ambient-mode-toggle");l&&l.addEventListener("change",()=>{c.updateSettings({ambientMode:l.checked})}),da();const g=m("photo-toggle");g&&g.addEventListener("change",()=>{c.updateSettings({photoCapture:g.checked})});const u=m("lang-toggle");u&&u.addEventListener("click",b=>{const R=b.target.getAttribute("data-lang");R&&R!==c.getState().currentLang&&(c.setLanguage(R),en(),ri())});const f=m("race-id-input");let y=!1;f&&(f.addEventListener("input",()=>{ve&&clearTimeout(ve);const b=f.value.trim();b?ve=setTimeout(()=>ua(b),500):tn(null,0)}),f.addEventListener("change",async()=>{if(!y){y=!0;try{const b=f.value.trim(),w=c.getState(),R=w.entries.length>0,L=w.lastSyncedRaceId!=="",T=b!==w.raceId&&b!=="";if(R&&T&&We)if(L){const O=await We("synced",w.currentLang);if(O==="export")jt(),c.clearAll(),await V.clearAll();else if(O==="delete")c.clearAll(),await V.clearAll();else{f.value=w.raceId;return}}else{const O=await We("unsynced",w.currentLang);if(O==="delete")c.clearAll(),await V.clearAll();else if(O==="cancel"){f.value=w.raceId;return}}if(b&&!Pn(b)){E(d("invalidRaceId",w.currentLang),"error"),f.value=w.raceId,F();return}if(w.settings.sync&&b&&!await $t(w.currentLang)){f.value=w.raceId;return}w.settings.sync&&w.raceId&&D.cleanup();const x=b.toLowerCase();f.value=x,c.setRaceId(x),w.settings.sync&&x&&(D.initialize(),c.markCurrentRaceAsSynced())}finally{y=!1}}}));const v=m("settings-recent-races-btn"),S=m("settings-recent-races-dropdown");v&&S&&(v.addEventListener("click",()=>{I(),S.style.display==="none"?ga(S):S.style.display="none"}),Tt||(Tt=b=>{const w=b.target;!v.contains(w)&&!S.contains(w)&&(S.style.display="none")},document.addEventListener("click",Tt)));const C=m("device-name-input");C&&C.addEventListener("change",()=>{c.setDeviceName(C.value.trim())}),ca(),oa()}function oa(){const n=m("advanced-settings-toggle"),e=m("advanced-settings-section");!n||!e||(n.setAttribute("role","button"),n.setAttribute("aria-expanded",e.classList.contains("expanded")?"true":"false"),n.addEventListener("click",()=>{const t=e.classList.toggle("expanded");n.setAttribute("aria-expanded",String(t)),I()}))}function ca(){const n=m("role-toggle");n&&n.addEventListener("click",e=>{const i=e.target.closest(".role-card-setting");if(!i)return;const s=i.getAttribute("data-role");s&&s!==c.getState().deviceRole&&(c.setDeviceRole(s),Xt(),Qt(),I(),s==="gateJudge"&&!c.getState().gateAssignment&&B(m("gate-assignment-modal")),s!=="gateJudge"&&c.getState().currentView==="gateJudge"&&c.setView("timer"))})}function Xt(){const n=m("role-toggle");if(!n)return;const e=c.getState();n.querySelectorAll(".role-card-setting").forEach(t=>{const i=t.getAttribute("data-role");t.classList.toggle("active",i===e.deviceRole)})}function la(){const n=c.getState(),{settings:e}=n,t=m("simple-mode-toggle"),i=m("gps-toggle"),s=m("sync-toggle"),r=m("auto-toggle"),a=m("haptic-toggle"),o=m("sound-toggle"),l=m("photo-toggle");t&&(t.checked=e.simple);const g=m("admin-section");g&&(g.style.display="block"),i&&(i.checked=e.gps),s&&(s.checked=e.sync),r&&(r.checked=e.auto),a&&(a.checked=e.haptic),o&&(o.checked=e.sound),l&&(l.checked=e.photoCapture);const u=m("ambient-mode-toggle");u&&(u.checked=e.ambientMode);const f=m("sync-photos-toggle");f&&(f.checked=e.syncPhotos,f.disabled=!e.sync);const y=m("race-id-input");y&&(y.value=n.raceId);const v=m("device-name-input");v&&(v.value=n.deviceName),ri()}function ri(){const n=c.getState().currentLang,e=m("lang-toggle");e&&e.querySelectorAll(".lang-option").forEach(t=>{t.classList.toggle("active",t.getAttribute("data-lang")===n)})}function da(){const n=m("voice-mode-toggle"),e=m("voice-mode-row");if(!(!n||!e)){if(!K.isSupported()){e.style.display="none";return}n.checked=K.isActive(),n.addEventListener("change",async()=>{const t=c.getState().currentLang;if(n.checked){if(!navigator.onLine){E(d("voiceOffline",t),"warning"),n.checked=!1;return}K.enable()||(E(d("voiceError",t),"error"),n.checked=!1)}else K.disable()})}}function en(){const n=c.getState().currentLang;document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.getAttribute("data-i18n");t&&(e.textContent=d(t,n))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const t=e.getAttribute("data-i18n-placeholder");t&&(e.placeholder=d(t,n))}),tn(Ht.exists,Ht.entryCount)}function ai(){document.querySelectorAll("[data-advanced]").forEach(t=>{t.style.display=""});const e=document.querySelector('[data-point="S"]');e&&(e.style.display=""),oi()}function oi(){const n=c.getState().settings,e=document.documentElement;n.glassEffects?(e.classList.remove("no-glass-effects"),document.querySelectorAll(".glass-enable-target").forEach(t=>{t.classList.add("glass-enabled")})):(e.classList.add("no-glass-effects"),document.querySelectorAll(".glass-enabled").forEach(t=>{t.classList.remove("glass-enabled")})),e.classList.add("no-motion-effects"),n.outdoorMode?e.classList.add("outdoor-mode"):e.classList.remove("outdoor-mode")}async function ua(n){const e=++Rn,t=await D.checkRaceExists(n);e===Rn&&(c.setRaceExistsInCloud(t.exists),tn(t.exists,t.entryCount))}async function ga(n){const e=c.getState().currentLang;n.innerHTML=`<div class="recent-races-empty">${d("loading",e)}</div>`,n.style.display="block";let t=[];if(ne())try{t=await fa()}catch(i){p.warn("Failed to fetch races from API:",i),t=Xe()}else t=Xe();t.length===0?n.innerHTML=`<div class="recent-races-empty">${d("noRecentRaces",e)}</div>`:(n.innerHTML=zn(t),Gn(n,t,i=>{ha(i,n)}))}async function fa(){const n=localStorage.getItem(Fe);if(!n)return[];const e=await J("/api/v1/admin/races",{headers:{Authorization:`Bearer ${n}`}},5e3);if(!e.ok)throw new Error(`API error: ${e.status}`);const i=(await e.json()).races||[],s=new Date;s.setHours(0,0,0,0);const r=s.getTime(),a=i.filter(o=>o.lastUpdated&&o.lastUpdated>=r).map(o=>({raceId:o.raceId,createdAt:o.lastUpdated||Date.now(),lastUpdated:o.lastUpdated||Date.now(),entryCount:o.entryCount})).slice(0,5);return a.forEach(o=>{zt(o.raceId,o.lastUpdated,o.entryCount)}),a}function ha(n,e){const t=m("race-id-input");t&&(t.value=n.raceId,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),I()),e.style.display="none"}function tn(n,e){Ht={exists:n,entryCount:e};const t=m("race-exists-indicator"),i=m("race-exists-text"),s=c.getState().currentLang;if(!(!t||!i)){if(n===null){t.style.display="none";return}if(t.style.display="inline-flex",t.classList.remove("found","new"),n)if(t.classList.add("found"),e>0){const r=d(e===1?"entryInCloud":"entriesInCloud",s);i.textContent=`${e} ${r}`}else i.textContent=d("raceFound",s);else t.classList.add("new"),i.textContent=d("raceNew",s)}}function ma(){ve&&(clearTimeout(ve),ve=null)}Hs();let re=null;function An(){const n=document.getElementById("app-version");n&&(n.textContent="5.5.4");const e=document.getElementById("version-info-btn");if(e&&e.addEventListener("click",async()=>{const r=c.getState(),a=["Ski Race Timer v5.5.4",`Device: ${r.deviceName||"Unknown"}`,`Role: ${r.deviceRole}`,`Race ID: ${r.raceId||"None"}`,`Entries: ${r.entries.length}`,`Sync: ${r.settings.sync?"On":"Off"}`,`Language: ${r.currentLang.toUpperCase()}`,`User Agent: ${navigator.userAgent}`,`Screen: ${window.screen.width}x${window.screen.height}`,`Viewport: ${window.innerWidth}x${window.innerHeight}`,`Online: ${navigator.onLine}`,`Timestamp: ${new Date().toISOString()}`].join(`
`);try{await navigator.clipboard.writeText(a),E(d("debugInfoCopied",r.currentLang),"success")}catch{E(d("debugInfoCopyFailed",r.currentLang),"warning")}I()}),Qs(),Zs(),Xs(),er(),tr(),nr(),ta({openEditModal:ya,promptDelete:va,openConfirmModal:ci}),na(),ra({showPhotoSyncWarningModal:_r,showRaceChangeDialog:Or}),aa(),Pr(Xt),Br(),pa(),Gr(),js(),c.subscribe(Ca),c.getState().settings.sync&&c.getState().raceId)if(ne())D.initialize();else{c.updateSettings({sync:!1});const r=document.getElementById("sync-toggle");r&&(r.checked=!1),setTimeout(()=>{const a=c.getState().currentLang;E(d("syncRequiresPin",a),"info",5e3)},500)}At(c.getState()),window.addEventListener("race-deleted",Xn),window.addEventListener("auth-expired",ei),window.addEventListener("storage-error",gi),window.addEventListener("storage-warning",fi),document.addEventListener("click",yn,{once:!0}),document.addEventListener("touchstart",yn,{once:!0}),window.addEventListener("beforeunload",Aa),ai(),La();const i=c.getState();i.currentView==="timer"&&et.enable(),i.settings.ambientMode&&(z.initialize(),i.currentView==="timer"&&z.enable()),z.subscribe(r=>{document.body.classList.toggle("ambient-mode",r.isActive),r.triggeredBy?document.body.dataset.ambientTrigger=r.triggeredBy:delete document.body.dataset.ambientTrigger}),ka(),re=new qs,re.setUpdateTranslationsCallback(()=>en()),re.shouldShow()&&re.show();const s=document.getElementById("show-tutorial-btn");s&&s.addEventListener("click",()=>{re&&(re.reset(),re.show(),I())})}function pa(){document.querySelectorAll(".modal-overlay").forEach(g=>{g.addEventListener("click",u=>{u.target===g&&Pe()})}),document.querySelectorAll('[data-action="cancel"]').forEach(g=>{g.addEventListener("click",Pe)});const n=document.getElementById("confirm-delete-btn");n&&n.addEventListener("click",ba);const e=document.getElementById("confirm-fault-delete-btn");e&&e.addEventListener("click",()=>{const g=document.getElementById("fault-delete-modal"),u=g==null?void 0:g.getAttribute("data-fault-id");if(u){c.markFaultForDeletion(u);const f=c.getState().faultEntries.find(y=>y.id===u);f&&Gt(f),Me(),E(d("faultDeleted",c.getState().currentLang),"success")}P(g)});const t=document.getElementById("save-edit-btn");t&&t.addEventListener("click",Sa);const i=document.getElementById("edit-bib-input");i&&rt(i,3);const s=document.getElementById("edit-run-selector");s&&s.addEventListener("click",g=>{const f=g.target.closest(".edit-run-btn");if(!f)return;const y=document.getElementById("edit-modal"),v=f.getAttribute("data-run")||"1";y&&y.setAttribute("data-entry-run",v),document.querySelectorAll(".edit-run-btn").forEach(S=>{S.classList.toggle("active",S===f)})});const r=document.getElementById("photo-viewer-close-btn");r&&r.addEventListener("click",Je);const a=document.getElementById("photo-viewer-close-footer-btn");a&&a.addEventListener("click",Je);const o=document.getElementById("photo-viewer-delete-btn");o&&o.addEventListener("click",lr);const l=document.getElementById("photo-viewer-modal");l&&l.addEventListener("click",g=>{g.target===l&&Je()}),Ir()}function ya(n){const e=document.getElementById("edit-modal");if(!e)return;e.setAttribute("data-entry-id",n.id);const t=document.getElementById("edit-bib-input"),i=document.getElementById("edit-status-select");t&&(t.value=n.bib||""),i&&(i.value=n.status);const s=n.run??1;document.querySelectorAll(".edit-run-btn").forEach(r=>{const a=r.getAttribute("data-run")===String(s);r.classList.toggle("active",a)}),e.setAttribute("data-entry-run",String(s)),B(e)}function ci(n){const e=document.getElementById("confirm-modal");if(!e)return;const t=c.getState().currentLang,i=e.querySelector(".modal-title"),s=e.querySelector(".modal-text");if(e.setAttribute("data-action",n),n==="clearAll")i&&(i.textContent=d("confirmClearAll",t)),s&&(s.textContent=d("clearAllText",t));else if(n==="deleteSelected"){const r=c.getState().selectedEntries.size,a=d(r===1?"entry":"entries",t);i&&(i.textContent=d("confirmDelete",t)),s&&(s.textContent=`${r} ${a} ${d("selected",t)}`)}else n==="undoAdd"?(i&&(i.textContent=d("confirmUndoAdd",t)),s&&(s.textContent=d("confirmUndoAddText",t))):(i&&(i.textContent=d("confirmDelete",t)),s&&(s.textContent=d("confirmDeleteText",t)));B(e)}function va(n){const e=document.getElementById("confirm-modal");e&&e.setAttribute("data-entry-id",n.id),ci("delete")}async function ba(){const n=document.getElementById("confirm-modal");if(!n)return;const e=n.getAttribute("data-action"),t=n.getAttribute("data-entry-id"),i=c.getState();if(e==="clearAll"){const s=[...i.entries];if(c.clearAll(),await V.clearAll(),i.settings.sync&&i.raceId)for(const r of s)D.deleteEntryFromCloud(r.id,r.deviceId);E(d("cleared",i.currentLang),"success")}else if(e==="deleteSelected"){const s=Array.from(i.selectedEntries),r=i.entries.filter(a=>s.includes(a.id));if(c.deleteMultiple(s),await V.deletePhotos(s),i.settings.sync&&i.raceId)for(const a of r)D.deleteEntryFromCloud(a.id,a.deviceId);E(d("deleted",i.currentLang),"success")}else if(e==="undoAdd"){const s=c.undo();if(Hn(),E(d("undone",i.currentLang),"success"),s&&s.type==="ADD_ENTRY"){const r=s.data;await V.deletePhoto(r.id),i.settings.sync&&i.raceId&&D.deleteEntryFromCloud(r.id,r.deviceId)}Pe();return}else if(t){const s=i.entries.find(r=>r.id===t);c.deleteEntry(t),await V.deletePhoto(t),i.settings.sync&&i.raceId&&s&&D.deleteEntryFromCloud(s.id,s.deviceId),E(d("deleted",i.currentLang),"success")}ct(),Pe()}function Sa(){const n=document.getElementById("edit-modal");if(!n)return;const e=n.getAttribute("data-entry-id");if(!e)return;const t=document.getElementById("edit-bib-input"),i=document.getElementById("edit-status-select"),s=n.getAttribute("data-entry-run"),r=s?parseInt(s,10):1;c.updateEntry(e,{bib:(t==null?void 0:t.value.padStart(3,"0"))||"",status:i==null?void 0:i.value,run:r}),E(d("saved",c.getState().currentLang),"success"),Pe()}function Pe(){const n=document.getElementById("admin-pin-modal");if(n!=null&&n.classList.contains("show")&&ea()){ti();const e=document.getElementById("admin-pin-verify-input");e&&(e.value="")}Js()}const Ea={bibInput:[()=>Jt()],selectedPoint:[()=>_t()],selectedRun:[n=>{qt(),Kt(),n.currentView==="gateJudge"&&te()}],entries:[n=>{const e=ii();e&&e.setEntries(n.entries),gt(),si(),n.currentView==="gateJudge"&&te()}],deviceRole:[()=>{Xt(),Qt(),ye()}],isJudgeReady:[()=>ye()],gateAssignment:[()=>ut()],faultEntries:[n=>{n.currentView==="gateJudge"&&te()}],syncStatus:[()=>Be()],cloudDeviceCount:[()=>Be()],gpsStatus:[()=>{ft(),ye()}],undoStack:[()=>ui()]};function wa(n){li(),ft(),Be(),n.currentView==="timer"?et.enable():et.disable(),n.currentView==="timer"&&n.settings.ambientMode?z.enable():z.disable();const e=ii();e&&(n.currentView==="results"?e.resume():e.pause())}function Ia(){Be(),ft(),ye(),di(),oi();const n=c.getState();n.settings.ambientMode?(z.initialize(),n.currentView==="timer"&&z.enable()):z.disable()}function Ca(n,e){e.includes("currentView")&&wa(n),e.includes("settings")&&(Ia(),At(n)),e.includes("currentView")&&!e.includes("settings")&&At(n);for(const t of e){const i=Ea[t];if(i)for(const s of i)s(n)}}function La(){li(),Jt(),_t(),qt(),gt(),si(),Be(),ft(),ye(),di(),ui(),la(),en()}function Ta(n){return n.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}function li(){const n=c.getState();document.querySelectorAll(".view").forEach(i=>{i.classList.remove("active")});const e=Ta(n.currentView),t=document.querySelector(`.${e}-view`);t&&t.classList.add("active"),document.querySelectorAll(".tab-btn").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")===n.currentView)}),n.currentView==="gateJudge"&&(te(),ut(),Kt(),st())}function Be(){var r,a;const n=c.getState(),e=m("sync-indicator"),t=(r=m("sync-indicator"))==null?void 0:r.querySelector(".sync-dot"),i=(a=m("sync-indicator"))==null?void 0:a.querySelector(".sync-status-text"),s=m("sync-device-count");e&&(e.style.display=n.settings.sync?"flex":"none"),t&&(t.classList.remove("connected","error","offline","syncing"),n.syncStatus==="connected"?t.classList.add("connected"):n.syncStatus==="syncing"?t.classList.add("syncing"):n.syncStatus==="error"?t.classList.add("error"):n.syncStatus==="offline"&&t.classList.add("offline")),i&&(i.textContent=d(n.syncStatus,n.currentLang)),s&&(n.syncStatus==="connected"&&n.cloudDeviceCount>0?(s.textContent=`(${n.cloudDeviceCount})`,s.style.display="inline"):s.style.display="none")}function ft(){const n=c.getState(),e=m("gps-indicator"),t=e==null?void 0:e.querySelector(".gps-dot"),i=e==null?void 0:e.querySelector(".gps-status-text");e&&(e.style.display=n.settings.gps?"flex":"none"),t&&(t.classList.remove("active","searching","paused"),n.gpsStatus==="active"?t.classList.add("active"):n.gpsStatus==="searching"?t.classList.add("searching"):n.gpsStatus==="paused"&&t.classList.add("paused")),i&&(i.textContent="GPS")}function di(){const n=c.getState(),e=m("camera-indicator");e&&(e.style.display=n.settings.photoCapture?"flex":"none")}function ka(){if(!K.isSupported()){p.debug("[VoiceMode] Not supported in this browser");return}const n="/api/v1/voice",e=window.VOICE_LLM_CONFIG,t={endpoint:(e==null?void 0:e.endpoint)||n,apiKey:(e==null?void 0:e.apiKey)||"proxy"};if(!K.initialize(t)){p.warn("[VoiceMode] Failed to initialize");return}K.onStatusChange(s=>{Ra(s)}),K.onAction(s=>{c.getState().deviceRole==="gateJudge"?Hr(s):or(s)}),p.debug("[VoiceMode] Initialized successfully")}function Ra(n){const e=m("voice-indicator"),t=m("voice-status-text");if(e){if(n==="inactive"){e.style.display="none";return}if(e.style.display="flex",e.classList.remove("listening","processing","confirming","offline","error"),e.classList.add(n),t){const i=c.getState().currentLang;switch(n){case"listening":t.textContent=d("voiceListening",i);break;case"processing":t.textContent=d("voiceProcessing",i);break;case"confirming":t.textContent=d("voiceConfirming",i);break;case"offline":t.textContent=d("voiceOffline",i);break;case"error":t.textContent=d("voiceError",i);break}}}}function ui(){const n=m("undo-btn");n&&n.toggleAttribute("disabled",!c.canUndo())}function gi(n){const{isQuotaError:e,entryCount:t}=n.detail,i=c.getState().currentLang;e?E(d("storageQuotaError",i),"error",Ae.CRITICAL):E(d("storageError",i),"error",Ae.ERROR),F(),p.error("[Storage] saveEntries:",n.detail.message,{entryCount:t,isQuotaError:e})}function fi(n){const{percent:e}=n.detail,t=c.getState().currentLang;sessionStorage.getItem("storage-warning-shown")||(E(`${d("storageWarning",t)} (${e}%)`,"warning",Ae.WARNING),sessionStorage.setItem("storage-warning-shown","true"))}function Aa(){try{Ks()}catch(n){p.warn("Clock cleanup error:",n)}D.cleanup(),fe.stop(),he.stop(),et.disable(),z.cleanup(),K.cleanup(),xs(),Ws(),document.querySelectorAll(".ripple").forEach(n=>n.remove()),window.removeEventListener("race-deleted",Xn),window.removeEventListener("auth-expired",ei),window.removeEventListener("storage-error",gi),window.removeEventListener("storage-warning",fi),sa(),ma(),ti()}let kt=!1,ke=[];const xa=3,Da=1e4;function Pa(){window.addEventListener("error",Ba),window.addEventListener("unhandledrejection",Fa),window.addEventListener("critical-error",Na)}function Ba(n){const{message:e,filename:t,lineno:i,colno:s,error:r}=n;at("Global","uncaught error",r||e,void 0),hi(e),mi()&&nn(e),n.preventDefault()}function Fa(n){const e=n.reason,t=e instanceof Error?e.message:String(e);at("Global","unhandled rejection",e,void 0),hi(t),mi()&&nn(t),n.preventDefault()}function Na(n){var i;const e=n.detail,t=((i=e==null?void 0:e.error)==null?void 0:i.message)||"Critical error occurred";Hi("Global","critical error event",e==null?void 0:e.error,void 0),nn(t)}function hi(n){const e=Date.now();ke.push({message:n,timestamp:e}),ke=ke.filter(t=>e-t.timestamp<Da)}function mi(){return ke.length>=xa}function nn(n){var s,r;if(kt)return;kt=!0;const e=c.getState().currentLang,t=document.createElement("div");t.id="error-boundary-overlay",t.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 24px;
  `;const i=document.createElement("div");i.style.cssText=`
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    text-align: center;
    color: #fff;
  `,i.innerHTML=`
    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
    <h2 style="margin: 0 0 8px; font-size: 1.25rem;">${d("errorOccurred",e)}</h2>
    <p style="color: #999; font-size: 0.875rem; margin: 0 0 16px;">
      ${d("errorRecoveryMessage",e)}
    </p>
    <p style="color: #666; font-size: 0.75rem; font-family: monospace; margin: 0 0 24px; word-break: break-word;">
      ${$a(n.substring(0,200))}
    </p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="error-dismiss-btn" style="
        padding: 12px 24px;
        border: 1px solid #444;
        border-radius: 8px;
        background: transparent;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${d("dismiss",e)}</button>
      <button id="error-reload-btn" style="
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #3B82F6;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${d("reload",e)}</button>
    </div>
  `,t.appendChild(i),document.body.appendChild(t),(s=document.getElementById("error-dismiss-btn"))==null||s.addEventListener("click",()=>{t.remove(),kt=!1,ke=[]}),(r=document.getElementById("error-reload-btn"))==null||r.addEventListener("click",()=>{window.location.reload()})}function $a(n){const e=document.createElement("div");return e.textContent=n,e.innerHTML}Pa();Vn();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",An):An();"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const n=await navigator.serviceWorker.register("/sw.js");setInterval(()=>{document.hidden||n.update()},6e4),n.addEventListener("updatefound",()=>{const e=n.installing;e&&e.addEventListener("statechange",()=>{e.state==="installed"&&navigator.serviceWorker.controller&&Ma()})})}catch(n){p.error("Service Worker registration failed:",n)}});function Ma(){const n=c.getState().currentLang;E(d("updateAvailable",n),"info",1e4)}document.addEventListener("visibilitychange",()=>{});window.addEventListener("beforeunload",()=>{});
