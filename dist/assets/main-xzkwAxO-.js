const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/gate-judge-BcJMKlnh.js","assets/chief-judge-riJEdY3M.js","assets/vendor-signals-BA-R9xnX.js"])))=>i.map(i=>d[i]);
var vt=Object.defineProperty;var St=(t,e,n)=>e in t?vt(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var A=(t,e,n)=>St(t,typeof e!="symbol"?e+"":e,n);import{s as ce,o as j,g as K,d as Pe,c as ne,i as Et,e as wt,f as It,h as z,j as Z,k as Me,l as Ne,r as Lt,m as Ct,a as kt,b as At,n as Rt,p as xt,u as Bt,q as Tt,_ as ve}from"./gate-judge-BcJMKlnh.js";import{af as M,an as ae,u as v,s as r,X as Ve,q as V,a as h,t as c,L as T,ao as Se,ap as se,N,aq as Oe,R as U,n as $t,m as Dt,W as Ee,ar as qt,T as Pt,ae as Fe,d as f,p as b,ac as Mt,ad as Nt,_ as we,h as me,f as Ue,E as Je,D as ze,z as He,y as Ge,l as _e,a6 as q,o as H,as as Vt,at as Ot,au as ie,av as Ie,aw as Ft,ak as Ut,al as Jt,ax as $,$ as zt,ay as We,az as Ht,aA as Gt,P as _t,ai as Wt,aj as jt,am as Kt,aB as Xt,ah as Le,aC as Yt,ag as Ce,aD as Zt,aE as Qt,aF as en,aG as tn,aH as nn,a5 as ke,a1 as an,a8 as sn,aI as on,e as G,r as rn,a0 as cn,a2 as je,aJ as ln,aK as dn,aL as un,w as Ae}from"./chief-judge-riJEdY3M.js";import{h as Ke,a as Xe,b as gn,c as fn,d as Ye,u as mn,e as Ze,f as pn,s as hn,r as Re,g as yn,i as xe,j as Qe,v as bn,k as vn,l as Sn,m as En,n as Be,o as wn,p as In}from"./settings-DouXa31l.js";import{m as y,o as Te}from"./vendor-signals-BA-R9xnX.js";import{c as de,d as Ln,u as et,a as tt,b as Cn,g as kn,i as An}from"./results-CgMF_Mmw.js";import{c as Rn,i as xn,a as oe,u as nt,d as Bn,b as Tn}from"./timer-DIxjZgeJ.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function n(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=n(a);fetch(a.href,i)}})();function at(t){t.currentView==="timer"&&t.settings.gps?M.start():t.settings.gps?M.pause():M.stop()}function st(t){t.currentView==="timer"&&t.settings.photoCapture?ae.initialize().catch(n=>{v.error("[Camera] Failed to initialize from view service:",n)}):ae.stop()}function $n(t){at(t),st(t)}const Y=new T;let P=null;function Dn(){if(r.getState().settings.sync&&r.getState().raceId)if(Ve())V.initialize();else{r.updateSettings({sync:!1});const s=document.getElementById("sync-toggle");s&&(s.checked=!1),setTimeout(()=>{const a=r.getState().currentLang;h(c("syncRequiresPin",a),"info",5e3)},500)}$n(r.getState()),Y.add(window,"race-deleted",Ke),Y.add(window,"auth-expired",Xe),Y.add(window,"storage-error",gt),Y.add(window,"storage-warning",ft),document.addEventListener("click",Se,{once:!0}),document.addEventListener("touchstart",Se,{once:!0}),gn();const e=r.getState();e.currentView==="timer"&&se.enable(),N.subscribe(s=>{document.body.classList.toggle("ambient-mode",s.isActive),s.triggeredBy?document.body.dataset.ambientTrigger=s.triggeredBy:delete document.body.dataset.ambientTrigger;const a=r.getState();a.settings.gps&&(s.isActive?M.pause():a.currentView==="timer"&&M.start())}),P&&P();let n=e.settings.photoCapture;P=y(()=>{const s=Oe.value;n&&!s&&queueMicrotask(()=>ae.stop()),n=s}),ra()}function qn(){P==null||P(),P=null}async function $e(t){const e=t.map(s=>s.id);e.length===1?r.deleteEntry(e[0]):r.deleteMultiple(e),e.length===1?await U.deletePhoto(e[0]):await U.deletePhotos(e);const n=r.getState();if(n.settings.sync&&n.raceId)for(const s of t)V.deleteEntryFromCloud(s.id,s.deviceId).catch(()=>{})}function Pn(t,e){t&&(ce(t,e),j(t))}function Mn(t,e,n,s){t&&t.querySelectorAll(e).forEach(a=>{const i=a.getAttribute(n)===s;a.classList.toggle("active",i),a.getAttribute("role")==="radio"&&a.setAttribute("aria-checked",String(i))})}const k=new T;function Nn(){document.querySelectorAll(".modal-overlay").forEach(u=>{k.add(u,"click",m=>{m.target===u&&X()})}),document.querySelectorAll('[data-action="cancel"]').forEach(u=>{k.add(u,"click",X)});const t=document.getElementById("confirm-delete-btn");t&&k.add(t,"click",Fn);const e=document.getElementById("confirm-fault-delete-btn");e&&k.add(e,"click",()=>{var p;const u=document.getElementById("fault-delete-modal"),m=u?(p=K(u))==null?void 0:p.faultId:void 0;if(m){r.markFaultForDeletion(m);const S=r.getState().faultEntries.find(C=>C.id===m);S&&$t(S).catch(()=>{}),Pe(),h(c("faultDeleted",r.getState().currentLang),"success")}ne(u)});const n=document.getElementById("save-edit-btn");n&&k.add(n,"click",Un);const s=document.getElementById("edit-bib-input");s&&Dt(s,3);const a=document.getElementById("edit-run-selector");a&&k.add(a,"click",u=>{const p=u.target.closest(".edit-run-btn");if(!p)return;const S=document.getElementById("edit-modal"),C=p.getAttribute("data-run")||"1";if(S){const I=K(S)||{entryId:"",entryRun:1};ce(S,{...I,entryRun:parseInt(C,10)})}document.querySelectorAll(".edit-run-btn").forEach(I=>{I.classList.toggle("active",I===p)})});const i=document.getElementById("photo-viewer-close-btn");i&&k.add(i,"click",de);const o=document.getElementById("photo-viewer-close-footer-btn");o&&k.add(o,"click",de);const l=document.getElementById("photo-viewer-delete-btn");l&&k.add(l,"click",Ln);const d=document.getElementById("photo-viewer-modal");d&&k.add(d,"click",u=>{u.target===d&&de()}),Et()}function Vn(t){const e=document.getElementById("edit-modal");if(!e)return;const n=t.run??1,s=document.getElementById("edit-bib-input"),a=document.getElementById("edit-status-select");s&&(s.value=t.bib||""),a&&(a.value=t.status),Mn(document.body,".edit-run-btn","data-run",String(n)),Pn(e,{entryId:t.id,entryRun:n})}function it(t){const e=document.getElementById("confirm-modal");if(!e)return;const n=r.getState().currentLang,s=e.querySelector(".modal-title"),a=e.querySelector(".modal-text"),i=K(e)||{};if(ce(e,{...i,action:t}),t==="clearAll")s&&(s.textContent=c("confirmClearAll",n)),a&&(a.textContent=c("clearAllText",n));else if(t==="deleteSelected"){const o=r.getState().selectedEntries.size,l=o===1?c("entry",n):c("entries",n);s&&(s.textContent=c("confirmDelete",n)),a&&(a.textContent=`${o} ${l} ${c("selected",n)}`)}else t==="undoAdd"?(s&&(s.textContent=c("confirmUndoAdd",n)),a&&(a.textContent=c("confirmUndoAddText",n))):(s&&(s.textContent=c("confirmDelete",n)),a&&(a.textContent=c("confirmDeleteText",n)));j(e)}function On(t){const e=document.getElementById("confirm-modal");e&&ce(e,{action:"delete",entryId:t.id}),it("delete")}async function Fn(){const t=document.getElementById("confirm-modal");if(!t)return;const e=K(t),n=e==null?void 0:e.action,s=e==null?void 0:e.entryId,a=r.getState();if(n==="clearAll"){const i=[...a.entries];r.clearAll(),await U.clearAll();const o=r.getState();if(o.settings.sync&&o.raceId)for(const l of i)V.deleteEntryFromCloud(l.id,l.deviceId).catch(()=>{});h(c("cleared",o.currentLang),"success")}else if(n==="deleteSelected"){const i=Array.from(a.selectedEntries),o=a.entries.filter(l=>i.includes(l.id));await $e(o),h(c("deleted",r.getState().currentLang),"success")}else if(n==="undoAdd"){const i=r.undo();if(Ee(),h(c("undone",a.currentLang),"success"),i&&i.type==="ADD_ENTRY"){const o=i.data;await U.deletePhoto(o.id);const l=r.getState();l.settings.sync&&l.raceId&&V.deleteEntryFromCloud(o.id,o.deviceId).catch(()=>{})}X();return}else if(s){const i=a.entries.find(d=>d.id===s);i&&await $e([i]);const o=a.currentLang;qt();const l={label:c("undoAction",o),callback:()=>{if(r.canUndo()){const d=r.undo();if(Ee(),d&&d.type==="DELETE_ENTRY"){const u=d.data;Fe(u).catch(()=>{})}}}};h(c("entryDeleted",o),"success",5e3,{action:l})}Pt(),X()}function Un(){const t=document.getElementById("edit-modal");if(!t)return;const e=K(t),n=e==null?void 0:e.entryId;if(!n)return;const s=document.getElementById("edit-bib-input"),a=document.getElementById("edit-status-select"),i=(e==null?void 0:e.entryRun)??1;r.updateEntry(n,{bib:(s==null?void 0:s.value.padStart(3,"0"))||"",status:a==null?void 0:a.value,run:i}),h(c("saved",r.getState().currentLang),"success"),X()}function X(){const t=document.getElementById("admin-pin-modal");if(t!=null&&t.classList.contains("show")&&fn()){Ye();const e=document.getElementById("admin-pin-verify-input");e&&(e.value="")}document.querySelectorAll(".modal-overlay").forEach(e=>{wt(e)}),It()}const B=new T;let x=null;const _=new Set;let F=null;function Jn(t){return t?/^0+$/.test(t):!1}function zn(){x&&(x.destroy(),x=null);const t=b("clock-container");t&&(x=new Mt(t),x.start())}function Hn(){x&&(x.destroy(),x=null)}function Gn(){const t=document.querySelectorAll(".tab-btn"),e=()=>Array.from(t).filter(n=>n.style.display!=="none");t.forEach(n=>{B.add(n,"click",()=>{const s=n.getAttribute("data-view");s&&(r.setView(s),f(),t.forEach(a=>{a.setAttribute("aria-selected",a===n?"true":"false")}))}),B.add(n,"keydown",s=>{const a=s,i=e(),o=i.indexOf(n);let l=o;switch(a.key){case"ArrowLeft":case"ArrowUp":a.preventDefault(),l=o>0?o-1:i.length-1;break;case"ArrowRight":case"ArrowDown":a.preventDefault(),l=o<i.length-1?o+1:0;break;case"Home":a.preventDefault(),l=0;break;case"End":a.preventDefault(),l=i.length-1;break;default:return}if(l!==o){const d=i[l];d.focus(),d.click()}})})}function _n(){const t=b("number-pad"),e=b("bib-display");e&&t&&(e.setAttribute("aria-expanded","true"),B.add(e,"click",()=>{const n=t.classList.toggle("collapsed");e.classList.toggle("expanded",!n),e.setAttribute("aria-expanded",String(!n)),f()})),t&&B.add(t,"click",n=>{const a=n.target.closest(".num-btn");if(!a)return;const i=a.getAttribute("data-num"),o=a.getAttribute("data-action");if(i){const l=r.getState();l.bibInput.length<3&&(r.setBibInput(l.bibInput+i),f())}else if(o==="clear")r.setBibInput(""),f();else if(o==="delete"){const l=r.getState();r.setBibInput(l.bibInput.slice(0,-1)),f()}})}function Wn(){const t=b("timing-points");t&&B.add(t,"click",e=>{const s=e.target.closest(".timing-point-btn");if(!s)return;const a=s.getAttribute("data-point");a&&(r.setSelectedPoint(a),f(),t.querySelectorAll(".timing-point-btn").forEach(i=>{i.setAttribute("aria-checked",i===s?"true":"false")}))})}function jn(){const t=b("run-selector");t&&B.add(t,"click",e=>{const s=e.target.closest(".run-btn");if(!s)return;const a=s.getAttribute("data-run"),i=a?parseInt(a,10):1;r.setSelectedRun(i),f(),t.querySelectorAll(".run-btn").forEach(o=>{o.setAttribute("aria-checked",o===s?"true":"false")})})}function Kn(){const t=b("timestamp-btn");t&&(B.add(t,"click",async()=>{if(N.wasRecentlyExited()){f();return}await De()}),B.add(document,"keydown",(e=>{var a;const n=(a=document.activeElement)==null?void 0:a.tagName,s=r.getState();if(!(n==="INPUT"||n==="TEXTAREA"||n==="SELECT")&&s.currentView==="timer"){if(/^[0-9]$/.test(e.key)){e.preventDefault(),s.bibInput.length<3&&(r.setBibInput(s.bibInput+e.key),f());return}if(e.key==="Backspace"){e.preventDefault(),r.setBibInput(s.bibInput.slice(0,-1)),f();return}if(e.key==="Delete"||e.key==="Escape"){e.preventDefault(),r.setBibInput(""),f();return}if(e.key==="s"||e.key==="S"){e.preventDefault(),r.setSelectedPoint("S"),f(),document.querySelectorAll(".timing-point-btn").forEach(i=>{i.setAttribute("aria-checked",i.getAttribute("data-point")==="S"?"true":"false")});return}if(e.key==="f"||e.key==="F"){e.preventDefault(),r.setSelectedPoint("F"),f(),document.querySelectorAll(".timing-point-btn").forEach(i=>{i.setAttribute("aria-checked",i.getAttribute("data-point")==="F"?"true":"false")});return}if(e.key==="1"&&e.altKey){e.preventDefault(),r.setSelectedRun(1),f();return}if(e.key==="2"&&e.altKey){e.preventDefault(),r.setSelectedRun(2),f();return}if(e.key===" "||e.key==="Enter"){if(e.preventDefault(),N.wasRecentlyExited()){f();return}De();return}}})))}async function De(){const t=r.getState();if(t.isRecording)return;const{entry:e}=Rn({bib:t.bibInput,point:t.selectedPoint,run:t.selectedRun,deviceId:t.deviceId,deviceName:t.deviceName,gpsService:M});r.setRecording(!0);try{if(t.settings.photoCapture){const a=e.id;Nt().then(async i=>{if(i)try{if(!r.getState().entries.some(u=>u.id===a)){v.warn("Entry was deleted before photo could be attached:",a);return}if(await U.savePhoto(a,i))r.updateEntry(a,{photo:"indexeddb"})||(v.warn("Entry deleted during photo save, removing orphaned photo:",a),await U.deletePhoto(a));else{v.warn("Photo save failed for entry:",a);const u=r.getState().currentLang;h(c("photoSaveFailed",u),"warning")}}catch(o){we("Camera","photo save/update",o,"photoError")}}).catch(i=>{if(i instanceof Error&&i.name==="PhotoTooLargeError"){const o=r.getState().currentLang;h(c("photoTooLarge",o),"warning")}else we("Camera","captureTimingPhoto",i,"photoError")})}const n=xn(e,t.entries),s=Jn(e.bib);if(r.addEntry(e),n?(me(),Yn(e)):s?(me(),Zn(e)):(Ue(),ot(e)),Fe(e).catch(a=>{v.error("syncEntry failed:",a)}),t.settings.auto&&t.bibInput){const a=parseInt(t.bibInput,10)+1,i=Math.min(t.settings.sync&&t.cloudHighestBib>0?Math.max(a,t.cloudHighestBib+1):a,999);r.setBibInput(String(i))}else t.bibInput?t.settings.auto||r.setBibInput(""):r.setBibInput("");Qn(e)}finally{r.setRecording(!1)}}function ot(t){const e=b("confirmation-overlay");if(!e)return;const n=e.querySelector(".confirmation-bib"),s=e.querySelector(".confirmation-point"),a=e.querySelector(".confirmation-run"),i=e.querySelector(".confirmation-time"),o=r.getState();if(n&&(n.textContent=t.bib||"---"),s&&(s.textContent=Je(t.point,o.currentLang),s.style.color=ze(t.point)),a&&t.run&&(a.textContent=He(t.run,o.currentLang),a.style.color=Ge(t.run)),i){const d=new Date(t.timestamp);i.textContent=_e(d)}e.dataset.point=t.point,e.classList.add("show"),e.setAttribute("aria-hidden","false"),Xn(t.point);const l=window.setTimeout(()=>{e.classList.remove("show"),e.setAttribute("aria-hidden","true"),_.delete(l)},1500);_.add(l)}function Xn(t){const e=document.getElementById("snowflake-burst");if(!e)return;e.innerHTML="";const n=t==="S"?"var(--start-color)":"var(--finish-color)",s=8;for(let a=0;a<s;a++){const i=document.createElement("span");i.className="flake",i.textContent="❄";const o=a/s*2*Math.PI,l=60+Math.random()*40,d=Math.cos(o)*l,u=Math.sin(o)*l,m=Math.random()*360;i.style.cssText=`
      --burst-x: ${d}px;
      --burst-y: ${u}px;
      --burst-rot: ${m}deg;
      color: ${n};
      font-size: ${.6+Math.random()*.6}rem;
      animation-duration: ${.6+Math.random()*.4}s;
      text-shadow: 0 0 6px ${n};
    `,i.addEventListener("animationend",()=>i.remove(),{once:!0}),e.appendChild(i)}}function Yn(t){rt(".confirmation-duplicate",t)}function Zn(t){rt(".confirmation-zero-bib",t)}function rt(t,e){const n=b("confirmation-overlay");if(!n)return;F!==null&&(clearTimeout(F),_.delete(F),F=null);for(const i of[".confirmation-duplicate",".confirmation-zero-bib"]){const o=n.querySelector(i);o&&(o.style.display="none")}const s=n.querySelector(t);s&&(s.style.display="flex"),ot(e);const a=window.setTimeout(()=>{s&&(s.style.display="none"),_.delete(a),F=null},2500);F=a,_.add(a)}function Qn(t){const e=b("last-recorded-inline");if(!e)return;const n=e.querySelector(".bib"),s=e.querySelector(".point"),a=e.querySelector(".run"),i=e.querySelector(".time"),o=r.getState();if(n&&(n.textContent=t.bib||"---"),s&&(s.textContent=Je(t.point,o.currentLang),s.style.color=ze(t.point)),a&&t.run&&(a.textContent=He(t.run,o.currentLang),a.style.color=Ge(t.run)),i){const l=new Date(t.timestamp);i.textContent=_e(l)}e.classList.add("visible"),e.classList.remove("pulse"),e.offsetWidth,e.classList.add("pulse")}function pe(){const t=r.getState(),e=b("bib-display"),n=e==null?void 0:e.querySelector(".bib-value");n&&(n.textContent=t.bibInput?t.bibInput.padStart(3,"0"):"---");const s=b("timestamp-btn");s&&s.classList.toggle("ready",t.bibInput.length>0)}function he(){const t=r.getState();document.querySelectorAll(".timing-point-btn").forEach(e=>{const n=e.getAttribute("data-point")===t.selectedPoint;e.classList.toggle("active",n),e.setAttribute("aria-checked",String(n))})}function ye(){const t=r.getState();document.querySelectorAll(".run-btn").forEach(e=>{const n=e.getAttribute("data-run")===String(t.selectedRun);e.classList.toggle("active",n),e.setAttribute("aria-checked",String(n))})}function ea(t){var e,n,s;switch(v.debug("[TimerView] Voice intent:",t.action,t.params),t.action){case"set_bib":(e=t.params)!=null&&e.bib&&(r.setBibInput(t.params.bib),pe(),f());break;case"set_point":(n=t.params)!=null&&n.point&&(r.setSelectedPoint(t.params.point),he(),f());break;case"set_run":(s=t.params)!=null&&s.run&&(r.setSelectedRun(t.params.run),ye(),f());break;default:v.debug("[TimerView] Unhandled voice intent:",t.action)}}function ta(){ct(),oe()?nt():(pe(),he()),ye(),et(),tt(),Q(),ee(),z(),lt(),dt(),mn(),Ze()}function na(t){return t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}function ct(){const t=r.getState();document.querySelectorAll(".view").forEach(s=>{s.classList.remove("active")});const e=na(t.currentView),n=document.querySelector(`.${e}-view`);n&&n.classList.add("active"),document.querySelectorAll(".tab-btn").forEach(s=>{s.classList.toggle("active",s.getAttribute("data-view")===t.currentView)}),t.currentView==="gateJudge"&&(Z(),Me(),Ne(),Lt())}function Q(){var o,l;const t=r.getState(),e=b("sync-indicator"),n=(o=b("sync-indicator"))==null?void 0:o.querySelector(".sync-dot"),s=(l=b("sync-indicator"))==null?void 0:l.querySelector(".sync-status-text"),a=b("sync-device-count");e&&(e.style.display=t.settings.sync?"flex":"none");const i=t.currentLang;if(n){n.classList.remove("connected","error","offline","syncing"),e&&e.classList.remove("connected","error","offline","syncing"),t.syncStatus==="connected"?(n.classList.add("connected"),e==null||e.classList.add("connected")):t.syncStatus==="syncing"?(n.classList.add("syncing"),e==null||e.classList.add("syncing")):t.syncStatus==="error"?(n.classList.add("error"),e==null||e.classList.add("error")):t.syncStatus==="offline"&&(n.classList.add("offline"),e==null||e.classList.add("offline"));const d=t.syncStatus==="connected"?c("syncOnline",i):t.syncStatus==="error"?c("syncError",i):t.syncStatus==="offline"?c("syncOffline",i):c("syncing",i);n.setAttribute("aria-label",d)}if(s){const d={connected:c("syncShortConnected",i),syncing:c("syncShortSyncing",i),error:c("syncShortError",i),offline:c("syncShortOff",i),disconnected:c("syncShortOff",i),connecting:c("syncShortSyncing",i)};s.textContent=d[t.syncStatus]||c(t.syncStatus,i)}if(e){const d=t.syncStatus==="connected"?`${c("syncOnline",i)}${t.cloudDeviceCount>0?` - ${t.cloudDeviceCount} ${c("devices",i)}`:""}`:t.syncStatus==="error"?c("syncError",i):t.syncStatus==="offline"?c("syncOffline",i):c("syncing",i);e.setAttribute("aria-label",d)}a&&(t.syncStatus==="connected"&&t.cloudDeviceCount>0?(a.textContent=`${t.cloudDeviceCount} ${c("syncDeviceAbbrev",i)}`,a.style.display="inline",a.classList.add("status-active")):t.syncStatus==="error"||t.syncStatus==="offline"?(a.textContent=c("syncShortOff",i),a.style.display="inline",a.classList.remove("status-active")):a.style.display="none")}function ee(){const t=r.getState(),e=b("gps-indicator"),n=e==null?void 0:e.querySelector(".gps-dot"),s=e==null?void 0:e.querySelector(".gps-status-text");if(e&&(e.style.display=t.settings.gps?"flex":"none"),n){n.classList.remove("active","searching","paused"),e&&e.classList.remove("active","searching","inactive"),t.gpsStatus==="active"?(n.classList.add("active"),e==null||e.classList.add("active")):t.gpsStatus==="searching"?(n.classList.add("searching"),e==null||e.classList.add("searching")):t.gpsStatus==="paused"?n.classList.add("paused"):e==null||e.classList.add("inactive");const a=t.currentLang,i=t.gpsStatus==="active"||t.gpsStatus==="paused"?"gpsActive":t.gpsStatus==="searching"?"gpsSearching":"gpsInactive";n.setAttribute("aria-label",c(i,a))}if(s&&(t.gpsStatus==="active"||t.gpsStatus==="paused"?(s.textContent="GPS",s.classList.add("status-active"),s.classList.remove("status-inactive","status-searching")):t.gpsStatus==="searching"?(s.textContent="GPS...",s.classList.add("status-searching"),s.classList.remove("status-active","status-inactive")):(s.textContent="GPS Off",s.classList.add("status-inactive"),s.classList.remove("status-active","status-searching"))),e){const a=t.currentLang,i=t.gpsStatus==="active"||t.gpsStatus==="paused"?"gpsActive":t.gpsStatus==="searching"?"gpsSearching":"gpsInactive";e.setAttribute("aria-label",c(i,a))}}function lt(){const t=r.getState(),e=b("camera-indicator");if(e){const n=t.settings.photoCapture;e.style.display=n?"flex":"none",n&&e.setAttribute("aria-label",c("photoCapture",t.currentLang))}}function aa(t){const e=b("voice-indicator"),n=b("voice-status-text");if(e){if(t==="inactive"){e.style.display="none";return}if(e.style.display="flex",e.classList.remove("listening","processing","confirming","offline","error"),e.classList.add(t),n){const s=r.getState().currentLang;switch(t){case"listening":n.textContent=c("voiceListening",s);break;case"processing":n.textContent=c("voiceProcessing",s);break;case"confirming":n.textContent=c("voiceConfirming",s);break;case"offline":n.textContent=c("voiceOffline",s);break;case"error":n.textContent=c("voiceError",s);break}}}}function dt(){const t=b("undo-btn");t&&t.toggleAttribute("disabled",!r.canUndo())}const w=new T,re=new Set;function L(t,e,n){const s=e.getBoundingClientRect();let a,i;typeof TouchEvent<"u"&&t instanceof TouchEvent&&t.touches.length>0?(a=t.touches[0].clientX-s.left,i=t.touches[0].clientY-s.top):typeof MouseEvent<"u"&&t instanceof MouseEvent?(a=t.clientX-s.left,i=t.clientY-s.top):(a=s.width/2,i=s.height/2);const o=document.createElement("span");o.classList.add("ripple"),n&&o.classList.add(`ripple-${n}`);const l=Math.max(s.width,s.height)*2;o.style.width=`${l}px`,o.style.height=`${l}px`,o.style.left=`${a-l/2}px`,o.style.top=`${i-l/2}px`,e.appendChild(o);const d=setTimeout(()=>{o.remove(),re.delete(d)},500);re.add(d)}function sa(){document.querySelectorAll(".num-btn").forEach(e=>{e.classList.add("ripple-container"),w.add(e,"touchstart",n=>L(n,e),{passive:!0}),w.add(e,"mousedown",n=>L(n,e))});const t=document.querySelector(".timestamp-btn");t&&(t.classList.add("ripple-container"),w.add(t,"touchstart",e=>L(e,t,"primary"),{passive:!0}),w.add(t,"mousedown",e=>L(e,t,"primary"))),document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.add("ripple-container");const n=e.getAttribute("data-point")==="S";w.add(e,"touchstart",s=>L(s,e,n?"success":"secondary"),{passive:!0}),w.add(e,"mousedown",s=>L(s,e,n?"success":"secondary"))}),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.add("ripple-container"),w.add(e,"touchstart",n=>L(n,e,"primary"),{passive:!0}),w.add(e,"mousedown",n=>L(n,e,"primary"))}),document.querySelectorAll(".action-btn").forEach(e=>{e.classList.add("ripple-container"),w.add(e,"touchstart",n=>L(n,e),{passive:!0}),w.add(e,"mousedown",n=>L(n,e))}),document.querySelectorAll(".modal-btn").forEach(e=>{e.classList.add("ripple-container");const n=e.classList.contains("primary"),s=e.classList.contains("danger"),a=n?"primary":s?"secondary":void 0;w.add(e,"touchstart",i=>L(i,e,a),{passive:!0}),w.add(e,"mousedown",i=>L(i,e,a))})}function ia(){w.removeAll(),re.forEach(t=>clearTimeout(t)),re.clear()}const ut=new T;function E(t,e){ut.add(window,t,e)}function oa(){E("open-edit-modal",(t=>{Vn(t.detail.entry)})),E("prompt-delete",(t=>{On(t.detail.entry)})),E("open-confirm-modal",(t=>{it(t.detail.action)})),E("request-photo-sync-warning",(async()=>{try{await hn(),Re()}catch(t){v.error("Photo sync warning modal failed:",t),Re()}})),E("request-race-change-dialog",(async t=>{try{const e=t,n=await yn(e.detail.type,e.detail.lang);xe(n)}catch(e){v.error("Race change dialog failed:",e),xe("cancel")}})),E("update-role-toggle",(()=>{Qe()})),E("request-pin-verification",(async t=>{try{const n=await bn(t.detail.lang);Ie(n)}catch(e){v.error("PIN verification failed:",e),Ie(!1)}})),E("open-fault-edit-modal",(t=>{kt(t.detail.fault)})),E("open-mark-deletion-modal",(t=>{At(t.detail.fault)})),E("update-inline-faults-list",(()=>{Pe()})),E("update-inline-bib-selector",(()=>{Rt()})),E("update-inline-gate-selector",(()=>{xt()})),E("fault-sync-error",(()=>{const t=r.getState().currentLang;h(c("faultSyncError",t),"error",4e3)}))}function ra(){if(!H.isSupported()){v.debug("[VoiceMode] Not supported in this browser");return}const t="/api/v1/voice",e=window.VOICE_LLM_CONFIG,n={endpoint:(e==null?void 0:e.endpoint)||t,apiKey:(e==null?void 0:e.apiKey)||"proxy"};if(!H.initialize(n)){v.warn("[VoiceMode] Failed to initialize");return}H.onStatusChange(a=>{aa(a)}),H.onAction(a=>{r.getState().deviceRole==="gateJudge"?Ct(a):ea(a)}),v.debug("[VoiceMode] Initialized successfully")}function gt(t){const{isQuotaError:e,entryCount:n,retriesExhausted:s}=t.detail,a=r.getState().currentLang;s?h(c("storageSaveGaveUp",a),"error",15e3):e?h(c("storageNearlyFull",a),"error",ie.CRITICAL):h(c("storageError",a),"error",ie.ERROR),me(),v.error("[Storage] saveEntries:",t.detail.message,{entryCount:n,isQuotaError:e,retriesExhausted:s})}function ft(t){const{percent:e,critical:n}=t.detail,s=r.getState().currentLang;n?h(`${c("storageQuotaError",s)} (${e}%)`,"error",ie.CRITICAL):sessionStorage.getItem("storage-warning-shown")||(h(c("storageNearlyFull",s),"warning",ie.WARNING),sessionStorage.setItem("storage-warning-shown","true"))}function ca(){try{r.forceSave(),q.flush()}catch(t){v.warn("Storage flush error on unload:",t)}try{Hn(),Bn()}catch(t){v.warn("Timer cleanup error:",t)}V.cleanup(),qn(),ae.stop(),M.stop(),se.disable(),N.cleanup(),H.cleanup(),Vt(),ia(),document.querySelectorAll(".ripple").forEach(t=>t.remove()),window.removeEventListener("race-deleted",Ke),window.removeEventListener("auth-expired",Xe),window.removeEventListener("storage-error",gt),window.removeEventListener("storage-warning",ft),ut.removeAll(),Cn(),pn(),Ye(),Ot()}function la(){const t=[];return t.push(y(()=>{Ft.value,oe()?nt():pe()})),t.push(y(()=>{Ut.value,oe()||he()})),t.push(y(()=>{Jt.value,ye(),Ne(),$.value==="gateJudge"&&Z()})),t.push(y(()=>{zt.value,et(),tt(),$.value==="gateJudge"&&Z()})),t.push(y(()=>{We.value,Qe(),Bt(),z()})),t.push(y(()=>{Ht.value,z()})),t.push(y(()=>{Gt.value,Me()})),t.push(y(()=>{_t.value,$.value==="gateJudge"&&Z()})),t.push(y(()=>{Wt.value,jt.value,Q()})),t.push(y(()=>{Kt.value,ee(),z()})),t.push(y(()=>{Xt.value,dt()})),t.push(y(()=>{const e=$.value;ct(),ee(),Q(),e==="timer"?se.enable():se.disable();const n=kn();n&&(e==="results"?n.resume():n.pause())})),t.push(y(()=>{Le.value,Yt.value,Q()})),t.push(y(()=>{Ce.value,$.value,Te(()=>ee()),queueMicrotask(()=>at(r.getState()))})),t.push(y(()=>{Oe.value,$.value,Te(()=>lt()),queueMicrotask(()=>st(r.getState()))})),t.push(y(()=>{Zt.value,Qt.value,vn()})),t.push(y(()=>{const e=en.value,n=$.value;e?(N.initialize(),n==="timer"&&N.enable()):N.disable()})),t.push(y(()=>{Le.value,Ce.value,z()})),()=>{for(const e of t)e()}}let le=!1;const ue=new T;function mt(){if(le)return;const t=document.getElementById("offline-banner");if(t){const e=r.getState().currentLang,n=document.getElementById("offline-banner-text");n&&(n.textContent=c("offlineBanner",e)),t.classList.remove("hidden")}}function pt(){const t=document.getElementById("offline-banner");t&&t.classList.add("hidden")}function da(){pt(),le=!1;const t=r.getState().currentLang;h(c("onlineRestored",t),"success",2e3)}function ua(){le=!1,mt()}function ga(){const t=document.getElementById("offline-banner-dismiss");t&&ue.add(t,"click",()=>{le=!0,pt()}),ue.add(window,"online",da),ue.add(window,"offline",ua),navigator.onLine||mt()}const ge="skiTimerHasCompletedOnboarding";class fa{constructor(){A(this,"modal");A(this,"currentStep",1);A(this,"totalSteps",6);A(this,"selectedRole","timer");A(this,"updateTranslationsCallback",null);A(this,"recentRacesDocumentHandler",null);A(this,"debouncedCheckRace",null);A(this,"listeners",new T);this.modal=document.getElementById("onboarding-modal"),this.modal&&this.setupEventListeners()}setUpdateTranslationsCallback(e){this.updateTranslationsCallback=e}shouldShow(){return q.getRaw(ge)!=="true"}show(){if(!this.modal)return;this.currentStep=1,this.selectedRole="timer",this.modal.querySelectorAll(".onboarding-card").forEach((m,p)=>{m.style.display=p===0?"block":"none"});const e=document.getElementById("onboarding-race-id");e&&(e.value="");const n=document.getElementById("onboarding-pin");n&&(n.value="",n.style.display="none");const s=document.getElementById("onboarding-race-status");s&&(s.textContent="",s.className="race-status");const a=document.getElementById("onboarding-sync-toggle");a&&(a.checked=!0);const i=document.getElementById("onboarding-photo-toggle");i&&(i.checked=!1),this.modal.querySelectorAll(".role-card").forEach(m=>{const p=m.getAttribute("data-role")==="timer";m.classList.toggle("selected",p),m.setAttribute("aria-checked",String(p))});const o=document.getElementById("onboarding-gate-start"),l=document.getElementById("onboarding-gate-end");o&&(o.value="1"),l&&(l.value="10"),this.updateUI(),j(this.modal);const d=document.getElementById("onboarding-device-name");d&&(d.value=r.getState().deviceName);const u=r.getState().currentLang;this.modal.querySelectorAll(".lang-btn").forEach(m=>{const S=m.dataset.lang===u;m.classList.toggle("selected",S),m.setAttribute("aria-checked",String(S))})}reset(){q.remove(ge),q.flush()}setupEventListeners(){if(!this.modal)return;this.listeners.add(document,"keydown",(i=>{var o;i.key==="Escape"&&((o=this.modal)!=null&&o.classList.contains("active"))&&this.dismiss()})),this.modal.querySelectorAll(".lang-btn").forEach(i=>{this.listeners.add(i,"click",o=>{const l=o.currentTarget,d=l.dataset.lang;d&&(r.setLanguage(d),this.modal.querySelectorAll(".lang-btn").forEach(u=>{u.classList.remove("selected"),u.setAttribute("aria-checked","false")}),l.classList.add("selected"),l.setAttribute("aria-checked","true"),f(),this.updateTranslationsCallback&&this.updateTranslationsCallback(),this.updateOnboardingTranslations())})}),this.modal.querySelectorAll("[data-action]").forEach(i=>{this.listeners.add(i,"click",async o=>{const d=o.currentTarget.dataset.action;d&&(f(),await this.handleAction(d))})});const e=document.getElementById("onboarding-regenerate-name");e&&this.listeners.add(e,"click",()=>{const i=document.getElementById("onboarding-device-name");i&&(i.value=tn(),f())}),this.modal.querySelectorAll(".role-card").forEach(i=>{this.listeners.add(i,"click",()=>{const o=i.getAttribute("data-role");o&&(this.selectedRole=o,this.modal.querySelectorAll(".role-card").forEach(l=>{const d=l===i;l.classList.toggle("selected",d),l.setAttribute("aria-checked",String(d))}),f())})});const n=document.getElementById("onboarding-race-id");n&&(this.debouncedCheckRace=nn(()=>this.checkRaceExists(),500),this.listeners.add(n,"input",()=>{this.debouncedCheckRace();const i=document.getElementById("onboarding-pin");i&&(i.style.display=n.value.trim()?"block":"none")}));const s=document.getElementById("onboarding-recent-races-btn"),a=document.getElementById("onboarding-recent-races-dropdown");s&&a&&(this.listeners.add(s,"click",()=>{f(),a.style.display==="none"?(this.showRecentRacesDropdown(a,"onboarding-race-id"),s.setAttribute("aria-expanded","true")):(a.style.display="none",s.setAttribute("aria-expanded","false"))}),this.recentRacesDocumentHandler||(this.recentRacesDocumentHandler=i=>{const o=i.target;!s.contains(o)&&!a.contains(o)&&(a.style.display="none",s.setAttribute("aria-expanded","false"))},this.listeners.add(document,"click",this.recentRacesDocumentHandler)))}async showRecentRacesDropdown(e,n){const s=r.getState().currentLang;e.innerHTML=`<div class="recent-races-empty">${c("loading",s)}</div>`,e.style.display="block";let a=[];if(Ve())try{a=await this.fetchRacesFromApi()}catch(i){v.warn("Failed to fetch races from API:",i),a=ke()}else a=ke();a.length===0?e.innerHTML=`<div class="recent-races-empty">${c("noRecentRaces",s)}</div>`:(e.innerHTML=Sn(a),En(e,a,i=>{this.selectRecentRace(i,n,e)}))}async fetchRacesFromApi(){const e=q.getRaw("skiTimerAuthToken");if(!e)return[];const n=await an("/api/v1/admin/races",{headers:{Authorization:`Bearer ${e}`}},5e3);if(!n.ok)throw new Error(`API error: ${n.status}`);const a=(await n.json()).races||[],i=new Date;i.setHours(0,0,0,0);const o=i.getTime(),l=a.filter(d=>d.lastUpdated&&d.lastUpdated>=o).map(d=>({raceId:d.raceId,createdAt:d.lastUpdated||Date.now(),lastUpdated:d.lastUpdated||Date.now(),entryCount:d.entryCount})).slice(0,5);return l.forEach(d=>{sn(d.raceId,d.lastUpdated,d.entryCount)}),l}selectRecentRace(e,n,s){const a=document.getElementById(n);a&&(a.value=e.raceId,a.dispatchEvent(new Event("input",{bubbles:!0})),f()),s.style.display="none"}updateOnboardingTranslations(){if(!this.modal)return;const e=r.getState().currentLang;this.modal.querySelectorAll("[data-i18n]").forEach(n=>{const s=n.getAttribute("data-i18n");s&&(n.textContent=c(s,e))})}async handleAction(e){switch(e){case"next":await this.validateCurrentStep()&&(await this.saveCurrentStep(),r.forceSave(),this.goToStep(this.currentStep+1));break;case"back":this.currentStep>1&&this.goToStep(this.currentStep-1);break;case"skip":r.forceSave(),this.goToStep(this.currentStep+1);break;case"finish":this.complete();break;case"dismiss":this.dismiss();break}}finalize(){if(r.forceSave(),q.setRaw(ge,"true"),q.flush(),ne(this.modal),this.selectedRole==="gateJudge"){r.setView("gateJudge");const e=document.getElementById("gate-judge-tab");e&&(e.style.display="")}else r.setView("timer");this.debouncedCheckRace&&(this.debouncedCheckRace.cancel(),this.debouncedCheckRace=null),this.listeners.removeAll(),this.recentRacesDocumentHandler=null}dismiss(){const e=document.getElementById("onboarding-device-name");e!=null&&e.value.trim()&&r.setDeviceName(e.value.trim()),r.setDeviceRole(this.selectedRole),this.finalize()}async validateCurrentStep(){var n,s,a,i;const e=r.getState().currentLang;switch(this.currentStep){case 2:return!0;case 3:return((n=document.getElementById("onboarding-device-name"))==null?void 0:n.value.trim())?!0:(h(c("deviceName",e),"warning"),!1);case 4:return!0;case 5:{const o=(s=document.getElementById("onboarding-race-id"))==null?void 0:s.value.trim(),l=(a=document.getElementById("onboarding-sync-toggle"))==null?void 0:a.checked;if(!o||!l)return!0;const d=(i=document.getElementById("onboarding-pin"))==null?void 0:i.value;return d.length!==4?(h(c("invalidPin",e),"warning"),!1):await this.validatePin(d)}default:return!0}}async saveCurrentStep(){var e,n,s,a,i,o;switch(this.currentStep){case 2:{r.setDeviceRole(this.selectedRole);break}case 3:{const l=(e=document.getElementById("onboarding-device-name"))==null?void 0:e.value.trim();l&&r.setDeviceName(l);break}case 4:{if(this.selectedRole==="gateJudge"){const l=parseInt(((n=document.getElementById("onboarding-gate-start"))==null?void 0:n.value)||"1",10),d=parseInt(((s=document.getElementById("onboarding-gate-end"))==null?void 0:s.value)||"10",10),u=Math.min(l,d),m=Math.max(l,d);r.setGateAssignment([u,m])}else{const l=(a=document.getElementById("onboarding-photo-toggle"))==null?void 0:a.checked;r.updateSettings({photoCapture:l})}break}case 5:{const l=(i=document.getElementById("onboarding-race-id"))==null?void 0:i.value.trim(),d=(o=document.getElementById("onboarding-sync-toggle"))==null?void 0:o.checked;l&&r.setRaceId(l);const u=d&&!!l;r.updateSettings({sync:u}),u&&V.initialize();break}}}goToStep(e){if(!(!this.modal||e<1||e>this.totalSteps)){if(this.modal.querySelectorAll(`[data-step="${this.currentStep}"]`).forEach(n=>{n.style.display="none"}),this.currentStep=e,e===4){const n=this.modal.querySelector(`[data-step="4"][data-path="${this.selectedRole}"]`);n&&(n.style.display="block")}else{const n=this.modal.querySelector(`[data-step="${e}"]:not([data-path])`);n&&(n.style.display="block")}this.updateUIForRole(),this.updateProgressDots(),e===6&&this.showSummary()}}updateUIForRole(){const e=r.getState().currentLang,n=document.getElementById("onboarding-device-name-title"),s=document.getElementById("onboarding-device-name-desc");this.selectedRole==="gateJudge"?(n&&(n.textContent=c("onboardingDeviceNameJudge",e)),s&&(s.textContent=c("onboardingDeviceNameJudgeDesc",e))):(n&&(n.textContent=c("onboardingDeviceName",e)),s&&(s.textContent=c("onboardingDeviceNameDesc",e)));const a=document.getElementById("onboarding-ready-title"),i=document.getElementById("onboarding-ready-tip"),o=document.getElementById("onboarding-finish-btn");this.selectedRole==="gateJudge"?(a&&(a.textContent=c("onboardingReadyJudge",e)),i&&(i.textContent=c("onboardingTipJudge",e)),o&&(o.textContent=c("startJudging",e))):(a&&(a.textContent=c("onboardingReady",e)),i&&(i.textContent=c("onboardingTip",e)),o&&(o.textContent=c("startTiming",e)))}updateProgressDots(){if(!this.modal)return;const e=this.modal.querySelectorAll(".progress-dot");e.forEach((s,a)=>{s.classList.remove("active","completed"),a+1===this.currentStep?s.classList.add("active"):a+1<this.currentStep&&s.classList.add("completed")});const n=this.modal.querySelector("#onboarding-progress-label");if(n){const s=e.length,a=r.getState().currentLang;n.textContent=c("onboardingStepOf",a).replace("{current}",String(this.currentStep)).replace("{total}",String(s))}}updateUI(){this.updateProgressDots(),this.updateOnboardingTranslations()}showSummary(){const e=r.getState(),n=e.currentLang,s=document.getElementById("onboarding-summary");if(s){s.innerHTML="";const a=[],i=this.selectedRole==="gateJudge"?c("roleJudgeTitle",n):c("roleTimerTitle",n);a.push({label:c("deviceRole",n),value:i,badge:"role"});const o=this.selectedRole==="gateJudge"?c("onboardingDeviceNameJudge",n):c("deviceNameLabel",n);if(a.push({label:o,value:e.deviceName}),this.selectedRole==="gateJudge"){const u=e.gateAssignment;a.push({label:c("gates",n),value:u?`${u[0]}–${u[1]}`:"—"})}else{const u=e.settings.photoCapture;a.push({label:c("photoCaptureLabel",n),value:u?c("enabled",n):c("disabled",n),badge:u?"enabled":"disabled"})}a.push({label:c("raceIdLabel",n),value:e.raceId||"—"});const l=e.settings.sync;a.push({label:c("syncStatusLabel",n),value:l?c("enabled",n):c("disabled",n),badge:l?"enabled":"disabled"});const d=document.createElement("div");d.className="onboarding-summary-list",a.forEach(({label:u,value:m,badge:p})=>{const S=document.createElement("div");S.className="onboarding-summary-row";const C=document.createElement("span");C.className="onboarding-summary-label",C.textContent=u;const I=document.createElement("span");p?I.className=`onboarding-summary-badge ${p}`:I.className="onboarding-summary-value",I.textContent=m,S.append(C,I),d.appendChild(S)}),s.appendChild(d)}}async checkRaceExists(){const e=document.getElementById("onboarding-race-id"),n=document.getElementById("onboarding-race-status");if(!e||!n)return;const s=e.value.trim(),a=r.getState().currentLang;if(!s){n.textContent="",n.className="race-status";return}n.innerHTML=`${on(14)} ${G(c("loading",a))}`,n.className="race-status loading";const i=await V.checkRaceExists(s);if(i.exists){const o=i.entryCount===1?c("entry",a):c("entries",a);n.innerHTML=`${rn(14)} ${G(c("raceFound",a))} (${G(String(i.entryCount))} ${G(o)})`,n.className="race-status found"}else n.textContent=`+ ${c("raceNew",a)}`,n.className="race-status new"}async validatePin(e){try{return(await cn(e)).success}catch{const n=r.getState().currentLang;return h(`${c("networkError",n)} - ${c("pinVerifyOnline",n)}`,"warning",5e3),!0}}complete(){this.finalize(),Ue(),h(c("onboardingComplete",r.getState().currentLang),"success")}}const R=new T;let D=null;function qe(){const t=document.getElementById("app-version");t&&(t.textContent="5.26.0");const e=Be("5.26.0",r.getState().currentLang),n=document.getElementById("app-version-name"),s=document.getElementById("app-version-description");e&&n&&(n.textContent=`"${e.name}"`),e&&s&&(s.textContent=e.description);const a=document.getElementById("version-info-btn");a&&R.add(a,"click",async()=>{const g=r.getState(),O=Be("5.26.0",g.currentLang),bt=[O?`CHRONO v5.26.0 "${O.name}"`:"CHRONO v5.26.0",`Device: ${g.deviceName||"Unknown"}`,`Role: ${g.deviceRole}`,`Race ID: ${g.raceId||"None"}`,`Entries: ${g.entries.length}`,`Sync: ${g.settings.sync?"On":"Off"}`,`Language: ${g.currentLang.toUpperCase()}`,`User Agent: ${navigator.userAgent}`,`Screen: ${window.screen.width}x${window.screen.height}`,`Viewport: ${window.innerWidth}x${window.innerHeight}`,`Online: ${navigator.onLine}`,`Timestamp: ${new Date().toISOString()}`].join(`
`);try{await navigator.clipboard.writeText(bt),h(c("debugInfoCopied",g.currentLang),"success")}catch{h(c("debugInfoCopyFailed",g.currentLang),"warning")}f()}),Gn(),oe()?Tn():(zn(),_n(),Wn(),jn(),Kn()),An(),wn();const i=()=>{ve(()=>import("./gate-judge-BcJMKlnh.js").then(g=>g.t),__vite__mapDeps([0,1,2])).then(g=>g.initGateJudgeView()).catch(g=>v.error("Failed to load gateJudgeView:",g)),ve(()=>import("./chief-judge-riJEdY3M.js").then(g=>g.aM),__vite__mapDeps([1,2])).then(g=>g.initChiefJudgeToggle()).catch(g=>v.error("Failed to load chiefJudgeView:",g))},o=r.getState().deviceRole;o==="gateJudge"&&i();let l=o;const d=y(()=>{const g=We.value;g!==l&&(l=g,g==="gateJudge"&&i())});R.add(window,"pagehide",()=>d()),oa(),Nn(),In(),sa(),ga();const u=la();R.add(window,"pagehide",()=>u()),Dn(),R.add(window,"beforeunload",ca),ta(),D=new fa,D.setUpdateTranslationsCallback(()=>Ze()),D.shouldShow()&&D.show();const m=document.getElementById("show-tutorial-btn");m&&R.add(m,"click",()=>{D&&(D.reset(),D.show(),f())});const p=document.getElementById("keyboard-shortcuts-modal"),S=document.getElementById("show-shortcuts-btn"),C=document.getElementById("shortcuts-close-btn"),I=document.getElementById("shortcuts-done-btn");S&&p&&R.add(S,"click",()=>{j(p),f()}),C&&p&&R.add(C,"click",()=>ne(p)),I&&p&&R.add(I,"click",()=>ne(p)),R.add(document,"keydown",(g=>{if(g.key==="?"&&!Tt()){const O=g.target;if(O.tagName==="INPUT"||O.tagName==="TEXTAREA"||O.tagName==="SELECT")return;g.preventDefault(),p&&j(p)}}))}let fe=!1,W=[],J=null;const ma=3,pa=1e4;function ha(){window.addEventListener("error",ya),window.addEventListener("unhandledrejection",ba),window.addEventListener("critical-error",va)}function ya(t){const{message:e,error:n}=t;je("Global","uncaught error",n||e,void 0),ht(e),yt()&&be(e),t.preventDefault()}function ba(t){const e=t.reason,n=e instanceof Error?e.message:String(e);je("Global","unhandled rejection",e,void 0),ht(n),yt()&&be(n),t.preventDefault()}function va(t){var s;const e=t.detail,n=((s=e==null?void 0:e.error)==null?void 0:s.message)||"Critical error occurred";ln("Global","critical error event",e==null?void 0:e.error,void 0),be(n)}function ht(t){const e=Date.now();W.push({message:t,timestamp:e}),W=W.filter(n=>e-n.timestamp<pa)}function yt(){return W.length>=ma}function be(t){var a,i;if(fe)return;fe=!0;const e=r.getState().currentLang,n=document.createElement("div");n.id="error-boundary-overlay",n.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 24px;
  `;const s=document.createElement("div");s.style.cssText=`
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    text-align: center;
    color: #fff;
  `,s.innerHTML=`
    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
    <h2 style="margin: 0 0 8px; font-size: 1.25rem;">${c("errorOccurred",e)}</h2>
    <p style="color: #999; font-size: 0.875rem; margin: 0 0 16px;">
      ${c("errorRecoveryMessage",e)}
    </p>
    <p style="color: #666; font-size: 0.75rem; font-family: monospace; margin: 0 0 24px; word-break: break-word;">
      ${G(t.substring(0,200))}
    </p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="error-dismiss-btn" style="
        padding: 12px 24px;
        border: 1px solid #444;
        border-radius: 8px;
        background: transparent;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${c("dismiss",e)}</button>
      <button id="error-reload-btn" style="
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #3B82F6;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${c("reload",e)}</button>
    </div>
  `,n.appendChild(s),document.body.appendChild(n),J=setTimeout(()=>{J=null;const o=document.getElementById("error-dismiss-btn");o==null||o.focus()},100),(a=document.getElementById("error-dismiss-btn"))==null||a.addEventListener("click",()=>{J!==null&&(clearTimeout(J),J=null),n.remove(),fe=!1,W=[]}),(i=document.getElementById("error-reload-btn"))==null||i.addEventListener("click",()=>{window.location.reload()})}ha();dn();un();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",qe):qe();let te=null;Ae.initialize().then(()=>{te=Ae.subscribe(t=>{document.body.classList.toggle("power-saver",t.batteryLevel!=="normal")})}).catch(()=>{});window.addEventListener("beforeunload",()=>{te&&(te(),te=null)});
