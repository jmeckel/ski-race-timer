var na=Object.defineProperty;var ia=(n,e,t)=>e in n?na(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var h=(n,e,t)=>ia(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&i(r)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();const yi={en:{timer:"Timer",results:"Results",settings:"Settings",start:"Start",finish:"Finish",startShort:"S",finishShort:"F",bib:"Bib",point:"Point",run:"Run",run1:"R1",run2:"R2",time:"Record time",lastRecorded:"Last recorded",lastRecordedShort:"Last:",advancedSettings:"Advanced Settings",status:"Status",noEntries:"No entries recorded",noEntriesHint:"Record times on the Timer tab",search:"Search by bib...",filter:"Filter",all:"All",total:"Total",racers:"Racers",finished:"Finished",fastest:"Fastest",average:"Average",timeEntry:"time",timeEntries:"times",faultEntry:"fault",faultEntries:"faults",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Delete Entry",confirmDeleteText:"Are you sure you want to delete this entry?",confirmDeleteFault:"Delete this fault?",confirmClearAll:"Clear All Results",clearAllText:"This will delete all recorded entries. This action cannot be undone.",confirmUndoAdd:"Undo Recording",confirmUndoAddText:"This will delete the recorded entry. Continue?",delete:"Delete",cancel:"Cancel",close:"Close",back:"Back",save:"Save",saving:"Saving...",edit:"Edit",undo:"Undo",export:"Export",clearAll:"Clear All",selectAll:"Select All",deleteSelected:"Delete Selected",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Synced from cloud",raceId:"Race ID",invalidRaceId:"Invalid Race ID. Use letters, numbers, hyphens, underscores only.",deviceName:"Time Keeper ID",cloudSync:"Cloud Sync",syncStatus:"Sync Status",pendingSync:"pending sync",raceSetup:"Race Setup",raceSetupDesc:"Required for multi-device timing and syncing.",firstGateLabel:"First gate",saved:"Saved",deleted:"Deleted",cleared:"All entries cleared",undone:"Undone",copied:"Copied to clipboard",debugInfoCopied:"Debug info copied to clipboard",debugInfoCopyFailed:"Tap and hold to copy debug info",duplicateWarning:"Duplicate entry detected",zeroBibWarning:"Bib 000 - verify entry",exported:"Exported successfully",gps:"GPS",gpsActive:"GPS Active",gpsSearching:"Searching for GPS...",gpsInactive:"GPS Inactive",gpsAccuracy:"Accuracy",settingsRaceSetup:"Race Setup",settingsTimingGroup:"Timing",settingsSyncGroup:"Sync",settingsFeedbackGroup:"Feedback",settingsDisplayGroup:"Display",simpleMode:"Simple Mode",fullMode:"Full Mode",autoIncrement:"Auto-increment Bib",hapticFeedback:"Haptic Feedback",soundFeedback:"Sound Feedback",language:"Language",advancedSettingsHint:"These options can affect timing accuracy. Change only if needed.",simpleModeDesc:"Simplified interface for basic timing",cloudSyncDesc:"Sync with other devices",gpsDesc:"Use GPS for accurate timestamps",autoIncrementDesc:"Increase bib number after recording",photoCaptureDesc:"Capture photo on timestamp",hapticFeedbackDesc:"Vibration on actions",soundFeedbackDesc:"Audio confirmation",ambientMode:"Ambient Mode",ambientModeDesc:"Auto-dim after 30s inactivity",photoCapture:"Photo Capture",photoCaptured:"Photo captured",photoError:"Photo capture failed",photoSaveFailed:"Photo storage failed",viewPhoto:"View Photo",deletePhoto:"Delete Photo",photoFor:"Photo for Bib",noPhotoAvailable:"No photo available",photoDeleted:"Photo deleted",raceChangeTitle:"Change Race",raceChangeSyncedText:"You have results from another race. Export or delete them before switching?",raceChangeUnsyncedText:"You have existing results. Keep them or delete before switching?",keepResults:"Keep",version:"Version",devices:"Devices",entries:"entries",selected:"selected",raceFound:"Race found",raceNew:"New race",entryInCloud:"entry in cloud",entriesInCloud:"entries in cloud",photoTooLarge:"Photo too large for sync",syncedEntriesFromCloud:"Synced {count} entries from cloud",syncedFaultsFromCloud:"Synced {count} faults from cloud",crossDeviceDuplicate:"Duplicate: Bib {bib} {point} already recorded by {device}",syncPhotos:"Sync Photos",syncPhotosDesc:"Share photos across devices via cloud",syncPhotosWarning:"Enable Photo Sync",syncPhotosWarningText:"Enabling photo sync will transfer the following data:",photosToUpload:"Photos to upload",photosToDownload:"Photos to download",totalDataVolume:"Total data volume",enableSync:"Enable Sync",noPhotosToSync:"No photos to sync",admin:"Admin",adminPin:"Race Management PIN",adminPinDesc:"Required to manage and sync races",manageRaces:"Manage Races",manageRacesDesc:"View and delete synced races",manage:"Manage",enterAdminPin:"Enter Race Management PIN",enterPinText:"Enter your PIN to access race management.",enterPinToJoinRace:"Enter your PIN to join this race.",enterPinForChiefJudge:"Enter your PIN to access Chief Judge mode.",enterChiefJudgePin:"Enter Chief Judge PIN",enterPinForChiefJudgeInfo:"Chief Judge mode requires a separate PIN. First use sets the PIN.",syncRequiresPin:"Sync disabled. Enable sync and enter PIN to reconnect.",incorrectPin:"Incorrect PIN",verify:"Verify",setPinFirst:"Please set a Race Management PIN first",pinSaved:"PIN saved",pinCleared:"PIN cleared",pinNotSet:"Not set",pinSet:"PIN set",setPin:"Set PIN",changePin:"Change PIN",currentPin:"Current PIN",newPin:"New PIN (4 digits)",confirmPin:"Confirm PIN",pinMismatch:"PINs do not match",pinFormatError:"PIN must be exactly 4 digits",loading:"Loading...",noRaces:"No active races",noRacesHint:"Create one in Settings",cleanRunHint:"Clean run so far",refresh:"Refresh",raceDeleted:"Race Deleted",raceDeletedText:"This race has been deleted by an administrator.",raceDeletedFor:"Race deleted:",raceDeletedSuccess:"Race deleted:",confirmDeleteRace:"Delete Race",confirmDeleteRaceText:"Are you sure you want to delete race",loadError:"Failed to load races. Check your connection and try again.",deleteError:"Failed to delete race",entry:"entry",device:"device",storageError:"Failed to save data - check storage",storageQuotaError:"Storage full! Export data immediately",storageWarning:"Storage almost full",storageNearlyFull:"Storage nearly full. Export data and clear old entries.",networkError:"Network error - check connection",connectionFailed:"Connection failed",serverUnavailable:"Server unavailable",rateLimitError:"Too many requests - please wait",authError:"Authentication failed. Try re-entering your PIN.",syncFailed:"Sync failed",pinSyncFailed:"PIN not synced to cloud",cameraError:"Camera error",cameraPermissionDenied:"Camera access denied",gpsError:"GPS error",gpsPermissionDenied:"GPS access denied",gpsUnavailable:"GPS unavailable",wakeLockFailed:"Screen may dim during timing",wakeLockIdleTimeout:"Screen will dim to save battery. Tap to keep awake.",unknownError:"Unknown error",onboardingWelcome:"Welcome to Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronized timing for ski races",getStarted:"Get Started",skipSetup:"Skip",onboardingRole:"What's Your Role?",onboardingRoleDesc:"Choose how you'll be helping at the race",roleTimerTitle:"Timer",roleTimerDesc:"You will record start and finish times",roleJudgeTitle:"Gate Judge",roleJudgeDesc:"You will record gate faults (Torrichter)",onboardingDeviceName:"Name Your Timer",onboardingDeviceNameDesc:"This identifies your device when syncing",onboardingDeviceNameJudge:"Your Name",onboardingDeviceNameJudgeDesc:"This identifies you as the gate judge",onboardingPhoto:"Photo Documentation",onboardingPhotoDesc:"Automatically capture a photo when recording each timestamp. Useful for verifying bib numbers and resolving disputes.",enablePhotoCapture:"Enable Photo Capture",photoCaptureLabel:"Photo Capture",onboardingGates:"Your Gate Assignment",onboardingGatesDesc:"Enter the gate numbers you'll be watching. You can change this later.",onboardingRaceSetup:"Join a Race",onboardingRaceSetupDesc:"Enter a race ID to sync with other timers",skipForNow:"Skip for now",onboardingReady:"Ready to Time!",onboardingReadyJudge:"Ready to Judge!",onboardingTip:"Tap the big blue button to record timestamps",onboardingTipJudge:"Tap a racer's bib to record a fault",startTiming:"Start Timing",startJudging:"Start Judging",continue:"Continue",deviceNameLabel:"Device Name",raceIdLabel:"Race ID",syncStatusLabel:"Cloud Sync",enabled:"Enabled",disabled:"Disabled",showTutorial:"Show Tutorial",showTutorialDesc:"Run the setup wizard again",show:"Show",onboardingComplete:"Setup complete!",invalidPin:"PIN must be 4 digits",recentRaces:"Recent Races",noRecentRaces:"No races from today",errorOccurred:"Something went wrong",errorRecoveryMessage:"The app encountered an error. You can dismiss this and continue, or reload the app.",dismiss:"Dismiss",reload:"Reload",updateAvailable:"Update available! Reload to get the latest version.",operationFailed:"Operation failed. Please try again.",raceIdPlaceholder:"RACE-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Photo for bib",gateJudge:"Gate Judge",gateJudgeTab:"Gate",deviceRole:"Device Role",deviceRoleDesc:"Timer records times, Gate Judge records faults",roleTimer:"Timer",roleGateJudge:"Gate Judge",gateAssignment:"Gate Assignment",noGateAssignment:"No gate assignment. Please set your gate range first.",gates:"Gates",gatesFrom:"From",gatesTo:"To",firstGateColor:"Color of first gate",colorRed:"Red",colorBlue:"Blue",changeGates:"Change",otherJudges:"Other judges:",activeBibs:"On Course",noBibsOnCourse:"No racers on course",recordFault:"Record Fault",faultType:"Fault Type",faultMG:"Missed Gate",faultSTR:"Straddling",faultBR:"Binding Release",faultMGShort:"MG",faultSTRShort:"STR",faultBRShort:"BR",orEnterManually:"or enter:",faultRecorded:"Fault recorded",signalReady:"Ready",judgeReady:"Ready for race!",judgeNotReady:"Ready status cleared",faultDeleted:"Fault deleted",recordedFaults:"Recorded Faults",selectBib:"Select Bib",selectGate:"Gate",gate:"Gate",noFaults:"No faults recorded",faultsFor:"Faults for",faultSummary:"Fault Summary",penaltyTime:"Penalty",faultCount:"faults",markOk:"Mark OK",saveFault:"Save Fault",selectFaultType:"Please select a fault type",gateOutOfRange:"Gate is outside assigned range",flt:"FLT",statusFlt:"Fault Penalty",chiefJudge:"Chief Judge",noFaultsRecorded:"No faults recorded",finalize:"Finalize",finalized:"Finalized",chiefJudgeMode:"Chief Judge Mode",chiefJudgeModeEnabled:"Chief Judge mode enabled",chiefJudgeModeDisabled:"Chief Judge mode disabled",racersWithFaults:"Racers with faults",penaltyMode:"+Time",gateJudges:"Gate Judges",noJudgesConnected:"No gate judges connected",summary:"Summary",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"No faults to export",copiedToClipboard:"Copied to clipboard",gateJudgeCard:"Gate Judge Card",race:"Race",date:"Date",gateJudgeLabel:"Gate Judge",runLabel:"Run",noFaultsEntered:"No faults entered",signature:"Signature",legend:"Legend",missedGateLegend:"Missed",straddlingLegend:"Straddling",bindingLegend:"Binding",gateFaults:"Gate Faults",penaltyLabel:"PENALTY",faultSummaryTitle:"GATE FAULT SUMMARY",faults:"Faults",penalty:"Penalty",sec:"sec",generated:"Generated",editFault:"Edit Fault",versionHistory:"Version History",restoreVersion:"Restore Selected Version",currentVersion:"Current",originalVersion:"Original",restored:"Restored",versionRestored:"Version restored",markForDeletion:"Mark for Deletion",markForDeletionText:"This fault will be marked for deletion and requires Chief Judge approval to permanently delete.",markedForDeletion:"Marked for deletion",deletionPending:"Deletion pending",pendingDeletions:"Pending Deletions",approveDeletion:"Approve Deletion",rejectDeletion:"Reject Deletion",deletionMarkedBy:"Marked by",deletionApproved:"Deletion approved",deletionRejected:"Deletion rejected",cannotEditPendingDeletion:"Cannot edit fault pending deletion",voiceMode:"Voice Mode",voiceModeDesc:"Hands-free voice commands (requires internet)",voiceListening:"Listening...",voiceProcessing:"Processing...",voiceConfirming:"Confirm?",voiceOffline:"Voice unavailable offline",voiceNotSupported:"Voice not supported in this browser",voicePermissionDenied:"Microphone access denied",voiceOK:"OK",voiceRecorded:"Recorded",voiceNotUnderstood:"Not understood",voiceCancelled:"Cancelled",voiceError:"Voice error",voiceApiKeyRequired:"API key required for voice mode",pullToRefresh:"Pull to refresh",releaseToRefresh:"Release to refresh",synced:"Synced",syncingStatus:"Syncing...",gateAssignmentInstructions:"Enter the gate range you are responsible for:",readySuffix:" - Ready",viewPhotoLabel:"View photo",editEntryLabel:"Edit entry",deleteEntryLabel:"Delete entry",editFaultLabel:"Edit fault",deleteFaultLabel:"Delete fault",deleteLabel:"Delete",gateNumberLabel:"Gate",numberLabel:"Number",currentTime:"Current time",pinVerifyOnline:"PIN will be verified when online",addNote:"Add Note",done:"Done",recordNote:"Record Note",listening:"Listening...",noteSaved:"Note saved",noteDeleted:"Note deleted",noteCharCount:"characters",voiceNoteUnsupported:"Voice input not supported in this browser",voiceNoteError:"Voice input error",typeNote:"Type or speak your note...",hasNote:"Has note",noteTextLabel:"Note text",recordVoiceNoteLabel:"Record voice note",syncOnline:"Sync online",syncOffline:"Offline",sessionExpired:"Session expired. Please re-enter your PIN.",authSuccess:"Authentication successful",keyboardShortcuts:"Keyboard Shortcuts",keyboardShortcutsDesc:"Show all keyboard shortcuts",shortcutSection_timer:"Timer",shortcutSection_gateJudge:"Gate Judge",shortcutSection_results:"Results",shortcutSection_global:"Global",shortcut_enterDigit:"Enter bib digit",shortcut_selectStart:"Select Start",shortcut_selectFinish:"Select Finish",shortcut_selectRun1:"Select Run 1",shortcut_selectRun2:"Select Run 2",shortcut_recordTime:"Record timestamp",shortcut_clearBib:"Clear bib",shortcut_deleteLastDigit:"Delete last digit",shortcut_missedGate:"Missed Gate",shortcut_straddled:"Straddled",shortcut_broken:"Broken gate",shortcut_selectGate:"Select gate",shortcut_navigateBtns:"Navigate buttons",shortcut_confirmSelection:"Confirm selection",shortcut_navigateItems:"Navigate items",shortcut_editItem:"Edit item",shortcut_deleteItem:"Delete item",shortcut_moveTab:"Move between tabs",shortcut_closeModal:"Close modal",shortcut_navigateInComponent:"Navigate in component",shortcut_showShortcuts:"Show shortcuts",offlineBanner:"You are offline. Times will be saved locally.",onlineRestored:"Back online",entryDeleted:"Entry deleted",undoAction:"Undo",multiDeviceDuplicate:"Multi-device",duplicateDevices:"{count} devices",duplicateCount:"{count} duplicates"},de:{timer:"Timer",results:"Ergebnisse",settings:"Einstellungen",start:"Start",finish:"Ziel",startShort:"S",finishShort:"Z",bib:"Startnr.",point:"Punkt",run:"Lauf",run1:"L1",run2:"L2",time:"Zeit erfassen",lastRecorded:"Zuletzt erfasst",lastRecordedShort:"Letzter:",advancedSettings:"Erweiterte Einstellungen",status:"Status",noEntries:"Keine Einträge vorhanden",noEntriesHint:"Zeiten im Timer-Tab aufnehmen",search:"Startnr. suchen...",filter:"Filter",all:"Alle",total:"Gesamt",racers:"Fahrer",finished:"Im Ziel",fastest:"Schnellste",average:"Durchschnitt",timeEntry:"Zeit",timeEntries:"Zeiten",faultEntry:"Fehler",faultEntries:"Fehler",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Eintrag löschen",confirmDeleteText:"Möchten Sie diesen Eintrag wirklich löschen?",confirmDeleteFault:"Diesen Fehler löschen?",confirmClearAll:"Alle löschen",clearAllText:"Alle Einträge werden gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.",confirmUndoAdd:"Erfassung rückgängig",confirmUndoAddText:"Der erfasste Eintrag wird gelöscht. Fortfahren?",delete:"Löschen",cancel:"Abbrechen",close:"Schließen",back:"Zurück",save:"Speichern",saving:"Speichern...",edit:"Bearbeiten",undo:"Rückgängig",export:"Exportieren",clearAll:"Alle löschen",selectAll:"Alle auswählen",deleteSelected:"Ausgewählte löschen",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Von Cloud synchronisiert",raceId:"Rennen-ID",invalidRaceId:"Ungültige Rennen-ID. Nur Buchstaben, Zahlen, Bindestriche, Unterstriche.",deviceName:"Zeitnehmer-ID",cloudSync:"Cloud-Sync",syncStatus:"Sync-Status",pendingSync:"ausstehend",raceSetup:"Rennen einrichten",raceSetupDesc:"Erforderlich für Timing und Sync über mehrere Geräte.",firstGateLabel:"Erstes Tor",saved:"Gespeichert",deleted:"Gelöscht",cleared:"Alle Einträge gelöscht",undone:"Rückgängig gemacht",copied:"In Zwischenablage kopiert",debugInfoCopied:"Debug-Info in Zwischenablage kopiert",debugInfoCopyFailed:"Lange drücken um Debug-Info zu kopieren",duplicateWarning:"Doppelter Eintrag erkannt",zeroBibWarning:"Startnr. 000 - Eintrag prüfen",exported:"Erfolgreich exportiert",gps:"GPS",gpsActive:"GPS Aktiv",gpsSearching:"GPS wird gesucht...",gpsInactive:"GPS Inaktiv",gpsAccuracy:"Genauigkeit",settingsRaceSetup:"Rennen einrichten",settingsTimingGroup:"Zeitmessung",settingsSyncGroup:"Synchronisation",settingsFeedbackGroup:"Rückmeldung",settingsDisplayGroup:"Anzeige",simpleMode:"Einfacher Modus",fullMode:"Erweiterter Modus",autoIncrement:"Startnr. automatisch",hapticFeedback:"Vibration",soundFeedback:"Signalton",language:"Sprache",advancedSettingsHint:"Diese Optionen beeinflussen die Zeitmessung. Nur bei Bedarf ändern.",simpleModeDesc:"Vereinfachte Oberfläche für einfache Zeitmessung",cloudSyncDesc:"Mit anderen Geräten synchronisieren",gpsDesc:"GPS für genaue Zeitstempel verwenden",autoIncrementDesc:"Startnr. nach Erfassung erhöhen",photoCaptureDesc:"Foto bei Zeiterfassung aufnehmen",hapticFeedbackDesc:"Vibration bei Aktionen",soundFeedbackDesc:"Akustische Bestätigung",ambientMode:"Ruhemodus",ambientModeDesc:"Nach 30s Inaktivität abdunkeln",photoCapture:"Foto aufnehmen",photoCaptured:"Foto aufgenommen",photoError:"Foto-Aufnahme fehlgeschlagen",photoSaveFailed:"Foto-Speicherung fehlgeschlagen",viewPhoto:"Foto anzeigen",deletePhoto:"Foto löschen",photoFor:"Foto für Startnr.",noPhotoAvailable:"Kein Foto verfügbar",photoDeleted:"Foto gelöscht",raceChangeTitle:"Rennen wechseln",raceChangeSyncedText:"Es gibt Ergebnisse von einem anderen Rennen. Exportieren oder löschen?",raceChangeUnsyncedText:"Es gibt bestehende Ergebnisse. Behalten oder löschen?",keepResults:"Behalten",version:"Version",devices:"Geräte",entries:"Einträge",selected:"ausgewählt",raceFound:"Rennen gefunden",raceNew:"Neues Rennen",entryInCloud:"Eintrag in der Cloud",entriesInCloud:"Einträge in der Cloud",photoTooLarge:"Foto zu groß für Sync",syncedEntriesFromCloud:"{count} Einträge aus Cloud synchronisiert",syncedFaultsFromCloud:"{count} Torfehler aus Cloud synchronisiert",crossDeviceDuplicate:"Duplikat: Startnr. {bib} {point} bereits von {device} erfasst",syncPhotos:"Fotos synchronisieren",syncPhotosDesc:"Fotos über Cloud mit anderen Geräten teilen",syncPhotosWarning:"Foto-Sync aktivieren",syncPhotosWarningText:"Aktivierung der Foto-Synchronisierung überträgt folgende Daten:",photosToUpload:"Fotos hochzuladen",photosToDownload:"Fotos herunterzuladen",totalDataVolume:"Gesamtes Datenvolumen",enableSync:"Sync aktivieren",noPhotosToSync:"Keine Fotos zu synchronisieren",admin:"Admin",adminPin:"Rennverwaltungs-PIN",adminPinDesc:"Erforderlich für Verwaltung und Sync",manageRaces:"Rennen verwalten",manageRacesDesc:"Synchronisierte Rennen anzeigen und löschen",manage:"Verwalten",enterAdminPin:"Rennverwaltungs-PIN eingeben",enterPinText:"Geben Sie Ihre PIN ein, um die Rennverwaltung zu öffnen.",enterPinToJoinRace:"Geben Sie Ihre PIN ein, um diesem Rennen beizutreten.",enterPinForChiefJudge:"Geben Sie Ihre PIN ein, um die Obmann-Ansicht zu öffnen.",enterChiefJudgePin:"Obmann-PIN eingeben",enterPinForChiefJudgeInfo:"Der Obmann-Modus erfordert eine separate PIN. Erste Eingabe setzt die PIN.",syncRequiresPin:"Sync deaktiviert. Aktivieren Sie Sync und geben Sie die PIN ein.",incorrectPin:"Falsche PIN",verify:"Bestätigen",setPinFirst:"Bitte zuerst Rennverwaltungs-PIN festlegen",pinSaved:"PIN gespeichert",pinCleared:"PIN gelöscht",pinNotSet:"Nicht gesetzt",pinSet:"PIN gesetzt",setPin:"PIN setzen",changePin:"PIN ändern",currentPin:"Aktuelle PIN",newPin:"Neue PIN (4 Ziffern)",confirmPin:"PIN bestätigen",pinMismatch:"PINs stimmen nicht überein",pinFormatError:"PIN muss genau 4 Ziffern haben",loading:"Laden...",noRaces:"Keine aktiven Rennen",noRacesHint:"In Einstellungen erstellen",cleanRunHint:"Bisher fehlerfreie Fahrt",refresh:"Aktualisieren",raceDeleted:"Rennen gelöscht",raceDeletedText:"Dieses Rennen wurde von einem Administrator gelöscht.",raceDeletedFor:"Rennen gelöscht:",raceDeletedSuccess:"Rennen gelöscht:",confirmDeleteRace:"Rennen löschen",confirmDeleteRaceText:"Möchten Sie das Rennen wirklich löschen",loadError:"Fehler beim Laden der Rennen. Verbindung prüfen und erneut versuchen.",deleteError:"Fehler beim Löschen des Rennens",entry:"Eintrag",device:"Gerät",storageError:"Speichern fehlgeschlagen - Speicher prüfen",storageQuotaError:"Speicher voll! Daten sofort exportieren",storageWarning:"Speicher fast voll",storageNearlyFull:"Speicher fast voll. Daten exportieren und alte Einträge löschen.",networkError:"Netzwerkfehler - Verbindung prüfen",connectionFailed:"Verbindung fehlgeschlagen",serverUnavailable:"Server nicht erreichbar",rateLimitError:"Zu viele Anfragen - bitte warten",authError:"Authentifizierung fehlgeschlagen. PIN erneut eingeben.",syncFailed:"Synchronisierung fehlgeschlagen",pinSyncFailed:"PIN nicht in Cloud gespeichert",cameraError:"Kamerafehler",cameraPermissionDenied:"Kamerazugriff verweigert",gpsError:"GPS-Fehler",gpsPermissionDenied:"GPS-Zugriff verweigert",gpsUnavailable:"GPS nicht verfügbar",wakeLockFailed:"Bildschirm kann während Zeitmessung abdunkeln",wakeLockIdleTimeout:"Bildschirm wird gedimmt um Akku zu sparen. Tippen zum Wachhalten.",unknownError:"Unbekannter Fehler",onboardingWelcome:"Willkommen bei Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronisierte Zeitmessung für Skirennen",getStarted:"Los geht's",skipSetup:"Überspringen",onboardingRole:"Was ist deine Aufgabe?",onboardingRoleDesc:"Wähle aus, wie du beim Rennen hilfst",roleTimerTitle:"Zeitnehmer",roleTimerDesc:"Du erfasst Start- und Zielzeiten",roleJudgeTitle:"Torrichter",roleJudgeDesc:"Du erfasst Torfehler",onboardingDeviceName:"Timer benennen",onboardingDeviceNameDesc:"Dieser Name identifiziert dein Gerät beim Synchronisieren",onboardingDeviceNameJudge:"Dein Name",onboardingDeviceNameJudgeDesc:"Dies identifiziert dich als Torrichter",onboardingPhoto:"Foto-Dokumentation",onboardingPhotoDesc:"Automatisch ein Foto bei jeder Zeiterfassung aufnehmen. Nützlich zur Überprüfung von Startnr. und bei Unstimmigkeiten.",enablePhotoCapture:"Foto-Aufnahme aktivieren",photoCaptureLabel:"Foto-Aufnahme",onboardingGates:"Deine Tor-Zuweisung",onboardingGatesDesc:"Gib die Tornummern ein, die du beobachtest. Du kannst dies später ändern.",onboardingRaceSetup:"Rennen beitreten",onboardingRaceSetupDesc:"Gib eine Rennen-ID ein um mit anderen Timern zu synchronisieren",skipForNow:"Vorerst überspringen",onboardingReady:"Bereit zur Zeitmessung!",onboardingReadyJudge:"Bereit als Torrichter!",onboardingTip:"Tippe auf den großen blauen Button um Zeiten zu erfassen",onboardingTipJudge:"Tippe auf eine Startnr. um einen Fehler zu erfassen",startTiming:"Zeitmessung starten",startJudging:"Starten",continue:"Weiter",deviceNameLabel:"Gerätename",raceIdLabel:"Rennen-ID",syncStatusLabel:"Cloud-Sync",enabled:"Aktiviert",disabled:"Deaktiviert",showTutorial:"Tutorial anzeigen",showTutorialDesc:"Setup-Assistenten erneut starten",show:"Anzeigen",onboardingComplete:"Einrichtung abgeschlossen!",invalidPin:"PIN muss 4 Ziffern haben",recentRaces:"Letzte Rennen",noRecentRaces:"Keine Rennen von heute",errorOccurred:"Ein Fehler ist aufgetreten",errorRecoveryMessage:"Die App hat einen Fehler festgestellt. Sie können diesen Hinweis schließen und fortfahren, oder die App neu laden.",dismiss:"Schließen",reload:"Neu laden",updateAvailable:"Update verfügbar! Neu laden für die neueste Version.",operationFailed:"Vorgang fehlgeschlagen. Bitte erneut versuchen.",raceIdPlaceholder:"RENNEN-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Foto für Startnr.",gateJudge:"Torrichter",gateJudgeTab:"Tor",deviceRole:"Geräte-Rolle",deviceRoleDesc:"Timer erfasst Zeiten, Torrichter erfasst Fehler",roleTimer:"Zeitnehmer",roleGateJudge:"Torrichter",gateAssignment:"Tor-Zuweisung",noGateAssignment:"Keine Tor-Zuweisung. Bitte zuerst den Torbereich festlegen.",gates:"Tore",gatesFrom:"Von",gatesTo:"Bis",firstGateColor:"Farbe des ersten Tors",colorRed:"Rot",colorBlue:"Blau",changeGates:"Ändern",otherJudges:"Andere Torrichter:",activeBibs:"Auf der Strecke",noBibsOnCourse:"Keine Fahrer auf der Strecke",recordFault:"Fehler erfassen",faultType:"Fehlerart",faultMG:"Tor ausgelassen",faultSTR:"Einfädler",faultBR:"Bindung offen",faultMGShort:"TF",faultSTRShort:"EF",faultBRShort:"BO",orEnterManually:"oder eingeben:",faultRecorded:"Fehler erfasst",signalReady:"Bereit",judgeReady:"Bereit für Rennen!",judgeNotReady:"Bereit-Status zurückgesetzt",faultDeleted:"Fehler gelöscht",recordedFaults:"Erfasste Fehler",selectBib:"Startnr. wählen",selectGate:"Tor",gate:"Tor",noFaults:"Keine Fehler erfasst",faultsFor:"Fehler für",faultSummary:"Fehler-Übersicht",penaltyTime:"Strafzeit",faultCount:"Fehler",markOk:"OK markieren",saveFault:"Fehler speichern",selectFaultType:"Bitte Fehlerart wählen",gateOutOfRange:"Tor liegt außerhalb des zugewiesenen Bereichs",flt:"STR",statusFlt:"Strafzeit",chiefJudge:"Obmann",noFaultsRecorded:"Keine Fehler erfasst",finalize:"Bestätigen",finalized:"Bestätigt",chiefJudgeMode:"Obmann-Ansicht",chiefJudgeModeEnabled:"Obmann-Ansicht aktiviert",chiefJudgeModeDisabled:"Obmann-Ansicht deaktiviert",racersWithFaults:"Fahrer mit Fehlern",penaltyMode:"+Zeit",gateJudges:"Torrichter",noJudgesConnected:"Keine Torrichter verbunden",summary:"Übersicht",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"Keine Fehler zum Exportieren",copiedToClipboard:"In Zwischenablage kopiert",gateJudgeCard:"Torrichterkarte",race:"Rennen",date:"Datum",gateJudgeLabel:"Torrichter",runLabel:"Lauf",noFaultsEntered:"Keine Fehler erfasst",signature:"Unterschrift",legend:"Legende",missedGateLegend:"Ausgelassen",straddlingLegend:"Einfädler",bindingLegend:"Bindung",gateFaults:"Torfehler",penaltyLabel:"STRAFZEIT",faultSummaryTitle:"ZUSAMMENFASSUNG TORFEHLER",faults:"Fehler",penalty:"Strafzeit",sec:"Sek",generated:"Erstellt",editFault:"Fehler bearbeiten",versionHistory:"Versionshistorie",restoreVersion:"Version wiederherstellen",currentVersion:"Aktuell",originalVersion:"Original",restored:"Wiederhergestellt",versionRestored:"Version wiederhergestellt",markForDeletion:"Zum Löschen markieren",markForDeletionText:"Dieser Fehler wird zum Löschen markiert und benötigt die Genehmigung des Obmanns für die endgültige Löschung.",markedForDeletion:"Zum Löschen markiert",deletionPending:"Löschung ausstehend",pendingDeletions:"Ausstehende Löschungen",approveDeletion:"Löschung genehmigen",rejectDeletion:"Löschung ablehnen",deletionMarkedBy:"Markiert von",deletionApproved:"Löschung genehmigt",deletionRejected:"Löschung abgelehnt",cannotEditPendingDeletion:"Fehler mit ausstehender Löschung kann nicht bearbeitet werden",voiceMode:"Sprachsteuerung",voiceModeDesc:"Freihändige Sprachbefehle (Internet erforderlich)",voiceListening:"Höre zu...",voiceProcessing:"Verarbeite...",voiceConfirming:"Bestätigen?",voiceOffline:"Sprache offline nicht verfügbar",voiceNotSupported:"Spracheingabe in diesem Browser nicht unterstützt",voicePermissionDenied:"Mikrofonzugriff verweigert",voiceOK:"OK",voiceRecorded:"Erfasst",voiceNotUnderstood:"Nicht verstanden",voiceCancelled:"Abgebrochen",voiceError:"Sprachfehler",voiceApiKeyRequired:"API-Schlüssel für Sprachsteuerung erforderlich",pullToRefresh:"Zum Aktualisieren ziehen",releaseToRefresh:"Loslassen zum Aktualisieren",synced:"Synchronisiert",syncingStatus:"Synchronisiere...",gateAssignmentInstructions:"Gib den Torbereich ein, für den du verantwortlich bist:",readySuffix:" - Bereit",viewPhotoLabel:"Foto anzeigen",editEntryLabel:"Eintrag bearbeiten",deleteEntryLabel:"Eintrag löschen",editFaultLabel:"Fehler bearbeiten",deleteFaultLabel:"Fehler löschen",deleteLabel:"Löschen",gateNumberLabel:"Tor",numberLabel:"Zahl",currentTime:"Aktuelle Uhrzeit",pinVerifyOnline:"PIN wird online überprüft",addNote:"Notiz hinzufügen",done:"Fertig",recordNote:"Notiz aufnehmen",listening:"Höre zu...",noteSaved:"Notiz gespeichert",noteDeleted:"Notiz gelöscht",noteCharCount:"Zeichen",voiceNoteUnsupported:"Spracheingabe in diesem Browser nicht unterstützt",voiceNoteError:"Spracheingabe-Fehler",typeNote:"Notiz eintippen oder sprechen...",hasNote:"Hat Notiz",noteTextLabel:"Notiztext",recordVoiceNoteLabel:"Sprachnotiz aufnehmen",syncOnline:"Sync online",syncOffline:"Offline",sessionExpired:"Sitzung abgelaufen. Bitte PIN erneut eingeben.",authSuccess:"Authentifizierung erfolgreich",keyboardShortcuts:"Tastenkürzel",keyboardShortcutsDesc:"Alle Tastenkürzel anzeigen",shortcutSection_timer:"Timer",shortcutSection_gateJudge:"Torrichter",shortcutSection_results:"Ergebnisse",shortcutSection_global:"Allgemein",shortcut_enterDigit:"Startnr.-Ziffer eingeben",shortcut_selectStart:"Start wählen",shortcut_selectFinish:"Ziel wählen",shortcut_selectRun1:"Lauf 1 wählen",shortcut_selectRun2:"Lauf 2 wählen",shortcut_recordTime:"Zeitstempel erfassen",shortcut_clearBib:"Startnr. löschen",shortcut_deleteLastDigit:"Letzte Ziffer löschen",shortcut_missedGate:"Tor ausgelassen",shortcut_straddled:"Einfädler",shortcut_broken:"Bindung offen",shortcut_selectGate:"Tor wählen",shortcut_navigateBtns:"Buttons navigieren",shortcut_confirmSelection:"Auswahl bestätigen",shortcut_navigateItems:"Einträge navigieren",shortcut_editItem:"Eintrag bearbeiten",shortcut_deleteItem:"Eintrag löschen",shortcut_moveTab:"Zwischen Tabs wechseln",shortcut_closeModal:"Dialog schließen",shortcut_navigateInComponent:"In Komponente navigieren",shortcut_showShortcuts:"Tastenkürzel anzeigen",offlineBanner:"Offline. Zeiten werden lokal gespeichert.",onlineRestored:"Wieder online",entryDeleted:"Eintrag gelöscht",undoAction:"Rückgängig",multiDeviceDuplicate:"Mehrere Geräte",duplicateDevices:"{count} Geräte",duplicateCount:"{count} Duplikate"}};function u(n,e="de"){const t=yi[e],i=yi.en;return t[n]||i[n]||n}const y={debug:()=>{},log:()=>{},info:()=>{},warn:console.warn.bind(console),error:console.error.bind(console)},sa=.2,aa=.1;class ra{constructor(){h(this,"battery",null);h(this,"isInitialized",!1);h(this,"callbacks",new Set);h(this,"currentStatus",{level:1,charging:!0,batteryLevel:"normal"});h(this,"levelChangeHandler",null);h(this,"chargingChangeHandler",null)}isSupported(){return"getBattery"in navigator}async initialize(){if(this.isInitialized)return!0;if(!this.isSupported())return!1;try{return this.battery=await navigator.getBattery(),this.isInitialized=!0,this.updateStatus(),this.levelChangeHandler=()=>this.updateStatus(),this.chargingChangeHandler=()=>this.updateStatus(),this.battery.addEventListener("levelchange",this.levelChangeHandler),this.battery.addEventListener("chargingchange",this.chargingChangeHandler),!0}catch(e){return y.warn("Failed to initialize battery service:",e),!1}}updateStatus(){if(!this.battery)return;const e=this.battery.level,t=this.battery.charging;let i="normal";t||(e<=aa?i="critical":e<=sa&&(i="low"));const s={level:e,charging:t,batteryLevel:i},a=this.currentStatus.level!==s.level||this.currentStatus.charging!==s.charging||this.currentStatus.batteryLevel!==s.batteryLevel;this.currentStatus=s,a&&this.notifySubscribers()}notifySubscribers(){for(const e of this.callbacks)try{e(this.currentStatus)}catch(t){y.error("Battery callback error:",t)}}subscribe(e){return this.callbacks.add(e),e(this.currentStatus),()=>{this.callbacks.delete(e)}}getStatus(){return{...this.currentStatus}}isLowBattery(){return this.currentStatus.batteryLevel==="low"||this.currentStatus.batteryLevel==="critical"}isCriticalBattery(){return this.currentStatus.batteryLevel==="critical"}isCharging(){return this.currentStatus.charging}getLevelPercent(){return Math.round(this.currentStatus.level*100)}cleanup(){this.battery&&(this.levelChangeHandler&&(this.battery.removeEventListener("levelchange",this.levelChangeHandler),this.levelChangeHandler=null),this.chargingChangeHandler&&(this.battery.removeEventListener("chargingchange",this.chargingChangeHandler),this.chargingChangeHandler=null),this.battery=null),this.callbacks.clear(),this.isInitialized=!1}}const Z=new ra;class oa{constructor(){h(this,"isInitialized",!1);h(this,"isEnabled",!1);h(this,"isAmbientActive",!1);h(this,"triggeredBy",null);h(this,"lastActivityTimestamp",Date.now());h(this,"inactivityCheckId",null);h(this,"batteryUnsubscribe",null);h(this,"callbacks",new Set);h(this,"activityHandler",null);h(this,"INACTIVITY_THRESHOLD_MS",3e4)}initialize(){this.isInitialized||(this.isInitialized=!0,this.batteryUnsubscribe=Z.subscribe(e=>{e.batteryLevel==="critical"&&!e.charging&&this.isEnabled&&this.enterAmbientMode("battery"),e.charging&&this.isAmbientActive&&this.triggeredBy==="battery"&&this.exitAmbientMode()}),this.activityHandler=()=>this.resetInactivityTimer(),document.addEventListener("touchstart",this.activityHandler,{passive:!0}),document.addEventListener("click",this.activityHandler,{passive:!0}),document.addEventListener("keydown",this.activityHandler,{passive:!0}))}cleanup(){this.disable(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.activityHandler&&(document.removeEventListener("touchstart",this.activityHandler),document.removeEventListener("click",this.activityHandler),document.removeEventListener("keydown",this.activityHandler),this.activityHandler=null),this.callbacks.clear(),this.isInitialized=!1}enable(){this.isEnabled||(this.isEnabled=!0,this.lastActivityTimestamp=Date.now(),this.startInactivityMonitor(),Z.isCriticalBattery()&&this.enterAmbientMode("battery"))}disable(){this.isEnabled&&(this.isEnabled=!1,this.stopInactivityMonitor(),this.isAmbientActive&&this.exitAmbientMode())}isActive(){return this.isAmbientActive}getState(){return{isActive:this.isAmbientActive,triggeredBy:this.triggeredBy}}subscribe(e){return this.callbacks.add(e),e(this.getState()),()=>{this.callbacks.delete(e)}}exitAmbientMode(){this.isAmbientActive&&(this.isAmbientActive=!1,this.triggeredBy=null,this.lastActivityTimestamp=Date.now(),this.notifySubscribers(),y.debug("[Ambient] Exited ambient mode"))}resetInactivityTimer(){this.lastActivityTimestamp=Date.now(),this.isAmbientActive}enterAmbientMode(e){this.isAmbientActive||!this.isEnabled||(this.isAmbientActive=!0,this.triggeredBy=e,this.notifySubscribers(),y.debug(`[Ambient] Entered ambient mode (trigger: ${e})`))}startInactivityMonitor(){this.inactivityCheckId===null&&(this.inactivityCheckId=setInterval(()=>{if(!this.isEnabled)return;Date.now()-this.lastActivityTimestamp>=this.INACTIVITY_THRESHOLD_MS&&!this.isAmbientActive&&this.enterAmbientMode("inactivity")},5e3))}stopInactivityMonitor(){this.inactivityCheckId!==null&&(clearInterval(this.inactivityCheckId),this.inactivityCheckId=null)}notifySubscribers(){const e=this.getState();for(const t of this.callbacks)try{t(e)}catch(i){y.error("[Ambient] Callback error:",i)}}}const Y=new oa,Vt=2;function ca(n){const e=new Uint8Array(Math.ceil(n/2));return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("").slice(0,n)}function la(n){var i;const e=Date.now(),t=((i=crypto.randomUUID)==null?void 0:i.call(crypto).slice(0,8))??ca(8);return`${n}-${e}-${t}`}const Ht=["swift","bold","cool","fast","keen","wild","calm","warm","bright","sharp","quick","brave","fresh","grand","prime","clear","snow","ice","frost","peak","alpine","polar","winter","crisp"],_t=["fox","bear","wolf","hawk","eagle","tiger","lion","deer","pine","oak","cedar","birch","maple","spruce","aspen","willow","peak","ridge","slope","trail","summit","valley","glacier","cliff"];function bi(n){return n.charAt(0).toUpperCase()+n.slice(1)}function da(){const n=Ht[Math.floor(Math.random()*Ht.length)],e=_t[Math.floor(Math.random()*_t.length)],t=Math.floor(Math.random()*100);return`dev_${n}-${e}-${t}`}function zt(){const n=Ht[Math.floor(Math.random()*Ht.length)],e=_t[Math.floor(Math.random()*_t.length)],t=Math.floor(Math.random()*100);return`${bi(n)} ${bi(e)} ${t}`}const ua=["S","F"],fa=["ok","dns","dnf","dsq","flt"],ns=["MG","STR","BR"];function is(n){return typeof n=="number"&&Number.isInteger(n)&&n>=1}const ga=["create","edit","restore"];function Ye(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"&&typeof e.id!="number"||typeof e.id=="string"&&e.id.length===0||typeof e.id=="number"&&e.id<=0||e.bib!==void 0&&typeof e.bib!="string"||typeof e.bib=="string"&&e.bib.length>10||!ua.includes(e.point)||!e.timestamp||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||e.status!==void 0&&!fa.includes(e.status)||e.deviceId!==void 0&&typeof e.deviceId!="string"||e.deviceName!==void 0&&typeof e.deviceName!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||e.syncedAt<0||!Number.isFinite(e.syncedAt))||e.photo!==void 0&&typeof e.photo!="string"||e.timeSource!==void 0&&e.timeSource!=="gps"&&e.timeSource!=="system"||e.gpsTimestamp!==void 0&&(typeof e.gpsTimestamp!="number"||!Number.isFinite(e.gpsTimestamp)))return!1;if(e.gpsCoords!==void 0){if(typeof e.gpsCoords!="object"||e.gpsCoords===null)return!1;const t=e.gpsCoords;if(typeof t.latitude!="number"||!Number.isFinite(t.latitude)||typeof t.longitude!="number"||!Number.isFinite(t.longitude)||typeof t.accuracy!="number"||!Number.isFinite(t.accuracy)||t.accuracy<0)return!1}return!0}function ha(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.version!="number"||!Number.isInteger(e.version)||e.version<1||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||typeof e.editedBy!="string"||e.editedBy.length>100||typeof e.editedByDeviceId!="string"||e.editedByDeviceId.length>100||!ga.includes(e.changeType)||!e.data||typeof e.data!="object")return!1;const t=e.data;return!(typeof t.id!="string"||typeof t.bib!="string"||t.bib.length>10||!is(t.run)||typeof t.gateNumber!="number"||!Number.isInteger(t.gateNumber)||t.gateNumber<0||!ns.includes(t.faultType)||typeof t.timestamp!="string"||Number.isNaN(Date.parse(t.timestamp))||typeof t.deviceId!="string"||typeof t.deviceName!="string"||t.deviceName.length>100||!Array.isArray(t.gateRange)||t.gateRange.length!==2||typeof t.gateRange[0]!="number"||typeof t.gateRange[1]!="number"||!Number.isInteger(t.gateRange[0])||!Number.isInteger(t.gateRange[1])||e.changeDescription!==void 0&&typeof e.changeDescription!="string"||typeof e.changeDescription=="string"&&e.changeDescription.length>500)}function ma(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"||e.id.length===0||typeof e.bib!="string"||e.bib.length>10||typeof e.deviceId!="string"||typeof e.deviceName!="string"||e.deviceName.length>100||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||!is(e.run)||typeof e.gateNumber!="number"||!Number.isInteger(e.gateNumber)||e.gateNumber<0||!ns.includes(e.faultType)||!Array.isArray(e.gateRange)||e.gateRange.length!==2||typeof e.gateRange[0]!="number"||typeof e.gateRange[1]!="number"||!Number.isInteger(e.gateRange[0])||!Number.isInteger(e.gateRange[1])||typeof e.currentVersion!="number"||!Number.isInteger(e.currentVersion)||e.currentVersion<1||!Array.isArray(e.versionHistory))return!1;for(const t of e.versionHistory)if(!ha(t))return!1;return!(typeof e.markedForDeletion!="boolean"||e.markedForDeletionAt!==void 0&&(typeof e.markedForDeletionAt!="string"||Number.isNaN(Date.parse(e.markedForDeletionAt)))||e.deletionApprovedAt!==void 0&&(typeof e.deletionApprovedAt!="string"||Number.isNaN(Date.parse(e.deletionApprovedAt)))||e.markedForDeletionBy!==void 0&&typeof e.markedForDeletionBy!="string"||e.markedForDeletionByDeviceId!==void 0&&typeof e.markedForDeletionByDeviceId!="string"||e.deletionApprovedBy!==void 0&&typeof e.deletionApprovedBy!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||!Number.isFinite(e.syncedAt)))}function pa(n){if(!ma(n))return null;const e=n,t=e.versionHistory.map(i=>({...i,editedBy:J(i.editedBy,100),editedByDeviceId:J(i.editedByDeviceId,100),changeDescription:i.changeDescription?J(i.changeDescription,500):void 0,data:{...i.data,bib:J(i.data.bib,10),deviceId:J(i.data.deviceId,100),deviceName:J(i.data.deviceName,100)}}));return{...e,bib:J(e.bib,10),deviceId:J(e.deviceId,100),deviceName:J(e.deviceName,100),markedForDeletionBy:e.markedForDeletionBy?J(e.markedForDeletionBy,100):void 0,markedForDeletionByDeviceId:e.markedForDeletionByDeviceId?J(e.markedForDeletionByDeviceId,100):void 0,deletionApprovedBy:e.deletionApprovedBy?J(e.deletionApprovedBy,100):void 0,versionHistory:t}}function ya(n){if(!n||typeof n!="object")return!1;const e=n;return!(!Ye(e.entry)||typeof e.retryCount!="number"||e.retryCount<0||typeof e.lastAttempt!="number"||e.lastAttempt<0)}function ss(n){return!n||typeof n!="string"||n.length>50?!1:/^[a-zA-Z0-9_-]+$/.test(n)}function ba(n){return!n||typeof n!="string"?!1:n.startsWith("dev_")&&n.length>4}function J(n,e=100){return!n||typeof n!="string"?"":n.slice(0,e).replace(/[<>"'&]/g,"").replace(/[\x00-\x1F\x7F]/g,"")}function va(n,e){if(!Ye(n))return null;const t=n;return{id:(typeof t.id=="number",String(t.id)),bib:J(t.bib,10),point:t.point,run:t.run??1,timestamp:t.timestamp,status:t.status||"ok",deviceId:J(t.deviceId||e,50),deviceName:J(t.deviceName||"Unknown Device",100),syncedAt:t.syncedAt,photo:t.photo,gpsCoords:t.gpsCoords}}function Sa(n,e){const t={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};if(!n||typeof n!="object")return{version:Vt,entries:[],settings:t,deviceId:e,deviceName:zt(),raceId:"",syncQueue:[]};const i=n;let s=[];Array.isArray(i.entries)&&(s=i.entries.map(o=>va(o,e)).filter(o=>o!==null));let a=t;if(i.settings&&typeof i.settings=="object"){const o=i.settings;a={auto:typeof o.auto=="boolean"?o.auto:t.auto,haptic:typeof o.haptic=="boolean"?o.haptic:t.haptic,sound:typeof o.sound=="boolean"?o.sound:t.sound,sync:typeof o.sync=="boolean"?o.sync:t.sync,syncPhotos:typeof o.syncPhotos=="boolean"?o.syncPhotos:t.syncPhotos,gps:typeof o.gps=="boolean"?o.gps:t.gps,simple:typeof o.simple=="boolean"?o.simple:t.simple,photoCapture:typeof o.photoCapture=="boolean"?o.photoCapture:t.photoCapture,motionEffects:typeof o.motionEffects=="boolean"?o.motionEffects:t.motionEffects,glassEffects:typeof o.glassEffects=="boolean"?o.glassEffects:t.glassEffects,outdoorMode:typeof o.outdoorMode=="boolean"?o.outdoorMode:t.outdoorMode,ambientMode:typeof o.ambientMode=="boolean"?o.ambientMode:t.ambientMode}}let r=[];return Array.isArray(i.syncQueue)&&(r=i.syncQueue.filter(ya)),{version:Vt,entries:s,settings:a,deviceId:ba(i.deviceId)?i.deviceId:e,deviceName:J(i.deviceName,100)||zt(),raceId:ss(i.raceId)?i.raceId:"",syncQueue:r,lastExport:typeof i.lastExport=="number"?i.lastExport:void 0}}function tn(n,e){n.addEventListener("input",()=>{n.value=n.value.replace(/[^0-9]/g,""),e!==void 0&&(n.value=n.value.slice(0,e))})}const vi=5*1024*1024,Ea=80;function wa(){let n=0;try{for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);if(t){const i=localStorage.getItem(t);n+=(t.length+((i==null?void 0:i.length)??0))*2}}}catch{}return n}function as(){const n=wa(),e=Math.round(n/vi*100),t=e>=Ea;return{usageBytes:n,estimatedQuota:vi,usagePercent:e,warning:t}}function Ia(){const{usageBytes:n,usagePercent:e}=as(),t=(n/1024).toFixed(1);y.debug(`[Storage] localStorage usage: ${t} KB (${e}% of ~5MB)`)}const ka=50;function Ca(n,e,t,i){const s=[...n,e],a=ft(t,{type:"ADD_ENTRY",data:e,timestamp:Date.now()});return{entries:s,undoStack:a,redoStack:[]}}function Ta(n,e,t,i){const s=n.find(r=>r.id===e);if(!s)return null;const a=ft(t,{type:"DELETE_ENTRY",data:s,timestamp:Date.now()});return{entries:n.filter(r=>r.id!==e),undoStack:a,redoStack:[]}}function La(n,e,t,i){const s=n.filter(r=>e.includes(r.id));if(s.length===0)return null;const a=ft(t,{type:"DELETE_MULTIPLE",data:s,timestamp:Date.now()});return{entries:n.filter(r=>!e.includes(r.id)),undoStack:a,redoStack:[]}}function Aa(n,e,t){if(n.length===0)return null;const i=ft(e,{type:"CLEAR_ALL",data:[...n],timestamp:Date.now()});return{entries:[],undoStack:i,redoStack:[]}}function Ra(n,e,t,i,s){const a=n.findIndex(d=>d.id===e);if(a===-1)return null;const r=n[a],o={...r,...t},l=ft(i,{type:"UPDATE_ENTRY",data:r,newData:o,timestamp:Date.now()}),f=[...n];return f[a]=o,{entries:f,undoStack:l,redoStack:[]}}function ft(n,e){const t=[...n,e];return t.length>ka&&t.shift(),t}function Da(n,e,t){if(e.length===0)return{entries:n,undoStack:e,redoStack:t,result:null};const i=[...e],s=i.pop(),a=[...t,s];let r=[...n],o=null;switch(s.type){case"ADD_ENTRY":{const l=s.data;r=r.filter(f=>f.id!==l.id),o=l;break}case"DELETE_ENTRY":{const l=s.data;r.push(l),r.sort((f,d)=>new Date(f.timestamp).getTime()-new Date(d.timestamp).getTime()),o=l;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const l=s.data;r=[...r,...l],r.sort((f,d)=>new Date(f.timestamp).getTime()-new Date(d.timestamp).getTime()),o=l;break}case"UPDATE_ENTRY":{const l=s.data,f=r.findIndex(d=>d.id===l.id);f!==-1&&(r[f]=l),o=l;break}}return{entries:r,undoStack:i,redoStack:a,result:o?{type:s.type,data:o}:null}}function xa(n,e,t){if(t.length===0)return{entries:n,undoStack:e,redoStack:t,result:null};const i=[...t],s=i.pop(),a=[...e,s];let r=[...n],o=null;switch(s.type){case"ADD_ENTRY":{const l=s.data;r.push(l),r.sort((f,d)=>new Date(f.timestamp).getTime()-new Date(d.timestamp).getTime()),o=l;break}case"DELETE_ENTRY":{const l=s.data;r=r.filter(f=>f.id!==l.id),o=l;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const l=s.data,f=new Set(l.map(d=>d.id));r=r.filter(d=>!f.has(d.id)),o=l;break}case"UPDATE_ENTRY":{const l=s.data,f=s.newData,d=r.findIndex(g=>g.id===l.id);d!==-1&&f&&(r[d]=f),o=f||l;break}}return{entries:r,undoStack:a,redoStack:i,result:o}}function Ba(n,e){const t={entry:e,retryCount:0,lastAttempt:0};return[...n,t]}function Pa(n,e){return n.filter(t=>t.entry.id!==e)}function Na(n,e,t){return n.map(i=>i.entry.id===e?{...i,...t}:i)}function Fa(n,e,t,i){let s=0;const a=new Set(n.map(l=>`${l.id}-${l.deviceId}`)),r=new Set(t),o=[];for(const l of e){if(!Ye(l)||l.deviceId===i)continue;const f=`${l.id}:${l.deviceId}`;if(r.has(f)||r.has(l.id))continue;const d=`${l.id}-${l.deviceId}`;a.has(d)||(o.push({...l,run:l.run??1}),a.add(d),s++)}if(o.length>0){const l=[...n,...o];return l.sort((f,d)=>new Date(f.timestamp).getTime()-new Date(d.timestamp).getTime()),{entries:l,addedCount:s}}return{entries:n,addedCount:s}}function $a(n,e){const t=new Set(e);let i=0;return{entries:n.filter(a=>{const r=`${a.id}:${a.deviceId}`;return t.has(r)||t.has(a.id)?(i++,!1):!0}),removedCount:i}}const Si=50;function Jn(n){return{id:n.id,bib:n.bib,run:n.run,gateNumber:n.gateNumber,faultType:n.faultType,timestamp:n.timestamp,deviceId:n.deviceId,deviceName:n.deviceName,gateRange:n.gateRange,syncedAt:n.syncedAt,notes:n.notes,notesSource:n.notesSource,notesTimestamp:n.notesTimestamp}}function nn(n,e,t,i,s,a){return{version:n,timestamp:new Date().toISOString(),editedBy:i,editedByDeviceId:s,changeType:e,data:t,changeDescription:a}}function jn(n,e){const t=[...n||[],e];return t.length>Si?t.slice(-Si):t}function Ma(n,e){const t=nn(1,"create",Jn(e),e.deviceName,e.deviceId),i={...e,currentVersion:1,versionHistory:[t],markedForDeletion:!1};return[...n,i]}function Oa(n,e){return n.filter(t=>t.id!==e)}function Va(n,e,t){const i=n.findIndex(a=>a.id===e);if(i===-1)return null;const s=[...n];return s[i]={...s[i],...t},s}function Ha(n,e,t,i,s,a){const r=n.findIndex(m=>m.id===e);if(r===-1)return null;const o=n[r];if(o.markedForDeletion)return null;const l=o.currentVersion+1,f={...o,...t},d=nn(l,"edit",Jn(f),i,s,a),g=[...n];return g[r]={...f,currentVersion:l,versionHistory:jn(o.versionHistory,d)},g}function _a(n,e,t,i,s){var g;const a=n.findIndex(m=>m.id===e);if(a===-1)return null;const r=n[a];if(r.markedForDeletion)return null;const o=(g=r.versionHistory)==null?void 0:g.find(m=>m.version===t);if(!o)return null;const l=r.currentVersion+1,f=nn(l,"restore",{...o.data},i,s,`Restored to version ${t}`),d=[...n];return d[a]={...r,bib:o.data.bib,run:o.data.run,gateNumber:o.data.gateNumber,faultType:o.data.faultType,notes:o.data.notes,notesSource:o.data.notesSource,notesTimestamp:o.data.notesTimestamp,currentVersion:l,versionHistory:jn(r.versionHistory,f)},d}function za(n,e,t,i){const s=n.findIndex(r=>r.id===e);if(s===-1)return null;const a=[...n];return a[s]={...a[s],markedForDeletion:!0,markedForDeletionAt:new Date().toISOString(),markedForDeletionBy:t,markedForDeletionByDeviceId:i},a}function Ua(n,e,t){const i=n.find(a=>a.id===e);if(!i||!i.markedForDeletion)return{faultEntries:n,approvedFault:null};const s={...i,deletionApprovedAt:new Date().toISOString(),deletionApprovedBy:t};return{faultEntries:n.filter(a=>a.id!==e),approvedFault:s}}function qa(n,e,t,i){const s=n.findIndex(f=>f.id===e);if(s===-1)return null;const a=n[s],r=a.currentVersion+1,o=nn(r,"edit",Jn(a),t,i,"Deletion rejected by Chief Judge"),l=[...n];return l[s]={...l[s],markedForDeletion:!1,markedForDeletionAt:void 0,markedForDeletionBy:void 0,markedForDeletionByDeviceId:void 0,currentVersion:r,versionHistory:jn(a.versionHistory,o)},l}function Ga(n){return n.filter(e=>e.markedForDeletion)}function Ja(n,e,t){return n.filter(i=>i.bib===e&&i.run===t)}function ja(n,e){const t=n.findIndex(s=>s.id===e);if(t===-1)return n;const i=[...n];return i[t]={...i[t],syncedAt:Date.now()},i}function Qa(n,e,t,i){let s=0,a=0;const r=new Map(n.map(d=>[`${d.id}-${d.deviceId}`,d])),o=new Set(t),l=[],f=[];for(const d of e){const g=pa(d);if(!g){y.warn("Skipping invalid fault from cloud:",d);continue}if(g.deviceId===i)continue;const m=`${g.id}:${g.deviceId}`;if(o.has(m)||o.has(g.id))continue;const p=`${g.id}-${g.deviceId}`,b=r.get(p);if(b){const w=g.currentVersion||1,S=b.currentVersion||1;(w>S||g.markedForDeletion!==b.markedForDeletion)&&(f.push(g),a++)}else l.push(g),s++}if(l.length>0||f.length>0){let d=[...n];for(const g of f){const m=`${g.id}-${g.deviceId}`,p=d.findIndex(b=>`${b.id}-${b.deviceId}`===m);p!==-1&&(d[p]=g)}return d=[...d,...l],d.sort((g,m)=>new Date(g.timestamp).getTime()-new Date(m.timestamp).getTime()),{faultEntries:d,addedCount:s+a}}return{faultEntries:n,addedCount:0}}function Wa(n,e){const t=new Set(e);let i=0;return{faultEntries:n.filter(a=>{const r=`${a.id}:${a.deviceId}`;return t.has(r)||t.has(a.id)?(i++,!1):!0}),removedCount:i}}function Ya(n){return{deviceRole:n}}function Ka(n){return{gateAssignment:n}}function Za(n){return{firstGateColor:n}}function Xa(n,e,t){if(!e)return t;const[i]=e;return(n-i)%2===0?t:t==="red"?"blue":"red"}function er(n){return{selectedFaultBib:n}}function tr(n){return{isJudgeReady:n}}function nr(n){return{isJudgeReady:!n}}function ir(n){return{isChiefJudgeView:n}}function sr(n){return{isChiefJudgeView:!n}}function ar(n,e,t){const i=`${n}-${e}`,s=new Set(t);return s.add(i),{finalizedRacers:s}}function rr(n,e,t){const i=`${n}-${e}`,s=new Set(t);return s.delete(i),{finalizedRacers:s}}function or(n,e,t){const i=`${n}-${e}`;return t.has(i)}function cr(){return{finalizedRacers:new Set}}function lr(n){return{penaltySeconds:Math.max(0,Math.min(60,n))}}function dr(n){return{usePenaltyMode:n}}function ur(n,e){const t=n.filter(r=>r.point==="S"&&r.run===e),i=n.filter(r=>r.point==="F"&&r.run===e),s=new Set(i.map(r=>r.bib)),a=new Set(t.filter(r=>!s.has(r.bib)).map(r=>r.bib));return Array.from(a).sort((r,o)=>parseInt(r,10)-parseInt(o,10))}const Ei={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};function fr(n,e){return{...n,...e}}function gr(n,e){return{...n,[e]:!n[e]}}function hr(n){return{syncStatus:n}}function mr(n,e){return{raceId:n,clearUndoRedo:n!==e}}function pr(n){return{lastSyncedRaceId:n}}function yr(n){return{deviceName:n}}const br=12e4;function vr(n,e){const t=Date.now(),i=new Map;for(const[s,a]of e)t-a.lastSeen<br&&i.set(s,a);return i.set(n.id,n),{connectedDevices:i}}function Sr(n,e){const t=new Map(e);return t.delete(n),{connectedDevices:t}}function Er(n){return{cloudDeviceCount:n}}function wr(n){return{cloudHighestBib:n}}function Ir(n){return{raceExistsInCloud:n}}function kr(n){return{currentView:n}}function Cr(n){return{currentLang:n}}function Tr(n){return{bibInput:n.replace(/\D/g,"").slice(0,3)}}function Lr(n){return{selectedPoint:n}}function Ar(n){return{selectedRun:n}}function Rr(n,e){return{selectMode:n,selectedEntries:n?e:new Set}}function Dr(n,e){const t=new Set(e);return t.has(n)?t.delete(n):t.add(n),{selectedEntries:t,selectMode:t.size>0}}function xr(n){return{selectedEntries:new Set(n),selectMode:!0}}function Br(){return{selectedEntries:new Set,selectMode:!1}}function Pr(n){return{isRecording:n}}const $={ENTRIES:"skiTimerEntries",SETTINGS:"skiTimerSettings",LANG:"skiTimerLang",DEVICE_ID:"skiTimerDeviceId",DEVICE_NAME:"skiTimerDeviceName",RACE_ID:"skiTimerRaceId",LAST_SYNCED_RACE_ID:"skiTimerLastSyncedRaceId",SYNC_QUEUE:"skiTimerSyncQueue",SCHEMA_VERSION:"skiTimerSchemaVersion",DEVICE_ROLE:"skiTimerDeviceRole",GATE_ASSIGNMENT:"skiTimerGateAssignment",FIRST_GATE_COLOR:"skiTimerFirstGateColor",FAULT_ENTRIES:"skiTimerFaultEntries"},hn=100,Nr=["entries","settings","currentLang","deviceName","raceId","lastSyncedRaceId","syncQueue","deviceRole","gateAssignment","firstGateColor","faultEntries"];class Fr{constructor(){h(this,"state");h(this,"listeners",new Set);h(this,"saveTimeout",null);h(this,"dirtySlices",new Set);h(this,"isNotifying",!1);h(this,"pendingNotifications",[]);h(this,"listenerErrorCallback",null);h(this,"failedListenerCount",0);this.state=this.loadInitialState()}loadInitialState(){let e=localStorage.getItem($.DEVICE_ID);e||(e=da(),localStorage.setItem($.DEVICE_ID,e));const t=localStorage.getItem($.ENTRIES),i=localStorage.getItem($.SETTINGS),s=localStorage.getItem($.SYNC_QUEUE);let a=[],r=Ei,o=[];try{if(t){const S=JSON.parse(t);Array.isArray(S)&&(a=S.filter(E=>Ye(E)).map(E=>({...E,run:E.run??1})))}}catch(S){y.error("Failed to parse entries:",S)}try{if(i){const S=JSON.parse(i);r={...Ei,...S}}}catch(S){y.error("Failed to parse settings:",S)}try{if(s){const S=JSON.parse(s);Array.isArray(S)&&(o=S)}}catch(S){y.error("Failed to parse sync queue:",S)}const l=localStorage.getItem($.LANG)||"de";let f=localStorage.getItem($.DEVICE_NAME);f||(f=zt(),localStorage.setItem($.DEVICE_NAME,f));const d=localStorage.getItem($.RACE_ID)||"",g=localStorage.getItem($.LAST_SYNCED_RACE_ID)||"",m=localStorage.getItem($.DEVICE_ROLE)||"timer";let p=null,b="red",w=[];try{const S=localStorage.getItem($.GATE_ASSIGNMENT);if(S){const C=JSON.parse(S);Array.isArray(C)&&C.length===2&&(p=C)}const E=localStorage.getItem($.FIRST_GATE_COLOR);(E==="red"||E==="blue")&&(b=E)}catch(S){y.error("Failed to parse gate assignment:",S)}try{const S=localStorage.getItem($.FAULT_ENTRIES);if(S){const E=JSON.parse(S);Array.isArray(E)&&(w=E)}}catch(S){y.error("Failed to parse fault entries:",S)}return{currentView:m==="gateJudge"?"gateJudge":"timer",currentLang:l,bibInput:"",selectedPoint:"F",selectedRun:1,selectMode:!1,selectedEntries:new Set,isRecording:!1,lastRecordedEntry:null,entries:a,deviceRole:m,gateAssignment:p,firstGateColor:b,faultEntries:w,selectedFaultBib:"",isJudgeReady:!1,isChiefJudgeView:!1,finalizedRacers:new Set,penaltySeconds:5,usePenaltyMode:!0,undoStack:[],redoStack:[],settings:r,deviceId:e,deviceName:f,raceId:d,lastSyncedRaceId:g,syncStatus:"disconnected",syncQueue:o,connectedDevices:new Map,cloudDeviceCount:0,cloudHighestBib:0,raceExistsInCloud:null,gpsEnabled:r.gps,gpsAccuracy:null,gpsStatus:"inactive",cameraReady:!1,cameraError:null}}getState(){return this.state}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e){const t=this.state;if(this.pendingNotifications.length>=hn&&(y.warn(`Notification queue exceeded ${hn} - draining oldest`),this.pendingNotifications.splice(0,Math.floor(hn/2))),this.pendingNotifications.push({keys:e,stateSnapshot:t}),!this.isNotifying){this.isNotifying=!0;try{for(;this.pendingNotifications.length>0;){const{keys:i,stateSnapshot:s}=this.pendingNotifications.shift(),a=Array.from(this.listeners);for(const r of a)try{r(s,i)}catch(o){if(y.error("State listener error:",o),this.failedListenerCount++,this.listenerErrorCallback)try{this.listenerErrorCallback(o,r)}catch{}}}}finally{this.isNotifying=!1}}}onListenerError(e){this.listenerErrorCallback=e}getListenerFailureCount(){return this.failedListenerCount}setState(e,t=!0){const i=Object.keys(e);if(this.state={...this.state,...e},this.notify(i),t){for(const s of i)this.dirtySlices.add(s);this.scheduleSave()}}scheduleSave(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveToStorage(),100)}forceSave(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null);for(const e of Nr)this.dirtySlices.add(e);this.saveToStorage()}saveToStorage(){const e=this.dirtySlices;if(this.dirtySlices=new Set,e.size!==0)try{if(this.checkStorageQuota(),e.has("entries")){const i=this.state.entries.map(s=>s.photo&&s.photo!=="indexeddb"&&s.photo.length>20?{...s,photo:"indexeddb"}:s);localStorage.setItem($.ENTRIES,JSON.stringify(i))}e.has("settings")&&localStorage.setItem($.SETTINGS,JSON.stringify(this.state.settings)),e.has("currentLang")&&localStorage.setItem($.LANG,this.state.currentLang),e.has("deviceName")&&localStorage.setItem($.DEVICE_NAME,this.state.deviceName),e.has("raceId")&&localStorage.setItem($.RACE_ID,this.state.raceId),e.has("lastSyncedRaceId")&&localStorage.setItem($.LAST_SYNCED_RACE_ID,this.state.lastSyncedRaceId),e.has("syncQueue")&&localStorage.setItem($.SYNC_QUEUE,JSON.stringify(this.state.syncQueue)),e.has("deviceRole")&&localStorage.setItem($.DEVICE_ROLE,this.state.deviceRole),e.has("gateAssignment")&&(this.state.gateAssignment?localStorage.setItem($.GATE_ASSIGNMENT,JSON.stringify(this.state.gateAssignment)):localStorage.removeItem($.GATE_ASSIGNMENT)),e.has("firstGateColor")&&localStorage.setItem($.FIRST_GATE_COLOR,this.state.firstGateColor),e.has("faultEntries")&&localStorage.setItem($.FAULT_ENTRIES,JSON.stringify(this.state.faultEntries)),(e.has("entries")||e.has("settings"))&&localStorage.setItem($.SCHEMA_VERSION,String(Vt));const t=as();t.warning&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t.usageBytes,quota:t.estimatedQuota,percent:t.usagePercent,critical:t.usagePercent>90}}))}catch(t){y.error("Failed to save to storage:",t),this.dispatchStorageError(t)}}async checkStorageQuota(){var e;if((e=navigator.storage)!=null&&e.estimate)try{const{usage:t,quota:i}=await navigator.storage.estimate();if(i&&t){const s=t/i;s>.75&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t,quota:i,percent:Math.round(s*100),critical:s>.9}}))}}catch(t){y.warn("Could not check storage quota:",t)}}dispatchStorageError(e){window.dispatchEvent(new CustomEvent("storage-error",{detail:{message:e.message,isQuotaError:e.name==="QuotaExceededError"||e.message.includes("quota")||e.message.includes("storage"),entryCount:this.state.entries.length}}))}addEntry(e){const t=Ca(this.state.entries,e,this.state.undoStack,this.state.redoStack);this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack,lastRecordedEntry:e,isRecording:!1}),this.state.settings.sync&&this.state.raceId&&this.addToSyncQueue(e)}deleteEntry(e){const t=Ta(this.state.entries,e,this.state.undoStack,this.state.redoStack);t&&this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack})}deleteMultiple(e){const t=La(this.state.entries,e,this.state.undoStack,this.state.redoStack);t&&this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack,selectMode:!1,selectedEntries:new Set})}clearAll(){const e=Aa(this.state.entries,this.state.undoStack,this.state.redoStack);e&&this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack,selectMode:!1,selectedEntries:new Set})}updateEntry(e,t){const i=Ra(this.state.entries,e,t,this.state.undoStack,this.state.redoStack);return i?(this.setState({entries:i.entries,undoStack:i.undoStack,redoStack:i.redoStack}),!0):!1}canUndo(){return this.state.undoStack.length>0}canRedo(){return this.state.redoStack.length>0}peekUndo(){return this.canUndo()?this.state.undoStack[this.state.undoStack.length-1]:null}undo(){const e=Da(this.state.entries,this.state.undoStack,this.state.redoStack);return this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack}),e.result}redo(){const e=xa(this.state.entries,this.state.undoStack,this.state.redoStack);return this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack}),e.result}addToSyncQueue(e){const t=Ba(this.state.syncQueue,e);this.setState({syncQueue:t})}removeFromSyncQueue(e){const t=Pa(this.state.syncQueue,e);this.setState({syncQueue:t})}updateSyncQueueItem(e,t){const i=Na(this.state.syncQueue,e,t);this.setState({syncQueue:i})}clearSyncQueue(){this.setState({syncQueue:[]})}setView(e){this.setState(kr(e),!1)}setLanguage(e){this.setState(Cr(e))}setBibInput(e){this.setState(Tr(e),!1)}setSelectedPoint(e){this.setState(Lr(e),!1)}setSelectedRun(e){this.setState(Ar(e),!1)}setSelectMode(e){this.setState(Rr(e,this.state.selectedEntries),!1)}toggleEntrySelection(e){this.setState(Dr(e,this.state.selectedEntries),!1)}selectAllEntries(){this.setState(xr(this.state.entries.map(e=>e.id)),!1)}clearSelection(){this.setState(Br(),!1)}setRecording(e){this.setState(Pr(e),!1)}setDeviceRole(e){this.setState(Ya(e))}setGateAssignment(e){this.setState(Ka(e))}setFirstGateColor(e){this.setState(Za(e))}getGateColor(e){return Xa(e,this.state.gateAssignment,this.state.firstGateColor)}setSelectedFaultBib(e){this.setState(er(e),!1)}setJudgeReady(e){this.setState(tr(e))}toggleJudgeReady(){this.setState(nr(this.state.isJudgeReady))}setChiefJudgeView(e){this.setState(ir(e),!1)}toggleChiefJudgeView(){this.setState(sr(this.state.isChiefJudgeView),!1)}finalizeRacer(e,t){this.setState(ar(e,t,this.state.finalizedRacers),!1)}unfinalizeRacer(e,t){this.setState(rr(e,t,this.state.finalizedRacers),!1)}isRacerFinalized(e,t){return or(e,t,this.state.finalizedRacers)}clearFinalizedRacers(){this.setState(cr(),!1)}setPenaltySeconds(e){this.setState(lr(e),!1)}setUsePenaltyMode(e){this.setState(dr(e),!1)}getActiveBibs(e){return ur(this.state.entries,e)}addFaultEntry(e){const t=Ma(this.state.faultEntries,e);this.setState({faultEntries:t})}deleteFaultEntry(e){const t=Oa(this.state.faultEntries,e);this.setState({faultEntries:t})}updateFaultEntry(e,t){const i=Va(this.state.faultEntries,e,t);return i?(this.setState({faultEntries:i}),!0):!1}updateFaultEntryWithHistory(e,t,i){const s=Ha(this.state.faultEntries,e,t,this.state.deviceName,this.state.deviceId,i);return s?(this.setState({faultEntries:s}),!0):!1}restoreFaultVersion(e,t){const i=_a(this.state.faultEntries,e,t,this.state.deviceName,this.state.deviceId);return i?(this.setState({faultEntries:i}),!0):!1}markFaultForDeletion(e){const t=za(this.state.faultEntries,e,this.state.deviceName,this.state.deviceId);return t?(this.setState({faultEntries:t}),!0):!1}approveFaultDeletion(e){const t=Ua(this.state.faultEntries,e,this.state.deviceName);return t.approvedFault&&this.setState({faultEntries:t.faultEntries}),t.approvedFault}rejectFaultDeletion(e){const t=qa(this.state.faultEntries,e,this.state.deviceName,this.state.deviceId);return t?(this.setState({faultEntries:t}),!0):!1}getPendingDeletions(){return Ga(this.state.faultEntries)}clearFaultEntries(){this.setState({faultEntries:[]})}getFaultsForBib(e,t){return Ja(this.state.faultEntries,e,t)}mergeFaultsFromCloud(e,t=[]){const i=Qa(this.state.faultEntries,e,t,this.state.deviceId);return i.addedCount>0&&this.setState({faultEntries:i.faultEntries}),i.addedCount}removeDeletedCloudFaults(e){const t=Wa(this.state.faultEntries,e);return t.removedCount>0&&this.setState({faultEntries:t.faultEntries}),t.removedCount}markFaultSynced(e){const t=ja(this.state.faultEntries,e);this.setState({faultEntries:t})}updateSettings(e){const t=fr(this.state.settings,e);this.setState({settings:t})}toggleSetting(e){const t=gr(this.state.settings,e);this.setState({settings:t})}setSyncStatus(e){this.setState(hr(e),!1)}setRaceId(e){const t=mr(e,this.state.raceId);t.clearUndoRedo?this.setState({raceId:t.raceId,undoStack:[],redoStack:[]}):this.setState({raceId:t.raceId})}setLastSyncedRaceId(e){this.setState(pr(e))}markCurrentRaceAsSynced(){this.setState({lastSyncedRaceId:this.state.raceId})}setDeviceName(e){this.setState(yr(e))}addConnectedDevice(e){this.setState(vr(e,this.state.connectedDevices),!1)}removeConnectedDevice(e){this.setState(Sr(e,this.state.connectedDevices),!1)}setCloudDeviceCount(e){this.setState(Er(e),!1)}setCloudHighestBib(e){this.setState(wr(e),!1)}setRaceExistsInCloud(e){this.setState(Ir(e),!1)}setGpsStatus(e,t){this.setState({gpsStatus:e,gpsAccuracy:t??null},!1)}setCameraReady(e,t){this.setState({cameraReady:e,cameraError:t??null},!1)}mergeCloudEntries(e,t=[]){const i=Fa(this.state.entries,e,t,this.state.deviceId);return i.addedCount>0&&this.setState({entries:i.entries}),i.addedCount}removeDeletedCloudEntries(e){const t=$a(this.state.entries,e);return t.removedCount>0&&this.setState({entries:t.entries}),t.removedCount}exportData(){return JSON.stringify({version:Vt,entries:this.state.entries,settings:this.state.settings,deviceId:this.state.deviceId,deviceName:this.state.deviceName,raceId:this.state.raceId,exportedAt:new Date().toISOString()},null,2)}importData(e){try{const t=JSON.parse(e),i=Sa(t,this.state.deviceId),s=new Set(this.state.entries.map(r=>r.id)),a=i.entries.filter(r=>!s.has(r.id));if(a.length>0){const r=[...this.state.entries,...a];r.sort((o,l)=>new Date(o.timestamp).getTime()-new Date(l.timestamp).getTime()),this.setState({entries:r})}return{success:!0,entriesImported:a.length}}catch(t){return{success:!1,entriesImported:0,error:String(t)}}}}const c=new Fr,wi={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},$r=.8,yt=1280,bt=720,Ii=200;class Mr{constructor(){h(this,"stream",null);h(this,"videoElement",null);h(this,"canvasElement",null);h(this,"cameraState","stopped");h(this,"visibilityHandler",null);h(this,"pendingVisibilityChange",null);h(this,"previewElement",null);h(this,"ownsVideoElement",!1)}async initialize(){if(this.cameraState==="ready")return!0;if(this.cameraState==="initializing")return!1;this.cameraState="initializing";try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not available");return this.previewElement?(this.videoElement=this.previewElement,this.ownsVideoElement=!1):(this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.ownsVideoElement=!0),this.canvasElement=document.createElement("canvas"),this.canvasElement.width=yt,this.canvasElement.height=bt,this.stream=await navigator.mediaDevices.getUserMedia(wi),this.videoElement.srcObject=this.stream,await new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))}),this.pendingVisibilityChange==="hidden"?(this.pendingVisibilityChange=null,this.pauseCamera(),!1):(this.cameraState="ready",c.setCameraReady(!0),this.visibilityHandler||(this.visibilityHandler=()=>this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.visibilityHandler)),!0)}catch(e){const t=e instanceof Error?e.message:"Camera initialization failed";return y.error("Camera initialization error:",t),this.cameraState="stopped",c.setCameraReady(!1,t),!1}}handleVisibilityChange(){document.hidden?this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange="hidden":this.cameraState==="ready"&&this.pauseCamera():this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange=null:this.cameraState==="paused"&&this.reinitializeCamera()}pauseCamera(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.videoElement&&(this.videoElement.srcObject=null)),this.cameraState="paused",c.setCameraReady(!1)}async reinitializeCamera(){if(this.cameraState!=="resuming"){this.cameraState="resuming";try{if(this.videoElement||(this.previewElement?(this.videoElement=this.previewElement,this.ownsVideoElement=!1):(this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.ownsVideoElement=!0)),this.stream=await navigator.mediaDevices.getUserMedia(wi),this.videoElement.srcObject=this.stream,await new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))}),this.pendingVisibilityChange==="hidden"){this.pendingVisibilityChange=null,this.pauseCamera();return}this.cameraState="ready",c.setCameraReady(!0)}catch(e){y.error("Failed to reinitialize camera:",e),this.cameraState="stopped"}}}async capturePhoto(){if(this.cameraState!=="ready"||!this.videoElement||!this.canvasElement)return y.warn("Camera not ready for capture"),null;try{const e=this.canvasElement.getContext("2d");if(!e)throw new Error("Could not get canvas context");const t=this.videoElement.videoWidth,i=this.videoElement.videoHeight;let s=t,a=i;if(s>yt){const d=yt/s;s=yt,a=Math.round(a*d)}if(a>bt){const d=bt/a;a=bt,s=Math.round(s*d)}this.canvasElement.width=s,this.canvasElement.height=a,e.drawImage(this.videoElement,0,0,s,a);const r=new Date().toISOString();e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,a-30,s,30),e.fillStyle="#ffffff",e.font="14px monospace",e.fillText(r,10,a-10);const l=this.canvasElement.toDataURL("image/jpeg",$r).split(",")[1],f=Math.round(l.length/1024);if(f>Ii){const d=new Error(`Photo too large (${f}KB > ${Ii}KB limit)`);throw d.name="PhotoTooLargeError",d}return l}catch(e){return y.error("Photo capture error:",e),null}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null,this.ownsVideoElement&&(this.videoElement.remove(),this.videoElement=null)),this.canvasElement&&(this.canvasElement=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.pendingVisibilityChange=null,this.cameraState="stopped",c.setCameraReady(!1)}isReady(){return this.cameraState==="ready"}setPreviewElement(e){if(this.previewElement=e,!e){this.videoElement&&!this.ownsVideoElement&&(this.videoElement.srcObject=null,this.videoElement=null);return}this.videoElement!==e&&(this.videoElement&&this.ownsVideoElement&&this.videoElement.remove(),this.videoElement=e,this.ownsVideoElement=!1),this.stream&&(this.videoElement.srcObject=this.stream,this.videoElement.play().catch(()=>null))}getVideoElement(){return this.videoElement}getError(){return c.getState().cameraError}async toggle(e){return e?this.initialize():(this.stop(),!0)}}const He=new Mr;async function rs(){return!c.getState().settings.photoCapture||!He.isReady()&&!await He.initialize()?null:He.capturePhoto()}let _e=null,vt=null;const Or=3e4;function os(){if(!_e)try{_e=new(window.AudioContext||window.webkitAudioContext)}catch(n){return y.warn("AudioContext not available:",n),null}return _e}function Vr(){vt!==null&&clearTimeout(vt),vt=window.setTimeout(()=>{_e&&_e.state==="running"&&_e.suspend().catch(()=>{}),vt=null},Or)}function Re(n){if(c.getState().settings.haptic&&navigator.vibrate)try{navigator.vibrate(n)}catch(t){y.warn("Vibration failed:",t)}}function sn(n=880,e=100){if(!c.getState().settings.sound)return;const i=os();if(i){i.state==="suspended"&&i.resume().catch(()=>{}),Vr();try{const s=i.createOscillator(),a=i.createGain();s.connect(a),a.connect(i.destination),s.frequency.value=n,s.type="sine",a.gain.setValueAtTime(.3,i.currentTime),a.gain.exponentialRampToValueAtTime(.01,i.currentTime+e/1e3),s.start(i.currentTime),s.stop(i.currentTime+e/1e3)}catch(s){y.warn("Sound playback failed:",s)}}}function q(){Re(40),sn(880,100)}function z(){Re([60,40,60]),sn(440,200)}function k(){Re(30)}function Hr(){Re(10)}function _r(){Re(20)}function an(){Re([40,30,40]),sn(330,150)}function Nn(){Re([35,35]),sn(660,100)}async function ki(){const n=os();if(n&&n.state==="suspended")try{await n.resume()}catch(e){y.warn("Failed to resume audio:",e)}}const zr={enableHighAccuracy:!0,timeout:1e4,maximumAge:1e4},Ur={enableHighAccuracy:!1,timeout:15e3,maximumAge:15e3},qr=10,Gr=30;class Jr{constructor(){h(this,"watchId",null);h(this,"lastPosition",null);h(this,"visibilityHandler",null);h(this,"wasActiveBeforeHidden",!1);h(this,"batteryUnsubscribe",null);h(this,"usingLowPowerMode",!1);h(this,"timeOffset",null)}getGpsOptions(){const e=Z.isLowBattery();return this.usingLowPowerMode=e,e?Ur:zr}start(){if(this.watchId!==null)return!0;if(!navigator.geolocation)return y.error("Geolocation not supported"),c.setGpsStatus("inactive"),!1;c.setGpsStatus("searching");try{const e=this.getGpsOptions();return this.watchId=navigator.geolocation.watchPosition(t=>this.handlePosition(t),t=>this.handleError(t),e),this.visibilityHandler||(this.visibilityHandler=()=>{if(document.hidden)this.wasActiveBeforeHidden=this.watchId!==null,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null,c.setGpsStatus("inactive"));else if(this.wasActiveBeforeHidden){c.setGpsStatus("searching");const t=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(i=>this.handlePosition(i),i=>this.handleError(i),t)}},document.addEventListener("visibilitychange",this.visibilityHandler)),this.batteryUnsubscribe||(this.batteryUnsubscribe=Z.subscribe(()=>{if(this.watchId===null)return;const t=Z.isLowBattery();if(t!==this.usingLowPowerMode){y.debug(`[GPS] Switching to ${t?"low-power":"high-accuracy"} mode`),navigator.geolocation.clearWatch(this.watchId);const i=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(s=>this.handlePosition(s),s=>this.handleError(s),i)}})),!0}catch(e){return y.error("Failed to start GPS:",e),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),c.setGpsStatus("inactive"),!1}}pause(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.wasActiveBeforeHidden=!1,c.setGpsStatus(this.lastPosition?"paused":"inactive")}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasActiveBeforeHidden=!1,this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.lastPosition=null,this.timeOffset=null,c.setGpsStatus("inactive")}handlePosition(e){this.lastPosition=e;const t=e.timestamp-Date.now();Math.abs(t)>500&&y.warn(`[GPS] Clock offset ${t}ms - system clock may be inaccurate`),this.timeOffset=t;const i=e.coords.accuracy;c.setGpsStatus("active",i)}handleError(e){switch(y.error("GPS error:",e.message),e.code){case e.PERMISSION_DENIED:c.setGpsStatus("inactive"),this.stop();break;case e.POSITION_UNAVAILABLE:c.setGpsStatus("searching");break;case e.TIMEOUT:c.setGpsStatus("searching");break}}getPosition(){return this.lastPosition}getCoordinates(){if(this.lastPosition)return{latitude:this.lastPosition.coords.latitude,longitude:this.lastPosition.coords.longitude,accuracy:this.lastPosition.coords.accuracy}}getTimestamp(){var e;return((e=this.lastPosition)==null?void 0:e.timestamp)??null}getTimeOffset(){return this.timeOffset}getAccuracyStatus(){if(!this.lastPosition)return"unknown";const e=this.lastPosition.coords.accuracy;return e<=qr?"good":e<=Gr?"fair":"poor"}isActive(){return this.watchId!==null&&this.lastPosition!==null}toggle(e){return e?this.start():(this.stop(),!0)}async requestPosition(){return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{this.lastPosition=t,e(t)},()=>e(null),this.getGpsOptions())}):null}}const ge=new Jr,jr=`You are a voice command processor for a ski race timing app.
Parse the user's spoken command and return a structured JSON response.

Context provided:
- role: "timer" (sets bib/point/run) or "gateJudge" (records faults)
- language: User's language (de/en)
- activeBibs: Racers currently on course (gate judge only)
- gateRange: Gates this judge is watching [start, end]
- pendingConfirmation: If set, user is responding to a confirmation prompt

For TIMER role, recognize:
- Bib numbers: spoken digits or number words (e.g., "forty-five" = 45, "fünfundvierzig" = 45)
- Timing point: "Start" / "Ziel" / "Finish"
- Run selection: "Lauf 1/2", "Run 1/2", "erster Lauf", "zweiter Lauf"
NOTE: Timer role does NOT support recording timestamps via voice (latency too high for timing)

For GATE JUDGE role, recognize:
- Fault recording with bib + gate + type
- Fault types: MG (missed gate/ausgelassen), STR (straddling/eingefädelt), BR (binding release/Bindung offen)
- Ready status: "Bereit", "Ready", "Fertig"
- Confirmation: "Ja", "Yes", "Correct", "Richtig", "Stimmt"
- Cancellation: "Nein", "No", "Cancel", "Abbrechen", "Falsch"

Return ONLY valid JSON (no markdown, no explanation):
{
  "action": "record_fault" | "set_bib" | "set_gate" | "set_point" | "set_run" | "toggle_ready" | "confirm" | "cancel" | "unknown",
  "confidence": 0.0-1.0,
  "params": {
    "bib": "string (3 digits, zero-padded)",
    "gate": number,
    "faultType": "MG" | "STR" | "BR",
    "point": "S" | "F",
    "run": number (positive integer, typically 1 or 2)
  },
  "confirmationNeeded": boolean,
  "confirmationPrompt": "string (spoken confirmation request in user's language)"
}

IMPORTANT:
- For gate judge faults, set confirmationNeeded=true with a clear prompt
- Confirmation prompts should be in the user's language
- If user tries to record time via voice, return action="unknown" (voice timing disabled)
- If unsure, set action="unknown" with low confidence`,Qr={model:"claude-3-haiku-20240307",maxTokens:256};function Wr(n){return n.includes("/api/v1/voice")}async function Yr(n,e,t){const{endpoint:i,apiKey:s,model:a,maxTokens:r}={...Qr,...t};if(!i)throw new Error("LLM endpoint is required");if(Wr(i))return Kr(n,e,i);if(!s)throw new Error("API key is required for direct LLM calls");return Zr(n,e,i,s,a,r)}async function Kr(n,e,t){try{const i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcript:n,context:e})});if(!i.ok){const a=await i.text();throw y.error("[LLMProvider] Proxy error:",i.status,a),new Error(`Proxy error: ${i.status}`)}const s=await i.json();if(s.success&&s.intent)return y.debug("[LLMProvider] Proxy intent:",s.intent),s.intent;throw new Error("Invalid proxy response")}catch(i){return y.error("[LLMProvider] Proxy processing error:",i),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function Zr(n,e,t,i,s,a){var l;const o=`Context: ${JSON.stringify({role:e.role,language:e.language,currentRun:e.currentRun,activeBibs:e.activeBibs,gateRange:e.gateRange,pendingConfirmation:e.pendingConfirmation?{action:e.pendingConfirmation.action,params:e.pendingConfirmation.params}:null})}

Transcript: "${n}"`;try{const f=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:s,max_tokens:a,system:jr,messages:[{role:"user",content:o}]})});if(!f.ok){const b=await f.text();throw y.error("[LLMProvider] API error:",f.status,b),new Error(`LLM API error: ${f.status}`)}const d=await f.json();let g="";if(d.content&&Array.isArray(d.content)?g=((l=d.content[0])==null?void 0:l.text)||"":typeof d.content=="string"&&(g=d.content),!g)throw new Error("Empty response from LLM");let m=g.trim();m.startsWith("```")&&(m=m.replace(/```json?\n?/g,"").replace(/```$/g,"").trim());const p=JSON.parse(m);if(!p.action||typeof p.confidence!="number")throw new Error("Invalid intent structure");return y.debug("[LLMProvider] Parsed intent:",p),p}catch(f){return y.error("[LLMProvider] Processing error:",f),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function Xr(n,e,t,i=5e3){const s=new Promise((a,r)=>{setTimeout(()=>r(new Error("LLM request timeout")),i)});return Promise.race([Yr(n,e,t),s]).catch(a=>(y.warn("[LLMProvider] Timeout or error:",a),{action:"unknown",confidence:0,confirmationNeeded:!1}))}const eo="ski-timer-photos",to=1,X="photos",no=3,io=5e3;class so{constructor(){h(this,"db",null);h(this,"initPromise",null);h(this,"saveQueue",[]);h(this,"activeSaves",0)}async initialize(){return this.initPromise?this.initPromise:(this.initPromise=new Promise(e=>{if(!window.indexedDB){y.warn("IndexedDB not supported - photo storage disabled"),e(!1);return}const t=indexedDB.open(eo,to);t.onerror=()=>{y.error("IndexedDB open error:",t.error),e(!1)},t.onsuccess=()=>{this.db=t.result,e(!0)},t.onupgradeneeded=i=>{const s=i.target.result;s.objectStoreNames.contains(X)||s.createObjectStore(X,{keyPath:"entryId"}).createIndex("timestamp","timestamp",{unique:!1})}}),this.initPromise)}async savePhoto(e,t){return new Promise(i=>{this.saveQueue.push({entryId:e,photoBase64:t,resolve:i}),this.processQueue()})}processQueue(){for(;this.saveQueue.length>0&&this.activeSaves<no;){const e=this.saveQueue.shift();this.activeSaves++,this.doSavePhotoWithTimeout(e.entryId,e.photoBase64).then(t=>{e.resolve(t)}).catch(()=>{e.resolve(!1)}).finally(()=>{this.activeSaves--,this.processQueue()})}}async doSavePhotoWithTimeout(e,t){return Promise.race([this.doSavePhoto(e,t),new Promise((i,s)=>setTimeout(()=>s(new Error("Photo save timeout")),io))])}async doSavePhoto(e,t){return!this.db&&!await this.initialize()?!1:new Promise(i=>{if(!this.db){i(!1);return}try{const a=this.db.transaction([X],"readwrite").objectStore(X),r={entryId:e,photo:t,timestamp:Date.now()},o=a.put(r);o.onsuccess=()=>{i(!0)},o.onerror=()=>{y.error("Photo save error:",o.error),i(!1)}}catch(s){y.error("Photo save transaction error:",s),i(!1)}})}async getPhoto(e){return!this.db&&!await this.initialize()?null:new Promise(t=>{if(!this.db){t(null);return}try{const a=this.db.transaction([X],"readonly").objectStore(X).get(e);a.onsuccess=()=>{const r=a.result;t((r==null?void 0:r.photo)||null)},a.onerror=()=>{y.error("Photo get error:",a.error),t(null)}}catch(i){y.error("Photo get transaction error:",i),t(null)}})}async deletePhoto(e){return!this.db&&!await this.initialize()?!1:new Promise(t=>{if(!this.db){t(!1);return}try{const a=this.db.transaction([X],"readwrite").objectStore(X).delete(e);a.onsuccess=()=>{t(!0)},a.onerror=()=>{y.error("Photo delete error:",a.error),t(!1)}}catch(i){y.error("Photo delete transaction error:",i),t(!1)}})}async hasPhoto(e){return await this.getPhoto(e)!==null}async clearAll(){return!this.db&&!await this.initialize()?!1:new Promise(e=>{if(!this.db){e(!1);return}try{const s=this.db.transaction([X],"readwrite").objectStore(X).clear();s.onsuccess=()=>{e(!0)},s.onerror=()=>{y.error("Photo clear error:",s.error),e(!1)}}catch(t){y.error("Photo clear transaction error:",t),e(!1)}})}async deletePhotos(e){for(const t of e)await this.deletePhoto(t)}async getStorageUsage(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{used:e.usage||0,quota:e.quota||0}}catch{return null}return null}async getPhotoCount(){return!this.db&&!await this.initialize()?0:new Promise(e=>{if(!this.db){e(0);return}try{const s=this.db.transaction([X],"readonly").objectStore(X).count();s.onsuccess=()=>{e(s.result)},s.onerror=()=>{e(0)}}catch{e(0)}})}close(){this.db&&(this.db.close(),this.db=null,this.initPromise=null)}}const Q=new so;class ao{constructor(){h(this,"synth",null);h(this,"voice",null);h(this,"voicesLoaded",!1);typeof window<"u"&&"speechSynthesis"in window&&(this.synth=window.speechSynthesis,this.loadVoices())}isSupported(){return this.synth!==null}loadVoices(){if(!this.synth)return;this.synth.getVoices().length>0?(this.voicesLoaded=!0,this.selectVoiceForLanguage(c.getState().currentLang)):this.synth.addEventListener("voiceschanged",()=>{this.voicesLoaded=!0,this.selectVoiceForLanguage(c.getState().currentLang)},{once:!0})}selectVoiceForLanguage(e){if(!this.synth)return;const t=this.synth.getVoices(),i=e==="de"?"de":"en";this.voice=t.find(s=>s.lang.startsWith(i)&&s.name.toLowerCase().includes("female"))||t.find(s=>s.lang.startsWith(i))||t.find(s=>s.lang.startsWith("en"))||null,this.voice&&y.debug("[SpeechSynthesis] Selected voice:",this.voice.name,this.voice.lang)}setLanguage(e){this.voicesLoaded&&this.selectVoiceForLanguage(e)}speak(e,t){return new Promise((i,s)=>{if(!this.synth){s(new Error("Speech synthesis not supported"));return}this.synth.cancel();const a=new SpeechSynthesisUtterance(e);this.voice&&(a.voice=this.voice),a.rate=(t==null?void 0:t.rate)??1.1,a.pitch=(t==null?void 0:t.pitch)??1,a.volume=1,a.onend=()=>i(),a.onerror=r=>{r.error==="interrupted"?i():(y.warn("[SpeechSynthesis] Error:",r.error),s(new Error(r.error)))},this.synth.speak(a)})}sayOK(){return this.speak("OK",{rate:1.2})}sayRecorded(){const t=c.getState().currentLang==="de"?"Erfasst":"Recorded";return this.speak(t,{rate:1.1})}sayNotUnderstood(){const t=c.getState().currentLang==="de"?"Nicht verstanden":"Not understood";return this.speak(t,{rate:1})}cancel(){var e;(e=this.synth)==null||e.cancel()}}const ye=new ao,se={CRITICAL:"critical",ERROR:"error",WARNING:"warning",INFO:"info"},je={CRITICAL:8e3,ERROR:5e3,WARNING:4e3,INFO:3e3};function ro(n){return`[${n.component}] ${n.operation}`}function oo(n){return n instanceof Error?n.message:typeof n=="string"?n:"Unknown error"}function Qn(n){const e=ro(n),t=n.error?oo(n.error):"No error details",i={code:n.code,message:t,timestamp:new Date().toISOString(),...n.metadata};switch(n.severity){case se.CRITICAL:case se.ERROR:console.error(`${e}:`,t,i);break;case se.WARNING:console.warn(`${e}:`,t,i);break;case se.INFO:console.log(`${e}:`,t,i);break}if(n.userMessageKey){const s=c.getState().currentLang,a=u(n.userMessageKey,s),r=co(n.severity),o=je[n.severity.toUpperCase()]||je.ERROR;I(a,r,o)}n.severity===se.CRITICAL&&window.dispatchEvent(new CustomEvent("critical-error",{detail:n}))}function co(n){switch(n){case se.CRITICAL:case se.ERROR:return"error";case se.WARNING:return"warning";case se.INFO:return"info";default:return"error"}}function rn(n,e,t,i){Qn({component:n,operation:e,severity:se.ERROR,error:t,userMessageKey:i})}function it(n,e,t,i){Qn({component:n,operation:e,severity:se.WARNING,error:t,userMessageKey:i})}function lo(n,e,t,i){Qn({component:n,operation:e,severity:se.CRITICAL,error:t,userMessageKey:i})}const uo=1e4;class fo extends Error{constructor(e,t){super(`Request to ${e} timed out after ${t}ms`),this.name="FetchTimeoutError"}}async function ae(n,e={},t=uo){const i=new AbortController,s=setTimeout(()=>i.abort(),t);try{return await fetch(n,{...e,signal:i.signal})}catch(a){throw a instanceof Error&&a.name==="AbortError"?new fo(n,t):a}finally{clearTimeout(s)}}const gt="skiTimerAuthToken";function ce(){const n=localStorage.getItem(gt);return n?{Authorization:`Bearer ${n}`}:{}}function Ce(){const n=localStorage.getItem(gt);if(!n)return!1;try{const e=n.split(".");if(e.length===3){const t=JSON.parse(atob(e[1]));if(t.exp&&t.exp*1e3<Date.now())return!1}}catch{}return!0}function go(n){localStorage.setItem(gt,n)}function cs(){localStorage.removeItem(gt)}const ho=1e4;async function ls(n,e){const t=new AbortController,i=setTimeout(()=>t.abort(),ho);try{const s=await fetch("/api/v1/auth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:n,role:e}),signal:t.signal});clearTimeout(i);const a=await s.json();return s.ok?a.token?(go(a.token),{success:!0,token:a.token,isNewPin:a.isNewPin}):{success:!1,error:"No token received"}:{success:!1,error:a.error||"Authentication failed"}}catch(s){return clearTimeout(i),s instanceof Error&&s.name==="AbortError"?(y.error("Token exchange timeout"),{success:!1,error:"Request timeout"}):(y.error("Token exchange error:",s),{success:!1,error:"Network error"})}}function mo(n="Session expired. Please re-enter your PIN."){window.dispatchEvent(new CustomEvent("auth-expired",{detail:{message:n}}))}class po{constructor(){h(this,"broadcastChannel",null)}initialize(e){if(typeof BroadcastChannel>"u"){y.info("BroadcastChannel not supported - cross-tab sync disabled (graceful degradation)");return}try{this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(`ski-timer-${e}`),this.broadcastChannel.onmessage=t=>{try{const{type:i,data:s}=t.data||{};if(i==="entry"&&Ye(s))c.mergeCloudEntries([s]);else if(i==="presence"){const a=s;c.addConnectedDevice(a)}else if(i==="fault"){const a=s;a!=null&&a.id&&c.mergeFaultsFromCloud([a])}else if(i==="fault-deleted"){const a=s;a&&c.markFaultForDeletion(a)}}catch(i){y.error("Error processing broadcast message:",i)}}}catch(t){y.warn("BroadcastChannel initialization failed:",t)}}broadcastEntry(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"entry",data:e})}catch(t){y.error("Broadcast error:",t)}}broadcastPresence(){const e=c.getState();if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"presence",data:{id:e.deviceId,name:e.deviceName,lastSeen:Date.now()}})}catch(t){y.error("Presence broadcast error:",t)}}broadcastFault(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"fault",data:e})}catch(t){y.error("Fault broadcast error:",t)}}broadcastFaultDeletion(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"fault-deleted",data:e})}catch(t){y.error("Fault deletion broadcast error:",t)}}cleanup(){if(this.broadcastChannel){try{this.broadcastChannel.close()}catch{}this.broadcastChannel=null}}}const Me=new po;function we(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),i=String(n.getSeconds()).padStart(2,"0"),s=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${i}.${s}`}function yo(n,e="de"){const t={weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"};return n.toLocaleDateString(e==="de"?"de-DE":"en-US",t)}function mn(n,e=3){return String(n).padStart(e,"0")}function T(n){const e=document.createElement("div");return e.textContent=String(n),e.innerHTML}function R(n){return T(n).replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function st(n){return{S:"var(--success)",F:"var(--secondary)"}[n]||"var(--text-secondary)"}function Ie(n,e="de"){return{en:{S:"Start",F:"Finish"},de:{S:"Start",F:"Ziel"}}[e][n]}function et(n,e="de"){return`${e==="de"?"L":"R"}${n}`}function tt(n){return n===1?"var(--primary)":n===2?"var(--warning)":"var(--text-secondary)"}function pe(n,e){return{MG:u("faultMGShort",e),STR:u("faultSTRShort",e),BR:u("faultBRShort",e)}[n]||n}function bo(n){return n<1024?`${n} B`:n<1024*1024?`${(n/1024).toFixed(1)} KB`:`${(n/(1024*1024)).toFixed(1)} MB`}const ds="skiTimerRecentRaces",vo=50;function us(){try{const n=localStorage.getItem(ds);return n?JSON.parse(n):[]}catch{return[]}}function Wn(n,e,t){try{const i=us(),s=n.toLowerCase(),a=i.findIndex(o=>o.raceId.toLowerCase()===s);a>=0?(i[a].lastUpdated=e,t!==void 0&&(i[a].entryCount=t)):i.unshift({raceId:n,createdAt:Date.now(),lastUpdated:e,entryCount:t}),i.sort((o,l)=>l.lastUpdated-o.lastUpdated);const r=i.slice(0,vo);localStorage.setItem(ds,JSON.stringify(r))}catch(i){y.error("Failed to save recent race:",i)}}function Ut(n=5){const e=us(),t=new Date;t.setHours(0,0,0,0);const i=t.getTime();return e.filter(s=>s.createdAt>=i||s.lastUpdated>=i).slice(0,n)}const at="/api/v1/sync",Yn="/api/v1/faults",Ci=15e3,Ti=3e4,So=5,Eo=2e3,wo=1e4,De=8e3,Io=[15e3,2e4,3e4,45e3,6e4],pn=6,Li=[3e4,45e3,6e4,9e4,12e4],Ai=[3e4,6e4],Ri=3,Di=[15e3,2e4,3e4,45e3,6e4],ko=15e3,Co=15e3,xi=6e4,Bi=3e4;let P=null,qt=0;function To(n){P=n}function Lo(){return qt}async function Ao(n){const e=c.getState(),t=[];for(const i of n)i.photo&&i.photo!=="indexeddb"&&i.photo.length>20?e.settings.syncPhotos?await Q.savePhoto(i.id,i.photo)?t.push({...i,photo:"indexeddb"}):(y.warn("Sync: Photo storage failed for entry:",i.id),t.push({...i,photo:void 0})):t.push({...i,photo:void 0}):t.push(i);return t}async function Pi(){const n=c.getState();if(!n.settings.sync||!n.raceId)return;const e=n.syncStatus;(e==="connected"||e==="connecting")&&c.setSyncStatus("syncing");try{const t=new URLSearchParams({raceId:n.raceId,deviceId:n.deviceId,deviceName:n.deviceName}),i=await ae(`${at}?${t}`,{headers:ce()},De);if(i.status===401){let f={};try{f=await i.json()}catch{f={}}if(f.expired){cs(),c.setSyncStatus("disconnected"),mo(),P==null||P.onCleanup();return}throw new Error(`HTTP ${i.status}: ${f.error||"Unauthorized"}`)}if(!i.ok)throw new Error(`HTTP ${i.status}`);let s;try{s=await i.json()}catch{throw new Error("Invalid response format")}if(!s||typeof s!="object")throw new Error("Invalid data structure");if(s.deleted){window.dispatchEvent(new CustomEvent("race-deleted",{detail:{raceId:n.raceId,deletedAt:s.deletedAt,message:s.message}})),P==null||P.onCleanup();return}const r=(Array.isArray(s.entries)?s.entries:[]).filter(f=>Ye(f)?!0:(y.warn("Skipping invalid entry from cloud:",f),!1)),o=Array.isArray(s.deletedIds)?s.deletedIds.filter(f=>typeof f=="string"&&f.length>0):[];c.setSyncStatus("connected"),typeof s.deviceCount=="number"&&c.setCloudDeviceCount(s.deviceCount),typeof s.highestBib=="number"&&c.setCloudHighestBib(s.highestBib);let l=!1;if(o.length>0&&(c.removeDeletedCloudEntries(o),l=!0),r.length>0){const f=await Ao(r),d=c.mergeCloudEntries(f,o);if(d>0){l=!0;const g=c.getState().currentLang;P==null||P.showToast(u("syncedEntriesFromCloud",g).replace("{count}",String(d)))}}qt=s.lastUpdated||Date.now(),n.raceId&&Wn(n.raceId,qt,r.length),await(P==null?void 0:P.fetchFaults()),P==null||P.onPollingAdjust(!0,l)}catch(t){y.error("Cloud sync fetch error:",t);const i=t instanceof Error?t.message:"Unknown error";(t instanceof Error?t.name:"")==="FetchTimeoutError"||i.includes("timed out")||i.includes("500")||i.includes("503")?c.setSyncStatus("error"):i.includes("Failed to fetch")||i.includes("NetworkError")?c.setSyncStatus("offline"):c.setSyncStatus("error"),P==null||P.onPollingAdjust(!1)}}async function Ro(n,e){const t=c.getState();if(!t.settings.sync||!t.raceId)return!1;try{const i=await ae(`${at}?raceId=${encodeURIComponent(t.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json",...ce()},body:JSON.stringify({entryId:n,deviceId:e||t.deviceId,deviceName:t.deviceName})},De);if(!i.ok)throw new Error(`HTTP ${i.status}`);return!0}catch(i){return y.error("Cloud sync delete error:",i),!1}}async function Fn(n){const e=c.getState();if(!e.settings.sync||!e.raceId)return!1;try{let t={...n};if(e.settings.syncPhotos&&n.photo==="indexeddb"){const s=await Q.getPhoto(n.id);s?t={...n,photo:s}:t={...n,photo:void 0}}else n.photo&&(t={...n,photo:void 0});const i=await ae(`${at}?raceId=${encodeURIComponent(e.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json",...ce()},body:JSON.stringify({entry:t,deviceId:e.deviceId,deviceName:e.deviceName})},De);if(!i.ok)throw new Error(`HTTP ${i.status}`);try{const s=await i.json(),a=c.getState().currentLang;if(s.photoSkipped&&(P==null||P.showToast(u("photoTooLarge",a),"warning")),s.crossDeviceDuplicate){const r=s.crossDeviceDuplicate,o=Ie(r.point,a);P==null||P.showToast(u("crossDeviceDuplicate",a).replace("{bib}",r.bib).replace("{point}",o).replace("{device}",r.deviceName),"warning",5e3),window.dispatchEvent(new CustomEvent("cross-device-duplicate",{detail:r}))}typeof s.deviceCount=="number"&&c.setCloudDeviceCount(s.deviceCount),typeof s.highestBib=="number"&&c.setCloudHighestBib(s.highestBib)}catch(s){y.warn("Failed to parse send response body:",s)}return c.removeFromSyncQueue(n.id),P==null||P.onResetFastPolling(),!0}catch(t){return y.error("Cloud sync send error:",t),!1}}async function Do(){const n=c.getState();if(!(!n.settings.sync||!n.raceId))for(const e of n.entries)e.deviceId===n.deviceId&&!e.syncedAt&&await Fn(e)}function xo(){P=null,qt=0}let ve=null,Kn=[];function Bo(n){ve=n}function Po(n){const e=c.getState();Kn=n.filter(t=>t.deviceId!==e.deviceId)}function No(){return Kn}async function Fo(){const n=c.getState();if(!(!n.settings.sync||!n.raceId))try{const e=new URLSearchParams({raceId:n.raceId,deviceId:n.deviceId,deviceName:n.deviceName});n.deviceRole==="gateJudge"&&n.gateAssignment&&(e.set("gateStart",String(n.gateAssignment[0])),e.set("gateEnd",String(n.gateAssignment[1])),e.set("isReady",String(n.isJudgeReady)),e.set("firstGateColor",n.firstGateColor));const t=await ae(`${Yn}?${e}`,{headers:ce()},De);if(!t.ok){if(t.status===401)return;throw new Error(`HTTP ${t.status}`)}const i=await t.json();if(!i||typeof i!="object")throw new Error("Invalid fault data structure");const s=Array.isArray(i.faults)?i.faults:[],a=Array.isArray(i.deletedIds)?i.deletedIds.filter(r=>typeof r=="string"):[];if(a.length>0&&c.removeDeletedCloudFaults(a),s.length>0){const r=c.mergeFaultsFromCloud(s,a);if(r>0){const o=c.getState().currentLang;ve==null||ve.showToast(u("syncedFaultsFromCloud",o).replace("{count}",String(r)))}}Array.isArray(i.gateAssignments)&&Po(i.gateAssignments)}catch(e){y.error("Fault sync fetch error:",e),window.dispatchEvent(new CustomEvent("fault-sync-error",{detail:{error:e instanceof Error?e.message:"Unknown error"}}))}}async function fs(n){const e=c.getState();if(!e.settings.sync||!e.raceId)return!1;try{const t=await ae(`${Yn}?raceId=${encodeURIComponent(e.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json",...ce()},body:JSON.stringify({fault:n,deviceId:e.deviceId,deviceName:e.deviceName,gateRange:e.gateAssignment,isReady:e.isJudgeReady,firstGateColor:e.firstGateColor})},De);if(!t.ok)throw new Error(`HTTP ${t.status}`);return c.markFaultSynced(n.id),ve==null||ve.onResetFastPolling(),!0}catch(t){return y.error("Fault sync send error:",t),!1}}async function $o(n,e,t){const i=c.getState();if(!i.settings.sync||!i.raceId)return!1;try{const s=await ae(`${Yn}?raceId=${encodeURIComponent(i.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json",...ce()},body:JSON.stringify({faultId:n,deviceId:e||i.deviceId,deviceName:i.deviceName,approvedBy:t||i.deviceName})},De);if(!s.ok)throw new Error(`HTTP ${s.status}`);return!0}catch(s){return y.error("Fault sync delete error:",s),!1}}async function Mo(){const n=c.getState();if(!(!n.settings.sync||!n.raceId))for(const e of n.faultEntries)e.deviceId===n.deviceId&&!e.syncedAt&&await fs(e)}function Oo(){ve=null,Kn=[]}class Vo{constructor(){h(this,"isMetered",!1);h(this,"currentQuality","good");h(this,"networkChangeHandler",null);h(this,"onlineHandler",null);h(this,"offlineHandler",null);h(this,"changeListeners",new Set);h(this,"qualityListeners",new Set)}getConnection(){return navigator.connection}initialize(){this.currentQuality=navigator.onLine?"good":"offline";const e=this.getConnection();e&&(this.updateNetworkState(e),this.networkChangeHandler||(this.networkChangeHandler=()=>{const t=this.isMetered,i=this.currentQuality;this.updateNetworkState(e),t!==this.isMetered&&this.notifyListeners(),i!==this.currentQuality&&this.notifyQualityListeners()},e.addEventListener("change",this.networkChangeHandler)))}updateNetworkState(e){this.isMetered=e.saveData===!0||e.type==="cellular"||e.effectiveType==="slow-2g"||e.effectiveType==="2g",this.currentQuality=this.detectConnectionQuality(e)}detectConnectionQuality(e){return navigator.onLine?e&&(e.effectiveType==="2g"||e.effectiveType==="slow-2g"||e.saveData)?"slow":"good":"offline"}isMeteredConnection(){return this.isMetered}getConnectionQuality(){return this.currentQuality}onMeteredChange(e){return this.changeListeners.add(e),()=>{this.changeListeners.delete(e)}}onQualityChange(e){return this.qualityListeners.add(e),()=>{this.qualityListeners.delete(e)}}notifyListeners(){for(const e of this.changeListeners)e(this.isMetered)}notifyQualityListeners(){for(const e of this.qualityListeners)e(this.currentQuality)}registerOnlineHandlers(e,t){this.onlineHandler=()=>{const i=this.currentQuality,s=this.getConnection();this.currentQuality=this.detectConnectionQuality(s),i!==this.currentQuality&&this.notifyQualityListeners(),e()},this.offlineHandler=()=>{const i=this.currentQuality;this.currentQuality="offline",i!==this.currentQuality&&this.notifyQualityListeners(),t()},window.addEventListener("online",this.onlineHandler),window.addEventListener("offline",this.offlineHandler)}cleanup(){const e=this.getConnection();this.networkChangeHandler&&e&&(e.removeEventListener("change",this.networkChangeHandler),this.networkChangeHandler=null),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.offlineHandler&&(window.removeEventListener("offline",this.offlineHandler),this.offlineHandler=null),this.changeListeners.clear(),this.qualityListeners.clear()}}const Ae=new Vo;class Ho{constructor(){h(this,"pollInterval",null);h(this,"consecutiveErrors",0);h(this,"consecutiveNoChanges",0);h(this,"currentIdleLevel",0);h(this,"currentBatteryLevel","normal");h(this,"currentConnectionQuality","good");h(this,"isTabHidden",!1);h(this,"batteryUnsubscribe",null);h(this,"meteredUnsubscribe",null);h(this,"qualityUnsubscribe",null);h(this,"isAdjustingInterval",!1);h(this,"currentPollingIntervalMs",0);h(this,"pollCallback",null)}initialize(e){this.pollCallback=e,this.batteryUnsubscribe=Z.subscribe(t=>{const i=this.currentBatteryLevel;this.currentBatteryLevel=t.batteryLevel,i!==t.batteryLevel&&this.pollInterval&&this.applyBatteryAwarePolling()}),this.meteredUnsubscribe=Ae.onMeteredChange(()=>{this.pollInterval&&this.applyBatteryAwarePolling()}),this.currentConnectionQuality=Ae.getConnectionQuality(),this.qualityUnsubscribe=Ae.onQualityChange(t=>{const i=this.currentConnectionQuality;this.currentConnectionQuality=t,i!==t&&this.pollInterval&&this.applyBatteryAwarePolling()})}start(){this.currentPollingIntervalMs=0,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.pollCallback&&this.pollCallback();const e=this.consecutiveErrors>2?Ti:Ci;this.setPollingInterval(e)}stop(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.currentPollingIntervalMs=0}isPolling(){return this.pollInterval!==null}getPollingConfig(){const e=Ae.isMeteredConnection();return this.currentConnectionQuality==="offline"?{intervals:[xi],threshold:1,baseInterval:xi}:this.isTabHidden?{intervals:[Bi],threshold:1,baseInterval:Bi}:this.currentBatteryLevel==="critical"?{intervals:Ai,threshold:Ri,baseInterval:Ai[0]}:this.currentConnectionQuality==="slow"?{intervals:Di,threshold:pn,baseInterval:Co}:e?{intervals:Di,threshold:pn,baseInterval:ko}:this.currentBatteryLevel==="low"?{intervals:Li,threshold:Ri,baseInterval:Li[0]}:{intervals:Io,threshold:pn,baseInterval:Ci}}setPollingInterval(e){this.currentPollingIntervalMs===e&&this.pollInterval||(this.pollInterval&&clearInterval(this.pollInterval),this.currentPollingIntervalMs=e,this.pollCallback&&(this.pollInterval=setInterval(this.pollCallback,e)))}applyBatteryAwarePolling(){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{const e=this.getPollingConfig();if(!e.intervals||e.intervals.length===0){this.setPollingInterval(e.baseInterval);return}this.currentIdleLevel=Math.min(Math.max(0,this.currentIdleLevel),e.intervals.length-1);const t=this.consecutiveNoChanges<e.threshold?e.baseInterval:e.intervals[this.currentIdleLevel];this.setPollingInterval(t)}finally{this.isAdjustingInterval=!1}}}adjustPollingInterval(e,t=!1){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{if(!e){this.consecutiveErrors++,this.consecutiveErrors>2&&this.pollInterval&&this.setPollingInterval(Ti);return}this.consecutiveErrors=0;const i=this.getPollingConfig();if(!i.intervals||i.intervals.length===0){this.pollInterval&&this.setPollingInterval(i.baseInterval);return}if(t)this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval&&this.setPollingInterval(i.baseInterval);else if(this.consecutiveNoChanges++,this.consecutiveNoChanges>=i.threshold){const s=Math.min(Math.max(0,this.currentIdleLevel+1),i.intervals.length-1);s!==this.currentIdleLevel&&(this.currentIdleLevel=s,this.pollInterval&&this.setPollingInterval(i.intervals[this.currentIdleLevel]))}}finally{this.isAdjustingInterval=!1}}}resetToFastPolling(){if(this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval){const e=this.getPollingConfig();this.setPollingInterval(e.baseInterval)}}setTabHidden(e){this.isTabHidden!==e&&(this.isTabHidden=e,this.pollInterval&&(e?this.applyBatteryAwarePolling():(this.pollCallback&&this.pollCallback(),this.applyBatteryAwarePolling())))}cleanup(){this.stop(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.meteredUnsubscribe&&(this.meteredUnsubscribe(),this.meteredUnsubscribe=null),this.qualityUnsubscribe&&(this.qualityUnsubscribe(),this.qualityUnsubscribe=null),this.pollCallback=null,this.consecutiveErrors=0,this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.isTabHidden=!1,this.currentConnectionQuality="good"}}const le=new Ho;class _o{constructor(){h(this,"queueInterval",null);h(this,"isProcessingQueue",!1);h(this,"sendEntryCallback",null)}initialize(e){this.sendEntryCallback=e}start(){this.queueInterval&&clearInterval(this.queueInterval),this.queueInterval=setInterval(()=>this.processQueue(),wo)}stop(){this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null)}isProcessing(){return this.queueInterval!==null}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{const e=c.getState();if(!e.settings.sync||!e.raceId||e.syncQueue.length===0)return;if(!this.sendEntryCallback){y.warn("Queue processor: No send callback configured");return}const t=Date.now();for(const i of e.syncQueue){if(i.retryCount>=So){y.warn("Max retries exceeded for entry:",i.entry.id),c.removeFromSyncQueue(i.entry.id);continue}const s=Eo*2**i.retryCount;if(t-i.lastAttempt<s)continue;await this.sendEntryCallback(i.entry)||c.updateSyncQueueItem(i.entry.id,{retryCount:i.retryCount+1,lastAttempt:t,error:"Failed to sync"})}}finally{this.isProcessingQueue=!1}}}getQueueLength(){return c.getState().syncQueue.length}cleanup(){this.stop(),this.sendEntryCallback=null}}const Te=new _o;class zo{constructor(){h(this,"visibilityHandler",null);h(this,"wasQueueProcessingBeforeHidden",!1)}initialize(){const e=c.getState();if(!e.settings.sync||!e.raceId){this.cleanup();return}this.initializeModules(),Me.initialize(e.raceId),Ae.initialize(),le.start(),Te.start();try{Do()}catch(t){y.error("Failed to push local entries during sync init:",t)}try{Mo()}catch(t){y.error("Failed to push local faults during sync init:",t)}this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(le.setTabHidden(!0),this.wasQueueProcessingBeforeHidden=Te.isProcessing(),Te.stop()):(le.setTabHidden(!1),this.wasQueueProcessingBeforeHidden&&Te.start())},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.visibilityHandler()),Z.initialize(),Ae.registerOnlineHandlers(()=>{c.getState().syncStatus==="offline"&&(c.setSyncStatus("connecting"),le.start())},()=>{c.setSyncStatus("offline")}),navigator.onLine?c.setSyncStatus("connecting"):c.setSyncStatus("offline")}initializeModules(){le.initialize(()=>{Pi()}),Te.initialize(Fn),To({onPollingAdjust:(e,t)=>{le.adjustPollingInterval(e,t)},onResetFastPolling:()=>{le.resetToFastPolling()},onCleanup:()=>this.cleanup(),showToast:(e,t,i)=>this.showSyncToast(e,t,i),fetchFaults:()=>Fo()}),Bo({onResetFastPolling:()=>{le.resetToFastPolling()},showToast:(e,t,i)=>this.showSyncToast(e,t,i)})}showSyncToast(e,t="success",i){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:e,type:t,duration:i}}))}cleanup(){le.cleanup(),Te.cleanup(),Me.cleanup(),Ae.cleanup(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasQueueProcessingBeforeHidden=!1,xo(),Oo(),c.setSyncStatus("disconnected")}async forceRefresh(){await Pi()}getQueueLength(){return Te.getQueueLength()}getLastSyncTime(){return Lo()}broadcastEntry(e){Me.broadcastEntry(e)}broadcastPresence(){Me.broadcastPresence()}resetToFastPolling(){le.resetToFastPolling()}sendEntryToCloud(e){return Fn(e)}deleteEntryFromCloud(e,t){return Ro(e,t)}sendFaultToCloud(e){return fs(e)}async deleteFaultFromCloud(e,t,i){return $o(e,t,i)}getOtherGateAssignments(){return No()}async checkRaceExists(e){if(!e)return{exists:!1,entryCount:0};try{const t=await ae(`${at}?raceId=${encodeURIComponent(e)}&checkOnly=true`,{headers:ce()},5e3);if(!t.ok)return{exists:!1,entryCount:0};const i=await t.json();return{exists:i.exists===!0,entryCount:typeof i.entryCount=="number"?i.entryCount:0}}catch(t){return y.error("Check race exists error:",t),{exists:!1,entryCount:0}}}async getPhotoSyncStats(){const e=c.getState();let t=0,i=0,s=0,a=0;for(const r of e.entries)if(r.photo==="indexeddb"&&r.deviceId===e.deviceId){const o=await Q.getPhoto(r.id);o&&(t++,i+=o.length)}if(e.settings.sync&&e.raceId)try{const r=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),o=await ae(`${at}?${r}`,{headers:ce()},De);if(o.ok){const l=await o.json(),f=Array.isArray(l.entries)?l.entries:[];for(const d of f)if(d.photo&&d.photo!=="indexeddb"&&d.photo.length>20&&d.deviceId!==e.deviceId){const g=e.entries.find(m=>m.id===d.id&&m.deviceId===d.deviceId);(!g||!g.photo)&&(s++,a+=d.photo.length)}}}catch(r){y.warn("Failed to fetch cloud entries for photo stats:",r)}return{uploadCount:t,uploadSize:i,downloadCount:s,downloadSize:a,totalSize:i+a}}}const N=new zo;async function Uo(n){const e=c.getState();N.broadcastEntry(n),e.settings.sync&&e.raceId&&(await N.sendEntryToCloud(n)||c.addToSyncQueue(n))}async function Ke(n){const e=c.getState();Me.broadcastFault(n),e.settings.sync&&e.raceId&&await N.sendFaultToCloud(n)}async function Zn(n){const e=c.getState();return Me.broadcastFaultDeletion(n.id),e.settings.sync&&e.raceId?N.deleteFaultFromCloud(n.id,n.deviceId,n.markedForDeletionBy):!0}class qo{constructor(){h(this,"recognition",null);h(this,"llmConfig",null);h(this,"isEnabled",!1);h(this,"isPaused",!1);h(this,"isOnline",typeof navigator<"u"?navigator.onLine:!0);h(this,"pendingIntent",null);h(this,"status","inactive");h(this,"confirmationTimeout",null);h(this,"restartTimeout",null);h(this,"stateCallbacks",new Set);h(this,"actionCallbacks",new Set);h(this,"CONFIRMATION_TIMEOUT_MS",1e4);h(this,"LLM_TIMEOUT_MS",5e3);h(this,"RESTART_DELAY_MS",100);h(this,"handleOnline",()=>{var e;if(this.isOnline=!0,this.isEnabled){this.setStatus("listening");try{(e=this.recognition)==null||e.start()}catch{}}});h(this,"handleOffline",()=>{var e;this.isOnline=!1,this.isEnabled&&(this.setStatus("offline"),(e=this.recognition)==null||e.stop())})}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(e){if(!this.isSupported())return y.warn("[Voice] Speech Recognition not supported"),!1;if(!ye.isSupported())return y.warn("[Voice] Speech Synthesis not supported"),!1;this.llmConfig=e;const t=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new t,this.recognition.continuous=!0,this.recognition.interimResults=!1,this.updateRecognitionLanguage(),this.setupRecognitionHandlers(),window.addEventListener("online",this.handleOnline),window.addEventListener("offline",this.handleOffline),y.debug("[Voice] Initialized successfully"),!0}updateRecognitionLanguage(){if(!this.recognition)return;const e=c.getState().currentLang;this.recognition.lang=e==="de"?"de-DE":"en-US",ye.setLanguage(e)}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{y.debug("[Voice] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{const t=e.results[e.resultIndex];if(t.isFinal){const i=t[0].transcript.trim();y.debug("[Voice] Transcript:",i),this.processTranscript(i)}},this.recognition.onerror=e=>{switch(y.warn("[Voice] Recognition error:",e.error),e.error){case"network":this.setStatus("offline");break;case"not-allowed":case"service-not-allowed":this.setStatus("error"),this.disable();break;case"no-speech":case"audio-capture":break;case"aborted":return;default:this.setStatus("error")}},this.recognition.onend=()=>{y.debug("[Voice] Recognition ended"),this.isEnabled&&this.isOnline&&!this.isPaused&&this.status!=="error"&&this.scheduleRestart()})}scheduleRestart(){this.restartTimeout&&clearTimeout(this.restartTimeout),this.restartTimeout=setTimeout(()=>{var e;if(this.isEnabled&&this.isOnline&&!this.isPaused)try{(e=this.recognition)==null||e.start()}catch{}},this.RESTART_DELAY_MS)}async processTranscript(e){if(!e||!this.llmConfig)return;this.setStatus("processing");const t=c.getState(),i={role:t.deviceRole,language:t.currentLang,currentRun:t.selectedRun,activeBibs:t.deviceRole==="gateJudge"?this.getActiveBibs(t.selectedRun):void 0,gateRange:t.gateAssignment||void 0,pendingConfirmation:this.pendingIntent||void 0};try{const s=await Xr(e,i,this.llmConfig,this.LLM_TIMEOUT_MS);await this.handleIntent(s)}catch(s){y.error("[Voice] Processing error:",s),this.setStatus("error"),await ye.sayNotUnderstood(),this.setStatus("listening")}}getActiveBibs(e){const t=c.getState(),i=new Set,s=new Set;for(const a of t.entries)a.run===e&&(a.point==="S"?i.add(a.bib):a.point==="F"&&s.add(a.bib));return Array.from(i).filter(a=>!s.has(a))}async handleIntent(e){if(this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.pendingIntent&&(e.action==="confirm"||e.action==="cancel")){if(e.action==="confirm")this.executeIntent(this.pendingIntent),await ye.sayRecorded();else{const t=c.getState().currentLang;await ye.speak(t==="de"?"Abgebrochen":"Cancelled")}this.pendingIntent=null,this.setStatus("listening");return}if(e.action==="unknown"||e.confidence<.5){await ye.sayNotUnderstood(),this.setStatus("listening");return}if(e.confirmationNeeded&&e.confirmationPrompt){this.pendingIntent=e,this.setStatus("confirming"),await ye.speak(e.confirmationPrompt),this.confirmationTimeout=setTimeout(()=>{this.pendingIntent&&(y.debug("[Voice] Confirmation timeout"),this.pendingIntent=null,this.setStatus("listening"))},this.CONFIRMATION_TIMEOUT_MS);return}this.executeIntent(e),this.setStatus("listening")}executeIntent(e){y.debug("[Voice] Executing intent:",e.action);for(const t of this.actionCallbacks)t(e)}setStatus(e){if(this.status!==e){this.status=e;for(const t of this.stateCallbacks)t(e)}}enable(){if(!this.recognition||!this.llmConfig)return y.warn("[Voice] Not initialized"),!1;if(!this.isOnline)return this.setStatus("offline"),!1;this.isEnabled=!0,this.updateRecognitionLanguage();try{return this.recognition.start(),!0}catch(e){return y.warn("[Voice] Failed to start recognition:",e),this.setStatus("error"),!1}}disable(){var e;this.isEnabled=!1,this.isPaused=!1,this.pendingIntent=null,this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.stop()}catch{}ye.cancel(),this.setStatus("inactive")}pause(){var e;if(!(!this.isEnabled||this.isPaused)){this.isPaused=!0,this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.abort()}catch{}y.debug("[Voice] Paused")}}resume(){!this.isEnabled||!this.isPaused||(this.isPaused=!1,this.isOnline&&this.status!=="error"&&this.scheduleRestart(),y.debug("[Voice] Resumed"))}getStatus(){return this.status}isActive(){return this.isEnabled}onStatusChange(e){return this.stateCallbacks.add(e),()=>this.stateCallbacks.delete(e)}onAction(e){return this.actionCallbacks.add(e),()=>this.actionCallbacks.delete(e)}isPausedState(){return this.isPaused}cleanup(){this.disable(),this.stateCallbacks.clear(),this.actionCallbacks.clear(),window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),this.recognition=null,this.llmConfig=null}}const _=new qo;class Go{constructor(){h(this,"recognition",null);h(this,"status","idle");h(this,"isDestroyed",!1);h(this,"statusCallbacks",new Set);h(this,"transcriptCallbacks",new Set);h(this,"MAX_DURATION_MS",3e4);h(this,"recordingTimeout",null)}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(){if(this.recognition)return!0;if(!this.isSupported())return y.warn("[VoiceNote] Speech Recognition not supported"),this.setStatus("unsupported"),!1;const e=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new e,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.setupRecognitionHandlers(),this.updateLanguage(),y.debug("[VoiceNote] Initialized successfully"),!0}updateLanguage(){if(!this.recognition)return;const e=c.getState().currentLang;this.recognition.lang=e==="de"?"de-DE":"en-US"}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{y.debug("[VoiceNote] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{let t="",i="";for(let s=e.resultIndex;s<e.results.length;s++){const a=e.results[s];a.isFinal?i+=a[0].transcript:t+=a[0].transcript}t&&this.notifyTranscript(t,!1),i&&this.notifyTranscript(i,!0)},this.recognition.onerror=e=>{switch(y.warn("[VoiceNote] Recognition error:",e.error),e.error){case"not-allowed":case"service-not-allowed":this.setStatus("error");break;case"no-speech":case"audio-capture":this.setStatus("idle");break;case"aborted":this.setStatus("idle");break;default:this.setStatus("error")}this.clearRecordingTimeout()},this.recognition.onend=()=>{y.debug("[VoiceNote] Recognition ended"),this.clearRecordingTimeout(),this.status==="listening"&&this.setStatus("idle")})}start(){var e;if(this.isDestroyed||!this.initialize())return!1;this.updateLanguage();try{return(e=this.recognition)==null||e.start(),this.recordingTimeout=setTimeout(()=>{y.debug("[VoiceNote] Max duration reached, stopping"),this.stop()},this.MAX_DURATION_MS),!0}catch(t){return y.warn("[VoiceNote] Failed to start:",t),this.setStatus("error"),!1}}stop(){var e;this.clearRecordingTimeout();try{(e=this.recognition)==null||e.stop()}catch{}this.setStatus("idle")}abort(){var e;this.clearRecordingTimeout();try{(e=this.recognition)==null||e.abort()}catch{}this.setStatus("idle")}clearRecordingTimeout(){this.recordingTimeout&&(clearTimeout(this.recordingTimeout),this.recordingTimeout=null)}setStatus(e){if(this.status!==e){this.status=e;for(const t of this.statusCallbacks)try{t(e)}catch(i){y.error("[VoiceNote] Status callback error:",i)}}}notifyTranscript(e,t){for(const i of this.transcriptCallbacks)try{i(e,t)}catch(s){y.error("[VoiceNote] Transcript callback error:",s)}}getStatus(){return this.status}isRecording(){return this.status==="listening"}onStatusChange(e){return this.statusCallbacks.add(e),()=>this.statusCallbacks.delete(e)}onTranscript(e){return this.transcriptCallbacks.add(e),()=>this.transcriptCallbacks.delete(e)}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.abort(),this.statusCallbacks.clear(),this.transcriptCallbacks.clear(),this.recognition=null)}}const j=new Go,Jo=30*60*1e3,jo=60*1e3;class Qo{constructor(){h(this,"wakeLock",null);h(this,"isEnabled",!1);h(this,"visibilityHandler",null);h(this,"lastInteraction",Date.now());h(this,"idleCheckInterval",null);h(this,"interactionHandler",null)}isSupported(){return"wakeLock"in navigator}async enable(){return this.isSupported()?this.isEnabled?!0:(this.isEnabled=!0,this.lastInteraction=Date.now(),this.visibilityHandler||(this.visibilityHandler=()=>{!document.hidden&&this.isEnabled&&!this.wakeLock&&this.requestWakeLock()},document.addEventListener("visibilitychange",this.visibilityHandler)),this.startIdleTracking(),this.requestWakeLock()):!1}async disable(){this.isEnabled=!1,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.stopIdleTracking(),await this.releaseWakeLock()}resetIdleTimer(){this.lastInteraction=Date.now(),this.isEnabled&&!this.wakeLock&&this.requestWakeLock()}startIdleTracking(){this.interactionHandler||(this.interactionHandler=()=>this.resetIdleTimer(),document.addEventListener("touchstart",this.interactionHandler,{passive:!0}),document.addEventListener("mousedown",this.interactionHandler),document.addEventListener("keydown",this.interactionHandler)),this.idleCheckInterval===null&&(this.idleCheckInterval=setInterval(()=>this.checkIdle(),jo))}stopIdleTracking(){this.interactionHandler&&(document.removeEventListener("touchstart",this.interactionHandler),document.removeEventListener("mousedown",this.interactionHandler),document.removeEventListener("keydown",this.interactionHandler),this.interactionHandler=null),this.idleCheckInterval!==null&&(clearInterval(this.idleCheckInterval),this.idleCheckInterval=null)}checkIdle(){if(!this.isEnabled)return;if(Date.now()-this.lastInteraction>=Jo&&this.wakeLock){y.debug("[WakeLock] Idle timeout reached, releasing wake lock"),this.releaseWakeLock();const t=c.getState().currentLang;I(u("wakeLockIdleTimeout",t),"warning",5e3)}}async requestWakeLock(){if(!this.isSupported()||this.wakeLock)return!!this.wakeLock;try{return this.wakeLock=await navigator.wakeLock.request("screen"),this.wakeLock.addEventListener("release",()=>{this.wakeLock=null}),!0}catch(e){const t=e instanceof Error?e.message:"Unknown error";y.warn("Wake Lock request failed:",t),this.wakeLock=null;const i=c.getState().currentLang;return I(u("wakeLockFailed",i),"warning",5e3),!1}}async releaseWakeLock(){if(this.wakeLock){try{await this.wakeLock.release()}catch(e){y.warn("Wake Lock release error:",e)}this.wakeLock=null}}isActive(){return this.wakeLock!==null}isWakeLockEnabled(){return this.isEnabled}}const Gt=new Qo,yn=new Map;function v(n){return yn.has(n)||yn.set(n,document.getElementById(n)),yn.get(n)}function Xn(n=18){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`}function Wo(n=14){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="9" y1="11" x2="9" y2="17"/><line x1="15" y1="11" x2="15" y2="17"/></svg>`}function gs(n=18){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`}function $n(n=16,e=2.5){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${e}"><path d="M20 6L9 17l-5-5"/></svg>`}function Yo(n=16,e=2){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${e}"><path d="M18 6L6 18M6 6l12 12"/></svg>`}function Ko(n=16,e=!1){return`<svg class="group-chevron" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true" style="flex-shrink: 0; transition: transform 0.2s; ${e?"transform: rotate(90deg);":""}"><path d="M9 18l6-6-6-6"/></svg>`}function Zo(n=12){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>`}function Xo(n=18){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>`}function ec(n=12){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 9v4M12 17h.01"/><circle cx="12" cy="12" r="10"/></svg>`}function St(n){return`<button class="${n.className||"result-edit-btn"}" aria-label="${R(n.ariaLabel)}" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; opacity: 0.7;">${gs(n.size||18)}</button>`}function Et(n){return`<button class="${n.className||"result-delete"}" aria-label="${R(n.ariaLabel)}" style="background: none; border: none; color: var(--error); padding: 6px; cursor: pointer; opacity: 0.7;">${Xn(n.size||18)}</button>`}function tc(n){return`<button class="result-photo-btn" aria-label="${R(n)}" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">${Xo()}</button>`}function Ni(n){return`<span class="result-duplicate-badge" title="${R(u("multiDeviceDuplicate",n))}" aria-label="${R(u("multiDeviceDuplicate",n))}">${Zo()} ${T(u("multiDeviceDuplicate",n))}</span>`}function Fi(n){var a;const{faults:e,lang:t}=n;if(e.length===0)return"";const i=e.map(r=>`T${r.gateNumber} (${pe(r.faultType,t)})`).join(", "),s=e.length>1?`${e.length}× ${u("flt",t)}`:`T${((a=e[0])==null?void 0:a.gateNumber)||"?"}`;return`<span class="result-fault-badge" title="${R(i)}" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">${T(s)}</span>`}function bn(n,e="var(--error)",t="white",i="0.7rem"){return`<span class="result-status" style="padding: 2px 6px; border-radius: var(--radius); font-size: ${i}; font-weight: 600; background: ${e}; color: ${t};">${T(n)}</span>`}function $i(n="0.7rem"){return`<span class="deletion-pending-status" style="display: flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: var(--radius); font-size: ${n}; font-weight: 600; background: var(--error); color: white;">${ec()} DEL</span>`}function vn(n,e){return`<span class="result-run" data-advanced style="padding: 4px 6px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; min-width: 36px; text-align: center; background: ${e}20; color: ${e};">${T(n)}</span>`}function wt(n,e,t="48px",i="0.75rem"){return`<div class="result-point" style="padding: 4px 6px; border-radius: var(--radius); font-size: ${i}; font-weight: 600; min-width: ${t}; text-align: center; background: ${e}20; color: ${e};">${T(n)}</div>`}const Mi=0,nc=1,ic=3;class sc{constructor(e){h(this,"container");h(this,"timeElement");h(this,"dateElement");h(this,"dateRow");h(this,"lastTimeStr","");h(this,"animationId",null);h(this,"isRunning",!1);h(this,"visibilityHandler",null);h(this,"frameSkipCount",Mi);h(this,"currentFrame",0);h(this,"batteryUnsubscribe",null);h(this,"isDestroyed",!1);h(this,"cachedDigits",[]);h(this,"tick",()=>{if(this.isRunning)try{if(this.currentFrame++,this.frameSkipCount===0||this.currentFrame%(this.frameSkipCount+1)===0){const t=new Date,i=we(t);if(i!==this.lastTimeStr&&(this.updateDigits(i),this.lastTimeStr=i),t.getSeconds()===0||!this.dateElement.textContent){const a=c.getState();this.dateElement.textContent=yo(t,a.currentLang)}}this.animationId=requestAnimationFrame(this.tick)}catch(e){if(y.error("Clock tick error:",e),this.animationId===null)try{this.animationId=requestAnimationFrame(this.tick)}catch(t){y.error("Clock RAF scheduling failed:",t),setTimeout(()=>{this.isRunning&&this.animationId===null&&this.tick()},16)}}});this.container=e,this.container.innerHTML="",this.timeElement=this.createTimeElement(),this.dateRow=this.createDateRow(),this.dateElement=this.dateRow.querySelector(".clock-date"),this.container.appendChild(this.timeElement),this.container.appendChild(this.dateRow),this.cachedDigits=Array.from(this.timeElement.querySelectorAll(".clock-digit")),this.moveTimingPointsToDateRow()}moveTimingPointsToDateRow(){const e=document.querySelector(".timing-controls");e&&this.dateRow&&this.dateRow.appendChild(e)}createTimeElement(){const e=document.createElement("div");e.className="clock-time",e.setAttribute("role","timer"),e.setAttribute("aria-live","polite");const t=c.getState().currentLang;e.setAttribute("aria-label",u("currentTime",t)),e.style.cssText=`
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(32px, 10vw, 48px);
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      text-shadow: 0 0 40px rgba(56, 189, 248, 0.3);
    `;for(let i=0;i<12;i++){const s=document.createElement("span");s.className="clock-digit",s.dataset.index=String(i),e.appendChild(s)}return e}createDateRow(){const e=document.createElement("div");e.className="clock-date-row",e.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      padding: 0 8px;
      width: 100%;
    `;const t=document.createElement("div");return t.className="clock-date",t.style.cssText=`
      font-size: 0.875rem;
      color: var(--text-secondary);
    `,e.appendChild(t),e}start(){this.isRunning||(this.isRunning=!0,this.tick(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null):this.isRunning&&this.animationId===null&&this.tick()},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)),this.batteryUnsubscribe||Z.initialize().then(()=>{this.batteryUnsubscribe=Z.subscribe(e=>{this.updateFrameSkipFromBattery(e.batteryLevel)})}).catch(e=>y.debug("Battery API unavailable:",e)))}updateFrameSkipFromBattery(e){switch(e){case"critical":this.frameSkipCount=ic;break;case"low":this.frameSkipCount=nc;break;default:this.frameSkipCount=Mi}}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null)}updateDigits(e){for(let t=0;t<e.length&&t<this.cachedDigits.length;t++){const i=this.cachedDigits[t],s=e[t];i.textContent!==s&&(i.textContent=s,i.style.transform="scale(1.02)",requestAnimationFrame(()=>{i.style.transform="scale(1)"}))}}getCurrentTime(){return this.lastTimeStr}getTimestamp(){const e=ge.getTimestamp();return e?new Date(e):new Date}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.stop(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.container.innerHTML="")}}const It=80,Oi=2.5;class ac{constructor(e){h(this,"container");h(this,"indicator");h(this,"styleElement",null);h(this,"onRefresh");h(this,"startY",0);h(this,"currentY",0);h(this,"isPulling",!1);h(this,"isRefreshing",!1);h(this,"scrollableParent",null);h(this,"onTouchStart",e=>{var i;this.isRefreshing||(((i=this.scrollableParent)==null?void 0:i.scrollTop)??0)>0||(this.startY=e.touches[0].clientY,this.isPulling=!0)});h(this,"onTouchMove",e=>{var t;if(!(!this.isPulling||this.isRefreshing))try{if((((t=this.scrollableParent)==null?void 0:t.scrollTop)??0)>0){this.isPulling=!1;return}this.currentY=e.touches[0].clientY;const s=(this.currentY-this.startY)/Oi;s>0&&(e.preventDefault(),this.updateIndicator(s))}catch(i){y.error("PullToRefresh move error:",i),this.isPulling=!1,this.resetIndicator()}});h(this,"onTouchEnd",async()=>{if(!this.isPulling||this.isRefreshing)return;const e=(this.currentY-this.startY)/Oi;this.isPulling=!1,e>=It?(this.isRefreshing=!0,await this.triggerRefresh()):this.resetIndicator()});this.container=e.container,this.onRefresh=e.onRefresh,this.indicator=this.createIndicator(),this.container.insertBefore(this.indicator,this.container.firstChild),this.scrollableParent=e.scrollElement??this.findScrollableParent(this.container)??this.findScrollableChild(this.container),this.bindEvents()}createIndicator(){const e=document.createElement("div");e.className="pull-indicator",e.style.cssText=`
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: transform 0.2s;
      pointer-events: none;
      z-index: 100;
    `;const t=c.getState().currentLang;return e.innerHTML=`
      <div class="pull-indicator-content" style="display: flex; align-items: center; gap: 8px;">
        <svg class="pull-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
        <span class="pull-text">${u("pullToRefresh",t)}</span>
      </div>
      <div class="pull-spinner" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      </div>
    `,this.styleElement=document.createElement("style"),this.styleElement.textContent=`
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(this.styleElement),e}findScrollableParent(e){let t=e.parentElement;for(;t;){const i=getComputedStyle(t);if(i.overflowY==="auto"||i.overflowY==="scroll")return t;t=t.parentElement}return null}findScrollableChild(e){const t=e.querySelectorAll("*");for(const i of t)if(i instanceof HTMLElement){const s=getComputedStyle(i);if(s.overflowY==="auto"||s.overflowY==="scroll")return i}return null}bindEvents(){this.container.addEventListener("touchstart",this.onTouchStart,{passive:!0}),this.container.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.container.addEventListener("touchend",this.onTouchEnd,{passive:!0})}updateIndicator(e){const t=Math.min(e,It*1.5);this.indicator.style.transform=`translateY(${t}px)`;const i=Math.min(e/It,1),s=this.indicator.querySelector(".pull-icon"),a=this.indicator.querySelector(".pull-text");if(s&&(s.style.transform=`rotate(${i*180}deg)`),a){const r=c.getState().currentLang;a.textContent=i>=1?u("releaseToRefresh",r):u("pullToRefresh",r)}}async triggerRefresh(){const e=this.indicator.querySelector(".pull-indicator-content"),t=this.indicator.querySelector(".pull-spinner");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.indicator.style.transform=`translateY(${It}px)`;try{await this.onRefresh()}catch(i){y.error("PullToRefresh callback error:",i)}finally{this.isRefreshing=!1,e&&(e.style.display="flex"),t&&(t.style.display="none"),this.resetIndicator()}}resetIndicator(){this.indicator.style.transform="translateY(0)";const e=this.indicator.querySelector(".pull-icon");e&&(e.style.transform="rotate(0deg)")}destroy(){this.container.removeEventListener("touchstart",this.onTouchStart),this.container.removeEventListener("touchmove",this.onTouchMove),this.container.removeEventListener("touchend",this.onTouchEnd),this.indicator.remove(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}}class rc{constructor(e,t={}){h(this,"container");h(this,"dialNumbers",null);h(this,"dialRing",null);h(this,"options");h(this,"rotation",0);h(this,"velocity",0);h(this,"isDragging",!1);h(this,"lastAngle",0);h(this,"lastDragTime",0);h(this,"accumulatedRotation",0);h(this,"spinAnimationId",null);h(this,"snapBackAnimationId",null);h(this,"snapBackTimeoutId",null);h(this,"resizeObserver",null);h(this,"lastContainerWidth",0);h(this,"visualTimeoutIds",new Set);h(this,"dragStartPos",null);h(this,"hasDraggedSignificantly",!1);h(this,"lastTouchTime",0);h(this,"numberKeydownListeners",new Map);h(this,"cachedNumberSpans",[]);h(this,"cachedNumberElements",new Map);h(this,"isDestroyed",!1);h(this,"bibValue","");h(this,"handleDragStart",e=>{var f,d;const t="touches"in e;if(!t&&Date.now()-this.lastTouchTime<500)return;t&&(this.lastTouchTime=Date.now());const i=this.container.getBoundingClientRect(),s=t?e.touches[0].clientX:e.clientX,a=t?e.touches[0].clientY:e.clientY,r=i.left+i.width/2,o=i.top+i.height/2,l=Math.sqrt((s-r)**2+(a-o)**2);l<i.width*.27||l>i.width*.5||(this.snapBackTimeoutId&&(clearTimeout(this.snapBackTimeoutId),this.snapBackTimeoutId=null),this.snapBackAnimationId&&(cancelAnimationFrame(this.snapBackAnimationId),this.snapBackAnimationId=null),this.dragStartPos={x:s,y:a},this.hasDraggedSignificantly=!1,this.isDragging=!0,this.velocity=0,this.spinAnimationId&&(cancelAnimationFrame(this.spinAnimationId),this.spinAnimationId=null),this.lastAngle=this.getAngle(s,a,i),this.lastDragTime=Date.now(),this.accumulatedRotation=0,(f=this.dialNumbers)==null||f.classList.remove("momentum"),(d=this.dialNumbers)==null||d.classList.add("momentum"))});h(this,"handleDragMove",e=>{if(!this.isDragging)return;const t="touches"in e?e.touches[0].clientX:e.clientX,i="touches"in e?e.touches[0].clientY:e.clientY;if(this.dragStartPos&&!this.hasDraggedSignificantly)if(Math.sqrt((t-this.dragStartPos.x)**2+(i-this.dragStartPos.y)**2)>10)this.hasDraggedSignificantly=!0;else return;e.preventDefault();const s=this.container.getBoundingClientRect(),a=this.getAngle(t,i,s);let r=a-this.lastAngle;r>180&&(r-=360),r<-180&&(r+=360);const o=Date.now(),l=Math.max(o-this.lastDragTime,1);if(this.velocity=r/l*16*this.options.momentum,this.rotation+=r,this.accumulatedRotation+=r,this.updateDialRotation(),Math.abs(this.accumulatedRotation)>=this.options.sensitivity){const f=this.accumulatedRotation>0?1:-1;this.adjustBib(f),this.accumulatedRotation=this.accumulatedRotation%this.options.sensitivity}this.lastAngle=a,this.lastDragTime=o});h(this,"handleDragEnd",()=>{var e,t,i;if(this.isDragging){if(this.isDragging=!1,!this.hasDraggedSignificantly&&this.dragStartPos){const s=this.container.getBoundingClientRect(),a=s.left+s.width/2,r=s.top+s.height/2;let o=Math.atan2(this.dragStartPos.y-r,this.dragStartPos.x-a)*(180/Math.PI);o-=this.rotation,o=(o%360+360)%360;const l=[1,2,3,4,5,6,7,8,9,0];let f=0,d=360;if(l.forEach((g,m)=>{const p=(m*36-90+360)%360;let b=Math.abs(o-p);b>180&&(b=360-b),b<d&&b<20&&(d=b,f=g)}),d<20){const g=(e=this.dialNumbers)==null?void 0:e.querySelector(`[data-num="${f}"]`);g&&this.handleNumberTap(f,g)}this.dragStartPos=null,(t=this.dialNumbers)==null||t.classList.remove("momentum");return}this.dragStartPos=null,Math.abs(this.velocity)>.5?this.spinWithMomentum():((i=this.dialNumbers)==null||i.classList.remove("momentum"),this.scheduleSnapBack())}});h(this,"spinWithMomentum",()=>{var e;if(Math.abs(this.velocity)<.2){this.velocity=0,(e=this.dialNumbers)==null||e.classList.remove("momentum"),this.scheduleSnapBack();return}if(this.rotation+=this.velocity,this.accumulatedRotation+=this.velocity,this.updateDialRotation(),Math.abs(this.accumulatedRotation)>=this.options.sensitivity){const t=this.accumulatedRotation>0?1:-1;this.adjustBib(t),this.accumulatedRotation=this.accumulatedRotation%this.options.sensitivity}this.velocity*=this.options.friction,this.spinAnimationId=requestAnimationFrame(this.spinWithMomentum)});h(this,"snapBack",()=>{var t;if(Math.abs(this.rotation)<1){this.rotation=0,this.updateDialRotation(),this.snapBackAnimationId=null,(t=this.dialNumbers)==null||t.classList.remove("momentum");return}this.rotation*=1-.15,this.updateDialRotation(),this.snapBackAnimationId=requestAnimationFrame(this.snapBack)});this.container=e,this.options={onChange:t.onChange||(()=>{}),momentum:t.momentum??1.5,friction:t.friction??.97,sensitivity:t.sensitivity??24},this.init()}init(){if(this.dialNumbers=this.container.querySelector(".dial-numbers"),this.dialRing=this.container.querySelector(".dial-ring"),!this.dialNumbers){y.warn("[RadialDial] Required elements not found");return}this.generateDialNumbers(),this.generateTicks(),this.bindEvents()}generateDialNumbers(){if(!this.dialNumbers)return;this.dialNumbers.innerHTML="",this.cachedNumberSpans=[],this.cachedNumberElements.clear();const e=[1,2,3,4,5,6,7,8,9,0],t=this.container.offsetWidth||460,i=t*.38,s=t/2;e.forEach((a,r)=>{const o=(r*36-90)*(Math.PI/180),l=s+i*Math.cos(o),f=s+i*Math.sin(o),d=document.createElement("div");d.className="dial-number",d.dataset.num=String(a),d.innerHTML=`<span>${a}</span>`,d.style.left=`${l}px`,d.style.top=`${f}px`,d.style.transform="translate(-50%, -50%)";const g=c.getState().currentLang;d.setAttribute("tabindex","0"),d.setAttribute("role","button"),d.setAttribute("aria-label",`${u("numberLabel",g)} ${a}`);const m=b=>{const w=b;(w.key==="Enter"||w.key===" ")&&(w.preventDefault(),this.handleNumberTap(a,d))};d.addEventListener("keydown",m),this.numberKeydownListeners.set(d,m),this.dialNumbers.appendChild(d);const p=d.querySelector("span");p&&this.cachedNumberSpans.push(p),this.cachedNumberElements.set(String(a),d)})}generateTicks(){const e=this.container.querySelector(".dial-ticks");if(e){e.innerHTML="";for(let t=0;t<60;t++){const i=document.createElement("div");i.className=`dial-tick${t%6===0?" major":""}`,i.style.transform=`rotate(${t*6}deg)`,e.appendChild(i)}}}handleNumberTap(e,t){if(this.bibValue.length<3){this.bibValue+=String(e),this.options.onChange(this.bibValue),Hr(),t.classList.add("pressed");const i=window.setTimeout(()=>{t.classList.remove("pressed"),this.visualTimeoutIds.delete(i)},150);this.visualTimeoutIds.add(i)}}bindEvents(){this.container.addEventListener("mousedown",this.handleDragStart),window.addEventListener("mousemove",this.handleDragMove),window.addEventListener("mouseup",this.handleDragEnd),this.container.addEventListener("touchstart",this.handleDragStart,{passive:!1}),window.addEventListener("touchmove",this.handleDragMove,{passive:!1}),window.addEventListener("touchend",this.handleDragEnd),this.lastContainerWidth=this.container.offsetWidth,this.resizeObserver=new ResizeObserver(e=>{const t=e[0];if(!t)return;const i=Math.round(t.contentRect.width);i>0&&i!==this.lastContainerWidth&&(this.lastContainerWidth=i,this.generateDialNumbers())}),this.resizeObserver.observe(this.container)}scheduleSnapBack(){this.snapBackTimeoutId&&clearTimeout(this.snapBackTimeoutId),this.snapBackTimeoutId=window.setTimeout(()=>{this.snapBack()},800)}adjustBib(e){let t=parseInt(this.bibValue||"0",10);t+=e,t<0&&(t=0),t>999&&(t=999),this.bibValue=String(t),this.options.onChange(this.bibValue),_r();const i=String(t%10),s=this.cachedNumberElements.get(i);if(s){s.classList.add("flash");const a=window.setTimeout(()=>{s.classList.remove("flash"),this.visualTimeoutIds.delete(a)},150);this.visualTimeoutIds.add(a)}}getAngle(e,t,i){const s=i.left+i.width/2,a=i.top+i.height/2;return Math.atan2(t-a,e-s)*(180/Math.PI)}updateDialRotation(){if(!this.dialNumbers)return;this.dialNumbers.style.transform=`rotate(${this.rotation}deg)`;const e=`rotate(${-this.rotation}deg)`;for(const t of this.cachedNumberSpans)t.style.transform=e}getValue(){return this.bibValue}setValue(e){this.bibValue=e.slice(0,3)}clear(){this.bibValue=""}flash(){var t,i;(t=this.dialRing)==null||t.classList.add("flash"),(i=this.dialNumbers)==null||i.querySelectorAll(".dial-number").forEach((s,a)=>{const r=window.setTimeout(()=>{this.visualTimeoutIds.delete(r),s.classList.add("flash");const o=window.setTimeout(()=>{s.classList.remove("flash"),this.visualTimeoutIds.delete(o)},200);this.visualTimeoutIds.add(o)},a*40);this.visualTimeoutIds.add(r)});const e=window.setTimeout(()=>{var s;(s=this.dialRing)==null||s.classList.remove("flash"),this.visualTimeoutIds.delete(e)},1200);this.visualTimeoutIds.add(e)}destroy(){if(!this.isDestroyed){this.isDestroyed=!0,this.spinAnimationId&&cancelAnimationFrame(this.spinAnimationId),this.snapBackAnimationId&&cancelAnimationFrame(this.snapBackAnimationId),this.snapBackTimeoutId&&clearTimeout(this.snapBackTimeoutId),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null);for(const e of this.visualTimeoutIds)clearTimeout(e);this.visualTimeoutIds.clear();for(const[e,t]of this.numberKeydownListeners)e.removeEventListener("keydown",t);this.numberKeydownListeners.clear(),this.container.removeEventListener("mousedown",this.handleDragStart),this.container.removeEventListener("touchstart",this.handleDragStart),window.removeEventListener("mousemove",this.handleDragMove),window.removeEventListener("mouseup",this.handleDragEnd),window.removeEventListener("touchmove",this.handleDragMove),window.removeEventListener("touchend",this.handleDragEnd)}}}const oc=3e3,cc=1e3;class lc{constructor(){h(this,"container");h(this,"queue",[]);h(this,"isShowing",!1);h(this,"toastEventListener");h(this,"lastCopyTime",0);h(this,"isDestroyed",!1);this.container=this.createContainer(),document.body.appendChild(this.container),this.toastEventListener=e=>{this.show(e.detail.message,{type:e.detail.type,duration:e.detail.duration})},window.addEventListener("show-toast",this.toastEventListener)}createContainer(){const e=document.createElement("div");return e.id="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.style.cssText=`
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    `,e}show(e,t={}){this.queue.push({message:e,options:t}),this.isShowing||this.processQueue()}processQueue(){if(this.queue.length===0){this.isShowing=!1;return}this.isShowing=!0;const{message:e,options:t}=this.queue.shift(),i=t.duration||oc,s=t.type||"info",a=this.createToast(e,s,t.action);this.container.appendChild(a),requestAnimationFrame(()=>{a.style.opacity="1",a.style.transform="translateY(0)"});let r=!1;const o=()=>{r||(r=!0,a.style.opacity="0",a.style.transform="translateY(10px)",setTimeout(()=>{a.remove(),this.processQueue()},200))};a._dismiss=o,setTimeout(o,i)}createToast(e,t,i){const s=document.createElement("div");s.className=`toast toast-${t}`;const a={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--primary)"},r={success:'<path d="M20 6L9 17l-5-5"/>',error:'<path d="M18 6L6 18M6 6l12 12"/>',warning:'<path d="M12 9v4M12 17h.01"/>',info:'<path d="M12 16v-4M12 8h.01"/>'};if(s.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border-left: 3px solid ${a[t]};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 0.875rem;
      color: var(--text-primary);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: auto;
      max-width: 90vw;
    `,s.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${a[t]}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        ${r[t]}
      </svg>
      <span>${this.escapeHtml(e)}</span>
    `,i){const o=document.createElement("button");o.textContent=i.label,o.setAttribute("aria-label",i.label),o.style.cssText=`
        background: none;
        border: 1px solid ${a[t]};
        color: ${a[t]};
        padding: 2px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        margin-left: 4px;
        white-space: nowrap;
      `,o.addEventListener("click",l=>{l.stopPropagation(),l.preventDefault(),i.callback();const f=s._dismiss;f&&f()}),s.appendChild(o)}else s.addEventListener("click",o=>{o.stopPropagation(),o.preventDefault(),this.copyToClipboard(e)});return s.addEventListener("mousedown",o=>o.stopPropagation()),s.addEventListener("touchstart",o=>o.stopPropagation(),{passive:!0}),s}async copyToClipboard(e){const t=Date.now(),i=t-this.lastCopyTime>cc;this.lastCopyTime=t;try{await navigator.clipboard.writeText(e),i&&this.show(u("copied",c.getState().currentLang),{type:"success",duration:1500})}catch{}}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}clear(){this.queue=[],this.container.innerHTML="",this.isShowing=!1}destroy(){this.isDestroyed||(this.isDestroyed=!0,window.removeEventListener("show-toast",this.toastEventListener),this.clear(),this.container.remove())}}let ze=null;function ei(){return ze||(ze=new lc),ze}function I(n,e="info",t,i){ei().show(n,{type:e,duration:t,action:i==null?void 0:i.action})}function dc(){ei().clear()}function uc(){ze&&(ze.destroy(),ze=null)}const Be=72,Pe=56,Ne=72,Vi=5,fc=16,gc=100;class hc{constructor(e){h(this,"container");h(this,"scrollContainer");h(this,"contentContainer");h(this,"entries",[]);h(this,"groups",[]);h(this,"expandedGroups",new Set);h(this,"visibleItems",new Map);h(this,"itemListeners",new Map);h(this,"scrollTop",0);h(this,"containerHeight",0);h(this,"options");h(this,"unsubscribe",null);h(this,"resizeObserver",null);h(this,"scrollHandler",null);h(this,"scrollDebounceTimeout",null);h(this,"resizeDebounceTimeout",null);h(this,"isPaused",!1);h(this,"needsRefreshOnResume",!1);h(this,"isDestroyed",!1);h(this,"domRemovalObserver",null);this.options=e,this.container=e.container,this.scrollContainer=document.createElement("div"),this.scrollContainer.className="virtual-scroll-container",this.scrollContainer.style.cssText=`
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    `,this.contentContainer=document.createElement("div"),this.contentContainer.className="virtual-scroll-content",this.contentContainer.style.position="relative",this.scrollContainer.appendChild(this.contentContainer),this.container.appendChild(this.scrollContainer),this.scrollHandler=()=>{this.scrollDebounceTimeout!==null&&clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=setTimeout(()=>{this.scrollDebounceTimeout=null;try{this.onScroll()}catch(i){y.error("VirtualList scroll error:",i)}},fc)},this.scrollContainer.addEventListener("scroll",this.scrollHandler,{passive:!0}),this.resizeObserver=new ResizeObserver(()=>{this.resizeDebounceTimeout!==null&&clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=setTimeout(()=>{this.resizeDebounceTimeout=null;try{this.containerHeight=this.scrollContainer.clientHeight,this.isPaused?this.needsRefreshOnResume=!0:this.render()}catch(i){y.error("VirtualList resize error:",i)}},gc)}),this.resizeObserver.observe(this.scrollContainer),this.unsubscribe=c.subscribe((i,s)=>{(s.includes("entries")||s.includes("selectedEntries")||s.includes("faultEntries"))&&this.setEntries(i.entries)}),this.domRemovalObserver=new MutationObserver(i=>{var s;for(const a of i)for(const r of a.removedNodes)if(r===this.container||(s=r.contains)!=null&&s.call(r,this.container)){this.destroy();return}});const t=this.container.parentElement||document.body;this.domRemovalObserver.observe(t,{childList:!0,subtree:!0}),this.containerHeight=this.scrollContainer.clientHeight}setEntries(e){this.entries=e,this.applyFilters()}applyFilters(e,t,i){var o;this.scrollDebounceTimeout!==null&&(clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=null);const s=c.getState();let a=[...this.entries];if(e){const l=e.toLowerCase();a=a.filter(f=>{var d;return f.bib.toLowerCase().includes(l)||((d=f.deviceName)==null?void 0:d.toLowerCase().includes(l))})}t&&t!=="all"&&(a=a.filter(l=>l.point===t)),i&&i!=="all"&&(a=a.filter(l=>l.status===i));const r=new Map;for(const l of a){const f=l.run??1,d=`${l.bib}-${f}`;r.has(d)||r.set(d,{id:d,bib:l.bib,run:f,entries:[],faults:[],isMultiItem:!1,latestTimestamp:l.timestamp,crossDeviceDuplicateCount:0});const g=r.get(d);g.entries.push(l),new Date(l.timestamp)>new Date(g.latestTimestamp)&&(g.latestTimestamp=l.timestamp)}for(const l of s.faultEntries){const f=`${l.bib}-${l.run}`;if(e){const g=e.toLowerCase();if(!l.bib.toLowerCase().includes(g)&&!((o=l.deviceName)!=null&&o.toLowerCase().includes(g)))continue}if(t&&t!=="all"||i&&i!=="all"&&i!=="dsq"&&i!=="flt")continue;r.has(f)||r.set(f,{id:f,bib:l.bib,run:l.run,entries:[],faults:[],isMultiItem:!1,latestTimestamp:l.timestamp,crossDeviceDuplicateCount:0});const d=r.get(f);d.faults.push(l),new Date(l.timestamp)>new Date(d.latestTimestamp)&&(d.latestTimestamp=l.timestamp)}for(const l of r.values()){const f=l.entries.length+l.faults.length;l.isMultiItem=f>1;const d=new Map;for(const m of l.entries){const p=m.point;d.has(p)||d.set(p,new Set),d.get(p).add(m.deviceId)}let g=0;for(const m of d.values())m.size>1&&g++;l.crossDeviceDuplicateCount=g}this.groups=Array.from(r.values()).sort((l,f)=>{const d=parseInt(l.bib,10)||0;return(parseInt(f.bib,10)||0)-d});for(const[l,f]of this.visibleItems)this.cleanupItemListeners(l,f),f.remove();this.visibleItems.clear(),this.updateContentHeight(),this.isPaused?this.needsRefreshOnResume=!0:this.render()}toggleGroup(e){this.expandedGroups.has(e)?this.expandedGroups.delete(e):this.expandedGroups.add(e);for(const[t,i]of this.visibleItems)this.cleanupItemListeners(t,i),i.remove();this.visibleItems.clear(),this.updateContentHeight(),this.isPaused?this.needsRefreshOnResume=!0:this.render()}updateContentHeight(){let e=0;for(const t of this.groups)if(!t.isMultiItem)e+=Be;else if(this.expandedGroups.has(t.id)){const i=t.entries.length+t.faults.length;e+=Ne+i*Pe}else e+=Ne;this.contentContainer.style.height=`${e}px`}getGroupHeight(e){if(!e.isMultiItem)return Be;if(this.expandedGroups.has(e.id)){const t=e.entries.length+e.faults.length;return Ne+t*Pe}return Ne}onScroll(){this.scrollTop=this.scrollContainer.scrollTop,this.isPaused?this.needsRefreshOnResume=!0:this.render()}render(){if(this.groups.length===0){this.renderEmpty();return}const e=this.contentContainer.querySelector(".empty-state");e&&e.remove();const t=new Set,i=this.scrollTop,s=this.scrollTop+this.containerHeight;let a=0;for(let r=0;r<this.groups.length;r++){const o=this.groups[r],l=this.getGroupHeight(o);a+l>=i-Vi*Be&&a<=s+Vi*Be&&(o.isMultiItem?this.expandedGroups.has(o.id)?this.renderExpandedGroup(o,a,t):this.renderCollapsedGroup(o,a,t):this.renderSingleItem(o,a,t)),a+=l}for(const[r,o]of this.visibleItems)t.has(r)||(this.cleanupItemListeners(r,o),o.remove(),this.visibleItems.delete(r))}renderSingleItem(e,t,i){const s=`single-${e.id}`;i.add(s);let a=this.visibleItems.get(s);if(!a){if(e.entries.length>0)a=this.createEntryItem(e.entries[0],e.faults,s,e.crossDeviceDuplicateCount);else if(e.faults.length>0)a=this.createFaultOnlyItem(e,s);else return;this.visibleItems.set(s,a),this.contentContainer.appendChild(a)}a.style.transform=`translateY(${t}px)`}renderCollapsedGroup(e,t,i){const s=`header-${e.id}`;i.add(s);let a=this.visibleItems.get(s);a||(a=this.createGroupHeader(e,!1),this.visibleItems.set(s,a),this.contentContainer.appendChild(a)),a.style.transform=`translateY(${t}px)`}renderExpandedGroup(e,t,i){const s=`header-${e.id}`;i.add(s);let a=this.visibleItems.get(s);a||(a=this.createGroupHeader(e,!0),this.visibleItems.set(s,a),this.contentContainer.appendChild(a)),a.style.transform=`translateY(${t}px)`;let r=t+Ne;for(let o=0;o<e.entries.length;o++){const l=e.entries[o],f=`sub-entry-${l.id}`;i.add(f);let d=this.visibleItems.get(f);d||(d=this.createSubEntryItem(l,f),this.visibleItems.set(f,d),this.contentContainer.appendChild(d)),d.style.transform=`translateY(${r}px)`,r+=Pe}for(let o=0;o<e.faults.length;o++){const l=e.faults[o],f=`sub-fault-${l.id}`;i.add(f);let d=this.visibleItems.get(f);d||(d=this.createSubFaultItem(l,f),this.visibleItems.set(f,d),this.contentContainer.appendChild(d)),d.style.transform=`translateY(${r}px)`,r+=Pe}}createGroupHeader(e,t){const i=document.createElement("div");i.className=`result-group-header ${t?"expanded":""}`,i.setAttribute("data-group-id",e.id),i.setAttribute("role","button"),i.setAttribute("tabindex","0"),i.setAttribute("aria-expanded",String(t)),i.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${Ne}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 4px;
      gap: 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    `;const s=mn(e.bib||"---"),r=c.getState().currentLang,o=tt(e.run),l=et(e.run,r),f=e.entries.length,d=e.faults.length,g=d>0,m=[];f>0&&m.push(`${f} ${u(f===1?"timeEntry":"timeEntries",r)}`),d>0&&m.push(`${d} ${u(d===1?"faultEntry":"faultEntries",r)}`);const p=m.join(", ");i.innerHTML=`
      ${Ko(16,t)}
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 44px; text-align: right;">
        ${T(s)}
      </div>
      <div style="min-width: 48px;"></div>
      ${vn(l,o)}
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0;">
        <div class="result-summary" style="font-size: 0.875rem; color: var(--text-secondary);">
          ${T(p)}
        </div>
      </div>
      ${e.crossDeviceDuplicateCount>0?Ni(r):""}
      ${g?`<span class="result-fault-badge" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">
          ${d}× ${u("flt",r)}
        </span>`:""}
    `;const b=`header-${e.id}`,w={};return w.click=()=>{this.toggleGroup(e.id)},i.addEventListener("click",w.click),w.keydown=S=>{switch(S.key){case"Enter":case" ":S.preventDefault(),this.toggleGroup(e.id);break;case"ArrowDown":S.preventDefault(),this.focusNextItem(i);break;case"ArrowUp":S.preventDefault(),this.focusPreviousItem(i);break}},i.addEventListener("keydown",w.keydown),w.touchstart=()=>{i.style.background="var(--surface-elevated)"},i.addEventListener("touchstart",w.touchstart,{passive:!0}),w.touchend=()=>{i.style.background="var(--surface)"},i.addEventListener("touchend",w.touchend,{passive:!0}),this.itemListeners.set(b,w),i}createEntryItem(e,t,i,s=0){const a=document.createElement("div");a.className="result-item",a.setAttribute("role","listitem"),a.setAttribute("tabindex","0"),a.setAttribute("data-entry-id",e.id),a.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${Be}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 4px;
      gap: 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    `;const r=new Date(e.timestamp),o=we(r),l=mn(e.bib||"---"),d=c.getState().currentLang,g=st(e.point),m=Ie(e.point,d),p=e.run??1,b=tt(p),w=et(p,d),S=t.length>0?Fi({faults:t,lang:d}):"",E=s>0?Ni(d):"";a.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 44px; text-align: right;">
        ${T(l)}
      </div>
      ${wt(m,g)}
      ${vn(w,b)}
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0;">
        <div class="result-time" style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); font-size: 0.875rem;">
          ${T(o)}
        </div>
        ${e.deviceName?`
          <div class="result-device" style="font-size: 0.7rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${T(e.deviceName)}
          </div>
        `:""}
      </div>
      ${E}
      ${S}
      ${e.status!=="ok"?bn(e.status.toUpperCase()):""}
      ${e.photo?tc(u("viewPhotoLabel",d)):""}
      ${St({ariaLabel:u("editEntryLabel",d)})}
      ${Et({ariaLabel:u("deleteEntryLabel",d)})}
    `;const C={},F=a.querySelector(".result-edit-btn");C.editBtn=F,C.editClick=L=>{var D,B;L.stopPropagation(),(B=(D=this.options).onItemClick)==null||B.call(D,e,L)},F.addEventListener("click",C.editClick);const V=a.querySelector(".result-delete");C.deleteBtn=V,C.deleteClick=L=>{var D,B;L.stopPropagation(),(B=(D=this.options).onItemDelete)==null||B.call(D,e)},V.addEventListener("click",C.deleteClick);const A=a.querySelector(".result-photo-btn");return A&&(C.photoBtn=A,C.photoClick=L=>{var D,B;L.stopPropagation(),(B=(D=this.options).onViewPhoto)==null||B.call(D,e)},A.addEventListener("click",C.photoClick)),C.click=L=>{var D,B;(B=(D=this.options).onItemClick)==null||B.call(D,e,L)},a.addEventListener("click",C.click),C.touchstart=()=>{a.style.background="var(--surface-elevated)"},a.addEventListener("touchstart",C.touchstart,{passive:!0}),C.touchend=()=>{a.style.background="var(--surface)"},a.addEventListener("touchend",C.touchend,{passive:!0}),C.keydown=L=>{var B,re,mt,pt,mi,pi;const D=L;switch(D.key){case"Enter":case" ":D.preventDefault(),(re=(B=this.options).onItemClick)==null||re.call(B,e,new MouseEvent("click"));break;case"e":case"E":D.preventDefault(),(pt=(mt=this.options).onItemClick)==null||pt.call(mt,e,new MouseEvent("click"));break;case"Delete":case"d":case"D":D.preventDefault(),(pi=(mi=this.options).onItemDelete)==null||pi.call(mi,e);break;case"ArrowDown":D.preventDefault(),this.focusNextItem(a);break;case"ArrowUp":D.preventDefault(),this.focusPreviousItem(a);break}},a.addEventListener("keydown",C.keydown),this.itemListeners.set(i,C),a}createFaultOnlyItem(e,t){var V;const i=document.createElement("div"),s=e.faults,a=s.some(A=>A.markedForDeletion);i.className=`result-item fault-only-item${a?" marked-for-deletion":""}`,i.setAttribute("role","listitem"),i.setAttribute("tabindex","0"),i.setAttribute("data-fault-id",e.id),i.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${Be}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 4px;
      gap: 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      border-left: 3px solid ${a?"var(--error)":"var(--warning)"};
      ${a?"opacity: 0.6;":""}
      cursor: pointer;
    `;const r=mn(e.bib||"---"),o=c.getState(),l=o.currentLang,f=tt(e.run),d=et(e.run,l),g=s.sort((A,L)=>A.gateNumber-L.gateNumber).map(A=>`T${A.gateNumber} (${pe(A.faultType,l)})${A.markedForDeletion?" ⚠":""}`).join(", "),m=Fi({faults:s,lang:l}),p=o.usePenaltyMode?u("flt",l):u("dsq",l),b=o.usePenaltyMode?"var(--warning)":"var(--error)",w=b==="var(--warning)"?"#000":"white",S=a?$i():"";i.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 44px; text-align: right; ${a?"text-decoration: line-through; opacity: 0.6;":""}">
        ${T(r)}
      </div>
      ${wt(u("gate",l),"var(--warning)")}
      ${vn(d,f)}
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0;">
        <div class="result-fault-details" style="font-size: 0.8rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ${a?"text-decoration: line-through; opacity: 0.6;":""}">
          ${T(g)}
        </div>
        ${(V=s[0])!=null&&V.deviceName?`
          <div class="result-device" style="font-size: 0.7rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${T(s[0].deviceName)}
          </div>
        `:""}
      </div>
      ${S}
      ${a?"":m}
      ${a?"":bn(p,b,w)}
      ${St({ariaLabel:u("editFaultLabel",l)})}
      ${Et({ariaLabel:u("deleteFaultLabel",l),className:"result-delete fault-delete-btn"})}
    `;const E={},C=i.querySelector(".result-edit-btn");C&&s.length>0&&(E.editBtn=C,E.editClick=A=>{A.stopPropagation();const L=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:s[0]}});i.dispatchEvent(L)},C.addEventListener("click",E.editClick));const F=i.querySelector(".fault-delete-btn");return F&&s.length>0&&(E.deleteBtn=F,E.deleteClick=A=>{A.stopPropagation();const L=new CustomEvent("fault-delete-request",{bubbles:!0,detail:{fault:s[0]}});i.dispatchEvent(L)},F.addEventListener("click",E.deleteClick)),E.click=A=>{const L=A.target;if(!(L.closest(".fault-delete-btn")||L.closest(".result-edit-btn"))&&s.length>0){const D=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:s[0]}});i.dispatchEvent(D)}},i.addEventListener("click",E.click),E.touchstart=()=>{i.style.background="var(--surface-elevated)"},i.addEventListener("touchstart",E.touchstart,{passive:!0}),E.touchend=()=>{i.style.background="var(--surface)"},i.addEventListener("touchend",E.touchend,{passive:!0}),E.keydown=A=>{const L=A;switch(L.key){case"Enter":case" ":case"e":case"E":if(L.preventDefault(),s.length>0){const D=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:s[0]}});i.dispatchEvent(D)}break;case"Delete":case"d":case"D":if(L.preventDefault(),s.length>0){const D=new CustomEvent("fault-delete-request",{bubbles:!0,detail:{fault:s[0]}});i.dispatchEvent(D)}break;case"ArrowDown":L.preventDefault(),this.focusNextItem(i);break;case"ArrowUp":L.preventDefault(),this.focusPreviousItem(i);break}},i.addEventListener("keydown",E.keydown),this.itemListeners.set(t,E),i}createSubEntryItem(e,t){const i=document.createElement("div");i.className="result-sub-item entry-sub-item",i.setAttribute("role","listitem"),i.setAttribute("tabindex","0"),i.setAttribute("data-entry-id",e.id),i.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${Pe}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 24px;
      gap: 8px;
      background: var(--surface-elevated);
      border-bottom: 1px solid var(--background);
      cursor: pointer;
      transition: background 0.2s;
    `;const s=new Date(e.timestamp),a=we(s),o=c.getState().currentLang,l=st(e.point),f=Ie(e.point,o);i.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div style="min-width: 44px;"></div>
      ${wt(f,l,"48px","0.7rem")}
      <div style="min-width: 36px;"></div>
      <div class="result-info" style="flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0;">
        <div class="result-time" style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); font-size: 0.85rem;">
          ${T(a)}
        </div>
        ${e.deviceName?`
          <div class="result-device" style="font-size: 0.65rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${T(e.deviceName)}
          </div>
        `:""}
      </div>
      ${e.status!=="ok"?bn(e.status.toUpperCase(),"var(--error)","white","0.65rem"):""}
      ${St({ariaLabel:u("editEntryLabel",o),size:16})}
      ${Et({ariaLabel:u("deleteEntryLabel",o),size:16})}
    `;const d={},g=i.querySelector(".result-edit-btn");d.editBtn=g,d.editClick=p=>{var b,w;p.stopPropagation(),(w=(b=this.options).onItemClick)==null||w.call(b,e,p)},g.addEventListener("click",d.editClick);const m=i.querySelector(".result-delete");return d.deleteBtn=m,d.deleteClick=p=>{var b,w;p.stopPropagation(),(w=(b=this.options).onItemDelete)==null||w.call(b,e)},m.addEventListener("click",d.deleteClick),d.click=p=>{var b,w;(w=(b=this.options).onItemClick)==null||w.call(b,e,p)},i.addEventListener("click",d.click),d.touchstart=()=>{i.style.background="var(--surface)"},i.addEventListener("touchstart",d.touchstart,{passive:!0}),d.touchend=()=>{i.style.background="var(--surface-elevated)"},i.addEventListener("touchend",d.touchend,{passive:!0}),d.keydown=p=>{var w,S,E,C;const b=p;switch(b.key){case"Enter":case" ":case"e":case"E":b.preventDefault(),(S=(w=this.options).onItemClick)==null||S.call(w,e,new MouseEvent("click"));break;case"Delete":case"d":case"D":b.preventDefault(),(C=(E=this.options).onItemDelete)==null||C.call(E,e);break;case"ArrowDown":b.preventDefault(),this.focusNextItem(i);break;case"ArrowUp":b.preventDefault(),this.focusPreviousItem(i);break}},i.addEventListener("keydown",d.keydown),this.itemListeners.set(t,d),i}createSubFaultItem(e,t){const i=document.createElement("div"),s=e.markedForDeletion;i.className=`result-sub-item fault-sub-item${s?" marked-for-deletion":""}`,i.setAttribute("role","listitem"),i.setAttribute("tabindex","0"),i.setAttribute("data-fault-id",e.id),i.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${Pe}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 24px;
      gap: 8px;
      background: var(--surface-elevated);
      border-bottom: 1px solid var(--background);
      border-left: 3px solid ${s?"var(--error)":"var(--warning)"};
      ${s?"opacity: 0.6;":""}
      cursor: pointer;
      transition: background 0.2s;
    `;const r=c.getState().currentLang,o=c.getGateColor(e.gateNumber),l=o==="red"?"#ef4444":"#3b82f6";i.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div style="min-width: 44px;"></div>
      ${wt(`T${e.gateNumber}`,"var(--warning)","48px","0.7rem")}
      <div style="min-width: 36px; display: flex; align-items: center; justify-content: center;">
        <div style="width: 8px; height: 8px; border-radius: 50%; background: ${l};" title="${o}"></div>
      </div>
      <div class="result-info" style="flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0;">
        <span style="font-size: 0.85rem; color: var(--text-secondary); ${s?"text-decoration: line-through;":""}">
          ${T(pe(e.faultType,r))}
        </span>
        ${e.deviceName?`
          <span style="font-size: 0.65rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${T(e.deviceName)}
          </span>
        `:""}
      </div>
      ${s?$i("0.65rem"):""}
      ${St({ariaLabel:u("editFaultLabel",r),size:16})}
      ${Et({ariaLabel:u("deleteFaultLabel",r),size:16,className:"result-delete fault-delete-btn"})}
    `;const f={},d=i.querySelector(".result-edit-btn");f.editBtn=d,f.editClick=m=>{m.stopPropagation();const p=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:e}});i.dispatchEvent(p)},d.addEventListener("click",f.editClick);const g=i.querySelector(".fault-delete-btn");return f.deleteBtn=g,f.deleteClick=m=>{m.stopPropagation();const p=new CustomEvent("fault-delete-request",{bubbles:!0,detail:{fault:e}});i.dispatchEvent(p)},g.addEventListener("click",f.deleteClick),f.click=()=>{const m=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:e}});i.dispatchEvent(m)},i.addEventListener("click",f.click),f.touchstart=()=>{i.style.background="var(--surface)"},i.addEventListener("touchstart",f.touchstart,{passive:!0}),f.touchend=()=>{i.style.background="var(--surface-elevated)"},i.addEventListener("touchend",f.touchend,{passive:!0}),f.keydown=m=>{const p=m;switch(p.key){case"Enter":case" ":case"e":case"E":p.preventDefault();{const b=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:e}});i.dispatchEvent(b)}break;case"Delete":case"d":case"D":p.preventDefault();{const b=new CustomEvent("fault-delete-request",{bubbles:!0,detail:{fault:e}});i.dispatchEvent(b)}break;case"ArrowDown":p.preventDefault(),this.focusNextItem(i);break;case"ArrowUp":p.preventDefault(),this.focusPreviousItem(i);break}},i.addEventListener("keydown",f.keydown),this.itemListeners.set(t,f),i}renderEmpty(){for(const t of this.visibleItems.values())t.remove();this.visibleItems.clear();const e=c.getState();this.contentContainer.innerHTML=`
      <div class="empty-state">
        <span class="empty-icon">⏱️</span>
        <span>${u("noEntries",e.currentLang)}</span>
        <span class="empty-subtitle">${u("noEntriesHint",e.currentLang)}</span>
      </div>
    `}pause(){this.isPaused=!0}resume(){this.isPaused=!1,this.needsRefreshOnResume&&(this.needsRefreshOnResume=!1,this.render())}scrollToTop(){this.scrollContainer.scrollTo({top:0,behavior:"smooth"})}scrollToEntry(e){const t=String(e),i=this.groups.find(a=>a.entries.some(r=>r.id===t));if(!i)return;let s=0;for(const a of this.groups){if(a.id===i.id)break;s+=this.getGroupHeight(a)}i.isMultiItem&&(this.expandedGroups.add(i.id),this.isPaused?this.needsRefreshOnResume=!0:this.render()),this.isPaused||this.scrollContainer.scrollTo({top:s,behavior:"smooth"})}getVisibleCount(){return this.groups.reduce((e,t)=>e+t.entries.length,0)}getSortedFocusableItems(){const e=Array.from(this.visibleItems.values());return e.sort((t,i)=>{const s=this.getItemYPosition(t),a=this.getItemYPosition(i);return s-a}),e}focusNextItem(e){const t=this.getSortedFocusableItems(),i=t.indexOf(e);i>=0&&i<t.length-1&&t[i+1].focus()}focusPreviousItem(e){const t=this.getSortedFocusableItems(),i=t.indexOf(e);i>0&&t[i-1].focus()}getItemYPosition(e){const i=e.style.transform.match(/translateY\((\d+)px\)/);return i?parseInt(i[1],10):0}cleanupItemListeners(e,t){const i=this.itemListeners.get(e);i&&(i.click&&t.removeEventListener("click",i.click),i.keydown&&t.removeEventListener("keydown",i.keydown),i.touchstart&&t.removeEventListener("touchstart",i.touchstart),i.touchend&&t.removeEventListener("touchend",i.touchend),i.editBtn&&i.editClick&&i.editBtn.removeEventListener("click",i.editClick),i.deleteBtn&&i.deleteClick&&i.deleteBtn.removeEventListener("click",i.deleteClick),i.photoBtn&&i.photoClick&&i.photoBtn.removeEventListener("click",i.photoClick),this.itemListeners.delete(e))}destroy(){if(!this.isDestroyed){this.isDestroyed=!0,this.domRemovalObserver&&(this.domRemovalObserver.disconnect(),this.domRemovalObserver=null),this.scrollHandler&&(this.scrollContainer.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null),this.scrollDebounceTimeout!==null&&(clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=null),this.resizeDebounceTimeout!==null&&(clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null);for(const[e,t]of this.visibleItems)this.cleanupItemListeners(e,t);this.visibleItems.clear(),this.itemListeners.clear(),this.scrollContainer.remove()}}}const mc="modulepreload",pc=function(n){return"/"+n},Hi={},yc=function(e,t,i){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),o=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=Promise.allSettled(t.map(l=>{if(l=pc(l),l in Hi)return;Hi[l]=!0;const f=l.endsWith(".css"),d=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${d}`))return;const g=document.createElement("link");if(g.rel=f?"stylesheet":mc,f||(g.as="script"),g.crossOrigin="",g.href=l,o&&g.setAttribute("nonce",o),document.head.appendChild(g),f)return new Promise((m,p)=>{g.addEventListener("load",m),g.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${l}`)))})}))}function a(r){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=r,window.dispatchEvent(o),!o.defaultPrevented)throw r}return s.then(r=>{for(const o of r||[])o.status==="rejected"&&a(o.reason);return e().catch(a)})};class G{constructor(){h(this,"listeners",[])}add(e,t,i,s){e.addEventListener(t,i,s),this.listeners.push([e,t,i,s])}removeAll(){for(const[e,t,i,s]of this.listeners)e.removeEventListener(t,i,s);this.listeners=[]}get count(){return this.listeners.length}}const ti=new WeakMap;function Ze(n,e){ti.set(n,e)}function Qe(n){return ti.get(n)??null}function bc(n){ti.delete(n)}const vc=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(","),Jt=new WeakMap;function hs(n){return Array.from(n.querySelectorAll(vc)).filter(e=>!e.hasAttribute("disabled")&&e.tabIndex!==-1)}function Sc(n){const e=hs(n);if(e.length>0){e[0].focus();return}n.hasAttribute("tabindex")||n.setAttribute("tabindex","-1"),n.focus()}function Ec(n){const e=t=>{if(t.key==="Escape"){M(n);return}if(t.key!=="Tab")return;const i=hs(n);if(i.length===0){t.preventDefault();return}const s=i[0],a=i[i.length-1],r=document.activeElement;if(t.shiftKey){(!r||r===s||r===n)&&(t.preventDefault(),a.focus());return}r===a&&(t.preventDefault(),s.focus())};n.addEventListener("keydown",e),Jt.set(n,{previousFocus:document.activeElement,keydownHandler:e})}function wc(n){const e=Jt.get(n);if(!e)return;n.removeEventListener("keydown",e.keydownHandler),Jt.delete(n);const t=e.previousFocus;t&&typeof t.focus=="function"&&t.focus()}function M(n){!n||!n.classList.contains("show")||(n.classList.add("closing"),setTimeout(()=>{n.classList.remove("show","closing"),wc(n)},150))}function O(n){if(!n)return;n.hasAttribute("role")||n.setAttribute("role","dialog"),n.setAttribute("aria-modal","true");const e=n.classList.contains("show");n.classList.add("show"),Jt.has(n)||Ec(n),e||setTimeout(()=>Sc(n),0)}function Ic(){document.querySelectorAll(".modal-overlay.show").forEach(n=>{M(n)})}function ms(){return document.querySelectorAll(".modal-overlay.show").length>0}const Fe=new G;let U=null;function ni(n,e,t){const i=c.getState(),s={id:`fault-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,bib:n,run:i.selectedRun,gateNumber:e,faultType:t,timestamp:new Date().toISOString(),deviceId:i.deviceId,deviceName:i.deviceName,gateRange:i.gateAssignment||[1,1]};c.addFaultEntry(s),z();const a=c.getState().faultEntries.find(r=>r.id===s.id);a&&(Ke(a),kc(a)),I(u("faultRecorded",i.currentLang),"success")}function kc(n){const e=document.getElementById("fault-confirmation-overlay");if(!e)return;Ze(e,{faultId:n.id});const t=e.querySelector(".fault-confirmation-bib"),i=e.querySelector(".fault-confirmation-gate"),s=e.querySelector(".fault-confirmation-type"),a=c.getState();t&&(t.textContent=n.bib),i&&(i.textContent=`${u("gate",a.currentLang)} ${n.gateNumber}`),s&&(s.textContent=pe(n.faultType,a.currentLang)),e.classList.add("show")}function Cc(){const n=document.getElementById("save-fault-edit-btn");n&&Fe.add(n,"click",Tc);const e=document.getElementById("restore-version-btn");e&&Fe.add(e,"click",Lc);const t=document.getElementById("fault-edit-bib-input");t&&tn(t,3);const i=document.getElementById("fault-edit-run-selector");i&&Fe.add(i,"click",l=>{const d=l.target.closest(".edit-run-btn");d&&i.querySelectorAll(".edit-run-btn").forEach(g=>{g.classList.toggle("active",g===d),g.setAttribute("aria-checked",g===d?"true":"false")})});const s=document.getElementById("fault-edit-notes"),a=document.getElementById("fault-edit-notes-char-count");s&&a&&Fe.add(s,"input",()=>{const l=s.value.length;a.textContent=`${l}/500`,a.classList.toggle("near-limit",l>450)});const r=document.getElementById("fault-edit-mic-btn");r&&Fe.add(r,"click",()=>{window.dispatchEvent(new CustomEvent("fault-edit-mic-click",{detail:{faultId:U}}))});const o=document.getElementById("confirm-mark-deletion-btn");o&&Fe.add(o,"click",Ac)}function ps(n){if(n.markedForDeletion){const m=c.getState().currentLang;I(u("cannotEditPendingDeletion",m),"warning");return}const e=document.getElementById("fault-edit-modal");if(!e)return;U=n.id;const i=c.getState().currentLang,s=document.getElementById("fault-edit-bib-input"),a=document.getElementById("fault-edit-gate-input"),r=document.getElementById("fault-edit-type-select"),o=document.getElementById("fault-edit-gate-range"),l=document.getElementById("fault-version-select"),f=document.getElementById("fault-edit-notes"),d=document.getElementById("fault-edit-notes-char-count");if(s&&(s.value=n.bib||""),a&&(a.value=String(n.gateNumber)),r&&(r.value=n.faultType),f&&(f.value=n.notes||""),d){const m=(n.notes||"").length;d.textContent=`${m}/500`}o&&n.gateRange&&(o.textContent=`(${u("gates",i)} ${n.gateRange[0]}-${n.gateRange[1]})`);const g=document.getElementById("fault-edit-run-selector");if(g&&g.querySelectorAll(".edit-run-btn").forEach(m=>{const p=m.getAttribute("data-run");m.classList.toggle("active",p===String(n.run))}),l){l.innerHTML="";const m=document.createElement("option");m.value=String(n.currentVersion||1),m.textContent=`v${n.currentVersion||1} - ${u("currentVersion",i)}`,l.appendChild(m);const b=[...n.versionHistory||[]].sort((w,S)=>S.version-w.version).filter(w=>w.version!==n.currentVersion);for(const w of b){const S=document.createElement("option");S.value=String(w.version);const C=new Date(w.timestamp).toLocaleTimeString(i==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"}),F=w.changeType==="create"?u("originalVersion",i):w.changeType==="restore"?u("restored",i):w.editedBy;S.textContent=`v${w.version} - ${F} (${C})`,l.appendChild(S)}}O(e)}function Tc(){if(!U)return;const n=c.getState(),e=n.faultEntries.find(C=>C.id===U);if(!e)return;const t=document.getElementById("fault-edit-bib-input"),i=document.getElementById("fault-edit-gate-input"),s=document.getElementById("fault-edit-type-select"),a=document.getElementById("fault-edit-run-selector"),r=document.getElementById("fault-edit-notes"),o=(t==null?void 0:t.value.padStart(3,"0"))||e.bib,l=parseInt((i==null?void 0:i.value)||String(e.gateNumber),10),f=(s==null?void 0:s.value)||e.faultType,d=(r==null?void 0:r.value.trim().slice(0,500))||"",g=n.currentLang;e.gateRange&&(l<e.gateRange[0]||l>e.gateRange[1])&&I(u("gateOutOfRange",g),"warning");const m=a==null?void 0:a.querySelector(".edit-run-btn.active"),p=m?parseInt(m.getAttribute("data-run")||"1",10):e.run,b=[];if(o!==e.bib&&b.push(`bib: ${e.bib} → ${o}`),l!==e.gateNumber&&b.push(`gate: ${e.gateNumber} → ${l}`),f!==e.faultType&&b.push(`type: ${e.faultType} → ${f}`),p!==e.run&&b.push(`run: ${e.run} → ${p}`),d!==(e.notes||"")){const C=d?`notes: ${d.slice(0,30)}${d.length>30?"...":""}`:"notes removed";b.push(C)}const w=b.length>0?b.join(", "):void 0,S={bib:o,gateNumber:l,faultType:f,run:p};if(d!==(e.notes||"")&&(S.notes=d||void 0,S.notesSource=d?"manual":void 0,S.notesTimestamp=d?new Date().toISOString():void 0),c.updateFaultEntryWithHistory(U,S,w)){const C=c.getState().faultEntries.find(F=>F.id===U);C&&Ke(C),I(u("saved",g),"success"),q()}M(document.getElementById("fault-edit-modal")),U=null}function Lc(){if(!U)return;const n=document.getElementById("fault-version-select"),e=parseInt((n==null?void 0:n.value)||"0",10);if(!e)return;const t=c.getState(),i=t.faultEntries.find(a=>a.id===U);if(i&&e===i.currentVersion)return;if(c.restoreFaultVersion(U,e)){const a=c.getState().faultEntries.find(o=>o.id===U);a&&Ke(a);const r=t.currentLang;I(u("versionRestored",r),"success"),q(),M(document.getElementById("fault-edit-modal")),U=null}}function ys(n){const e=document.getElementById("mark-deletion-modal");if(!e)return;U=n.id;const i=c.getState().currentLang,s=document.getElementById("mark-deletion-details");s&&(s.innerHTML=`
      <div>#${T(n.bib.padStart(3,"0"))} T${T(String(n.gateNumber))} (${T(pe(n.faultType,i))}) - ${T(u(n.run===1?"run1":"run2",i))}</div>
    `),O(e)}function Ac(){if(!U)return;if(c.markFaultForDeletion(U)){const e=c.getState().faultEntries.find(i=>i.id===U);e&&Ke(e);const t=c.getState().currentLang;I(u("markedForDeletion",t),"info"),k()}M(document.getElementById("mark-deletion-modal")),U=null}const $e=new G;let de="",he=0,Ue=null;function Se(){const n=document.getElementById("active-bibs-list"),e=document.getElementById("no-active-bibs");if(!n)return;const t=c.getState(),i=c.getActiveBibs(t.selectedRun);if(n.querySelectorAll(".active-bib-card").forEach(r=>r.remove()),i.length===0){e&&(e.style.display="");return}e&&(e.style.display="none");const s=new Map;t.entries.forEach(r=>{r.point==="S"&&r.run===t.selectedRun&&s.set(r.bib,new Date(r.timestamp))}),[...i].sort((r,o)=>{var d,g;const l=((d=s.get(r))==null?void 0:d.getTime())||0;return(((g=s.get(o))==null?void 0:g.getTime())||0)-l}).forEach(r=>{const o=s.get(r),l=c.getFaultsForBib(r,t.selectedRun),f=l.length>0,d=document.createElement("div");d.className=`active-bib-card${f?" has-fault":""}`,d.setAttribute("data-bib",T(r)),d.setAttribute("role","listitem");const g=o?we(o):"--:--:--";d.innerHTML=`
      <div class="bib-card-info">
        <span class="bib-card-number">${T(r)}</span>
        <span class="bib-card-time">${T(g)}</span>
        ${f?`<span class="bib-fault-indicator">${l.length} ${u("faultCount",t.currentLang)}</span>`:""}
      </div>
      <div class="bib-card-actions">
        <button class="bib-action-btn fault" data-action="fault" aria-label="${R(u("recordFault",t.currentLang))}">${u("faultMGShort",t.currentLang)}</button>
        <button class="bib-action-btn ok" data-action="ok" aria-label="${R(u("markOk",t.currentLang))}">${u("ok",t.currentLang)}</button>
      </div>
    `,d.addEventListener("click",m=>{const b=m.target.closest(".bib-action-btn");if(b){const w=b.getAttribute("data-action");w==="fault"?(k(),yc(async()=>{const{openFaultRecordingModal:S}=await Promise.resolve().then(()=>$c);return{openFaultRecordingModal:S}},void 0).then(({openFaultRecordingModal:S})=>{S(r)})):w==="ok"&&(k(),I(u("ok",t.currentLang),"success",1e3))}}),n.appendChild(d)})}function on(){const n=document.getElementById("gate-judge-faults-list"),e=document.getElementById("inline-fault-count"),t=document.getElementById("no-faults-recorded-inline");if(!n)return;const i=c.getState(),s=i.currentLang,a=i.faultEntries.filter(o=>o.run===i.selectedRun&&!o.markedForDeletion);if(e&&(e.textContent=String(a.length),e.setAttribute("data-count",String(a.length))),n.querySelectorAll(".gate-judge-fault-item").forEach(o=>o.remove()),a.length===0){t&&(t.style.display="");return}t&&(t.style.display="none"),[...a].sort((o,l)=>new Date(l.timestamp).getTime()-new Date(o.timestamp).getTime()).forEach(o=>{const l=c.getGateColor(o.gateNumber),f=o.notes&&o.notes.length>0,d=document.createElement("div");d.className="gate-judge-fault-item",d.setAttribute("data-fault-id",o.id),d.innerHTML=`
      <div class="gate-judge-fault-info">
        <span class="gate-judge-fault-bib">${T(o.bib)}</span>
        <div class="gate-judge-fault-details">
          <span class="gate-judge-fault-gate ${T(l)}">T${T(String(o.gateNumber))}</span>
          <span class="gate-judge-fault-type">${T(pe(o.faultType,s))}</span>
          ${f?`<span class="gate-judge-fault-note-icon" title="${R(u("hasNote",s))}" aria-label="${R(u("hasNote",s))}">📝</span>`:""}
        </div>
      </div>
      <button class="gate-judge-fault-delete" aria-label="${u("deleteLabel",s)}">
        ${Xn(18)}
      </button>
    `;const g=d.querySelector(".gate-judge-fault-delete");g&&g.addEventListener("click",m=>{m.stopPropagation(),k(),Nc(o)}),n.appendChild(d)})}function bs(){const n=c.getState(),e=c.getActiveBibs(n.selectedRun);!de&&e.length>0&&(de=e[0]);const t=document.getElementById("inline-bib-input");t&&de&&(t.value=de),Ee()}function Rc(n){de=n;const e=document.getElementById("inline-bib-input");e&&(e.value=n),Ee()}function vs(){const n=document.getElementById("inline-gate-selector");if(!n)return;const e=c.getState(),t=e.currentLang,[i,s]=e.gateAssignment||[1,10];n.innerHTML="";const a=new Map;e.faultEntries.forEach(r=>{r.run===e.selectedRun&&!r.markedForDeletion&&a.set(r.gateNumber,(a.get(r.gateNumber)||0)+1)});for(let r=i;r<=s;r++){const o=c.getGateColor(r),l=a.get(r)||0,f=document.createElement("button");if(f.className=`gate-grid-btn ${o}`,f.setAttribute("data-gate",String(r)),f.setAttribute("role","radio"),f.setAttribute("aria-checked",String(r===he)),f.setAttribute("aria-label",`${u("gateNumberLabel",t)} ${r}${l?` (${l})`:""}`),f.textContent=String(r),l>0){const d=document.createElement("span");d.className="gate-fault-count",d.textContent=String(l),d.setAttribute("aria-hidden","true"),f.appendChild(d)}r===he&&f.classList.add("selected"),f.addEventListener("click",()=>{k(),Sn(r)}),f.addEventListener("keydown",d=>{const g=Array.from(n.querySelectorAll(".gate-grid-btn")),m=g.indexOf(f);switch(d.key){case" ":case"Enter":d.preventDefault(),k(),Sn(r);break;case"ArrowLeft":d.preventDefault(),m>0&&g[m-1].focus();break;case"ArrowRight":d.preventDefault(),m<g.length-1&&g[m+1].focus();break;case"ArrowUp":d.preventDefault(),m>=5&&g[m-5].focus();break;case"ArrowDown":d.preventDefault(),m+5<g.length&&g[m+5].focus();break;default:if(/^[0-9]$/.test(d.key)){d.preventDefault();const p=d.key==="0"?10:parseInt(d.key,10);if(p>=i&&p<=s){const b=n.querySelector(`[data-gate="${p}"]`);b&&(k(),Sn(p),b.focus())}}}}),n.appendChild(f)}}function Sn(n){if(he===n){he=0,Ss(),Ee(),document.querySelectorAll("#inline-gate-selector .gate-grid-btn").forEach(t=>{t.classList.remove("selected"),t.setAttribute("aria-checked","false")});return}he=n,document.querySelectorAll("#inline-gate-selector .gate-grid-btn").forEach(t=>{const i=t.getAttribute("data-gate")===String(n);t.classList.toggle("selected",i),t.setAttribute("aria-checked",String(i))}),Dc(n),de||xc(),Ee()}function Dc(n){const e=document.getElementById("fault-detail-panel"),t=document.getElementById("fault-detail-gate-label");if(!e)return;const s=c.getState().currentLang,a=c.getGateColor(n);t&&(t.textContent=`${u("gate",s)} ${n}`,t.style.color=a==="red"?"var(--error)":"var(--primary)"),e.style.display=""}function Ss(){const n=document.getElementById("fault-detail-panel");n&&(n.style.display="none")}function xc(){const n=c.getState(),e=c.getActiveBibs(n.selectedRun);if(e.length===0)return;const t=new Map;n.entries.forEach(s=>{s.point==="S"&&s.run===n.selectedRun&&t.set(s.bib,new Date(s.timestamp).getTime())});const i=[...e].sort((s,a)=>(t.get(a)||0)-(t.get(s)||0));Rc(i[0])}function Bc(){$e.removeAll();const n=document.getElementById("inline-bib-input");n&&(tn(n,3),$e.add(n,"input",()=>{n.value&&(de=n.value.padStart(3,"0"),Ee())}));const e=document.getElementById("fault-detail-close");e&&$e.add(e,"click",()=>{he=0,Ue=null,Ss(),document.querySelectorAll("#inline-gate-selector .gate-grid-btn").forEach(s=>{s.classList.remove("selected"),s.setAttribute("aria-checked","false")}),document.querySelectorAll("#inline-fault-types .inline-fault-type-btn").forEach(s=>{s.classList.remove("selected"),s.setAttribute("aria-pressed","false")}),Ee()});const t=document.getElementById("inline-fault-types");if(t){const s=a=>{k(),Ue=a.getAttribute("data-fault"),t.querySelectorAll(".inline-fault-type-btn").forEach(o=>{o.classList.toggle("selected",o===a),o.setAttribute("aria-pressed",String(o===a))}),Ee()};$e.add(t,"click",a=>{const o=a.target.closest(".inline-fault-type-btn");o&&s(o)}),$e.add(t,"keydown",a=>{const r=a,l=r.target.closest(".inline-fault-type-btn");if(l&&(r.key===" "||r.key==="Enter")){r.preventDefault(),s(l);return}const f=r.key.toUpperCase();let d=null;switch(f){case"M":case"G":d="MG";break;case"T":d="STR";break;case"B":case"R":d="BR";break}if(d){r.preventDefault();const g=t.querySelector(`[data-fault="${d}"]`);g&&(s(g),g.focus())}})}const i=document.getElementById("inline-save-fault-btn");i&&$e.add(i,"click",Pc)}function Ee(){const n=document.getElementById("inline-save-fault-btn");if(n){const e=de&&he>0&&Ue;n.disabled=!e}}function Pc(){const n=c.getState().currentLang;if(!de){I(u("selectBib",n),"warning");return}if(!he){I(u("selectGate",n),"warning");return}if(!Ue){I(u("selectFaultType",n),"warning");return}ni(de,he,Ue),Ue=null,document.querySelectorAll("#inline-fault-types .inline-fault-type-btn").forEach(e=>{e.classList.remove("selected"),e.setAttribute("aria-pressed","false")}),rt()}function Nc(n){const e=document.getElementById("fault-delete-modal");if(!e){c.markFaultForDeletion(n.id);const a=c.getState().faultEntries.find(r=>r.id===n.id);a&&Zn(a),on(),I(u("faultDeleted",c.getState().currentLang),"success");return}Ze(e,{faultId:n.id});const t=c.getState(),i=c.getGateColor(n.gateNumber),s=e.querySelector(".delete-fault-info");s&&(s.innerHTML=`
      <strong>#${T(n.bib)}</strong> -
      <span class="fault-gate ${i}">T${T(String(n.gateNumber))}</span>
      (${T(pe(n.faultType,t.currentLang))}) -
      ${u("run1",t.currentLang).replace("1",String(n.run))}
    `),O(e)}function rt(){on(),bs(),vs(),Ee()}const kt=new G;function Fc(n){const e=c.getState(),t=e.currentLang,i=c.getActiveBibs(e.selectedRun);kt.removeAll();const s=document.getElementById("fault-bib-selector");s&&(s.innerHTML=i.map(l=>`
      <button class="fault-bib-btn ${l===n?"selected":""}" data-bib="${R(l)}" aria-label="${R(u("selectBib",t))} ${R(l)}">${T(l)}</button>
    `).join(""),s.querySelectorAll(".fault-bib-btn").forEach(l=>{kt.add(l,"click",()=>{s.querySelectorAll(".fault-bib-btn").forEach(d=>d.classList.remove("selected")),l.classList.add("selected");const f=document.getElementById("fault-bib-input");f&&(f.value=""),c.setSelectedFaultBib(l.getAttribute("data-bib")||"")})}));const a=document.getElementById("fault-bib-input");a&&(a.value=n||"",kt.add(a,"input",()=>{s==null||s.querySelectorAll(".fault-bib-btn").forEach(l=>l.classList.remove("selected")),c.setSelectedFaultBib(a.value.padStart(3,"0"))})),c.setSelectedFaultBib(n||"");const r=document.getElementById("fault-gate-selector");if(r&&e.gateAssignment){const[l,f]=e.gateAssignment;let d="";for(let g=l;g<=f;g++){const p=c.getGateColor(g)==="red"?"gate-red":"gate-blue";d+=`<button class="fault-gate-btn ${p}" data-gate="${g}" aria-label="${R(u("gateNumberLabel",t))} ${g}">${g}</button>`}r.innerHTML=d,r.querySelectorAll(".fault-gate-btn").forEach(g=>{kt.add(g,"click",()=>{r.querySelectorAll(".fault-gate-btn").forEach(m=>m.classList.remove("selected")),g.classList.add("selected")})})}const o=document.getElementById("fault-type-buttons");o&&o.querySelectorAll(".fault-type-btn").forEach(l=>{l.classList.remove("selected")}),O(document.getElementById("fault-modal"))}const En=new G;function Es(){const n=document.getElementById("fault-type-buttons");if(n){const t=i=>{const s=n.querySelector(`[data-fault="${i}"]`);s&&(n.querySelectorAll(".fault-type-btn").forEach(a=>a.classList.remove("selected")),s.classList.add("selected"),k())};En.add(n,"click",i=>{const a=i.target.closest(".fault-type-btn");if(!a)return;const r=a.getAttribute("data-fault");r&&t(r)}),En.add(n,"keydown",i=>{const a=i.target.closest(".fault-type-btn");if(a&&(i.key===" "||i.key==="Enter")){i.preventDefault();const o=a.getAttribute("data-fault");o&&t(o);return}const r=i.key.toUpperCase();r==="M"||r==="G"?(i.preventDefault(),t("MG")):r==="T"?(i.preventDefault(),t("STR")):(r==="B"||r==="R")&&(i.preventDefault(),t("BR"))})}const e=document.getElementById("save-fault-btn");e&&En.add(e,"click",()=>{const t=document.querySelector("#fault-type-buttons .fault-type-btn.selected");if(!t){const s=c.getState().currentLang;I(u("selectFaultType",s),"warning");return}const i=t.getAttribute("data-fault");i&&ws(i)})}function ws(n){const e=c.getState();let t=e.selectedFaultBib;if(!t){const a=document.getElementById("fault-bib-input");t=(a==null?void 0:a.value.padStart(3,"0"))||""}if(!t){I(u("selectBib",e.currentLang),"warning");return}const i=document.querySelector("#fault-gate-selector .fault-gate-btn.selected"),s=i?parseInt(i.getAttribute("data-gate")||"0",10):0;if(!s){I(u("selectGate",e.currentLang),"warning");return}ni(t,s,n),M(document.getElementById("fault-modal")),Se()}function Is(n,e,t){const i=c.getState();if(i.gateAssignment){const[s,a]=i.gateAssignment;if(e<s||e>a){I(u("gateOutOfRange",i.currentLang),"warning");return}}ni(n.padStart(3,"0"),e,t),Se()}const $c=Object.freeze(Object.defineProperty({__proto__:null,initFaultRecordingModal:Es,openFaultRecordingModal:Fc,recordFault:ws,recordFaultFromVoice:Is},Symbol.toStringTag,{value:"Module"}));let jt=null;async function Mc(n){const e=document.getElementById("photo-viewer-modal");if(!e||!n.photo)return;jt=n.id;const t=document.getElementById("photo-viewer-image"),i=document.getElementById("photo-viewer-bib"),s=document.getElementById("photo-viewer-point"),a=document.getElementById("photo-viewer-time"),o=c.getState().currentLang;if(t){const l=Ie(n.point,o);if(t.alt=`${u("photoForBib",o)} ${n.bib||"---"} - ${l}`,n.photo==="indexeddb"){t.src="";const f=await Q.getPhoto(n.id);if(f)t.src=`data:image/jpeg;base64,${f}`;else{y.warn("Photo not found in IndexedDB for entry:",n.id);return}}else t.src=`data:image/jpeg;base64,${n.photo}`}if(i&&(i.textContent=n.bib||"---"),s){s.textContent=Ie(n.point,o);const l=st(n.point);s.style.background=l,s.style.color="var(--background)"}if(a){const l=new Date(n.timestamp);a.textContent=we(l)}O(e)}function Tt(){const n=document.getElementById("photo-viewer-modal");M(n),jt=null}async function Oc(){if(!jt)return;const n=c.getState(),e=jt;await Q.deletePhoto(e),c.updateEntry(e,{photo:void 0}),Tt(),I(u("photoDeleted",n.currentLang),"success"),an()}const _i=new G;let K=null;async function Qt(n,e){const t=await ls(n,e);return t.success&&ot(),t}async function Vc(){Ce()}function zi(n){return/^\d{4}$/.test(n)}function ot(){const n=c.getState().currentLang,e=Ce(),t=document.getElementById("admin-pin-status"),i=document.getElementById("change-pin-btn-text");t&&(t.textContent=u(e?"pinSet":"pinNotSet",n)),i&&(i.textContent=u(e?"changePin":"setPin",n))}function Hc(){const n=c.getState().currentLang,e=Ce(),t=document.getElementById("change-pin-modal"),i=document.getElementById("change-pin-modal-title"),s=document.getElementById("current-pin-row"),a=document.getElementById("current-pin-input"),r=document.getElementById("new-pin-input"),o=document.getElementById("confirm-pin-input");t&&(a&&(a.value=""),r&&(r.value=""),o&&(o.value=""),ks(),e?(s&&(s.style.display="block"),i&&(i.textContent=u("changePin",n))):(s&&(s.style.display="none"),i&&(i.textContent=u("setPin",n))),O(t),e&&a?a.focus():r&&r.focus())}function ks(){["current-pin-error","pin-mismatch-error","pin-format-error"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="none")})}async function _c(){const n=c.getState().currentLang,e=Ce(),t=document.getElementById("current-pin-input"),i=document.getElementById("new-pin-input"),s=document.getElementById("confirm-pin-input"),a=document.getElementById("save-pin-btn"),r=document.getElementById("current-pin-error"),o=document.getElementById("pin-mismatch-error"),l=document.getElementById("pin-format-error");ks();const f=(t==null?void 0:t.value)||"",d=(i==null?void 0:i.value)||"",g=(s==null?void 0:s.value)||"";if(!zi(d)){l&&(l.style.display="block"),i&&i.focus(),z();return}if(d!==g){o&&(o.style.display="block"),s&&(s.value="",s.focus()),z();return}if(e){if(!zi(f)){r&&(r.style.display="block"),t&&t.focus(),z();return}const m=(a==null?void 0:a.textContent)||"";a&&(a.disabled=!0,a.textContent=u("saving",n));try{const p=await fetch("/api/v1/admin/pin",{method:"POST",headers:{...ce(),"Content-Type":"application/json"},body:JSON.stringify({currentPin:f,newPin:d})});if(p.status===401){r&&(r.style.display="block"),t&&(t.value="",t.focus()),z();return}if(!p.ok)throw new Error(`HTTP ${p.status}`);if(cs(),!(await Qt(d)).success){I(u("pinSyncFailed",n),"error"),z();return}const w=document.getElementById("change-pin-modal");M(w),I(u("pinSaved",n),"success"),q(),ot()}catch(p){it("Admin","handleSavePin",p,"pinSyncFailed"),I(u("pinSyncFailed",n),"error"),z()}finally{a&&(a.disabled=!1,a.textContent=m)}}else{const m=(a==null?void 0:a.textContent)||"";a&&(a.disabled=!0,a.textContent=u("saving",n));try{if(!(await Qt(d)).success){I(u("pinSyncFailed",n),"error"),z();return}const b=document.getElementById("change-pin-modal");M(b),I(u("pinSaved",n),"success"),q(),ot()}finally{a&&(a.disabled=!1,a.textContent=m)}}}function Mn(n){return new Promise(e=>{if(Ce()){e(!0);return}const t=document.getElementById("admin-pin-modal"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),a=document.getElementById("admin-pin-verify-input"),r=document.getElementById("admin-pin-error");if(!t||!a){e(!1);return}i&&(i.textContent=u("enterAdminPin",n)),s&&(s.textContent=u("enterPinToJoinRace",n)),r&&(r.style.display="none"),a.value="",K={type:"raceJoin",resolve:e},O(t),setTimeout(()=>a.focus(),100)})}function zc(n){return new Promise(e=>{const t=document.getElementById("admin-pin-modal"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),a=document.getElementById("admin-pin-verify-input"),r=document.getElementById("admin-pin-error");if(!t||!a){e(!1);return}i&&(i.textContent=u("enterChiefJudgePin",n)),s&&(s.textContent=u("enterPinForChiefJudgeInfo",n)),r&&(r.style.display="none"),a.value="",K={type:"chiefJudge",resolve:e},O(t),setTimeout(()=>a.focus(),100)})}async function Ui(){const n=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),t=document.getElementById("admin-pin-modal");if(!n||!t||!K)return;const i=n.value.trim(),s=K.type==="chiefJudge"?"chiefJudge":void 0;(await Qt(i,s)).success?(M(t),n.value="",e&&(e.style.display="none"),K.resolve(!0),K=null):(e&&(e.style.display="block"),n.value="",n.focus(),z())}function Uc(){const n=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input");M(n),e&&(e.value=""),K&&(K.resolve(!1),K=null)}function Cs(){return K?(K.resolve(!1),K=null,!0):!1}function Lt(){return K!==null}function qc(){Vc().then(()=>{ot()}).catch(i=>{y.error("Failed to initialize admin PIN:",i)}),ot();const n=document.getElementById("change-pin-btn");n&&_i.add(n,"click",Hc);const e=document.getElementById("save-pin-btn");e&&_i.add(e,"click",_c),["admin-pin-verify-input","current-pin-input","new-pin-input","confirm-pin-input"].forEach(i=>{const s=document.getElementById(i);s&&tn(s)})}const wn=new G,Ts="/api/v1/admin/races";let At=null;function Gc(){const n=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input"),t=document.getElementById("admin-pin-error"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),a=c.getState().currentLang;n&&e&&t&&(e.value="",t.style.display="none",i&&(i.textContent=u("enterAdminPin",a)),s&&(s.textContent=u("enterPinText",a)),O(n),e.focus())}async function qi(){const n=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),t=document.getElementById("admin-pin-modal");if(!n||!t)return;const i=n.value.trim();(await Qt(i)).success?(M(t),n.value="",e&&(e.style.display="none"),Jc()):(e&&(e.style.display="block"),n.value="",n.focus(),z())}function Jc(){const n=document.getElementById("race-management-modal");n&&(O(n),ii())}async function ii(){const n=document.getElementById("race-list"),e=document.getElementById("race-list-loading"),t=document.getElementById("race-list-empty"),i=c.getState().currentLang;if(n){n.setAttribute("aria-busy","true"),e&&(e.style.display="block"),t&&(t.style.display="none"),n.querySelectorAll(".race-item").forEach(s=>s.remove());try{const s=await ae(Ts,{headers:ce()},1e4);if(!s.ok){if(s.status===401){const o=document.getElementById("race-management-modal");M(o),I(u("authError",i),"error"),y.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${s.status}`)}const r=(await s.json()).races||[];if(n.setAttribute("aria-busy","false"),e&&(e.style.display="none"),r.length===0){t&&(t.style.display="block");return}r.forEach(o=>{const l=jc(o,i);n.appendChild(l)})}catch(s){rn("Admin","loadRaceList",s,"loadError"),I(u("loadError",i),"error"),n.setAttribute("aria-busy","false"),e&&(e.style.display="none")}}}function jc(n,e){const t=document.createElement("div");t.className="race-item",t.setAttribute("data-race-id",n.raceId);const i=document.createElement("div");i.className="race-info";const s=document.createElement("span");s.className="race-id",s.textContent=n.raceId.toUpperCase();const a=document.createElement("span");a.className="race-meta";const r=n.entryCount===1?u("entry",e):u("entries",e),o=n.deviceCount===1?u("device",e):u("devices",e);a.textContent=`${n.entryCount} ${r}, ${n.deviceCount} ${o}`,i.appendChild(s),i.appendChild(a);const l=document.createElement("button");return l.className="race-delete-btn danger",l.textContent=u("delete",e),l.addEventListener("click",()=>Qc(n.raceId)),t.appendChild(i),t.appendChild(l),t}function Qc(n){const e=c.getState().currentLang;At=n;const t=document.getElementById("delete-race-confirm-modal"),i=document.getElementById("delete-race-confirm-text");i&&(i.textContent=`${u("confirmDeleteRaceText",e)} "${n.toUpperCase()}"?`),t&&O(t)}async function Wc(){if(!At)return;const n=At,e=c.getState().currentLang,t=document.getElementById("delete-race-confirm-modal");M(t);try{const i=await ae(`${Ts}?raceId=${encodeURIComponent(n)}`,{method:"DELETE",headers:ce()},1e4);if(!i.ok){if(i.status===401){const a=document.getElementById("race-management-modal");M(a),I(u("authError",e),"error"),y.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${i.status}`)}const s=await i.json();if(s.success)I(`${u("raceDeletedSuccess",e)} ${n.toUpperCase()}`,"success"),an(),ii();else throw new Error(s.error||u("unknownError",e))}catch(i){rn("Admin","deleteRace",i,"deleteError")}finally{At=null}}function Yc(){const n=document.getElementById("manage-races-btn");n&&wn.add(n,"click",Gc);const e=document.getElementById("refresh-races-btn");e&&wn.add(e,"click",ii);const t=document.getElementById("confirm-delete-race-btn");t&&wn.add(t,"click",Wc)}const Rt=new G;function Kc(n,e){return new Promise(t=>{const i=document.getElementById("race-change-modal");if(!i){t("cancel");return}const s=i.querySelector(".modal-title"),a=i.querySelector(".modal-text"),r=document.getElementById("race-change-export-btn"),o=document.getElementById("race-change-delete-btn"),l=document.getElementById("race-change-keep-btn"),f=i.querySelector('[data-action="cancel"]');n==="synced"?(s&&(s.textContent=u("raceChangeTitle",e)),a&&(a.textContent=u("raceChangeSyncedText",e)),r&&(r.style.display=""),l&&(l.style.display="none")):(s&&(s.textContent=u("raceChangeTitle",e)),a&&(a.textContent=u("raceChangeUnsyncedText",e)),r&&(r.style.display="none"),l&&(l.style.display=""));const d=()=>{M(i),r==null||r.removeEventListener("click",g),o==null||o.removeEventListener("click",m),l==null||l.removeEventListener("click",p),f==null||f.removeEventListener("click",b)},g=()=>{d(),t("export")},m=()=>{d(),t("delete")},p=()=>{d(),t("keep")},b=()=>{d(),t("cancel")};r==null||r.addEventListener("click",g),o==null||o.addEventListener("click",m),l==null||l.addEventListener("click",p),f==null||f.addEventListener("click",b),O(i)})}function Ls(n){const{raceId:e,message:t}=n.detail,i=c.getState().currentLang,s=document.getElementById("race-deleted-text");s&&(s.textContent=`${u("raceDeletedFor",i)} "${e}". ${t||u("raceDeletedText",i)}`);const a=document.getElementById("race-deleted-modal");a&&O(a),c.updateSettings({sync:!1}),c.setRaceId("");const r=document.getElementById("sync-toggle");r&&(r.checked=!1);const o=document.getElementById("race-id-input");o&&(o.value=""),z()}function As(n){const{message:e}=n.detail,t=c.getState().currentLang;I(e||u("sessionExpired",t),"warning",5e3),Mn(t).then(i=>{if(i){const s=c.getState();s.settings.sync&&s.raceId&&N.initialize(),I(u("authSuccess",t),"success")}}).catch(i=>y.error("Re-auth failed:",i)),z()}async function Zc(){const n=document.getElementById("photo-sync-modal");if(!n)return;const e=c.getState().currentLang,t=document.getElementById("photos-upload-count"),i=document.getElementById("photos-download-count"),s=document.getElementById("photos-total-size");t&&(t.textContent=u("loading",e)),i&&(i.textContent=u("loading",e)),s&&(s.textContent=u("loading",e)),O(n);const a=await N.getPhotoSyncStats();t&&(t.textContent=String(a.uploadCount)),i&&(i.textContent=String(a.downloadCount)),s&&(s.textContent=bo(a.totalSize));const r=document.getElementById("photo-sync-confirm-btn");r&&(r.textContent=u("enableSync",e))}function Xc(){const n=document.getElementById("photo-sync-modal"),e=document.getElementById("photo-sync-cancel-btn"),t=document.getElementById("photo-sync-confirm-btn");e&&Rt.add(e,"click",()=>{M(n)}),t&&Rt.add(t,"click",()=>{c.updateSettings({syncPhotos:!0});const i=document.getElementById("sync-photos-toggle");i&&(i.checked=!0),M(n);const s=c.getState();s.settings.sync&&s.raceId&&N.forceRefresh(),q()}),n&&Rt.add(n,"click",i=>{i.target===n&&M(n)})}function el(){const n=document.getElementById("race-deleted-ok-btn");n&&Rt.add(n,"click",()=>{const e=document.getElementById("race-deleted-modal");M(e)}),Xc()}const In=new G;function tl(){qc(),Yc(),el();const n=document.getElementById("admin-pin-verify-btn");n&&In.add(n,"click",()=>{Lt()?Ui():qi()});const e=document.getElementById("admin-pin-verify-input");e&&In.add(e,"keydown",i=>{i.key==="Enter"&&(Lt()?Ui():qi())});const t=document.getElementById("admin-pin-modal");t&&In.add(t,"click",i=>{i.target===t&&Lt()&&Uc()})}function nl(){document.querySelectorAll(".modal-overlay").forEach(f=>{f.addEventListener("click",d=>{d.target===f&&ct()})}),document.querySelectorAll('[data-action="cancel"]').forEach(f=>{f.addEventListener("click",ct)});const n=document.getElementById("confirm-delete-btn");n&&n.addEventListener("click",al);const e=document.getElementById("confirm-fault-delete-btn");e&&e.addEventListener("click",()=>{var g;const f=document.getElementById("fault-delete-modal"),d=f?(g=Qe(f))==null?void 0:g.faultId:void 0;if(d){c.markFaultForDeletion(d);const m=c.getState().faultEntries.find(p=>p.id===d);m&&Zn(m),on(),I(u("faultDeleted",c.getState().currentLang),"success")}M(f)});const t=document.getElementById("save-edit-btn");t&&t.addEventListener("click",rl);const i=document.getElementById("edit-bib-input");i&&tn(i,3);const s=document.getElementById("edit-run-selector");s&&s.addEventListener("click",f=>{const g=f.target.closest(".edit-run-btn");if(!g)return;const m=document.getElementById("edit-modal"),p=g.getAttribute("data-run")||"1";if(m){const b=Qe(m)||{entryId:"",entryRun:1};Ze(m,{...b,entryRun:parseInt(p,10)})}document.querySelectorAll(".edit-run-btn").forEach(b=>{b.classList.toggle("active",b===g)})});const a=document.getElementById("photo-viewer-close-btn");a&&a.addEventListener("click",Tt);const r=document.getElementById("photo-viewer-close-footer-btn");r&&r.addEventListener("click",Tt);const o=document.getElementById("photo-viewer-delete-btn");o&&o.addEventListener("click",Oc);const l=document.getElementById("photo-viewer-modal");l&&l.addEventListener("click",f=>{f.target===l&&Tt()}),Cc()}function il(n){const e=document.getElementById("edit-modal");if(!e)return;const t=n.run??1;Ze(e,{entryId:n.id,entryRun:t});const i=document.getElementById("edit-bib-input"),s=document.getElementById("edit-status-select");i&&(i.value=n.bib||""),s&&(s.value=n.status),document.querySelectorAll(".edit-run-btn").forEach(a=>{const r=a.getAttribute("data-run")===String(t);a.classList.toggle("active",r)}),O(e)}function Rs(n){const e=document.getElementById("confirm-modal");if(!e)return;const t=c.getState().currentLang,i=e.querySelector(".modal-title"),s=e.querySelector(".modal-text"),a=Qe(e)||{};if(Ze(e,{...a,action:n}),n==="clearAll")i&&(i.textContent=u("confirmClearAll",t)),s&&(s.textContent=u("clearAllText",t));else if(n==="deleteSelected"){const r=c.getState().selectedEntries.size,o=u(r===1?"entry":"entries",t);i&&(i.textContent=u("confirmDelete",t)),s&&(s.textContent=`${r} ${o} ${u("selected",t)}`)}else n==="undoAdd"?(i&&(i.textContent=u("confirmUndoAdd",t)),s&&(s.textContent=u("confirmUndoAddText",t))):(i&&(i.textContent=u("confirmDelete",t)),s&&(s.textContent=u("confirmDeleteText",t)));O(e)}function sl(n){const e=document.getElementById("confirm-modal");e&&Ze(e,{action:"delete",entryId:n.id}),Rs("delete")}async function al(){const n=document.getElementById("confirm-modal");if(!n)return;const e=Qe(n),t=e==null?void 0:e.action,i=e==null?void 0:e.entryId,s=c.getState();if(t==="clearAll"){const a=[...s.entries];if(c.clearAll(),await Q.clearAll(),s.settings.sync&&s.raceId)for(const r of a)N.deleteEntryFromCloud(r.id,r.deviceId);I(u("cleared",s.currentLang),"success")}else if(t==="deleteSelected"){const a=Array.from(s.selectedEntries),r=s.entries.filter(o=>a.includes(o.id));if(c.deleteMultiple(a),await Q.deletePhotos(a),s.settings.sync&&s.raceId)for(const o of r)N.deleteEntryFromCloud(o.id,o.deviceId);I(u("deleted",s.currentLang),"success")}else if(t==="undoAdd"){const a=c.undo();if(Nn(),I(u("undone",s.currentLang),"success"),a&&a.type==="ADD_ENTRY"){const r=a.data;await Q.deletePhoto(r.id),s.settings.sync&&s.raceId&&N.deleteEntryFromCloud(r.id,r.deviceId)}ct();return}else if(i){const a=s.entries.find(l=>l.id===i);c.deleteEntry(i),await Q.deletePhoto(i),s.settings.sync&&s.raceId&&a&&N.deleteEntryFromCloud(a.id,a.deviceId);const r=s.currentLang;dc();const o={label:u("undoAction",r),callback:()=>{if(c.canUndo()){const l=c.undo();if(Nn(),l&&l.type==="DELETE_ENTRY"){const f=l.data;Uo(f).catch(()=>{})}}}};I(u("entryDeleted",r),"success",5e3,{action:o})}an(),ct()}function rl(){const n=document.getElementById("edit-modal");if(!n)return;const e=Qe(n),t=e==null?void 0:e.entryId;if(!t)return;const i=document.getElementById("edit-bib-input"),s=document.getElementById("edit-status-select"),a=(e==null?void 0:e.entryRun)??1;c.updateEntry(t,{bib:(i==null?void 0:i.value.padStart(3,"0"))||"",status:s==null?void 0:s.value,run:a}),I(u("saved",c.getState().currentLang),"success"),ct()}function ct(){const n=document.getElementById("admin-pin-modal");if(n!=null&&n.classList.contains("show")&&Lt()){Cs();const e=document.getElementById("admin-pin-verify-input");e&&(e.value="")}document.querySelectorAll(".modal-overlay").forEach(e=>{bc(e)}),Ic()}const ie=new G;let Oe=null,lt="",Dt=null,xt=null,Gi=null;const Wt=500;function ol(n){const e=document.getElementById("voice-note-modal");if(!e)return;Oe=n,lt="";const i=c.getState().faultEntries.find(r=>r.id===n),s=document.getElementById("voice-note-textarea");s&&(s.value=(i==null?void 0:i.notes)||"",ai());const a=document.getElementById("voice-note-mic-btn");a&&(a.classList.toggle("unsupported",!j.isSupported()),a.classList.remove("loading")),si(!1),j.isSupported()&&j.initialize(),O(e),requestAnimationFrame(()=>s==null?void 0:s.focus())}function Xe(){j.stop(),Ds(),Oe=null,lt="",M(document.getElementById("voice-note-modal")),_.resume()}function cl(){if(!Oe)return;const n=document.getElementById("voice-note-textarea"),e=(n==null?void 0:n.value.trim().slice(0,Wt))||"",t=c.getState();if(!t.faultEntries.find(o=>o.id===Oe))return;const s=lt?"voice":"manual",a=e?`notes: ${e.slice(0,30)}${e.length>30?"...":""}`:"notes removed";if(c.updateFaultEntryWithHistory(Oe,{notes:e||void 0,notesSource:e?s:void 0,notesTimestamp:e?new Date().toISOString():void 0},a)){const o=c.getState().faultEntries.find(f=>f.id===Oe);o&&Ke(o);const l=t.currentLang;I(u("noteSaved",l),"success"),q()}Xe()}function ll(){const n=c.getState().currentLang;if(!j.isSupported()){I(u("voiceNoteUnsupported",n),"warning");return}const e=document.getElementById("voice-note-mic-btn");e==null||e.classList.add("loading"),_.pause(),Dt=j.onStatusChange(i=>{e==null||e.classList.remove("loading"),si(i==="listening"),i==="error"&&(I(u("voiceNoteError",n),"warning"),_.resume())}),xt=j.onTranscript((i,s)=>{const a=document.getElementById("voice-note-textarea");if(a&&s){lt+=(lt?" ":"")+i;const r=a.value,o=r?`${r} ${i}`:i;a.value=o.slice(0,Wt),ai()}}),j.start()?k():(e==null||e.classList.remove("loading"),_.resume())}function dl(){j.stop(),Ds(),si(!1),_.resume()}function ul(){j.isRecording()?dl():ll()}function si(n){const e=document.getElementById("voice-note-listening-indicator"),t=document.getElementById("voice-note-mic-btn");e&&e.classList.toggle("active",n),t&&(t.classList.toggle("recording",n),t.setAttribute("aria-pressed",String(n)))}function ai(){const n=document.getElementById("voice-note-textarea"),e=document.getElementById("voice-note-char-count");if(n&&e){const t=n.value.length;e.textContent=`${t}/${Wt}`,e.classList.toggle("near-limit",t>Wt*.9)}}function Ds(){Dt&&(Dt(),Dt=null),xt&&(xt(),xt=null)}function fl(){const n=document.getElementById("voice-note-modal"),e=document.getElementById("voice-note-mic-btn");e&&ie.add(e,"click",ul);const t=document.getElementById("voice-note-save-btn");t&&ie.add(t,"click",cl);const i=document.getElementById("voice-note-cancel-btn");i&&ie.add(i,"click",Xe);const s=document.getElementById("voice-note-close-btn");s&&ie.add(s,"click",Xe);const a=document.getElementById("voice-note-textarea");a&&ie.add(a,"input",ai),n&&(ie.add(n,"keydown",r=>{r.key==="Escape"&&(r.preventDefault(),Xe())}),ie.add(n,"click",r=>{r.target===n&&Xe()}))}function Ct(){const n=document.getElementById("fault-confirmation-overlay");n!=null&&n.classList.contains("show")&&n.classList.remove("show")}function gl(){const n=document.getElementById("fault-confirmation-overlay"),e=n==null?void 0:n.querySelector(".fault-confirmation-content"),t=document.getElementById("fault-confirmation-add-note-btn");t&&ie.add(t,"click",()=>{var a;k();const s=n?((a=Qe(n))==null?void 0:a.faultId)||n.getAttribute("data-fault-id"):void 0;Ct(),s&&ol(s)});const i=document.getElementById("fault-confirmation-done-btn");i&&ie.add(i,"click",()=>{k(),Ct()}),n&&e&&ie.add(n,"click",s=>{s.target===n&&(k(),Ct())}),n&&ie.add(document,"keydown",s=>{s.key==="Escape"&&n.classList.contains("show")&&!ms()&&(s.preventDefault(),Ct())})}function hl(){let n=!1,e=null,t=null;const i=()=>{e&&(e(),e=null),t&&(t(),t=null)};ie.add(window,"fault-edit-mic-click",()=>{const a=c.getState().currentLang,r=document.getElementById("fault-edit-mic-btn"),o=document.getElementById("fault-edit-notes"),l=document.getElementById("fault-edit-notes-char-count");if(!j.isSupported()){I(u("voiceNoteUnsupported",a),"warning");return}if(n){j.stop(),i(),n=!1,r==null||r.classList.remove("recording"),r==null||r.setAttribute("aria-pressed","false"),_.resume();return}_.pause(),e=j.onStatusChange(d=>{d==="error"&&(I(u("voiceNoteError",a),"warning"),i(),n=!1,r==null||r.classList.remove("recording"),r==null||r.setAttribute("aria-pressed","false"),_.resume())}),t=j.onTranscript((d,g)=>{if(g&&o){const m=o.value,p=m?`${m} ${d}`:d;if(o.value=p.slice(0,500),l){const b=o.value.length;l.textContent=`${b}/500`,l.classList.toggle("near-limit",b>450)}}}),j.start()?(n=!0,r==null||r.classList.add("recording"),r==null||r.setAttribute("aria-pressed","true"),k()):_.resume()});const s=document.getElementById("fault-edit-modal");s&&(Gi=new MutationObserver(a=>{for(const r of a)if(r.type==="attributes"&&r.attributeName==="class"&&!(s.classList.contains("show")||s.style.display!=="none")&&n){j.stop(),i(),n=!1;const l=document.getElementById("fault-edit-mic-btn");l==null||l.classList.remove("recording"),l==null||l.setAttribute("aria-pressed","false"),_.resume()}}),Gi.observe(s,{attributes:!0}))}function ml(){fl(),gl(),hl()}const Ve=new G;function ri(){const n=v("timer-tab"),e=v("gate-judge-tab"),t=document.querySelector(".tab-bar"),s=c.getState().deviceRole==="gateJudge";n&&(n.style.display=s?"none":""),e&&(e.style.display=s?"":"none"),t&&t.classList.toggle("gate-judge-mode",s)}function pl(){Ve.removeAll(),window.dispatchEvent(new CustomEvent("update-role-toggle")),ri();const n=v("gate-change-btn");n&&Ve.add(n,"click",()=>{k(),yl()});const e=v("gate-judge-run-selector");e&&Ve.add(e,"click",i=>{const a=i.target.closest(".run-btn");if(!a)return;const r=a.getAttribute("data-run"),o=r?parseInt(r,10):1;c.setSelectedRun(o),k(),e.querySelectorAll(".run-btn").forEach(l=>{l.classList.toggle("active",l===a),l.setAttribute("aria-checked",l===a?"true":"false")}),Se(),rt()});const t=v("ready-toggle-btn");t&&(Ve.add(t,"click",()=>{const i=c.getState(),s=!i.isJudgeReady;c.setJudgeReady(s),q(),On();const a=i.currentLang;I(u(s?"judgeReady":"judgeNotReady",a),"success")}),On()),bl(),Es(),Bc(),rt(),ml(),cn()}function yl(){const n=c.getState(),e=v("gate-start-input"),t=v("gate-end-input");e&&t&&(n.gateAssignment?(e.value=String(n.gateAssignment[0]),t.value=String(n.gateAssignment[1])):(e.value="1",t.value="10"));const i=v("gate-color-selector");i&&i.querySelectorAll(".gate-color-btn").forEach(s=>{const r=s.getAttribute("data-color")===n.firstGateColor;s.classList.toggle("active",r),s.setAttribute("aria-checked",String(r))}),O(v("gate-assignment-modal"))}function bl(){const n=v("gate-color-selector");n&&Ve.add(n,"click",t=>{const i=t.target.closest(".gate-color-btn");i&&(n.querySelectorAll(".gate-color-btn").forEach(s=>{s.classList.remove("active"),s.setAttribute("aria-checked","false")}),i.classList.add("active"),i.setAttribute("aria-checked","true"),k())});const e=v("save-gate-assignment-btn");e&&Ve.add(e,"click",()=>{const t=v("gate-start-input"),i=v("gate-end-input");if(!t||!i)return;const s=parseInt(t.value,10)||1,a=parseInt(i.value,10)||10,r=Math.min(s,a),o=Math.max(s,a),l=document.querySelector("#gate-color-selector .gate-color-btn.active"),f=(l==null?void 0:l.getAttribute("data-color"))||"red";c.setGateAssignment([r,o]),c.setFirstGateColor(f),cn(),M(v("gate-assignment-modal")),q();const d=c.getState().currentLang;I(u("saved",d),"success")})}function cn(){const n=v("gate-range-display"),e=v("gate-color-indicator"),t=v("gate-color-text");if(!n)return;const i=c.getState();if(i.gateAssignment?n.textContent=`${i.gateAssignment[0]}–${i.gateAssignment[1]}`:n.textContent="--",e&&t){const s=i.currentLang,a=i.firstGateColor==="red"?"colorRed":"colorBlue";t.textContent=`${u("firstGateLabel",s)}: ${u(a,s)}`,e.classList.toggle("red",i.firstGateColor==="red"),e.classList.toggle("blue",i.firstGateColor==="blue")}vl()}function vl(){const n=v("other-judges-coverage"),e=v("other-judges-list");if(!n||!e)return;if(!c.getState().settings.sync){n.style.display="none";return}const i=N.getOtherGateAssignments();if(i.length===0){n.style.display="none";return}n.style.display="flex";const s=c.getState().currentLang;e.innerHTML=i.map(a=>`
    <div class="coverage-badge ${a.isReady?"ready":""}" title="${R(a.deviceName)}${a.isReady?u("readySuffix",s):""}">
      ${a.isReady?'<span class="ready-check" aria-hidden="true">✓</span>':""}
      <span class="device-name">${T(a.deviceName.slice(0,15))}</span>
      <span class="gate-range">${a.gateStart}–${a.gateEnd}</span>
    </div>
  `).join(""),Sl(i),qe()}function On(){const n=v("ready-toggle-btn");if(!n)return;const e=c.getState();n.classList.toggle("ready",e.isJudgeReady),n.setAttribute("aria-pressed",String(e.isJudgeReady))}function Sl(n){const e=v("judges-ready-indicator"),t=v("judges-ready-count");if(!e||!t)return;const i=c.getState();if(!i.settings.sync){e.style.display="none";return}const s=n||N.getOtherGateAssignments();let a=s.length,r=s.filter(o=>o.isReady).length;if(i.deviceRole==="gateJudge"&&i.gateAssignment&&(a++,i.isJudgeReady&&r++),a===0){e.style.display="none";return}e.style.display="flex",t.textContent=`${r}/${a}`,e.classList.toggle("all-ready",r===a&&a>0)}function qe(){const n=v("gps-indicator"),e=v("judge-ready-indicator");if(!e)return;const t=c.getState(),i=t.deviceRole==="gateJudge";if(n&&(n.style.display=!i&&t.settings.gps?"flex":"none"),!i){e.style.display="none";return}e.style.display="flex";const s=N.getOtherGateAssignments();let a=s.length,r=s.filter(o=>o.isReady).length;t.gateAssignment&&(a++,t.isJudgeReady&&r++),e.classList.remove("none-ready","some-ready","all-ready"),r===0||a===0?e.classList.add("none-ready"):r===a?e.classList.add("all-ready"):e.classList.add("some-ready")}function oi(){const n=c.getState(),e=v("gate-judge-run-selector");e&&e.querySelectorAll(".run-btn").forEach(t=>{const i=t.getAttribute("data-run")===String(n.selectedRun);t.classList.toggle("active",i),t.setAttribute("aria-checked",String(i))})}function El(n){var e,t,i,s;switch(y.debug("[GateJudgeView] Voice intent:",n.action,n.params),n.action){case"record_fault":(e=n.params)!=null&&e.bib&&((t=n.params)==null?void 0:t.gate)!==void 0&&((i=n.params)!=null&&i.faultType)&&Is(n.params.bib,n.params.gate,n.params.faultType);break;case"toggle_ready":{const a=c.getState(),r=!a.isJudgeReady;c.setJudgeReady(r),q(),On();const o=a.currentLang;I(u(r?"judgeReady":"judgeNotReady",o),"success");break}case"set_run":(s=n.params)!=null&&s.run&&(c.setSelectedRun(n.params.run),oi(),Se(),rt(),k());break;default:y.debug("[GateJudgeView] Unhandled voice intent:",n.action)}}function xs(n){const{bib:e,point:t,run:i,deviceId:s,deviceName:a,gpsService:r}=n,o=r.getTimeOffset();let l,f;o!==null?(l=new Date(Date.now()+o).toISOString(),f="gps"):(l=new Date().toISOString(),f="system");const d=r.getCoordinates(),g=r.getTimestamp()??void 0;return{entry:{id:la(s),bib:e?e.padStart(3,"0"):"",point:t,run:i,timestamp:l,status:"ok",deviceId:s,deviceName:a,gpsCoords:d,timeSource:f,gpsTimestamp:g},timeSource:f}}function Bs(n,e){return!!(n.bib&&e.some(t=>t.bib===n.bib&&t.point===n.point&&(t.run??1)===n.run))}const Ps=0,wl=1,Il=3,kl={normal:Ps,low:wl,critical:Il},xe=new G;let x=null,ne=null,kn=Ps,Ji=0,Yt=null,Vn=!1,Bt=null,Pt=null;function Cl(){if(!v("dial-container")){y.debug("[RadialTimerView] Dial container not found, skipping init");return}if(Vn){y.debug("[RadialTimerView] Already initialized");return}y.debug("[RadialTimerView] Initializing..."),Tl(),Ll(),Al(),Rl(),Dl(),xl(),Bl(),Cn(),Tn(),Hn(),Bt=c.subscribe((e,t)=>{t.includes("settings")&&(Cn(),Tn()),(t.includes("syncStatus")||t.includes("cloudDeviceCount"))&&Tn(),t.includes("selectedPoint")&&dt(),t.includes("selectedRun")&&Kt(),t.includes("entries")&&Hn(),t.includes("gpsStatus")&&Cn()}),Vn=!0,y.debug("[RadialTimerView] Initialized successfully")}function Tl(){const n=()=>{if(Yt)return;const t=new Date,i=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0"),a=String(t.getSeconds()).padStart(2,"0"),r=String(t.getMilliseconds()).padStart(3,"0"),o=v("radial-time-hm"),l=v("radial-time-seconds"),f=v("radial-time-subseconds");o&&(o.textContent=`${i}:${s}`),l&&(l.textContent=a),f&&(f.textContent=r)},e=()=>{Ji++,(kn===0||Ji%(kn+1)===0)&&n(),ne=requestAnimationFrame(e)};ne!==null&&cancelAnimationFrame(ne),Z.initialize().then(()=>{Pt=Z.subscribe(t=>{kn=kl[t.batteryLevel]})}).catch(()=>{}),xe.add(document,"visibilitychange",()=>{document.hidden?ne!==null&&(cancelAnimationFrame(ne),ne=null):ne===null&&(ne=requestAnimationFrame(e))}),n(),ne=requestAnimationFrame(e)}function Ll(){const n=v("dial-container");if(!n)return;x&&x.destroy(),x=new rc(n,{onChange:t=>{c.setBibInput(t),me(t)},momentum:1.5,friction:.97,sensitivity:24});const e=c.getState();e.bibInput&&(x.setValue(e.bibInput),me(e.bibInput))}function me(n){const e=v("radial-bib-value");if(!e)return;const t='<span class="radial-bib-cursor"></span>';if(!n)e.innerHTML=`---${t}`,e.classList.remove("active");else{const i=T(n.padStart(3,"0"));e.innerHTML=i+(n.length<3?t:""),e.classList.add("active")}}function Al(){const n=v("radial-timing-point");n&&(xe.add(n,"click",e=>{const i=e.target.closest(".radial-point-btn");if(!i)return;const s=i.getAttribute("data-point");s&&(c.setSelectedPoint(s),k(),dt())}),dt())}function dt(){const n=c.getState();document.querySelectorAll(".radial-point-btn").forEach(e=>{const t=e.getAttribute("data-point")===n.selectedPoint;e.classList.toggle("active",t),e.setAttribute("aria-checked",String(t))})}function Rl(){const n=v("radial-run-selector");n&&(xe.add(n,"click",e=>{const i=e.target.closest(".radial-run-btn");if(!i)return;const s=i.getAttribute("data-run");if(s){const a=parseInt(s,10);c.setSelectedRun(a),k(),Kt()}}),Kt())}function Kt(){const n=c.getState();document.querySelectorAll(".radial-run-btn").forEach(e=>{const i=e.getAttribute("data-run")===String(n.selectedRun);e.classList.toggle("active",i),e.setAttribute("aria-checked",String(i))})}function Dl(){const n=v("radial-time-btn");n&&xe.add(n,"click",Ns)}function xl(){const n=v("radial-clear-btn");n&&xe.add(n,"click",()=>{x==null||x.clear(),c.setBibInput(""),me(""),k(),n.classList.add("flash"),setTimeout(()=>n.classList.remove("flash"),150)})}function Bl(){xe.add(document,"keydown",n=>{var i;const e=(i=document.activeElement)==null?void 0:i.tagName,t=c.getState();if(!(e==="INPUT"||e==="TEXTAREA"||e==="SELECT")&&t.currentView==="timer"){if(/^[0-9]$/.test(n.key)){n.preventDefault();const s=t.bibInput;if(s.length<3){const a=s+n.key;c.setBibInput(a),x==null||x.setValue(a),me(a),k()}return}if(n.key==="Backspace"){n.preventDefault();const s=t.bibInput.slice(0,-1);c.setBibInput(s),x==null||x.setValue(s),me(s),k();return}if(n.key==="Delete"||n.key==="Escape"){n.preventDefault(),x==null||x.clear(),c.setBibInput(""),me(""),k();return}if(n.key==="s"||n.key==="S"){n.preventDefault(),c.setSelectedPoint("S"),k(),dt();return}if(n.key==="f"||n.key==="F"){n.preventDefault(),c.setSelectedPoint("F"),k(),dt();return}if(n.altKey&&(n.key==="1"||n.key==="2")){n.preventDefault();const s=n.key==="1"?1:2;c.setSelectedRun(s),k(),Kt();return}if(n.key===" "||n.key==="Enter"){n.preventDefault(),Ns();return}}})}async function Ns(){const n=c.getState();if(n.isRecording)return;const{entry:e}=xs({bib:n.bibInput,point:n.selectedPoint,run:n.selectedRun,deviceId:n.deviceId,deviceName:n.deviceName,gpsService:ge});c.setRecording(!0);try{n.settings.photoCapture&&rs().then(async i=>{if(i)try{await Q.savePhoto(e.id,i)&&c.updateEntry(e.id,{photo:"indexeddb"})}catch(s){it("Camera","photo save",s,"photoError")}}).catch(i=>{it("Camera","captureTimingPhoto",i,"photoError")});const t=Bs(e,n.entries);if(c.addEntry(e),t?z():q(),Pl(e),N.broadcastEntry(e),n.settings.auto&&n.bibInput){const i=parseInt(n.bibInput,10)+1,s=n.settings.sync&&n.cloudHighestBib>0?Math.max(i,n.cloudHighestBib+1):i,a=String(s);c.setBibInput(a),x==null||x.setValue(a),me(a)}else n.bibInput&&!n.settings.auto&&(c.setBibInput(""),x==null||x.clear(),me(""));Hn()}finally{c.setRecording(!1)}}function Pl(n){const e=new Date(n.timestamp),t=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),s=String(e.getSeconds()).padStart(2,"0"),a=String(e.getMilliseconds()).padStart(3,"0"),r=`${t}:${i}:${s}.${a}`;Yt=r;const o=v("radial-time-hm"),l=v("radial-time-seconds"),f=v("radial-time-subseconds");o&&(o.textContent=`${t}:${i}`),l&&(l.textContent=s),f&&(f.textContent=a);const d=v("dial-ring"),g=v("radial-time-display"),m=v("radial-time-btn");d==null||d.classList.add("flash"),g==null||g.classList.add("flash","frozen"),m==null||m.classList.add("flash"),x==null||x.flash();const p=v("radial-confirmation-overlay"),b=v("radial-confirm-bib"),w=v("radial-confirm-time"),S=v("radial-confirm-point");if(b&&(b.textContent=n.bib||"---"),w&&(w.textContent=r),S){const E=c.getState();S.textContent=Ie(n.point,E.currentLang),S.className=`radial-confirmation-point ${n.point==="S"?"start":"finish"}`}p==null||p.classList.add("show"),setTimeout(()=>{Yt=null,d==null||d.classList.remove("flash"),g==null||g.classList.remove("flash","frozen"),m==null||m.classList.remove("flash"),p==null||p.classList.remove("show")},1200)}function Cn(){const n=c.getState(),e=v("radial-gps-status");if(!e)return;const t=e.querySelector(".radial-status-dot");t&&(n.settings.gps?n.gpsStatus==="active"?t.className="radial-status-dot":n.gpsStatus==="searching"?t.className="radial-status-dot warning":t.className="radial-status-dot inactive":t.className="radial-status-dot inactive")}function Tn(){const n=c.getState(),e=v("radial-sync-status");if(!e)return;if(!n.settings.sync){e.style.display="none";return}e.style.display="flex";const t=e.querySelector(".radial-status-dot"),i=e.querySelector(".radial-sync-text");if(t&&(n.syncStatus==="connected"?t.className="radial-status-dot":n.syncStatus==="error"?t.className="radial-status-dot error":t.className="radial-status-dot warning"),i){const s=n.cloudDeviceCount||0,a=n.currentLang;i.textContent=s>0?`${u("synced",a)} (${s})`:u("syncingStatus",a)}}function Hn(){const n=c.getState(),e=n.entries,t=v("radial-stats-count");if(t&&(t.textContent=`${e.length} ${e.length===1?u("entry",n.currentLang):u("entries",n.currentLang)}`),e.length>0){const i=e[e.length-1],s=v("radial-last-bib"),a=v("radial-last-point"),r=v("radial-last-time");if(s&&(s.textContent=i.bib||"---"),a&&(a.textContent=i.point==="S"?u("startShort",n.currentLang):u("finishShort",n.currentLang),a.className=`radial-stats-point ${i.point==="S"?"start":"finish"}`),r){const o=new Date(i.timestamp);r.textContent=we(o)}}}function Nl(){Bt&&(Bt(),Bt=null),ne!==null&&(cancelAnimationFrame(ne),ne=null),Pt&&(Pt(),Pt=null),xe.removeAll(),x&&(x.destroy(),x=null),Yt=null,Vn=!1}function Fs(){const n=c.getState();me(n.bibInput),x==null||x.setValue(n.bibInput)}function Zt(){const n=document.querySelector(".timer-view");return(n==null?void 0:n.classList.contains("radial-mode"))??!1}function Fl(n){const e=new Date(n);let t=e.getHours(),i=e.getMinutes(),s=e.getSeconds(),a=Math.round(e.getMilliseconds()/10);return a>=100&&(a=0,s++,s>=60&&(s=0,i++),i>=60&&(i=0,t++),t>=24&&(t=0)),`${String(t).padStart(2,"0")}:${String(i).padStart(2,"0")}:${String(s).padStart(2,"0")},${String(a).padStart(2,"0")}`}function Ln(n){const e=["=","+","-","@","|","	","\r",`
`];let t=n;return e.some(i=>t.startsWith(i))&&(t=`'${t}`),/^[+]?0x/i.test(t)&&(t=`'${t}`),t.includes('"')&&(t=t.replace(/"/g,'""')),(t.includes(";")||t.includes('"')||t.includes(`
`)||t.includes("|"))&&(t=`"${t}"`),t}function $l(n){const e=new Date(n),t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${i}-${s}`}function Ml(n){return n==="S"?"ST":"FT"}function An(n,e){var i;return((i={ok:{en:"OK",de:"OK"},dns:{en:"DNS",de:"DNS"},dnf:{en:"DNF",de:"DNF"},dsq:{en:"DSQ",de:"DSQ"},flt:{en:"FLT",de:"STR"}}[n])==null?void 0:i[e])||n.toUpperCase()}function Ol(n){return n.length===0?"":n.sort((e,t)=>e.gateNumber-t.gateNumber).map(e=>`T${e.gateNumber}(${e.faultType})`).join(",")}function ci(){const n=c.getState(),e=n.entries,t=n.faultEntries,i=n.currentLang;if(e.length===0){I(u("noEntries",i),"warning");return}try{const s=[...e].sort((b,w)=>new Date(b.timestamp).getTime()-new Date(w.timestamp).getTime()),a=t.length>0,r=a?"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Torstrafzeit;Torfehler;Datum":"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Datum",o=s.map(b=>{const w=Ln(b.bib),S=b.run??1,E=Ml(b.point),C=Fl(b.timestamp),F=Ln(b.deviceName||b.deviceId),V=Ln($l(b.timestamp)),A=b.point==="F"?t.filter(D=>D.bib===b.bib&&D.run===S):[];let L;if(b.point==="F"&&A.length>0?L=n.usePenaltyMode?An("flt",i):An("dsq",i):L=An(b.status,i),a){const D=A.length>0&&n.usePenaltyMode?A.length*n.penaltySeconds:0,B=Ol(A);return`${w};${S};${E};${C};${L};${F};${D};${B};${V}`}else return`${w};${S};${E};${C};${L};${F};${V}`}),l=[r,...o].join(`
`),f=new Blob([l],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(f),g=document.createElement("a");g.href=d;const m=new Date().toISOString().split("T")[0],p=n.raceId||"race";g.download=`${p}_${m}.csv`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(d),q(),I(u("exported",i),"success")}catch(s){y.error("CSV export failed:",s),I(u("operationFailed",i),"error")}}function _n(n,e="csv"){const t=new Date().toISOString().split("T")[0];return`${n.replace(/[^a-zA-Z0-9-_]/g,"_")||"race"}_${t}.${e}`}function Vl(){const n=c.getState(),e=n.currentLang,t=n.faultEntries,i=n.raceId||"RACE";if(t.length===0){I(u("noFaultsToExport",e),"warning");return}const s=new Map;for(const g of t){const m=`${g.bib}-${g.run}`;s.has(m)||s.set(m,[]),s.get(m).push(g)}const a=[];a.push(`📋 ${u("gateFaults",e)} - ${i}`),a.push("");const r=Array.from(s.entries()).filter(([g])=>g.endsWith("-1")),o=Array.from(s.entries()).filter(([g])=>g.endsWith("-2")),l=(g,m)=>{const[p]=g.split("-"),b=p.padStart(3,"0"),w=m.sort((E,C)=>E.gateNumber-C.gateNumber).map(E=>`T${E.gateNumber}`).join("+"),S=m.map(E=>E.faultType).join(", ");if(n.usePenaltyMode){const E=m.length*n.penaltySeconds;return`#${b}: ${w} (${S}) → +${E}s`}else return`#${b}: ${w} (${S})`};r.length>0&&(a.push(`🏁 ${u("runLabel",e)} 1:`),n.usePenaltyMode?a.push(`🟡 ${u("penaltyLabel",e)}:`):a.push(`🔴 ${u("dsq",e)}:`),r.sort((g,m)=>parseInt(g[0].split("-")[0],10)-parseInt(m[0].split("-")[0],10)).forEach(([g,m])=>{a.push(l(g,m))}),a.push("")),o.length>0&&(a.push(`🏁 ${u("runLabel",e)} 2:`),n.usePenaltyMode?a.push(`🟡 ${u("penaltyLabel",e)}:`):a.push(`🔴 ${u("dsq",e)}:`),o.sort((g,m)=>parseInt(g[0].split("-")[0],10)-parseInt(m[0].split("-")[0],10)).forEach(([g,m])=>{a.push(l(g,m))}),a.push(""));const f=new Date;a.push(`📅 ${f.toLocaleDateString(e==="de"?"de-DE":"en-US")} ${f.toLocaleTimeString(e==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"})}`);const d=a.join(`
`);navigator.clipboard?navigator.clipboard.writeText(d).then(()=>{q(),I(u("copiedToClipboard",e),"success")}).catch(()=>{zn(d,_n(`${i}_WhatsApp`,"txt"))}):zn(d,_n(`${i}_WhatsApp`,"txt"))}function Hl(){const n=c.getState(),e=n.currentLang,t=n.faultEntries,i=n.raceId||"RACE";if(t.length===0){I(u("noFaultsToExport",e),"warning");return}const s=new Map;for(const g of t){const m=`${g.bib}-${g.run}`;s.has(m)||s.set(m,[]),s.get(m).push(g)}const a=[],r="══════════════════════════════════════════════════════",o=Array.from(s.entries()).filter(([g])=>g.endsWith("-1")),l=Array.from(s.entries()).filter(([g])=>g.endsWith("-2")),f=(g,m)=>{g.length!==0&&(a.push(`${u("faultSummaryTitle",e)} - ${u("runLabel",e)} ${m}`),a.push(r),a.push(`${u("bib",e).substring(0,7).padEnd(7)} │ ${u("faults",e).padEnd(16)} │ ${u("penalty",e).padStart(9)} │ Status`),a.push("────────┼──────────────────┼───────────┼────────"),g.sort((p,b)=>parseInt(p[0].split("-")[0],10)-parseInt(b[0].split("-")[0],10)).forEach(([p,b])=>{const[w]=p.split("-"),S=w.padStart(5),E=b.sort((V,A)=>V.gateNumber-A.gateNumber).map(V=>`T${V.gateNumber}(${V.faultType})`).join(", ").padEnd(16);let C,F;n.usePenaltyMode?(C=`${b.length*n.penaltySeconds} ${u("sec",e)}`.padStart(9),F=u("flt",e)):(C="-".padStart(9),F=u("dsq",e)),a.push(`  ${S}   │ ${E} │ ${C} │ ${F}`)}),a.push(""))};a.push(`${i} - ${new Date().toLocaleDateString(e==="de"?"de-DE":"en-US")}`),a.push(""),f(o,1),f(l,2),a.push(r),a.push(`${u("generated",e)}: ${new Date().toLocaleString(e==="de"?"de-DE":"en-US")}`);const d=a.join(`
`);zn(d,_n(`${i}_${u("summary",e)}`,"txt")),q(),I(u("exported",e),"success")}function zn(n,e){const t=new Blob([n],{type:"text/plain;charset=utf-8;"}),i=URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}let ue=null,Nt=null,fe=null;const oe=new G;function _l(n){window.dispatchEvent(new CustomEvent("open-edit-modal",{detail:{entry:n}}))}function zl(n){window.dispatchEvent(new CustomEvent("prompt-delete",{detail:{entry:n}}))}function Rn(n){window.dispatchEvent(new CustomEvent("open-confirm-modal",{detail:{action:n}}))}function $s(){return ue}function Ul(){oe.removeAll(),fe&&(clearTimeout(fe),fe=null);const n=v("results-list");if(!n)return;ue=new hc({container:n,onItemClick:r=>_l(r),onItemDelete:r=>zl(r),onItemSelect:r=>{c.toggleEntrySelection(r.id)},onViewPhoto:r=>Mc(r)}),oe.add(n,"fault-edit-request",r=>{var l;const o=(l=r.detail)==null?void 0:l.fault;o&&ps(o)}),oe.add(n,"fault-delete-request",r=>{var l;const o=(l=r.detail)==null?void 0:l.fault;o&&ys(o)});const e=c.getState();ue.setEntries(e.entries),ln();const t=document.querySelector(".results-view");t&&(Nt=new ac({container:t,onRefresh:async()=>{await N.forceRefresh(),I(u("syncReceived",c.getState().currentLang),"success")}}));const i=v("search-input");i&&oe.add(i,"input",()=>{fe&&clearTimeout(fe),fe=setTimeout(()=>{Dn()},300)});const s=v("filter-point"),a=v("filter-status");s&&oe.add(s,"change",Dn),a&&oe.add(a,"change",Dn),ql(),e.currentView!=="results"&&ue&&ue.pause()}function ql(){const n=v("clear-all-btn");n&&oe.add(n,"click",()=>{const s=c.getState();if(s.entries.length===0){I(u("noEntries",s.currentLang),"info");return}Rn("clearAll")});const e=v("undo-btn");e&&oe.add(e,"click",()=>{if(c.canUndo()){const s=c.peekUndo();if(s&&s.type==="ADD_ENTRY")Rn("undoAdd");else{const a=c.undo();Nn(),I(u("undone",c.getState().currentLang),"success");const r=c.getState();if(a&&a.type==="ADD_ENTRY"&&r.settings.sync&&r.raceId){const o=a.data;N.deleteEntryFromCloud(o.id,o.deviceId)}}}});const t=v("export-btn");t&&oe.add(t,"click",ci);const i=v("delete-selected-btn");i&&oe.add(i,"click",()=>{c.getState().selectedEntries.size>0&&Rn("deleteSelected")})}function Dn(){if(!ue)return;const n=v("search-input"),e=v("filter-point"),t=v("filter-status");ue.applyFilters((n==null?void 0:n.value)||"",(e==null?void 0:e.value)||"all",(t==null?void 0:t.value)||"all"),ln()}function ln(){const e=c.getState().entries,t=e.length,i=new Set(e.map(m=>m.bib)).size,s=new Set(e.filter(m=>m.point==="F"&&m.status==="ok").map(m=>m.bib)).size,a=new Map;for(const m of e){const p=`${m.bib}-${m.point}-${m.run??1}`;a.has(p)||a.set(p,new Set),a.get(p).add(m.deviceId)}let r=0;for(const m of a.values())m.size>1&&r++;const o=v("stat-total"),l=v("stat-racers"),f=v("stat-finished"),d=v("stat-duplicates"),g=v("stat-duplicates-item");o&&(o.textContent=String(t)),l&&(l.textContent=String(i)),f&&(f.textContent=String(s)),d&&(d.textContent=String(r)),g&&(g.style.display=r>0?"":"none")}function Ms(){const n=v("entry-count-badge");if(n){const e=c.getState().entries.length;n.textContent=String(e),n.style.display=e>0?"inline":"none"}}function Gl(){fe&&(clearTimeout(fe),fe=null),oe.removeAll(),Nt&&(Nt.destroy(),Nt=null),ue&&(ue.destroy(),ue=null)}function Jl(){Gl()}function jl(n){const e=c.getState().currentLang,t=n.entryCount!==void 0?`${n.entryCount} ${u("entries",e)}`:"",i=T(n.raceId);return`
    <div class="recent-race-item" data-race-id="${R(n.raceId)}" tabindex="0" role="option" aria-label="${R(u("race",e))} ${i}${t?`, ${t}`:""}">
      <span class="recent-race-id">${i}</span>
      <span class="recent-race-meta">${t}</span>
    </div>
  `}function Os(n){return n.map(jl).join("")}function Vs(n,e,t){const i=n.querySelectorAll(".recent-race-item");i.forEach((s,a)=>{s.addEventListener("click",()=>{const r=e[a];r&&t(r)}),s.addEventListener("keydown",r=>{const o=r,l=Array.from(i);switch(o.key){case"Enter":case" ":{o.preventDefault();const f=e[a];f&&t(f);break}case"ArrowDown":o.preventDefault(),a<l.length-1&&l[a+1].focus();break;case"ArrowUp":o.preventDefault(),a>0&&l[a-1].focus();break;case"Escape":o.preventDefault(),n.style.display="none";break}})})}const Ql={"5.18":{name:"Tiramisu Fox",description:{en:"Battery power saver for longer outdoor timing. Improved PIN security and faster voice notes.",de:"Batterieschoner für längere Zeitmessung im Freien. Verbesserte PIN-Sicherheit und schnellere Sprachnotizen."}},"5.19":{name:"Marzipan Lynx",description:{en:"Under-the-hood reliability upgrade. Stronger server-side input validation and improved code quality.",de:"Verbesserungen unter der Haube. Stärkere serverseitige Eingabevalidierung und verbesserte Codequalität."}},"5.20":{name:"Baklava Falcon",description:{en:"Offline banner, undo for deletions, reorganized settings, and standardized event cleanup across the app.",de:"Offline-Banner, Rückgängig-Funktion für Löschungen, neu organisierte Einstellungen und standardisierte Ereignisbereinigung."}},"5.21":{name:"Churros Otter",description:{en:"Responsive layout fixes for all screen sizes. Dial and numbers scale smoothly from iPhone SE to iPad landscape.",de:"Responsive Layout-Korrekturen für alle Bildschirmgrößen. Zifferblatt und Zahlen skalieren fließend vom iPhone SE bis iPad Querformat."}}};function Un(n){const e=n.split(".");if(e.length<2)return null;const t=`${e[0]}.${e[1]}`,i=Ql[t];if(!i)return null;const s=c.getState().currentLang;return{name:i.name,description:i.description[s]||i.description.en}}const H=new G;let Ge=null,xn=0,qn={exists:null,entryCount:0},Ft=null,$t=null;async function Wl(){return new Promise(n=>{Ft=n,window.dispatchEvent(new CustomEvent("request-photo-sync-warning"))})}async function ji(n,e){return new Promise(t=>{$t=t,window.dispatchEvent(new CustomEvent("request-race-change-dialog",{detail:{type:n,lang:e}}))})}function Qi(){Ft&&(Ft(),Ft=null)}function Wi(n){$t&&($t(n),$t=null)}function Yl(){const n=v("simple-mode-toggle");n&&H.add(n,"change",()=>{c.updateSettings({simple:n.checked}),_s();const S=v("admin-section");S&&(S.style.display="block")});const e=v("gps-toggle");e&&H.add(e,"change",()=>{c.updateSettings({gps:e.checked})});const t=v("sync-toggle");let i=!1;t&&H.add(t,"change",async()=>{if(i){t.checked=!t.checked;return}i=!0;try{const S=c.getState();if(t.checked&&S.raceId&&!await Mn(S.currentLang)){t.checked=!1;return}c.updateSettings({sync:t.checked});const E=v("sync-photos-toggle");E&&(E.disabled=!t.checked,t.checked||(E.checked=!1,c.updateSettings({syncPhotos:!1}))),t.checked&&S.raceId?N.initialize():N.cleanup()}finally{i=!1}});const s=v("sync-photos-toggle");s&&H.add(s,"change",async S=>{const E=S.target;E.checked?(S.preventDefault(),E.checked=!1,await Wl()):c.updateSettings({syncPhotos:!1})});const a=v("auto-toggle");a&&H.add(a,"change",()=>{c.updateSettings({auto:a.checked})});const r=v("haptic-toggle");r&&H.add(r,"change",()=>{c.updateSettings({haptic:r.checked})});const o=v("sound-toggle");o&&H.add(o,"change",()=>{c.updateSettings({sound:o.checked})});const l=v("ambient-mode-toggle");l&&H.add(l,"change",()=>{c.updateSettings({ambientMode:l.checked})}),ed();const f=v("photo-toggle");f&&H.add(f,"change",()=>{c.updateSettings({photoCapture:f.checked})});const d=v("lang-toggle");if(d){const S=E=>{E&&E!==c.getState().currentLang&&(c.setLanguage(E),li(),Hs())};H.add(d,"click",E=>{const F=E.target.getAttribute("data-lang");S(F)}),d.querySelectorAll(".lang-option").forEach(E=>{H.add(E,"keydown",C=>{const F=C,V=E.getAttribute("data-lang");switch(F.key){case"Enter":case" ":F.preventDefault(),S(V);break;case"ArrowLeft":case"ArrowRight":{F.preventDefault();const A=V==="de"?"en":"de",L=d.querySelector(`[data-lang="${A}"]`);L&&(L.focus(),S(A));break}}})})}const g=v("race-id-input");let m=!1;g&&(H.add(g,"input",()=>{Ge&&clearTimeout(Ge);const S=g.value.trim();S?Ge=setTimeout(()=>td(S),500):Xt(null,0)}),H.add(g,"change",async()=>{if(!m){m=!0;try{const S=g.value.trim(),E=c.getState(),C=E.entries.length>0,F=E.lastSyncedRaceId!=="",V=S!==E.raceId&&S!=="";if(C&&V)if(F){const L=await ji("synced",E.currentLang);if(L==="export")ci(),c.clearAll(),c.clearFaultEntries(),await Q.clearAll();else if(L==="delete")c.clearAll(),c.clearFaultEntries(),await Q.clearAll();else{g.value=E.raceId;return}}else{const L=await ji("unsynced",E.currentLang);if(L==="delete")c.clearAll(),c.clearFaultEntries(),await Q.clearAll();else if(L==="cancel"){g.value=E.raceId;return}}if(S&&!ss(S)){I(u("invalidRaceId",E.currentLang),"error"),g.value=E.raceId,z();return}if(E.settings.sync&&S&&!await Mn(E.currentLang)){g.value=E.raceId;return}E.settings.sync&&E.raceId&&N.cleanup();const A=S.toLowerCase();g.value=A,c.setRaceId(A),E.settings.sync&&A&&(N.initialize(),c.markCurrentRaceAsSynced())}finally{m=!1}}}));const p=v("settings-recent-races-btn"),b=v("settings-recent-races-dropdown");p&&b&&(H.add(p,"click",()=>{k(),b.style.display==="none"?(nd(b),p.setAttribute("aria-expanded","true")):(b.style.display="none",p.setAttribute("aria-expanded","false"))}),H.add(document,"click",S=>{const E=S.target;!p.contains(E)&&!b.contains(E)&&(b.style.display="none",p.setAttribute("aria-expanded","false"))}));const w=v("device-name-input");w&&H.add(w,"change",()=>{c.setDeviceName(w.value.trim())}),Zl(),H.add(window,"update-role-toggle",()=>dn()),Kl()}function Kl(){const n=v("advanced-settings-toggle"),e=v("advanced-settings-section");!n||!e||(n.setAttribute("role","button"),n.setAttribute("aria-expanded",e.classList.contains("expanded")?"true":"false"),H.add(n,"click",()=>{const t=e.classList.toggle("expanded");n.setAttribute("aria-expanded",String(t)),k()}))}function Zl(){const n=v("role-toggle");n&&H.add(n,"click",e=>{const i=e.target.closest(".role-card-setting");if(!i)return;const s=i.getAttribute("data-role");s&&s!==c.getState().deviceRole&&(c.setDeviceRole(s),dn(),ri(),k(),s==="gateJudge"&&!c.getState().gateAssignment&&O(v("gate-assignment-modal")),s!=="gateJudge"&&c.getState().currentView==="gateJudge"&&c.setView("timer"))})}function dn(){const n=v("role-toggle");if(!n)return;const e=c.getState();n.querySelectorAll(".role-card-setting").forEach(t=>{const s=t.getAttribute("data-role")===e.deviceRole;t.classList.toggle("active",s),t.setAttribute("aria-checked",String(s))})}function Xl(){const n=c.getState(),{settings:e}=n,t=v("simple-mode-toggle"),i=v("gps-toggle"),s=v("sync-toggle"),a=v("auto-toggle"),r=v("haptic-toggle"),o=v("sound-toggle"),l=v("photo-toggle");t&&(t.checked=e.simple);const f=v("admin-section");f&&(f.style.display="block"),i&&(i.checked=e.gps),s&&(s.checked=e.sync),a&&(a.checked=e.auto),r&&(r.checked=e.haptic),o&&(o.checked=e.sound),l&&(l.checked=e.photoCapture);const d=v("ambient-mode-toggle");d&&(d.checked=e.ambientMode);const g=v("sync-photos-toggle");g&&(g.checked=e.syncPhotos,g.disabled=!e.sync);const m=v("race-id-input");m&&(m.value=n.raceId);const p=v("device-name-input");p&&(p.value=n.deviceName),Hs()}function Hs(){const n=c.getState().currentLang,e=v("lang-toggle");e&&e.querySelectorAll(".lang-option").forEach(t=>{const i=t.getAttribute("data-lang")===n;t.classList.toggle("active",i),t.setAttribute("aria-checked",String(i))})}function ed(){const n=v("voice-mode-toggle"),e=v("voice-mode-row");if(!(!n||!e)){if(!_.isSupported()){e.style.display="none";return}n.checked=_.isActive(),H.add(n,"change",async()=>{const t=c.getState().currentLang;if(n.checked){if(!navigator.onLine){I(u("voiceOffline",t),"warning"),n.checked=!1;return}_.enable()||(I(u("voiceError",t),"error"),n.checked=!1)}else _.disable()})}}function li(){const n=c.getState().currentLang;document.documentElement.lang=n,document.querySelectorAll("[data-i18n]").forEach(t=>{const i=t.getAttribute("data-i18n");i&&(t.textContent=u(i,n))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(t=>{const i=t.getAttribute("data-i18n-placeholder");i&&(t.placeholder=u(i,n))}),document.querySelectorAll("[data-i18n-aria-label]").forEach(t=>{const i=t.getAttribute("data-i18n-aria-label");i&&t.setAttribute("aria-label",u(i,n))}),Xt(qn.exists,qn.entryCount);const e=document.getElementById("app-version-description");if(e){const t=Un("5.21.0");e.textContent=(t==null?void 0:t.description)??""}}function _s(){document.querySelectorAll("[data-advanced]").forEach(t=>{t.style.display=""});const e=document.querySelector('[data-point="S"]');e&&(e.style.display=""),zs()}function zs(){const n=c.getState().settings,e=document.documentElement;n.glassEffects?(e.classList.remove("no-glass-effects"),document.querySelectorAll(".glass-enable-target").forEach(t=>{t.classList.add("glass-enabled")})):(e.classList.add("no-glass-effects"),document.querySelectorAll(".glass-enabled").forEach(t=>{t.classList.remove("glass-enabled")})),e.classList.add("no-motion-effects"),n.outdoorMode?e.classList.add("outdoor-mode"):e.classList.remove("outdoor-mode")}async function td(n){const e=++xn;try{const t=await N.checkRaceExists(n);if(e!==xn)return;c.setRaceExistsInCloud(t.exists),Xt(t.exists,t.entryCount)}catch(t){if(e!==xn)return;y.warn("Race exists check failed:",t),Xt(null,0)}}async function nd(n){const e=c.getState().currentLang;n.innerHTML=`<div class="recent-races-empty">${u("loading",e)}</div>`,n.style.display="block";let t=[];if(Ce())try{t=await id()}catch(i){y.warn("Failed to fetch races from API:",i),t=Ut()}else t=Ut();t.length===0?n.innerHTML=`<div class="recent-races-empty">${u("noRecentRaces",e)}</div>`:(n.innerHTML=Os(t),Vs(n,t,i=>{sd(i,n)}))}async function id(){const n=localStorage.getItem(gt);if(!n)return[];const e=await ae("/api/v1/admin/races",{headers:{Authorization:`Bearer ${n}`}},5e3);if(!e.ok)throw new Error(`API error: ${e.status}`);const i=(await e.json()).races||[],s=new Date;s.setHours(0,0,0,0);const a=s.getTime(),r=i.filter(o=>o.lastUpdated&&o.lastUpdated>=a).map(o=>({raceId:o.raceId,createdAt:o.lastUpdated||Date.now(),lastUpdated:o.lastUpdated||Date.now(),entryCount:o.entryCount})).slice(0,5);return r.forEach(o=>{Wn(o.raceId,o.lastUpdated,o.entryCount)}),r}function sd(n,e){const t=v("race-id-input");t&&(t.value=n.raceId,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),k()),e.style.display="none"}function Xt(n,e){qn={exists:n,entryCount:e};const t=v("race-exists-indicator"),i=v("race-exists-text"),s=c.getState().currentLang;if(!(!t||!i)){if(n===null){t.style.display="none";return}if(t.style.display="inline-flex",t.classList.remove("found","new"),n)if(t.classList.add("found"),e>0){const a=u(e===1?"entryInCloud":"entriesInCloud",s);i.textContent=`${e} ${a}`}else i.textContent=u("raceFound",s);else t.classList.add("new"),i.textContent=u("raceNew",s)}}function ad(){Ge&&(clearTimeout(Ge),Ge=null),H.removeAll()}const ke=new G;let be=null;const We=new Set;function rd(n){return n?/^0+$/.test(n):!1}function od(){be&&(be.destroy(),be=null);const n=v("clock-container");n&&(be=new sc(n),be.start())}function cd(){be&&(be.destroy(),be=null)}function ld(){const n=document.querySelectorAll(".tab-btn"),e=()=>Array.from(n).filter(t=>t.style.display!=="none");n.forEach(t=>{ke.add(t,"click",()=>{const i=t.getAttribute("data-view");i&&(c.setView(i),k(),n.forEach(s=>{s.setAttribute("aria-selected",s===t?"true":"false")}))}),ke.add(t,"keydown",i=>{const s=i,a=e(),r=a.indexOf(t);let o=r;switch(s.key){case"ArrowLeft":case"ArrowUp":s.preventDefault(),o=r>0?r-1:a.length-1;break;case"ArrowRight":case"ArrowDown":s.preventDefault(),o=r<a.length-1?r+1:0;break;case"Home":s.preventDefault(),o=0;break;case"End":s.preventDefault(),o=a.length-1;break;default:return}if(o!==r){const l=a[o];l.focus(),l.click()}})})}function dd(){const n=v("number-pad"),e=v("bib-display");e&&n&&(e.setAttribute("aria-expanded","true"),ke.add(e,"click",()=>{const t=n.classList.toggle("collapsed");e.classList.toggle("expanded",!t),e.setAttribute("aria-expanded",String(!t)),k()})),n&&ke.add(n,"click",t=>{const s=t.target.closest(".num-btn");if(!s)return;const a=s.getAttribute("data-num"),r=s.getAttribute("data-action");if(a){const o=c.getState();o.bibInput.length<3&&(c.setBibInput(o.bibInput+a),k())}else if(r==="clear")c.setBibInput(""),k();else if(r==="delete"){const o=c.getState();c.setBibInput(o.bibInput.slice(0,-1)),k()}})}function ud(){const n=v("timing-points");n&&ke.add(n,"click",e=>{const i=e.target.closest(".timing-point-btn");if(!i)return;const s=i.getAttribute("data-point");s&&(c.setSelectedPoint(s),k(),n.querySelectorAll(".timing-point-btn").forEach(a=>{a.setAttribute("aria-checked",a===i?"true":"false")}))})}function fd(){const n=v("run-selector");n&&ke.add(n,"click",e=>{const i=e.target.closest(".run-btn");if(!i)return;const s=i.getAttribute("data-run"),a=s?parseInt(s,10):1;c.setSelectedRun(a),k(),n.querySelectorAll(".run-btn").forEach(r=>{r.setAttribute("aria-checked",r===i?"true":"false")})})}function gd(){const n=v("timestamp-btn");n&&(ke.add(n,"click",async()=>{if(Y.isActive()){Y.exitAmbientMode(),k();return}await Yi()}),ke.add(document,"keydown",e=>{var s;const t=(s=document.activeElement)==null?void 0:s.tagName,i=c.getState();if(!(t==="INPUT"||t==="TEXTAREA"||t==="SELECT")&&i.currentView==="timer"){if(/^[0-9]$/.test(e.key)){e.preventDefault(),i.bibInput.length<3&&(c.setBibInput(i.bibInput+e.key),k());return}if(e.key==="Backspace"){e.preventDefault(),c.setBibInput(i.bibInput.slice(0,-1)),k();return}if(e.key==="Delete"||e.key==="Escape"){e.preventDefault(),c.setBibInput(""),k();return}if(e.key==="s"||e.key==="S"){e.preventDefault(),c.setSelectedPoint("S"),k(),document.querySelectorAll(".timing-point-btn").forEach(a=>{a.setAttribute("aria-checked",a.getAttribute("data-point")==="S"?"true":"false")});return}if(e.key==="f"||e.key==="F"){e.preventDefault(),c.setSelectedPoint("F"),k(),document.querySelectorAll(".timing-point-btn").forEach(a=>{a.setAttribute("aria-checked",a.getAttribute("data-point")==="F"?"true":"false")});return}if(e.key==="1"&&e.altKey){e.preventDefault(),c.setSelectedRun(1),k();return}if(e.key==="2"&&e.altKey){e.preventDefault(),c.setSelectedRun(2),k();return}if(e.key===" "||e.key==="Enter"){if(e.preventDefault(),Y.isActive()){Y.exitAmbientMode(),k();return}Yi();return}}}))}async function Yi(){const n=c.getState();if(n.isRecording)return;const{entry:e}=xs({bib:n.bibInput,point:n.selectedPoint,run:n.selectedRun,deviceId:n.deviceId,deviceName:n.deviceName,gpsService:ge});c.setRecording(!0);try{if(n.settings.photoCapture){const s=e.id;rs().then(async a=>{if(a)try{if(!c.getState().entries.some(f=>f.id===s)){y.warn("Entry was deleted before photo could be attached:",s);return}if(await Q.savePhoto(s,a))c.updateEntry(s,{photo:"indexeddb"})||(y.warn("Entry deleted during photo save, removing orphaned photo:",s),await Q.deletePhoto(s));else{y.warn("Photo save failed for entry:",s);const f=c.getState().currentLang;I(u("photoSaveFailed",f),"warning")}}catch(r){it("Camera","photo save/update",r,"photoError")}}).catch(a=>{if(a instanceof Error&&a.name==="PhotoTooLargeError"){const r=c.getState().currentLang;I(u("photoTooLarge",r),"warning")}else it("Camera","captureTimingPhoto",a,"photoError")})}const t=Bs(e,n.entries),i=rd(e.bib);if(c.addEntry(e),t?(z(),md(e)):i?(z(),pd(e)):(q(),di(e)),N.broadcastEntry(e),n.settings.auto&&n.bibInput){const s=parseInt(n.bibInput,10)+1,a=n.settings.sync&&n.cloudHighestBib>0?Math.max(s,n.cloudHighestBib+1):s;c.setBibInput(String(a))}else n.bibInput&&n.settings.auto||c.setBibInput("");yd(e)}finally{c.setRecording(!1)}}function di(n){const e=v("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-bib"),i=e.querySelector(".confirmation-point"),s=e.querySelector(".confirmation-run"),a=e.querySelector(".confirmation-time"),r=c.getState();if(t&&(t.textContent=n.bib||"---"),i&&(i.textContent=Ie(n.point,r.currentLang),i.style.color=st(n.point)),s&&n.run&&(s.textContent=et(n.run,r.currentLang),s.style.color=tt(n.run)),a){const l=new Date(n.timestamp);a.textContent=we(l)}e.dataset.point=n.point,e.classList.add("show"),hd(n.point);const o=window.setTimeout(()=>{e.classList.remove("show"),We.delete(o)},1500);We.add(o)}function hd(n){const e=document.getElementById("snowflake-burst");if(!e)return;e.innerHTML="";const t=n==="S"?"var(--start-color)":"var(--finish-color)",i=8;for(let s=0;s<i;s++){const a=document.createElement("span");a.className="flake",a.textContent="❄";const r=s/i*2*Math.PI,o=60+Math.random()*40,l=Math.cos(r)*o,f=Math.sin(r)*o,d=Math.random()*360;a.style.cssText=`
      --burst-x: ${l}px;
      --burst-y: ${f}px;
      --burst-rot: ${d}deg;
      color: ${t};
      font-size: ${.6+Math.random()*.6}rem;
      animation-duration: ${.6+Math.random()*.4}s;
      text-shadow: 0 0 6px ${t};
    `,a.addEventListener("animationend",()=>a.remove(),{once:!0}),e.appendChild(a)}}function md(n){const e=v("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-duplicate");t&&(t.style.display="flex"),di(n);const i=window.setTimeout(()=>{t&&(t.style.display="none"),We.delete(i)},2500);We.add(i)}function pd(n){const e=v("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-zero-bib");t&&(t.style.display="flex"),di(n);const i=window.setTimeout(()=>{t&&(t.style.display="none"),We.delete(i)},2500);We.add(i)}function yd(n){const e=v("last-recorded-inline");if(!e)return;const t=e.querySelector(".bib"),i=e.querySelector(".point"),s=e.querySelector(".run"),a=e.querySelector(".time"),r=c.getState();if(t&&(t.textContent=n.bib||"---"),i&&(i.textContent=Ie(n.point,r.currentLang),i.style.color=st(n.point)),s&&n.run&&(s.textContent=et(n.run,r.currentLang),s.style.color=tt(n.run)),a){const o=new Date(n.timestamp);a.textContent=we(o)}e.classList.add("visible"),e.classList.remove("pulse"),e.offsetWidth,e.classList.add("pulse")}function ui(){const n=c.getState(),e=v("bib-display"),t=e==null?void 0:e.querySelector(".bib-value");t&&(t.textContent=n.bibInput?n.bibInput.padStart(3,"0"):"---");const i=v("timestamp-btn");i&&i.classList.toggle("ready",n.bibInput.length>0)}function fi(){const n=c.getState();document.querySelectorAll(".timing-point-btn").forEach(e=>{const t=e.getAttribute("data-point")===n.selectedPoint;e.classList.toggle("active",t),e.setAttribute("aria-checked",String(t))})}function gi(){const n=c.getState();document.querySelectorAll(".run-btn").forEach(e=>{const t=e.getAttribute("data-run")===String(n.selectedRun);e.classList.toggle("active",t),e.setAttribute("aria-checked",String(t))})}function bd(n){var e,t,i;switch(y.debug("[TimerView] Voice intent:",n.action,n.params),n.action){case"set_bib":(e=n.params)!=null&&e.bib&&(c.setBibInput(n.params.bib),ui(),k());break;case"set_point":(t=n.params)!=null&&t.point&&(c.setSelectedPoint(n.params.point),fi(),k());break;case"set_run":(i=n.params)!=null&&i.run&&(c.setSelectedRun(n.params.run),gi(),k());break;default:y.debug("[TimerView] Unhandled voice intent:",n.action)}}function vd(){Us(),Zt()?Fs():(ui(),fi()),gi(),ln(),Ms(),ut(),un(),qe(),qs(),Gs(),Xl(),li()}function Sd(n){return n.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}function Us(){const n=c.getState();document.querySelectorAll(".view").forEach(i=>{i.classList.remove("active")});const e=Sd(n.currentView),t=document.querySelector(`.${e}-view`);t&&t.classList.add("active"),document.querySelectorAll(".tab-btn").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")===n.currentView)}),n.currentView==="gateJudge"&&(Se(),cn(),oi(),rt())}function ut(){var r,o;const n=c.getState(),e=v("sync-indicator"),t=(r=v("sync-indicator"))==null?void 0:r.querySelector(".sync-dot"),i=(o=v("sync-indicator"))==null?void 0:o.querySelector(".sync-status-text"),s=v("sync-device-count");e&&(e.style.display=n.settings.sync?"flex":"none");const a=n.currentLang;if(t){t.classList.remove("connected","error","offline","syncing"),n.syncStatus==="connected"?t.classList.add("connected"):n.syncStatus==="syncing"?t.classList.add("syncing"):n.syncStatus==="error"?t.classList.add("error"):n.syncStatus==="offline"&&t.classList.add("offline");const l=n.syncStatus==="connected"?u("syncOnline",a):n.syncStatus==="error"?u("syncError",a):n.syncStatus==="offline"?u("syncOffline",a):u("syncing",a);t.setAttribute("aria-label",l)}i&&(i.textContent=u(n.syncStatus,a)),s&&(n.syncStatus==="connected"&&n.cloudDeviceCount>0?(s.textContent=`${n.cloudDeviceCount} ${u("devices",a)}`,s.style.display="inline",s.classList.add("status-active")):n.syncStatus==="error"||n.syncStatus==="offline"?(s.textContent=u("syncOffline",a),s.style.display="inline",s.classList.remove("status-active")):s.style.display="none")}function un(){const n=c.getState(),e=v("gps-indicator"),t=e==null?void 0:e.querySelector(".gps-dot"),i=e==null?void 0:e.querySelector(".gps-status-text");if(e&&(e.style.display=n.settings.gps?"flex":"none"),t){t.classList.remove("active","searching","paused"),n.gpsStatus==="active"?t.classList.add("active"):n.gpsStatus==="searching"?t.classList.add("searching"):n.gpsStatus==="paused"&&t.classList.add("paused");const s=n.currentLang,a=n.gpsStatus==="active"||n.gpsStatus==="paused"?"gpsActive":n.gpsStatus==="searching"?"gpsSearching":"gpsInactive";t.setAttribute("aria-label",u(a,s))}if(i){const s=n.currentLang;n.gpsStatus==="active"||n.gpsStatus==="paused"?(i.textContent=u("gpsActive",s),i.classList.add("status-active"),i.classList.remove("status-inactive","status-searching")):n.gpsStatus==="searching"?(i.textContent=u("gpsSearching",s),i.classList.add("status-searching"),i.classList.remove("status-active","status-inactive")):(i.textContent=u("gpsInactive",s),i.classList.add("status-inactive"),i.classList.remove("status-active","status-searching"))}}function qs(){const n=c.getState(),e=v("camera-indicator");e&&(e.style.display=n.settings.photoCapture?"flex":"none")}function Ed(n){const e=v("voice-indicator"),t=v("voice-status-text");if(e){if(n==="inactive"){e.style.display="none";return}if(e.style.display="flex",e.classList.remove("listening","processing","confirming","offline","error"),e.classList.add(n),t){const i=c.getState().currentLang;switch(n){case"listening":t.textContent=u("voiceListening",i);break;case"processing":t.textContent=u("voiceProcessing",i);break;case"confirming":t.textContent=u("voiceConfirming",i);break;case"offline":t.textContent=u("voiceOffline",i);break;case"error":t.textContent=u("voiceError",i);break}}}}function Gs(){const n=v("undo-btn");n&&n.toggleAttribute("disabled",!c.canUndo())}const Je=new G;let Mt=null;async function wd(n){return new Promise(e=>{Mt=e,window.dispatchEvent(new CustomEvent("request-pin-verification",{detail:{lang:n}}))})}function Ki(n){Mt&&(Mt(n),Mt=null)}function Id(n){window.dispatchEvent(new CustomEvent("open-fault-edit-modal",{detail:{fault:n}}))}function kd(n){window.dispatchEvent(new CustomEvent("open-mark-deletion-modal",{detail:{fault:n}}))}function Cd(){window.dispatchEvent(new CustomEvent("update-inline-faults-list"))}function Zi(){window.dispatchEvent(new CustomEvent("update-inline-bib-selector"))}function Td(){window.dispatchEvent(new CustomEvent("update-inline-gate-selector"))}function Ld(){const n=document.getElementById("chief-judge-toggle-btn");n&&(Je.add(n,"click",async()=>{const e=c.getState(),t=e.currentLang;if(e.isChiefJudgeView){c.toggleChiefJudgeView(),es(),k(),I(u("chiefJudgeModeDisabled",t),"info");return}e.settings.sync&&e.raceId&&!await wd(t)||(c.toggleChiefJudgeView(),es(),k(),I(u("chiefJudgeModeEnabled",t),"info"))}),Xi(),c.subscribe((e,t)=>{(t.includes("settings")||t.includes("faultEntries"))&&Xi(),(t.includes("faultEntries")||t.includes("penaltySeconds")||t.includes("usePenaltyMode"))&&e.isChiefJudgeView&&(ht(),fn()),(t.includes("penaltySeconds")||t.includes("usePenaltyMode"))&&Js(),(t.includes("entries")||t.includes("faultEntries")||t.includes("isJudgeReady"))&&e.isChiefJudgeView&&js(),t.includes("faultEntries")&&e.deviceRole==="gateJudge"&&(Cd(),Zi()),t.includes("entries")&&e.deviceRole==="gateJudge"&&Zi(),t.includes("gateAssignment")&&e.deviceRole==="gateJudge"&&Td()}),Rd(),Ad())}function Ad(){const n=document.getElementById("export-csv-btn");n&&Je.add(n,"click",()=>{k(),ci()});const e=document.getElementById("export-summary-btn");e&&Je.add(e,"click",()=>{k(),Hl()});const t=document.getElementById("export-whatsapp-btn");t&&Je.add(t,"click",()=>{k(),Vl()})}function Rd(){const n=document.getElementById("penalty-mode-toggle");n&&Je.add(n,"click",t=>{const i=t.target.closest(".penalty-mode-btn");if(!i)return;const s=i.getAttribute("data-mode");s==="penalty"?c.setUsePenaltyMode(!0):s==="dsq"&&c.setUsePenaltyMode(!1),k()});const e=document.getElementById("penalty-seconds-selector");e&&Je.add(e,"click",t=>{const i=t.target.closest(".penalty-adj-btn");if(!i)return;const s=i.getAttribute("data-adj"),r=c.getState().penaltySeconds;s==="+1"?c.setPenaltySeconds(r+1):s==="-1"&&c.setPenaltySeconds(r-1),k()}),Js()}function Js(){const n=c.getState(),e=document.getElementById("penalty-config-row"),t=document.getElementById("penalty-seconds-value"),i=document.getElementById("penalty-mode-toggle");e&&e.classList.toggle("dsq-mode",!n.usePenaltyMode),t&&(t.textContent=String(n.penaltySeconds)),i&&i.querySelectorAll(".penalty-mode-btn").forEach(a=>{const r=a.getAttribute("data-mode"),o=r==="penalty"&&n.usePenaltyMode||r==="dsq"&&!n.usePenaltyMode;a.classList.toggle("active",o),a.setAttribute("aria-pressed",String(o))})}function Xi(){const n=document.getElementById("chief-judge-toggle-row");if(!n)return;const t=c.getState().settings.sync;n.style.display=t?"block":"none"}function es(){const n=c.getState(),e=document.querySelector(".results-view"),t=document.getElementById("chief-judge-toggle-btn");!e||!t||(t.classList.toggle("active",n.isChiefJudgeView),t.setAttribute("aria-pressed",String(n.isChiefJudgeView)),e.classList.toggle("chief-mode",n.isChiefJudgeView),n.isChiefJudgeView&&(ht(),fn(),js()))}function js(){const n=document.getElementById("judges-overview-list"),e=document.getElementById("judges-overview-count"),t=document.getElementById("judges-overview-empty");if(!n||!e)return;const i=N.getOtherGateAssignments(),s=c.getState(),a=[...i];if(s.deviceRole==="gateJudge"&&s.gateAssignment&&a.push({deviceId:s.deviceId,deviceName:s.deviceName,gateStart:s.gateAssignment[0],gateEnd:s.gateAssignment[1],lastSeen:Date.now(),isReady:s.isJudgeReady}),e.textContent=String(a.length),t&&(t.style.display=a.length===0?"block":"none"),n.querySelectorAll(".judge-card").forEach(l=>l.remove()),a.length===0)return;a.sort((l,f)=>l.gateStart-f.gateStart);const o=a.map(l=>`
    <div class="judge-card${l.isReady?" ready":""}">
      <span class="judge-ready-indicator"></span>
      <span class="judge-name" title="${R(l.deviceName)}">${T(l.deviceName)}</span>
      <span class="judge-gates">${l.gateStart}–${l.gateEnd}</span>
    </div>
  `).join("");t?t.insertAdjacentHTML("beforebegin",o):n.innerHTML=o}function ht(){const n=document.getElementById("fault-summary-list"),e=document.getElementById("fault-summary-count"),t=document.getElementById("chief-empty-state");if(!n||!e)return;const i=c.getState(),s=i.currentLang,a=i.faultEntries,r=new Map;for(const p of a){const b=`${p.bib}-${p.run}`;r.has(b)||r.set(b,[]),r.get(b).push(p)}if(e.textContent=String(r.size),t&&(t.style.display=r.size===0?"flex":"none"),r.size===0){n.querySelectorAll(".fault-summary-card").forEach(b=>b.remove());return}const o=[],l=Array.from(r.entries()).sort((p,b)=>{const[w]=p,[S]=b,E=parseInt(w.split("-")[0],10)||0,C=parseInt(S.split("-")[0],10)||0;return E-C});for(const[p,b]of l){const[w,S]=p.split("-"),E=parseInt(S,10),C=c.isRacerFinalized(w,E),F=b.filter(B=>!B.markedForDeletion),V=i.usePenaltyMode?F.length*i.penaltySeconds:0,A=b.map(B=>{const re=B.markedForDeletion,mt=re&&B.markedForDeletionBy?`${u("deletionPending",s)} (${B.markedForDeletionBy})`:"",pt=B.notes&&B.notes.length>0;return`
        <div class="fault-entry-row${re?" marked-for-deletion":""}" data-fault-id="${R(B.id)}">
          <div class="fault-gate-info">
            <span class="fault-gate-num${re?" strikethrough":""}">${u("gate",s)} ${T(String(B.gateNumber))}</span>
            <span class="fault-type-badge${re?" marked":""}">${pe(B.faultType,s)}</span>
            ${pt?`<span class="fault-note-icon" title="${R(u("hasNote",s))}" aria-label="${R(u("hasNote",s))}">📝</span>`:""}
            ${re?`<span class="deletion-pending-badge" title="${R(mt)}">⚠</span>`:""}
          </div>
          <span class="fault-judge-name">${T(B.deviceName)}</span>
          <div class="fault-row-actions">
            <button class="fault-row-btn edit-fault-btn" data-fault-id="${R(B.id)}" title="${R(u("edit",s))}" ${re?"disabled":""}>
              ${gs(14)}
            </button>
            <button class="fault-row-btn delete-fault-btn" data-fault-id="${R(B.id)}" title="${R(u(re?"rejectDeletion":"markForDeletion",s))}">
              ${re?Wo(14):Xn(14)}
            </button>
          </div>
        </div>
      `}).join(""),L=C?`<div class="finalized-badge">
           ${$n(16,2.5)}
           ${u("finalized",s)}
         </div>`:`<button class="finalize-btn" data-bib="${R(w)}" data-run="${R(String(E))}">
           ${$n(16)}
           ${u("finalize",s)}
         </button>`,D=i.usePenaltyMode?`<span class="fault-card-penalty">+${V}s</span>
         <span class="fault-card-result flt">${u("flt",s)}</span>`:`<span class="fault-card-result dsq">${u("dsq",s)}</span>`;o.push(`
      <div class="fault-summary-card${C?" finalized":""}" data-bib="${R(w)}" data-run="${R(String(E))}">
        <div class="fault-card-header">
          <span class="fault-card-bib">#${T(w.padStart(3,"0"))}</span>
          <div class="fault-card-status">
            ${D}
          </div>
        </div>
        <div class="fault-card-body">
          ${A}
        </div>
        <div class="fault-card-actions">
          ${L}
        </div>
      </div>
    `)}n.querySelectorAll(".fault-summary-card").forEach(p=>p.remove()),t?t.insertAdjacentHTML("beforebegin",o.join("")):n.innerHTML=o.join(""),n.querySelectorAll(".finalize-btn").forEach(p=>{p.addEventListener("click",xd)}),n.querySelectorAll(".edit-fault-btn").forEach(p=>{p.addEventListener("click",b=>{b.stopPropagation();const w=p.dataset.faultId;if(w){const S=c.getState().faultEntries.find(E=>E.id===w);S&&Id(S)}})}),n.querySelectorAll(".delete-fault-btn").forEach(p=>{p.addEventListener("click",b=>{b.stopPropagation();const w=p.dataset.faultId;if(w){const S=c.getState().faultEntries.find(E=>E.id===w);S&&(S.markedForDeletion?Qs(S):kd(S))}})})}function Qs(n){if(c.rejectFaultDeletion(n.id)){const t=c.getState().faultEntries.find(s=>s.id===n.id);t&&Ke(t);const i=c.getState().currentLang;I(u("deletionRejected",i),"success"),q(),ht(),fn()}}function Dd(n){const e=c.approveFaultDeletion(n.id);if(e){Zn(e);const t=c.getState().currentLang;I(u("deletionApproved",t),"success"),an(),ht(),fn()}}function fn(){const n=document.getElementById("pending-deletions-section"),e=document.getElementById("pending-deletions-list"),t=document.getElementById("pending-deletions-count");if(!n||!e||!t)return;const i=c.getPendingDeletions(),a=c.getState().currentLang;if(t.textContent=String(i.length),n.style.display=i.length>0?"block":"none",i.length===0){e.innerHTML="";return}const r=i.map(o=>{const l=o.markedForDeletionAt?new Date(o.markedForDeletionAt).toLocaleTimeString(a==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"}):"";return`
      <div class="pending-deletion-item" data-fault-id="${R(o.id)}">
        <div class="pending-deletion-info">
          <span class="pending-deletion-fault">
            #${T(o.bib.padStart(3,"0"))} T${T(String(o.gateNumber))} (${pe(o.faultType,a)}) - ${u(o.run===1?"run1":"run2",a)}
          </span>
          <span class="pending-deletion-meta">
            ${u("deletionMarkedBy",a)}: ${T(o.markedForDeletionBy||"?")} (${T(l)})
          </span>
        </div>
        <div class="pending-deletion-actions">
          <button class="pending-deletion-btn approve" data-fault-id="${R(o.id)}" title="${R(u("approveDeletion",a))}">
            ${$n(16,2.5)}
          </button>
          <button class="pending-deletion-btn reject" data-fault-id="${R(o.id)}" title="${R(u("rejectDeletion",a))}">
            ${Yo(16)}
          </button>
        </div>
      </div>
    `}).join("");e.innerHTML=r,e.querySelectorAll(".pending-deletion-btn.approve").forEach(o=>{o.addEventListener("click",l=>{l.stopPropagation();const f=o.dataset.faultId;if(f){const d=i.find(g=>g.id===f);d&&Dd(d)}})}),e.querySelectorAll(".pending-deletion-btn.reject").forEach(o=>{o.addEventListener("click",l=>{l.stopPropagation();const f=o.dataset.faultId;if(f){const d=i.find(g=>g.id===f);d&&Qs(d)}})})}function xd(n){const e=n.currentTarget,t=e.dataset.bib,i=e.dataset.run;if(!t||!i)return;const s=parseInt(i,10);c.finalizeRacer(t,s),q();const a=c.getState();I(`#${t.padStart(3,"0")} ${u("finalized",a.currentLang)}`,"success"),ht()}const W=new G,en=new Set;function ee(n,e,t){const i=e.getBoundingClientRect();let s,a;typeof TouchEvent<"u"&&n instanceof TouchEvent&&n.touches.length>0?(s=n.touches[0].clientX-i.left,a=n.touches[0].clientY-i.top):typeof MouseEvent<"u"&&n instanceof MouseEvent?(s=n.clientX-i.left,a=n.clientY-i.top):(s=i.width/2,a=i.height/2);const r=document.createElement("span");r.classList.add("ripple"),t&&r.classList.add(`ripple-${t}`);const o=Math.max(i.width,i.height)*2;r.style.width=`${o}px`,r.style.height=`${o}px`,r.style.left=`${s-o/2}px`,r.style.top=`${a-o/2}px`,e.appendChild(r);const l=setTimeout(()=>{r.remove(),en.delete(l)},500);en.add(l)}function Bd(){document.querySelectorAll(".num-btn").forEach(e=>{e.classList.add("ripple-container"),W.add(e,"touchstart",t=>ee(t,e),{passive:!0}),W.add(e,"mousedown",t=>ee(t,e))});const n=document.querySelector(".timestamp-btn");n&&(n.classList.add("ripple-container"),W.add(n,"touchstart",e=>ee(e,n,"primary"),{passive:!0}),W.add(n,"mousedown",e=>ee(e,n,"primary"))),document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.add("ripple-container");const t=e.getAttribute("data-point")==="S";W.add(e,"touchstart",i=>ee(i,e,t?"success":"secondary"),{passive:!0}),W.add(e,"mousedown",i=>ee(i,e,t?"success":"secondary"))}),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.add("ripple-container"),W.add(e,"touchstart",t=>ee(t,e,"primary"),{passive:!0}),W.add(e,"mousedown",t=>ee(t,e,"primary"))}),document.querySelectorAll(".action-btn").forEach(e=>{e.classList.add("ripple-container"),W.add(e,"touchstart",t=>ee(t,e),{passive:!0}),W.add(e,"mousedown",t=>ee(t,e))}),document.querySelectorAll(".modal-btn").forEach(e=>{e.classList.add("ripple-container");const t=e.classList.contains("primary"),i=e.classList.contains("danger"),s=t?"primary":i?"secondary":void 0;W.add(e,"touchstart",a=>ee(a,e,s),{passive:!0}),W.add(e,"mousedown",a=>ee(a,e,s))})}function Pd(){W.removeAll(),en.forEach(n=>clearTimeout(n)),en.clear()}const Ws=new G;function te(n,e){Ws.add(window,n,e)}function Nd(){te("open-edit-modal",n=>{il(n.detail.entry)}),te("prompt-delete",n=>{sl(n.detail.entry)}),te("open-confirm-modal",n=>{Rs(n.detail.action)}),te("request-photo-sync-warning",async()=>{try{await Zc(),Qi()}catch(n){y.error("Photo sync warning modal failed:",n),Qi()}}),te("request-race-change-dialog",async n=>{try{const e=n,t=await Kc(e.detail.type,e.detail.lang);Wi(t)}catch(e){y.error("Race change dialog failed:",e),Wi("cancel")}}),te("update-role-toggle",()=>{dn()}),te("request-pin-verification",async n=>{try{const t=await zc(n.detail.lang);Ki(t)}catch(e){y.error("PIN verification failed:",e),Ki(!1)}}),te("open-fault-edit-modal",n=>{ps(n.detail.fault)}),te("open-mark-deletion-modal",n=>{ys(n.detail.fault)}),te("update-inline-faults-list",()=>{on()}),te("update-inline-bib-selector",()=>{bs()}),te("update-inline-gate-selector",()=>{vs()})}function Fd(){if(!_.isSupported()){y.debug("[VoiceMode] Not supported in this browser");return}const n="/api/v1/voice",e=window.VOICE_LLM_CONFIG,t={endpoint:(e==null?void 0:e.endpoint)||n,apiKey:(e==null?void 0:e.apiKey)||"proxy"};if(!_.initialize(t)){y.warn("[VoiceMode] Failed to initialize");return}_.onStatusChange(s=>{Ed(s)}),_.onAction(s=>{c.getState().deviceRole==="gateJudge"?El(s):bd(s)}),y.debug("[VoiceMode] Initialized successfully")}function Ys(n){const{isQuotaError:e,entryCount:t}=n.detail,i=c.getState().currentLang;e?I(u("storageNearlyFull",i),"error",je.CRITICAL):I(u("storageError",i),"error",je.ERROR),z(),y.error("[Storage] saveEntries:",n.detail.message,{entryCount:t,isQuotaError:e})}function Ks(n){const{percent:e,critical:t}=n.detail,i=c.getState().currentLang;t?I(`${u("storageQuotaError",i)} (${e}%)`,"error",je.CRITICAL):sessionStorage.getItem("storage-warning-shown")||(I(u("storageNearlyFull",i),"warning",je.WARNING),sessionStorage.setItem("storage-warning-shown","true"))}function $d(){try{cd(),Nl()}catch(n){y.warn("Timer cleanup error:",n)}N.cleanup(),He.stop(),ge.stop(),Gt.disable(),Y.cleanup(),_.cleanup(),uc(),Pd(),document.querySelectorAll(".ripple").forEach(n=>n.remove()),window.removeEventListener("race-deleted",Ls),window.removeEventListener("auth-expired",As),window.removeEventListener("storage-error",Ys),window.removeEventListener("storage-warning",Ks),Ws.removeAll(),Jl(),ad(),Cs()}function Gn(n){const e=n.currentView==="timer";e&&n.settings.gps?ge.start():n.settings.gps?ge.pause():ge.stop(),e&&n.settings.photoCapture?He.initialize():He.stop()}const Md={bibInput:[()=>{Zt()?Fs():ui()}],selectedPoint:[()=>{Zt()||fi()}],selectedRun:[n=>{gi(),oi(),n.currentView==="gateJudge"&&Se()}],entries:[n=>{const e=$s();e&&e.setEntries(n.entries),ln(),Ms(),n.currentView==="gateJudge"&&Se()}],deviceRole:[()=>{dn(),ri(),qe()}],isJudgeReady:[()=>qe()],gateAssignment:[()=>cn()],faultEntries:[n=>{n.currentView==="gateJudge"&&Se()}],syncStatus:[()=>ut()],cloudDeviceCount:[()=>ut()],gpsStatus:[()=>{un(),qe()}],undoStack:[()=>Gs()]};function Od(n){Us(),un(),ut(),n.currentView==="timer"?Gt.enable():Gt.disable(),n.currentView==="timer"&&n.settings.ambientMode?Y.enable():Y.disable();const e=$s();e&&(n.currentView==="results"?e.resume():e.pause())}function Vd(){ut(),un(),qe(),qs(),zs();const n=c.getState();n.settings.ambientMode?(Y.initialize(),n.currentView==="timer"&&Y.enable()):Y.disable()}function Hd(n,e){e.includes("currentView")&&Od(n),e.includes("settings")&&(Vd(),Gn(n)),e.includes("currentView")&&!e.includes("settings")&&Gn(n);for(const t of e){const i=Md[t];if(i)for(const s of i)s(n)}}let gn=!1;function Zs(){if(gn)return;const n=document.getElementById("offline-banner");if(n){const e=c.getState().currentLang,t=document.getElementById("offline-banner-text");t&&(t.textContent=u("offlineBanner",e)),n.classList.remove("hidden")}}function Xs(){const n=document.getElementById("offline-banner");n&&n.classList.add("hidden")}function _d(){Xs(),gn=!1;const n=c.getState().currentLang;I(u("onlineRestored",n),"success",2e3)}function zd(){gn=!1,Zs()}function Ud(){const n=document.getElementById("offline-banner-dismiss");n&&n.addEventListener("click",()=>{gn=!0,Xs()}),window.addEventListener("online",_d),window.addEventListener("offline",zd),navigator.onLine||Zs()}const Bn="skiTimerHasCompletedOnboarding";function qd(n,e){let t=null;return(...i)=>{t&&clearTimeout(t),t=setTimeout(()=>n(...i),e)}}class Gd{constructor(){h(this,"modal");h(this,"currentStep",1);h(this,"totalSteps",6);h(this,"selectedRole","timer");h(this,"updateTranslationsCallback",null);h(this,"recentRacesDocumentHandler",null);this.modal=document.getElementById("onboarding-modal"),this.modal&&this.setupEventListeners()}setUpdateTranslationsCallback(e){this.updateTranslationsCallback=e}shouldShow(){return localStorage.getItem(Bn)!=="true"}show(){if(!this.modal)return;this.currentStep=1,this.selectedRole="timer",this.modal.querySelectorAll(".onboarding-card").forEach((d,g)=>{d.style.display=g===0?"block":"none"});const e=document.getElementById("onboarding-race-id");e&&(e.value="");const t=document.getElementById("onboarding-pin");t&&(t.value="",t.style.display="none");const i=document.getElementById("onboarding-race-status");i&&(i.textContent="",i.className="race-status");const s=document.getElementById("onboarding-sync-toggle");s&&(s.checked=!0);const a=document.getElementById("onboarding-photo-toggle");a&&(a.checked=!1),this.modal.querySelectorAll(".role-card").forEach(d=>{const g=d.getAttribute("data-role")==="timer";d.classList.toggle("selected",g),d.setAttribute("aria-checked",String(g))});const r=document.getElementById("onboarding-gate-start"),o=document.getElementById("onboarding-gate-end");r&&(r.value="1"),o&&(o.value="10"),this.updateUI(),O(this.modal);const l=document.getElementById("onboarding-device-name");l&&(l.value=c.getState().deviceName);const f=c.getState().currentLang;this.modal.querySelectorAll(".lang-btn").forEach(d=>{const g=d.dataset.lang;d.classList.toggle("selected",g===f)})}reset(){localStorage.removeItem(Bn)}setupEventListeners(){if(!this.modal)return;document.addEventListener("keydown",a=>{var r;a.key==="Escape"&&((r=this.modal)!=null&&r.classList.contains("active"))&&this.dismiss()}),this.modal.querySelectorAll(".lang-btn").forEach(a=>{a.addEventListener("click",r=>{const o=r.currentTarget,l=o.dataset.lang;l&&(c.setLanguage(l),this.modal.querySelectorAll(".lang-btn").forEach(f=>f.classList.remove("selected")),o.classList.add("selected"),k(),this.updateTranslationsCallback&&this.updateTranslationsCallback(),this.updateOnboardingTranslations())})}),this.modal.querySelectorAll("[data-action]").forEach(a=>{a.addEventListener("click",async r=>{const l=r.currentTarget.dataset.action;l&&(k(),await this.handleAction(l))})});const e=document.getElementById("onboarding-regenerate-name");e&&e.addEventListener("click",()=>{const a=document.getElementById("onboarding-device-name");a&&(a.value=zt(),k())}),this.modal.querySelectorAll(".role-card").forEach(a=>{a.addEventListener("click",()=>{const r=a.getAttribute("data-role");r&&(this.selectedRole=r,this.modal.querySelectorAll(".role-card").forEach(o=>{const l=o===a;o.classList.toggle("selected",l),o.setAttribute("aria-checked",String(l))}),k())})});const t=document.getElementById("onboarding-race-id");if(t){const a=qd(()=>this.checkRaceExists(),500);t.addEventListener("input",()=>{a();const r=document.getElementById("onboarding-pin");r&&(r.style.display=t.value.trim()?"block":"none")})}const i=document.getElementById("onboarding-recent-races-btn"),s=document.getElementById("onboarding-recent-races-dropdown");i&&s&&(i.addEventListener("click",()=>{k(),s.style.display==="none"?(this.showRecentRacesDropdown(s,"onboarding-race-id"),i.setAttribute("aria-expanded","true")):(s.style.display="none",i.setAttribute("aria-expanded","false"))}),this.recentRacesDocumentHandler||(this.recentRacesDocumentHandler=a=>{const r=a.target;!i.contains(r)&&!s.contains(r)&&(s.style.display="none",i.setAttribute("aria-expanded","false"))},document.addEventListener("click",this.recentRacesDocumentHandler)))}async showRecentRacesDropdown(e,t){const i=c.getState().currentLang;e.innerHTML=`<div class="recent-races-empty">${u("loading",i)}</div>`,e.style.display="block";let s=[];if(Ce())try{s=await this.fetchRacesFromApi()}catch(a){y.warn("Failed to fetch races from API:",a),s=Ut()}else s=Ut();s.length===0?e.innerHTML=`<div class="recent-races-empty">${u("noRecentRaces",i)}</div>`:(e.innerHTML=Os(s),Vs(e,s,a=>{this.selectRecentRace(a,t,e)}))}async fetchRacesFromApi(){const e=localStorage.getItem("skiTimerAuthToken");if(!e)return[];const t=await ae("/api/v1/admin/races",{headers:{Authorization:`Bearer ${e}`}},5e3);if(!t.ok)throw new Error(`API error: ${t.status}`);const s=(await t.json()).races||[],a=new Date;a.setHours(0,0,0,0);const r=a.getTime(),o=s.filter(l=>l.lastUpdated&&l.lastUpdated>=r).map(l=>({raceId:l.raceId,createdAt:l.lastUpdated||Date.now(),lastUpdated:l.lastUpdated||Date.now(),entryCount:l.entryCount})).slice(0,5);return o.forEach(l=>{Wn(l.raceId,l.lastUpdated,l.entryCount)}),o}selectRecentRace(e,t,i){const s=document.getElementById(t);s&&(s.value=e.raceId,s.dispatchEvent(new Event("input",{bubbles:!0})),k()),i.style.display="none"}updateOnboardingTranslations(){if(!this.modal)return;const e=c.getState().currentLang;this.modal.querySelectorAll("[data-i18n]").forEach(t=>{const i=t.getAttribute("data-i18n");i&&(t.textContent=u(i,e))})}async handleAction(e){switch(e){case"next":await this.validateCurrentStep()&&(await this.saveCurrentStep(),c.forceSave(),this.goToStep(this.currentStep+1));break;case"back":this.currentStep>1&&this.goToStep(this.currentStep-1);break;case"skip":c.forceSave(),this.goToStep(this.currentStep+1);break;case"finish":this.complete();break;case"dismiss":this.dismiss();break}}finalize(){if(c.forceSave(),localStorage.setItem(Bn,"true"),M(this.modal),this.selectedRole==="gateJudge"){c.setView("gateJudge");const e=document.getElementById("gate-judge-tab");e&&(e.style.display="")}else c.setView("timer");this.recentRacesDocumentHandler&&(document.removeEventListener("click",this.recentRacesDocumentHandler),this.recentRacesDocumentHandler=null)}dismiss(){const e=document.getElementById("onboarding-device-name");e!=null&&e.value.trim()&&c.setDeviceName(e.value.trim()),c.setDeviceRole(this.selectedRole),this.finalize()}async validateCurrentStep(){var t,i,s,a;const e=c.getState().currentLang;switch(this.currentStep){case 2:return!0;case 3:return((t=document.getElementById("onboarding-device-name"))==null?void 0:t.value.trim())?!0:(I(u("deviceName",e),"warning"),!1);case 4:return!0;case 5:{const r=(i=document.getElementById("onboarding-race-id"))==null?void 0:i.value.trim(),o=(s=document.getElementById("onboarding-sync-toggle"))==null?void 0:s.checked;if(!r||!o)return!0;const l=(a=document.getElementById("onboarding-pin"))==null?void 0:a.value;return l.length!==4?(I(u("invalidPin",e),"warning"),!1):await this.validatePin(l)}default:return!0}}async saveCurrentStep(){var e,t,i,s,a,r;switch(this.currentStep){case 2:{c.setDeviceRole(this.selectedRole);break}case 3:{const o=(e=document.getElementById("onboarding-device-name"))==null?void 0:e.value.trim();o&&c.setDeviceName(o);break}case 4:{if(this.selectedRole==="gateJudge"){const o=parseInt(((t=document.getElementById("onboarding-gate-start"))==null?void 0:t.value)||"1",10),l=parseInt(((i=document.getElementById("onboarding-gate-end"))==null?void 0:i.value)||"10",10),f=Math.min(o,l),d=Math.max(o,l);c.setGateAssignment([f,d])}else{const o=(s=document.getElementById("onboarding-photo-toggle"))==null?void 0:s.checked;c.updateSettings({photoCapture:o})}break}case 5:{const o=(a=document.getElementById("onboarding-race-id"))==null?void 0:a.value.trim(),l=(r=document.getElementById("onboarding-sync-toggle"))==null?void 0:r.checked;o&&c.setRaceId(o);const f=l&&!!o;c.updateSettings({sync:f}),f&&N.initialize();break}}}goToStep(e){if(!(!this.modal||e<1||e>this.totalSteps)){if(this.modal.querySelectorAll(`[data-step="${this.currentStep}"]`).forEach(t=>{t.style.display="none"}),this.currentStep=e,e===4){const t=this.modal.querySelector(`[data-step="4"][data-path="${this.selectedRole}"]`);t&&(t.style.display="block")}else{const t=this.modal.querySelector(`[data-step="${e}"]:not([data-path])`);t&&(t.style.display="block")}this.updateUIForRole(),this.updateProgressDots(),e===6&&this.showSummary()}}updateUIForRole(){const e=c.getState().currentLang,t=document.getElementById("onboarding-device-name-title"),i=document.getElementById("onboarding-device-name-desc");this.selectedRole==="gateJudge"?(t&&(t.textContent=u("onboardingDeviceNameJudge",e)),i&&(i.textContent=u("onboardingDeviceNameJudgeDesc",e))):(t&&(t.textContent=u("onboardingDeviceName",e)),i&&(i.textContent=u("onboardingDeviceNameDesc",e)));const s=document.getElementById("onboarding-ready-title"),a=document.getElementById("onboarding-ready-tip"),r=document.getElementById("onboarding-finish-btn");this.selectedRole==="gateJudge"?(s&&(s.textContent=u("onboardingReadyJudge",e)),a&&(a.textContent=u("onboardingTipJudge",e)),r&&(r.textContent=u("startJudging",e))):(s&&(s.textContent=u("onboardingReady",e)),a&&(a.textContent=u("onboardingTip",e)),r&&(r.textContent=u("startTiming",e)))}updateProgressDots(){if(!this.modal)return;const e=this.modal.querySelectorAll(".progress-dot");e.forEach((i,s)=>{i.classList.remove("active","completed"),s+1===this.currentStep?i.classList.add("active"):s+1<this.currentStep&&i.classList.add("completed")});const t=this.modal.querySelector("#onboarding-progress-label");if(t){const i=e.length,s=c.getState().currentLang;t.textContent=s==="de"?`Schritt ${this.currentStep} von ${i}`:`Step ${this.currentStep} of ${i}`}}updateUI(){this.updateProgressDots(),this.updateOnboardingTranslations()}showSummary(){const e=c.getState(),t=e.currentLang,i=document.getElementById("onboarding-summary");if(i){i.innerHTML="";const s=[],a=this.selectedRole==="gateJudge"?u("roleJudgeTitle",t):u("roleTimerTitle",t);s.push({label:u("deviceRole",t),value:a,badge:"role"});const r=this.selectedRole==="gateJudge"?u("onboardingDeviceNameJudge",t):u("deviceNameLabel",t);if(s.push({label:r,value:e.deviceName}),this.selectedRole==="gateJudge"){const f=e.gateAssignment;s.push({label:u("gates",t),value:f?`${f[0]}–${f[1]}`:"—"})}else{const f=e.settings.photoCapture;s.push({label:u("photoCaptureLabel",t),value:u(f?"enabled":"disabled",t),badge:f?"enabled":"disabled"})}s.push({label:u("raceIdLabel",t),value:e.raceId||"—"});const o=e.settings.sync;s.push({label:u("syncStatusLabel",t),value:u(o?"enabled":"disabled",t),badge:o?"enabled":"disabled"});const l=document.createElement("div");l.className="onboarding-summary-list",s.forEach(({label:f,value:d,badge:g})=>{const m=document.createElement("div");m.className="onboarding-summary-row";const p=document.createElement("span");p.className="onboarding-summary-label",p.textContent=f;const b=document.createElement("span");g?b.className=`onboarding-summary-badge ${g}`:b.className="onboarding-summary-value",b.textContent=d,m.append(p,b),l.appendChild(m)}),i.appendChild(l)}}async checkRaceExists(){const e=document.getElementById("onboarding-race-id"),t=document.getElementById("onboarding-race-status");if(!e||!t)return;const i=e.value.trim(),s=c.getState().currentLang;if(!i){t.textContent="",t.className="race-status";return}t.textContent=`⏳ ${u("loading",s)}`,t.className="race-status loading";const a=await N.checkRaceExists(i);if(a.exists){const r=a.entryCount===1?u("entry",s):u("entries",s);t.textContent=`✓ ${u("raceFound",s)} (${a.entryCount} ${r})`,t.className="race-status found"}else t.textContent=`+ ${u("raceNew",s)}`,t.className="race-status new"}async validatePin(e){try{return(await ls(e)).success}catch{const t=c.getState().currentLang;return I(`${u("networkError",t)} - ${u("pinVerifyOnline",t)}`,"warning",5e3),!0}}complete(){this.finalize(),q(),I(u("onboardingComplete",c.getState().currentLang),"success")}}let Le=null;function ts(){const n=document.getElementById("app-version");n&&(n.textContent="5.21.0");const e=Un("5.21.0"),t=document.getElementById("app-version-name"),i=document.getElementById("app-version-description");e&&t&&(t.textContent=`"${e.name}"`),e&&i&&(i.textContent=e.description);const s=document.getElementById("version-info-btn");if(s&&s.addEventListener("click",async()=>{const m=c.getState(),p=Un("5.21.0"),w=[p?`Ski Race Timer v5.21.0 "${p.name}"`:"Ski Race Timer v5.21.0",`Device: ${m.deviceName||"Unknown"}`,`Role: ${m.deviceRole}`,`Race ID: ${m.raceId||"None"}`,`Entries: ${m.entries.length}`,`Sync: ${m.settings.sync?"On":"Off"}`,`Language: ${m.currentLang.toUpperCase()}`,`User Agent: ${navigator.userAgent}`,`Screen: ${window.screen.width}x${window.screen.height}`,`Viewport: ${window.innerWidth}x${window.innerHeight}`,`Online: ${navigator.onLine}`,`Timestamp: ${new Date().toISOString()}`].join(`
`);try{await navigator.clipboard.writeText(w),I(u("debugInfoCopied",m.currentLang),"success")}catch{I(u("debugInfoCopyFailed",m.currentLang),"warning")}k()}),ld(),Zt()?Cl():(od(),dd(),ud(),fd(),gd()),Ul(),Yl(),pl(),Ld(),Nd(),nl(),tl(),Bd(),Ud(),c.subscribe(Hd),c.getState().settings.sync&&c.getState().raceId)if(Ce())N.initialize();else{c.updateSettings({sync:!1});const m=document.getElementById("sync-toggle");m&&(m.checked=!1),setTimeout(()=>{const p=c.getState().currentLang;I(u("syncRequiresPin",p),"info",5e3)},500)}Gn(c.getState()),window.addEventListener("race-deleted",Ls),window.addEventListener("auth-expired",As),window.addEventListener("storage-error",Ys),window.addEventListener("storage-warning",Ks),document.addEventListener("click",ki,{once:!0}),document.addEventListener("touchstart",ki,{once:!0}),window.addEventListener("beforeunload",$d),_s(),vd();const r=c.getState();r.currentView==="timer"&&Gt.enable(),r.settings.ambientMode&&(Y.initialize(),r.currentView==="timer"&&Y.enable()),Y.subscribe(m=>{document.body.classList.toggle("ambient-mode",m.isActive),m.triggeredBy?document.body.dataset.ambientTrigger=m.triggeredBy:delete document.body.dataset.ambientTrigger;const p=c.getState();p.settings.gps&&(m.isActive?ge.pause():p.currentView==="timer"&&ge.start())}),Fd(),Le=new Gd,Le.setUpdateTranslationsCallback(()=>li()),Le.shouldShow()&&Le.show();const o=document.getElementById("show-tutorial-btn");o&&o.addEventListener("click",()=>{Le&&(Le.reset(),Le.show(),k())});const l=document.getElementById("keyboard-shortcuts-modal"),f=document.getElementById("show-shortcuts-btn"),d=document.getElementById("shortcuts-close-btn"),g=document.getElementById("shortcuts-done-btn");f&&l&&f.addEventListener("click",()=>{O(l),k()}),d&&l&&d.addEventListener("click",()=>M(l)),g&&l&&g.addEventListener("click",()=>M(l)),document.addEventListener("keydown",m=>{if(m.key==="?"&&!ms()){const p=m.target;if(p.tagName==="INPUT"||p.tagName==="TEXTAREA"||p.tagName==="SELECT")return;m.preventDefault(),l&&O(l)}})}let Pn=!1,nt=[];const Jd=3,jd=1e4;function Qd(){window.addEventListener("error",Wd),window.addEventListener("unhandledrejection",Yd),window.addEventListener("critical-error",Kd)}function Wd(n){const{message:e,error:t}=n;rn("Global","uncaught error",t||e,void 0),ea(e),ta()&&hi(e),n.preventDefault()}function Yd(n){const e=n.reason,t=e instanceof Error?e.message:String(e);rn("Global","unhandled rejection",e,void 0),ea(t),ta()&&hi(t),n.preventDefault()}function Kd(n){var i;const e=n.detail,t=((i=e==null?void 0:e.error)==null?void 0:i.message)||"Critical error occurred";lo("Global","critical error event",e==null?void 0:e.error,void 0),hi(t)}function ea(n){const e=Date.now();nt.push({message:n,timestamp:e}),nt=nt.filter(t=>e-t.timestamp<jd)}function ta(){return nt.length>=Jd}function hi(n){var s,a;if(Pn)return;Pn=!0;const e=c.getState().currentLang,t=document.createElement("div");t.id="error-boundary-overlay",t.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 24px;
  `;const i=document.createElement("div");i.style.cssText=`
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    text-align: center;
    color: #fff;
  `,i.innerHTML=`
    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
    <h2 style="margin: 0 0 8px; font-size: 1.25rem;">${u("errorOccurred",e)}</h2>
    <p style="color: #999; font-size: 0.875rem; margin: 0 0 16px;">
      ${u("errorRecoveryMessage",e)}
    </p>
    <p style="color: #666; font-size: 0.75rem; font-family: monospace; margin: 0 0 24px; word-break: break-word;">
      ${Zd(n.substring(0,200))}
    </p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="error-dismiss-btn" style="
        padding: 12px 24px;
        border: 1px solid #444;
        border-radius: 8px;
        background: transparent;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${u("dismiss",e)}</button>
      <button id="error-reload-btn" style="
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #3B82F6;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${u("reload",e)}</button>
    </div>
  `,t.appendChild(i),document.body.appendChild(t),setTimeout(()=>{const r=document.getElementById("error-dismiss-btn");r==null||r.focus()},100),(s=document.getElementById("error-dismiss-btn"))==null||s.addEventListener("click",()=>{t.remove(),Pn=!1,nt=[]}),(a=document.getElementById("error-reload-btn"))==null||a.addEventListener("click",()=>{window.location.reload()})}function Zd(n){const e=document.createElement("div");return e.textContent=n,e.innerHTML}Qd();Ia();ei();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ts):ts();let Ot=null;Z.initialize().then(()=>{Ot=Z.subscribe(n=>{document.body.classList.toggle("power-saver",n.batteryLevel!=="normal")})}).catch(()=>{});window.addEventListener("beforeunload",()=>{Ot&&(Ot(),Ot=null)});
