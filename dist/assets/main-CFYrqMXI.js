var $r=Object.defineProperty;var Mr=(t,e,n)=>e in t?$r(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var g=(t,e,n)=>Mr(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();const Or="modulepreload",Vr=function(t){return"/"+t},_i={},Xn=function(e,n,i){let s=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),o=(a==null?void 0:a.nonce)||(a==null?void 0:a.getAttribute("nonce"));s=Promise.allSettled(n.map(c=>{if(c=Vr(c),c in _i)return;_i[c]=!0;const u=c.endsWith(".css"),d=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${d}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":Or,u||(h.as="script"),h.crossOrigin="",h.href=c,o&&h.setAttribute("nonce",o),document.head.appendChild(h),u)return new Promise((m,p)=>{h.addEventListener("load",m),h.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${c}`)))})}))}function r(a){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=a,window.dispatchEvent(o),!o.defaultPrevented)throw a}return s.then(a=>{for(const o of a||[])o.status==="rejected"&&r(o.reason);return e().catch(r)})},Hi={en:{timer:"Timer",results:"Results",settings:"Settings",start:"Start",finish:"Finish",startShort:"S",finishShort:"F",bib:"Bib",point:"Point",run:"Run",run1:"R1",run2:"R2",time:"Record time",lastRecorded:"Last recorded",lastRecordedShort:"Last:",advancedSettings:"Advanced Settings",status:"Status",noEntries:"No entries recorded",noEntriesHint:"Record times on the Timer tab",search:"Search by bib...",filter:"Filter",all:"All",total:"Total",racers:"Racers",finished:"Finished",fastest:"Fastest",average:"Average",timeEntry:"time",timeEntries:"times",faultEntry:"fault",faultEntries:"faults",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Delete Entry",confirmDeleteText:"Are you sure you want to delete this entry?",confirmDeleteFault:"Delete this fault?",confirmClearAll:"Clear All Results",clearAllText:"This will delete all recorded entries. This action cannot be undone.",confirmUndoAdd:"Undo Recording",confirmUndoAddText:"This will delete the recorded entry. Continue?",delete:"Delete",cancel:"Cancel",close:"Close",back:"Back",save:"Save",saving:"Saving...",edit:"Edit",undo:"Undo",export:"Export",clearAll:"Clear All",selectAll:"Select All",deleteSelected:"Delete Selected",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Synced from cloud",raceId:"Race ID",invalidRaceId:"Invalid Race ID. Use letters, numbers, hyphens, underscores only.",deviceName:"Time Keeper ID",cloudSync:"Cloud Sync",syncStatus:"Sync Status",pendingSync:"pending sync",raceSetup:"Race Setup",raceSetupDesc:"Required for multi-device timing and syncing.",firstGateLabel:"First gate",saved:"Saved",deleted:"Deleted",cleared:"All entries cleared",undone:"Undone",copied:"Copied to clipboard",debugInfoCopied:"Debug info copied to clipboard",debugInfoCopyFailed:"Tap and hold to copy debug info",duplicateWarning:"Duplicate entry detected",zeroBibWarning:"Bib 000 - verify entry",exported:"Exported successfully",gps:"GPS",gpsActive:"GPS Active",gpsSearching:"Searching for GPS...",gpsInactive:"GPS Inactive",gpsAccuracy:"Accuracy",settingsRaceSetup:"Race Setup",settingsTimingGroup:"Timing",settingsSyncGroup:"Sync",settingsFeedbackGroup:"Feedback",settingsDisplayGroup:"Display",simpleMode:"Simple Mode",fullMode:"Full Mode",autoIncrement:"Auto-increment Bib",hapticFeedback:"Haptic Feedback",soundFeedback:"Sound Feedback",language:"Language",advancedSettingsHint:"These options can affect timing accuracy. Change only if needed.",simpleModeDesc:"Simplified interface for basic timing",cloudSyncDesc:"Sync with other devices",gpsDesc:"Use GPS for accurate timestamps",autoIncrementDesc:"Increase bib number after recording",photoCaptureDesc:"Capture photo on timestamp",hapticFeedbackDesc:"Vibration on actions",soundFeedbackDesc:"Audio confirmation",ambientMode:"Ambient Mode",ambientModeDesc:"Auto-dim after 30s inactivity",photoCapture:"Photo Capture",photoCaptured:"Photo captured",photoError:"Photo capture failed",photoSaveFailed:"Photo storage failed",viewPhoto:"View Photo",deletePhoto:"Delete Photo",photoFor:"Photo for Bib",noPhotoAvailable:"No photo available",photoDeleted:"Photo deleted",raceChangeTitle:"Change Race",raceChangeSyncedText:"You have results from another race. Export or delete them before switching?",raceChangeUnsyncedText:"You have existing results. Keep them or delete before switching?",keepResults:"Keep",version:"Version",devices:"Devices",entries:"entries",selected:"selected",raceFound:"Race found",raceNew:"New race",entryInCloud:"entry in cloud",entriesInCloud:"entries in cloud",photoTooLarge:"Photo too large for sync",syncedEntriesFromCloud:"Synced {count} entries from cloud",syncedFaultsFromCloud:"Synced {count} faults from cloud",crossDeviceDuplicate:"Duplicate: Bib {bib} {point} already recorded by {device}",syncPhotos:"Sync Photos",syncPhotosDesc:"Share photos across devices via cloud",syncPhotosWarning:"Enable Photo Sync",syncPhotosWarningText:"Enabling photo sync will transfer the following data:",photosToUpload:"Photos to upload",photosToDownload:"Photos to download",totalDataVolume:"Total data volume",enableSync:"Enable Sync",noPhotosToSync:"No photos to sync",admin:"Admin",adminPin:"Race Management PIN",adminPinDesc:"Required to manage and sync races",manageRaces:"Manage Races",manageRacesDesc:"View and delete synced races",manage:"Manage",enterAdminPin:"Enter Race Management PIN",enterPinText:"Enter your PIN to access race management.",enterPinToJoinRace:"Enter your PIN to join this race.",enterPinForChiefJudge:"Enter your PIN to access Chief Judge mode.",enterChiefJudgePin:"Enter Chief Judge PIN",enterPinForChiefJudgeInfo:"Chief Judge mode requires a separate PIN. First use sets the PIN.",syncRequiresPin:"Sync disabled. Enable sync and enter PIN to reconnect.",incorrectPin:"Incorrect PIN",verify:"Verify",setPinFirst:"Please set a Race Management PIN first",pinSaved:"PIN saved",pinCleared:"PIN cleared",pinNotSet:"Not set",pinSet:"PIN set",setPin:"Set PIN",changePin:"Change PIN",currentPin:"Current PIN",newPin:"New PIN (4 digits)",confirmPin:"Confirm PIN",pinMismatch:"PINs do not match",pinFormatError:"PIN must be exactly 4 digits",loading:"Loading...",noRaces:"No active races",noRacesHint:"Create one in Settings",cleanRunHint:"Clean run so far",refresh:"Refresh",raceDeleted:"Race Deleted",raceDeletedText:"This race has been deleted by an administrator.",raceDeletedFor:"Race deleted:",raceDeletedSuccess:"Race deleted:",confirmDeleteRace:"Delete Race",confirmDeleteRaceText:"Are you sure you want to delete race",loadError:"Failed to load races. Check your connection and try again.",deleteError:"Failed to delete race",entry:"entry",device:"device",storageError:"Failed to save data - check storage",storageQuotaError:"Storage full! Export data immediately",storageWarning:"Storage almost full",storageNearlyFull:"Storage nearly full. Export data and clear old entries.",networkError:"Network error - check connection",connectionFailed:"Connection failed",serverUnavailable:"Server unavailable",rateLimitError:"Too many requests - please wait",authError:"Authentication failed. Try re-entering your PIN.",syncFailed:"Sync failed",pinSyncFailed:"PIN not synced to cloud",cameraError:"Camera error",cameraPermissionDenied:"Camera access denied",gpsError:"GPS error",gpsPermissionDenied:"GPS access denied",gpsUnavailable:"GPS unavailable",wakeLockFailed:"Screen may dim during timing",wakeLockIdleTimeout:"Screen will dim to save battery. Tap to keep awake.",unknownError:"Unknown error",onboardingWelcome:"Welcome to Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronized timing for ski races",getStarted:"Get Started",skipSetup:"Skip",onboardingRole:"What's Your Role?",onboardingRoleDesc:"Choose how you'll be helping at the race",roleTimerTitle:"Timer",roleTimerDesc:"You will record start and finish times",roleJudgeTitle:"Gate Judge",roleJudgeDesc:"You will record gate faults (Torrichter)",onboardingDeviceName:"Name Your Timer",onboardingDeviceNameDesc:"This identifies your device when syncing",onboardingDeviceNameJudge:"Your Name",onboardingDeviceNameJudgeDesc:"This identifies you as the gate judge",onboardingPhoto:"Photo Documentation",onboardingPhotoDesc:"Automatically capture a photo when recording each timestamp. Useful for verifying bib numbers and resolving disputes.",enablePhotoCapture:"Enable Photo Capture",photoCaptureLabel:"Photo Capture",onboardingGates:"Your Gate Assignment",onboardingGatesDesc:"Enter the gate numbers you'll be watching. You can change this later.",onboardingRaceSetup:"Join a Race",onboardingRaceSetupDesc:"Enter a race ID to sync with other timers",skipForNow:"Skip for now",onboardingReady:"Ready to Time!",onboardingReadyJudge:"Ready to Judge!",onboardingTip:"Tap the big blue button to record timestamps",onboardingTipJudge:"Tap a racer's bib to record a fault",startTiming:"Start Timing",startJudging:"Start Judging",continue:"Continue",deviceNameLabel:"Device Name",raceIdLabel:"Race ID",syncStatusLabel:"Cloud Sync",enabled:"Enabled",disabled:"Disabled",showTutorial:"Show Tutorial",showTutorialDesc:"Run the setup wizard again",show:"Show",onboardingComplete:"Setup complete!",invalidPin:"PIN must be 4 digits",recentRaces:"Recent Races",noRecentRaces:"No races from today",errorOccurred:"Something went wrong",errorRecoveryMessage:"The app encountered an error. You can dismiss this and continue, or reload the app.",dismiss:"Dismiss",reload:"Reload",updateAvailable:"Update available! Reload to get the latest version.",operationFailed:"Operation failed. Please try again.",raceIdPlaceholder:"RACE-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Photo for bib",gateJudge:"Gate Judge",gateJudgeTab:"Gate",deviceRole:"Device Role",deviceRoleDesc:"Timer records times, Gate Judge records faults",roleTimer:"Timer",roleGateJudge:"Gate Judge",gateAssignment:"Gate Assignment",noGateAssignment:"No gate assignment. Please set your gate range first.",gates:"Gates",gatesFrom:"From",gatesTo:"To",firstGateColor:"Color of first gate",colorRed:"Red",colorBlue:"Blue",changeGates:"Change",otherJudges:"Other judges:",activeBibs:"On Course",noBibsOnCourse:"No racers on course",recordFault:"Record Fault",faultType:"Fault Type",faultMG:"Missed Gate",faultSTR:"Straddling",faultBR:"Binding Release",faultMGShort:"MG",faultSTRShort:"STR",faultBRShort:"BR",orEnterManually:"or enter:",faultRecorded:"Fault recorded",signalReady:"Ready",judgeReady:"Ready for race!",judgeNotReady:"Ready status cleared",faultDeleted:"Fault deleted",recordedFaults:"Recorded Faults",selectBib:"Select Bib",selectGate:"Gate",gate:"Gate",noFaults:"No faults recorded",faultsFor:"Faults for",faultSummary:"Fault Summary",penaltyTime:"Penalty",faultCount:"faults",markOk:"Mark OK",saveFault:"Save Fault",selectFaultType:"Please select a fault type",gateOutOfRange:"Gate is outside assigned range",flt:"FLT",statusFlt:"Fault Penalty",chiefJudge:"Chief Judge",noFaultsRecorded:"No faults recorded",finalize:"Finalize",finalized:"Finalized",chiefJudgeMode:"Chief Judge Mode",chiefJudgeModeEnabled:"Chief Judge mode enabled",chiefJudgeModeDisabled:"Chief Judge mode disabled",racersWithFaults:"Racers with faults",penaltyMode:"+Time",gateJudges:"Gate Judges",noJudgesConnected:"No gate judges connected",summary:"Summary",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"No faults to export",copiedToClipboard:"Copied to clipboard",gateJudgeCard:"Gate Judge Card",race:"Race",date:"Date",gateJudgeLabel:"Gate Judge",runLabel:"Run",noFaultsEntered:"No faults entered",signature:"Signature",legend:"Legend",missedGateLegend:"Missed",straddlingLegend:"Straddling",bindingLegend:"Binding",gateFaults:"Gate Faults",penaltyLabel:"PENALTY",faultSummaryTitle:"GATE FAULT SUMMARY",faults:"Faults",penalty:"Penalty",sec:"sec",generated:"Generated",editFault:"Edit Fault",versionHistory:"Version History",restoreVersion:"Restore Selected Version",currentVersion:"Current",originalVersion:"Original",restored:"Restored",versionRestored:"Version restored",markForDeletion:"Mark for Deletion",markForDeletionText:"This fault will be marked for deletion and requires Chief Judge approval to permanently delete.",markedForDeletion:"Marked for deletion",deletionPending:"Deletion pending",pendingDeletions:"Pending Deletions",approveDeletion:"Approve Deletion",rejectDeletion:"Reject Deletion",deletionMarkedBy:"Marked by",deletionApproved:"Deletion approved",deletionRejected:"Deletion rejected",cannotEditPendingDeletion:"Cannot edit fault pending deletion",voiceMode:"Voice Mode",voiceModeDesc:"Hands-free voice commands (requires internet)",voiceListening:"Listening...",voiceProcessing:"Processing...",voiceConfirming:"Confirm?",voiceOffline:"Voice unavailable offline",voiceNotSupported:"Voice not supported in this browser",voicePermissionDenied:"Microphone access denied",voiceOK:"OK",voiceRecorded:"Recorded",voiceNotUnderstood:"Not understood",voiceCancelled:"Cancelled",voiceError:"Voice error",voiceApiKeyRequired:"API key required for voice mode",pullToRefresh:"Pull to refresh",releaseToRefresh:"Release to refresh",synced:"Synced",syncingStatus:"Syncing...",gateAssignmentInstructions:"Enter the gate range you are responsible for:",readySuffix:" - Ready",viewPhotoLabel:"View photo",editEntryLabel:"Edit entry",deleteEntryLabel:"Delete entry",editFaultLabel:"Edit fault",deleteFaultLabel:"Delete fault",deleteLabel:"Delete",gateNumberLabel:"Gate",numberLabel:"Number",currentTime:"Current time",pinVerifyOnline:"PIN will be verified when online",addNote:"Add Note",done:"Done",recordNote:"Record Note",listening:"Listening...",noteSaved:"Note saved",noteDeleted:"Note deleted",noteCharCount:"characters",voiceNoteUnsupported:"Voice input not supported in this browser",voiceNoteError:"Voice input error",typeNote:"Type or speak your note...",hasNote:"Has note",noteTextLabel:"Note text",recordVoiceNoteLabel:"Record voice note",syncOnline:"Sync online",syncOffline:"Offline",sessionExpired:"Session expired. Please re-enter your PIN.",authSuccess:"Authentication successful",keyboardShortcuts:"Keyboard Shortcuts",keyboardShortcutsDesc:"Show all keyboard shortcuts",shortcutSection_timer:"Timer",shortcutSection_gateJudge:"Gate Judge",shortcutSection_results:"Results",shortcutSection_global:"Global",shortcut_enterDigit:"Enter bib digit",shortcut_selectStart:"Select Start",shortcut_selectFinish:"Select Finish",shortcut_selectRun1:"Select Run 1",shortcut_selectRun2:"Select Run 2",shortcut_recordTime:"Record timestamp",shortcut_clearBib:"Clear bib",shortcut_deleteLastDigit:"Delete last digit",shortcut_missedGate:"Missed Gate",shortcut_straddled:"Straddled",shortcut_broken:"Broken gate",shortcut_selectGate:"Select gate",shortcut_navigateBtns:"Navigate buttons",shortcut_confirmSelection:"Confirm selection",shortcut_navigateItems:"Navigate items",shortcut_editItem:"Edit item",shortcut_deleteItem:"Delete item",shortcut_moveTab:"Move between tabs",shortcut_closeModal:"Close modal",shortcut_navigateInComponent:"Navigate in component",shortcut_showShortcuts:"Show shortcuts",offlineBanner:"You are offline. Times will be saved locally.",onlineRestored:"Back online",entryDeleted:"Entry deleted",undoAction:"Undo",multiDeviceDuplicate:"Multi-device",duplicateDevices:"{count} devices",duplicateCount:"{count} duplicates"},de:{timer:"Timer",results:"Ergebnisse",settings:"Einstellungen",start:"Start",finish:"Ziel",startShort:"S",finishShort:"Z",bib:"Startnr.",point:"Punkt",run:"Lauf",run1:"L1",run2:"L2",time:"Zeit erfassen",lastRecorded:"Zuletzt erfasst",lastRecordedShort:"Letzter:",advancedSettings:"Erweiterte Einstellungen",status:"Status",noEntries:"Keine Einträge vorhanden",noEntriesHint:"Zeiten im Timer-Tab aufnehmen",search:"Startnr. suchen...",filter:"Filter",all:"Alle",total:"Gesamt",racers:"Fahrer",finished:"Im Ziel",fastest:"Schnellste",average:"Durchschnitt",timeEntry:"Zeit",timeEntries:"Zeiten",faultEntry:"Fehler",faultEntries:"Fehler",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Eintrag löschen",confirmDeleteText:"Möchten Sie diesen Eintrag wirklich löschen?",confirmDeleteFault:"Diesen Fehler löschen?",confirmClearAll:"Alle löschen",clearAllText:"Alle Einträge werden gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.",confirmUndoAdd:"Erfassung rückgängig",confirmUndoAddText:"Der erfasste Eintrag wird gelöscht. Fortfahren?",delete:"Löschen",cancel:"Abbrechen",close:"Schließen",back:"Zurück",save:"Speichern",saving:"Speichern...",edit:"Bearbeiten",undo:"Rückgängig",export:"Exportieren",clearAll:"Alle löschen",selectAll:"Alle auswählen",deleteSelected:"Ausgewählte löschen",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Von Cloud synchronisiert",raceId:"Rennen-ID",invalidRaceId:"Ungültige Rennen-ID. Nur Buchstaben, Zahlen, Bindestriche, Unterstriche.",deviceName:"Zeitnehmer-ID",cloudSync:"Cloud-Sync",syncStatus:"Sync-Status",pendingSync:"ausstehend",raceSetup:"Rennen einrichten",raceSetupDesc:"Erforderlich für Timing und Sync über mehrere Geräte.",firstGateLabel:"Erstes Tor",saved:"Gespeichert",deleted:"Gelöscht",cleared:"Alle Einträge gelöscht",undone:"Rückgängig gemacht",copied:"In Zwischenablage kopiert",debugInfoCopied:"Debug-Info in Zwischenablage kopiert",debugInfoCopyFailed:"Lange drücken um Debug-Info zu kopieren",duplicateWarning:"Doppelter Eintrag erkannt",zeroBibWarning:"Startnr. 000 - Eintrag prüfen",exported:"Erfolgreich exportiert",gps:"GPS",gpsActive:"GPS Aktiv",gpsSearching:"GPS wird gesucht...",gpsInactive:"GPS Inaktiv",gpsAccuracy:"Genauigkeit",settingsRaceSetup:"Rennen einrichten",settingsTimingGroup:"Zeitmessung",settingsSyncGroup:"Synchronisation",settingsFeedbackGroup:"Rückmeldung",settingsDisplayGroup:"Anzeige",simpleMode:"Einfacher Modus",fullMode:"Erweiterter Modus",autoIncrement:"Startnr. automatisch",hapticFeedback:"Vibration",soundFeedback:"Signalton",language:"Sprache",advancedSettingsHint:"Diese Optionen beeinflussen die Zeitmessung. Nur bei Bedarf ändern.",simpleModeDesc:"Vereinfachte Oberfläche für einfache Zeitmessung",cloudSyncDesc:"Mit anderen Geräten synchronisieren",gpsDesc:"GPS für genaue Zeitstempel verwenden",autoIncrementDesc:"Startnr. nach Erfassung erhöhen",photoCaptureDesc:"Foto bei Zeiterfassung aufnehmen",hapticFeedbackDesc:"Vibration bei Aktionen",soundFeedbackDesc:"Akustische Bestätigung",ambientMode:"Ruhemodus",ambientModeDesc:"Nach 30s Inaktivität abdunkeln",photoCapture:"Foto aufnehmen",photoCaptured:"Foto aufgenommen",photoError:"Foto-Aufnahme fehlgeschlagen",photoSaveFailed:"Foto-Speicherung fehlgeschlagen",viewPhoto:"Foto anzeigen",deletePhoto:"Foto löschen",photoFor:"Foto für Startnr.",noPhotoAvailable:"Kein Foto verfügbar",photoDeleted:"Foto gelöscht",raceChangeTitle:"Rennen wechseln",raceChangeSyncedText:"Es gibt Ergebnisse von einem anderen Rennen. Exportieren oder löschen?",raceChangeUnsyncedText:"Es gibt bestehende Ergebnisse. Behalten oder löschen?",keepResults:"Behalten",version:"Version",devices:"Geräte",entries:"Einträge",selected:"ausgewählt",raceFound:"Rennen gefunden",raceNew:"Neues Rennen",entryInCloud:"Eintrag in der Cloud",entriesInCloud:"Einträge in der Cloud",photoTooLarge:"Foto zu groß für Sync",syncedEntriesFromCloud:"{count} Einträge aus Cloud synchronisiert",syncedFaultsFromCloud:"{count} Torfehler aus Cloud synchronisiert",crossDeviceDuplicate:"Duplikat: Startnr. {bib} {point} bereits von {device} erfasst",syncPhotos:"Fotos synchronisieren",syncPhotosDesc:"Fotos über Cloud mit anderen Geräten teilen",syncPhotosWarning:"Foto-Sync aktivieren",syncPhotosWarningText:"Aktivierung der Foto-Synchronisierung überträgt folgende Daten:",photosToUpload:"Fotos hochzuladen",photosToDownload:"Fotos herunterzuladen",totalDataVolume:"Gesamtes Datenvolumen",enableSync:"Sync aktivieren",noPhotosToSync:"Keine Fotos zu synchronisieren",admin:"Admin",adminPin:"Rennverwaltungs-PIN",adminPinDesc:"Erforderlich für Verwaltung und Sync",manageRaces:"Rennen verwalten",manageRacesDesc:"Synchronisierte Rennen anzeigen und löschen",manage:"Verwalten",enterAdminPin:"Rennverwaltungs-PIN eingeben",enterPinText:"Geben Sie Ihre PIN ein, um die Rennverwaltung zu öffnen.",enterPinToJoinRace:"Geben Sie Ihre PIN ein, um diesem Rennen beizutreten.",enterPinForChiefJudge:"Geben Sie Ihre PIN ein, um die Obmann-Ansicht zu öffnen.",enterChiefJudgePin:"Obmann-PIN eingeben",enterPinForChiefJudgeInfo:"Der Obmann-Modus erfordert eine separate PIN. Erste Eingabe setzt die PIN.",syncRequiresPin:"Sync deaktiviert. Aktivieren Sie Sync und geben Sie die PIN ein.",incorrectPin:"Falsche PIN",verify:"Bestätigen",setPinFirst:"Bitte zuerst Rennverwaltungs-PIN festlegen",pinSaved:"PIN gespeichert",pinCleared:"PIN gelöscht",pinNotSet:"Nicht gesetzt",pinSet:"PIN gesetzt",setPin:"PIN setzen",changePin:"PIN ändern",currentPin:"Aktuelle PIN",newPin:"Neue PIN (4 Ziffern)",confirmPin:"PIN bestätigen",pinMismatch:"PINs stimmen nicht überein",pinFormatError:"PIN muss genau 4 Ziffern haben",loading:"Laden...",noRaces:"Keine aktiven Rennen",noRacesHint:"In Einstellungen erstellen",cleanRunHint:"Bisher fehlerfreie Fahrt",refresh:"Aktualisieren",raceDeleted:"Rennen gelöscht",raceDeletedText:"Dieses Rennen wurde von einem Administrator gelöscht.",raceDeletedFor:"Rennen gelöscht:",raceDeletedSuccess:"Rennen gelöscht:",confirmDeleteRace:"Rennen löschen",confirmDeleteRaceText:"Möchten Sie das Rennen wirklich löschen",loadError:"Fehler beim Laden der Rennen. Verbindung prüfen und erneut versuchen.",deleteError:"Fehler beim Löschen des Rennens",entry:"Eintrag",device:"Gerät",storageError:"Speichern fehlgeschlagen - Speicher prüfen",storageQuotaError:"Speicher voll! Daten sofort exportieren",storageWarning:"Speicher fast voll",storageNearlyFull:"Speicher fast voll. Daten exportieren und alte Einträge löschen.",networkError:"Netzwerkfehler - Verbindung prüfen",connectionFailed:"Verbindung fehlgeschlagen",serverUnavailable:"Server nicht erreichbar",rateLimitError:"Zu viele Anfragen - bitte warten",authError:"Authentifizierung fehlgeschlagen. PIN erneut eingeben.",syncFailed:"Synchronisierung fehlgeschlagen",pinSyncFailed:"PIN nicht in Cloud gespeichert",cameraError:"Kamerafehler",cameraPermissionDenied:"Kamerazugriff verweigert",gpsError:"GPS-Fehler",gpsPermissionDenied:"GPS-Zugriff verweigert",gpsUnavailable:"GPS nicht verfügbar",wakeLockFailed:"Bildschirm kann während Zeitmessung abdunkeln",wakeLockIdleTimeout:"Bildschirm wird gedimmt um Akku zu sparen. Tippen zum Wachhalten.",unknownError:"Unbekannter Fehler",onboardingWelcome:"Willkommen bei Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronisierte Zeitmessung für Skirennen",getStarted:"Los geht's",skipSetup:"Überspringen",onboardingRole:"Was ist deine Aufgabe?",onboardingRoleDesc:"Wähle aus, wie du beim Rennen hilfst",roleTimerTitle:"Zeitnehmer",roleTimerDesc:"Du erfasst Start- und Zielzeiten",roleJudgeTitle:"Torrichter",roleJudgeDesc:"Du erfasst Torfehler",onboardingDeviceName:"Timer benennen",onboardingDeviceNameDesc:"Dieser Name identifiziert dein Gerät beim Synchronisieren",onboardingDeviceNameJudge:"Dein Name",onboardingDeviceNameJudgeDesc:"Dies identifiziert dich als Torrichter",onboardingPhoto:"Foto-Dokumentation",onboardingPhotoDesc:"Automatisch ein Foto bei jeder Zeiterfassung aufnehmen. Nützlich zur Überprüfung von Startnr. und bei Unstimmigkeiten.",enablePhotoCapture:"Foto-Aufnahme aktivieren",photoCaptureLabel:"Foto-Aufnahme",onboardingGates:"Deine Tor-Zuweisung",onboardingGatesDesc:"Gib die Tornummern ein, die du beobachtest. Du kannst dies später ändern.",onboardingRaceSetup:"Rennen beitreten",onboardingRaceSetupDesc:"Gib eine Rennen-ID ein um mit anderen Timern zu synchronisieren",skipForNow:"Vorerst überspringen",onboardingReady:"Bereit zur Zeitmessung!",onboardingReadyJudge:"Bereit als Torrichter!",onboardingTip:"Tippe auf den großen blauen Button um Zeiten zu erfassen",onboardingTipJudge:"Tippe auf eine Startnr. um einen Fehler zu erfassen",startTiming:"Zeitmessung starten",startJudging:"Starten",continue:"Weiter",deviceNameLabel:"Gerätename",raceIdLabel:"Rennen-ID",syncStatusLabel:"Cloud-Sync",enabled:"Aktiviert",disabled:"Deaktiviert",showTutorial:"Tutorial anzeigen",showTutorialDesc:"Setup-Assistenten erneut starten",show:"Anzeigen",onboardingComplete:"Einrichtung abgeschlossen!",invalidPin:"PIN muss 4 Ziffern haben",recentRaces:"Letzte Rennen",noRecentRaces:"Keine Rennen von heute",errorOccurred:"Ein Fehler ist aufgetreten",errorRecoveryMessage:"Die App hat einen Fehler festgestellt. Sie können diesen Hinweis schließen und fortfahren, oder die App neu laden.",dismiss:"Schließen",reload:"Neu laden",updateAvailable:"Update verfügbar! Neu laden für die neueste Version.",operationFailed:"Vorgang fehlgeschlagen. Bitte erneut versuchen.",raceIdPlaceholder:"RENNEN-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Foto für Startnr.",gateJudge:"Torrichter",gateJudgeTab:"Tor",deviceRole:"Geräte-Rolle",deviceRoleDesc:"Timer erfasst Zeiten, Torrichter erfasst Fehler",roleTimer:"Zeitnehmer",roleGateJudge:"Torrichter",gateAssignment:"Tor-Zuweisung",noGateAssignment:"Keine Tor-Zuweisung. Bitte zuerst den Torbereich festlegen.",gates:"Tore",gatesFrom:"Von",gatesTo:"Bis",firstGateColor:"Farbe des ersten Tors",colorRed:"Rot",colorBlue:"Blau",changeGates:"Ändern",otherJudges:"Andere Torrichter:",activeBibs:"Auf der Strecke",noBibsOnCourse:"Keine Fahrer auf der Strecke",recordFault:"Fehler erfassen",faultType:"Fehlerart",faultMG:"Tor ausgelassen",faultSTR:"Einfädler",faultBR:"Bindung offen",faultMGShort:"TF",faultSTRShort:"EF",faultBRShort:"BO",orEnterManually:"oder eingeben:",faultRecorded:"Fehler erfasst",signalReady:"Bereit",judgeReady:"Bereit für Rennen!",judgeNotReady:"Bereit-Status zurückgesetzt",faultDeleted:"Fehler gelöscht",recordedFaults:"Erfasste Fehler",selectBib:"Startnr. wählen",selectGate:"Tor",gate:"Tor",noFaults:"Keine Fehler erfasst",faultsFor:"Fehler für",faultSummary:"Fehler-Übersicht",penaltyTime:"Strafzeit",faultCount:"Fehler",markOk:"OK markieren",saveFault:"Fehler speichern",selectFaultType:"Bitte Fehlerart wählen",gateOutOfRange:"Tor liegt außerhalb des zugewiesenen Bereichs",flt:"STR",statusFlt:"Strafzeit",chiefJudge:"Obmann",noFaultsRecorded:"Keine Fehler erfasst",finalize:"Bestätigen",finalized:"Bestätigt",chiefJudgeMode:"Obmann-Ansicht",chiefJudgeModeEnabled:"Obmann-Ansicht aktiviert",chiefJudgeModeDisabled:"Obmann-Ansicht deaktiviert",racersWithFaults:"Fahrer mit Fehlern",penaltyMode:"+Zeit",gateJudges:"Torrichter",noJudgesConnected:"Keine Torrichter verbunden",summary:"Übersicht",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"Keine Fehler zum Exportieren",copiedToClipboard:"In Zwischenablage kopiert",gateJudgeCard:"Torrichterkarte",race:"Rennen",date:"Datum",gateJudgeLabel:"Torrichter",runLabel:"Lauf",noFaultsEntered:"Keine Fehler erfasst",signature:"Unterschrift",legend:"Legende",missedGateLegend:"Ausgelassen",straddlingLegend:"Einfädler",bindingLegend:"Bindung",gateFaults:"Torfehler",penaltyLabel:"STRAFZEIT",faultSummaryTitle:"ZUSAMMENFASSUNG TORFEHLER",faults:"Fehler",penalty:"Strafzeit",sec:"Sek",generated:"Erstellt",editFault:"Fehler bearbeiten",versionHistory:"Versionshistorie",restoreVersion:"Version wiederherstellen",currentVersion:"Aktuell",originalVersion:"Original",restored:"Wiederhergestellt",versionRestored:"Version wiederhergestellt",markForDeletion:"Zum Löschen markieren",markForDeletionText:"Dieser Fehler wird zum Löschen markiert und benötigt die Genehmigung des Obmanns für die endgültige Löschung.",markedForDeletion:"Zum Löschen markiert",deletionPending:"Löschung ausstehend",pendingDeletions:"Ausstehende Löschungen",approveDeletion:"Löschung genehmigen",rejectDeletion:"Löschung ablehnen",deletionMarkedBy:"Markiert von",deletionApproved:"Löschung genehmigt",deletionRejected:"Löschung abgelehnt",cannotEditPendingDeletion:"Fehler mit ausstehender Löschung kann nicht bearbeitet werden",voiceMode:"Sprachsteuerung",voiceModeDesc:"Freihändige Sprachbefehle (Internet erforderlich)",voiceListening:"Höre zu...",voiceProcessing:"Verarbeite...",voiceConfirming:"Bestätigen?",voiceOffline:"Sprache offline nicht verfügbar",voiceNotSupported:"Spracheingabe in diesem Browser nicht unterstützt",voicePermissionDenied:"Mikrofonzugriff verweigert",voiceOK:"OK",voiceRecorded:"Erfasst",voiceNotUnderstood:"Nicht verstanden",voiceCancelled:"Abgebrochen",voiceError:"Sprachfehler",voiceApiKeyRequired:"API-Schlüssel für Sprachsteuerung erforderlich",pullToRefresh:"Zum Aktualisieren ziehen",releaseToRefresh:"Loslassen zum Aktualisieren",synced:"Synchronisiert",syncingStatus:"Synchronisiere...",gateAssignmentInstructions:"Gib den Torbereich ein, für den du verantwortlich bist:",readySuffix:" - Bereit",viewPhotoLabel:"Foto anzeigen",editEntryLabel:"Eintrag bearbeiten",deleteEntryLabel:"Eintrag löschen",editFaultLabel:"Fehler bearbeiten",deleteFaultLabel:"Fehler löschen",deleteLabel:"Löschen",gateNumberLabel:"Tor",numberLabel:"Zahl",currentTime:"Aktuelle Uhrzeit",pinVerifyOnline:"PIN wird online überprüft",addNote:"Notiz hinzufügen",done:"Fertig",recordNote:"Notiz aufnehmen",listening:"Höre zu...",noteSaved:"Notiz gespeichert",noteDeleted:"Notiz gelöscht",noteCharCount:"Zeichen",voiceNoteUnsupported:"Spracheingabe in diesem Browser nicht unterstützt",voiceNoteError:"Spracheingabe-Fehler",typeNote:"Notiz eintippen oder sprechen...",hasNote:"Hat Notiz",noteTextLabel:"Notiztext",recordVoiceNoteLabel:"Sprachnotiz aufnehmen",syncOnline:"Sync online",syncOffline:"Offline",sessionExpired:"Sitzung abgelaufen. Bitte PIN erneut eingeben.",authSuccess:"Authentifizierung erfolgreich",keyboardShortcuts:"Tastenkürzel",keyboardShortcutsDesc:"Alle Tastenkürzel anzeigen",shortcutSection_timer:"Timer",shortcutSection_gateJudge:"Torrichter",shortcutSection_results:"Ergebnisse",shortcutSection_global:"Allgemein",shortcut_enterDigit:"Startnr.-Ziffer eingeben",shortcut_selectStart:"Start wählen",shortcut_selectFinish:"Ziel wählen",shortcut_selectRun1:"Lauf 1 wählen",shortcut_selectRun2:"Lauf 2 wählen",shortcut_recordTime:"Zeitstempel erfassen",shortcut_clearBib:"Startnr. löschen",shortcut_deleteLastDigit:"Letzte Ziffer löschen",shortcut_missedGate:"Tor ausgelassen",shortcut_straddled:"Einfädler",shortcut_broken:"Bindung offen",shortcut_selectGate:"Tor wählen",shortcut_navigateBtns:"Buttons navigieren",shortcut_confirmSelection:"Auswahl bestätigen",shortcut_navigateItems:"Einträge navigieren",shortcut_editItem:"Eintrag bearbeiten",shortcut_deleteItem:"Eintrag löschen",shortcut_moveTab:"Zwischen Tabs wechseln",shortcut_closeModal:"Dialog schließen",shortcut_navigateInComponent:"In Komponente navigieren",shortcut_showShortcuts:"Tastenkürzel anzeigen",offlineBanner:"Offline. Zeiten werden lokal gespeichert.",onlineRestored:"Wieder online",entryDeleted:"Eintrag gelöscht",undoAction:"Rückgängig",multiDeviceDuplicate:"Mehrere Geräte",duplicateDevices:"{count} Geräte",duplicateCount:"{count} Duplikate"}};function f(t,e="de"){const n=Hi[e],i=Hi.en;return n[t]||i[t]||t}const y={debug:()=>{},log:()=>{},info:()=>{},warn:console.warn.bind(console),error:console.error.bind(console)},_r=.2,Hr=.1;class zr{constructor(){g(this,"battery",null);g(this,"isInitialized",!1);g(this,"callbacks",new Set);g(this,"currentStatus",{level:1,charging:!0,batteryLevel:"normal"});g(this,"levelChangeHandler",null);g(this,"chargingChangeHandler",null)}isSupported(){return"getBattery"in navigator}async initialize(){if(this.isInitialized)return!0;if(!this.isSupported())return!1;try{return this.battery=await navigator.getBattery(),this.isInitialized=!0,this.updateStatus(),this.levelChangeHandler=()=>this.updateStatus(),this.chargingChangeHandler=()=>this.updateStatus(),this.battery.addEventListener("levelchange",this.levelChangeHandler),this.battery.addEventListener("chargingchange",this.chargingChangeHandler),!0}catch(e){return y.warn("Failed to initialize battery service:",e),!1}}updateStatus(){if(!this.battery)return;const e=this.battery.level,n=this.battery.charging;let i="normal";n||(e<=Hr?i="critical":e<=_r&&(i="low"));const s={level:e,charging:n,batteryLevel:i},r=this.currentStatus.level!==s.level||this.currentStatus.charging!==s.charging||this.currentStatus.batteryLevel!==s.batteryLevel;this.currentStatus=s,r&&this.notifySubscribers()}notifySubscribers(){for(const e of this.callbacks)try{e(this.currentStatus)}catch(n){y.error("Battery callback error:",n)}}subscribe(e){return this.callbacks.add(e),e(this.currentStatus),()=>{this.callbacks.delete(e)}}getStatus(){return{...this.currentStatus}}isLowBattery(){return this.currentStatus.batteryLevel==="low"||this.currentStatus.batteryLevel==="critical"}isCriticalBattery(){return this.currentStatus.batteryLevel==="critical"}isCharging(){return this.currentStatus.charging}getLevelPercent(){return Math.round(this.currentStatus.level*100)}cleanup(){this.battery&&(this.levelChangeHandler&&(this.battery.removeEventListener("levelchange",this.levelChangeHandler),this.levelChangeHandler=null),this.chargingChangeHandler&&(this.battery.removeEventListener("chargingchange",this.chargingChangeHandler),this.chargingChangeHandler=null),this.battery=null),this.callbacks.clear(),this.isInitialized=!1}}const W=new zr;class Ur{constructor(){g(this,"isInitialized",!1);g(this,"isEnabled",!1);g(this,"isAmbientActive",!1);g(this,"triggeredBy",null);g(this,"lastActivityTimestamp",Date.now());g(this,"inactivityCheckId",null);g(this,"batteryUnsubscribe",null);g(this,"callbacks",new Set);g(this,"activityHandler",null);g(this,"INACTIVITY_THRESHOLD_MS",3e4)}initialize(){this.isInitialized||(this.isInitialized=!0,this.batteryUnsubscribe=W.subscribe(e=>{e.batteryLevel==="critical"&&!e.charging&&this.isEnabled&&this.enterAmbientMode("battery"),e.charging&&this.isAmbientActive&&this.triggeredBy==="battery"&&this.exitAmbientMode()}),this.activityHandler=()=>this.resetInactivityTimer(),document.addEventListener("touchstart",this.activityHandler,{passive:!0}),document.addEventListener("click",this.activityHandler,{passive:!0}),document.addEventListener("keydown",this.activityHandler,{passive:!0}))}cleanup(){this.disable(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.activityHandler&&(document.removeEventListener("touchstart",this.activityHandler),document.removeEventListener("click",this.activityHandler),document.removeEventListener("keydown",this.activityHandler),this.activityHandler=null),this.callbacks.clear(),this.isInitialized=!1}enable(){this.isEnabled||(this.isEnabled=!0,this.lastActivityTimestamp=Date.now(),this.startInactivityMonitor(),W.isCriticalBattery()&&this.enterAmbientMode("battery"))}disable(){this.isEnabled&&(this.isEnabled=!1,this.stopInactivityMonitor(),this.isAmbientActive&&this.exitAmbientMode())}isActive(){return this.isAmbientActive}getState(){return{isActive:this.isAmbientActive,triggeredBy:this.triggeredBy}}subscribe(e){return this.callbacks.add(e),e(this.getState()),()=>{this.callbacks.delete(e)}}exitAmbientMode(){this.isAmbientActive&&(this.isAmbientActive=!1,this.triggeredBy=null,this.lastActivityTimestamp=Date.now(),this.notifySubscribers(),y.debug("[Ambient] Exited ambient mode"))}resetInactivityTimer(){this.lastActivityTimestamp=Date.now(),this.isAmbientActive}enterAmbientMode(e){this.isAmbientActive||!this.isEnabled||(this.isAmbientActive=!0,this.triggeredBy=e,this.notifySubscribers(),y.debug(`[Ambient] Entered ambient mode (trigger: ${e})`))}startInactivityMonitor(){this.inactivityCheckId===null&&(this.inactivityCheckId=setInterval(()=>{if(!this.isEnabled)return;Date.now()-this.lastActivityTimestamp>=this.INACTIVITY_THRESHOLD_MS&&!this.isAmbientActive&&this.enterAmbientMode("inactivity")},5e3))}stopInactivityMonitor(){this.inactivityCheckId!==null&&(clearInterval(this.inactivityCheckId),this.inactivityCheckId=null)}notifySubscribers(){const e=this.getState();for(const n of this.callbacks)try{n(e)}catch(i){y.error("[Ambient] Callback error:",i)}}}const Z=new Ur;var Gr=Symbol.for("preact-signals");function hi(){if(We>1)We--;else{for(var t,e=!1;dt!==void 0;){var n=dt;for(dt=void 0,ei++;n!==void 0;){var i=n.o;if(n.o=void 0,n.f&=-3,!(8&n.f)&&Ts(n))try{n.c()}catch(s){e||(t=s,e=!0)}n=i}}if(ei=0,We--,e)throw t}}var B=void 0;function ks(t){var e=B;B=void 0;try{return t()}finally{B=e}}var dt=void 0,We=0,ei=0,tn=0;function Cs(t){if(B!==void 0){var e=t.n;if(e===void 0||e.t!==B)return e={i:0,S:t,p:B.s,n:void 0,t:B,e:void 0,x:void 0,r:e},B.s!==void 0&&(B.s.n=e),B.s=e,t.n=e,32&B.f&&t.S(e),e;if(e.i===-1)return e.i=0,e.n!==void 0&&(e.n.p=e.p,e.p!==void 0&&(e.p.n=e.n),e.p=B.s,e.n=void 0,B.s.n=e,B.s=e),e}}function Y(t,e){this.v=t,this.i=0,this.n=void 0,this.t=void 0,this.W=e==null?void 0:e.watched,this.Z=e==null?void 0:e.unwatched,this.name=e==null?void 0:e.name}Y.prototype.brand=Gr;Y.prototype.h=function(){return!0};Y.prototype.S=function(t){var e=this,n=this.t;n!==t&&t.e===void 0&&(t.x=n,this.t=t,n!==void 0?n.e=t:ks(function(){var i;(i=e.W)==null||i.call(e)}))};Y.prototype.U=function(t){var e=this;if(this.t!==void 0){var n=t.e,i=t.x;n!==void 0&&(n.x=i,t.e=void 0),i!==void 0&&(i.e=n,t.x=void 0),t===this.t&&(this.t=i,i===void 0&&ks(function(){var s;(s=e.Z)==null||s.call(e)}))}};Y.prototype.subscribe=function(t){var e=this;return jr(function(){var n=e.value,i=B;B=void 0;try{t(n)}finally{B=i}},{name:"sub"})};Y.prototype.valueOf=function(){return this.value};Y.prototype.toString=function(){return this.value+""};Y.prototype.toJSON=function(){return this.value};Y.prototype.peek=function(){var t=B;B=void 0;try{return this.value}finally{B=t}};Object.defineProperty(Y.prototype,"value",{get:function(){var t=Cs(this);return t!==void 0&&(t.i=this.i),this.v},set:function(t){if(t!==this.v){if(ei>100)throw new Error("Cycle detected");this.v=t,this.i++,tn++,We++;try{for(var e=this.t;e!==void 0;e=e.x)e.t.N()}finally{hi()}}}});function qr(t,e){return new Y(t,e)}function Ts(t){for(var e=t.s;e!==void 0;e=e.n)if(e.S.i!==e.i||!e.S.h()||e.S.i!==e.i)return!0;return!1}function Ls(t){for(var e=t.s;e!==void 0;e=e.n){var n=e.S.n;if(n!==void 0&&(e.r=n),e.S.n=e,e.i=-1,e.n===void 0){t.s=e;break}}}function As(t){for(var e=t.s,n=void 0;e!==void 0;){var i=e.p;e.i===-1?(e.S.U(e),i!==void 0&&(i.n=e.n),e.n!==void 0&&(e.n.p=i)):n=e,e.S.n=e.r,e.r!==void 0&&(e.r=void 0),e=i}t.s=n}function it(t,e){Y.call(this,void 0),this.x=t,this.s=void 0,this.g=tn-1,this.f=4,this.W=e==null?void 0:e.watched,this.Z=e==null?void 0:e.unwatched,this.name=e==null?void 0:e.name}it.prototype=new Y;it.prototype.h=function(){if(this.f&=-3,1&this.f)return!1;if((36&this.f)==32||(this.f&=-5,this.g===tn))return!0;if(this.g=tn,this.f|=1,this.i>0&&!Ts(this))return this.f&=-2,!0;var t=B;try{Ls(this),B=this;var e=this.x();(16&this.f||this.v!==e||this.i===0)&&(this.v=e,this.f&=-17,this.i++)}catch(n){this.v=n,this.f|=16,this.i++}return B=t,As(this),this.f&=-2,!0};it.prototype.S=function(t){if(this.t===void 0){this.f|=36;for(var e=this.s;e!==void 0;e=e.n)e.S.S(e)}Y.prototype.S.call(this,t)};it.prototype.U=function(t){if(this.t!==void 0&&(Y.prototype.U.call(this,t),this.t===void 0)){this.f&=-33;for(var e=this.s;e!==void 0;e=e.n)e.S.U(e)}};it.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var t=this.t;t!==void 0;t=t.x)t.t.N()}};Object.defineProperty(it.prototype,"value",{get:function(){if(1&this.f)throw new Error("Cycle detected");var t=Cs(this);if(this.h(),t!==void 0&&(t.i=this.i),16&this.f)throw this.v;return this.v}});function Rs(t){var e=t.u;if(t.u=void 0,typeof e=="function"){We++;var n=B;B=void 0;try{e()}catch(i){throw t.f&=-2,t.f|=8,gi(t),i}finally{B=n,hi()}}}function gi(t){for(var e=t.s;e!==void 0;e=e.n)e.S.U(e);t.x=void 0,t.s=void 0,Rs(t)}function Jr(t){if(B!==this)throw new Error("Out-of-order effect");As(this),B=t,this.f&=-2,8&this.f&&gi(this),hi()}function st(t,e){this.x=t,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32,this.name=e==null?void 0:e.name}st.prototype.c=function(){var t=this.S();try{if(8&this.f||this.x===void 0)return;var e=this.x();typeof e=="function"&&(this.u=e)}finally{t()}};st.prototype.S=function(){if(1&this.f)throw new Error("Cycle detected");this.f|=1,this.f&=-9,Rs(this),Ls(this),We++;var t=B;return B=this,Jr.bind(this,t)};st.prototype.N=function(){2&this.f||(this.f|=2,this.o=dt,dt=this)};st.prototype.d=function(){this.f|=8,1&this.f||gi(this)};st.prototype.dispose=function(){this.d()};function jr(t,e){var n=new st(t,e);try{n.c()}catch(s){throw n.d(),s}var i=n.d.bind(n);return i[Symbol.dispose]=i,i}const nn=2;function Wr(t){const e=new Uint8Array(Math.ceil(t/2));return crypto.getRandomValues(e),Array.from(e,n=>n.toString(16).padStart(2,"0")).join("").slice(0,t)}function Qr(t){var i;const e=Date.now(),n=((i=crypto.randomUUID)==null?void 0:i.call(crypto).slice(0,8))??Wr(8);return`${t}-${e}-${n}`}const sn=["swift","bold","cool","fast","keen","wild","calm","warm","bright","sharp","quick","brave","fresh","grand","prime","clear","snow","ice","frost","peak","alpine","polar","winter","crisp"],rn=["fox","bear","wolf","hawk","eagle","tiger","lion","deer","pine","oak","cedar","birch","maple","spruce","aspen","willow","peak","ridge","slope","trail","summit","valley","glacier","cliff"];function zi(t){return t.charAt(0).toUpperCase()+t.slice(1)}function Yr(){const t=sn[Math.floor(Math.random()*sn.length)],e=rn[Math.floor(Math.random()*rn.length)],n=Math.floor(Math.random()*100);return`dev_${t}-${e}-${n}`}function an(){const t=sn[Math.floor(Math.random()*sn.length)],e=rn[Math.floor(Math.random()*rn.length)],n=Math.floor(Math.random()*100);return`${zi(t)} ${zi(e)} ${n}`}const Ui=5*1024*1024,Kr=80;function Zr(){let t=0;try{for(let e=0;e<localStorage.length;e++){const n=localStorage.key(e);if(n){const i=localStorage.getItem(n);t+=(n.length+((i==null?void 0:i.length)??0))*2}}}catch{}return t}function Ds(){const t=Zr(),e=Math.round(t/Ui*100),n=e>=Kr;return{usageBytes:t,estimatedQuota:Ui,usagePercent:e,warning:n}}function Xr(){const{usageBytes:t,usagePercent:e}=Ds(),n=(t/1024).toFixed(1);y.debug(`[Storage] localStorage usage: ${n} KB (${e}% of ~5MB)`)}const ea=["S","F"],ta=["ok","dns","dnf","dsq","flt"],xs=["MG","STR","BR"],na=50,ia=10;function Bs(t){return!t||typeof t!="string"||t.length>na?!1:/^[a-zA-Z0-9_-]+$/.test(t)}function rt(t){if(!t||typeof t!="object")return!1;const e=t;if(typeof e.id!="string"&&typeof e.id!="number"||typeof e.id=="string"&&e.id.length===0||typeof e.id=="number"&&e.id<=0||e.bib!==void 0&&typeof e.bib!="string"||typeof e.bib=="string"&&e.bib.length>ia||!ea.includes(e.point)||!e.timestamp||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||e.status!==void 0&&!ta.includes(e.status)||e.deviceId!==void 0&&typeof e.deviceId!="string"||e.deviceName!==void 0&&typeof e.deviceName!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||e.syncedAt<0||!Number.isFinite(e.syncedAt))||e.photo!==void 0&&typeof e.photo!="string"||e.timeSource!==void 0&&e.timeSource!=="gps"&&e.timeSource!=="system"||e.gpsTimestamp!==void 0&&(typeof e.gpsTimestamp!="number"||!Number.isFinite(e.gpsTimestamp)))return!1;if(e.gpsCoords!==void 0){if(typeof e.gpsCoords!="object"||e.gpsCoords===null)return!1;const n=e.gpsCoords;if(typeof n.latitude!="number"||!Number.isFinite(n.latitude)||typeof n.longitude!="number"||!Number.isFinite(n.longitude)||typeof n.accuracy!="number"||!Number.isFinite(n.accuracy)||n.accuracy<0)return!1}return!0}function sa(t){return!t||typeof t!="string"?!1:t.startsWith("dev_")&&t.length>4}function Ps(t){return typeof t=="number"&&Number.isInteger(t)&&t>=1}const ra=["create","edit","restore"];function aa(t){if(!t||typeof t!="object")return!1;const e=t;if(typeof e.version!="number"||!Number.isInteger(e.version)||e.version<1||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||typeof e.editedBy!="string"||e.editedBy.length>100||typeof e.editedByDeviceId!="string"||e.editedByDeviceId.length>100||!ra.includes(e.changeType)||!e.data||typeof e.data!="object")return!1;const n=e.data;return!(typeof n.id!="string"||typeof n.bib!="string"||n.bib.length>10||!Ps(n.run)||typeof n.gateNumber!="number"||!Number.isInteger(n.gateNumber)||n.gateNumber<0||!xs.includes(n.faultType)||typeof n.timestamp!="string"||Number.isNaN(Date.parse(n.timestamp))||typeof n.deviceId!="string"||typeof n.deviceName!="string"||n.deviceName.length>100||!Array.isArray(n.gateRange)||n.gateRange.length!==2||typeof n.gateRange[0]!="number"||typeof n.gateRange[1]!="number"||!Number.isInteger(n.gateRange[0])||!Number.isInteger(n.gateRange[1])||e.changeDescription!==void 0&&typeof e.changeDescription!="string"||typeof e.changeDescription=="string"&&e.changeDescription.length>500)}function oa(t){if(!t||typeof t!="object")return!1;const e=t;if(typeof e.id!="string"||e.id.length===0||typeof e.bib!="string"||e.bib.length>10||typeof e.deviceId!="string"||typeof e.deviceName!="string"||e.deviceName.length>100||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||!Ps(e.run)||typeof e.gateNumber!="number"||!Number.isInteger(e.gateNumber)||e.gateNumber<0||!xs.includes(e.faultType)||!Array.isArray(e.gateRange)||e.gateRange.length!==2||typeof e.gateRange[0]!="number"||typeof e.gateRange[1]!="number"||!Number.isInteger(e.gateRange[0])||!Number.isInteger(e.gateRange[1])||typeof e.currentVersion!="number"||!Number.isInteger(e.currentVersion)||e.currentVersion<1||!Array.isArray(e.versionHistory))return!1;for(const n of e.versionHistory)if(!aa(n))return!1;return!(typeof e.markedForDeletion!="boolean"||e.markedForDeletionAt!==void 0&&(typeof e.markedForDeletionAt!="string"||Number.isNaN(Date.parse(e.markedForDeletionAt)))||e.deletionApprovedAt!==void 0&&(typeof e.deletionApprovedAt!="string"||Number.isNaN(Date.parse(e.deletionApprovedAt)))||e.markedForDeletionBy!==void 0&&typeof e.markedForDeletionBy!="string"||e.markedForDeletionByDeviceId!==void 0&&typeof e.markedForDeletionByDeviceId!="string"||e.deletionApprovedBy!==void 0&&typeof e.deletionApprovedBy!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||!Number.isFinite(e.syncedAt)))}function ca(t){if(!oa(t))return null;const e=t,n=e.versionHistory.map(i=>({...i,editedBy:J(i.editedBy,100),editedByDeviceId:J(i.editedByDeviceId,100),changeDescription:i.changeDescription?J(i.changeDescription,500):void 0,data:{...i.data,bib:J(i.data.bib,10),deviceId:J(i.data.deviceId,100),deviceName:J(i.data.deviceName,100)}}));return{...e,bib:J(e.bib,10),deviceId:J(e.deviceId,100),deviceName:J(e.deviceName,100),markedForDeletionBy:e.markedForDeletionBy?J(e.markedForDeletionBy,100):void 0,markedForDeletionByDeviceId:e.markedForDeletionByDeviceId?J(e.markedForDeletionByDeviceId,100):void 0,deletionApprovedBy:e.deletionApprovedBy?J(e.deletionApprovedBy,100):void 0,versionHistory:n}}function la(t){if(!t||typeof t!="object")return!1;const e=t;return!(!rt(e.entry)||typeof e.retryCount!="number"||e.retryCount<0||typeof e.lastAttempt!="number"||e.lastAttempt<0)}function J(t,e=100){return!t||typeof t!="string"?"":t.slice(0,e).replace(/[<>"'&]/g,"").replace(/[\x00-\x1F\x7F]/g,"")}function da(t,e){if(!rt(t))return null;const n=t;return{id:(typeof n.id=="number",String(n.id)),bib:J(n.bib,10),point:n.point,run:n.run??1,timestamp:n.timestamp,status:n.status||"ok",deviceId:J(n.deviceId||e,50),deviceName:J(n.deviceName||"Unknown Device",100),syncedAt:n.syncedAt,photo:n.photo,gpsCoords:n.gpsCoords}}function ua(t,e){const n={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};if(!t||typeof t!="object")return{version:nn,entries:[],settings:n,deviceId:e,deviceName:an(),raceId:"",syncQueue:[]};const i=t;let s=[];Array.isArray(i.entries)&&(s=i.entries.map(o=>da(o,e)).filter(o=>o!==null));let r=n;if(i.settings&&typeof i.settings=="object"){const o=i.settings;r={auto:typeof o.auto=="boolean"?o.auto:n.auto,haptic:typeof o.haptic=="boolean"?o.haptic:n.haptic,sound:typeof o.sound=="boolean"?o.sound:n.sound,sync:typeof o.sync=="boolean"?o.sync:n.sync,syncPhotos:typeof o.syncPhotos=="boolean"?o.syncPhotos:n.syncPhotos,gps:typeof o.gps=="boolean"?o.gps:n.gps,simple:typeof o.simple=="boolean"?o.simple:n.simple,photoCapture:typeof o.photoCapture=="boolean"?o.photoCapture:n.photoCapture,motionEffects:typeof o.motionEffects=="boolean"?o.motionEffects:n.motionEffects,glassEffects:typeof o.glassEffects=="boolean"?o.glassEffects:n.glassEffects,outdoorMode:typeof o.outdoorMode=="boolean"?o.outdoorMode:n.outdoorMode,ambientMode:typeof o.ambientMode=="boolean"?o.ambientMode:n.ambientMode}}let a=[];return Array.isArray(i.syncQueue)&&(a=i.syncQueue.filter(la)),{version:nn,entries:s,settings:r,deviceId:sa(i.deviceId)?i.deviceId:e,deviceName:J(i.deviceName,100)||an(),raceId:Bs(i.raceId)?i.raceId:"",syncQueue:a,lastExport:typeof i.lastExport=="number"?i.lastExport:void 0}}function Sn(t,e){t.addEventListener("input",()=>{t.value=t.value.replace(/[^0-9]/g,""),e!==void 0&&(t.value=t.value.slice(0,e))})}const fa=50;function ha(t,e,n,i){const s=[...t,e],r=Ct(n,{type:"ADD_ENTRY",data:e,timestamp:Date.now()});return{entries:s,undoStack:r,redoStack:[]}}function ga(t,e,n,i){const s=t.find(a=>a.id===e);if(!s)return null;const r=Ct(n,{type:"DELETE_ENTRY",data:s,timestamp:Date.now()});return{entries:t.filter(a=>a.id!==e),undoStack:r,redoStack:[]}}function ma(t,e,n,i){const s=t.filter(a=>e.includes(a.id));if(s.length===0)return null;const r=Ct(n,{type:"DELETE_MULTIPLE",data:s,timestamp:Date.now()});return{entries:t.filter(a=>!e.includes(a.id)),undoStack:r,redoStack:[]}}function pa(t,e,n){if(t.length===0)return null;const i=Ct(e,{type:"CLEAR_ALL",data:[...t],timestamp:Date.now()});return{entries:[],undoStack:i,redoStack:[]}}function ya(t,e,n,i,s){const r=t.findIndex(d=>d.id===e);if(r===-1)return null;const a=t[r],o={...a,...n},c=Ct(i,{type:"UPDATE_ENTRY",data:a,newData:o,timestamp:Date.now()}),u=[...t];return u[r]=o,{entries:u,undoStack:c,redoStack:[]}}function Ct(t,e){const n=[...t,e];return n.length>fa&&n.shift(),n}function va(t,e,n){if(e.length===0)return{entries:t,undoStack:e,redoStack:n,result:null};const i=[...e],s=i.pop(),r=[...n,s];let a=[...t],o=null;switch(s.type){case"ADD_ENTRY":{const c=s.data;a=a.filter(u=>u.id!==c.id),o=c;break}case"DELETE_ENTRY":{const c=s.data;a.push(c),a.sort((u,d)=>new Date(u.timestamp).getTime()-new Date(d.timestamp).getTime()),o=c;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const c=s.data;a=[...a,...c],a.sort((u,d)=>new Date(u.timestamp).getTime()-new Date(d.timestamp).getTime()),o=c;break}case"UPDATE_ENTRY":{const c=s.data,u=a.findIndex(d=>d.id===c.id);u!==-1&&(a[u]=c),o=c;break}}return{entries:a,undoStack:i,redoStack:r,result:o?{type:s.type,data:o}:null}}function ba(t,e,n){if(n.length===0)return{entries:t,undoStack:e,redoStack:n,result:null};const i=[...n],s=i.pop(),r=[...e,s];let a=[...t],o=null;switch(s.type){case"ADD_ENTRY":{const c=s.data;a.push(c),a.sort((u,d)=>new Date(u.timestamp).getTime()-new Date(d.timestamp).getTime()),o=c;break}case"DELETE_ENTRY":{const c=s.data;a=a.filter(u=>u.id!==c.id),o=c;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const c=s.data,u=new Set(c.map(d=>d.id));a=a.filter(d=>!u.has(d.id)),o=c;break}case"UPDATE_ENTRY":{const c=s.data,u=s.newData,d=a.findIndex(h=>h.id===c.id);d!==-1&&u&&(a[d]=u),o=u||c;break}}return{entries:a,undoStack:r,redoStack:i,result:o}}function Sa(t,e){const n={entry:e,retryCount:0,lastAttempt:0};return[...t,n]}function Ea(t,e){return t.filter(n=>n.entry.id!==e)}function wa(t,e,n){return t.map(i=>i.entry.id===e?{...i,...n}:i)}function Ia(t,e,n,i){let s=0;const r=new Set(t.map(c=>`${c.id}-${c.deviceId}`)),a=new Set(n),o=[];for(const c of e){if(!rt(c)||c.deviceId===i)continue;const u=`${c.id}:${c.deviceId}`;if(a.has(u)||a.has(c.id))continue;const d=`${c.id}-${c.deviceId}`;r.has(d)||(o.push({...c,run:c.run??1}),r.add(d),s++)}if(o.length>0){const c=[...t,...o];return c.sort((u,d)=>new Date(u.timestamp).getTime()-new Date(d.timestamp).getTime()),{entries:c,addedCount:s}}return{entries:t,addedCount:s}}function ka(t,e){const n=new Set(e);let i=0;return{entries:t.filter(r=>{const a=`${r.id}:${r.deviceId}`;return n.has(a)||n.has(r.id)?(i++,!1):!0}),removedCount:i}}const Gi=50;function mi(t){return{id:t.id,bib:t.bib,run:t.run,gateNumber:t.gateNumber,faultType:t.faultType,timestamp:t.timestamp,deviceId:t.deviceId,deviceName:t.deviceName,gateRange:t.gateRange,syncedAt:t.syncedAt,notes:t.notes,notesSource:t.notesSource,notesTimestamp:t.notesTimestamp}}function En(t,e,n,i,s,r){return{version:t,timestamp:new Date().toISOString(),editedBy:i,editedByDeviceId:s,changeType:e,data:n,changeDescription:r}}function pi(t,e){const n=[...t||[],e];return n.length>Gi?n.slice(-Gi):n}function Ca(t,e){const n=En(1,"create",mi(e),e.deviceName,e.deviceId),i={...e,currentVersion:1,versionHistory:[n],markedForDeletion:!1};return[...t,i]}function Ta(t,e){return t.filter(n=>n.id!==e)}function La(t,e,n){const i=t.findIndex(r=>r.id===e);if(i===-1)return null;const s=[...t];return s[i]={...s[i],...n},s}function Aa(t,e,n,i,s,r){const a=t.findIndex(m=>m.id===e);if(a===-1)return null;const o=t[a];if(o.markedForDeletion)return null;const c=o.currentVersion+1,u={...o,...n},d=En(c,"edit",mi(u),i,s,r),h=[...t];return h[a]={...u,currentVersion:c,versionHistory:pi(o.versionHistory,d)},h}function Ra(t,e,n,i,s){var h;const r=t.findIndex(m=>m.id===e);if(r===-1)return null;const a=t[r];if(a.markedForDeletion)return null;const o=(h=a.versionHistory)==null?void 0:h.find(m=>m.version===n);if(!o)return null;const c=a.currentVersion+1,u=En(c,"restore",{...o.data},i,s,`Restored to version ${n}`),d=[...t];return d[r]={...a,bib:o.data.bib,run:o.data.run,gateNumber:o.data.gateNumber,faultType:o.data.faultType,notes:o.data.notes,notesSource:o.data.notesSource,notesTimestamp:o.data.notesTimestamp,currentVersion:c,versionHistory:pi(a.versionHistory,u)},d}function Da(t,e,n,i){const s=t.findIndex(a=>a.id===e);if(s===-1)return null;const r=[...t];return r[s]={...r[s],markedForDeletion:!0,markedForDeletionAt:new Date().toISOString(),markedForDeletionBy:n,markedForDeletionByDeviceId:i},r}function xa(t,e,n){const i=t.find(r=>r.id===e);if(!i||!i.markedForDeletion)return{faultEntries:t,approvedFault:null};const s={...i,deletionApprovedAt:new Date().toISOString(),deletionApprovedBy:n};return{faultEntries:t.filter(r=>r.id!==e),approvedFault:s}}function Ba(t,e,n,i){const s=t.findIndex(u=>u.id===e);if(s===-1)return null;const r=t[s],a=r.currentVersion+1,o=En(a,"edit",mi(r),n,i,"Deletion rejected by Chief Judge"),c=[...t];return c[s]={...c[s],markedForDeletion:!1,markedForDeletionAt:void 0,markedForDeletionBy:void 0,markedForDeletionByDeviceId:void 0,currentVersion:a,versionHistory:pi(r.versionHistory,o)},c}function Pa(t){return t.filter(e=>e.markedForDeletion)}function Na(t,e,n){return t.filter(i=>i.bib===e&&i.run===n)}function Fa(t,e){const n=t.findIndex(s=>s.id===e);if(n===-1)return t;const i=[...t];return i[n]={...i[n],syncedAt:Date.now()},i}function $a(t,e,n,i){let s=0,r=0;const a=new Map(t.map(d=>[`${d.id}-${d.deviceId}`,d])),o=new Set(n),c=[],u=[];for(const d of e){const h=ca(d);if(!h){y.warn("Skipping invalid fault from cloud:",d);continue}if(h.deviceId===i)continue;const m=`${h.id}:${h.deviceId}`;if(o.has(m)||o.has(h.id))continue;const p=`${h.id}-${h.deviceId}`,v=a.get(p);if(v){const S=h.currentVersion||1,E=v.currentVersion||1;(S>E||h.markedForDeletion!==v.markedForDeletion)&&(u.push(h),r++)}else c.push(h),s++}if(c.length>0||u.length>0){let d=[...t];for(const h of u){const m=`${h.id}-${h.deviceId}`,p=d.findIndex(v=>`${v.id}-${v.deviceId}`===m);p!==-1&&(d[p]=h)}return d=[...d,...c],d.sort((h,m)=>new Date(h.timestamp).getTime()-new Date(m.timestamp).getTime()),{faultEntries:d,addedCount:s+r}}return{faultEntries:t,addedCount:0}}function Ma(t,e){const n=new Set(e);let i=0;return{faultEntries:t.filter(r=>{const a=`${r.id}:${r.deviceId}`;return n.has(a)||n.has(r.id)?(i++,!1):!0}),removedCount:i}}function Oa(t){return{deviceRole:t}}function Va(t){return{gateAssignment:t}}function _a(t){return{firstGateColor:t}}function Ha(t,e,n){if(!e)return n;const[i]=e;return(t-i)%2===0?n:n==="red"?"blue":"red"}function za(t){return{selectedFaultBib:t}}function Ua(t){return{isJudgeReady:t}}function Ga(t){return{isJudgeReady:!t}}function qa(t){return{isChiefJudgeView:t}}function Ja(t){return{isChiefJudgeView:!t}}function ja(t,e,n){const i=`${t}-${e}`,s=new Set(n);return s.add(i),{finalizedRacers:s}}function Wa(t,e,n){const i=`${t}-${e}`,s=new Set(n);return s.delete(i),{finalizedRacers:s}}function Qa(t,e,n){const i=`${t}-${e}`;return n.has(i)}function Ya(){return{finalizedRacers:new Set}}function Ka(t){return{penaltySeconds:Math.max(0,Math.min(60,t))}}function Za(t){return{usePenaltyMode:t}}function Xa(t,e){const n=t.filter(a=>a.point==="S"&&a.run===e),i=t.filter(a=>a.point==="F"&&a.run===e),s=new Set(i.map(a=>a.bib)),r=new Set(n.filter(a=>!s.has(a.bib)).map(a=>a.bib));return Array.from(r).sort((a,o)=>parseInt(a,10)-parseInt(o,10))}const qi={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};function eo(t,e){return{...t,...e}}function to(t,e){return{...t,[e]:!t[e]}}function no(t){return{syncStatus:t}}function io(t,e){return{raceId:t,clearUndoRedo:t!==e}}function so(t){return{lastSyncedRaceId:t}}function ro(t){return{deviceName:t}}const ao=12e4;function oo(t,e){const n=Date.now(),i=new Map;for(const[s,r]of e)n-r.lastSeen<ao&&i.set(s,r);return i.set(t.id,t),{connectedDevices:i}}function co(t,e){const n=new Map(e);return n.delete(t),{connectedDevices:n}}function lo(t){return{cloudDeviceCount:t}}function uo(t){return{cloudHighestBib:t}}function fo(t){return{raceExistsInCloud:t}}function ho(t){return{currentView:t}}function go(t){return{currentLang:t}}function mo(t){return{bibInput:t.replace(/\D/g,"").slice(0,3)}}function po(t){return{selectedPoint:t}}function yo(t){return{selectedRun:t}}function vo(t,e){return{selectMode:t,selectedEntries:t?e:new Set}}function bo(t,e){const n=new Set(e);return n.has(t)?n.delete(t):n.add(t),{selectedEntries:n,selectMode:n.size>0}}function So(t){return{selectedEntries:new Set(t),selectMode:!0}}function Eo(){return{selectedEntries:new Set,selectMode:!1}}function wo(t){return{isRecording:t}}const F={ENTRIES:"skiTimerEntries",SETTINGS:"skiTimerSettings",LANG:"skiTimerLang",DEVICE_ID:"skiTimerDeviceId",DEVICE_NAME:"skiTimerDeviceName",RACE_ID:"skiTimerRaceId",LAST_SYNCED_RACE_ID:"skiTimerLastSyncedRaceId",SYNC_QUEUE:"skiTimerSyncQueue",SCHEMA_VERSION:"skiTimerSchemaVersion",DEVICE_ROLE:"skiTimerDeviceRole",GATE_ASSIGNMENT:"skiTimerGateAssignment",FIRST_GATE_COLOR:"skiTimerFirstGateColor",FAULT_ENTRIES:"skiTimerFaultEntries"},Bn=100,Io=["entries","settings","currentLang","deviceName","raceId","lastSyncedRaceId","syncQueue","deviceRole","gateAssignment","firstGateColor","faultEntries"];class ko{constructor(){g(this,"state");g(this,"$state");g(this,"listeners",new Set);g(this,"saveTimeout",null);g(this,"dirtySlices",new Set);g(this,"isNotifying",!1);g(this,"pendingNotifications",[]);g(this,"listenerErrorCallback",null);g(this,"failedListenerCount",0);this.state=this.loadInitialState(),this.$state=qr(this.state)}loadInitialState(){let e=localStorage.getItem(F.DEVICE_ID);e||(e=Yr(),localStorage.setItem(F.DEVICE_ID,e));const n=localStorage.getItem(F.ENTRIES),i=localStorage.getItem(F.SETTINGS),s=localStorage.getItem(F.SYNC_QUEUE);let r=[],a=qi,o=[];try{if(n){const E=JSON.parse(n);Array.isArray(E)&&(r=E.filter(k=>rt(k)).map(k=>({...k,run:k.run??1})))}}catch(E){y.error("Failed to parse entries:",E)}try{if(i){const E=JSON.parse(i);a={...qi,...E}}}catch(E){y.error("Failed to parse settings:",E)}try{if(s){const E=JSON.parse(s);Array.isArray(E)&&(o=E)}}catch(E){y.error("Failed to parse sync queue:",E)}const c=localStorage.getItem(F.LANG)||"de";let u=localStorage.getItem(F.DEVICE_NAME);u||(u=an(),localStorage.setItem(F.DEVICE_NAME,u));const d=localStorage.getItem(F.RACE_ID)||"",h=localStorage.getItem(F.LAST_SYNCED_RACE_ID)||"",m=localStorage.getItem(F.DEVICE_ROLE)||"timer";let p=null,v="red",S=[];try{const E=localStorage.getItem(F.GATE_ASSIGNMENT);if(E){const C=JSON.parse(E);Array.isArray(C)&&C.length===2&&(p=C)}const k=localStorage.getItem(F.FIRST_GATE_COLOR);(k==="red"||k==="blue")&&(v=k)}catch(E){y.error("Failed to parse gate assignment:",E)}try{const E=localStorage.getItem(F.FAULT_ENTRIES);if(E){const k=JSON.parse(E);Array.isArray(k)&&(S=k)}}catch(E){y.error("Failed to parse fault entries:",E)}return{currentView:m==="gateJudge"?"gateJudge":"timer",currentLang:c,bibInput:"",selectedPoint:"F",selectedRun:1,selectMode:!1,selectedEntries:new Set,isRecording:!1,lastRecordedEntry:null,entries:r,deviceRole:m,gateAssignment:p,firstGateColor:v,faultEntries:S,selectedFaultBib:"",isJudgeReady:!1,isChiefJudgeView:!1,finalizedRacers:new Set,penaltySeconds:5,usePenaltyMode:!0,undoStack:[],redoStack:[],settings:a,deviceId:e,deviceName:u,raceId:d,lastSyncedRaceId:h,syncStatus:"disconnected",syncQueue:o,connectedDevices:new Map,cloudDeviceCount:0,cloudHighestBib:0,raceExistsInCloud:null,gpsEnabled:a.gps,gpsAccuracy:null,gpsStatus:"inactive",cameraReady:!1,cameraError:null}}getState(){return this.$state.value}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e){const n=this.state;if(this.pendingNotifications.length>=Bn&&(y.warn(`Notification queue exceeded ${Bn} - draining oldest`),this.pendingNotifications.splice(0,Math.floor(Bn/2))),this.pendingNotifications.push({keys:e,stateSnapshot:n}),!this.isNotifying){this.isNotifying=!0;try{for(;this.pendingNotifications.length>0;){const{keys:i,stateSnapshot:s}=this.pendingNotifications.shift(),r=Array.from(this.listeners);for(const a of r)try{a(s,i)}catch(o){if(y.error("State listener error:",o),this.failedListenerCount++,this.listenerErrorCallback)try{this.listenerErrorCallback(o,a)}catch{}}}}finally{this.isNotifying=!1}}}onListenerError(e){this.listenerErrorCallback=e}getListenerFailureCount(){return this.failedListenerCount}setState(e,n=!0){const i=Object.keys(e);if(this.state={...this.state,...e},this.$state.value=this.state,this.notify(i),n){for(const s of i)this.dirtySlices.add(s);this.scheduleSave()}}scheduleSave(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveToStorage(),100)}forceSave(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null);for(const e of Io)this.dirtySlices.add(e);this.saveToStorage()}saveToStorage(){const e=this.dirtySlices;if(this.dirtySlices=new Set,e.size!==0)try{if(this.checkStorageQuota(),e.has("entries")){const i=this.state.entries.map(s=>s.photo&&s.photo!=="indexeddb"&&s.photo.length>20?{...s,photo:"indexeddb"}:s);localStorage.setItem(F.ENTRIES,JSON.stringify(i))}e.has("settings")&&localStorage.setItem(F.SETTINGS,JSON.stringify(this.state.settings)),e.has("currentLang")&&localStorage.setItem(F.LANG,this.state.currentLang),e.has("deviceName")&&localStorage.setItem(F.DEVICE_NAME,this.state.deviceName),e.has("raceId")&&localStorage.setItem(F.RACE_ID,this.state.raceId),e.has("lastSyncedRaceId")&&localStorage.setItem(F.LAST_SYNCED_RACE_ID,this.state.lastSyncedRaceId),e.has("syncQueue")&&localStorage.setItem(F.SYNC_QUEUE,JSON.stringify(this.state.syncQueue)),e.has("deviceRole")&&localStorage.setItem(F.DEVICE_ROLE,this.state.deviceRole),e.has("gateAssignment")&&(this.state.gateAssignment?localStorage.setItem(F.GATE_ASSIGNMENT,JSON.stringify(this.state.gateAssignment)):localStorage.removeItem(F.GATE_ASSIGNMENT)),e.has("firstGateColor")&&localStorage.setItem(F.FIRST_GATE_COLOR,this.state.firstGateColor),e.has("faultEntries")&&localStorage.setItem(F.FAULT_ENTRIES,JSON.stringify(this.state.faultEntries)),(e.has("entries")||e.has("settings"))&&localStorage.setItem(F.SCHEMA_VERSION,String(nn));const n=Ds();n.warning&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:n.usageBytes,quota:n.estimatedQuota,percent:n.usagePercent,critical:n.usagePercent>90}}))}catch(n){y.error("Failed to save to storage:",n),this.dispatchStorageError(n)}}async checkStorageQuota(){var e;if((e=navigator.storage)!=null&&e.estimate)try{const{usage:n,quota:i}=await navigator.storage.estimate();if(i&&n){const s=n/i;s>.75&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:n,quota:i,percent:Math.round(s*100),critical:s>.9}}))}}catch(n){y.warn("Could not check storage quota:",n)}}dispatchStorageError(e){window.dispatchEvent(new CustomEvent("storage-error",{detail:{message:e.message,isQuotaError:e.name==="QuotaExceededError"||e.message.includes("quota")||e.message.includes("storage"),entryCount:this.state.entries.length}}))}addEntry(e){const n=ha(this.state.entries,e,this.state.undoStack,this.state.redoStack);this.setState({entries:n.entries,undoStack:n.undoStack,redoStack:n.redoStack,lastRecordedEntry:e,isRecording:!1}),this.state.settings.sync&&this.state.raceId&&this.addToSyncQueue(e)}deleteEntry(e){const n=ga(this.state.entries,e,this.state.undoStack,this.state.redoStack);n&&this.setState({entries:n.entries,undoStack:n.undoStack,redoStack:n.redoStack})}deleteMultiple(e){const n=ma(this.state.entries,e,this.state.undoStack,this.state.redoStack);n&&this.setState({entries:n.entries,undoStack:n.undoStack,redoStack:n.redoStack,selectMode:!1,selectedEntries:new Set})}clearAll(){const e=pa(this.state.entries,this.state.undoStack,this.state.redoStack);e&&this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack,selectMode:!1,selectedEntries:new Set})}updateEntry(e,n){const i=ya(this.state.entries,e,n,this.state.undoStack,this.state.redoStack);return i?(this.setState({entries:i.entries,undoStack:i.undoStack,redoStack:i.redoStack}),!0):!1}canUndo(){return this.state.undoStack.length>0}canRedo(){return this.state.redoStack.length>0}peekUndo(){return this.canUndo()?this.state.undoStack[this.state.undoStack.length-1]:null}undo(){const e=va(this.state.entries,this.state.undoStack,this.state.redoStack);return this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack}),e.result}redo(){const e=ba(this.state.entries,this.state.undoStack,this.state.redoStack);return this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack}),e.result}addToSyncQueue(e){const n=Sa(this.state.syncQueue,e);this.setState({syncQueue:n})}removeFromSyncQueue(e){const n=Ea(this.state.syncQueue,e);this.setState({syncQueue:n})}updateSyncQueueItem(e,n){const i=wa(this.state.syncQueue,e,n);this.setState({syncQueue:i})}clearSyncQueue(){this.setState({syncQueue:[]})}setView(e){this.setState(ho(e),!1)}setLanguage(e){this.setState(go(e))}setBibInput(e){this.setState(mo(e),!1)}setSelectedPoint(e){this.setState(po(e),!1)}setSelectedRun(e){this.setState(yo(e),!1)}setSelectMode(e){this.setState(vo(e,this.state.selectedEntries),!1)}toggleEntrySelection(e){this.setState(bo(e,this.state.selectedEntries),!1)}selectAllEntries(){this.setState(So(this.state.entries.map(e=>e.id)),!1)}clearSelection(){this.setState(Eo(),!1)}setRecording(e){this.setState(wo(e),!1)}setDeviceRole(e){this.setState(Oa(e))}setGateAssignment(e){this.setState(Va(e))}setFirstGateColor(e){this.setState(_a(e))}getGateColor(e){return Ha(e,this.state.gateAssignment,this.state.firstGateColor)}setSelectedFaultBib(e){this.setState(za(e),!1)}setJudgeReady(e){this.setState(Ua(e))}toggleJudgeReady(){this.setState(Ga(this.state.isJudgeReady))}setChiefJudgeView(e){this.setState(qa(e),!1)}toggleChiefJudgeView(){this.setState(Ja(this.state.isChiefJudgeView),!1)}finalizeRacer(e,n){this.setState(ja(e,n,this.state.finalizedRacers),!1)}unfinalizeRacer(e,n){this.setState(Wa(e,n,this.state.finalizedRacers),!1)}isRacerFinalized(e,n){return Qa(e,n,this.state.finalizedRacers)}clearFinalizedRacers(){this.setState(Ya(),!1)}setPenaltySeconds(e){this.setState(Ka(e),!1)}setUsePenaltyMode(e){this.setState(Za(e),!1)}getActiveBibs(e){return Xa(this.state.entries,e)}addFaultEntry(e){const n=Ca(this.state.faultEntries,e);this.setState({faultEntries:n})}deleteFaultEntry(e){const n=Ta(this.state.faultEntries,e);this.setState({faultEntries:n})}updateFaultEntry(e,n){const i=La(this.state.faultEntries,e,n);return i?(this.setState({faultEntries:i}),!0):!1}updateFaultEntryWithHistory(e,n,i){const s=Aa(this.state.faultEntries,e,n,this.state.deviceName,this.state.deviceId,i);return s?(this.setState({faultEntries:s}),!0):!1}restoreFaultVersion(e,n){const i=Ra(this.state.faultEntries,e,n,this.state.deviceName,this.state.deviceId);return i?(this.setState({faultEntries:i}),!0):!1}markFaultForDeletion(e){const n=Da(this.state.faultEntries,e,this.state.deviceName,this.state.deviceId);return n?(this.setState({faultEntries:n}),!0):!1}approveFaultDeletion(e){const n=xa(this.state.faultEntries,e,this.state.deviceName);return n.approvedFault&&this.setState({faultEntries:n.faultEntries}),n.approvedFault}rejectFaultDeletion(e){const n=Ba(this.state.faultEntries,e,this.state.deviceName,this.state.deviceId);return n?(this.setState({faultEntries:n}),!0):!1}getPendingDeletions(){return Pa(this.state.faultEntries)}clearFaultEntries(){this.setState({faultEntries:[]})}getFaultsForBib(e,n){return Na(this.state.faultEntries,e,n)}mergeFaultsFromCloud(e,n=[]){const i=$a(this.state.faultEntries,e,n,this.state.deviceId);return i.addedCount>0&&this.setState({faultEntries:i.faultEntries}),i.addedCount}removeDeletedCloudFaults(e){const n=Ma(this.state.faultEntries,e);return n.removedCount>0&&this.setState({faultEntries:n.faultEntries}),n.removedCount}markFaultSynced(e){const n=Fa(this.state.faultEntries,e);this.setState({faultEntries:n})}updateSettings(e){const n=eo(this.state.settings,e);this.setState({settings:n})}toggleSetting(e){const n=to(this.state.settings,e);this.setState({settings:n})}setSyncStatus(e){this.setState(no(e),!1)}setRaceId(e){const n=io(e,this.state.raceId);n.clearUndoRedo?this.setState({raceId:n.raceId,undoStack:[],redoStack:[]}):this.setState({raceId:n.raceId})}setLastSyncedRaceId(e){this.setState(so(e))}markCurrentRaceAsSynced(){this.setState({lastSyncedRaceId:this.state.raceId})}setDeviceName(e){this.setState(ro(e))}addConnectedDevice(e){this.setState(oo(e,this.state.connectedDevices),!1)}removeConnectedDevice(e){this.setState(co(e,this.state.connectedDevices),!1)}setCloudDeviceCount(e){this.setState(lo(e),!1)}setCloudHighestBib(e){this.setState(uo(e),!1)}setRaceExistsInCloud(e){this.setState(fo(e),!1)}setGpsStatus(e,n){this.setState({gpsStatus:e,gpsAccuracy:n??null},!1)}setCameraReady(e,n){this.setState({cameraReady:e,cameraError:n??null},!1)}mergeCloudEntries(e,n=[]){const i=Ia(this.state.entries,e,n,this.state.deviceId);return i.addedCount>0&&this.setState({entries:i.entries}),i.addedCount}removeDeletedCloudEntries(e){const n=ka(this.state.entries,e);return n.removedCount>0&&this.setState({entries:n.entries}),n.removedCount}exportData(){return JSON.stringify({version:nn,entries:this.state.entries,settings:this.state.settings,deviceId:this.state.deviceId,deviceName:this.state.deviceName,raceId:this.state.raceId,exportedAt:new Date().toISOString()},null,2)}importData(e){try{const n=JSON.parse(e),i=ua(n,this.state.deviceId),s=new Set(this.state.entries.map(a=>a.id)),r=i.entries.filter(a=>!s.has(a.id));if(r.length>0){const a=[...this.state.entries,...r];a.sort((o,c)=>new Date(o.timestamp).getTime()-new Date(c.timestamp).getTime()),this.setState({entries:a})}return{success:!0,entriesImported:r.length}}catch(n){return{success:!1,entriesImported:0,error:String(n)}}}}const l=new ko,Ji={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},Co=.8,xt=1280,Bt=720,ji=200;class To{constructor(){g(this,"stream",null);g(this,"videoElement",null);g(this,"canvasElement",null);g(this,"cameraState","stopped");g(this,"visibilityHandler",null);g(this,"pendingVisibilityChange",null);g(this,"previewElement",null);g(this,"ownsVideoElement",!1)}async initialize(){if(this.cameraState==="ready")return!0;if(this.cameraState==="initializing")return!1;this.cameraState="initializing";try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not available");return this.previewElement?(this.videoElement=this.previewElement,this.ownsVideoElement=!1):(this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.ownsVideoElement=!0),this.canvasElement=document.createElement("canvas"),this.canvasElement.width=xt,this.canvasElement.height=Bt,this.stream=await navigator.mediaDevices.getUserMedia(Ji),this.videoElement.srcObject=this.stream,await new Promise((e,n)=>{if(!this.videoElement){n(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(n)},this.videoElement.onerror=()=>n(new Error("Video load error"))}),this.pendingVisibilityChange==="hidden"?(this.pendingVisibilityChange=null,this.pauseCamera(),!1):(this.cameraState="ready",l.setCameraReady(!0),this.visibilityHandler||(this.visibilityHandler=()=>this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.visibilityHandler)),!0)}catch(e){const n=e instanceof Error?e.message:"Camera initialization failed";return y.error("Camera initialization error:",n),this.cameraState="stopped",l.setCameraReady(!1,n),!1}}handleVisibilityChange(){document.hidden?this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange="hidden":this.cameraState==="ready"&&this.pauseCamera():this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange=null:this.cameraState==="paused"&&this.reinitializeCamera()}pauseCamera(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.videoElement&&(this.videoElement.srcObject=null)),this.cameraState="paused",l.setCameraReady(!1)}async reinitializeCamera(){if(this.cameraState!=="resuming"){this.cameraState="resuming";try{if(this.videoElement||(this.previewElement?(this.videoElement=this.previewElement,this.ownsVideoElement=!1):(this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.ownsVideoElement=!0)),this.stream=await navigator.mediaDevices.getUserMedia(Ji),this.videoElement.srcObject=this.stream,await new Promise((e,n)=>{if(!this.videoElement){n(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(n)},this.videoElement.onerror=()=>n(new Error("Video load error"))}),this.pendingVisibilityChange==="hidden"){this.pendingVisibilityChange=null,this.pauseCamera();return}this.cameraState="ready",l.setCameraReady(!0)}catch(e){y.error("Failed to reinitialize camera:",e),this.cameraState="stopped"}}}async capturePhoto(){if(this.cameraState!=="ready"||!this.videoElement||!this.canvasElement)return y.warn("Camera not ready for capture"),null;try{const e=this.canvasElement.getContext("2d");if(!e)throw new Error("Could not get canvas context");const n=this.videoElement.videoWidth,i=this.videoElement.videoHeight;let s=n,r=i;if(s>xt){const d=xt/s;s=xt,r=Math.round(r*d)}if(r>Bt){const d=Bt/r;r=Bt,s=Math.round(s*d)}this.canvasElement.width=s,this.canvasElement.height=r,e.drawImage(this.videoElement,0,0,s,r);const a=new Date().toISOString();e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,r-30,s,30),e.fillStyle="#ffffff",e.font="14px monospace",e.fillText(a,10,r-10);const c=this.canvasElement.toDataURL("image/jpeg",Co).split(",")[1],u=Math.round(c.length/1024);if(u>ji){const d=new Error(`Photo too large (${u}KB > ${ji}KB limit)`);throw d.name="PhotoTooLargeError",d}return c}catch(e){return y.error("Photo capture error:",e),null}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null,this.ownsVideoElement&&(this.videoElement.remove(),this.videoElement=null)),this.canvasElement&&(this.canvasElement=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.pendingVisibilityChange=null,this.cameraState="stopped",l.setCameraReady(!1)}isReady(){return this.cameraState==="ready"}setPreviewElement(e){if(this.previewElement=e,!e){this.videoElement&&!this.ownsVideoElement&&(this.videoElement.srcObject=null,this.videoElement=null);return}this.videoElement!==e&&(this.videoElement&&this.ownsVideoElement&&this.videoElement.remove(),this.videoElement=e,this.ownsVideoElement=!1),this.stream&&(this.videoElement.srcObject=this.stream,this.videoElement.play().catch(()=>null))}getVideoElement(){return this.videoElement}getError(){return l.getState().cameraError}async toggle(e){return e?this.initialize():(this.stop(),!0)}}const Qe=new To;async function Ns(){return!l.getState().settings.photoCapture||!Qe.isReady()&&!await Qe.initialize()?null:Qe.capturePhoto()}let Ye=null,Pt=null;const Lo=3e4;function Fs(){if(!Ye)try{Ye=new(window.AudioContext||window.webkitAudioContext)}catch(t){return y.warn("AudioContext not available:",t),null}return Ye}function Ao(){Pt!==null&&clearTimeout(Pt),Pt=window.setTimeout(()=>{Ye&&Ye.state==="running"&&Ye.suspend().catch(()=>{}),Pt=null},Lo)}function Me(t){if(l.getState().settings.haptic&&navigator.vibrate)try{navigator.vibrate(t)}catch(n){y.warn("Vibration failed:",n)}}function wn(t=880,e=100){if(!l.getState().settings.sound)return;const i=Fs();if(i){i.state==="suspended"&&i.resume().catch(()=>{}),Ao();try{const s=i.createOscillator(),r=i.createGain();s.connect(r),r.connect(i.destination),s.frequency.value=t,s.type="sine",r.gain.setValueAtTime(.3,i.currentTime),r.gain.exponentialRampToValueAtTime(.01,i.currentTime+e/1e3),s.start(i.currentTime),s.stop(i.currentTime+e/1e3)}catch(s){y.warn("Sound playback failed:",s)}}}function G(){Me(40),wn(880,100)}function z(){Me([60,40,60]),wn(440,200)}function I(){Me(30)}function Ro(){Me(10)}function Do(){Me(20)}function In(){Me([40,30,40]),wn(330,150)}function ti(){Me([35,35]),wn(660,100)}async function Wi(){const t=Fs();if(t&&t.state==="suspended")try{await t.resume()}catch(e){y.warn("Failed to resume audio:",e)}}const xo={enableHighAccuracy:!0,timeout:1e4,maximumAge:1e4},Bo={enableHighAccuracy:!1,timeout:15e3,maximumAge:3e4},Qi={enableHighAccuracy:!1,timeout:3e4,maximumAge:6e4},Po=10,No=30;class Fo{constructor(){g(this,"watchId",null);g(this,"lastPosition",null);g(this,"visibilityHandler",null);g(this,"wasActiveBeforeHidden",!1);g(this,"batteryUnsubscribe",null);g(this,"usingLowPowerMode",!1);g(this,"dutyCycleIntervalId",null);g(this,"isDutyCycling",!1);g(this,"timeOffset",null)}getGpsOptions(){const e=W.isLowBattery();return this.usingLowPowerMode=e,e?Bo:xo}startDutyCycling(){this.isDutyCycling||(this.isDutyCycling=!0,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),y.debug("[GPS] Starting duty cycling (30s interval)"),this.dutyCycleIntervalId=setInterval(()=>{navigator.geolocation.getCurrentPosition(e=>this.handlePosition(e),e=>this.handleError(e),Qi)},3e4),navigator.geolocation.getCurrentPosition(e=>this.handlePosition(e),e=>this.handleError(e),Qi))}stopDutyCycling(){this.dutyCycleIntervalId!==null&&(clearInterval(this.dutyCycleIntervalId),this.dutyCycleIntervalId=null),this.isDutyCycling=!1}start(){if(this.watchId!==null||this.isDutyCycling)return!0;if(!navigator.geolocation)return y.error("Geolocation not supported"),l.setGpsStatus("inactive"),!1;l.setGpsStatus("searching");try{const e=this.getGpsOptions();return this.watchId=navigator.geolocation.watchPosition(n=>this.handlePosition(n),n=>this.handleError(n),e),this.visibilityHandler||(this.visibilityHandler=()=>{if(document.hidden)this.wasActiveBeforeHidden=this.watchId!==null||this.isDutyCycling,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.wasActiveBeforeHidden&&l.setGpsStatus("inactive");else if(this.wasActiveBeforeHidden)if(l.setGpsStatus("searching"),W.isCriticalBattery())this.startDutyCycling();else{const n=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(i=>this.handlePosition(i),i=>this.handleError(i),n)}},document.addEventListener("visibilitychange",this.visibilityHandler)),this.batteryUnsubscribe||(this.batteryUnsubscribe=W.subscribe(()=>{if(this.watchId===null&&!this.isDutyCycling)return;const n=W.isCriticalBattery();if(n&&!this.isDutyCycling){y.debug("[GPS] Switching to duty-cycle mode (critical battery)"),this.startDutyCycling();return}if(!n&&this.isDutyCycling){y.debug("[GPS] Resuming continuous GPS from duty-cycle mode"),this.stopDutyCycling();const i=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(s=>this.handlePosition(s),s=>this.handleError(s),i);return}if(this.watchId!==null){const i=W.isLowBattery();if(i!==this.usingLowPowerMode){y.debug(`[GPS] Switching to ${i?"low-power":"high-accuracy"} mode`),navigator.geolocation.clearWatch(this.watchId);const s=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(r=>this.handlePosition(r),r=>this.handleError(r),s)}}})),!0}catch(e){return y.error("Failed to start GPS:",e),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),l.setGpsStatus("inactive"),!1}}pause(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.wasActiveBeforeHidden=!1,l.setGpsStatus(this.lastPosition?"paused":"inactive")}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasActiveBeforeHidden=!1,this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.lastPosition=null,this.timeOffset=null,l.setGpsStatus("inactive")}handlePosition(e){this.lastPosition=e;const n=e.timestamp-Date.now();Math.abs(n)>500&&y.warn(`[GPS] Clock offset ${n}ms - system clock may be inaccurate`),this.timeOffset=n;const i=e.coords.accuracy;l.setGpsStatus("active",i)}handleError(e){switch(y.error("GPS error:",e.message),e.code){case e.PERMISSION_DENIED:l.setGpsStatus("inactive"),this.stop();break;case e.POSITION_UNAVAILABLE:l.setGpsStatus("searching");break;case e.TIMEOUT:l.setGpsStatus("searching");break}}getPosition(){return this.lastPosition}getCoordinates(){if(this.lastPosition)return{latitude:this.lastPosition.coords.latitude,longitude:this.lastPosition.coords.longitude,accuracy:this.lastPosition.coords.accuracy}}getTimestamp(){var e;return((e=this.lastPosition)==null?void 0:e.timestamp)??null}getTimeOffset(){return this.timeOffset}getAccuracyStatus(){if(!this.lastPosition)return"unknown";const e=this.lastPosition.coords.accuracy;return e<=Po?"good":e<=No?"fair":"poor"}isActive(){return(this.watchId!==null||this.isDutyCycling)&&this.lastPosition!==null}toggle(e){return e?this.start():(this.stop(),!0)}async requestPosition(){return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(n=>{this.lastPosition=n,e(n)},()=>e(null),this.getGpsOptions())}):null}}const me=new Fo,$o=`You are a voice command processor for a ski race timing app.
Parse the user's spoken command and return a structured JSON response.

Context provided:
- role: "timer" (sets bib/point/run) or "gateJudge" (records faults)
- language: User's language (de/en)
- activeBibs: Racers currently on course (gate judge only)
- gateRange: Gates this judge is watching [start, end]
- pendingConfirmation: If set, user is responding to a confirmation prompt

For TIMER role, recognize:
- Bib numbers: spoken digits or number words (e.g., "forty-five" = 45, "fünfundvierzig" = 45)
- Timing point: "Start" / "Ziel" / "Finish"
- Run selection: "Lauf 1/2", "Run 1/2", "erster Lauf", "zweiter Lauf"
NOTE: Timer role does NOT support recording timestamps via voice (latency too high for timing)

For GATE JUDGE role, recognize:
- Fault recording with bib + gate + type
- Fault types: MG (missed gate/ausgelassen), STR (straddling/eingefädelt), BR (binding release/Bindung offen)
- Ready status: "Bereit", "Ready", "Fertig"
- Confirmation: "Ja", "Yes", "Correct", "Richtig", "Stimmt"
- Cancellation: "Nein", "No", "Cancel", "Abbrechen", "Falsch"

Return ONLY valid JSON (no markdown, no explanation):
{
  "action": "record_fault" | "set_bib" | "set_gate" | "set_point" | "set_run" | "toggle_ready" | "confirm" | "cancel" | "unknown",
  "confidence": 0.0-1.0,
  "params": {
    "bib": "string (3 digits, zero-padded)",
    "gate": number,
    "faultType": "MG" | "STR" | "BR",
    "point": "S" | "F",
    "run": number (positive integer, typically 1 or 2)
  },
  "confirmationNeeded": boolean,
  "confirmationPrompt": "string (spoken confirmation request in user's language)"
}

IMPORTANT:
- For gate judge faults, set confirmationNeeded=true with a clear prompt
- Confirmation prompts should be in the user's language
- If user tries to record time via voice, return action="unknown" (voice timing disabled)
- If unsure, set action="unknown" with low confidence`,Mo={model:"claude-3-haiku-20240307",maxTokens:256};function Oo(t){return t.includes("/api/v1/voice")}async function Vo(t,e,n){const{endpoint:i,apiKey:s,model:r,maxTokens:a}={...Mo,...n};if(!i)throw new Error("LLM endpoint is required");if(Oo(i))return _o(t,e,i);if(!s)throw new Error("API key is required for direct LLM calls");return Ho(t,e,i,s,r,a)}async function _o(t,e,n){try{const i=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcript:t,context:e})});if(!i.ok){const r=await i.text();throw y.error("[LLMProvider] Proxy error:",i.status,r),new Error(`Proxy error: ${i.status}`)}const s=await i.json();if(s.success&&s.intent)return y.debug("[LLMProvider] Proxy intent:",s.intent),s.intent;throw new Error("Invalid proxy response")}catch(i){return y.error("[LLMProvider] Proxy processing error:",i),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function Ho(t,e,n,i,s,r){var c;const o=`Context: ${JSON.stringify({role:e.role,language:e.language,currentRun:e.currentRun,activeBibs:e.activeBibs,gateRange:e.gateRange,pendingConfirmation:e.pendingConfirmation?{action:e.pendingConfirmation.action,params:e.pendingConfirmation.params}:null})}

Transcript: "${t}"`;try{const u=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:s,max_tokens:r,system:$o,messages:[{role:"user",content:o}]})});if(!u.ok){const v=await u.text();throw y.error("[LLMProvider] API error:",u.status,v),new Error(`LLM API error: ${u.status}`)}const d=await u.json();let h="";if(d.content&&Array.isArray(d.content)?h=((c=d.content[0])==null?void 0:c.text)||"":typeof d.content=="string"&&(h=d.content),!h)throw new Error("Empty response from LLM");let m=h.trim();m.startsWith("```")&&(m=m.replace(/```json?\n?/g,"").replace(/```$/g,"").trim());const p=JSON.parse(m);if(!p.action||typeof p.confidence!="number")throw new Error("Invalid intent structure");return y.debug("[LLMProvider] Parsed intent:",p),p}catch(u){return y.error("[LLMProvider] Processing error:",u),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function zo(t,e,n,i=5e3){const s=new Promise((r,a)=>{setTimeout(()=>a(new Error("LLM request timeout")),i)});return Promise.race([Vo(t,e,n),s]).catch(r=>(y.warn("[LLMProvider] Timeout or error:",r),{action:"unknown",confidence:0,confirmationNeeded:!1}))}const Uo="ski-timer-photos",Go=1,ee="photos",qo=3,Jo=5e3;class jo{constructor(){g(this,"db",null);g(this,"initPromise",null);g(this,"saveQueue",[]);g(this,"activeSaves",0)}async initialize(){return this.initPromise?this.initPromise:(this.initPromise=new Promise(e=>{if(!window.indexedDB){y.warn("IndexedDB not supported - photo storage disabled"),e(!1);return}const n=indexedDB.open(Uo,Go);n.onerror=()=>{y.error("IndexedDB open error:",n.error),e(!1)},n.onsuccess=()=>{this.db=n.result,e(!0)},n.onupgradeneeded=i=>{const s=i.target.result;s.objectStoreNames.contains(ee)||s.createObjectStore(ee,{keyPath:"entryId"}).createIndex("timestamp","timestamp",{unique:!1})}}),this.initPromise)}async savePhoto(e,n){return new Promise(i=>{this.saveQueue.push({entryId:e,photoBase64:n,resolve:i}),this.processQueue()})}processQueue(){for(;this.saveQueue.length>0&&this.activeSaves<qo;){const e=this.saveQueue.shift();this.activeSaves++,this.doSavePhotoWithTimeout(e.entryId,e.photoBase64).then(n=>{e.resolve(n)}).catch(()=>{e.resolve(!1)}).finally(()=>{this.activeSaves--,this.processQueue()})}}async doSavePhotoWithTimeout(e,n){return Promise.race([this.doSavePhoto(e,n),new Promise((i,s)=>setTimeout(()=>s(new Error("Photo save timeout")),Jo))])}async doSavePhoto(e,n){return!this.db&&!await this.initialize()?!1:new Promise(i=>{if(!this.db){i(!1);return}try{const r=this.db.transaction([ee],"readwrite").objectStore(ee),a={entryId:e,photo:n,timestamp:Date.now()},o=r.put(a);o.onsuccess=()=>{i(!0)},o.onerror=()=>{y.error("Photo save error:",o.error),i(!1)}}catch(s){y.error("Photo save transaction error:",s),i(!1)}})}async getPhoto(e){return!this.db&&!await this.initialize()?null:new Promise(n=>{if(!this.db){n(null);return}try{const r=this.db.transaction([ee],"readonly").objectStore(ee).get(e);r.onsuccess=()=>{const a=r.result;n((a==null?void 0:a.photo)||null)},r.onerror=()=>{y.error("Photo get error:",r.error),n(null)}}catch(i){y.error("Photo get transaction error:",i),n(null)}})}async deletePhoto(e){return!this.db&&!await this.initialize()?!1:new Promise(n=>{if(!this.db){n(!1);return}try{const r=this.db.transaction([ee],"readwrite").objectStore(ee).delete(e);r.onsuccess=()=>{n(!0)},r.onerror=()=>{y.error("Photo delete error:",r.error),n(!1)}}catch(i){y.error("Photo delete transaction error:",i),n(!1)}})}async hasPhoto(e){return await this.getPhoto(e)!==null}async clearAll(){return!this.db&&!await this.initialize()?!1:new Promise(e=>{if(!this.db){e(!1);return}try{const s=this.db.transaction([ee],"readwrite").objectStore(ee).clear();s.onsuccess=()=>{e(!0)},s.onerror=()=>{y.error("Photo clear error:",s.error),e(!1)}}catch(n){y.error("Photo clear transaction error:",n),e(!1)}})}async deletePhotos(e){for(const n of e)await this.deletePhoto(n)}async getStorageUsage(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{used:e.usage||0,quota:e.quota||0}}catch{return null}return null}async getPhotoCount(){return!this.db&&!await this.initialize()?0:new Promise(e=>{if(!this.db){e(0);return}try{const s=this.db.transaction([ee],"readonly").objectStore(ee).count();s.onsuccess=()=>{e(s.result)},s.onerror=()=>{e(0)}}catch{e(0)}})}close(){this.db&&(this.db.close(),this.db=null,this.initPromise=null)}}const Q=new jo;class Wo{constructor(){g(this,"synth",null);g(this,"voice",null);g(this,"voicesLoaded",!1);typeof window<"u"&&"speechSynthesis"in window&&(this.synth=window.speechSynthesis,this.loadVoices())}isSupported(){return this.synth!==null}loadVoices(){if(!this.synth)return;this.synth.getVoices().length>0?(this.voicesLoaded=!0,this.selectVoiceForLanguage(l.getState().currentLang)):this.synth.addEventListener("voiceschanged",()=>{this.voicesLoaded=!0,this.selectVoiceForLanguage(l.getState().currentLang)},{once:!0})}selectVoiceForLanguage(e){if(!this.synth)return;const n=this.synth.getVoices(),i=e==="de"?"de":"en";this.voice=n.find(s=>s.lang.startsWith(i)&&s.name.toLowerCase().includes("female"))||n.find(s=>s.lang.startsWith(i))||n.find(s=>s.lang.startsWith("en"))||null,this.voice&&y.debug("[SpeechSynthesis] Selected voice:",this.voice.name,this.voice.lang)}setLanguage(e){this.voicesLoaded&&this.selectVoiceForLanguage(e)}speak(e,n){return new Promise((i,s)=>{if(!this.synth){s(new Error("Speech synthesis not supported"));return}this.synth.cancel();const r=new SpeechSynthesisUtterance(e);this.voice&&(r.voice=this.voice),r.rate=(n==null?void 0:n.rate)??1.1,r.pitch=(n==null?void 0:n.pitch)??1,r.volume=1,r.onend=()=>i(),r.onerror=a=>{a.error==="interrupted"?i():(y.warn("[SpeechSynthesis] Error:",a.error),s(new Error(a.error)))},this.synth.speak(r)})}sayOK(){return this.speak("OK",{rate:1.2})}sayRecorded(){const n=l.getState().currentLang==="de"?"Erfasst":"Recorded";return this.speak(n,{rate:1.1})}sayNotUnderstood(){const n=l.getState().currentLang==="de"?"Nicht verstanden":"Not understood";return this.speak(n,{rate:1})}cancel(){var e;(e=this.synth)==null||e.cancel()}}const be=new Wo,re={CRITICAL:"critical",ERROR:"error",WARNING:"warning",INFO:"info"},et={CRITICAL:8e3,ERROR:5e3,WARNING:4e3,INFO:3e3};function Qo(t){return`[${t.component}] ${t.operation}`}function Yo(t){return t instanceof Error?t.message:typeof t=="string"?t:"Unknown error"}function yi(t){const e=Qo(t),n=t.error?Yo(t.error):"No error details",i={code:t.code,message:n,timestamp:new Date().toISOString(),...t.metadata};switch(t.severity){case re.CRITICAL:case re.ERROR:console.error(`${e}:`,n,i);break;case re.WARNING:console.warn(`${e}:`,n,i);break;case re.INFO:console.log(`${e}:`,n,i);break}if(t.userMessageKey){const s=l.getState().currentLang,r=f(t.userMessageKey,s),a=Ko(t.severity),o=et[t.severity.toUpperCase()]||et.ERROR;w(r,a,o)}t.severity===re.CRITICAL&&window.dispatchEvent(new CustomEvent("critical-error",{detail:t}))}function Ko(t){switch(t){case re.CRITICAL:case re.ERROR:return"error";case re.WARNING:return"warning";case re.INFO:return"info";default:return"error"}}function kn(t,e,n,i){yi({component:t,operation:e,severity:re.ERROR,error:n,userMessageKey:i})}function gt(t,e,n,i){yi({component:t,operation:e,severity:re.WARNING,error:n,userMessageKey:i})}function Zo(t,e,n,i){yi({component:t,operation:e,severity:re.CRITICAL,error:n,userMessageKey:i})}const Xo=1e4;class ec extends Error{constructor(e,n){super(`Request to ${e} timed out after ${n}ms`),this.name="FetchTimeoutError"}}async function ae(t,e={},n=Xo){const i=new AbortController,s=setTimeout(()=>i.abort(),n);try{return await fetch(t,{...e,signal:i.signal})}catch(r){throw r instanceof Error&&r.name==="AbortError"?new ec(t,n):r}finally{clearTimeout(s)}}const Tt="skiTimerAuthToken";function le(){const t=localStorage.getItem(Tt);return t?{Authorization:`Bearer ${t}`}:{}}function Le(){const t=localStorage.getItem(Tt);if(!t)return!1;try{const e=t.split(".");if(e.length===3){const n=JSON.parse(atob(e[1]));if(n.exp&&n.exp*1e3<Date.now())return!1}}catch{}return!0}function tc(t){localStorage.setItem(Tt,t)}function $s(){localStorage.removeItem(Tt)}const nc=1e4;async function Ms(t,e){const n=new AbortController,i=setTimeout(()=>n.abort(),nc);try{const s=await fetch("/api/v1/auth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:t,role:e}),signal:n.signal});clearTimeout(i);const r=await s.json();return s.ok?r.token?(tc(r.token),{success:!0,token:r.token,isNewPin:r.isNewPin}):{success:!1,error:"No token received"}:{success:!1,error:r.error||"Authentication failed"}}catch(s){return clearTimeout(i),s instanceof Error&&s.name==="AbortError"?(y.error("Token exchange timeout"),{success:!1,error:"Request timeout"}):(y.error("Token exchange error:",s),{success:!1,error:"Network error"})}}function ic(t="Session expired. Please re-enter your PIN."){window.dispatchEvent(new CustomEvent("auth-expired",{detail:{message:t}}))}class sc{constructor(){g(this,"broadcastChannel",null)}initialize(e){if(typeof BroadcastChannel>"u"){y.info("BroadcastChannel not supported - cross-tab sync disabled (graceful degradation)");return}try{this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(`ski-timer-${e}`),this.broadcastChannel.onmessage=n=>{try{const{type:i,data:s}=n.data||{};if(i==="entry"&&rt(s))l.mergeCloudEntries([s]);else if(i==="presence"){const r=s;l.addConnectedDevice(r)}else if(i==="fault"){const r=s;r!=null&&r.id&&l.mergeFaultsFromCloud([r])}else if(i==="fault-deleted"){const r=s;r&&l.markFaultForDeletion(r)}}catch(i){y.error("Error processing broadcast message:",i)}}}catch(n){y.warn("BroadcastChannel initialization failed:",n)}}broadcastEntry(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"entry",data:e})}catch(n){y.error("Broadcast error:",n)}}broadcastPresence(){const e=l.getState();if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"presence",data:{id:e.deviceId,name:e.deviceName,lastSeen:Date.now()}})}catch(n){y.error("Presence broadcast error:",n)}}broadcastFault(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"fault",data:e})}catch(n){y.error("Fault broadcast error:",n)}}broadcastFaultDeletion(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"fault-deleted",data:e})}catch(n){y.error("Fault deletion broadcast error:",n)}}cleanup(){if(this.broadcastChannel){try{this.broadcastChannel.close()}catch{}this.broadcastChannel=null}}}const qe=new sc;function ke(t){const e=String(t.getHours()).padStart(2,"0"),n=String(t.getMinutes()).padStart(2,"0"),i=String(t.getSeconds()).padStart(2,"0"),s=String(t.getMilliseconds()).padStart(3,"0");return`${e}:${n}:${i}.${s}`}function rc(t,e="de"){const n={weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"};return t.toLocaleDateString(e==="de"?"de-DE":"en-US",n)}function Pn(t,e=3){return String(t).padStart(e,"0")}function T(t){const e=document.createElement("div");return e.textContent=String(t),e.innerHTML}function L(t){return T(t).replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function mt(t){return{S:"var(--success)",F:"var(--secondary)"}[t]||"var(--text-secondary)"}function Ce(t,e="de"){return{en:{S:"Start",F:"Finish"},de:{S:"Start",F:"Ziel"}}[e][t]}function ut(t,e="de"){return`${e==="de"?"L":"R"}${t}`}function ft(t){return t===1?"var(--primary)":t===2?"var(--warning)":"var(--text-secondary)"}function ve(t,e){return{MG:f("faultMGShort",e),STR:f("faultSTRShort",e),BR:f("faultBRShort",e)}[t]||t}function ac(t){return t<1024?`${t} B`:t<1024*1024?`${(t/1024).toFixed(1)} KB`:`${(t/(1024*1024)).toFixed(1)} MB`}const Os="skiTimerRecentRaces",oc=50;function Vs(){try{const t=localStorage.getItem(Os);return t?JSON.parse(t):[]}catch{return[]}}function vi(t,e,n){try{const i=Vs(),s=t.toLowerCase(),r=i.findIndex(o=>o.raceId.toLowerCase()===s);r>=0?(i[r].lastUpdated=e,n!==void 0&&(i[r].entryCount=n)):i.unshift({raceId:t,createdAt:Date.now(),lastUpdated:e,entryCount:n}),i.sort((o,c)=>c.lastUpdated-o.lastUpdated);const a=i.slice(0,oc);localStorage.setItem(Os,JSON.stringify(a))}catch(i){y.error("Failed to save recent race:",i)}}function on(t=5){const e=Vs(),n=new Date;n.setHours(0,0,0,0);const i=n.getTime();return e.filter(s=>s.createdAt>=i||s.lastUpdated>=i).slice(0,t)}const pt="/api/v1/sync",bi="/api/v1/faults",Yi=15e3,Ki=3e4,cc=5,lc=2e3,dc=1e4,Oe=8e3,uc=[15e3,2e4,3e4,45e3,6e4],Nn=6,Zi=[3e4,45e3,6e4,9e4,12e4],Xi=[3e4,6e4],es=3,ts=[15e3,2e4,3e4,45e3,6e4],fc=15e3,hc=15e3,ns=6e4,is=3e4;let P=null,cn=0;function gc(t){P=t}function mc(){return cn}async function pc(t){const e=l.getState(),n=[];for(const i of t)i.photo&&i.photo!=="indexeddb"&&i.photo.length>20?e.settings.syncPhotos?await Q.savePhoto(i.id,i.photo)?n.push({...i,photo:"indexeddb"}):(y.warn("Sync: Photo storage failed for entry:",i.id),n.push({...i,photo:void 0})):n.push({...i,photo:void 0}):n.push(i);return n}async function ss(){const t=l.getState();if(!t.settings.sync||!t.raceId)return;const e=t.syncStatus;(e==="connected"||e==="connecting")&&l.setSyncStatus("syncing");try{const n=new URLSearchParams({raceId:t.raceId,deviceId:t.deviceId,deviceName:t.deviceName}),i=await ae(`${pt}?${n}`,{headers:le()},Oe);if(i.status===401){let u={};try{u=await i.json()}catch{u={}}if(u.expired){$s(),l.setSyncStatus("disconnected"),ic(),P==null||P.onCleanup();return}throw new Error(`HTTP ${i.status}: ${u.error||"Unauthorized"}`)}if(!i.ok)throw new Error(`HTTP ${i.status}`);let s;try{s=await i.json()}catch{throw new Error("Invalid response format")}if(!s||typeof s!="object")throw new Error("Invalid data structure");if(s.deleted){window.dispatchEvent(new CustomEvent("race-deleted",{detail:{raceId:t.raceId,deletedAt:s.deletedAt,message:s.message}})),P==null||P.onCleanup();return}const a=(Array.isArray(s.entries)?s.entries:[]).filter(u=>rt(u)?!0:(y.warn("Skipping invalid entry from cloud:",u),!1)),o=Array.isArray(s.deletedIds)?s.deletedIds.filter(u=>typeof u=="string"&&u.length>0):[];l.setSyncStatus("connected"),typeof s.deviceCount=="number"&&l.setCloudDeviceCount(s.deviceCount),typeof s.highestBib=="number"&&l.setCloudHighestBib(s.highestBib);let c=!1;if(o.length>0&&(l.removeDeletedCloudEntries(o),c=!0),a.length>0){const u=await pc(a),d=l.mergeCloudEntries(u,o);if(d>0){c=!0;const h=l.getState().currentLang;P==null||P.showToast(f("syncedEntriesFromCloud",h).replace("{count}",String(d)))}}cn=s.lastUpdated||Date.now(),t.raceId&&vi(t.raceId,cn,a.length),await(P==null?void 0:P.fetchFaults()),P==null||P.onPollingAdjust(!0,c)}catch(n){y.error("Cloud sync fetch error:",n);const i=n instanceof Error?n.message:"Unknown error";(n instanceof Error?n.name:"")==="FetchTimeoutError"||i.includes("timed out")||i.includes("500")||i.includes("503")?l.setSyncStatus("error"):i.includes("Failed to fetch")||i.includes("NetworkError")?l.setSyncStatus("offline"):l.setSyncStatus("error"),P==null||P.onPollingAdjust(!1)}}async function yc(t,e){const n=l.getState();if(!n.settings.sync||!n.raceId)return!1;try{const i=await ae(`${pt}?raceId=${encodeURIComponent(n.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json",...le()},body:JSON.stringify({entryId:t,deviceId:e||n.deviceId,deviceName:n.deviceName})},Oe);if(!i.ok)throw new Error(`HTTP ${i.status}`);return!0}catch(i){return y.error("Cloud sync delete error:",i),!1}}async function ni(t){const e=l.getState();if(!e.settings.sync||!e.raceId)return!1;try{let n={...t};if(e.settings.syncPhotos&&t.photo==="indexeddb"){const s=await Q.getPhoto(t.id);s?n={...t,photo:s}:n={...t,photo:void 0}}else t.photo&&(n={...t,photo:void 0});const i=await ae(`${pt}?raceId=${encodeURIComponent(e.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json",...le()},body:JSON.stringify({entry:n,deviceId:e.deviceId,deviceName:e.deviceName})},Oe);if(!i.ok)throw new Error(`HTTP ${i.status}`);try{const s=await i.json(),r=l.getState().currentLang;if(s.photoSkipped&&(P==null||P.showToast(f("photoTooLarge",r),"warning")),s.crossDeviceDuplicate){const a=s.crossDeviceDuplicate,o=Ce(a.point,r);P==null||P.showToast(f("crossDeviceDuplicate",r).replace("{bib}",a.bib).replace("{point}",o).replace("{device}",a.deviceName),"warning",5e3),window.dispatchEvent(new CustomEvent("cross-device-duplicate",{detail:a}))}typeof s.deviceCount=="number"&&l.setCloudDeviceCount(s.deviceCount),typeof s.highestBib=="number"&&l.setCloudHighestBib(s.highestBib)}catch(s){y.warn("Failed to parse send response body:",s)}return l.removeFromSyncQueue(t.id),P==null||P.onResetFastPolling(),!0}catch(n){return y.error("Cloud sync send error:",n),!1}}async function vc(){const t=l.getState();if(!(!t.settings.sync||!t.raceId))for(const e of t.entries)e.deviceId===t.deviceId&&!e.syncedAt&&await ni(e)}function bc(){P=null,cn=0}let Ee=null,Si=[];function Sc(t){Ee=t}function Ec(t){const e=l.getState();Si=t.filter(n=>n.deviceId!==e.deviceId)}function wc(){return Si}async function Ic(){const t=l.getState();if(!(!t.settings.sync||!t.raceId))try{const e=new URLSearchParams({raceId:t.raceId,deviceId:t.deviceId,deviceName:t.deviceName});t.deviceRole==="gateJudge"&&t.gateAssignment&&(e.set("gateStart",String(t.gateAssignment[0])),e.set("gateEnd",String(t.gateAssignment[1])),e.set("isReady",String(t.isJudgeReady)),e.set("firstGateColor",t.firstGateColor));const n=await ae(`${bi}?${e}`,{headers:le()},Oe);if(!n.ok){if(n.status===401)return;throw new Error(`HTTP ${n.status}`)}const i=await n.json();if(!i||typeof i!="object")throw new Error("Invalid fault data structure");const s=Array.isArray(i.faults)?i.faults:[],r=Array.isArray(i.deletedIds)?i.deletedIds.filter(a=>typeof a=="string"):[];if(r.length>0&&l.removeDeletedCloudFaults(r),s.length>0){const a=l.mergeFaultsFromCloud(s,r);if(a>0){const o=l.getState().currentLang;Ee==null||Ee.showToast(f("syncedFaultsFromCloud",o).replace("{count}",String(a)))}}Array.isArray(i.gateAssignments)&&Ec(i.gateAssignments)}catch(e){y.error("Fault sync fetch error:",e),window.dispatchEvent(new CustomEvent("fault-sync-error",{detail:{error:e instanceof Error?e.message:"Unknown error"}}))}}async function _s(t){const e=l.getState();if(!e.settings.sync||!e.raceId)return!1;try{const n=await ae(`${bi}?raceId=${encodeURIComponent(e.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json",...le()},body:JSON.stringify({fault:t,deviceId:e.deviceId,deviceName:e.deviceName,gateRange:e.gateAssignment,isReady:e.isJudgeReady,firstGateColor:e.firstGateColor})},Oe);if(!n.ok)throw new Error(`HTTP ${n.status}`);return l.markFaultSynced(t.id),Ee==null||Ee.onResetFastPolling(),!0}catch(n){return y.error("Fault sync send error:",n),!1}}async function kc(t,e,n){const i=l.getState();if(!i.settings.sync||!i.raceId)return!1;try{const s=await ae(`${bi}?raceId=${encodeURIComponent(i.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json",...le()},body:JSON.stringify({faultId:t,deviceId:e||i.deviceId,deviceName:i.deviceName,approvedBy:n||i.deviceName})},Oe);if(!s.ok)throw new Error(`HTTP ${s.status}`);return!0}catch(s){return y.error("Fault sync delete error:",s),!1}}async function Cc(){const t=l.getState();if(!(!t.settings.sync||!t.raceId))for(const e of t.faultEntries)e.deviceId===t.deviceId&&!e.syncedAt&&await _s(e)}function Tc(){Ee=null,Si=[]}class Lc{constructor(){g(this,"isMetered",!1);g(this,"currentQuality","good");g(this,"networkChangeHandler",null);g(this,"onlineHandler",null);g(this,"offlineHandler",null);g(this,"changeListeners",new Set);g(this,"qualityListeners",new Set)}getConnection(){return navigator.connection}initialize(){this.currentQuality=navigator.onLine?"good":"offline";const e=this.getConnection();e&&(this.updateNetworkState(e),this.networkChangeHandler||(this.networkChangeHandler=()=>{const n=this.isMetered,i=this.currentQuality;this.updateNetworkState(e),n!==this.isMetered&&this.notifyListeners(),i!==this.currentQuality&&this.notifyQualityListeners()},e.addEventListener("change",this.networkChangeHandler)))}updateNetworkState(e){this.isMetered=e.saveData===!0||e.type==="cellular"||e.effectiveType==="slow-2g"||e.effectiveType==="2g",this.currentQuality=this.detectConnectionQuality(e)}detectConnectionQuality(e){return navigator.onLine?e&&(e.effectiveType==="2g"||e.effectiveType==="slow-2g"||e.saveData)?"slow":"good":"offline"}isMeteredConnection(){return this.isMetered}getConnectionQuality(){return this.currentQuality}onMeteredChange(e){return this.changeListeners.add(e),()=>{this.changeListeners.delete(e)}}onQualityChange(e){return this.qualityListeners.add(e),()=>{this.qualityListeners.delete(e)}}notifyListeners(){for(const e of this.changeListeners)e(this.isMetered)}notifyQualityListeners(){for(const e of this.qualityListeners)e(this.currentQuality)}registerOnlineHandlers(e,n){this.onlineHandler=()=>{const i=this.currentQuality,s=this.getConnection();this.currentQuality=this.detectConnectionQuality(s),i!==this.currentQuality&&this.notifyQualityListeners(),e()},this.offlineHandler=()=>{const i=this.currentQuality;this.currentQuality="offline",i!==this.currentQuality&&this.notifyQualityListeners(),n()},window.addEventListener("online",this.onlineHandler),window.addEventListener("offline",this.offlineHandler)}cleanup(){const e=this.getConnection();this.networkChangeHandler&&e&&(e.removeEventListener("change",this.networkChangeHandler),this.networkChangeHandler=null),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.offlineHandler&&(window.removeEventListener("offline",this.offlineHandler),this.offlineHandler=null),this.changeListeners.clear(),this.qualityListeners.clear()}}const Pe=new Lc;class Ac{constructor(){g(this,"pollInterval",null);g(this,"consecutiveErrors",0);g(this,"consecutiveNoChanges",0);g(this,"currentIdleLevel",0);g(this,"currentBatteryLevel","normal");g(this,"currentConnectionQuality","good");g(this,"isTabHidden",!1);g(this,"batteryUnsubscribe",null);g(this,"meteredUnsubscribe",null);g(this,"qualityUnsubscribe",null);g(this,"isAdjustingInterval",!1);g(this,"currentPollingIntervalMs",0);g(this,"pollCallback",null)}initialize(e){this.pollCallback=e,this.batteryUnsubscribe=W.subscribe(n=>{const i=this.currentBatteryLevel;this.currentBatteryLevel=n.batteryLevel,i!==n.batteryLevel&&this.pollInterval&&this.applyBatteryAwarePolling()}),this.meteredUnsubscribe=Pe.onMeteredChange(()=>{this.pollInterval&&this.applyBatteryAwarePolling()}),this.currentConnectionQuality=Pe.getConnectionQuality(),this.qualityUnsubscribe=Pe.onQualityChange(n=>{const i=this.currentConnectionQuality;this.currentConnectionQuality=n,i!==n&&this.pollInterval&&this.applyBatteryAwarePolling()})}start(){this.currentPollingIntervalMs=0,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.pollCallback&&this.pollCallback();const e=this.consecutiveErrors>2?Ki:Yi;this.setPollingInterval(e)}stop(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.currentPollingIntervalMs=0}isPolling(){return this.pollInterval!==null}getPollingConfig(){const e=Pe.isMeteredConnection();return this.currentConnectionQuality==="offline"?{intervals:[ns],threshold:1,baseInterval:ns}:this.isTabHidden?{intervals:[is],threshold:1,baseInterval:is}:this.currentBatteryLevel==="critical"?{intervals:Xi,threshold:es,baseInterval:Xi[0]}:this.currentConnectionQuality==="slow"?{intervals:ts,threshold:Nn,baseInterval:hc}:e?{intervals:ts,threshold:Nn,baseInterval:fc}:this.currentBatteryLevel==="low"?{intervals:Zi,threshold:es,baseInterval:Zi[0]}:{intervals:uc,threshold:Nn,baseInterval:Yi}}setPollingInterval(e){this.currentPollingIntervalMs===e&&this.pollInterval||(this.pollInterval&&clearInterval(this.pollInterval),this.currentPollingIntervalMs=e,this.pollCallback&&(this.pollInterval=setInterval(this.pollCallback,e)))}applyBatteryAwarePolling(){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{const e=this.getPollingConfig();if(!e.intervals||e.intervals.length===0){this.setPollingInterval(e.baseInterval);return}this.currentIdleLevel=Math.min(Math.max(0,this.currentIdleLevel),e.intervals.length-1);const n=this.consecutiveNoChanges<e.threshold?e.baseInterval:e.intervals[this.currentIdleLevel];this.setPollingInterval(n)}finally{this.isAdjustingInterval=!1}}}adjustPollingInterval(e,n=!1){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{if(!e){this.consecutiveErrors++,this.consecutiveErrors>2&&this.pollInterval&&this.setPollingInterval(Ki);return}this.consecutiveErrors=0;const i=this.getPollingConfig();if(!i.intervals||i.intervals.length===0){this.pollInterval&&this.setPollingInterval(i.baseInterval);return}if(n)this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval&&this.setPollingInterval(i.baseInterval);else if(this.consecutiveNoChanges++,this.consecutiveNoChanges>=i.threshold){const s=Math.min(Math.max(0,this.currentIdleLevel+1),i.intervals.length-1);s!==this.currentIdleLevel&&(this.currentIdleLevel=s,this.pollInterval&&this.setPollingInterval(i.intervals[this.currentIdleLevel]))}}finally{this.isAdjustingInterval=!1}}}resetToFastPolling(){if(this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval){const e=this.getPollingConfig();this.setPollingInterval(e.baseInterval)}}setTabHidden(e){this.isTabHidden!==e&&(this.isTabHidden=e,this.pollInterval&&(e?this.applyBatteryAwarePolling():(this.pollCallback&&this.pollCallback(),this.applyBatteryAwarePolling())))}cleanup(){this.stop(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.meteredUnsubscribe&&(this.meteredUnsubscribe(),this.meteredUnsubscribe=null),this.qualityUnsubscribe&&(this.qualityUnsubscribe(),this.qualityUnsubscribe=null),this.pollCallback=null,this.consecutiveErrors=0,this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.isTabHidden=!1,this.currentConnectionQuality="good"}}const de=new Ac;class Rc{constructor(){g(this,"queueInterval",null);g(this,"isProcessingQueue",!1);g(this,"sendEntryCallback",null)}initialize(e){this.sendEntryCallback=e}start(){this.queueInterval&&clearInterval(this.queueInterval),this.queueInterval=setInterval(()=>this.processQueue(),dc)}stop(){this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null)}isProcessing(){return this.queueInterval!==null}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{const e=l.getState();if(!e.settings.sync||!e.raceId||e.syncQueue.length===0)return;if(!this.sendEntryCallback){y.warn("Queue processor: No send callback configured");return}const n=Date.now();for(const i of e.syncQueue){if(i.retryCount>=cc){y.warn("Max retries exceeded for entry:",i.entry.id),l.removeFromSyncQueue(i.entry.id);continue}const s=lc*2**i.retryCount;if(n-i.lastAttempt<s)continue;await this.sendEntryCallback(i.entry)||l.updateSyncQueueItem(i.entry.id,{retryCount:i.retryCount+1,lastAttempt:n,error:"Failed to sync"})}}finally{this.isProcessingQueue=!1}}}getQueueLength(){return l.getState().syncQueue.length}cleanup(){this.stop(),this.sendEntryCallback=null}}const Ae=new Rc;class Dc{constructor(){g(this,"visibilityHandler",null);g(this,"wasQueueProcessingBeforeHidden",!1)}initialize(){const e=l.getState();if(!e.settings.sync||!e.raceId){this.cleanup();return}this.initializeModules(),qe.initialize(e.raceId),Pe.initialize(),de.start(),Ae.start();try{vc()}catch(n){y.error("Failed to push local entries during sync init:",n)}try{Cc()}catch(n){y.error("Failed to push local faults during sync init:",n)}this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(de.setTabHidden(!0),this.wasQueueProcessingBeforeHidden=Ae.isProcessing(),Ae.stop()):(de.setTabHidden(!1),this.wasQueueProcessingBeforeHidden&&Ae.start())},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.visibilityHandler()),W.initialize(),Pe.registerOnlineHandlers(()=>{l.getState().syncStatus==="offline"&&(l.setSyncStatus("connecting"),de.start())},()=>{l.setSyncStatus("offline")}),navigator.onLine?l.setSyncStatus("connecting"):l.setSyncStatus("offline")}initializeModules(){de.initialize(()=>{ss()}),Ae.initialize(ni),gc({onPollingAdjust:(e,n)=>{de.adjustPollingInterval(e,n)},onResetFastPolling:()=>{de.resetToFastPolling()},onCleanup:()=>this.cleanup(),showToast:(e,n,i)=>this.showSyncToast(e,n,i),fetchFaults:()=>Ic()}),Sc({onResetFastPolling:()=>{de.resetToFastPolling()},showToast:(e,n,i)=>this.showSyncToast(e,n,i)})}showSyncToast(e,n="success",i){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:e,type:n,duration:i}}))}cleanup(){de.cleanup(),Ae.cleanup(),qe.cleanup(),Pe.cleanup(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasQueueProcessingBeforeHidden=!1,bc(),Tc(),l.setSyncStatus("disconnected")}async forceRefresh(){await ss()}getQueueLength(){return Ae.getQueueLength()}getLastSyncTime(){return mc()}broadcastEntry(e){qe.broadcastEntry(e)}broadcastPresence(){qe.broadcastPresence()}resetToFastPolling(){de.resetToFastPolling()}sendEntryToCloud(e){return ni(e)}deleteEntryFromCloud(e,n){return yc(e,n)}sendFaultToCloud(e){return _s(e)}async deleteFaultFromCloud(e,n,i){return kc(e,n,i)}getOtherGateAssignments(){return wc()}async checkRaceExists(e){if(!e)return{exists:!1,entryCount:0};try{const n=await ae(`${pt}?raceId=${encodeURIComponent(e)}&checkOnly=true`,{headers:le()},5e3);if(!n.ok)return{exists:!1,entryCount:0};const i=await n.json();return{exists:i.exists===!0,entryCount:typeof i.entryCount=="number"?i.entryCount:0}}catch(n){return y.error("Check race exists error:",n),{exists:!1,entryCount:0}}}async getPhotoSyncStats(){const e=l.getState();let n=0,i=0,s=0,r=0;for(const a of e.entries)if(a.photo==="indexeddb"&&a.deviceId===e.deviceId){const o=await Q.getPhoto(a.id);o&&(n++,i+=o.length)}if(e.settings.sync&&e.raceId)try{const a=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),o=await ae(`${pt}?${a}`,{headers:le()},Oe);if(o.ok){const c=await o.json(),u=Array.isArray(c.entries)?c.entries:[];for(const d of u)if(d.photo&&d.photo!=="indexeddb"&&d.photo.length>20&&d.deviceId!==e.deviceId){const h=e.entries.find(m=>m.id===d.id&&m.deviceId===d.deviceId);(!h||!h.photo)&&(s++,r+=d.photo.length)}}}catch(a){y.warn("Failed to fetch cloud entries for photo stats:",a)}return{uploadCount:n,uploadSize:i,downloadCount:s,downloadSize:r,totalSize:i+r}}}const $=new Dc;async function xc(t){const e=l.getState();$.broadcastEntry(t),e.settings.sync&&e.raceId&&(await $.sendEntryToCloud(t)||l.addToSyncQueue(t))}async function at(t){const e=l.getState();qe.broadcastFault(t),e.settings.sync&&e.raceId&&await $.sendFaultToCloud(t)}async function Ei(t){const e=l.getState();return qe.broadcastFaultDeletion(t.id),e.settings.sync&&e.raceId?$.deleteFaultFromCloud(t.id,t.deviceId,t.markedForDeletionBy):!0}class Bc{constructor(){g(this,"recognition",null);g(this,"llmConfig",null);g(this,"isEnabled",!1);g(this,"isPaused",!1);g(this,"isOnline",typeof navigator<"u"?navigator.onLine:!0);g(this,"pendingIntent",null);g(this,"status","inactive");g(this,"confirmationTimeout",null);g(this,"restartTimeout",null);g(this,"stateCallbacks",new Set);g(this,"actionCallbacks",new Set);g(this,"CONFIRMATION_TIMEOUT_MS",1e4);g(this,"LLM_TIMEOUT_MS",5e3);g(this,"RESTART_DELAY_MS",100);g(this,"handleOnline",()=>{var e;if(this.isOnline=!0,this.isEnabled){this.setStatus("listening");try{(e=this.recognition)==null||e.start()}catch{}}});g(this,"handleOffline",()=>{var e;this.isOnline=!1,this.isEnabled&&(this.setStatus("offline"),(e=this.recognition)==null||e.stop())})}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(e){if(!this.isSupported())return y.warn("[Voice] Speech Recognition not supported"),!1;if(!be.isSupported())return y.warn("[Voice] Speech Synthesis not supported"),!1;this.llmConfig=e;const n=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new n,this.recognition.continuous=!0,this.recognition.interimResults=!1,this.updateRecognitionLanguage(),this.setupRecognitionHandlers(),window.addEventListener("online",this.handleOnline),window.addEventListener("offline",this.handleOffline),y.debug("[Voice] Initialized successfully"),!0}updateRecognitionLanguage(){if(!this.recognition)return;const e=l.getState().currentLang;this.recognition.lang=e==="de"?"de-DE":"en-US",be.setLanguage(e)}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{y.debug("[Voice] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{const n=e.results[e.resultIndex];if(n.isFinal){const i=n[0].transcript.trim();y.debug("[Voice] Transcript:",i),this.processTranscript(i)}},this.recognition.onerror=e=>{switch(y.warn("[Voice] Recognition error:",e.error),e.error){case"network":this.setStatus("offline");break;case"not-allowed":case"service-not-allowed":this.setStatus("error"),this.disable();break;case"no-speech":case"audio-capture":break;case"aborted":return;default:this.setStatus("error")}},this.recognition.onend=()=>{y.debug("[Voice] Recognition ended"),this.isEnabled&&this.isOnline&&!this.isPaused&&this.status!=="error"&&this.scheduleRestart()})}scheduleRestart(){this.restartTimeout&&clearTimeout(this.restartTimeout),this.restartTimeout=setTimeout(()=>{var e;if(this.isEnabled&&this.isOnline&&!this.isPaused)try{(e=this.recognition)==null||e.start()}catch{}},this.RESTART_DELAY_MS)}async processTranscript(e){if(!e||!this.llmConfig)return;this.setStatus("processing");const n=l.getState(),i={role:n.deviceRole,language:n.currentLang,currentRun:n.selectedRun,activeBibs:n.deviceRole==="gateJudge"?this.getActiveBibs(n.selectedRun):void 0,gateRange:n.gateAssignment||void 0,pendingConfirmation:this.pendingIntent||void 0};try{const s=await zo(e,i,this.llmConfig,this.LLM_TIMEOUT_MS);await this.handleIntent(s)}catch(s){y.error("[Voice] Processing error:",s),this.setStatus("error"),await be.sayNotUnderstood(),this.setStatus("listening")}}getActiveBibs(e){const n=l.getState(),i=new Set,s=new Set;for(const r of n.entries)r.run===e&&(r.point==="S"?i.add(r.bib):r.point==="F"&&s.add(r.bib));return Array.from(i).filter(r=>!s.has(r))}async handleIntent(e){if(this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.pendingIntent&&(e.action==="confirm"||e.action==="cancel")){if(e.action==="confirm")this.executeIntent(this.pendingIntent),await be.sayRecorded();else{const n=l.getState().currentLang;await be.speak(n==="de"?"Abgebrochen":"Cancelled")}this.pendingIntent=null,this.setStatus("listening");return}if(e.action==="unknown"||e.confidence<.5){await be.sayNotUnderstood(),this.setStatus("listening");return}if(e.confirmationNeeded&&e.confirmationPrompt){this.pendingIntent=e,this.setStatus("confirming"),await be.speak(e.confirmationPrompt),this.confirmationTimeout=setTimeout(()=>{this.pendingIntent&&(y.debug("[Voice] Confirmation timeout"),this.pendingIntent=null,this.setStatus("listening"))},this.CONFIRMATION_TIMEOUT_MS);return}this.executeIntent(e),this.setStatus("listening")}executeIntent(e){y.debug("[Voice] Executing intent:",e.action);for(const n of this.actionCallbacks)n(e)}setStatus(e){if(this.status!==e){this.status=e;for(const n of this.stateCallbacks)n(e)}}enable(){if(!this.recognition||!this.llmConfig)return y.warn("[Voice] Not initialized"),!1;if(!this.isOnline)return this.setStatus("offline"),!1;this.isEnabled=!0,this.updateRecognitionLanguage();try{return this.recognition.start(),!0}catch(e){return y.warn("[Voice] Failed to start recognition:",e),this.setStatus("error"),!1}}disable(){var e;this.isEnabled=!1,this.isPaused=!1,this.pendingIntent=null,this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.stop()}catch{}be.cancel(),this.setStatus("inactive")}pause(){var e;if(!(!this.isEnabled||this.isPaused)){this.isPaused=!0,this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.abort()}catch{}y.debug("[Voice] Paused")}}resume(){!this.isEnabled||!this.isPaused||(this.isPaused=!1,this.isOnline&&this.status!=="error"&&this.scheduleRestart(),y.debug("[Voice] Resumed"))}getStatus(){return this.status}isActive(){return this.isEnabled}onStatusChange(e){return this.stateCallbacks.add(e),()=>this.stateCallbacks.delete(e)}onAction(e){return this.actionCallbacks.add(e),()=>this.actionCallbacks.delete(e)}isPausedState(){return this.isPaused}cleanup(){this.disable(),this.stateCallbacks.clear(),this.actionCallbacks.clear(),window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),this.recognition=null,this.llmConfig=null}}const H=new Bc;class Pc{constructor(){g(this,"recognition",null);g(this,"status","idle");g(this,"isDestroyed",!1);g(this,"statusCallbacks",new Set);g(this,"transcriptCallbacks",new Set);g(this,"MAX_DURATION_MS",3e4);g(this,"recordingTimeout",null)}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(){if(this.recognition)return!0;if(!this.isSupported())return y.warn("[VoiceNote] Speech Recognition not supported"),this.setStatus("unsupported"),!1;const e=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new e,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.setupRecognitionHandlers(),this.updateLanguage(),y.debug("[VoiceNote] Initialized successfully"),!0}updateLanguage(){if(!this.recognition)return;const e=l.getState().currentLang;this.recognition.lang=e==="de"?"de-DE":"en-US"}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{y.debug("[VoiceNote] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{let n="",i="";for(let s=e.resultIndex;s<e.results.length;s++){const r=e.results[s];r.isFinal?i+=r[0].transcript:n+=r[0].transcript}n&&this.notifyTranscript(n,!1),i&&this.notifyTranscript(i,!0)},this.recognition.onerror=e=>{switch(y.warn("[VoiceNote] Recognition error:",e.error),e.error){case"not-allowed":case"service-not-allowed":this.setStatus("error");break;case"no-speech":case"audio-capture":this.setStatus("idle");break;case"aborted":this.setStatus("idle");break;default:this.setStatus("error")}this.clearRecordingTimeout()},this.recognition.onend=()=>{y.debug("[VoiceNote] Recognition ended"),this.clearRecordingTimeout(),this.status==="listening"&&this.setStatus("idle")})}start(){var e;if(this.isDestroyed||!this.initialize())return!1;this.updateLanguage();try{return(e=this.recognition)==null||e.start(),this.recordingTimeout=setTimeout(()=>{y.debug("[VoiceNote] Max duration reached, stopping"),this.stop()},this.MAX_DURATION_MS),!0}catch(n){return y.warn("[VoiceNote] Failed to start:",n),this.setStatus("error"),!1}}stop(){var e;this.clearRecordingTimeout();try{(e=this.recognition)==null||e.stop()}catch{}this.setStatus("idle")}abort(){var e;this.clearRecordingTimeout();try{(e=this.recognition)==null||e.abort()}catch{}this.setStatus("idle")}clearRecordingTimeout(){this.recordingTimeout&&(clearTimeout(this.recordingTimeout),this.recordingTimeout=null)}setStatus(e){if(this.status!==e){this.status=e;for(const n of this.statusCallbacks)try{n(e)}catch(i){y.error("[VoiceNote] Status callback error:",i)}}}notifyTranscript(e,n){for(const i of this.transcriptCallbacks)try{i(e,n)}catch(s){y.error("[VoiceNote] Transcript callback error:",s)}}getStatus(){return this.status}isRecording(){return this.status==="listening"}onStatusChange(e){return this.statusCallbacks.add(e),()=>this.statusCallbacks.delete(e)}onTranscript(e){return this.transcriptCallbacks.add(e),()=>this.transcriptCallbacks.delete(e)}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.abort(),this.statusCallbacks.clear(),this.transcriptCallbacks.clear(),this.recognition=null)}}const j=new Pc,Nc=30*60*1e3,Fc=60*1e3;class $c{constructor(){g(this,"wakeLock",null);g(this,"isEnabled",!1);g(this,"visibilityHandler",null);g(this,"lastInteraction",Date.now());g(this,"idleCheckInterval",null);g(this,"interactionHandler",null)}isSupported(){return"wakeLock"in navigator}async enable(){return this.isSupported()?this.isEnabled?!0:(this.isEnabled=!0,this.lastInteraction=Date.now(),this.visibilityHandler||(this.visibilityHandler=()=>{!document.hidden&&this.isEnabled&&!this.wakeLock&&this.requestWakeLock()},document.addEventListener("visibilitychange",this.visibilityHandler)),this.startIdleTracking(),this.requestWakeLock()):!1}async disable(){this.isEnabled=!1,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.stopIdleTracking(),await this.releaseWakeLock()}resetIdleTimer(){this.lastInteraction=Date.now(),this.isEnabled&&!this.wakeLock&&this.requestWakeLock()}startIdleTracking(){this.interactionHandler||(this.interactionHandler=()=>this.resetIdleTimer(),document.addEventListener("touchstart",this.interactionHandler,{passive:!0}),document.addEventListener("mousedown",this.interactionHandler),document.addEventListener("keydown",this.interactionHandler)),this.idleCheckInterval===null&&(this.idleCheckInterval=setInterval(()=>this.checkIdle(),Fc))}stopIdleTracking(){this.interactionHandler&&(document.removeEventListener("touchstart",this.interactionHandler),document.removeEventListener("mousedown",this.interactionHandler),document.removeEventListener("keydown",this.interactionHandler),this.interactionHandler=null),this.idleCheckInterval!==null&&(clearInterval(this.idleCheckInterval),this.idleCheckInterval=null)}checkIdle(){if(!this.isEnabled)return;if(Date.now()-this.lastInteraction>=Nc&&this.wakeLock){y.debug("[WakeLock] Idle timeout reached, releasing wake lock"),this.releaseWakeLock();const n=l.getState().currentLang;w(f("wakeLockIdleTimeout",n),"warning",5e3)}}async requestWakeLock(){if(!this.isSupported()||this.wakeLock)return!!this.wakeLock;try{return this.wakeLock=await navigator.wakeLock.request("screen"),this.wakeLock.addEventListener("release",()=>{this.wakeLock=null}),!0}catch(e){const n=e instanceof Error?e.message:"Unknown error";y.warn("Wake Lock request failed:",n),this.wakeLock=null;const i=l.getState().currentLang;return w(f("wakeLockFailed",i),"warning",2e3),!1}}async releaseWakeLock(){if(this.wakeLock){try{await this.wakeLock.release()}catch(e){y.warn("Wake Lock release error:",e)}this.wakeLock=null}}isActive(){return this.wakeLock!==null}isWakeLockEnabled(){return this.isEnabled}}const ln=new $c,Fn=new Map;function b(t){return Fn.has(t)||Fn.set(t,document.getElementById(t)),Fn.get(t)}function wi(t=18){return`<svg aria-hidden="true" width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`}function Mc(t=14){return`<svg aria-hidden="true" width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="9" y1="11" x2="9" y2="17"/><line x1="15" y1="11" x2="15" y2="17"/></svg>`}function Hs(t=18){return`<svg aria-hidden="true" width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`}function yt(t=16,e=2.5){return`<svg aria-hidden="true" width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${e}"><path d="M20 6L9 17l-5-5"/></svg>`}function Oc(t=16,e=2){return`<svg aria-hidden="true" width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${e}"><path d="M18 6L6 18M6 6l12 12"/></svg>`}function Vc(t=16,e=!1){return`<svg class="group-chevron" width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true" style="flex-shrink: 0; transition: transform 0.2s; ${e?"transform: rotate(90deg);":""}"><path d="M9 18l6-6-6-6"/></svg>`}function _c(t=12){return`<svg width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>`}function Hc(t=18){return`<svg width="${t}" height="${t}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>`}function zs(t=12){return`<svg width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 9v4M12 17h.01"/><circle cx="12" cy="12" r="10"/></svg>`}function Us(t=14){return`<svg aria-hidden="true" width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`}function zc(t=16){return`<svg aria-hidden="true" width="${t}" height="${t}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2v6l4 4-4 4v6h12v-6l-4-4 4-4V2H6z"/></svg>`}function Nt(t){return`<button class="${t.className||"result-edit-btn"}" aria-label="${L(t.ariaLabel)}" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; opacity: 0.7;">${Hs(t.size||18)}</button>`}function Ft(t){return`<button class="${t.className||"result-delete"}" aria-label="${L(t.ariaLabel)}" style="background: none; border: none; color: var(--error); padding: 6px; cursor: pointer; opacity: 0.7;">${wi(t.size||18)}</button>`}function Uc(t){return`<button class="result-photo-btn" aria-label="${L(t)}" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">${Hc()}</button>`}function rs(t){return`<span class="result-duplicate-badge" title="${L(f("multiDeviceDuplicate",t))}" aria-label="${L(f("multiDeviceDuplicate",t))}">${_c()} ${T(f("multiDeviceDuplicate",t))}</span>`}function as(t){var r;const{faults:e,lang:n}=t;if(e.length===0)return"";const i=e.map(a=>`T${a.gateNumber} (${ve(a.faultType,n)})`).join(", "),s=e.length>1?`${e.length}× ${f("flt",n)}`:`T${((r=e[0])==null?void 0:r.gateNumber)||"?"}`;return`<span class="result-fault-badge" title="${L(i)}" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">${T(s)}</span>`}function $n(t,e="var(--error)",n="white",i="0.7rem"){return`<span class="result-status" style="padding: 2px 6px; border-radius: var(--radius); font-size: ${i}; font-weight: 600; background: ${e}; color: ${n};">${T(t)}</span>`}function os(t="0.7rem"){return`<span class="deletion-pending-status" style="display: flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: var(--radius); font-size: ${t}; font-weight: 600; background: var(--error); color: white;">${zs()} DEL</span>`}function Mn(t,e){return`<span class="result-run" data-advanced style="padding: 4px 6px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; min-width: 36px; text-align: center; background: ${e}20; color: ${e};">${T(t)}</span>`}function $t(t,e,n="48px",i="0.75rem"){return`<div class="result-point" style="padding: 4px 6px; border-radius: var(--radius); font-size: ${i}; font-weight: 600; min-width: ${n}; text-align: center; background: ${e}20; color: ${e};">${T(t)}</div>`}const cs=0,Gc=1,qc=3;class Jc{constructor(e){g(this,"container");g(this,"timeElement");g(this,"dateElement");g(this,"dateRow");g(this,"lastTimeStr","");g(this,"animationId",null);g(this,"isRunning",!1);g(this,"visibilityHandler",null);g(this,"frameSkipCount",cs);g(this,"currentFrame",0);g(this,"batteryUnsubscribe",null);g(this,"isDestroyed",!1);g(this,"cachedDigits",[]);g(this,"tick",()=>{if(this.isRunning)try{if(this.currentFrame++,this.frameSkipCount===0||this.currentFrame%(this.frameSkipCount+1)===0){const n=new Date,i=ke(n);if(i!==this.lastTimeStr&&(this.updateDigits(i),this.lastTimeStr=i),n.getSeconds()===0||!this.dateElement.textContent){const r=l.getState();this.dateElement.textContent=rc(n,r.currentLang)}}this.animationId=requestAnimationFrame(this.tick)}catch(e){if(y.error("Clock tick error:",e),this.animationId===null)try{this.animationId=requestAnimationFrame(this.tick)}catch(n){y.error("Clock RAF scheduling failed:",n),setTimeout(()=>{this.isRunning&&this.animationId===null&&this.tick()},16)}}});this.container=e,this.container.innerHTML="",this.timeElement=this.createTimeElement(),this.dateRow=this.createDateRow(),this.dateElement=this.dateRow.querySelector(".clock-date"),this.container.appendChild(this.timeElement),this.container.appendChild(this.dateRow),this.cachedDigits=Array.from(this.timeElement.querySelectorAll(".clock-digit")),this.moveTimingPointsToDateRow()}moveTimingPointsToDateRow(){const e=document.querySelector(".timing-controls");e&&this.dateRow&&this.dateRow.appendChild(e)}createTimeElement(){const e=document.createElement("div");e.className="clock-time",e.setAttribute("role","timer"),e.setAttribute("aria-live","polite");const n=l.getState().currentLang;e.setAttribute("aria-label",f("currentTime",n)),e.style.cssText=`
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(32px, 10vw, 48px);
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      text-shadow: 0 0 40px rgba(56, 189, 248, 0.3);
    `;for(let i=0;i<12;i++){const s=document.createElement("span");s.className="clock-digit",s.dataset.index=String(i),e.appendChild(s)}return e}createDateRow(){const e=document.createElement("div");e.className="clock-date-row",e.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      padding: 0 8px;
      width: 100%;
    `;const n=document.createElement("div");return n.className="clock-date",n.style.cssText=`
      font-size: 0.875rem;
      color: var(--text-secondary);
    `,e.appendChild(n),e}start(){this.isRunning||(this.isRunning=!0,this.tick(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null):this.isRunning&&this.animationId===null&&this.tick()},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)),this.batteryUnsubscribe||W.initialize().then(()=>{this.batteryUnsubscribe=W.subscribe(e=>{this.updateFrameSkipFromBattery(e.batteryLevel)})}).catch(e=>y.debug("Battery API unavailable:",e)))}updateFrameSkipFromBattery(e){switch(e){case"critical":this.frameSkipCount=qc;break;case"low":this.frameSkipCount=Gc;break;default:this.frameSkipCount=cs}}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null)}updateDigits(e){for(let n=0;n<e.length&&n<this.cachedDigits.length;n++){const i=this.cachedDigits[n],s=e[n];i.textContent!==s&&(i.textContent=s,i.style.transform="scale(1.02)",requestAnimationFrame(()=>{i.style.transform="scale(1)"}))}}getCurrentTime(){return this.lastTimeStr}getTimestamp(){const e=me.getTimestamp();return e?new Date(e):new Date}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.stop(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.container.innerHTML="")}}class O{constructor(){g(this,"listeners",[])}add(e,n,i,s){e.addEventListener(n,i,s),this.listeners.push([e,n,i,s])}removeAll(){for(const[e,n,i,s]of this.listeners)e.removeEventListener(n,i,s);this.listeners=[]}get count(){return this.listeners.length}}const Mt=80,ls=2.5;class jc{constructor(e){g(this,"container");g(this,"indicator");g(this,"styleElement",null);g(this,"onRefresh");g(this,"startY",0);g(this,"currentY",0);g(this,"isPulling",!1);g(this,"isRefreshing",!1);g(this,"scrollableParent",null);g(this,"listeners",new O);g(this,"onTouchStart",e=>{var i;this.isRefreshing||(((i=this.scrollableParent)==null?void 0:i.scrollTop)??0)>0||(this.startY=e.touches[0].clientY,this.isPulling=!0)});g(this,"onTouchMove",e=>{var n;if(!(!this.isPulling||this.isRefreshing))try{if((((n=this.scrollableParent)==null?void 0:n.scrollTop)??0)>0){this.isPulling=!1;return}this.currentY=e.touches[0].clientY;const s=(this.currentY-this.startY)/ls;s>0&&(e.preventDefault(),this.updateIndicator(s))}catch(i){y.error("PullToRefresh move error:",i),this.isPulling=!1,this.resetIndicator()}});g(this,"onTouchEnd",async()=>{if(!this.isPulling||this.isRefreshing)return;const e=(this.currentY-this.startY)/ls;this.isPulling=!1,e>=Mt?(this.isRefreshing=!0,await this.triggerRefresh()):this.resetIndicator()});this.container=e.container,this.onRefresh=e.onRefresh,this.indicator=this.createIndicator(),this.container.insertBefore(this.indicator,this.container.firstChild),this.scrollableParent=e.scrollElement??this.findScrollableParent(this.container)??this.findScrollableChild(this.container),this.bindEvents()}createIndicator(){const e=document.createElement("div");e.className="pull-indicator",e.style.cssText=`
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: transform 0.2s;
      pointer-events: none;
      z-index: 100;
    `;const n=l.getState().currentLang;return e.innerHTML=`
      <div class="pull-indicator-content" style="display: flex; align-items: center; gap: 8px;">
        <svg class="pull-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
        <span class="pull-text">${f("pullToRefresh",n)}</span>
      </div>
      <div class="pull-spinner" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      </div>
    `,this.styleElement=document.createElement("style"),this.styleElement.textContent=`
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(this.styleElement),e}findScrollableParent(e){let n=e.parentElement;for(;n;){const i=getComputedStyle(n);if(i.overflowY==="auto"||i.overflowY==="scroll")return n;n=n.parentElement}return null}findScrollableChild(e){const n=e.querySelectorAll("*");for(const i of n)if(i instanceof HTMLElement){const s=getComputedStyle(i);if(s.overflowY==="auto"||s.overflowY==="scroll")return i}return null}bindEvents(){this.listeners.add(this.container,"touchstart",this.onTouchStart,{passive:!0}),this.listeners.add(this.container,"touchmove",this.onTouchMove,{passive:!1}),this.listeners.add(this.container,"touchend",this.onTouchEnd,{passive:!0})}updateIndicator(e){const n=Math.min(e,Mt*1.5);this.indicator.style.transform=`translateY(${n}px)`;const i=Math.min(e/Mt,1),s=this.indicator.querySelector(".pull-icon"),r=this.indicator.querySelector(".pull-text");if(s&&(s.style.transform=`rotate(${i*180}deg)`),r){const a=l.getState().currentLang;r.textContent=i>=1?f("releaseToRefresh",a):f("pullToRefresh",a)}}async triggerRefresh(){const e=this.indicator.querySelector(".pull-indicator-content"),n=this.indicator.querySelector(".pull-spinner");e&&(e.style.display="none"),n&&(n.style.display="flex"),this.indicator.style.transform=`translateY(${Mt}px)`;try{await this.onRefresh()}catch(i){y.error("PullToRefresh callback error:",i)}finally{this.isRefreshing=!1,e&&(e.style.display="flex"),n&&(n.style.display="none"),this.resetIndicator()}}resetIndicator(){this.indicator.style.transform="translateY(0)";const e=this.indicator.querySelector(".pull-icon");e&&(e.style.transform="rotate(0deg)")}destroy(){this.isRefreshing=!1,this.isPulling=!1,this.listeners.removeAll(),this.indicator.remove(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}}class Wc{constructor(e,n={}){g(this,"container");g(this,"dialNumbers",null);g(this,"dialRing",null);g(this,"options");g(this,"rotation",0);g(this,"velocity",0);g(this,"isDragging",!1);g(this,"lastAngle",0);g(this,"lastDragTime",0);g(this,"accumulatedRotation",0);g(this,"spinAnimationId",null);g(this,"snapBackAnimationId",null);g(this,"snapBackTimeoutId",null);g(this,"resizeObserver",null);g(this,"lastContainerWidth",0);g(this,"visualTimeoutIds",new Set);g(this,"dragStartPos",null);g(this,"hasDraggedSignificantly",!1);g(this,"lastTouchTime",0);g(this,"numberKeydownListeners",new Map);g(this,"cachedNumberSpans",[]);g(this,"cachedNumberElements",new Map);g(this,"isDestroyed",!1);g(this,"visibilityHandler",null);g(this,"bibValue","");g(this,"handleDragStart",e=>{var u,d;const n="touches"in e;if(!n&&Date.now()-this.lastTouchTime<500)return;n&&(this.lastTouchTime=Date.now());const i=this.container.getBoundingClientRect(),s=n?e.touches[0].clientX:e.clientX,r=n?e.touches[0].clientY:e.clientY,a=i.left+i.width/2,o=i.top+i.height/2,c=Math.sqrt((s-a)**2+(r-o)**2);c<i.width*.27||c>i.width*.5||(this.snapBackTimeoutId&&(clearTimeout(this.snapBackTimeoutId),this.snapBackTimeoutId=null),this.snapBackAnimationId&&(cancelAnimationFrame(this.snapBackAnimationId),this.snapBackAnimationId=null),this.dragStartPos={x:s,y:r},this.hasDraggedSignificantly=!1,this.isDragging=!0,this.velocity=0,this.spinAnimationId&&(cancelAnimationFrame(this.spinAnimationId),this.spinAnimationId=null),this.lastAngle=this.getAngle(s,r,i),this.lastDragTime=Date.now(),this.accumulatedRotation=0,(u=this.dialNumbers)==null||u.classList.remove("momentum"),(d=this.dialNumbers)==null||d.classList.add("momentum"))});g(this,"handleDragMove",e=>{if(!this.isDragging)return;const n="touches"in e?e.touches[0].clientX:e.clientX,i="touches"in e?e.touches[0].clientY:e.clientY;if(this.dragStartPos&&!this.hasDraggedSignificantly)if(Math.sqrt((n-this.dragStartPos.x)**2+(i-this.dragStartPos.y)**2)>10)this.hasDraggedSignificantly=!0;else return;e.preventDefault();const s=this.container.getBoundingClientRect(),r=this.getAngle(n,i,s);let a=r-this.lastAngle;a>180&&(a-=360),a<-180&&(a+=360);const o=Date.now(),c=Math.max(o-this.lastDragTime,1);if(this.velocity=a/c*16*this.options.momentum,this.rotation+=a,this.accumulatedRotation+=a,this.updateDialRotation(),Math.abs(this.accumulatedRotation)>=this.options.sensitivity){const u=this.accumulatedRotation>0?1:-1;this.adjustBib(u),this.accumulatedRotation=this.accumulatedRotation%this.options.sensitivity}this.lastAngle=r,this.lastDragTime=o});g(this,"handleDragEnd",()=>{var e,n,i;if(this.isDragging){if(this.isDragging=!1,!this.hasDraggedSignificantly&&this.dragStartPos){const s=this.container.getBoundingClientRect(),r=s.left+s.width/2,a=s.top+s.height/2;let o=Math.atan2(this.dragStartPos.y-a,this.dragStartPos.x-r)*(180/Math.PI);o-=this.rotation,o=(o%360+360)%360;const c=[1,2,3,4,5,6,7,8,9,0];let u=0,d=360;if(c.forEach((h,m)=>{const p=(m*36-90+360)%360;let v=Math.abs(o-p);v>180&&(v=360-v),v<d&&v<20&&(d=v,u=h)}),d<20){const h=(e=this.dialNumbers)==null?void 0:e.querySelector(`[data-num="${u}"]`);h&&this.handleNumberTap(u,h)}this.dragStartPos=null,(n=this.dialNumbers)==null||n.classList.remove("momentum");return}this.dragStartPos=null,Math.abs(this.velocity)>.5?this.spinWithMomentum():((i=this.dialNumbers)==null||i.classList.remove("momentum"),this.scheduleSnapBack())}});g(this,"spinWithMomentum",()=>{var e;if(Math.abs(this.velocity)<.2){this.velocity=0,(e=this.dialNumbers)==null||e.classList.remove("momentum"),this.scheduleSnapBack();return}if(this.rotation+=this.velocity,this.accumulatedRotation+=this.velocity,this.updateDialRotation(),Math.abs(this.accumulatedRotation)>=this.options.sensitivity){const n=this.accumulatedRotation>0?1:-1;this.adjustBib(n),this.accumulatedRotation=this.accumulatedRotation%this.options.sensitivity}this.velocity*=this.options.friction,this.spinAnimationId=requestAnimationFrame(this.spinWithMomentum)});g(this,"snapBack",()=>{var n;if(Math.abs(this.rotation)<1){this.rotation=0,this.updateDialRotation(),this.snapBackAnimationId=null,(n=this.dialNumbers)==null||n.classList.remove("momentum");return}this.rotation*=1-.15,this.updateDialRotation(),this.snapBackAnimationId=requestAnimationFrame(this.snapBack)});this.container=e,this.options={onChange:n.onChange||(()=>{}),momentum:n.momentum??1.5,friction:n.friction??.97,sensitivity:n.sensitivity??24},this.init()}init(){if(this.dialNumbers=this.container.querySelector(".dial-numbers"),this.dialRing=this.container.querySelector(".dial-ring"),!this.dialNumbers){y.warn("[RadialDial] Required elements not found");return}this.generateDialNumbers(),this.generateTicks(),this.bindEvents()}generateDialNumbers(){if(!this.dialNumbers)return;this.dialNumbers.innerHTML="",this.cachedNumberSpans=[],this.cachedNumberElements.clear();const e=[1,2,3,4,5,6,7,8,9,0],n=this.container.offsetWidth||460,i=n*.38,s=n/2;e.forEach((r,a)=>{const o=(a*36-90)*(Math.PI/180),c=s+i*Math.cos(o),u=s+i*Math.sin(o),d=document.createElement("div");d.className="dial-number",d.dataset.num=String(r),d.innerHTML=`<span>${r}</span>`,d.style.left=`${c}px`,d.style.top=`${u}px`,d.style.transform="translate(-50%, -50%)";const h=l.getState().currentLang;d.setAttribute("tabindex","0"),d.setAttribute("role","button"),d.setAttribute("aria-label",`${f("numberLabel",h)} ${r}`);const m=v=>{const S=v;(S.key==="Enter"||S.key===" ")&&(S.preventDefault(),this.handleNumberTap(r,d))};d.addEventListener("keydown",m),this.numberKeydownListeners.set(d,m),this.dialNumbers.appendChild(d);const p=d.querySelector("span");p&&this.cachedNumberSpans.push(p),this.cachedNumberElements.set(String(r),d)})}generateTicks(){const e=this.container.querySelector(".dial-ticks");if(e){e.innerHTML="";for(let n=0;n<60;n++){const i=document.createElement("div");i.className=`dial-tick${n%6===0?" major":""}`,i.style.transform=`rotate(${n*6}deg)`,e.appendChild(i)}}}handleNumberTap(e,n){if(this.bibValue.length<3){this.bibValue+=String(e),this.options.onChange(this.bibValue),Ro(),n.classList.add("pressed");const i=window.setTimeout(()=>{n.classList.remove("pressed"),this.visualTimeoutIds.delete(i)},150);this.visualTimeoutIds.add(i)}}bindEvents(){this.container.addEventListener("mousedown",this.handleDragStart),window.addEventListener("mousemove",this.handleDragMove),window.addEventListener("mouseup",this.handleDragEnd),this.container.addEventListener("touchstart",this.handleDragStart,{passive:!1}),window.addEventListener("touchmove",this.handleDragMove,{passive:!1}),window.addEventListener("touchend",this.handleDragEnd),this.visibilityHandler=()=>{document.hidden&&(this.spinAnimationId&&(cancelAnimationFrame(this.spinAnimationId),this.spinAnimationId=null),this.snapBackAnimationId&&(cancelAnimationFrame(this.snapBackAnimationId),this.snapBackAnimationId=null))},document.addEventListener("visibilitychange",this.visibilityHandler),this.lastContainerWidth=this.container.offsetWidth,this.resizeObserver=new ResizeObserver(e=>{const n=e[0];if(!n)return;const i=Math.round(n.contentRect.width);i>0&&i!==this.lastContainerWidth&&(this.lastContainerWidth=i,this.generateDialNumbers())}),this.resizeObserver.observe(this.container)}scheduleSnapBack(){this.snapBackTimeoutId&&clearTimeout(this.snapBackTimeoutId),this.snapBackTimeoutId=window.setTimeout(()=>{this.snapBack()},800)}adjustBib(e){let n=parseInt(this.bibValue||"0",10);n+=e,n<0&&(n=0),n>999&&(n=999),this.bibValue=String(n),this.options.onChange(this.bibValue),Do();const i=String(n%10),s=this.cachedNumberElements.get(i);if(s){s.classList.add("flash");const r=window.setTimeout(()=>{s.classList.remove("flash"),this.visualTimeoutIds.delete(r)},150);this.visualTimeoutIds.add(r)}}getAngle(e,n,i){const s=i.left+i.width/2,r=i.top+i.height/2;return Math.atan2(n-r,e-s)*(180/Math.PI)}updateDialRotation(){if(!this.dialNumbers)return;this.dialNumbers.style.transform=`rotate(${this.rotation}deg)`;const e=`rotate(${-this.rotation}deg)`;for(const n of this.cachedNumberSpans)n.style.transform=e}getValue(){return this.bibValue}setValue(e){this.bibValue=e.slice(0,3)}clear(){this.bibValue=""}flash(){var n,i;(n=this.dialRing)==null||n.classList.add("flash"),(i=this.dialNumbers)==null||i.querySelectorAll(".dial-number").forEach((s,r)=>{const a=window.setTimeout(()=>{this.visualTimeoutIds.delete(a),s.classList.add("flash");const o=window.setTimeout(()=>{s.classList.remove("flash"),this.visualTimeoutIds.delete(o)},200);this.visualTimeoutIds.add(o)},r*40);this.visualTimeoutIds.add(a)});const e=window.setTimeout(()=>{var s;(s=this.dialRing)==null||s.classList.remove("flash"),this.visualTimeoutIds.delete(e)},1200);this.visualTimeoutIds.add(e)}destroy(){if(!this.isDestroyed){this.isDestroyed=!0,this.spinAnimationId&&cancelAnimationFrame(this.spinAnimationId),this.snapBackAnimationId&&cancelAnimationFrame(this.snapBackAnimationId),this.snapBackTimeoutId&&clearTimeout(this.snapBackTimeoutId),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null);for(const e of this.visualTimeoutIds)clearTimeout(e);this.visualTimeoutIds.clear();for(const[e,n]of this.numberKeydownListeners)e.removeEventListener("keydown",n);this.numberKeydownListeners.clear(),this.container.removeEventListener("mousedown",this.handleDragStart),this.container.removeEventListener("touchstart",this.handleDragStart),window.removeEventListener("mousemove",this.handleDragMove),window.removeEventListener("mouseup",this.handleDragEnd),window.removeEventListener("touchmove",this.handleDragMove),window.removeEventListener("touchend",this.handleDragEnd)}}}const Qc=3e3,Yc=1e3;class Kc{constructor(){g(this,"container");g(this,"queue",[]);g(this,"isShowing",!1);g(this,"toastEventListener");g(this,"lastCopyTime",0);g(this,"isDestroyed",!1);this.container=this.createContainer(),document.body.appendChild(this.container),this.toastEventListener=e=>{this.show(e.detail.message,{type:e.detail.type,duration:e.detail.duration})},window.addEventListener("show-toast",this.toastEventListener)}createContainer(){const e=document.createElement("div");return e.id="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.style.cssText=`
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    `,e}show(e,n={}){this.queue.push({message:e,options:n}),this.isShowing||this.processQueue()}processQueue(){if(this.queue.length===0){this.isShowing=!1;return}this.isShowing=!0;const{message:e,options:n}=this.queue.shift(),i=n.duration||Qc,s=n.type||"info",r=this.createToast(e,s,n.action);this.container.appendChild(r),requestAnimationFrame(()=>{r.style.opacity="1",r.style.transform="translateY(0)"});let a=!1;const o=()=>{a||(a=!0,r.style.opacity="0",r.style.transform="translateY(10px)",setTimeout(()=>{r.remove(),this.processQueue()},200))};r._dismiss=o,setTimeout(o,i)}createToast(e,n,i){const s=document.createElement("div");s.className=`toast toast-${n}`;const r={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--primary)"},a={success:'<path d="M20 6L9 17l-5-5"/>',error:'<path d="M18 6L6 18M6 6l12 12"/>',warning:'<path d="M12 9v4M12 17h.01"/>',info:'<path d="M12 16v-4M12 8h.01"/>'};if(s.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border-left: 3px solid ${r[n]};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 0.875rem;
      color: var(--text-primary);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: auto;
      max-width: 90vw;
    `,s.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${r[n]}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        ${a[n]}
      </svg>
      <span>${this.escapeHtml(e)}</span>
    `,i){const o=document.createElement("button");o.textContent=i.label,o.setAttribute("aria-label",i.label),o.style.cssText=`
        background: none;
        border: 1px solid ${r[n]};
        color: ${r[n]};
        padding: 2px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        margin-left: 4px;
        white-space: nowrap;
      `,o.addEventListener("click",c=>{c.stopPropagation(),c.preventDefault(),i.callback();const u=s._dismiss;u&&u()}),s.appendChild(o)}else s.addEventListener("click",o=>{o.stopPropagation(),o.preventDefault(),this.copyToClipboard(e)});return s.addEventListener("mousedown",o=>o.stopPropagation()),s.addEventListener("touchstart",o=>o.stopPropagation(),{passive:!0}),s}async copyToClipboard(e){const n=Date.now(),i=n-this.lastCopyTime>Yc;this.lastCopyTime=n;try{await navigator.clipboard.writeText(e),i&&this.show(f("copied",l.getState().currentLang),{type:"success",duration:1500})}catch{}}escapeHtml(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}clear(){this.queue=[],this.container.innerHTML="",this.isShowing=!1}destroy(){this.isDestroyed||(this.isDestroyed=!0,window.removeEventListener("show-toast",this.toastEventListener),this.clear(),this.container.remove())}}let Ke=null;function Ii(){return Ke||(Ke=new Kc),Ke}function w(t,e="info",n,i){Ii().show(t,{type:e,duration:n,action:i==null?void 0:i.action})}function Zc(){Ii().clear()}function Xc(){Ke&&(Ke.destroy(),Ke=null)}const _e=72,He=56,ze=72,ds=5,el=16,tl=100;class nl{constructor(e){g(this,"container");g(this,"scrollContainer");g(this,"contentContainer");g(this,"entries",[]);g(this,"groups",[]);g(this,"expandedGroups",new Set);g(this,"visibleItems",new Map);g(this,"itemListeners",new Map);g(this,"scrollTop",0);g(this,"containerHeight",0);g(this,"options");g(this,"unsubscribe",null);g(this,"resizeObserver",null);g(this,"scrollHandler",null);g(this,"scrollDebounceTimeout",null);g(this,"resizeDebounceTimeout",null);g(this,"isPaused",!1);g(this,"needsRefreshOnResume",!1);g(this,"isDestroyed",!1);g(this,"domRemovalObserver",null);this.options=e,this.container=e.container,this.scrollContainer=document.createElement("div"),this.scrollContainer.className="virtual-scroll-container",this.scrollContainer.style.cssText=`
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    `,this.contentContainer=document.createElement("div"),this.contentContainer.className="virtual-scroll-content",this.contentContainer.style.position="relative",this.scrollContainer.appendChild(this.contentContainer),this.container.appendChild(this.scrollContainer),this.scrollHandler=()=>{this.scrollDebounceTimeout!==null&&clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=setTimeout(()=>{this.scrollDebounceTimeout=null;try{this.onScroll()}catch(i){y.error("VirtualList scroll error:",i)}},el)},this.scrollContainer.addEventListener("scroll",this.scrollHandler,{passive:!0}),this.resizeObserver=new ResizeObserver(()=>{this.resizeDebounceTimeout!==null&&clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=setTimeout(()=>{this.resizeDebounceTimeout=null;try{this.containerHeight=this.scrollContainer.clientHeight,this.isPaused?this.needsRefreshOnResume=!0:this.render()}catch(i){y.error("VirtualList resize error:",i)}},tl)}),this.resizeObserver.observe(this.scrollContainer),this.unsubscribe=l.subscribe((i,s)=>{(s.includes("entries")||s.includes("selectedEntries")||s.includes("faultEntries"))&&this.setEntries(i.entries)}),this.domRemovalObserver=new MutationObserver(i=>{var s;for(const r of i)for(const a of r.removedNodes)if(a===this.container||(s=a.contains)!=null&&s.call(a,this.container)){this.destroy();return}});const n=this.container.parentElement||document.body;this.domRemovalObserver.observe(n,{childList:!0,subtree:!0}),this.containerHeight=this.scrollContainer.clientHeight}setEntries(e){this.entries=e,this.applyFilters()}applyFilters(e,n,i){var o;this.scrollDebounceTimeout!==null&&(clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=null);const s=l.getState();let r=[...this.entries];if(e){const c=e.toLowerCase();r=r.filter(u=>{var d;return u.bib.toLowerCase().includes(c)||((d=u.deviceName)==null?void 0:d.toLowerCase().includes(c))})}n&&n!=="all"&&(r=r.filter(c=>c.point===n)),i&&i!=="all"&&(r=r.filter(c=>c.status===i));const a=new Map;for(const c of r){const u=c.run??1,d=`${c.bib}-${u}`;a.has(d)||a.set(d,{id:d,bib:c.bib,run:u,entries:[],faults:[],isMultiItem:!1,latestTimestamp:c.timestamp,crossDeviceDuplicateCount:0});const h=a.get(d);h.entries.push(c),new Date(c.timestamp)>new Date(h.latestTimestamp)&&(h.latestTimestamp=c.timestamp)}for(const c of s.faultEntries){const u=`${c.bib}-${c.run}`;if(e){const h=e.toLowerCase();if(!c.bib.toLowerCase().includes(h)&&!((o=c.deviceName)!=null&&o.toLowerCase().includes(h)))continue}if(n&&n!=="all"||i&&i!=="all"&&i!=="dsq"&&i!=="flt")continue;a.has(u)||a.set(u,{id:u,bib:c.bib,run:c.run,entries:[],faults:[],isMultiItem:!1,latestTimestamp:c.timestamp,crossDeviceDuplicateCount:0});const d=a.get(u);d.faults.push(c),new Date(c.timestamp)>new Date(d.latestTimestamp)&&(d.latestTimestamp=c.timestamp)}for(const c of a.values()){const u=c.entries.length+c.faults.length;c.isMultiItem=u>1;const d=new Map;for(const m of c.entries){const p=m.point;d.has(p)||d.set(p,new Set),d.get(p).add(m.deviceId)}let h=0;for(const m of d.values())m.size>1&&h++;c.crossDeviceDuplicateCount=h}this.groups=Array.from(a.values()).sort((c,u)=>{const d=parseInt(c.bib,10)||0;return(parseInt(u.bib,10)||0)-d});for(const[c,u]of this.visibleItems)this.cleanupItemListeners(c,u),u.remove();this.visibleItems.clear(),this.updateContentHeight(),this.isPaused?this.needsRefreshOnResume=!0:this.render()}toggleGroup(e){this.expandedGroups.has(e)?this.expandedGroups.delete(e):this.expandedGroups.add(e);for(const[n,i]of this.visibleItems)this.cleanupItemListeners(n,i),i.remove();this.visibleItems.clear(),this.updateContentHeight(),this.isPaused?this.needsRefreshOnResume=!0:this.render()}updateContentHeight(){let e=0;for(const n of this.groups)if(!n.isMultiItem)e+=_e;else if(this.expandedGroups.has(n.id)){const i=n.entries.length+n.faults.length;e+=ze+i*He}else e+=ze;this.contentContainer.style.height=`${e}px`}getGroupHeight(e){if(!e.isMultiItem)return _e;if(this.expandedGroups.has(e.id)){const n=e.entries.length+e.faults.length;return ze+n*He}return ze}onScroll(){this.scrollTop=this.scrollContainer.scrollTop,this.isPaused?this.needsRefreshOnResume=!0:this.render()}render(){if(this.groups.length===0){this.renderEmpty();return}const e=this.contentContainer.querySelector(".empty-state");e&&e.remove();const n=new Set,i=this.scrollTop,s=this.scrollTop+this.containerHeight;let r=0;for(let a=0;a<this.groups.length;a++){const o=this.groups[a],c=this.getGroupHeight(o);r+c>=i-ds*_e&&r<=s+ds*_e&&(o.isMultiItem?this.expandedGroups.has(o.id)?this.renderExpandedGroup(o,r,n):this.renderCollapsedGroup(o,r,n):this.renderSingleItem(o,r,n)),r+=c}for(const[a,o]of this.visibleItems)n.has(a)||(this.cleanupItemListeners(a,o),o.remove(),this.visibleItems.delete(a))}renderSingleItem(e,n,i){const s=`single-${e.id}`;i.add(s);let r=this.visibleItems.get(s);if(!r){if(e.entries.length>0)r=this.createEntryItem(e.entries[0],e.faults,s,e.crossDeviceDuplicateCount);else if(e.faults.length>0)r=this.createFaultOnlyItem(e,s);else return;this.visibleItems.set(s,r),this.contentContainer.appendChild(r)}r.style.transform=`translateY(${n}px)`}renderCollapsedGroup(e,n,i){const s=`header-${e.id}`;i.add(s);let r=this.visibleItems.get(s);r||(r=this.createGroupHeader(e,!1),this.visibleItems.set(s,r),this.contentContainer.appendChild(r)),r.style.transform=`translateY(${n}px)`}renderExpandedGroup(e,n,i){const s=`header-${e.id}`;i.add(s);let r=this.visibleItems.get(s);r||(r=this.createGroupHeader(e,!0),this.visibleItems.set(s,r),this.contentContainer.appendChild(r)),r.style.transform=`translateY(${n}px)`;let a=n+ze;for(let o=0;o<e.entries.length;o++){const c=e.entries[o],u=`sub-entry-${c.id}`;i.add(u);let d=this.visibleItems.get(u);d||(d=this.createSubEntryItem(c,u),this.visibleItems.set(u,d),this.contentContainer.appendChild(d)),d.style.transform=`translateY(${a}px)`,a+=He}for(let o=0;o<e.faults.length;o++){const c=e.faults[o],u=`sub-fault-${c.id}`;i.add(u);let d=this.visibleItems.get(u);d||(d=this.createSubFaultItem(c,u),this.visibleItems.set(u,d),this.contentContainer.appendChild(d)),d.style.transform=`translateY(${a}px)`,a+=He}}createGroupHeader(e,n){const i=document.createElement("div");i.className=`result-group-header ${n?"expanded":""}`,i.setAttribute("data-group-id",e.id),i.setAttribute("role","button"),i.setAttribute("tabindex","0"),i.setAttribute("aria-expanded",String(n)),i.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${ze}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 4px;
      gap: 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    `;const s=Pn(e.bib||"---"),a=l.getState().currentLang,o=ft(e.run),c=ut(e.run,a),u=e.entries.length,d=e.faults.length,h=d>0,m=[];u>0&&m.push(`${u} ${f(u===1?"timeEntry":"timeEntries",a)}`),d>0&&m.push(`${d} ${f(d===1?"faultEntry":"faultEntries",a)}`);const p=m.join(", ");i.innerHTML=`
      ${Vc(16,n)}
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 44px; text-align: right;">
        ${T(s)}
      </div>
      <div style="min-width: 48px;"></div>
      ${Mn(c,o)}
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0;">
        <div class="result-summary" style="font-size: 0.875rem; color: var(--text-secondary);">
          ${T(p)}
        </div>
      </div>
      ${e.crossDeviceDuplicateCount>0?rs(a):""}
      ${h?`<span class="result-fault-badge" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">
          ${d}× ${f("flt",a)}
        </span>`:""}
    `;const v=`header-${e.id}`,S={};return S.click=()=>{this.toggleGroup(e.id)},i.addEventListener("click",S.click),S.keydown=E=>{switch(E.key){case"Enter":case" ":E.preventDefault(),this.toggleGroup(e.id);break;case"ArrowDown":E.preventDefault(),this.focusNextItem(i);break;case"ArrowUp":E.preventDefault(),this.focusPreviousItem(i);break}},i.addEventListener("keydown",S.keydown),S.touchstart=()=>{i.style.background="var(--surface-elevated)"},i.addEventListener("touchstart",S.touchstart,{passive:!0}),S.touchend=()=>{i.style.background="var(--surface)"},i.addEventListener("touchend",S.touchend,{passive:!0}),this.itemListeners.set(v,S),i}createEntryItem(e,n,i,s=0){const r=document.createElement("div");r.className="result-item",r.setAttribute("role","listitem"),r.setAttribute("tabindex","0"),r.setAttribute("data-entry-id",e.id),r.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${_e}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 4px;
      gap: 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    `;const a=new Date(e.timestamp),o=ke(a),c=Pn(e.bib||"---"),d=l.getState().currentLang,h=mt(e.point),m=Ce(e.point,d),p=e.run??1,v=ft(p),S=ut(p,d),E=n.length>0?as({faults:n,lang:d}):"",k=s>0?rs(d):"";r.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 44px; text-align: right;">
        ${T(c)}
      </div>
      ${$t(m,h)}
      ${Mn(S,v)}
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0;">
        <div class="result-time" style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); font-size: 0.875rem;">
          ${T(o)}
        </div>
        ${e.deviceName?`
          <div class="result-device" style="font-size: 0.7rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${T(e.deviceName)}
          </div>
        `:""}
      </div>
      ${k}
      ${E}
      ${e.status!=="ok"?$n(e.status.toUpperCase()):""}
      ${e.photo?Uc(f("viewPhotoLabel",d)):""}
      ${Nt({ariaLabel:f("editEntryLabel",d)})}
      ${Ft({ariaLabel:f("deleteEntryLabel",d)})}
    `;const C={},_=r.querySelector(".result-edit-btn");C.editBtn=_,C.editClick=A=>{var R,x;A.stopPropagation(),(x=(R=this.options).onItemClick)==null||x.call(R,e,A)},_.addEventListener("click",C.editClick);const q=r.querySelector(".result-delete");C.deleteBtn=q,C.deleteClick=A=>{var R,x;A.stopPropagation(),(x=(R=this.options).onItemDelete)==null||x.call(R,e)},q.addEventListener("click",C.deleteClick);const N=r.querySelector(".result-photo-btn");return N&&(C.photoBtn=N,C.photoClick=A=>{var R,x;A.stopPropagation(),(x=(R=this.options).onViewPhoto)==null||x.call(R,e)},N.addEventListener("click",C.photoClick)),C.click=A=>{var R,x;(x=(R=this.options).onItemClick)==null||x.call(R,e,A)},r.addEventListener("click",C.click),C.touchstart=()=>{r.style.background="var(--surface-elevated)"},r.addEventListener("touchstart",C.touchstart,{passive:!0}),C.touchend=()=>{r.style.background="var(--surface)"},r.addEventListener("touchend",C.touchend,{passive:!0}),C.keydown=A=>{var x,oe,Rt,Dt,Oi,Vi;const R=A;switch(R.key){case"Enter":case" ":R.preventDefault(),(oe=(x=this.options).onItemClick)==null||oe.call(x,e,new MouseEvent("click"));break;case"e":case"E":R.preventDefault(),(Dt=(Rt=this.options).onItemClick)==null||Dt.call(Rt,e,new MouseEvent("click"));break;case"Delete":case"d":case"D":R.preventDefault(),(Vi=(Oi=this.options).onItemDelete)==null||Vi.call(Oi,e);break;case"ArrowDown":R.preventDefault(),this.focusNextItem(r);break;case"ArrowUp":R.preventDefault(),this.focusPreviousItem(r);break}},r.addEventListener("keydown",C.keydown),this.itemListeners.set(i,C),r}createFaultOnlyItem(e,n){var q;const i=document.createElement("div"),s=e.faults,r=s.some(N=>N.markedForDeletion);i.className=`result-item fault-only-item${r?" marked-for-deletion":""}`,i.setAttribute("role","listitem"),i.setAttribute("tabindex","0"),i.setAttribute("data-fault-id",e.id),i.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${_e}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 4px;
      gap: 8px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      border-left: 3px solid ${r?"var(--error)":"var(--warning)"};
      ${r?"opacity: 0.6;":""}
      cursor: pointer;
    `;const a=Pn(e.bib||"---"),o=l.getState(),c=o.currentLang,u=ft(e.run),d=ut(e.run,c),h=s.sort((N,A)=>N.gateNumber-A.gateNumber).map(N=>`T${N.gateNumber} (${ve(N.faultType,c)})${N.markedForDeletion?" ⚠":""}`).join(", "),m=as({faults:s,lang:c}),p=o.usePenaltyMode?f("flt",c):f("dsq",c),v=o.usePenaltyMode?"var(--warning)":"var(--error)",S=v==="var(--warning)"?"#000":"white",E=r?os():"";i.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 44px; text-align: right; ${r?"text-decoration: line-through; opacity: 0.6;":""}">
        ${T(a)}
      </div>
      ${$t(f("gate",c),"var(--warning)")}
      ${Mn(d,u)}
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px; min-width: 0;">
        <div class="result-fault-details" style="font-size: 0.8rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; ${r?"text-decoration: line-through; opacity: 0.6;":""}">
          ${T(h)}
        </div>
        ${(q=s[0])!=null&&q.deviceName?`
          <div class="result-device" style="font-size: 0.7rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${T(s[0].deviceName)}
          </div>
        `:""}
      </div>
      ${E}
      ${r?"":m}
      ${r?"":$n(p,v,S)}
      ${Nt({ariaLabel:f("editFaultLabel",c)})}
      ${Ft({ariaLabel:f("deleteFaultLabel",c),className:"result-delete fault-delete-btn"})}
    `;const k={},C=i.querySelector(".result-edit-btn");C&&s.length>0&&(k.editBtn=C,k.editClick=N=>{N.stopPropagation();const A=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:s[0]}});i.dispatchEvent(A)},C.addEventListener("click",k.editClick));const _=i.querySelector(".fault-delete-btn");return _&&s.length>0&&(k.deleteBtn=_,k.deleteClick=N=>{N.stopPropagation();const A=new CustomEvent("fault-delete-request",{bubbles:!0,detail:{fault:s[0]}});i.dispatchEvent(A)},_.addEventListener("click",k.deleteClick)),k.click=N=>{const A=N.target;if(!(A.closest(".fault-delete-btn")||A.closest(".result-edit-btn"))&&s.length>0){const R=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:s[0]}});i.dispatchEvent(R)}},i.addEventListener("click",k.click),k.touchstart=()=>{i.style.background="var(--surface-elevated)"},i.addEventListener("touchstart",k.touchstart,{passive:!0}),k.touchend=()=>{i.style.background="var(--surface)"},i.addEventListener("touchend",k.touchend,{passive:!0}),k.keydown=N=>{const A=N;switch(A.key){case"Enter":case" ":case"e":case"E":if(A.preventDefault(),s.length>0){const R=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:s[0]}});i.dispatchEvent(R)}break;case"Delete":case"d":case"D":if(A.preventDefault(),s.length>0){const R=new CustomEvent("fault-delete-request",{bubbles:!0,detail:{fault:s[0]}});i.dispatchEvent(R)}break;case"ArrowDown":A.preventDefault(),this.focusNextItem(i);break;case"ArrowUp":A.preventDefault(),this.focusPreviousItem(i);break}},i.addEventListener("keydown",k.keydown),this.itemListeners.set(n,k),i}createSubEntryItem(e,n){const i=document.createElement("div");i.className="result-sub-item entry-sub-item",i.setAttribute("role","listitem"),i.setAttribute("tabindex","0"),i.setAttribute("data-entry-id",e.id),i.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${He}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 24px;
      gap: 8px;
      background: var(--surface-elevated);
      border-bottom: 1px solid var(--background);
      cursor: pointer;
      transition: background 0.2s;
    `;const s=new Date(e.timestamp),r=ke(s),o=l.getState().currentLang,c=mt(e.point),u=Ce(e.point,o);i.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div style="min-width: 44px;"></div>
      ${$t(u,c,"48px","0.7rem")}
      <div style="min-width: 36px;"></div>
      <div class="result-info" style="flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0;">
        <div class="result-time" style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); font-size: 0.85rem;">
          ${T(r)}
        </div>
        ${e.deviceName?`
          <div class="result-device" style="font-size: 0.65rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${T(e.deviceName)}
          </div>
        `:""}
      </div>
      ${e.status!=="ok"?$n(e.status.toUpperCase(),"var(--error)","white","0.65rem"):""}
      ${Nt({ariaLabel:f("editEntryLabel",o),size:16})}
      ${Ft({ariaLabel:f("deleteEntryLabel",o),size:16})}
    `;const d={},h=i.querySelector(".result-edit-btn");d.editBtn=h,d.editClick=p=>{var v,S;p.stopPropagation(),(S=(v=this.options).onItemClick)==null||S.call(v,e,p)},h.addEventListener("click",d.editClick);const m=i.querySelector(".result-delete");return d.deleteBtn=m,d.deleteClick=p=>{var v,S;p.stopPropagation(),(S=(v=this.options).onItemDelete)==null||S.call(v,e)},m.addEventListener("click",d.deleteClick),d.click=p=>{var v,S;(S=(v=this.options).onItemClick)==null||S.call(v,e,p)},i.addEventListener("click",d.click),d.touchstart=()=>{i.style.background="var(--surface)"},i.addEventListener("touchstart",d.touchstart,{passive:!0}),d.touchend=()=>{i.style.background="var(--surface-elevated)"},i.addEventListener("touchend",d.touchend,{passive:!0}),d.keydown=p=>{var S,E,k,C;const v=p;switch(v.key){case"Enter":case" ":case"e":case"E":v.preventDefault(),(E=(S=this.options).onItemClick)==null||E.call(S,e,new MouseEvent("click"));break;case"Delete":case"d":case"D":v.preventDefault(),(C=(k=this.options).onItemDelete)==null||C.call(k,e);break;case"ArrowDown":v.preventDefault(),this.focusNextItem(i);break;case"ArrowUp":v.preventDefault(),this.focusPreviousItem(i);break}},i.addEventListener("keydown",d.keydown),this.itemListeners.set(n,d),i}createSubFaultItem(e,n){const i=document.createElement("div"),s=e.markedForDeletion;i.className=`result-sub-item fault-sub-item${s?" marked-for-deletion":""}`,i.setAttribute("role","listitem"),i.setAttribute("tabindex","0"),i.setAttribute("data-fault-id",e.id),i.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${He}px;
      display: flex;
      align-items: center;
      padding: 0 8px 0 24px;
      gap: 8px;
      background: var(--surface-elevated);
      border-bottom: 1px solid var(--background);
      border-left: 3px solid ${s?"var(--error)":"var(--warning)"};
      ${s?"opacity: 0.6;":""}
      cursor: pointer;
      transition: background 0.2s;
    `;const a=l.getState().currentLang,o=l.getGateColor(e.gateNumber),c=o==="red"?"#ef4444":"#3b82f6";i.innerHTML=`
      <div style="width: 16px; flex-shrink: 0;"></div>
      <div style="min-width: 44px;"></div>
      ${$t(`T${e.gateNumber}`,"var(--warning)","48px","0.7rem")}
      <div style="min-width: 36px; display: flex; align-items: center; justify-content: center;">
        <div style="width: 8px; height: 8px; border-radius: 50%; background: ${c};" title="${o}"></div>
      </div>
      <div class="result-info" style="flex: 1; display: flex; align-items: center; gap: 8px; min-width: 0;">
        <span style="font-size: 0.85rem; color: var(--text-secondary); ${s?"text-decoration: line-through;":""}">
          ${T(ve(e.faultType,a))}
        </span>
        ${e.deviceName?`
          <span style="font-size: 0.65rem; color: var(--text-tertiary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            ${T(e.deviceName)}
          </span>
        `:""}
      </div>
      ${s?os("0.65rem"):""}
      ${Nt({ariaLabel:f("editFaultLabel",a),size:16})}
      ${Ft({ariaLabel:f("deleteFaultLabel",a),size:16,className:"result-delete fault-delete-btn"})}
    `;const u={},d=i.querySelector(".result-edit-btn");u.editBtn=d,u.editClick=m=>{m.stopPropagation();const p=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:e}});i.dispatchEvent(p)},d.addEventListener("click",u.editClick);const h=i.querySelector(".fault-delete-btn");return u.deleteBtn=h,u.deleteClick=m=>{m.stopPropagation();const p=new CustomEvent("fault-delete-request",{bubbles:!0,detail:{fault:e}});i.dispatchEvent(p)},h.addEventListener("click",u.deleteClick),u.click=()=>{const m=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:e}});i.dispatchEvent(m)},i.addEventListener("click",u.click),u.touchstart=()=>{i.style.background="var(--surface)"},i.addEventListener("touchstart",u.touchstart,{passive:!0}),u.touchend=()=>{i.style.background="var(--surface-elevated)"},i.addEventListener("touchend",u.touchend,{passive:!0}),u.keydown=m=>{const p=m;switch(p.key){case"Enter":case" ":case"e":case"E":p.preventDefault();{const v=new CustomEvent("fault-edit-request",{bubbles:!0,detail:{fault:e}});i.dispatchEvent(v)}break;case"Delete":case"d":case"D":p.preventDefault();{const v=new CustomEvent("fault-delete-request",{bubbles:!0,detail:{fault:e}});i.dispatchEvent(v)}break;case"ArrowDown":p.preventDefault(),this.focusNextItem(i);break;case"ArrowUp":p.preventDefault(),this.focusPreviousItem(i);break}},i.addEventListener("keydown",u.keydown),this.itemListeners.set(n,u),i}renderEmpty(){for(const n of this.visibleItems.values())n.remove();this.visibleItems.clear();const e=l.getState();this.contentContainer.innerHTML=`
      <div class="empty-state">
        <span class="empty-icon">⏱️</span>
        <span>${f("noEntries",e.currentLang)}</span>
        <span class="empty-subtitle">${f("noEntriesHint",e.currentLang)}</span>
      </div>
    `}pause(){this.isPaused=!0}resume(){this.isPaused=!1,this.needsRefreshOnResume&&(this.needsRefreshOnResume=!1,this.render())}scrollToTop(){this.scrollContainer.scrollTo({top:0,behavior:"smooth"})}scrollToEntry(e){const n=String(e),i=this.groups.find(r=>r.entries.some(a=>a.id===n));if(!i)return;let s=0;for(const r of this.groups){if(r.id===i.id)break;s+=this.getGroupHeight(r)}i.isMultiItem&&(this.expandedGroups.add(i.id),this.isPaused?this.needsRefreshOnResume=!0:this.render()),this.isPaused||this.scrollContainer.scrollTo({top:s,behavior:"smooth"})}getVisibleCount(){return this.groups.reduce((e,n)=>e+n.entries.length,0)}getSortedFocusableItems(){const e=Array.from(this.visibleItems.values());return e.sort((n,i)=>{const s=this.getItemYPosition(n),r=this.getItemYPosition(i);return s-r}),e}focusNextItem(e){const n=this.getSortedFocusableItems(),i=n.indexOf(e);i>=0&&i<n.length-1&&n[i+1].focus()}focusPreviousItem(e){const n=this.getSortedFocusableItems(),i=n.indexOf(e);i>0&&n[i-1].focus()}getItemYPosition(e){const i=e.style.transform.match(/translateY\((\d+)px\)/);return i?parseInt(i[1],10):0}cleanupItemListeners(e,n){const i=this.itemListeners.get(e);i&&(i.click&&n.removeEventListener("click",i.click),i.keydown&&n.removeEventListener("keydown",i.keydown),i.touchstart&&n.removeEventListener("touchstart",i.touchstart),i.touchend&&n.removeEventListener("touchend",i.touchend),i.editBtn&&i.editClick&&i.editBtn.removeEventListener("click",i.editClick),i.deleteBtn&&i.deleteClick&&i.deleteBtn.removeEventListener("click",i.deleteClick),i.photoBtn&&i.photoClick&&i.photoBtn.removeEventListener("click",i.photoClick),this.itemListeners.delete(e))}destroy(){if(!this.isDestroyed){this.isDestroyed=!0,this.domRemovalObserver&&(this.domRemovalObserver.disconnect(),this.domRemovalObserver=null),this.scrollHandler&&(this.scrollContainer.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null),this.scrollDebounceTimeout!==null&&(clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=null),this.resizeDebounceTimeout!==null&&(clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null);for(const[e,n]of this.visibleItems)this.cleanupItemListeners(e,n);this.visibleItems.clear(),this.itemListeners.clear(),this.scrollContainer.remove()}}}async function us(t){const e=l.getState(),n=t.map(i=>i.id);if(n.length===1?l.deleteEntry(n[0]):l.deleteMultiple(n),n.length===1?await Q.deletePhoto(n[0]):await Q.deletePhotos(n),e.settings.sync&&e.raceId)for(const i of t)$.deleteEntryFromCloud(i.id,i.deviceId)}const ki=new WeakMap;function ot(t,e){ki.set(t,e)}function tt(t){return ki.get(t)??null}function il(t){ki.delete(t)}const sl=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(","),dn=new WeakMap;function Gs(t){return Array.from(t.querySelectorAll(sl)).filter(e=>!e.hasAttribute("disabled")&&e.tabIndex!==-1)}function rl(t){const e=Gs(t);if(e.length>0){e[0].focus();return}t.hasAttribute("tabindex")||t.setAttribute("tabindex","-1"),t.focus()}function al(t){const e=n=>{if(n.key==="Escape"){M(t);return}if(n.key!=="Tab")return;const i=Gs(t);if(i.length===0){n.preventDefault();return}const s=i[0],r=i[i.length-1],a=document.activeElement;if(n.shiftKey){(!a||a===s||a===t)&&(n.preventDefault(),r.focus());return}a===r&&(n.preventDefault(),s.focus())};t.addEventListener("keydown",e),dn.set(t,{previousFocus:document.activeElement,keydownHandler:e})}function ol(t){const e=dn.get(t);if(!e)return;t.removeEventListener("keydown",e.keydownHandler),dn.delete(t);const n=e.previousFocus;n&&typeof n.focus=="function"&&n.focus()}function M(t){!t||!t.classList.contains("show")||(t.classList.add("closing"),setTimeout(()=>{t.classList.remove("show","closing"),ol(t)},150))}function V(t){if(!t)return;t.hasAttribute("role")||t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true");const e=t.classList.contains("show");t.classList.add("show"),dn.has(t)||al(t),e||setTimeout(()=>rl(t),0)}function cl(){document.querySelectorAll(".modal-overlay.show").forEach(t=>{M(t)})}function qs(){return document.querySelectorAll(".modal-overlay.show").length>0}const Ue=new O;let U=null;function Ci(t,e,n){const i=l.getState(),s={id:`fault-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,bib:t,run:i.selectedRun,gateNumber:e,faultType:n,timestamp:new Date().toISOString(),deviceId:i.deviceId,deviceName:i.deviceName,gateRange:i.gateAssignment||[1,1]};l.addFaultEntry(s),z();const r=l.getState().faultEntries.find(a=>a.id===s.id);r&&(at(r),ll(r)),w(f("faultRecorded",i.currentLang),"success")}function ll(t){const e=document.getElementById("fault-confirmation-overlay");if(!e)return;ot(e,{faultId:t.id});const n=e.querySelector(".fault-confirmation-bib"),i=e.querySelector(".fault-confirmation-gate"),s=e.querySelector(".fault-confirmation-type"),r=l.getState();n&&(n.textContent=t.bib),i&&(i.textContent=`${f("gate",r.currentLang)} ${t.gateNumber}`),s&&(s.textContent=ve(t.faultType,r.currentLang)),e.classList.add("show")}function dl(){const t=document.getElementById("save-fault-edit-btn");t&&Ue.add(t,"click",ul);const e=document.getElementById("restore-version-btn");e&&Ue.add(e,"click",fl);const n=document.getElementById("fault-edit-bib-input");n&&Sn(n,3);const i=document.getElementById("fault-edit-run-selector");i&&Ue.add(i,"click",c=>{const d=c.target.closest(".edit-run-btn");d&&i.querySelectorAll(".edit-run-btn").forEach(h=>{h.classList.toggle("active",h===d),h.setAttribute("aria-checked",h===d?"true":"false")})});const s=document.getElementById("fault-edit-notes"),r=document.getElementById("fault-edit-notes-char-count");s&&r&&Ue.add(s,"input",()=>{const c=s.value.length;r.textContent=`${c}/500`,r.classList.toggle("near-limit",c>450)});const a=document.getElementById("fault-edit-mic-btn");a&&Ue.add(a,"click",()=>{window.dispatchEvent(new CustomEvent("fault-edit-mic-click",{detail:{faultId:U}}))});const o=document.getElementById("confirm-mark-deletion-btn");o&&Ue.add(o,"click",hl)}function Js(t){if(t.markedForDeletion){const m=l.getState().currentLang;w(f("cannotEditPendingDeletion",m),"warning");return}const e=document.getElementById("fault-edit-modal");if(!e)return;U=t.id;const i=l.getState().currentLang,s=document.getElementById("fault-edit-bib-input"),r=document.getElementById("fault-edit-gate-input"),a=document.getElementById("fault-edit-type-select"),o=document.getElementById("fault-edit-gate-range"),c=document.getElementById("fault-version-select"),u=document.getElementById("fault-edit-notes"),d=document.getElementById("fault-edit-notes-char-count");if(s&&(s.value=t.bib||""),r&&(r.value=String(t.gateNumber)),a&&(a.value=t.faultType),u&&(u.value=t.notes||""),d){const m=(t.notes||"").length;d.textContent=`${m}/500`}o&&t.gateRange&&(o.textContent=`(${f("gates",i)} ${t.gateRange[0]}-${t.gateRange[1]})`);const h=document.getElementById("fault-edit-run-selector");if(h&&h.querySelectorAll(".edit-run-btn").forEach(m=>{const p=m.getAttribute("data-run");m.classList.toggle("active",p===String(t.run))}),c){c.innerHTML="";const m=document.createElement("option");m.value=String(t.currentVersion||1),m.textContent=`v${t.currentVersion||1} - ${f("currentVersion",i)}`,c.appendChild(m);const v=[...t.versionHistory||[]].sort((S,E)=>E.version-S.version).filter(S=>S.version!==t.currentVersion);for(const S of v){const E=document.createElement("option");E.value=String(S.version);const C=new Date(S.timestamp).toLocaleTimeString(i==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"}),_=S.changeType==="create"?f("originalVersion",i):S.changeType==="restore"?f("restored",i):S.editedBy;E.textContent=`v${S.version} - ${_} (${C})`,c.appendChild(E)}}V(e)}function ul(){if(!U)return;const t=l.getState(),e=t.faultEntries.find(C=>C.id===U);if(!e)return;const n=document.getElementById("fault-edit-bib-input"),i=document.getElementById("fault-edit-gate-input"),s=document.getElementById("fault-edit-type-select"),r=document.getElementById("fault-edit-run-selector"),a=document.getElementById("fault-edit-notes"),o=(n==null?void 0:n.value.padStart(3,"0"))||e.bib,c=parseInt((i==null?void 0:i.value)||String(e.gateNumber),10),u=(s==null?void 0:s.value)||e.faultType,d=(a==null?void 0:a.value.trim().slice(0,500))||"",h=t.currentLang;e.gateRange&&(c<e.gateRange[0]||c>e.gateRange[1])&&w(f("gateOutOfRange",h),"warning");const m=r==null?void 0:r.querySelector(".edit-run-btn.active"),p=m?parseInt(m.getAttribute("data-run")||"1",10):e.run,v=[];if(o!==e.bib&&v.push(`bib: ${e.bib} → ${o}`),c!==e.gateNumber&&v.push(`gate: ${e.gateNumber} → ${c}`),u!==e.faultType&&v.push(`type: ${e.faultType} → ${u}`),p!==e.run&&v.push(`run: ${e.run} → ${p}`),d!==(e.notes||"")){const C=d?`notes: ${d.slice(0,30)}${d.length>30?"...":""}`:"notes removed";v.push(C)}const S=v.length>0?v.join(", "):void 0,E={bib:o,gateNumber:c,faultType:u,run:p};if(d!==(e.notes||"")&&(E.notes=d||void 0,E.notesSource=d?"manual":void 0,E.notesTimestamp=d?new Date().toISOString():void 0),l.updateFaultEntryWithHistory(U,E,S)){const C=l.getState().faultEntries.find(_=>_.id===U);C&&at(C),w(f("saved",h),"success"),G()}M(document.getElementById("fault-edit-modal")),U=null}function fl(){if(!U)return;const t=document.getElementById("fault-version-select"),e=parseInt((t==null?void 0:t.value)||"0",10);if(!e)return;const n=l.getState(),i=n.faultEntries.find(r=>r.id===U);if(i&&e===i.currentVersion)return;if(l.restoreFaultVersion(U,e)){const r=l.getState().faultEntries.find(o=>o.id===U);r&&at(r);const a=n.currentLang;w(f("versionRestored",a),"success"),G(),M(document.getElementById("fault-edit-modal")),U=null}}function js(t){const e=document.getElementById("mark-deletion-modal");if(!e)return;U=t.id;const i=l.getState().currentLang,s=document.getElementById("mark-deletion-details");s&&(s.innerHTML=`
      <div>#${T(t.bib.padStart(3,"0"))} T${T(String(t.gateNumber))} (${T(ve(t.faultType,i))}) - ${T(f(t.run===1?"run1":"run2",i))}</div>
    `),V(e)}function hl(){if(!U)return;if(l.markFaultForDeletion(U)){const e=l.getState().faultEntries.find(i=>i.id===U);e&&at(e);const n=l.getState().currentLang;w(f("markedForDeletion",n),"info"),I()}M(document.getElementById("mark-deletion-modal")),U=null}const Ge=new O;let fe="",pe=0,Ze=null;function we(){const t=document.getElementById("active-bibs-list"),e=document.getElementById("no-active-bibs");if(!t)return;const n=l.getState(),i=l.getActiveBibs(n.selectedRun);if(t.querySelectorAll(".active-bib-card").forEach(a=>a.remove()),i.length===0){e&&(e.style.display="");return}e&&(e.style.display="none");const s=new Map;n.entries.forEach(a=>{a.point==="S"&&a.run===n.selectedRun&&s.set(a.bib,new Date(a.timestamp))}),[...i].sort((a,o)=>{var d,h;const c=((d=s.get(a))==null?void 0:d.getTime())||0;return(((h=s.get(o))==null?void 0:h.getTime())||0)-c}).forEach(a=>{const o=s.get(a),c=l.getFaultsForBib(a,n.selectedRun),u=c.length>0,d=document.createElement("div");d.className=`active-bib-card${u?" has-fault":""}`,d.setAttribute("data-bib",T(a)),d.setAttribute("role","listitem");const h=o?ke(o):"--:--:--";d.innerHTML=`
      <div class="bib-card-info">
        <span class="bib-card-number">${T(a)}</span>
        <span class="bib-card-time">${T(h)}</span>
        ${u?`<span class="bib-fault-indicator">${c.length} ${f("faultCount",n.currentLang)}</span>`:""}
      </div>
      <div class="bib-card-actions">
        <button class="bib-action-btn fault" data-action="fault" aria-label="${L(f("recordFault",n.currentLang))}">${f("faultMGShort",n.currentLang)}</button>
        <button class="bib-action-btn ok" data-action="ok" aria-label="${L(f("markOk",n.currentLang))}">${f("ok",n.currentLang)}</button>
      </div>
    `,d.addEventListener("click",m=>{const v=m.target.closest(".bib-action-btn");if(v){const S=v.getAttribute("data-action");S==="fault"?(I(),Xn(async()=>{const{openFaultRecordingModal:E}=await Promise.resolve().then(()=>El);return{openFaultRecordingModal:E}},void 0).then(({openFaultRecordingModal:E})=>{E(a)})):S==="ok"&&(I(),w(f("ok",n.currentLang),"success",1e3))}}),t.appendChild(d)})}function Cn(){const t=document.getElementById("gate-judge-faults-list"),e=document.getElementById("inline-fault-count"),n=document.getElementById("no-faults-recorded-inline");if(!t)return;const i=l.getState(),s=i.currentLang,r=i.faultEntries.filter(o=>o.run===i.selectedRun&&!o.markedForDeletion);if(e&&(e.textContent=String(r.length),e.setAttribute("data-count",String(r.length))),t.querySelectorAll(".gate-judge-fault-item").forEach(o=>o.remove()),r.length===0){n&&(n.style.display="");return}n&&(n.style.display="none"),[...r].sort((o,c)=>new Date(c.timestamp).getTime()-new Date(o.timestamp).getTime()).forEach(o=>{const c=l.getGateColor(o.gateNumber),u=o.notes&&o.notes.length>0,d=document.createElement("div");d.className="gate-judge-fault-item",d.setAttribute("data-fault-id",o.id),d.innerHTML=`
      <div class="gate-judge-fault-info">
        <span class="gate-judge-fault-bib">${T(o.bib)}</span>
        <div class="gate-judge-fault-details">
          <span class="gate-judge-fault-gate ${T(c)}">T${T(String(o.gateNumber))}</span>
          <span class="gate-judge-fault-type">${T(ve(o.faultType,s))}</span>
          ${u?`<span class="gate-judge-fault-note-icon" title="${L(f("hasNote",s))}" aria-label="${L(f("hasNote",s))}">${Us(14)}</span>`:""}
        </div>
      </div>
      <button class="gate-judge-fault-delete" aria-label="${f("deleteLabel",s)}">
        ${wi(18)}
      </button>
    `;const h=d.querySelector(".gate-judge-fault-delete");h&&h.addEventListener("click",m=>{m.stopPropagation(),I(),bl(o)}),t.appendChild(d)})}function Ws(){const t=l.getState(),e=l.getActiveBibs(t.selectedRun);!fe&&e.length>0&&(fe=e[0]);const n=document.getElementById("inline-bib-input");n&&fe&&(n.value=fe),Ie()}function gl(t){fe=t;const e=document.getElementById("inline-bib-input");e&&(e.value=t),Ie()}function Qs(){const t=document.getElementById("inline-gate-selector");if(!t)return;const e=l.getState(),n=e.currentLang,[i,s]=e.gateAssignment||[1,10];t.innerHTML="";const r=new Map;e.faultEntries.forEach(a=>{a.run===e.selectedRun&&!a.markedForDeletion&&r.set(a.gateNumber,(r.get(a.gateNumber)||0)+1)});for(let a=i;a<=s;a++){const o=l.getGateColor(a),c=r.get(a)||0,u=document.createElement("button");if(u.className=`gate-grid-btn ${o}`,u.setAttribute("data-gate",String(a)),u.setAttribute("role","radio"),u.setAttribute("aria-checked",String(a===pe)),u.setAttribute("aria-label",`${f("gateNumberLabel",n)} ${a}${c?` (${c})`:""}`),u.textContent=String(a),c>0){const d=document.createElement("span");d.className="gate-fault-count",d.textContent=String(c),d.setAttribute("aria-hidden","true"),u.appendChild(d)}a===pe&&u.classList.add("selected"),u.addEventListener("click",()=>{I(),On(a)}),u.addEventListener("keydown",d=>{const h=Array.from(t.querySelectorAll(".gate-grid-btn")),m=h.indexOf(u);switch(d.key){case" ":case"Enter":d.preventDefault(),I(),On(a);break;case"ArrowLeft":d.preventDefault(),m>0&&h[m-1].focus();break;case"ArrowRight":d.preventDefault(),m<h.length-1&&h[m+1].focus();break;case"ArrowUp":d.preventDefault(),m>=5&&h[m-5].focus();break;case"ArrowDown":d.preventDefault(),m+5<h.length&&h[m+5].focus();break;default:if(/^[0-9]$/.test(d.key)){d.preventDefault();const p=d.key==="0"?10:parseInt(d.key,10);if(p>=i&&p<=s){const v=t.querySelector(`[data-gate="${p}"]`);v&&(I(),On(p),v.focus())}}}}),t.appendChild(u)}}function On(t){if(pe===t){pe=0,Ys(),Ie(),document.querySelectorAll("#inline-gate-selector .gate-grid-btn").forEach(n=>{n.classList.remove("selected"),n.setAttribute("aria-checked","false")});return}pe=t,document.querySelectorAll("#inline-gate-selector .gate-grid-btn").forEach(n=>{const i=n.getAttribute("data-gate")===String(t);n.classList.toggle("selected",i),n.setAttribute("aria-checked",String(i))}),ml(t),fe||pl(),Ie()}function ml(t){const e=document.getElementById("fault-detail-panel"),n=document.getElementById("fault-detail-gate-label");if(!e)return;const s=l.getState().currentLang,r=l.getGateColor(t);n&&(n.textContent=`${f("gate",s)} ${t}`,n.style.color=r==="red"?"var(--error)":"var(--primary)"),e.style.display=""}function Ys(){const t=document.getElementById("fault-detail-panel");t&&(t.style.display="none")}function pl(){const t=l.getState(),e=l.getActiveBibs(t.selectedRun);if(e.length===0)return;const n=new Map;t.entries.forEach(s=>{s.point==="S"&&s.run===t.selectedRun&&n.set(s.bib,new Date(s.timestamp).getTime())});const i=[...e].sort((s,r)=>(n.get(r)||0)-(n.get(s)||0));gl(i[0])}function yl(){Ge.removeAll();const t=document.getElementById("inline-bib-input");t&&(Sn(t,3),Ge.add(t,"input",()=>{t.value&&(fe=t.value.padStart(3,"0"),Ie())}));const e=document.getElementById("fault-detail-close");e&&Ge.add(e,"click",()=>{pe=0,Ze=null,Ys(),document.querySelectorAll("#inline-gate-selector .gate-grid-btn").forEach(s=>{s.classList.remove("selected"),s.setAttribute("aria-checked","false")}),document.querySelectorAll("#inline-fault-types .inline-fault-type-btn").forEach(s=>{s.classList.remove("selected"),s.setAttribute("aria-pressed","false")}),Ie()});const n=document.getElementById("inline-fault-types");if(n){const s=r=>{I(),Ze=r.getAttribute("data-fault"),n.querySelectorAll(".inline-fault-type-btn").forEach(o=>{o.classList.toggle("selected",o===r),o.setAttribute("aria-pressed",String(o===r))}),Ie()};Ge.add(n,"click",r=>{const o=r.target.closest(".inline-fault-type-btn");o&&s(o)}),Ge.add(n,"keydown",r=>{const a=r,c=a.target.closest(".inline-fault-type-btn");if(c&&(a.key===" "||a.key==="Enter")){a.preventDefault(),s(c);return}const u=a.key.toUpperCase();let d=null;switch(u){case"M":case"G":d="MG";break;case"T":d="STR";break;case"B":case"R":d="BR";break}if(d){a.preventDefault();const h=n.querySelector(`[data-fault="${d}"]`);h&&(s(h),h.focus())}})}const i=document.getElementById("inline-save-fault-btn");i&&Ge.add(i,"click",vl)}function Ie(){const t=document.getElementById("inline-save-fault-btn");if(t){const e=fe&&pe>0&&Ze;t.disabled=!e}}function vl(){const t=l.getState().currentLang;if(!fe){w(f("selectBib",t),"warning");return}if(!pe){w(f("selectGate",t),"warning");return}if(!Ze){w(f("selectFaultType",t),"warning");return}Ci(fe,pe,Ze),Ze=null,document.querySelectorAll("#inline-fault-types .inline-fault-type-btn").forEach(e=>{e.classList.remove("selected"),e.setAttribute("aria-pressed","false")}),vt()}function bl(t){const e=document.getElementById("fault-delete-modal");if(!e){l.markFaultForDeletion(t.id);const r=l.getState().faultEntries.find(a=>a.id===t.id);r&&Ei(r),Cn(),w(f("faultDeleted",l.getState().currentLang),"success");return}ot(e,{faultId:t.id});const n=l.getState(),i=l.getGateColor(t.gateNumber),s=e.querySelector(".delete-fault-info");s&&(s.innerHTML=`
      <strong>#${T(t.bib)}</strong> -
      <span class="fault-gate ${i}">T${T(String(t.gateNumber))}</span>
      (${T(ve(t.faultType,n.currentLang))}) -
      ${f("run1",n.currentLang).replace("1",String(t.run))}
    `),V(e)}function vt(){Cn(),Ws(),Qs(),Ie()}const Ot=new O;function Sl(t){const e=l.getState(),n=e.currentLang,i=l.getActiveBibs(e.selectedRun);Ot.removeAll();const s=document.getElementById("fault-bib-selector");s&&(s.innerHTML=i.map(c=>`
      <button class="fault-bib-btn ${c===t?"selected":""}" data-bib="${L(c)}" aria-label="${L(f("selectBib",n))} ${L(c)}">${T(c)}</button>
    `).join(""),s.querySelectorAll(".fault-bib-btn").forEach(c=>{Ot.add(c,"click",()=>{s.querySelectorAll(".fault-bib-btn").forEach(d=>d.classList.remove("selected")),c.classList.add("selected");const u=document.getElementById("fault-bib-input");u&&(u.value=""),l.setSelectedFaultBib(c.getAttribute("data-bib")||"")})}));const r=document.getElementById("fault-bib-input");r&&(r.value=t||"",Ot.add(r,"input",()=>{s==null||s.querySelectorAll(".fault-bib-btn").forEach(c=>c.classList.remove("selected")),l.setSelectedFaultBib(r.value.padStart(3,"0"))})),l.setSelectedFaultBib(t||"");const a=document.getElementById("fault-gate-selector");if(a&&e.gateAssignment){const[c,u]=e.gateAssignment;let d="";for(let h=c;h<=u;h++){const p=l.getGateColor(h)==="red"?"gate-red":"gate-blue";d+=`<button class="fault-gate-btn ${p}" data-gate="${h}" aria-label="${L(f("gateNumberLabel",n))} ${h}">${h}</button>`}a.innerHTML=d,a.querySelectorAll(".fault-gate-btn").forEach(h=>{Ot.add(h,"click",()=>{a.querySelectorAll(".fault-gate-btn").forEach(m=>m.classList.remove("selected")),h.classList.add("selected")})})}const o=document.getElementById("fault-type-buttons");o&&o.querySelectorAll(".fault-type-btn").forEach(c=>{c.classList.remove("selected")}),V(document.getElementById("fault-modal"))}const Vn=new O;function Ks(){const t=document.getElementById("fault-type-buttons");if(t){const n=i=>{const s=t.querySelector(`[data-fault="${i}"]`);s&&(t.querySelectorAll(".fault-type-btn").forEach(r=>r.classList.remove("selected")),s.classList.add("selected"),I())};Vn.add(t,"click",i=>{const r=i.target.closest(".fault-type-btn");if(!r)return;const a=r.getAttribute("data-fault");a&&n(a)}),Vn.add(t,"keydown",i=>{const r=i.target.closest(".fault-type-btn");if(r&&(i.key===" "||i.key==="Enter")){i.preventDefault();const o=r.getAttribute("data-fault");o&&n(o);return}const a=i.key.toUpperCase();a==="M"||a==="G"?(i.preventDefault(),n("MG")):a==="T"?(i.preventDefault(),n("STR")):(a==="B"||a==="R")&&(i.preventDefault(),n("BR"))})}const e=document.getElementById("save-fault-btn");e&&Vn.add(e,"click",()=>{const n=document.querySelector("#fault-type-buttons .fault-type-btn.selected");if(!n){const s=l.getState().currentLang;w(f("selectFaultType",s),"warning");return}const i=n.getAttribute("data-fault");i&&Zs(i)})}function Zs(t){const e=l.getState();let n=e.selectedFaultBib;if(!n){const r=document.getElementById("fault-bib-input");n=(r==null?void 0:r.value.padStart(3,"0"))||""}if(!n){w(f("selectBib",e.currentLang),"warning");return}const i=document.querySelector("#fault-gate-selector .fault-gate-btn.selected"),s=i?parseInt(i.getAttribute("data-gate")||"0",10):0;if(!s){w(f("selectGate",e.currentLang),"warning");return}Ci(n,s,t),M(document.getElementById("fault-modal")),we()}function Xs(t,e,n){const i=l.getState();if(i.gateAssignment){const[s,r]=i.gateAssignment;if(e<s||e>r){w(f("gateOutOfRange",i.currentLang),"warning");return}}Ci(t.padStart(3,"0"),e,n),we()}const El=Object.freeze(Object.defineProperty({__proto__:null,initFaultRecordingModal:Ks,openFaultRecordingModal:Sl,recordFault:Zs,recordFaultFromVoice:Xs},Symbol.toStringTag,{value:"Module"}));let un=null;async function wl(t){const e=document.getElementById("photo-viewer-modal");if(!e||!t.photo)return;un=t.id;const n=document.getElementById("photo-viewer-image"),i=document.getElementById("photo-viewer-bib"),s=document.getElementById("photo-viewer-point"),r=document.getElementById("photo-viewer-time"),o=l.getState().currentLang;if(n){const c=Ce(t.point,o);if(n.alt=`${f("photoForBib",o)} ${t.bib||"---"} - ${c}`,t.photo==="indexeddb"){n.src="";const u=await Q.getPhoto(t.id);if(u)n.src=`data:image/jpeg;base64,${u}`;else{y.warn("Photo not found in IndexedDB for entry:",t.id);return}}else n.src=`data:image/jpeg;base64,${t.photo}`}if(i&&(i.textContent=t.bib||"---"),s){s.textContent=Ce(t.point,o);const c=mt(t.point);s.style.background=c,s.style.color="var(--background)"}if(r){const c=new Date(t.timestamp);r.textContent=ke(c)}V(e)}function Ht(){const t=document.getElementById("photo-viewer-modal");M(t),un=null}async function Il(){if(!un)return;const t=l.getState(),e=un;await Q.deletePhoto(e),l.updateEntry(e,{photo:void 0}),Ht(),w(f("photoDeleted",t.currentLang),"success"),In()}const fs=new O;let X=null;async function fn(t,e){const n=await Ms(t,e);return n.success&&bt(),n}async function kl(){Le()}function hs(t){return/^\d{4}$/.test(t)}function bt(){const t=l.getState().currentLang,e=Le(),n=document.getElementById("admin-pin-status"),i=document.getElementById("change-pin-btn-text");n&&(n.textContent=f(e?"pinSet":"pinNotSet",t)),i&&(i.textContent=f(e?"changePin":"setPin",t))}function Cl(){const t=l.getState().currentLang,e=Le(),n=document.getElementById("change-pin-modal"),i=document.getElementById("change-pin-modal-title"),s=document.getElementById("current-pin-row"),r=document.getElementById("current-pin-input"),a=document.getElementById("new-pin-input"),o=document.getElementById("confirm-pin-input");n&&(r&&(r.value=""),a&&(a.value=""),o&&(o.value=""),er(),e?(s&&(s.style.display="block"),i&&(i.textContent=f("changePin",t))):(s&&(s.style.display="none"),i&&(i.textContent=f("setPin",t))),V(n),e&&r?r.focus():a&&a.focus())}function er(){["current-pin-error","pin-mismatch-error","pin-format-error"].forEach(e=>{const n=document.getElementById(e);n&&(n.style.display="none")})}async function Tl(){const t=l.getState().currentLang,e=Le(),n=document.getElementById("current-pin-input"),i=document.getElementById("new-pin-input"),s=document.getElementById("confirm-pin-input"),r=document.getElementById("save-pin-btn"),a=document.getElementById("current-pin-error"),o=document.getElementById("pin-mismatch-error"),c=document.getElementById("pin-format-error");er();const u=(n==null?void 0:n.value)||"",d=(i==null?void 0:i.value)||"",h=(s==null?void 0:s.value)||"";if(!hs(d)){c&&(c.style.display="block"),i&&i.focus(),z();return}if(d!==h){o&&(o.style.display="block"),s&&(s.value="",s.focus()),z();return}if(e){if(!hs(u)){a&&(a.style.display="block"),n&&n.focus(),z();return}const m=(r==null?void 0:r.textContent)||"";r&&(r.disabled=!0,r.textContent=f("saving",t));try{const p=await fetch("/api/v1/admin/pin",{method:"POST",headers:{...le(),"Content-Type":"application/json"},body:JSON.stringify({currentPin:u,newPin:d})});if(p.status===401){a&&(a.style.display="block"),n&&(n.value="",n.focus()),z();return}if(!p.ok)throw new Error(`HTTP ${p.status}`);if($s(),!(await fn(d)).success){w(f("pinSyncFailed",t),"error"),z();return}const S=document.getElementById("change-pin-modal");M(S),w(f("pinSaved",t),"success"),G(),bt()}catch(p){gt("Admin","handleSavePin",p,"pinSyncFailed"),w(f("pinSyncFailed",t),"error"),z()}finally{r&&(r.disabled=!1,r.textContent=m)}}else{const m=(r==null?void 0:r.textContent)||"";r&&(r.disabled=!0,r.textContent=f("saving",t));try{if(!(await fn(d)).success){w(f("pinSyncFailed",t),"error"),z();return}const v=document.getElementById("change-pin-modal");M(v),w(f("pinSaved",t),"success"),G(),bt()}finally{r&&(r.disabled=!1,r.textContent=m)}}}function ii(t){return new Promise(e=>{if(Le()){e(!0);return}const n=document.getElementById("admin-pin-modal"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),r=document.getElementById("admin-pin-verify-input"),a=document.getElementById("admin-pin-error");if(!n||!r){e(!1);return}i&&(i.textContent=f("enterAdminPin",t)),s&&(s.textContent=f("enterPinToJoinRace",t)),a&&(a.style.display="none"),r.value="",X={type:"raceJoin",resolve:e},V(n),setTimeout(()=>r.focus(),100)})}function Ll(t){return new Promise(e=>{const n=document.getElementById("admin-pin-modal"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),r=document.getElementById("admin-pin-verify-input"),a=document.getElementById("admin-pin-error");if(!n||!r){e(!1);return}i&&(i.textContent=f("enterChiefJudgePin",t)),s&&(s.textContent=f("enterPinForChiefJudgeInfo",t)),a&&(a.style.display="none"),r.value="",X={type:"chiefJudge",resolve:e},V(n),setTimeout(()=>r.focus(),100)})}async function gs(){const t=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),n=document.getElementById("admin-pin-modal");if(!t||!n||!X)return;const i=t.value.trim(),s=X.type==="chiefJudge"?"chiefJudge":void 0;(await fn(i,s)).success?(M(n),t.value="",e&&(e.style.display="none"),X.resolve(!0),X=null):(e&&(e.style.display="block"),t.value="",t.focus(),z())}function Al(){const t=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input");M(t),e&&(e.value=""),X&&(X.resolve(!1),X=null)}function tr(){return X?(X.resolve(!1),X=null,!0):!1}function zt(){return X!==null}function Rl(){kl().then(()=>{bt()}).catch(i=>{y.error("Failed to initialize admin PIN:",i)}),bt();const t=document.getElementById("change-pin-btn");t&&fs.add(t,"click",Cl);const e=document.getElementById("save-pin-btn");e&&fs.add(e,"click",Tl),["admin-pin-verify-input","current-pin-input","new-pin-input","confirm-pin-input"].forEach(i=>{const s=document.getElementById(i);s&&Sn(s)})}const _n=new O,nr="/api/v1/admin/races";let Ut=null;function Dl(){const t=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input"),n=document.getElementById("admin-pin-error"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),r=l.getState().currentLang;t&&e&&n&&(e.value="",n.style.display="none",i&&(i.textContent=f("enterAdminPin",r)),s&&(s.textContent=f("enterPinText",r)),V(t),e.focus())}async function ms(){const t=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),n=document.getElementById("admin-pin-modal");if(!t||!n)return;const i=t.value.trim();(await fn(i)).success?(M(n),t.value="",e&&(e.style.display="none"),xl()):(e&&(e.style.display="block"),t.value="",t.focus(),z())}function xl(){const t=document.getElementById("race-management-modal");t&&(V(t),Ti())}async function Ti(){const t=document.getElementById("race-list"),e=document.getElementById("race-list-loading"),n=document.getElementById("race-list-empty"),i=l.getState().currentLang;if(t){t.setAttribute("aria-busy","true"),e&&(e.style.display="block"),n&&(n.style.display="none"),t.querySelectorAll(".race-item").forEach(s=>s.remove());try{const s=await ae(nr,{headers:le()},1e4);if(!s.ok){if(s.status===401){const o=document.getElementById("race-management-modal");M(o),w(f("authError",i),"error"),y.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${s.status}`)}const a=(await s.json()).races||[];if(t.setAttribute("aria-busy","false"),e&&(e.style.display="none"),a.length===0){n&&(n.style.display="block");return}a.forEach(o=>{const c=Bl(o,i);t.appendChild(c)})}catch(s){kn("Admin","loadRaceList",s,"loadError"),w(f("loadError",i),"error"),t.setAttribute("aria-busy","false"),e&&(e.style.display="none")}}}function Bl(t,e){const n=document.createElement("div");n.className="race-item",n.setAttribute("data-race-id",t.raceId);const i=document.createElement("div");i.className="race-info";const s=document.createElement("span");s.className="race-id",s.textContent=t.raceId.toUpperCase();const r=document.createElement("span");r.className="race-meta";const a=t.entryCount===1?f("entry",e):f("entries",e),o=t.deviceCount===1?f("device",e):f("devices",e);r.textContent=`${t.entryCount} ${a}, ${t.deviceCount} ${o}`,i.appendChild(s),i.appendChild(r);const c=document.createElement("button");return c.className="race-delete-btn danger",c.textContent=f("delete",e),c.addEventListener("click",()=>Pl(t.raceId)),n.appendChild(i),n.appendChild(c),n}function Pl(t){const e=l.getState().currentLang;Ut=t;const n=document.getElementById("delete-race-confirm-modal"),i=document.getElementById("delete-race-confirm-text");i&&(i.textContent=`${f("confirmDeleteRaceText",e)} "${t.toUpperCase()}"?`),n&&V(n)}async function Nl(){if(!Ut)return;const t=Ut,e=l.getState().currentLang,n=document.getElementById("delete-race-confirm-modal");M(n);try{const i=await ae(`${nr}?raceId=${encodeURIComponent(t)}`,{method:"DELETE",headers:le()},1e4);if(!i.ok){if(i.status===401){const r=document.getElementById("race-management-modal");M(r),w(f("authError",e),"error"),y.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${i.status}`)}const s=await i.json();if(s.success)w(`${f("raceDeletedSuccess",e)} ${t.toUpperCase()}`,"success"),In(),Ti();else throw new Error(s.error||f("unknownError",e))}catch(i){kn("Admin","deleteRace",i,"deleteError")}finally{Ut=null}}function Fl(){const t=document.getElementById("manage-races-btn");t&&_n.add(t,"click",Dl);const e=document.getElementById("refresh-races-btn");e&&_n.add(e,"click",Ti);const n=document.getElementById("confirm-delete-race-btn");n&&_n.add(n,"click",Nl)}const Gt=new O;function $l(t,e){return new Promise(n=>{const i=document.getElementById("race-change-modal");if(!i){n("cancel");return}const s=i.querySelector(".modal-title"),r=i.querySelector(".modal-text"),a=document.getElementById("race-change-export-btn"),o=document.getElementById("race-change-delete-btn"),c=document.getElementById("race-change-keep-btn"),u=i.querySelector('[data-action="cancel"]');t==="synced"?(s&&(s.textContent=f("raceChangeTitle",e)),r&&(r.textContent=f("raceChangeSyncedText",e)),a&&(a.style.display=""),c&&(c.style.display="none")):(s&&(s.textContent=f("raceChangeTitle",e)),r&&(r.textContent=f("raceChangeUnsyncedText",e)),a&&(a.style.display="none"),c&&(c.style.display=""));const d=()=>{M(i),a==null||a.removeEventListener("click",h),o==null||o.removeEventListener("click",m),c==null||c.removeEventListener("click",p),u==null||u.removeEventListener("click",v)},h=()=>{d(),n("export")},m=()=>{d(),n("delete")},p=()=>{d(),n("keep")},v=()=>{d(),n("cancel")};a==null||a.addEventListener("click",h),o==null||o.addEventListener("click",m),c==null||c.addEventListener("click",p),u==null||u.addEventListener("click",v),V(i)})}function ir(t){const{raceId:e,message:n}=t.detail,i=l.getState().currentLang,s=document.getElementById("race-deleted-text");s&&(s.textContent=`${f("raceDeletedFor",i)} "${e}". ${n||f("raceDeletedText",i)}`);const r=document.getElementById("race-deleted-modal");r&&V(r),l.updateSettings({sync:!1}),l.setRaceId("");const a=document.getElementById("sync-toggle");a&&(a.checked=!1);const o=document.getElementById("race-id-input");o&&(o.value=""),z()}function sr(t){const{message:e}=t.detail,n=l.getState().currentLang;w(e||f("sessionExpired",n),"warning",5e3),ii(n).then(i=>{if(i){const s=l.getState();s.settings.sync&&s.raceId&&$.initialize(),w(f("authSuccess",n),"success")}}).catch(i=>y.error("Re-auth failed:",i)),z()}async function Ml(){const t=document.getElementById("photo-sync-modal");if(!t)return;const e=l.getState().currentLang,n=document.getElementById("photos-upload-count"),i=document.getElementById("photos-download-count"),s=document.getElementById("photos-total-size");n&&(n.textContent=f("loading",e)),i&&(i.textContent=f("loading",e)),s&&(s.textContent=f("loading",e)),V(t);const r=await $.getPhotoSyncStats();n&&(n.textContent=String(r.uploadCount)),i&&(i.textContent=String(r.downloadCount)),s&&(s.textContent=ac(r.totalSize));const a=document.getElementById("photo-sync-confirm-btn");a&&(a.textContent=f("enableSync",e))}function Ol(){const t=document.getElementById("photo-sync-modal"),e=document.getElementById("photo-sync-cancel-btn"),n=document.getElementById("photo-sync-confirm-btn");e&&Gt.add(e,"click",()=>{M(t)}),n&&Gt.add(n,"click",()=>{l.updateSettings({syncPhotos:!0});const i=document.getElementById("sync-photos-toggle");i&&(i.checked=!0),M(t);const s=l.getState();s.settings.sync&&s.raceId&&$.forceRefresh(),G()}),t&&Gt.add(t,"click",i=>{i.target===t&&M(t)})}function Vl(){const t=document.getElementById("race-deleted-ok-btn");t&&Gt.add(t,"click",()=>{const e=document.getElementById("race-deleted-modal");M(e)}),Ol()}const Hn=new O;function _l(){Rl(),Fl(),Vl();const t=document.getElementById("admin-pin-verify-btn");t&&Hn.add(t,"click",()=>{zt()?gs():ms()});const e=document.getElementById("admin-pin-verify-input");e&&Hn.add(e,"keydown",i=>{i.key==="Enter"&&(zt()?gs():ms())});const n=document.getElementById("admin-pin-modal");n&&Hn.add(n,"click",i=>{i.target===n&&zt()&&Al()})}function Hl(t,e){t&&(ot(t,e),V(t))}function zl(t,e,n,i){t&&t.querySelectorAll(e).forEach(s=>{const r=s.getAttribute(n)===i;s.classList.toggle("active",r)})}const ue=new O;function Ul(){document.querySelectorAll(".modal-overlay").forEach(u=>{ue.add(u,"click",d=>{d.target===u&&St()})}),document.querySelectorAll('[data-action="cancel"]').forEach(u=>{ue.add(u,"click",St)});const t=document.getElementById("confirm-delete-btn");t&&ue.add(t,"click",Jl);const e=document.getElementById("confirm-fault-delete-btn");e&&ue.add(e,"click",()=>{var h;const u=document.getElementById("fault-delete-modal"),d=u?(h=tt(u))==null?void 0:h.faultId:void 0;if(d){l.markFaultForDeletion(d);const m=l.getState().faultEntries.find(p=>p.id===d);m&&Ei(m),Cn(),w(f("faultDeleted",l.getState().currentLang),"success")}M(u)});const n=document.getElementById("save-edit-btn");n&&ue.add(n,"click",jl);const i=document.getElementById("edit-bib-input");i&&Sn(i,3);const s=document.getElementById("edit-run-selector");s&&ue.add(s,"click",u=>{const h=u.target.closest(".edit-run-btn");if(!h)return;const m=document.getElementById("edit-modal"),p=h.getAttribute("data-run")||"1";if(m){const v=tt(m)||{entryId:"",entryRun:1};ot(m,{...v,entryRun:parseInt(p,10)})}document.querySelectorAll(".edit-run-btn").forEach(v=>{v.classList.toggle("active",v===h)})});const r=document.getElementById("photo-viewer-close-btn");r&&ue.add(r,"click",Ht);const a=document.getElementById("photo-viewer-close-footer-btn");a&&ue.add(a,"click",Ht);const o=document.getElementById("photo-viewer-delete-btn");o&&ue.add(o,"click",Il);const c=document.getElementById("photo-viewer-modal");c&&ue.add(c,"click",u=>{u.target===c&&Ht()}),dl()}function Gl(t){const e=document.getElementById("edit-modal");if(!e)return;const n=t.run??1,i=document.getElementById("edit-bib-input"),s=document.getElementById("edit-status-select");i&&(i.value=t.bib||""),s&&(s.value=t.status),zl(document.body,".edit-run-btn","data-run",String(n)),Hl(e,{entryId:t.id,entryRun:n})}function rr(t){const e=document.getElementById("confirm-modal");if(!e)return;const n=l.getState().currentLang,i=e.querySelector(".modal-title"),s=e.querySelector(".modal-text"),r=tt(e)||{};if(ot(e,{...r,action:t}),t==="clearAll")i&&(i.textContent=f("confirmClearAll",n)),s&&(s.textContent=f("clearAllText",n));else if(t==="deleteSelected"){const a=l.getState().selectedEntries.size,o=f(a===1?"entry":"entries",n);i&&(i.textContent=f("confirmDelete",n)),s&&(s.textContent=`${a} ${o} ${f("selected",n)}`)}else t==="undoAdd"?(i&&(i.textContent=f("confirmUndoAdd",n)),s&&(s.textContent=f("confirmUndoAddText",n))):(i&&(i.textContent=f("confirmDelete",n)),s&&(s.textContent=f("confirmDeleteText",n)));V(e)}function ql(t){const e=document.getElementById("confirm-modal");e&&ot(e,{action:"delete",entryId:t.id}),rr("delete")}async function Jl(){const t=document.getElementById("confirm-modal");if(!t)return;const e=tt(t),n=e==null?void 0:e.action,i=e==null?void 0:e.entryId,s=l.getState();if(n==="clearAll"){const r=[...s.entries];if(l.clearAll(),await Q.clearAll(),s.settings.sync&&s.raceId)for(const a of r)$.deleteEntryFromCloud(a.id,a.deviceId);w(f("cleared",s.currentLang),"success")}else if(n==="deleteSelected"){const r=Array.from(s.selectedEntries),a=s.entries.filter(o=>r.includes(o.id));await us(a),w(f("deleted",s.currentLang),"success")}else if(n==="undoAdd"){const r=l.undo();if(ti(),w(f("undone",s.currentLang),"success"),r&&r.type==="ADD_ENTRY"){const a=r.data;await Q.deletePhoto(a.id),s.settings.sync&&s.raceId&&$.deleteEntryFromCloud(a.id,a.deviceId)}St();return}else if(i){const r=s.entries.find(c=>c.id===i);r&&await us([r]);const a=s.currentLang;Zc();const o={label:f("undoAction",a),callback:()=>{if(l.canUndo()){const c=l.undo();if(ti(),c&&c.type==="DELETE_ENTRY"){const u=c.data;xc(u).catch(()=>{})}}}};w(f("entryDeleted",a),"success",5e3,{action:o})}In(),St()}function jl(){const t=document.getElementById("edit-modal");if(!t)return;const e=tt(t),n=e==null?void 0:e.entryId;if(!n)return;const i=document.getElementById("edit-bib-input"),s=document.getElementById("edit-status-select"),r=(e==null?void 0:e.entryRun)??1;l.updateEntry(n,{bib:(i==null?void 0:i.value.padStart(3,"0"))||"",status:s==null?void 0:s.value,run:r}),w(f("saved",l.getState().currentLang),"success"),St()}function St(){const t=document.getElementById("admin-pin-modal");if(t!=null&&t.classList.contains("show")&&zt()){tr();const e=document.getElementById("admin-pin-verify-input");e&&(e.value="")}document.querySelectorAll(".modal-overlay").forEach(e=>{il(e)}),cl()}const se=new O;let Je=null,Et="",qt=null,Jt=null,ps=null;const hn=500;function Wl(t){const e=document.getElementById("voice-note-modal");if(!e)return;Je=t,Et="";const i=l.getState().faultEntries.find(a=>a.id===t),s=document.getElementById("voice-note-textarea");s&&(s.value=(i==null?void 0:i.notes)||"",Ai());const r=document.getElementById("voice-note-mic-btn");r&&(r.classList.toggle("unsupported",!j.isSupported()),r.classList.remove("loading")),Li(!1),j.isSupported()&&j.initialize(),V(e),requestAnimationFrame(()=>s==null?void 0:s.focus())}function lt(){j.stop(),ar(),Je=null,Et="",M(document.getElementById("voice-note-modal")),H.resume()}function Ql(){if(!Je)return;const t=document.getElementById("voice-note-textarea"),e=(t==null?void 0:t.value.trim().slice(0,hn))||"",n=l.getState();if(!n.faultEntries.find(o=>o.id===Je))return;const s=Et?"voice":"manual",r=e?`notes: ${e.slice(0,30)}${e.length>30?"...":""}`:"notes removed";if(l.updateFaultEntryWithHistory(Je,{notes:e||void 0,notesSource:e?s:void 0,notesTimestamp:e?new Date().toISOString():void 0},r)){const o=l.getState().faultEntries.find(u=>u.id===Je);o&&at(o);const c=n.currentLang;w(f("noteSaved",c),"success"),G()}lt()}function Yl(){const t=l.getState().currentLang;if(!j.isSupported()){w(f("voiceNoteUnsupported",t),"warning");return}const e=document.getElementById("voice-note-mic-btn");e==null||e.classList.add("loading"),H.pause(),qt=j.onStatusChange(i=>{e==null||e.classList.remove("loading"),Li(i==="listening"),i==="error"&&(w(f("voiceNoteError",t),"warning"),H.resume())}),Jt=j.onTranscript((i,s)=>{const r=document.getElementById("voice-note-textarea");if(r&&s){Et+=(Et?" ":"")+i;const a=r.value,o=a?`${a} ${i}`:i;r.value=o.slice(0,hn),Ai()}}),j.start()?I():(e==null||e.classList.remove("loading"),H.resume())}function Kl(){j.stop(),ar(),Li(!1),H.resume()}function Zl(){j.isRecording()?Kl():Yl()}function Li(t){const e=document.getElementById("voice-note-listening-indicator"),n=document.getElementById("voice-note-mic-btn");e&&e.classList.toggle("active",t),n&&(n.classList.toggle("recording",t),n.setAttribute("aria-pressed",String(t)))}function Ai(){const t=document.getElementById("voice-note-textarea"),e=document.getElementById("voice-note-char-count");if(t&&e){const n=t.value.length;e.textContent=`${n}/${hn}`,e.classList.toggle("near-limit",n>hn*.9)}}function ar(){qt&&(qt(),qt=null),Jt&&(Jt(),Jt=null)}function Xl(){const t=document.getElementById("voice-note-modal"),e=document.getElementById("voice-note-mic-btn");e&&se.add(e,"click",Zl);const n=document.getElementById("voice-note-save-btn");n&&se.add(n,"click",Ql);const i=document.getElementById("voice-note-cancel-btn");i&&se.add(i,"click",lt);const s=document.getElementById("voice-note-close-btn");s&&se.add(s,"click",lt);const r=document.getElementById("voice-note-textarea");r&&se.add(r,"input",Ai),t&&(se.add(t,"keydown",a=>{a.key==="Escape"&&(a.preventDefault(),lt())}),se.add(t,"click",a=>{a.target===t&&lt()}))}function Vt(){const t=document.getElementById("fault-confirmation-overlay");t!=null&&t.classList.contains("show")&&t.classList.remove("show")}function ed(){const t=document.getElementById("fault-confirmation-overlay"),e=t==null?void 0:t.querySelector(".fault-confirmation-content"),n=document.getElementById("fault-confirmation-add-note-btn");n&&se.add(n,"click",()=>{var r;I();const s=t?((r=tt(t))==null?void 0:r.faultId)||t.getAttribute("data-fault-id"):void 0;Vt(),s&&Wl(s)});const i=document.getElementById("fault-confirmation-done-btn");i&&se.add(i,"click",()=>{I(),Vt()}),t&&e&&se.add(t,"click",s=>{s.target===t&&(I(),Vt())}),t&&se.add(document,"keydown",s=>{s.key==="Escape"&&t.classList.contains("show")&&!qs()&&(s.preventDefault(),Vt())})}function td(){let t=!1,e=null,n=null;const i=()=>{e&&(e(),e=null),n&&(n(),n=null)};se.add(window,"fault-edit-mic-click",()=>{const r=l.getState().currentLang,a=document.getElementById("fault-edit-mic-btn"),o=document.getElementById("fault-edit-notes"),c=document.getElementById("fault-edit-notes-char-count");if(!j.isSupported()){w(f("voiceNoteUnsupported",r),"warning");return}if(t){j.stop(),i(),t=!1,a==null||a.classList.remove("recording"),a==null||a.setAttribute("aria-pressed","false"),H.resume();return}H.pause(),e=j.onStatusChange(d=>{d==="error"&&(w(f("voiceNoteError",r),"warning"),i(),t=!1,a==null||a.classList.remove("recording"),a==null||a.setAttribute("aria-pressed","false"),H.resume())}),n=j.onTranscript((d,h)=>{if(h&&o){const m=o.value,p=m?`${m} ${d}`:d;if(o.value=p.slice(0,500),c){const v=o.value.length;c.textContent=`${v}/500`,c.classList.toggle("near-limit",v>450)}}}),j.start()?(t=!0,a==null||a.classList.add("recording"),a==null||a.setAttribute("aria-pressed","true"),I()):H.resume()});const s=document.getElementById("fault-edit-modal");s&&(ps=new MutationObserver(r=>{for(const a of r)if(a.type==="attributes"&&a.attributeName==="class"&&!(s.classList.contains("show")||s.style.display!=="none")&&t){j.stop(),i(),t=!1;const c=document.getElementById("fault-edit-mic-btn");c==null||c.classList.remove("recording"),c==null||c.setAttribute("aria-pressed","false"),H.resume()}}),ps.observe(s,{attributes:!0}))}function nd(){Xl(),ed(),td()}const Ne=new O;function Tn(){const t=b("timer-tab"),e=b("gate-judge-tab"),n=document.querySelector(".tab-bar"),s=l.getState().deviceRole==="gateJudge";t&&(t.style.display=s?"none":""),e&&(e.style.display=s?"":"none"),n&&n.classList.toggle("gate-judge-mode",s)}function id(){Ne.removeAll(),window.dispatchEvent(new CustomEvent("update-role-toggle")),Tn();const t=b("gate-change-btn");t&&Ne.add(t,"click",()=>{I(),or()});const e=b("gate-judge-run-selector");e&&Ne.add(e,"click",i=>{const r=i.target.closest(".run-btn");if(!r)return;const a=r.getAttribute("data-run"),o=a?parseInt(a,10):1;l.setSelectedRun(o),I(),e.querySelectorAll(".run-btn").forEach(c=>{c.classList.toggle("active",c===r),c.setAttribute("aria-checked",c===r?"true":"false")}),we(),vt()});const n=b("ready-toggle-btn");n&&(Ne.add(n,"click",()=>{const i=l.getState(),s=!i.isJudgeReady;l.setJudgeReady(s),G(),gn();const r=i.currentLang;w(f(s?"judgeReady":"judgeNotReady",r),"success")}),gn()),cr(),Ks(),yl(),vt(),nd(),Lt()}function or(){const t=l.getState(),e=b("gate-start-input"),n=b("gate-end-input");e&&n&&(t.gateAssignment?(e.value=String(t.gateAssignment[0]),n.value=String(t.gateAssignment[1])):(e.value="1",n.value="10"));const i=b("gate-color-selector");i&&i.querySelectorAll(".gate-color-btn").forEach(s=>{const a=s.getAttribute("data-color")===t.firstGateColor;s.classList.toggle("active",a),s.setAttribute("aria-checked",String(a))}),V(b("gate-assignment-modal"))}function cr(){const t=b("gate-color-selector");t&&Ne.add(t,"click",n=>{const i=n.target.closest(".gate-color-btn");i&&(t.querySelectorAll(".gate-color-btn").forEach(s=>{s.classList.remove("active"),s.setAttribute("aria-checked","false")}),i.classList.add("active"),i.setAttribute("aria-checked","true"),I())});const e=b("save-gate-assignment-btn");e&&Ne.add(e,"click",()=>{const n=b("gate-start-input"),i=b("gate-end-input");if(!n||!i)return;const s=parseInt(n.value,10)||1,r=parseInt(i.value,10)||10,a=Math.min(s,r),o=Math.max(s,r),c=document.querySelector("#gate-color-selector .gate-color-btn.active"),u=(c==null?void 0:c.getAttribute("data-color"))||"red";l.setGateAssignment([a,o]),l.setFirstGateColor(u),Lt(),M(b("gate-assignment-modal")),G();const d=l.getState().currentLang;w(f("saved",d),"success")})}function Lt(){const t=b("gate-range-display"),e=b("gate-color-indicator"),n=b("gate-color-text");if(!t)return;const i=l.getState();if(i.gateAssignment?t.textContent=`${i.gateAssignment[0]}–${i.gateAssignment[1]}`:t.textContent="--",e&&n){const s=i.currentLang,r=i.firstGateColor==="red"?"colorRed":"colorBlue";n.textContent=`${f("firstGateLabel",s)}: ${f(r,s)}`,e.classList.toggle("red",i.firstGateColor==="red"),e.classList.toggle("blue",i.firstGateColor==="blue")}lr()}function lr(){const t=b("other-judges-coverage"),e=b("other-judges-list");if(!t||!e)return;if(!l.getState().settings.sync){t.style.display="none";return}const i=$.getOtherGateAssignments();if(i.length===0){t.style.display="none";return}t.style.display="flex";const s=l.getState().currentLang;e.innerHTML=i.map(r=>`
    <div class="coverage-badge ${r.isReady?"ready":""}" title="${L(r.deviceName)}${r.isReady?f("readySuffix",s):""}">
      ${r.isReady?`<span class="ready-check" aria-hidden="true">${yt(14)}</span>`:""}
      <span class="device-name">${T(r.deviceName.slice(0,15))}</span>
      <span class="gate-range">${r.gateStart}–${r.gateEnd}</span>
    </div>
  `).join(""),dr(i),Fe()}function gn(){const t=b("ready-toggle-btn");if(!t)return;const e=l.getState();t.classList.toggle("ready",e.isJudgeReady),t.setAttribute("aria-pressed",String(e.isJudgeReady))}function dr(t){const e=b("judges-ready-indicator"),n=b("judges-ready-count");if(!e||!n)return;const i=l.getState();if(!i.settings.sync){e.style.display="none";return}const s=t||$.getOtherGateAssignments();let r=s.length,a=s.filter(o=>o.isReady).length;if(i.deviceRole==="gateJudge"&&i.gateAssignment&&(r++,i.isJudgeReady&&a++),r===0){e.style.display="none";return}e.style.display="flex",n.textContent=`${a}/${r}`,e.classList.toggle("all-ready",a===r&&r>0)}function Fe(){const t=b("gps-indicator"),e=b("judge-ready-indicator");if(!e)return;const n=l.getState(),i=n.deviceRole==="gateJudge";if(t&&(t.style.display=!i&&n.settings.gps?"flex":"none"),!i){e.style.display="none";return}e.style.display="flex";const s=$.getOtherGateAssignments();let r=s.length,a=s.filter(o=>o.isReady).length;n.gateAssignment&&(r++,n.isJudgeReady&&a++),e.classList.remove("none-ready","some-ready","all-ready"),a===0||r===0?e.classList.add("none-ready"):a===r?e.classList.add("all-ready"):e.classList.add("some-ready")}function Ln(){const t=l.getState(),e=b("gate-judge-run-selector");e&&e.querySelectorAll(".run-btn").forEach(n=>{const i=n.getAttribute("data-run")===String(t.selectedRun);n.classList.toggle("active",i),n.setAttribute("aria-checked",String(i))})}function ur(t){var e,n,i,s;switch(y.debug("[GateJudgeView] Voice intent:",t.action,t.params),t.action){case"record_fault":(e=t.params)!=null&&e.bib&&((n=t.params)==null?void 0:n.gate)!==void 0&&((i=t.params)!=null&&i.faultType)&&Xs(t.params.bib,t.params.gate,t.params.faultType);break;case"toggle_ready":{const r=l.getState(),a=!r.isJudgeReady;l.setJudgeReady(a),G(),gn();const o=r.currentLang;w(f(a?"judgeReady":"judgeNotReady",o),"success");break}case"set_run":(s=t.params)!=null&&s.run&&(l.setSelectedRun(t.params.run),Ln(),we(),vt(),I());break;default:y.debug("[GateJudgeView] Unhandled voice intent:",t.action)}}function sd(){Ne.removeAll()}const rd=Object.freeze(Object.defineProperty({__proto__:null,cleanupGateJudgeView:sd,handleGateJudgeVoiceIntent:ur,initGateAssignmentModal:cr,initGateJudgeView:id,openGateAssignmentModal:or,updateGateJudgeRunSelection:Ln,updateGateJudgeTabVisibility:Tn,updateGateRangeDisplay:Lt,updateJudgeReadyStatus:Fe,updateJudgesReadyIndicator:dr,updateOtherJudgesCoverage:lr,updateReadyButtonState:gn},Symbol.toStringTag,{value:"Module"}));function fr(t){const{bib:e,point:n,run:i,deviceId:s,deviceName:r,gpsService:a}=t,o=a.getTimeOffset();let c,u;o!==null?(c=new Date(Date.now()+o).toISOString(),u="gps"):(c=new Date().toISOString(),u="system");const d=a.getCoordinates(),h=a.getTimestamp()??void 0;return{entry:{id:Qr(s),bib:e?e.padStart(3,"0"):"",point:n,run:i,timestamp:c,status:"ok",deviceId:s,deviceName:r,gpsCoords:d,timeSource:u,gpsTimestamp:h},timeSource:u}}function hr(t,e){return!!(t.bib&&e.some(n=>n.bib===t.bib&&n.point===t.point&&(n.run??1)===t.run))}const gr=0,ad=1,od=3,cd={normal:gr,low:ad,critical:od},Ve=new O;let D=null,ie=null,zn=gr,ys=0,mn=null,si=!1,jt=null,Wt=null;function ld(){if(!b("dial-container")){y.debug("[RadialTimerView] Dial container not found, skipping init");return}if(si){y.debug("[RadialTimerView] Already initialized");return}y.debug("[RadialTimerView] Initializing..."),dd(),ud(),fd(),hd(),gd(),md(),pd(),Un(),Gn(),ri(),jt=l.subscribe((e,n)=>{n.includes("settings")&&(Un(),Gn()),(n.includes("syncStatus")||n.includes("cloudDeviceCount"))&&Gn(),n.includes("selectedPoint")&&wt(),n.includes("selectedRun")&&pn(),n.includes("entries")&&ri(),n.includes("gpsStatus")&&Un()}),si=!0,y.debug("[RadialTimerView] Initialized successfully")}function dd(){const t=()=>{if(mn)return;const n=new Date,i=String(n.getHours()).padStart(2,"0"),s=String(n.getMinutes()).padStart(2,"0"),r=String(n.getSeconds()).padStart(2,"0"),a=String(n.getMilliseconds()).padStart(3,"0"),o=b("radial-time-hm"),c=b("radial-time-seconds"),u=b("radial-time-subseconds");o&&(o.textContent=`${i}:${s}`),c&&(c.textContent=r),u&&(u.textContent=a)},e=()=>{ys++,(zn===0||ys%(zn+1)===0)&&t(),ie=requestAnimationFrame(e)};ie!==null&&cancelAnimationFrame(ie),W.initialize().then(()=>{Wt=W.subscribe(n=>{zn=cd[n.batteryLevel]})}).catch(()=>{}),Ve.add(document,"visibilitychange",()=>{document.hidden?ie!==null&&(cancelAnimationFrame(ie),ie=null):ie===null&&(ie=requestAnimationFrame(e))}),t(),ie=requestAnimationFrame(e)}function ud(){const t=b("dial-container");if(!t)return;D&&D.destroy(),D=new Wc(t,{onChange:n=>{l.setBibInput(n),ye(n)},momentum:1.5,friction:.97,sensitivity:24});const e=l.getState();e.bibInput&&(D.setValue(e.bibInput),ye(e.bibInput))}function ye(t){const e=b("radial-bib-value");if(!e)return;const n='<span class="radial-bib-cursor"></span>';if(!t)e.innerHTML=`---${n}`,e.classList.remove("active");else{const i=T(t.padStart(3,"0"));e.innerHTML=i+(t.length<3?n:""),e.classList.add("active")}}function fd(){const t=b("radial-timing-point");t&&(Ve.add(t,"click",e=>{const i=e.target.closest(".radial-point-btn");if(!i)return;const s=i.getAttribute("data-point");s&&(l.setSelectedPoint(s),I(),wt())}),wt())}function wt(){const t=l.getState();document.querySelectorAll(".radial-point-btn").forEach(e=>{const n=e.getAttribute("data-point")===t.selectedPoint;e.classList.toggle("active",n),e.setAttribute("aria-checked",String(n))})}function hd(){const t=b("radial-run-selector");t&&(Ve.add(t,"click",e=>{const i=e.target.closest(".radial-run-btn");if(!i)return;const s=i.getAttribute("data-run");if(s){const r=parseInt(s,10);l.setSelectedRun(r),I(),pn()}}),pn())}function pn(){const t=l.getState();document.querySelectorAll(".radial-run-btn").forEach(e=>{const i=e.getAttribute("data-run")===String(t.selectedRun);e.classList.toggle("active",i),e.setAttribute("aria-checked",String(i))})}function gd(){const t=b("radial-time-btn");t&&Ve.add(t,"click",mr)}function md(){const t=b("radial-clear-btn");t&&Ve.add(t,"click",()=>{D==null||D.clear(),l.setBibInput(""),ye(""),I(),t.classList.add("flash"),setTimeout(()=>t.classList.remove("flash"),150)})}function pd(){Ve.add(document,"keydown",t=>{var i;const e=(i=document.activeElement)==null?void 0:i.tagName,n=l.getState();if(!(e==="INPUT"||e==="TEXTAREA"||e==="SELECT")&&n.currentView==="timer"){if(/^[0-9]$/.test(t.key)){t.preventDefault();const s=n.bibInput;if(s.length<3){const r=s+t.key;l.setBibInput(r),D==null||D.setValue(r),ye(r),I()}return}if(t.key==="Backspace"){t.preventDefault();const s=n.bibInput.slice(0,-1);l.setBibInput(s),D==null||D.setValue(s),ye(s),I();return}if(t.key==="Delete"||t.key==="Escape"){t.preventDefault(),D==null||D.clear(),l.setBibInput(""),ye(""),I();return}if(t.key==="s"||t.key==="S"){t.preventDefault(),l.setSelectedPoint("S"),I(),wt();return}if(t.key==="f"||t.key==="F"){t.preventDefault(),l.setSelectedPoint("F"),I(),wt();return}if(t.altKey&&(t.key==="1"||t.key==="2")){t.preventDefault();const s=t.key==="1"?1:2;l.setSelectedRun(s),I(),pn();return}if(t.key===" "||t.key==="Enter"){t.preventDefault(),mr();return}}})}async function mr(){const t=l.getState();if(t.isRecording)return;const{entry:e}=fr({bib:t.bibInput,point:t.selectedPoint,run:t.selectedRun,deviceId:t.deviceId,deviceName:t.deviceName,gpsService:me});l.setRecording(!0);try{t.settings.photoCapture&&Ns().then(async i=>{if(i)try{await Q.savePhoto(e.id,i)&&l.updateEntry(e.id,{photo:"indexeddb"})}catch(s){gt("Camera","photo save",s,"photoError")}}).catch(i=>{gt("Camera","captureTimingPhoto",i,"photoError")});const n=hr(e,t.entries);if(l.addEntry(e),n?z():G(),yd(e),$.broadcastEntry(e),t.settings.auto&&t.bibInput){const i=parseInt(t.bibInput,10)+1,s=t.settings.sync&&t.cloudHighestBib>0?Math.max(i,t.cloudHighestBib+1):i,r=String(s);l.setBibInput(r),D==null||D.setValue(r),ye(r)}else t.bibInput&&!t.settings.auto&&(l.setBibInput(""),D==null||D.clear(),ye(""));ri()}finally{l.setRecording(!1)}}function yd(t){const e=new Date(t.timestamp),n=String(e.getHours()).padStart(2,"0"),i=String(e.getMinutes()).padStart(2,"0"),s=String(e.getSeconds()).padStart(2,"0"),r=String(e.getMilliseconds()).padStart(3,"0"),a=`${n}:${i}:${s}.${r}`;mn=a;const o=b("radial-time-hm"),c=b("radial-time-seconds"),u=b("radial-time-subseconds");o&&(o.textContent=`${n}:${i}`),c&&(c.textContent=s),u&&(u.textContent=r);const d=b("dial-ring"),h=b("radial-time-display"),m=b("radial-time-btn");d==null||d.classList.add("flash"),h==null||h.classList.add("flash","frozen"),m==null||m.classList.add("flash"),D==null||D.flash();const p=b("radial-confirmation-overlay"),v=b("radial-confirm-bib"),S=b("radial-confirm-time"),E=b("radial-confirm-point");if(v&&(v.textContent=t.bib||"---"),S&&(S.textContent=a),E){const k=l.getState();E.textContent=Ce(t.point,k.currentLang),E.className=`radial-confirmation-point ${t.point==="S"?"start":"finish"}`}p==null||p.classList.add("show"),setTimeout(()=>{mn=null,d==null||d.classList.remove("flash"),h==null||h.classList.remove("flash","frozen"),m==null||m.classList.remove("flash"),p==null||p.classList.remove("show")},1200)}function Un(){const t=l.getState(),e=b("radial-gps-status");if(!e)return;const n=e.querySelector(".radial-status-dot");n&&(t.settings.gps?t.gpsStatus==="active"?n.className="radial-status-dot":t.gpsStatus==="searching"?n.className="radial-status-dot warning":n.className="radial-status-dot inactive":n.className="radial-status-dot inactive")}function Gn(){const t=l.getState(),e=b("radial-sync-status");if(!e)return;if(!t.settings.sync){e.style.display="none";return}e.style.display="flex";const n=e.querySelector(".radial-status-dot"),i=e.querySelector(".radial-sync-text");if(n&&(t.syncStatus==="connected"?n.className="radial-status-dot":t.syncStatus==="error"?n.className="radial-status-dot error":n.className="radial-status-dot warning"),i){const s=t.cloudDeviceCount||0,r=t.currentLang;i.textContent=s>0?`${f("synced",r)} (${s})`:f("syncingStatus",r)}}function ri(){const t=l.getState(),e=t.entries,n=b("radial-stats-count");if(n&&(n.textContent=`${e.length} ${e.length===1?f("entry",t.currentLang):f("entries",t.currentLang)}`),e.length>0){const i=e[e.length-1],s=b("radial-last-bib"),r=b("radial-last-point"),a=b("radial-last-time");if(s&&(s.textContent=i.bib||"---"),r&&(r.textContent=i.point==="S"?f("startShort",t.currentLang):f("finishShort",t.currentLang),r.className=`radial-stats-point ${i.point==="S"?"start":"finish"}`),a){const o=new Date(i.timestamp);a.textContent=ke(o)}}}function vd(){jt&&(jt(),jt=null),ie!==null&&(cancelAnimationFrame(ie),ie=null),Wt&&(Wt(),Wt=null),Ve.removeAll(),D&&(D.destroy(),D=null),mn=null,si=!1}function pr(){const t=l.getState();ye(t.bibInput),D==null||D.setValue(t.bibInput)}function yn(){const t=document.querySelector(".timer-view");return(t==null?void 0:t.classList.contains("radial-mode"))??!1}function bd(t){const e=new Date(t);let n=e.getHours(),i=e.getMinutes(),s=e.getSeconds(),r=Math.round(e.getMilliseconds()/10);return r>=100&&(r=0,s++,s>=60&&(s=0,i++),i>=60&&(i=0,n++),n>=24&&(n=0)),`${String(n).padStart(2,"0")}:${String(i).padStart(2,"0")}:${String(s).padStart(2,"0")},${String(r).padStart(2,"0")}`}function qn(t){const e=["=","+","-","@","|","	","\r",`
`];let n=t;return e.some(i=>n.startsWith(i))&&(n=`'${n}`),/^[+]?0x/i.test(n)&&(n=`'${n}`),n.includes('"')&&(n=n.replace(/"/g,'""')),(n.includes(";")||n.includes('"')||n.includes(`
`)||n.includes("|"))&&(n=`"${n}"`),n}function Sd(t){const e=new Date(t),n=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${n}-${i}-${s}`}function Ed(t){return t==="S"?"ST":"FT"}function Jn(t,e){var i;return((i={ok:{en:"OK",de:"OK"},dns:{en:"DNS",de:"DNS"},dnf:{en:"DNF",de:"DNF"},dsq:{en:"DSQ",de:"DSQ"},flt:{en:"FLT",de:"STR"}}[t])==null?void 0:i[e])||t.toUpperCase()}function wd(t){return t.length===0?"":t.sort((e,n)=>e.gateNumber-n.gateNumber).map(e=>`T${e.gateNumber}(${e.faultType})`).join(",")}function Ri(){const t=l.getState(),e=t.entries,n=t.faultEntries,i=t.currentLang;if(e.length===0){w(f("noEntries",i),"warning");return}try{const s=[...e].sort((v,S)=>new Date(v.timestamp).getTime()-new Date(S.timestamp).getTime()),r=n.length>0,a=r?"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Torstrafzeit;Torfehler;Datum":"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Datum",o=s.map(v=>{const S=qn(v.bib),E=v.run??1,k=Ed(v.point),C=bd(v.timestamp),_=qn(v.deviceName||v.deviceId),q=qn(Sd(v.timestamp)),N=v.point==="F"?n.filter(R=>R.bib===v.bib&&R.run===E):[];let A;if(v.point==="F"&&N.length>0?A=t.usePenaltyMode?Jn("flt",i):Jn("dsq",i):A=Jn(v.status,i),r){const R=N.length>0&&t.usePenaltyMode?N.length*t.penaltySeconds:0,x=wd(N);return`${S};${E};${k};${C};${A};${_};${R};${x};${q}`}else return`${S};${E};${k};${C};${A};${_};${q}`}),c=[a,...o].join(`
`),u=new Blob([c],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(u),h=document.createElement("a");h.href=d;const m=new Date().toISOString().split("T")[0],p=t.raceId||"race";h.download=`${p}_${m}.csv`,document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(d),G(),w(f("exported",i),"success")}catch(s){y.error("CSV export failed:",s),w(f("operationFailed",i),"error")}}function ai(t,e="csv"){const n=new Date().toISOString().split("T")[0];return`${t.replace(/[^a-zA-Z0-9-_]/g,"_")||"race"}_${n}.${e}`}function Id(){const t=l.getState(),e=t.currentLang,n=t.faultEntries,i=t.raceId||"RACE";if(n.length===0){w(f("noFaultsToExport",e),"warning");return}const s=new Map;for(const h of n){const m=`${h.bib}-${h.run}`;s.has(m)||s.set(m,[]),s.get(m).push(h)}const r=[];r.push(`📋 ${f("gateFaults",e)} - ${i}`),r.push("");const a=Array.from(s.entries()).filter(([h])=>h.endsWith("-1")),o=Array.from(s.entries()).filter(([h])=>h.endsWith("-2")),c=(h,m)=>{const[p]=h.split("-"),v=p.padStart(3,"0"),S=m.sort((k,C)=>k.gateNumber-C.gateNumber).map(k=>`T${k.gateNumber}`).join("+"),E=m.map(k=>k.faultType).join(", ");if(t.usePenaltyMode){const k=m.length*t.penaltySeconds;return`#${v}: ${S} (${E}) → +${k}s`}else return`#${v}: ${S} (${E})`};a.length>0&&(r.push(`🏁 ${f("runLabel",e)} 1:`),t.usePenaltyMode?r.push(`🟡 ${f("penaltyLabel",e)}:`):r.push(`🔴 ${f("dsq",e)}:`),a.sort((h,m)=>parseInt(h[0].split("-")[0],10)-parseInt(m[0].split("-")[0],10)).forEach(([h,m])=>{r.push(c(h,m))}),r.push("")),o.length>0&&(r.push(`🏁 ${f("runLabel",e)} 2:`),t.usePenaltyMode?r.push(`🟡 ${f("penaltyLabel",e)}:`):r.push(`🔴 ${f("dsq",e)}:`),o.sort((h,m)=>parseInt(h[0].split("-")[0],10)-parseInt(m[0].split("-")[0],10)).forEach(([h,m])=>{r.push(c(h,m))}),r.push(""));const u=new Date;r.push(`📅 ${u.toLocaleDateString(e==="de"?"de-DE":"en-US")} ${u.toLocaleTimeString(e==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"})}`);const d=r.join(`
`);navigator.clipboard?navigator.clipboard.writeText(d).then(()=>{G(),w(f("copiedToClipboard",e),"success")}).catch(()=>{oi(d,ai(`${i}_WhatsApp`,"txt"))}):oi(d,ai(`${i}_WhatsApp`,"txt"))}function kd(){const t=l.getState(),e=t.currentLang,n=t.faultEntries,i=t.raceId||"RACE";if(n.length===0){w(f("noFaultsToExport",e),"warning");return}const s=new Map;for(const h of n){const m=`${h.bib}-${h.run}`;s.has(m)||s.set(m,[]),s.get(m).push(h)}const r=[],a="══════════════════════════════════════════════════════",o=Array.from(s.entries()).filter(([h])=>h.endsWith("-1")),c=Array.from(s.entries()).filter(([h])=>h.endsWith("-2")),u=(h,m)=>{h.length!==0&&(r.push(`${f("faultSummaryTitle",e)} - ${f("runLabel",e)} ${m}`),r.push(a),r.push(`${f("bib",e).substring(0,7).padEnd(7)} │ ${f("faults",e).padEnd(16)} │ ${f("penalty",e).padStart(9)} │ Status`),r.push("────────┼──────────────────┼───────────┼────────"),h.sort((p,v)=>parseInt(p[0].split("-")[0],10)-parseInt(v[0].split("-")[0],10)).forEach(([p,v])=>{const[S]=p.split("-"),E=S.padStart(5),k=v.sort((q,N)=>q.gateNumber-N.gateNumber).map(q=>`T${q.gateNumber}(${q.faultType})`).join(", ").padEnd(16);let C,_;t.usePenaltyMode?(C=`${v.length*t.penaltySeconds} ${f("sec",e)}`.padStart(9),_=f("flt",e)):(C="-".padStart(9),_=f("dsq",e)),r.push(`  ${E}   │ ${k} │ ${C} │ ${_}`)}),r.push(""))};r.push(`${i} - ${new Date().toLocaleDateString(e==="de"?"de-DE":"en-US")}`),r.push(""),u(o,1),u(c,2),r.push(a),r.push(`${f("generated",e)}: ${new Date().toLocaleString(e==="de"?"de-DE":"en-US")}`);const d=r.join(`
`);oi(d,ai(`${i}_${f("summary",e)}`,"txt")),G(),w(f("exported",e),"success")}function oi(t,e){const n=new Blob([t],{type:"text/plain;charset=utf-8;"}),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}let he=null,Qt=null,ge=null;const ce=new O;function Cd(t){window.dispatchEvent(new CustomEvent("open-edit-modal",{detail:{entry:t}}))}function Td(t){window.dispatchEvent(new CustomEvent("prompt-delete",{detail:{entry:t}}))}function jn(t){window.dispatchEvent(new CustomEvent("open-confirm-modal",{detail:{action:t}}))}function yr(){return he}function Ld(){ce.removeAll(),ge&&(clearTimeout(ge),ge=null);const t=b("results-list");if(!t)return;he=new nl({container:t,onItemClick:a=>Cd(a),onItemDelete:a=>Td(a),onItemSelect:a=>{l.toggleEntrySelection(a.id)},onViewPhoto:a=>wl(a)}),ce.add(t,"fault-edit-request",a=>{var c;const o=(c=a.detail)==null?void 0:c.fault;o&&Js(o)}),ce.add(t,"fault-delete-request",a=>{var c;const o=(c=a.detail)==null?void 0:c.fault;o&&js(o)});const e=l.getState();he.setEntries(e.entries),An();const n=document.querySelector(".results-view");n&&(Qt=new jc({container:n,onRefresh:async()=>{await $.forceRefresh(),w(f("syncReceived",l.getState().currentLang),"success")}}));const i=b("search-input");i&&ce.add(i,"input",()=>{ge&&clearTimeout(ge),ge=setTimeout(()=>{Wn()},300)});const s=b("filter-point"),r=b("filter-status");s&&ce.add(s,"change",Wn),r&&ce.add(r,"change",Wn),Ad(),e.currentView!=="results"&&he&&he.pause()}function Ad(){const t=b("clear-all-btn");t&&ce.add(t,"click",()=>{const s=l.getState();if(s.entries.length===0){w(f("noEntries",s.currentLang),"info");return}jn("clearAll")});const e=b("undo-btn");e&&ce.add(e,"click",()=>{if(l.canUndo()){const s=l.peekUndo();if(s&&s.type==="ADD_ENTRY")jn("undoAdd");else{const r=l.undo();ti(),w(f("undone",l.getState().currentLang),"success");const a=l.getState();if(r&&r.type==="ADD_ENTRY"&&a.settings.sync&&a.raceId){const o=r.data;$.deleteEntryFromCloud(o.id,o.deviceId)}}}});const n=b("export-btn");n&&ce.add(n,"click",Ri);const i=b("delete-selected-btn");i&&ce.add(i,"click",()=>{l.getState().selectedEntries.size>0&&jn("deleteSelected")})}function Wn(){if(!he)return;const t=b("search-input"),e=b("filter-point"),n=b("filter-status");he.applyFilters((t==null?void 0:t.value)||"",(e==null?void 0:e.value)||"all",(n==null?void 0:n.value)||"all"),An()}function An(){const e=l.getState().entries,n=e.length,i=new Set(e.map(m=>m.bib)).size,s=new Set(e.filter(m=>m.point==="F"&&m.status==="ok").map(m=>m.bib)).size,r=new Map;for(const m of e){const p=`${m.bib}-${m.point}-${m.run??1}`;r.has(p)||r.set(p,new Set),r.get(p).add(m.deviceId)}let a=0;for(const m of r.values())m.size>1&&a++;const o=b("stat-total"),c=b("stat-racers"),u=b("stat-finished"),d=b("stat-duplicates"),h=b("stat-duplicates-item");o&&(o.textContent=String(n)),c&&(c.textContent=String(i)),u&&(u.textContent=String(s)),d&&(d.textContent=String(a)),h&&(h.style.display=a>0?"":"none")}function vr(){const t=b("entry-count-badge");if(t){const e=l.getState().entries.length;t.textContent=String(e),t.style.display=e>0?"inline":"none"}}function Rd(){ge&&(clearTimeout(ge),ge=null),ce.removeAll(),Qt&&(Qt.destroy(),Qt=null),he&&(he.destroy(),he=null)}function Dd(){Rd()}const xd={"5.18":{name:"Tiramisu Fox",description:{en:"Battery power saver for longer outdoor timing. Improved PIN security and faster voice notes.",de:"Batterieschoner für längere Zeitmessung im Freien. Verbesserte PIN-Sicherheit und schnellere Sprachnotizen."}},"5.19":{name:"Marzipan Lynx",description:{en:"Under-the-hood reliability upgrade. Stronger server-side input validation and improved code quality.",de:"Verbesserungen unter der Haube. Stärkere serverseitige Eingabevalidierung und verbesserte Codequalität."}},"5.20":{name:"Baklava Falcon",description:{en:"Offline banner, undo for deletions, reorganized settings, and standardized event cleanup across the app.",de:"Offline-Banner, Rückgängig-Funktion für Löschungen, neu organisierte Einstellungen und standardisierte Ereignisbereinigung."}},"5.21":{name:"Churros Otter",description:{en:"Responsive layout fixes for all screen sizes. Dial and numbers scale smoothly from iPhone SE to iPad landscape.",de:"Responsive Layout-Korrekturen für alle Bildschirmgrößen. Zifferblatt und Zahlen skalieren fließend vom iPhone SE bis iPad Querformat."}}};function ci(t){const e=t.split(".");if(e.length<2)return null;const n=`${e[0]}.${e[1]}`,i=xd[n];if(!i)return null;const s=l.getState().currentLang;return{name:i.name,description:i.description[s]||i.description.en}}const It=new O;function Bd(){const t=b("device-name-input");t&&It.add(t,"change",()=>{l.setDeviceName(t.value.trim())}),Pd(),It.add(window,"update-role-toggle",()=>Rn()),Nd()}function Pd(){const t=b("role-toggle");t&&It.add(t,"click",e=>{const i=e.target.closest(".role-card-setting");if(!i)return;const s=i.getAttribute("data-role");s&&s!==l.getState().deviceRole&&(l.setDeviceRole(s),Rn(),Tn(),I(),s==="gateJudge"&&!l.getState().gateAssignment&&V(b("gate-assignment-modal")),s!=="gateJudge"&&l.getState().currentView==="gateJudge"&&l.setView("timer"))})}function Rn(){const t=b("role-toggle");if(!t)return;const e=l.getState();t.querySelectorAll(".role-card-setting").forEach(n=>{const s=n.getAttribute("data-role")===e.deviceRole;n.classList.toggle("active",s),n.setAttribute("aria-checked",String(s))})}function Nd(){const t=b("advanced-settings-toggle"),e=b("advanced-settings-section");!t||!e||(t.setAttribute("role","button"),t.setAttribute("aria-expanded",e.classList.contains("expanded")?"true":"false"),It.add(t,"click",()=>{const n=e.classList.toggle("expanded");t.setAttribute("aria-expanded",String(n)),I()}))}function Fd(){const t=l.getState(),e=b("device-name-input");e&&(e.value=t.deviceName)}function $d(){It.removeAll()}const je=new O;function Md(t){const e=b("simple-mode-toggle");e&&je.add(e,"change",()=>{l.updateSettings({simple:e.checked}),t();const s=b("admin-section");s&&(s.style.display="block")});const n=b("ambient-mode-toggle");n&&je.add(n,"change",()=>{l.updateSettings({ambientMode:n.checked})}),Od();const i=b("lang-toggle");if(i){const s=r=>{r&&r!==l.getState().currentLang&&(l.setLanguage(r),window.dispatchEvent(new CustomEvent("settings-language-changed")))};je.add(i,"click",r=>{const o=r.target.getAttribute("data-lang");s(o)}),i.querySelectorAll(".lang-option").forEach(r=>{je.add(r,"keydown",a=>{const o=a,c=r.getAttribute("data-lang");switch(o.key){case"Enter":case" ":o.preventDefault(),s(c);break;case"ArrowLeft":case"ArrowRight":{o.preventDefault();const u=c==="de"?"en":"de",d=i.querySelector(`[data-lang="${u}"]`);d&&(d.focus(),s(u));break}}})})}}function Od(){const t=b("voice-mode-toggle"),e=b("voice-mode-row");if(!(!t||!e)){if(!H.isSupported()){e.style.display="none";return}t.checked=H.isActive(),je.add(t,"change",async()=>{const n=l.getState().currentLang;if(t.checked){if(!navigator.onLine){w(f("voiceOffline",n),"warning"),t.checked=!1;return}H.enable()||(w(f("voiceError",n),"error"),t.checked=!1)}else H.disable()})}}function Vd(){const t=l.getState(),{settings:e}=t,n=b("simple-mode-toggle");n&&(n.checked=e.simple);const i=b("admin-section");i&&(i.style.display="block");const s=b("ambient-mode-toggle");s&&(s.checked=e.ambientMode),br()}function br(){const t=l.getState().currentLang,e=b("lang-toggle");e&&e.querySelectorAll(".lang-option").forEach(n=>{const i=n.getAttribute("data-lang")===t;n.classList.toggle("active",i),n.setAttribute("aria-checked",String(i))})}function _d(){je.removeAll()}function Hd(t){const e=l.getState().currentLang,n=t.entryCount!==void 0?`${t.entryCount} ${f("entries",e)}`:"",i=T(t.raceId);return`
    <div class="recent-race-item" data-race-id="${L(t.raceId)}" tabindex="0" role="option" aria-label="${L(f("race",e))} ${i}${n?`, ${n}`:""}">
      <span class="recent-race-id">${i}</span>
      <span class="recent-race-meta">${n}</span>
    </div>
  `}function Sr(t){return t.map(Hd).join("")}function Er(t,e,n){const i=t.querySelectorAll(".recent-race-item");i.forEach((s,r)=>{s.addEventListener("click",()=>{const a=e[r];a&&n(a)}),s.addEventListener("keydown",a=>{const o=a,c=Array.from(i);switch(o.key){case"Enter":case" ":{o.preventDefault();const u=e[r];u&&n(u);break}case"ArrowDown":o.preventDefault(),r<c.length-1&&c[r+1].focus();break;case"ArrowUp":o.preventDefault(),r>0&&c[r-1].focus();break;case"Escape":o.preventDefault(),t.style.display="none";break}})})}const xe=new O;let Xe=null,Qn=0,wr={exists:null,entryCount:0},Yt=null,Kt=null;async function zd(){return new Promise(t=>{Yt=t,window.dispatchEvent(new CustomEvent("request-photo-sync-warning"))})}async function vs(t,e){return new Promise(n=>{Kt=n,window.dispatchEvent(new CustomEvent("request-race-change-dialog",{detail:{type:t,lang:e}}))})}function bs(){Yt&&(Yt(),Yt=null)}function Ss(t){Kt&&(Kt(t),Kt=null)}function Ud(){const t=b("sync-toggle");let e=!1;t&&xe.add(t,"change",async()=>{if(e){t.checked=!t.checked;return}e=!0;try{const o=l.getState();if(t.checked&&o.raceId&&!await ii(o.currentLang)){t.checked=!1;return}l.updateSettings({sync:t.checked});const c=b("sync-photos-toggle");c&&(c.disabled=!t.checked,t.checked||(c.checked=!1,l.updateSettings({syncPhotos:!1}))),t.checked&&o.raceId?$.initialize():$.cleanup()}finally{e=!1}});const n=b("sync-photos-toggle");n&&xe.add(n,"change",async o=>{const c=o.target;c.checked?(o.preventDefault(),c.checked=!1,await zd()):l.updateSettings({syncPhotos:!1})});const i=b("race-id-input");let s=!1;i&&(xe.add(i,"input",()=>{Xe&&clearTimeout(Xe);const o=i.value.trim();o?Xe=setTimeout(()=>qd(o),500):vn(null,0)}),xe.add(i,"change",async()=>{if(!s){s=!0;try{const o=i.value.trim(),c=l.getState(),u=c.entries.length>0,d=c.lastSyncedRaceId!=="",h=o!==c.raceId&&o!=="";if(u&&h)if(d){const p=await vs("synced",c.currentLang);if(p==="export")Ri(),l.clearAll(),l.clearFaultEntries(),await Q.clearAll();else if(p==="delete")l.clearAll(),l.clearFaultEntries(),await Q.clearAll();else{i.value=c.raceId;return}}else{const p=await vs("unsynced",c.currentLang);if(p==="delete")l.clearAll(),l.clearFaultEntries(),await Q.clearAll();else if(p==="cancel"){i.value=c.raceId;return}}if(o&&!Bs(o)){w(f("invalidRaceId",c.currentLang),"error"),i.value=c.raceId,z();return}if(c.settings.sync&&o&&!await ii(c.currentLang)){i.value=c.raceId;return}c.settings.sync&&c.raceId&&$.cleanup();const m=o.toLowerCase();i.value=m,l.setRaceId(m),c.settings.sync&&m&&($.initialize(),l.markCurrentRaceAsSynced())}finally{s=!1}}}));const r=b("settings-recent-races-btn"),a=b("settings-recent-races-dropdown");r&&a&&(xe.add(r,"click",()=>{I(),a.style.display==="none"?(Jd(a),r.setAttribute("aria-expanded","true")):(a.style.display="none",r.setAttribute("aria-expanded","false"))}),xe.add(document,"click",o=>{const c=o.target;!r.contains(c)&&!a.contains(c)&&(a.style.display="none",r.setAttribute("aria-expanded","false"))}))}function Gd(){const t=l.getState(),{settings:e}=t,n=b("sync-toggle");n&&(n.checked=e.sync);const i=b("sync-photos-toggle");i&&(i.checked=e.syncPhotos,i.disabled=!e.sync);const s=b("race-id-input");s&&(s.value=t.raceId)}async function qd(t){const e=++Qn;try{const n=await $.checkRaceExists(t);if(e!==Qn)return;l.setRaceExistsInCloud(n.exists),vn(n.exists,n.entryCount)}catch(n){if(e!==Qn)return;y.warn("Race exists check failed:",n),vn(null,0)}}async function Jd(t){const e=l.getState().currentLang;t.innerHTML=`<div class="recent-races-empty">${f("loading",e)}</div>`,t.style.display="block";let n=[];if(Le())try{n=await jd()}catch(i){y.warn("Failed to fetch races from API:",i),n=on()}else n=on();n.length===0?t.innerHTML=`<div class="recent-races-empty">${f("noRecentRaces",e)}</div>`:(t.innerHTML=Sr(n),Er(t,n,i=>{Wd(i,t)}))}async function jd(){const t=localStorage.getItem(Tt);if(!t)return[];const e=await ae("/api/v1/admin/races",{headers:{Authorization:`Bearer ${t}`}},5e3);if(!e.ok)throw new Error(`API error: ${e.status}`);const i=(await e.json()).races||[],s=new Date;s.setHours(0,0,0,0);const r=s.getTime(),a=i.filter(o=>o.lastUpdated&&o.lastUpdated>=r).map(o=>({raceId:o.raceId,createdAt:o.lastUpdated||Date.now(),lastUpdated:o.lastUpdated||Date.now(),entryCount:o.entryCount})).slice(0,5);return a.forEach(o=>{vi(o.raceId,o.lastUpdated,o.entryCount)}),a}function Wd(t,e){const n=b("race-id-input");n&&(n.value=t.raceId,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),I()),e.style.display="none"}function vn(t,e){wr={exists:t,entryCount:e};const n=b("race-exists-indicator"),i=b("race-exists-text"),s=l.getState().currentLang;if(!(!n||!i)){if(t===null){n.style.display="none";return}if(n.style.display="inline-flex",n.classList.remove("found","new"),t)if(n.classList.add("found"),e>0){const r=f(e===1?"entryInCloud":"entriesInCloud",s);i.textContent=`${e} ${r}`}else i.textContent=f("raceFound",s);else n.classList.add("new"),i.textContent=f("raceNew",s)}}function Qd(){return wr}function Yd(){Xe&&(clearTimeout(Xe),Xe=null),xe.removeAll()}const Be=new O;function Kd(){Md(Ir),Ud(),Bd(),Be.add(window,"settings-language-changed",()=>{Di(),br()});const t=b("gps-toggle");t&&Be.add(t,"change",()=>{l.updateSettings({gps:t.checked})});const e=b("auto-toggle");e&&Be.add(e,"change",()=>{l.updateSettings({auto:e.checked})});const n=b("haptic-toggle");n&&Be.add(n,"change",()=>{l.updateSettings({haptic:n.checked})});const i=b("sound-toggle");i&&Be.add(i,"change",()=>{l.updateSettings({sound:i.checked})});const s=b("photo-toggle");s&&Be.add(s,"change",()=>{l.updateSettings({photoCapture:s.checked})})}function Zd(){const t=l.getState(),{settings:e}=t;Vd(),Gd(),Fd();const n=b("gps-toggle"),i=b("auto-toggle"),s=b("haptic-toggle"),r=b("sound-toggle"),a=b("photo-toggle");n&&(n.checked=e.gps),i&&(i.checked=e.auto),s&&(s.checked=e.haptic),r&&(r.checked=e.sound),a&&(a.checked=e.photoCapture)}function Di(){const t=l.getState().currentLang;document.documentElement.lang=t,document.querySelectorAll("[data-i18n]").forEach(i=>{const s=i.getAttribute("data-i18n");s&&(i.textContent=f(s,t))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(i=>{const s=i.getAttribute("data-i18n-placeholder");s&&(i.placeholder=f(s,t))}),document.querySelectorAll("[data-i18n-aria-label]").forEach(i=>{const s=i.getAttribute("data-i18n-aria-label");s&&i.setAttribute("aria-label",f(s,t))});const e=Qd();vn(e.exists,e.entryCount);const n=document.getElementById("app-version-description");if(n){const i=ci("5.21.0");n.textContent=(i==null?void 0:i.description)??""}}function Ir(){document.querySelectorAll("[data-advanced]").forEach(n=>{n.style.display=""});const e=document.querySelector('[data-point="S"]');e&&(e.style.display=""),kr()}function kr(){const t=l.getState().settings,e=document.documentElement;t.glassEffects?(e.classList.remove("no-glass-effects"),document.querySelectorAll(".glass-enable-target").forEach(n=>{n.classList.add("glass-enabled")})):(e.classList.add("no-glass-effects"),document.querySelectorAll(".glass-enabled").forEach(n=>{n.classList.remove("glass-enabled")})),e.classList.add("no-motion-effects"),t.outdoorMode?e.classList.add("outdoor-mode"):e.classList.remove("outdoor-mode")}function Xd(){Yd(),_d(),$d(),Be.removeAll()}const Te=new O;let Se=null;const nt=new Set;function eu(t){return t?/^0+$/.test(t):!1}function tu(){Se&&(Se.destroy(),Se=null);const t=b("clock-container");t&&(Se=new Jc(t),Se.start())}function nu(){Se&&(Se.destroy(),Se=null)}function iu(){const t=document.querySelectorAll(".tab-btn"),e=()=>Array.from(t).filter(n=>n.style.display!=="none");t.forEach(n=>{Te.add(n,"click",()=>{const i=n.getAttribute("data-view");i&&(l.setView(i),I(),t.forEach(s=>{s.setAttribute("aria-selected",s===n?"true":"false")}))}),Te.add(n,"keydown",i=>{const s=i,r=e(),a=r.indexOf(n);let o=a;switch(s.key){case"ArrowLeft":case"ArrowUp":s.preventDefault(),o=a>0?a-1:r.length-1;break;case"ArrowRight":case"ArrowDown":s.preventDefault(),o=a<r.length-1?a+1:0;break;case"Home":s.preventDefault(),o=0;break;case"End":s.preventDefault(),o=r.length-1;break;default:return}if(o!==a){const c=r[o];c.focus(),c.click()}})})}function su(){const t=b("number-pad"),e=b("bib-display");e&&t&&(e.setAttribute("aria-expanded","true"),Te.add(e,"click",()=>{const n=t.classList.toggle("collapsed");e.classList.toggle("expanded",!n),e.setAttribute("aria-expanded",String(!n)),I()})),t&&Te.add(t,"click",n=>{const s=n.target.closest(".num-btn");if(!s)return;const r=s.getAttribute("data-num"),a=s.getAttribute("data-action");if(r){const o=l.getState();o.bibInput.length<3&&(l.setBibInput(o.bibInput+r),I())}else if(a==="clear")l.setBibInput(""),I();else if(a==="delete"){const o=l.getState();l.setBibInput(o.bibInput.slice(0,-1)),I()}})}function ru(){const t=b("timing-points");t&&Te.add(t,"click",e=>{const i=e.target.closest(".timing-point-btn");if(!i)return;const s=i.getAttribute("data-point");s&&(l.setSelectedPoint(s),I(),t.querySelectorAll(".timing-point-btn").forEach(r=>{r.setAttribute("aria-checked",r===i?"true":"false")}))})}function au(){const t=b("run-selector");t&&Te.add(t,"click",e=>{const i=e.target.closest(".run-btn");if(!i)return;const s=i.getAttribute("data-run"),r=s?parseInt(s,10):1;l.setSelectedRun(r),I(),t.querySelectorAll(".run-btn").forEach(a=>{a.setAttribute("aria-checked",a===i?"true":"false")})})}function ou(){const t=b("timestamp-btn");t&&(Te.add(t,"click",async()=>{if(Z.isActive()){Z.exitAmbientMode(),I();return}await Es()}),Te.add(document,"keydown",e=>{var s;const n=(s=document.activeElement)==null?void 0:s.tagName,i=l.getState();if(!(n==="INPUT"||n==="TEXTAREA"||n==="SELECT")&&i.currentView==="timer"){if(/^[0-9]$/.test(e.key)){e.preventDefault(),i.bibInput.length<3&&(l.setBibInput(i.bibInput+e.key),I());return}if(e.key==="Backspace"){e.preventDefault(),l.setBibInput(i.bibInput.slice(0,-1)),I();return}if(e.key==="Delete"||e.key==="Escape"){e.preventDefault(),l.setBibInput(""),I();return}if(e.key==="s"||e.key==="S"){e.preventDefault(),l.setSelectedPoint("S"),I(),document.querySelectorAll(".timing-point-btn").forEach(r=>{r.setAttribute("aria-checked",r.getAttribute("data-point")==="S"?"true":"false")});return}if(e.key==="f"||e.key==="F"){e.preventDefault(),l.setSelectedPoint("F"),I(),document.querySelectorAll(".timing-point-btn").forEach(r=>{r.setAttribute("aria-checked",r.getAttribute("data-point")==="F"?"true":"false")});return}if(e.key==="1"&&e.altKey){e.preventDefault(),l.setSelectedRun(1),I();return}if(e.key==="2"&&e.altKey){e.preventDefault(),l.setSelectedRun(2),I();return}if(e.key===" "||e.key==="Enter"){if(e.preventDefault(),Z.isActive()){Z.exitAmbientMode(),I();return}Es();return}}}))}async function Es(){const t=l.getState();if(t.isRecording)return;const{entry:e}=fr({bib:t.bibInput,point:t.selectedPoint,run:t.selectedRun,deviceId:t.deviceId,deviceName:t.deviceName,gpsService:me});l.setRecording(!0);try{if(t.settings.photoCapture){const s=e.id;Ns().then(async r=>{if(r)try{if(!l.getState().entries.some(u=>u.id===s)){y.warn("Entry was deleted before photo could be attached:",s);return}if(await Q.savePhoto(s,r))l.updateEntry(s,{photo:"indexeddb"})||(y.warn("Entry deleted during photo save, removing orphaned photo:",s),await Q.deletePhoto(s));else{y.warn("Photo save failed for entry:",s);const u=l.getState().currentLang;w(f("photoSaveFailed",u),"warning")}}catch(a){gt("Camera","photo save/update",a,"photoError")}}).catch(r=>{if(r instanceof Error&&r.name==="PhotoTooLargeError"){const a=l.getState().currentLang;w(f("photoTooLarge",a),"warning")}else gt("Camera","captureTimingPhoto",r,"photoError")})}const n=hr(e,t.entries),i=eu(e.bib);if(l.addEntry(e),n?(z(),lu(e)):i?(z(),du(e)):(G(),xi(e)),$.broadcastEntry(e),t.settings.auto&&t.bibInput){const s=parseInt(t.bibInput,10)+1,r=t.settings.sync&&t.cloudHighestBib>0?Math.max(s,t.cloudHighestBib+1):s;l.setBibInput(String(r))}else t.bibInput&&t.settings.auto||l.setBibInput("");uu(e)}finally{l.setRecording(!1)}}function xi(t){const e=b("confirmation-overlay");if(!e)return;const n=e.querySelector(".confirmation-bib"),i=e.querySelector(".confirmation-point"),s=e.querySelector(".confirmation-run"),r=e.querySelector(".confirmation-time"),a=l.getState();if(n&&(n.textContent=t.bib||"---"),i&&(i.textContent=Ce(t.point,a.currentLang),i.style.color=mt(t.point)),s&&t.run&&(s.textContent=ut(t.run,a.currentLang),s.style.color=ft(t.run)),r){const c=new Date(t.timestamp);r.textContent=ke(c)}e.dataset.point=t.point,e.classList.add("show"),cu(t.point);const o=window.setTimeout(()=>{e.classList.remove("show"),nt.delete(o)},1500);nt.add(o)}function cu(t){const e=document.getElementById("snowflake-burst");if(!e)return;e.innerHTML="";const n=t==="S"?"var(--start-color)":"var(--finish-color)",i=8;for(let s=0;s<i;s++){const r=document.createElement("span");r.className="flake",r.textContent="❄";const a=s/i*2*Math.PI,o=60+Math.random()*40,c=Math.cos(a)*o,u=Math.sin(a)*o,d=Math.random()*360;r.style.cssText=`
      --burst-x: ${c}px;
      --burst-y: ${u}px;
      --burst-rot: ${d}deg;
      color: ${n};
      font-size: ${.6+Math.random()*.6}rem;
      animation-duration: ${.6+Math.random()*.4}s;
      text-shadow: 0 0 6px ${n};
    `,r.addEventListener("animationend",()=>r.remove(),{once:!0}),e.appendChild(r)}}function lu(t){const e=b("confirmation-overlay");if(!e)return;const n=e.querySelector(".confirmation-duplicate");n&&(n.style.display="flex"),xi(t);const i=window.setTimeout(()=>{n&&(n.style.display="none"),nt.delete(i)},2500);nt.add(i)}function du(t){const e=b("confirmation-overlay");if(!e)return;const n=e.querySelector(".confirmation-zero-bib");n&&(n.style.display="flex"),xi(t);const i=window.setTimeout(()=>{n&&(n.style.display="none"),nt.delete(i)},2500);nt.add(i)}function uu(t){const e=b("last-recorded-inline");if(!e)return;const n=e.querySelector(".bib"),i=e.querySelector(".point"),s=e.querySelector(".run"),r=e.querySelector(".time"),a=l.getState();if(n&&(n.textContent=t.bib||"---"),i&&(i.textContent=Ce(t.point,a.currentLang),i.style.color=mt(t.point)),s&&t.run&&(s.textContent=ut(t.run,a.currentLang),s.style.color=ft(t.run)),r){const o=new Date(t.timestamp);r.textContent=ke(o)}e.classList.add("visible"),e.classList.remove("pulse"),e.offsetWidth,e.classList.add("pulse")}function Bi(){const t=l.getState(),e=b("bib-display"),n=e==null?void 0:e.querySelector(".bib-value");n&&(n.textContent=t.bibInput?t.bibInput.padStart(3,"0"):"---");const i=b("timestamp-btn");i&&i.classList.toggle("ready",t.bibInput.length>0)}function Pi(){const t=l.getState();document.querySelectorAll(".timing-point-btn").forEach(e=>{const n=e.getAttribute("data-point")===t.selectedPoint;e.classList.toggle("active",n),e.setAttribute("aria-checked",String(n))})}function Ni(){const t=l.getState();document.querySelectorAll(".run-btn").forEach(e=>{const n=e.getAttribute("data-run")===String(t.selectedRun);e.classList.toggle("active",n),e.setAttribute("aria-checked",String(n))})}function fu(t){var e,n,i;switch(y.debug("[TimerView] Voice intent:",t.action,t.params),t.action){case"set_bib":(e=t.params)!=null&&e.bib&&(l.setBibInput(t.params.bib),Bi(),I());break;case"set_point":(n=t.params)!=null&&n.point&&(l.setSelectedPoint(t.params.point),Pi(),I());break;case"set_run":(i=t.params)!=null&&i.run&&(l.setSelectedRun(t.params.run),Ni(),I());break;default:y.debug("[TimerView] Unhandled voice intent:",t.action)}}function hu(){Cr(),yn()?pr():(Bi(),Pi()),Ni(),An(),vr(),kt(),Dn(),Fe(),Tr(),Lr(),Zd(),Di()}function gu(t){return t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}function Cr(){const t=l.getState();document.querySelectorAll(".view").forEach(i=>{i.classList.remove("active")});const e=gu(t.currentView),n=document.querySelector(`.${e}-view`);n&&n.classList.add("active"),document.querySelectorAll(".tab-btn").forEach(i=>{i.classList.toggle("active",i.getAttribute("data-view")===t.currentView)}),t.currentView==="gateJudge"&&(we(),Lt(),Ln(),vt())}function kt(){var a,o;const t=l.getState(),e=b("sync-indicator"),n=(a=b("sync-indicator"))==null?void 0:a.querySelector(".sync-dot"),i=(o=b("sync-indicator"))==null?void 0:o.querySelector(".sync-status-text"),s=b("sync-device-count");e&&(e.style.display=t.settings.sync?"flex":"none");const r=t.currentLang;if(n){n.classList.remove("connected","error","offline","syncing"),t.syncStatus==="connected"?n.classList.add("connected"):t.syncStatus==="syncing"?n.classList.add("syncing"):t.syncStatus==="error"?n.classList.add("error"):t.syncStatus==="offline"&&n.classList.add("offline");const c=t.syncStatus==="connected"?f("syncOnline",r):t.syncStatus==="error"?f("syncError",r):t.syncStatus==="offline"?f("syncOffline",r):f("syncing",r);n.setAttribute("aria-label",c)}i&&(i.textContent=f(t.syncStatus,r)),s&&(t.syncStatus==="connected"&&t.cloudDeviceCount>0?(s.textContent=`${t.cloudDeviceCount} ${f("devices",r)}`,s.style.display="inline",s.classList.add("status-active")):t.syncStatus==="error"||t.syncStatus==="offline"?(s.textContent=f("syncOffline",r),s.style.display="inline",s.classList.remove("status-active")):s.style.display="none")}function Dn(){const t=l.getState(),e=b("gps-indicator"),n=e==null?void 0:e.querySelector(".gps-dot"),i=e==null?void 0:e.querySelector(".gps-status-text");if(e&&(e.style.display=t.settings.gps?"flex":"none"),n){n.classList.remove("active","searching","paused"),t.gpsStatus==="active"?n.classList.add("active"):t.gpsStatus==="searching"?n.classList.add("searching"):t.gpsStatus==="paused"&&n.classList.add("paused");const s=t.currentLang,r=t.gpsStatus==="active"||t.gpsStatus==="paused"?"gpsActive":t.gpsStatus==="searching"?"gpsSearching":"gpsInactive";n.setAttribute("aria-label",f(r,s))}if(i){const s=t.currentLang;t.gpsStatus==="active"||t.gpsStatus==="paused"?(i.textContent=f("gpsActive",s),i.classList.add("status-active"),i.classList.remove("status-inactive","status-searching")):t.gpsStatus==="searching"?(i.textContent=f("gpsSearching",s),i.classList.add("status-searching"),i.classList.remove("status-active","status-inactive")):(i.textContent=f("gpsInactive",s),i.classList.add("status-inactive"),i.classList.remove("status-active","status-searching"))}}function Tr(){const t=l.getState(),e=b("camera-indicator");e&&(e.style.display=t.settings.photoCapture?"flex":"none")}function mu(t){const e=b("voice-indicator"),n=b("voice-status-text");if(e){if(t==="inactive"){e.style.display="none";return}if(e.style.display="flex",e.classList.remove("listening","processing","confirming","offline","error"),e.classList.add(t),n){const i=l.getState().currentLang;switch(t){case"listening":n.textContent=f("voiceListening",i);break;case"processing":n.textContent=f("voiceProcessing",i);break;case"confirming":n.textContent=f("voiceConfirming",i);break;case"offline":n.textContent=f("voiceOffline",i);break;case"error":n.textContent=f("voiceError",i);break}}}}function Lr(){const t=b("undo-btn");t&&t.toggleAttribute("disabled",!l.canUndo())}const $e=new O;let Zt=null,Xt=null;async function pu(t){return new Promise(e=>{Xt=e,window.dispatchEvent(new CustomEvent("request-pin-verification",{detail:{lang:t}}))})}function li(t){Xt&&(Xt(t),Xt=null)}function yu(t){window.dispatchEvent(new CustomEvent("open-fault-edit-modal",{detail:{fault:t}}))}function vu(t){window.dispatchEvent(new CustomEvent("open-mark-deletion-modal",{detail:{fault:t}}))}function bu(){window.dispatchEvent(new CustomEvent("update-inline-faults-list"))}function ws(){window.dispatchEvent(new CustomEvent("update-inline-bib-selector"))}function Su(){window.dispatchEvent(new CustomEvent("update-inline-gate-selector"))}function Eu(){const t=document.getElementById("chief-judge-toggle-btn");t&&($e.add(t,"click",async()=>{const e=l.getState(),n=e.currentLang;if(e.isChiefJudgeView){l.toggleChiefJudgeView(),ui(),I(),w(f("chiefJudgeModeDisabled",n),"info");return}e.settings.sync&&e.raceId&&!await pu(n)||(l.toggleChiefJudgeView(),ui(),I(),w(f("chiefJudgeModeEnabled",n),"info"))}),di(),Zt=l.subscribe((e,n)=>{(n.includes("settings")||n.includes("faultEntries"))&&di(),(n.includes("faultEntries")||n.includes("penaltySeconds")||n.includes("usePenaltyMode"))&&e.isChiefJudgeView&&(ct(),At()),(n.includes("penaltySeconds")||n.includes("usePenaltyMode"))&&Fi(),(n.includes("entries")||n.includes("faultEntries")||n.includes("isJudgeReady"))&&e.isChiefJudgeView&&$i(),n.includes("faultEntries")&&e.deviceRole==="gateJudge"&&(bu(),ws()),n.includes("entries")&&e.deviceRole==="gateJudge"&&ws(),n.includes("gateAssignment")&&e.deviceRole==="gateJudge"&&Su()}),Iu(),wu())}function wu(){const t=document.getElementById("export-csv-btn");t&&$e.add(t,"click",()=>{I(),Ri()});const e=document.getElementById("export-summary-btn");e&&$e.add(e,"click",()=>{I(),kd()});const n=document.getElementById("export-whatsapp-btn");n&&$e.add(n,"click",()=>{I(),Id()})}function Iu(){const t=document.getElementById("penalty-mode-toggle");t&&$e.add(t,"click",n=>{const i=n.target.closest(".penalty-mode-btn");if(!i)return;const s=i.getAttribute("data-mode");s==="penalty"?l.setUsePenaltyMode(!0):s==="dsq"&&l.setUsePenaltyMode(!1),I()});const e=document.getElementById("penalty-seconds-selector");e&&$e.add(e,"click",n=>{const i=n.target.closest(".penalty-adj-btn");if(!i)return;const s=i.getAttribute("data-adj"),a=l.getState().penaltySeconds;s==="+1"?l.setPenaltySeconds(a+1):s==="-1"&&l.setPenaltySeconds(a-1),I()}),Fi()}function Fi(){const t=l.getState(),e=document.getElementById("penalty-config-row"),n=document.getElementById("penalty-seconds-value"),i=document.getElementById("penalty-mode-toggle");e&&e.classList.toggle("dsq-mode",!t.usePenaltyMode),n&&(n.textContent=String(t.penaltySeconds)),i&&i.querySelectorAll(".penalty-mode-btn").forEach(r=>{const a=r.getAttribute("data-mode"),o=a==="penalty"&&t.usePenaltyMode||a==="dsq"&&!t.usePenaltyMode;r.classList.toggle("active",o),r.setAttribute("aria-pressed",String(o))})}function di(){const t=document.getElementById("chief-judge-toggle-row");if(!t)return;const n=l.getState().settings.sync;t.style.display=n?"block":"none"}function ui(){const t=l.getState(),e=document.querySelector(".results-view"),n=document.getElementById("chief-judge-toggle-btn");!e||!n||(n.classList.toggle("active",t.isChiefJudgeView),n.setAttribute("aria-pressed",String(t.isChiefJudgeView)),e.classList.toggle("chief-mode",t.isChiefJudgeView),t.isChiefJudgeView&&(ct(),At(),$i()))}function $i(){const t=document.getElementById("judges-overview-list"),e=document.getElementById("judges-overview-count"),n=document.getElementById("judges-overview-empty");if(!t||!e)return;const i=$.getOtherGateAssignments(),s=l.getState(),r=[...i];if(s.deviceRole==="gateJudge"&&s.gateAssignment&&r.push({deviceId:s.deviceId,deviceName:s.deviceName,gateStart:s.gateAssignment[0],gateEnd:s.gateAssignment[1],lastSeen:Date.now(),isReady:s.isJudgeReady}),e.textContent=String(r.length),n&&(n.style.display=r.length===0?"block":"none"),t.querySelectorAll(".judge-card").forEach(c=>c.remove()),r.length===0)return;r.sort((c,u)=>c.gateStart-u.gateStart);const o=r.map(c=>`
    <div class="judge-card${c.isReady?" ready":""}">
      <span class="judge-ready-indicator"></span>
      <span class="judge-name" title="${L(c.deviceName)}">${T(c.deviceName)}</span>
      <span class="judge-gates">${c.gateStart}–${c.gateEnd}</span>
    </div>
  `).join("");n?n.insertAdjacentHTML("beforebegin",o):t.innerHTML=o}function ct(){const t=document.getElementById("fault-summary-list"),e=document.getElementById("fault-summary-count"),n=document.getElementById("chief-empty-state");if(!t||!e)return;const i=l.getState(),s=i.currentLang,r=i.faultEntries,a=new Map;for(const p of r){const v=`${p.bib}-${p.run}`;a.has(v)||a.set(v,[]),a.get(v).push(p)}if(e.textContent=String(a.size),n&&(n.style.display=a.size===0?"flex":"none"),a.size===0){t.querySelectorAll(".fault-summary-card").forEach(v=>v.remove());return}const o=[],c=Array.from(a.entries()).sort((p,v)=>{const[S]=p,[E]=v,k=parseInt(S.split("-")[0],10)||0,C=parseInt(E.split("-")[0],10)||0;return k-C});for(const[p,v]of c){const[S,E]=p.split("-"),k=parseInt(E,10),C=l.isRacerFinalized(S,k),_=v.filter(x=>!x.markedForDeletion),q=i.usePenaltyMode?_.length*i.penaltySeconds:0,N=v.map(x=>{const oe=x.markedForDeletion,Rt=oe&&x.markedForDeletionBy?`${f("deletionPending",s)} (${x.markedForDeletionBy})`:"",Dt=x.notes&&x.notes.length>0;return`
        <div class="fault-entry-row${oe?" marked-for-deletion":""}" data-fault-id="${L(x.id)}">
          <div class="fault-gate-info">
            <span class="fault-gate-num${oe?" strikethrough":""}">${f("gate",s)} ${T(String(x.gateNumber))}</span>
            <span class="fault-type-badge${oe?" marked":""}">${ve(x.faultType,s)}</span>
            ${Dt?`<span class="fault-note-icon" title="${L(f("hasNote",s))}" aria-label="${L(f("hasNote",s))}">${Us(14)}</span>`:""}
            ${oe?`<span class="deletion-pending-badge" title="${L(Rt)}">${zs(14)}</span>`:""}
          </div>
          <span class="fault-judge-name">${T(x.deviceName)}</span>
          <div class="fault-row-actions">
            <button class="fault-row-btn edit-fault-btn" data-fault-id="${L(x.id)}" title="${L(f("edit",s))}" ${oe?"disabled":""}>
              ${Hs(14)}
            </button>
            <button class="fault-row-btn delete-fault-btn" data-fault-id="${L(x.id)}" title="${L(f(oe?"rejectDeletion":"markForDeletion",s))}">
              ${oe?Mc(14):wi(14)}
            </button>
          </div>
        </div>
      `}).join(""),A=C?`<div class="finalized-badge">
           ${yt(16,2.5)}
           ${f("finalized",s)}
         </div>`:`<button class="finalize-btn" data-bib="${L(S)}" data-run="${L(String(k))}">
           ${yt(16)}
           ${f("finalize",s)}
         </button>`,R=i.usePenaltyMode?`<span class="fault-card-penalty">+${q}s</span>
         <span class="fault-card-result flt">${f("flt",s)}</span>`:`<span class="fault-card-result dsq">${f("dsq",s)}</span>`;o.push(`
      <div class="fault-summary-card${C?" finalized":""}" data-bib="${L(S)}" data-run="${L(String(k))}">
        <div class="fault-card-header">
          <span class="fault-card-bib">#${T(S.padStart(3,"0"))}</span>
          <div class="fault-card-status">
            ${R}
          </div>
        </div>
        <div class="fault-card-body">
          ${N}
        </div>
        <div class="fault-card-actions">
          ${A}
        </div>
      </div>
    `)}t.querySelectorAll(".fault-summary-card").forEach(p=>p.remove()),n?n.insertAdjacentHTML("beforebegin",o.join("")):t.innerHTML=o.join(""),t.querySelectorAll(".finalize-btn").forEach(p=>{p.addEventListener("click",Cu)}),t.querySelectorAll(".edit-fault-btn").forEach(p=>{p.addEventListener("click",v=>{v.stopPropagation();const S=p.dataset.faultId;if(S){const E=l.getState().faultEntries.find(k=>k.id===S);E&&yu(E)}})}),t.querySelectorAll(".delete-fault-btn").forEach(p=>{p.addEventListener("click",v=>{v.stopPropagation();const S=p.dataset.faultId;if(S){const E=l.getState().faultEntries.find(k=>k.id===S);E&&(E.markedForDeletion?Ar(E):vu(E))}})})}function Ar(t){if(l.rejectFaultDeletion(t.id)){const n=l.getState().faultEntries.find(s=>s.id===t.id);n&&at(n);const i=l.getState().currentLang;w(f("deletionRejected",i),"success"),G(),ct(),At()}}function ku(t){const e=l.approveFaultDeletion(t.id);if(e){Ei(e);const n=l.getState().currentLang;w(f("deletionApproved",n),"success"),In(),ct(),At()}}function At(){const t=document.getElementById("pending-deletions-section"),e=document.getElementById("pending-deletions-list"),n=document.getElementById("pending-deletions-count");if(!t||!e||!n)return;const i=l.getPendingDeletions(),r=l.getState().currentLang;if(n.textContent=String(i.length),t.style.display=i.length>0?"block":"none",i.length===0){e.innerHTML="";return}const a=i.map(o=>{const c=o.markedForDeletionAt?new Date(o.markedForDeletionAt).toLocaleTimeString(r==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"}):"";return`
      <div class="pending-deletion-item" data-fault-id="${L(o.id)}">
        <div class="pending-deletion-info">
          <span class="pending-deletion-fault">
            #${T(o.bib.padStart(3,"0"))} T${T(String(o.gateNumber))} (${ve(o.faultType,r)}) - ${f(o.run===1?"run1":"run2",r)}
          </span>
          <span class="pending-deletion-meta">
            ${f("deletionMarkedBy",r)}: ${T(o.markedForDeletionBy||"?")} (${T(c)})
          </span>
        </div>
        <div class="pending-deletion-actions">
          <button class="pending-deletion-btn approve" data-fault-id="${L(o.id)}" title="${L(f("approveDeletion",r))}">
            ${yt(16,2.5)}
          </button>
          <button class="pending-deletion-btn reject" data-fault-id="${L(o.id)}" title="${L(f("rejectDeletion",r))}">
            ${Oc(16)}
          </button>
        </div>
      </div>
    `}).join("");e.innerHTML=a,e.querySelectorAll(".pending-deletion-btn.approve").forEach(o=>{o.addEventListener("click",c=>{c.stopPropagation();const u=o.dataset.faultId;if(u){const d=i.find(h=>h.id===u);d&&ku(d)}})}),e.querySelectorAll(".pending-deletion-btn.reject").forEach(o=>{o.addEventListener("click",c=>{c.stopPropagation();const u=o.dataset.faultId;if(u){const d=i.find(h=>h.id===u);d&&Ar(d)}})})}function Cu(t){const e=t.currentTarget,n=e.dataset.bib,i=e.dataset.run;if(!n||!i)return;const s=parseInt(i,10);l.finalizeRacer(n,s),G();const r=l.getState();w(`#${n.padStart(3,"0")} ${f("finalized",r.currentLang)}`,"success"),ct()}function Tu(){Zt&&(Zt(),Zt=null),$e.removeAll()}const Lu=Object.freeze(Object.defineProperty({__proto__:null,cleanupChiefJudgeView:Tu,initChiefJudgeToggle:Eu,resolvePinVerification:li,updateChiefJudgeToggleVisibility:di,updateChiefJudgeView:ui,updateFaultSummaryPanel:ct,updateJudgesOverview:$i,updatePenaltyConfigUI:Fi,updatePendingDeletionsPanel:At},Symbol.toStringTag,{value:"Module"})),K=new O,bn=new Set;function te(t,e,n){const i=e.getBoundingClientRect();let s,r;typeof TouchEvent<"u"&&t instanceof TouchEvent&&t.touches.length>0?(s=t.touches[0].clientX-i.left,r=t.touches[0].clientY-i.top):typeof MouseEvent<"u"&&t instanceof MouseEvent?(s=t.clientX-i.left,r=t.clientY-i.top):(s=i.width/2,r=i.height/2);const a=document.createElement("span");a.classList.add("ripple"),n&&a.classList.add(`ripple-${n}`);const o=Math.max(i.width,i.height)*2;a.style.width=`${o}px`,a.style.height=`${o}px`,a.style.left=`${s-o/2}px`,a.style.top=`${r-o/2}px`,e.appendChild(a);const c=setTimeout(()=>{a.remove(),bn.delete(c)},500);bn.add(c)}function Au(){document.querySelectorAll(".num-btn").forEach(e=>{e.classList.add("ripple-container"),K.add(e,"touchstart",n=>te(n,e),{passive:!0}),K.add(e,"mousedown",n=>te(n,e))});const t=document.querySelector(".timestamp-btn");t&&(t.classList.add("ripple-container"),K.add(t,"touchstart",e=>te(e,t,"primary"),{passive:!0}),K.add(t,"mousedown",e=>te(e,t,"primary"))),document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.add("ripple-container");const n=e.getAttribute("data-point")==="S";K.add(e,"touchstart",i=>te(i,e,n?"success":"secondary"),{passive:!0}),K.add(e,"mousedown",i=>te(i,e,n?"success":"secondary"))}),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.add("ripple-container"),K.add(e,"touchstart",n=>te(n,e,"primary"),{passive:!0}),K.add(e,"mousedown",n=>te(n,e,"primary"))}),document.querySelectorAll(".action-btn").forEach(e=>{e.classList.add("ripple-container"),K.add(e,"touchstart",n=>te(n,e),{passive:!0}),K.add(e,"mousedown",n=>te(n,e))}),document.querySelectorAll(".modal-btn").forEach(e=>{e.classList.add("ripple-container");const n=e.classList.contains("primary"),i=e.classList.contains("danger"),s=n?"primary":i?"secondary":void 0;K.add(e,"touchstart",r=>te(r,e,s),{passive:!0}),K.add(e,"mousedown",r=>te(r,e,s))})}function Ru(){K.removeAll(),bn.forEach(t=>clearTimeout(t)),bn.clear()}const Rr=new O;function ne(t,e){Rr.add(window,t,e)}function Du(){ne("open-edit-modal",t=>{Gl(t.detail.entry)}),ne("prompt-delete",t=>{ql(t.detail.entry)}),ne("open-confirm-modal",t=>{rr(t.detail.action)}),ne("request-photo-sync-warning",async()=>{try{await Ml(),bs()}catch(t){y.error("Photo sync warning modal failed:",t),bs()}}),ne("request-race-change-dialog",async t=>{try{const e=t,n=await $l(e.detail.type,e.detail.lang);Ss(n)}catch(e){y.error("Race change dialog failed:",e),Ss("cancel")}}),ne("update-role-toggle",()=>{Rn()}),ne("request-pin-verification",async t=>{try{const n=await Ll(t.detail.lang);li(n)}catch(e){y.error("PIN verification failed:",e),li(!1)}}),ne("open-fault-edit-modal",t=>{Js(t.detail.fault)}),ne("open-mark-deletion-modal",t=>{js(t.detail.fault)}),ne("update-inline-faults-list",()=>{Cn()}),ne("update-inline-bib-selector",()=>{Ws()}),ne("update-inline-gate-selector",()=>{Qs()})}function xu(){if(!H.isSupported()){y.debug("[VoiceMode] Not supported in this browser");return}const t="/api/v1/voice",e=window.VOICE_LLM_CONFIG,n={endpoint:(e==null?void 0:e.endpoint)||t,apiKey:(e==null?void 0:e.apiKey)||"proxy"};if(!H.initialize(n)){y.warn("[VoiceMode] Failed to initialize");return}H.onStatusChange(s=>{mu(s)}),H.onAction(s=>{l.getState().deviceRole==="gateJudge"?ur(s):fu(s)}),y.debug("[VoiceMode] Initialized successfully")}function Dr(t){const{isQuotaError:e,entryCount:n}=t.detail,i=l.getState().currentLang;e?w(f("storageNearlyFull",i),"error",et.CRITICAL):w(f("storageError",i),"error",et.ERROR),z(),y.error("[Storage] saveEntries:",t.detail.message,{entryCount:n,isQuotaError:e})}function xr(t){const{percent:e,critical:n}=t.detail,i=l.getState().currentLang;n?w(`${f("storageQuotaError",i)} (${e}%)`,"error",et.CRITICAL):sessionStorage.getItem("storage-warning-shown")||(w(f("storageNearlyFull",i),"warning",et.WARNING),sessionStorage.setItem("storage-warning-shown","true"))}function Bu(){try{nu(),vd()}catch(t){y.warn("Timer cleanup error:",t)}$.cleanup(),Qe.stop(),me.stop(),ln.disable(),Z.cleanup(),H.cleanup(),Xc(),Ru(),document.querySelectorAll(".ripple").forEach(t=>t.remove()),window.removeEventListener("race-deleted",ir),window.removeEventListener("auth-expired",sr),window.removeEventListener("storage-error",Dr),window.removeEventListener("storage-warning",xr),Rr.removeAll(),Dd(),Xd(),tr()}function fi(t){const e=t.currentView==="timer";e&&t.settings.gps?me.start():t.settings.gps?me.pause():me.stop(),e&&t.settings.photoCapture?Qe.initialize():Qe.stop()}const _t=new O;function Pu(){if(l.getState().settings.sync&&l.getState().raceId)if(Le())$.initialize();else{l.updateSettings({sync:!1});const n=document.getElementById("sync-toggle");n&&(n.checked=!1),setTimeout(()=>{const i=l.getState().currentLang;w(f("syncRequiresPin",i),"info",5e3)},500)}fi(l.getState()),_t.add(window,"race-deleted",ir),_t.add(window,"auth-expired",sr),_t.add(window,"storage-error",Dr),_t.add(window,"storage-warning",xr),document.addEventListener("click",Wi,{once:!0}),document.addEventListener("touchstart",Wi,{once:!0}),Ir();const e=l.getState();e.currentView==="timer"&&ln.enable(),e.settings.ambientMode&&(Z.initialize(),e.currentView==="timer"&&Z.enable()),Z.subscribe(n=>{document.body.classList.toggle("ambient-mode",n.isActive),n.triggeredBy?document.body.dataset.ambientTrigger=n.triggeredBy:delete document.body.dataset.ambientTrigger;const i=l.getState();i.settings.gps&&(n.isActive?me.pause():i.currentView==="timer"&&me.start())}),xu()}const Nu={bibInput:[()=>{yn()?pr():Bi()}],selectedPoint:[()=>{yn()||Pi()}],selectedRun:[t=>{Ni(),Ln(),t.currentView==="gateJudge"&&we()}],entries:[t=>{const e=yr();e&&e.setEntries(t.entries),An(),vr(),t.currentView==="gateJudge"&&we()}],deviceRole:[()=>{Rn(),Tn(),Fe()}],isJudgeReady:[()=>Fe()],gateAssignment:[()=>Lt()],faultEntries:[t=>{t.currentView==="gateJudge"&&we()}],syncStatus:[()=>kt()],cloudDeviceCount:[()=>kt()],gpsStatus:[()=>{Dn(),Fe()}],undoStack:[()=>Lr()]};function Fu(t){Cr(),Dn(),kt(),t.currentView==="timer"?ln.enable():ln.disable(),t.currentView==="timer"&&t.settings.ambientMode?Z.enable():Z.disable();const e=yr();e&&(t.currentView==="results"?e.resume():e.pause())}function $u(){kt(),Dn(),Fe(),Tr(),kr();const t=l.getState();t.settings.ambientMode?(Z.initialize(),t.currentView==="timer"&&Z.enable()):Z.disable()}function Mu(t,e){e.includes("currentView")&&Fu(t),e.includes("settings")&&($u(),fi(t)),e.includes("currentView")&&!e.includes("settings")&&fi(t);for(const n of e){const i=Nu[n];if(i)for(const s of i)s(t)}}let xn=!1;const Yn=new O;function Br(){if(xn)return;const t=document.getElementById("offline-banner");if(t){const e=l.getState().currentLang,n=document.getElementById("offline-banner-text");n&&(n.textContent=f("offlineBanner",e)),t.classList.remove("hidden")}}function Pr(){const t=document.getElementById("offline-banner");t&&t.classList.add("hidden")}function Ou(){Pr(),xn=!1;const t=l.getState().currentLang;w(f("onlineRestored",t),"success",2e3)}function Vu(){xn=!1,Br()}function _u(){const t=document.getElementById("offline-banner-dismiss");t&&Yn.add(t,"click",()=>{xn=!0,Pr()}),Yn.add(window,"online",Ou),Yn.add(window,"offline",Vu),navigator.onLine||Br()}const Kn="skiTimerHasCompletedOnboarding";function Hu(t,e){let n=null;return(...i)=>{n&&clearTimeout(n),n=setTimeout(()=>t(...i),e)}}class zu{constructor(){g(this,"modal");g(this,"currentStep",1);g(this,"totalSteps",6);g(this,"selectedRole","timer");g(this,"updateTranslationsCallback",null);g(this,"recentRacesDocumentHandler",null);g(this,"listeners",new O);this.modal=document.getElementById("onboarding-modal"),this.modal&&this.setupEventListeners()}setUpdateTranslationsCallback(e){this.updateTranslationsCallback=e}shouldShow(){return localStorage.getItem(Kn)!=="true"}show(){if(!this.modal)return;this.currentStep=1,this.selectedRole="timer",this.modal.querySelectorAll(".onboarding-card").forEach((d,h)=>{d.style.display=h===0?"block":"none"});const e=document.getElementById("onboarding-race-id");e&&(e.value="");const n=document.getElementById("onboarding-pin");n&&(n.value="",n.style.display="none");const i=document.getElementById("onboarding-race-status");i&&(i.textContent="",i.className="race-status");const s=document.getElementById("onboarding-sync-toggle");s&&(s.checked=!0);const r=document.getElementById("onboarding-photo-toggle");r&&(r.checked=!1),this.modal.querySelectorAll(".role-card").forEach(d=>{const h=d.getAttribute("data-role")==="timer";d.classList.toggle("selected",h),d.setAttribute("aria-checked",String(h))});const a=document.getElementById("onboarding-gate-start"),o=document.getElementById("onboarding-gate-end");a&&(a.value="1"),o&&(o.value="10"),this.updateUI(),V(this.modal);const c=document.getElementById("onboarding-device-name");c&&(c.value=l.getState().deviceName);const u=l.getState().currentLang;this.modal.querySelectorAll(".lang-btn").forEach(d=>{const h=d.dataset.lang;d.classList.toggle("selected",h===u)})}reset(){localStorage.removeItem(Kn)}setupEventListeners(){if(!this.modal)return;this.listeners.add(document,"keydown",r=>{var a;r.key==="Escape"&&((a=this.modal)!=null&&a.classList.contains("active"))&&this.dismiss()}),this.modal.querySelectorAll(".lang-btn").forEach(r=>{this.listeners.add(r,"click",a=>{const o=a.currentTarget,c=o.dataset.lang;c&&(l.setLanguage(c),this.modal.querySelectorAll(".lang-btn").forEach(u=>u.classList.remove("selected")),o.classList.add("selected"),I(),this.updateTranslationsCallback&&this.updateTranslationsCallback(),this.updateOnboardingTranslations())})}),this.modal.querySelectorAll("[data-action]").forEach(r=>{this.listeners.add(r,"click",async a=>{const c=a.currentTarget.dataset.action;c&&(I(),await this.handleAction(c))})});const e=document.getElementById("onboarding-regenerate-name");e&&this.listeners.add(e,"click",()=>{const r=document.getElementById("onboarding-device-name");r&&(r.value=an(),I())}),this.modal.querySelectorAll(".role-card").forEach(r=>{this.listeners.add(r,"click",()=>{const a=r.getAttribute("data-role");a&&(this.selectedRole=a,this.modal.querySelectorAll(".role-card").forEach(o=>{const c=o===r;o.classList.toggle("selected",c),o.setAttribute("aria-checked",String(c))}),I())})});const n=document.getElementById("onboarding-race-id");if(n){const r=Hu(()=>this.checkRaceExists(),500);this.listeners.add(n,"input",()=>{r();const a=document.getElementById("onboarding-pin");a&&(a.style.display=n.value.trim()?"block":"none")})}const i=document.getElementById("onboarding-recent-races-btn"),s=document.getElementById("onboarding-recent-races-dropdown");i&&s&&(this.listeners.add(i,"click",()=>{I(),s.style.display==="none"?(this.showRecentRacesDropdown(s,"onboarding-race-id"),i.setAttribute("aria-expanded","true")):(s.style.display="none",i.setAttribute("aria-expanded","false"))}),this.recentRacesDocumentHandler||(this.recentRacesDocumentHandler=r=>{const a=r.target;!i.contains(a)&&!s.contains(a)&&(s.style.display="none",i.setAttribute("aria-expanded","false"))},this.listeners.add(document,"click",this.recentRacesDocumentHandler)))}async showRecentRacesDropdown(e,n){const i=l.getState().currentLang;e.innerHTML=`<div class="recent-races-empty">${f("loading",i)}</div>`,e.style.display="block";let s=[];if(Le())try{s=await this.fetchRacesFromApi()}catch(r){y.warn("Failed to fetch races from API:",r),s=on()}else s=on();s.length===0?e.innerHTML=`<div class="recent-races-empty">${f("noRecentRaces",i)}</div>`:(e.innerHTML=Sr(s),Er(e,s,r=>{this.selectRecentRace(r,n,e)}))}async fetchRacesFromApi(){const e=localStorage.getItem("skiTimerAuthToken");if(!e)return[];const n=await ae("/api/v1/admin/races",{headers:{Authorization:`Bearer ${e}`}},5e3);if(!n.ok)throw new Error(`API error: ${n.status}`);const s=(await n.json()).races||[],r=new Date;r.setHours(0,0,0,0);const a=r.getTime(),o=s.filter(c=>c.lastUpdated&&c.lastUpdated>=a).map(c=>({raceId:c.raceId,createdAt:c.lastUpdated||Date.now(),lastUpdated:c.lastUpdated||Date.now(),entryCount:c.entryCount})).slice(0,5);return o.forEach(c=>{vi(c.raceId,c.lastUpdated,c.entryCount)}),o}selectRecentRace(e,n,i){const s=document.getElementById(n);s&&(s.value=e.raceId,s.dispatchEvent(new Event("input",{bubbles:!0})),I()),i.style.display="none"}updateOnboardingTranslations(){if(!this.modal)return;const e=l.getState().currentLang;this.modal.querySelectorAll("[data-i18n]").forEach(n=>{const i=n.getAttribute("data-i18n");i&&(n.textContent=f(i,e))})}async handleAction(e){switch(e){case"next":await this.validateCurrentStep()&&(await this.saveCurrentStep(),l.forceSave(),this.goToStep(this.currentStep+1));break;case"back":this.currentStep>1&&this.goToStep(this.currentStep-1);break;case"skip":l.forceSave(),this.goToStep(this.currentStep+1);break;case"finish":this.complete();break;case"dismiss":this.dismiss();break}}finalize(){if(l.forceSave(),localStorage.setItem(Kn,"true"),M(this.modal),this.selectedRole==="gateJudge"){l.setView("gateJudge");const e=document.getElementById("gate-judge-tab");e&&(e.style.display="")}else l.setView("timer");this.listeners.removeAll(),this.recentRacesDocumentHandler=null}dismiss(){const e=document.getElementById("onboarding-device-name");e!=null&&e.value.trim()&&l.setDeviceName(e.value.trim()),l.setDeviceRole(this.selectedRole),this.finalize()}async validateCurrentStep(){var n,i,s,r;const e=l.getState().currentLang;switch(this.currentStep){case 2:return!0;case 3:return((n=document.getElementById("onboarding-device-name"))==null?void 0:n.value.trim())?!0:(w(f("deviceName",e),"warning"),!1);case 4:return!0;case 5:{const a=(i=document.getElementById("onboarding-race-id"))==null?void 0:i.value.trim(),o=(s=document.getElementById("onboarding-sync-toggle"))==null?void 0:s.checked;if(!a||!o)return!0;const c=(r=document.getElementById("onboarding-pin"))==null?void 0:r.value;return c.length!==4?(w(f("invalidPin",e),"warning"),!1):await this.validatePin(c)}default:return!0}}async saveCurrentStep(){var e,n,i,s,r,a;switch(this.currentStep){case 2:{l.setDeviceRole(this.selectedRole);break}case 3:{const o=(e=document.getElementById("onboarding-device-name"))==null?void 0:e.value.trim();o&&l.setDeviceName(o);break}case 4:{if(this.selectedRole==="gateJudge"){const o=parseInt(((n=document.getElementById("onboarding-gate-start"))==null?void 0:n.value)||"1",10),c=parseInt(((i=document.getElementById("onboarding-gate-end"))==null?void 0:i.value)||"10",10),u=Math.min(o,c),d=Math.max(o,c);l.setGateAssignment([u,d])}else{const o=(s=document.getElementById("onboarding-photo-toggle"))==null?void 0:s.checked;l.updateSettings({photoCapture:o})}break}case 5:{const o=(r=document.getElementById("onboarding-race-id"))==null?void 0:r.value.trim(),c=(a=document.getElementById("onboarding-sync-toggle"))==null?void 0:a.checked;o&&l.setRaceId(o);const u=c&&!!o;l.updateSettings({sync:u}),u&&$.initialize();break}}}goToStep(e){if(!(!this.modal||e<1||e>this.totalSteps)){if(this.modal.querySelectorAll(`[data-step="${this.currentStep}"]`).forEach(n=>{n.style.display="none"}),this.currentStep=e,e===4){const n=this.modal.querySelector(`[data-step="4"][data-path="${this.selectedRole}"]`);n&&(n.style.display="block")}else{const n=this.modal.querySelector(`[data-step="${e}"]:not([data-path])`);n&&(n.style.display="block")}this.updateUIForRole(),this.updateProgressDots(),e===6&&this.showSummary()}}updateUIForRole(){const e=l.getState().currentLang,n=document.getElementById("onboarding-device-name-title"),i=document.getElementById("onboarding-device-name-desc");this.selectedRole==="gateJudge"?(n&&(n.textContent=f("onboardingDeviceNameJudge",e)),i&&(i.textContent=f("onboardingDeviceNameJudgeDesc",e))):(n&&(n.textContent=f("onboardingDeviceName",e)),i&&(i.textContent=f("onboardingDeviceNameDesc",e)));const s=document.getElementById("onboarding-ready-title"),r=document.getElementById("onboarding-ready-tip"),a=document.getElementById("onboarding-finish-btn");this.selectedRole==="gateJudge"?(s&&(s.textContent=f("onboardingReadyJudge",e)),r&&(r.textContent=f("onboardingTipJudge",e)),a&&(a.textContent=f("startJudging",e))):(s&&(s.textContent=f("onboardingReady",e)),r&&(r.textContent=f("onboardingTip",e)),a&&(a.textContent=f("startTiming",e)))}updateProgressDots(){if(!this.modal)return;const e=this.modal.querySelectorAll(".progress-dot");e.forEach((i,s)=>{i.classList.remove("active","completed"),s+1===this.currentStep?i.classList.add("active"):s+1<this.currentStep&&i.classList.add("completed")});const n=this.modal.querySelector("#onboarding-progress-label");if(n){const i=e.length,s=l.getState().currentLang;n.textContent=s==="de"?`Schritt ${this.currentStep} von ${i}`:`Step ${this.currentStep} of ${i}`}}updateUI(){this.updateProgressDots(),this.updateOnboardingTranslations()}showSummary(){const e=l.getState(),n=e.currentLang,i=document.getElementById("onboarding-summary");if(i){i.innerHTML="";const s=[],r=this.selectedRole==="gateJudge"?f("roleJudgeTitle",n):f("roleTimerTitle",n);s.push({label:f("deviceRole",n),value:r,badge:"role"});const a=this.selectedRole==="gateJudge"?f("onboardingDeviceNameJudge",n):f("deviceNameLabel",n);if(s.push({label:a,value:e.deviceName}),this.selectedRole==="gateJudge"){const u=e.gateAssignment;s.push({label:f("gates",n),value:u?`${u[0]}–${u[1]}`:"—"})}else{const u=e.settings.photoCapture;s.push({label:f("photoCaptureLabel",n),value:f(u?"enabled":"disabled",n),badge:u?"enabled":"disabled"})}s.push({label:f("raceIdLabel",n),value:e.raceId||"—"});const o=e.settings.sync;s.push({label:f("syncStatusLabel",n),value:f(o?"enabled":"disabled",n),badge:o?"enabled":"disabled"});const c=document.createElement("div");c.className="onboarding-summary-list",s.forEach(({label:u,value:d,badge:h})=>{const m=document.createElement("div");m.className="onboarding-summary-row";const p=document.createElement("span");p.className="onboarding-summary-label",p.textContent=u;const v=document.createElement("span");h?v.className=`onboarding-summary-badge ${h}`:v.className="onboarding-summary-value",v.textContent=d,m.append(p,v),c.appendChild(m)}),i.appendChild(c)}}async checkRaceExists(){const e=document.getElementById("onboarding-race-id"),n=document.getElementById("onboarding-race-status");if(!e||!n)return;const i=e.value.trim(),s=l.getState().currentLang;if(!i){n.textContent="",n.className="race-status";return}n.innerHTML=`${zc(14)} ${T(f("loading",s))}`,n.className="race-status loading";const r=await $.checkRaceExists(i);if(r.exists){const a=r.entryCount===1?f("entry",s):f("entries",s);n.innerHTML=`${yt(14)} ${T(f("raceFound",s))} (${T(String(r.entryCount))} ${T(a)})`,n.className="race-status found"}else n.textContent=`+ ${f("raceNew",s)}`,n.className="race-status new"}async validatePin(e){try{return(await Ms(e)).success}catch{const n=l.getState().currentLang;return w(`${f("networkError",n)} - ${f("pinVerifyOnline",n)}`,"warning",5e3),!0}}complete(){this.finalize(),G(),w(f("onboardingComplete",l.getState().currentLang),"success")}}const Re=new O;let De=null;function Is(){const t=document.getElementById("app-version");t&&(t.textContent="5.21.0");const e=ci("5.21.0"),n=document.getElementById("app-version-name"),i=document.getElementById("app-version-description");e&&n&&(n.textContent=`"${e.name}"`),e&&i&&(i.textContent=e.description);const s=document.getElementById("version-info-btn");s&&Re.add(s,"click",async()=>{const p=l.getState(),v=ci("5.21.0"),E=[v?`Ski Race Timer v5.21.0 "${v.name}"`:"Ski Race Timer v5.21.0",`Device: ${p.deviceName||"Unknown"}`,`Role: ${p.deviceRole}`,`Race ID: ${p.raceId||"None"}`,`Entries: ${p.entries.length}`,`Sync: ${p.settings.sync?"On":"Off"}`,`Language: ${p.currentLang.toUpperCase()}`,`User Agent: ${navigator.userAgent}`,`Screen: ${window.screen.width}x${window.screen.height}`,`Viewport: ${window.innerWidth}x${window.innerHeight}`,`Online: ${navigator.onLine}`,`Timestamp: ${new Date().toISOString()}`].join(`
`);try{await navigator.clipboard.writeText(E),w(f("debugInfoCopied",p.currentLang),"success")}catch{w(f("debugInfoCopyFailed",p.currentLang),"warning")}I()}),iu(),yn()?ld():(tu(),su(),ru(),au(),ou()),Ld(),Kd();const r=()=>{Xn(()=>Promise.resolve().then(()=>rd),void 0).then(p=>p.initGateJudgeView()).catch(p=>y.error("Failed to load gateJudgeView:",p)),Xn(()=>Promise.resolve().then(()=>Lu),void 0).then(p=>p.initChiefJudgeToggle()).catch(p=>y.error("Failed to load chiefJudgeView:",p))},a=l.getState().deviceRole;a==="gateJudge"&&r();let o=a;l.subscribe((p,v)=>{v.includes("deviceRole")&&p.deviceRole!==o&&(o=p.deviceRole,o==="gateJudge"&&r())}),Du(),Ul(),_l(),Au(),_u(),l.subscribe(Mu),Pu(),Re.add(window,"beforeunload",Bu),hu(),De=new zu,De.setUpdateTranslationsCallback(()=>Di()),De.shouldShow()&&De.show();const c=document.getElementById("show-tutorial-btn");c&&Re.add(c,"click",()=>{De&&(De.reset(),De.show(),I())});const u=document.getElementById("keyboard-shortcuts-modal"),d=document.getElementById("show-shortcuts-btn"),h=document.getElementById("shortcuts-close-btn"),m=document.getElementById("shortcuts-done-btn");d&&u&&Re.add(d,"click",()=>{V(u),I()}),h&&u&&Re.add(h,"click",()=>M(u)),m&&u&&Re.add(m,"click",()=>M(u)),Re.add(document,"keydown",p=>{if(p.key==="?"&&!qs()){const v=p.target;if(v.tagName==="INPUT"||v.tagName==="TEXTAREA"||v.tagName==="SELECT")return;p.preventDefault(),u&&V(u)}})}let Zn=!1,ht=[];const Uu=3,Gu=1e4;function qu(){window.addEventListener("error",Ju),window.addEventListener("unhandledrejection",ju),window.addEventListener("critical-error",Wu)}function Ju(t){const{message:e,error:n}=t;kn("Global","uncaught error",n||e,void 0),Nr(e),Fr()&&Mi(e),t.preventDefault()}function ju(t){const e=t.reason,n=e instanceof Error?e.message:String(e);kn("Global","unhandled rejection",e,void 0),Nr(n),Fr()&&Mi(n),t.preventDefault()}function Wu(t){var i;const e=t.detail,n=((i=e==null?void 0:e.error)==null?void 0:i.message)||"Critical error occurred";Zo("Global","critical error event",e==null?void 0:e.error,void 0),Mi(n)}function Nr(t){const e=Date.now();ht.push({message:t,timestamp:e}),ht=ht.filter(n=>e-n.timestamp<Gu)}function Fr(){return ht.length>=Uu}function Mi(t){var s,r;if(Zn)return;Zn=!0;const e=l.getState().currentLang,n=document.createElement("div");n.id="error-boundary-overlay",n.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 24px;
  `;const i=document.createElement("div");i.style.cssText=`
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    text-align: center;
    color: #fff;
  `,i.innerHTML=`
    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
    <h2 style="margin: 0 0 8px; font-size: 1.25rem;">${f("errorOccurred",e)}</h2>
    <p style="color: #999; font-size: 0.875rem; margin: 0 0 16px;">
      ${f("errorRecoveryMessage",e)}
    </p>
    <p style="color: #666; font-size: 0.75rem; font-family: monospace; margin: 0 0 24px; word-break: break-word;">
      ${Qu(t.substring(0,200))}
    </p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="error-dismiss-btn" style="
        padding: 12px 24px;
        border: 1px solid #444;
        border-radius: 8px;
        background: transparent;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${f("dismiss",e)}</button>
      <button id="error-reload-btn" style="
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #3B82F6;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${f("reload",e)}</button>
    </div>
  `,n.appendChild(i),document.body.appendChild(n),setTimeout(()=>{const a=document.getElementById("error-dismiss-btn");a==null||a.focus()},100),(s=document.getElementById("error-dismiss-btn"))==null||s.addEventListener("click",()=>{n.remove(),Zn=!1,ht=[]}),(r=document.getElementById("error-reload-btn"))==null||r.addEventListener("click",()=>{window.location.reload()})}function Qu(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}qu();Xr();Ii();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Is):Is();let en=null;W.initialize().then(()=>{en=W.subscribe(t=>{document.body.classList.toggle("power-saver",t.batteryLevel!=="normal")})}).catch(()=>{});window.addEventListener("beforeunload",()=>{en&&(en(),en=null)});
