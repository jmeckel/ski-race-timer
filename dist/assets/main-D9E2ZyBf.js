var Gt=Object.defineProperty;var jt=(n,e,t)=>e in n?Gt(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var d=(n,e,t)=>jt(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function Qt(n){const e=Date.now(),t=crypto.randomUUID().slice(0,8);return`${n}-${e}-${t}`}const de=["swift","bold","cool","fast","keen","wild","calm","warm","bright","sharp","quick","brave","fresh","grand","prime","clear","snow","ice","frost","peak","alpine","polar","winter","crisp"],ue=["fox","bear","wolf","hawk","eagle","tiger","lion","deer","pine","oak","cedar","birch","maple","spruce","aspen","willow","peak","ridge","slope","trail","summit","valley","glacier","cliff"];function Je(n){return n.charAt(0).toUpperCase()+n.slice(1)}function Wt(){const n=de[Math.floor(Math.random()*de.length)],e=ue[Math.floor(Math.random()*ue.length)],t=Math.floor(Math.random()*100);return`dev_${n}-${e}-${t}`}function he(){const n=de[Math.floor(Math.random()*de.length)],e=ue[Math.floor(Math.random()*ue.length)],t=Math.floor(Math.random()*100);return`${Je(n)} ${Je(e)} ${t}`}const ge=2,Yt=["S","F"],Jt=["ok","dns","dnf","dsq"];function V(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"&&typeof e.id!="number"||typeof e.id=="string"&&e.id.length===0||typeof e.id=="number"&&e.id<=0||e.bib!==void 0&&typeof e.bib!="string"||typeof e.bib=="string"&&e.bib.length>10||!Yt.includes(e.point)||!e.timestamp||typeof e.timestamp!="string"||isNaN(Date.parse(e.timestamp))||e.status!==void 0&&!Jt.includes(e.status)||e.deviceId!==void 0&&typeof e.deviceId!="string"||e.deviceName!==void 0&&typeof e.deviceName!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||e.syncedAt<0||!Number.isFinite(e.syncedAt))||e.photo!==void 0&&typeof e.photo!="string")return!1;if(e.gpsCoords!==void 0){if(typeof e.gpsCoords!="object"||e.gpsCoords===null)return!1;const t=e.gpsCoords;if(typeof t.latitude!="number"||!Number.isFinite(t.latitude)||typeof t.longitude!="number"||!Number.isFinite(t.longitude)||typeof t.accuracy!="number"||!Number.isFinite(t.accuracy)||t.accuracy<0)return!1}return!0}function Zt(n){if(!n||typeof n!="object")return!1;const e=n;return!(!V(e.entry)||typeof e.retryCount!="number"||e.retryCount<0||typeof e.lastAttempt!="number"||e.lastAttempt<0)}function ft(n){return!n||typeof n!="string"||n.length>50?!1:/^[a-zA-Z0-9_-]+$/.test(n)}function Kt(n){return!n||typeof n!="string"?!1:n.startsWith("dev_")&&n.length>4}function oe(n,e=100){return!n||typeof n!="string"?"":n.slice(0,e).replace(/[<>"'&]/g,"").replace(/[\x00-\x1F\x7F]/g,"")}function Xt(n,e){if(!V(n))return null;const t=n;return{id:(typeof t.id=="number",String(t.id)),bib:oe(t.bib,10),point:t.point,run:t.run??1,timestamp:t.timestamp,status:t.status||"ok",deviceId:oe(t.deviceId||e,50),deviceName:oe(t.deviceName||"Unknown Device",100),syncedAt:t.syncedAt,photo:t.photo,gpsCoords:t.gpsCoords}}function en(n,e){const t={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!1,simple:!0,photoCapture:!1};if(!n||typeof n!="object")return{version:ge,entries:[],settings:t,deviceId:e,deviceName:he(),raceId:"",syncQueue:[]};const i=n;let s=[];Array.isArray(i.entries)&&(s=i.entries.map(a=>Xt(a,e)).filter(a=>a!==null));let r=t;if(i.settings&&typeof i.settings=="object"){const a=i.settings;r={auto:typeof a.auto=="boolean"?a.auto:t.auto,haptic:typeof a.haptic=="boolean"?a.haptic:t.haptic,sound:typeof a.sound=="boolean"?a.sound:t.sound,sync:typeof a.sync=="boolean"?a.sync:t.sync,syncPhotos:typeof a.syncPhotos=="boolean"?a.syncPhotos:t.syncPhotos,gps:typeof a.gps=="boolean"?a.gps:t.gps,simple:typeof a.simple=="boolean"?a.simple:t.simple,photoCapture:typeof a.photoCapture=="boolean"?a.photoCapture:t.photoCapture}}let o=[];return Array.isArray(i.syncQueue)&&(o=i.syncQueue.filter(Zt)),{version:ge,entries:s,settings:r,deviceId:Kt(i.deviceId)?i.deviceId:e,deviceName:oe(i.deviceName,100)||he(),raceId:ft(i.raceId)?i.raceId:"",syncQueue:o,lastExport:typeof i.lastExport=="number"?i.lastExport:void 0}}const S={ENTRIES:"skiTimerEntries",SETTINGS:"skiTimerSettings",LANG:"skiTimerLang",DEVICE_ID:"skiTimerDeviceId",DEVICE_NAME:"skiTimerDeviceName",RACE_ID:"skiTimerRaceId",LAST_SYNCED_RACE_ID:"skiTimerLastSyncedRaceId",SYNC_QUEUE:"skiTimerSyncQueue",SCHEMA_VERSION:"skiTimerSchemaVersion"},Ze={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!1,simple:!0,photoCapture:!1},tn=50;class nn{constructor(){d(this,"state");d(this,"listeners",new Set);d(this,"saveTimeout",null);d(this,"isNotifying",!1);d(this,"pendingNotifications",[]);d(this,"listenerErrorCallback",null);d(this,"failedListenerCount",0);this.state=this.loadInitialState()}loadInitialState(){let e=localStorage.getItem(S.DEVICE_ID);e||(e=Wt(),localStorage.setItem(S.DEVICE_ID,e));const t=localStorage.getItem(S.ENTRIES),i=localStorage.getItem(S.SETTINGS),s=localStorage.getItem(S.SYNC_QUEUE);let r=[],o=Ze,a=[];try{if(t){const m=JSON.parse(t);Array.isArray(m)&&(r=m.filter(E=>V(E)).map(E=>({...E,run:E.run??1})))}}catch(m){console.error("Failed to parse entries:",m)}try{if(i){const m=JSON.parse(i);o={...Ze,...m}}}catch(m){console.error("Failed to parse settings:",m)}try{if(s){const m=JSON.parse(s);Array.isArray(m)&&(a=m)}}catch(m){console.error("Failed to parse sync queue:",m)}const l=localStorage.getItem(S.LANG)||"de";let g=localStorage.getItem(S.DEVICE_NAME);g||(g=he(),localStorage.setItem(S.DEVICE_NAME,g));const h=localStorage.getItem(S.RACE_ID)||"",p=localStorage.getItem(S.LAST_SYNCED_RACE_ID)||"";return{currentView:"timer",currentLang:l,bibInput:"",selectedPoint:"F",selectedRun:1,selectMode:!1,selectedEntries:new Set,isRecording:!1,lastRecordedEntry:null,entries:r,undoStack:[],redoStack:[],settings:o,deviceId:e,deviceName:g,raceId:h,lastSyncedRaceId:p,syncStatus:"disconnected",syncQueue:a,connectedDevices:new Map,cloudDeviceCount:0,cloudHighestBib:0,raceExistsInCloud:null,gpsEnabled:o.gps,gpsAccuracy:null,gpsStatus:"inactive",cameraReady:!1,cameraError:null}}getState(){return this.state}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e){if(this.pendingNotifications.push({keys:e,stateSnapshot:this.state}),!this.isNotifying){this.isNotifying=!0;try{for(;this.pendingNotifications.length>0;){const{keys:t,stateSnapshot:i}=this.pendingNotifications.shift(),s=Array.from(this.listeners);for(const r of s)try{r(i,t)}catch(o){if(console.error("State listener error:",o),this.failedListenerCount++,this.listenerErrorCallback)try{this.listenerErrorCallback(o,r)}catch{}}}}finally{this.isNotifying=!1}}}onListenerError(e){this.listenerErrorCallback=e}getListenerFailureCount(){return this.failedListenerCount}setState(e,t=!0){const i=Object.keys(e);this.state={...this.state,...e},this.notify(i),t&&this.scheduleSave()}scheduleSave(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveToStorage(),100)}saveToStorage(){try{this.checkStorageQuota();const e=this.state.entries.map(t=>t.photo&&t.photo!=="indexeddb"&&t.photo.length>20?{...t,photo:"indexeddb"}:t);localStorage.setItem(S.ENTRIES,JSON.stringify(e)),localStorage.setItem(S.SETTINGS,JSON.stringify(this.state.settings)),localStorage.setItem(S.LANG,this.state.currentLang),localStorage.setItem(S.DEVICE_NAME,this.state.deviceName),localStorage.setItem(S.RACE_ID,this.state.raceId),localStorage.setItem(S.LAST_SYNCED_RACE_ID,this.state.lastSyncedRaceId),localStorage.setItem(S.SYNC_QUEUE,JSON.stringify(this.state.syncQueue)),localStorage.setItem(S.SCHEMA_VERSION,String(ge))}catch(e){console.error("Failed to save to storage:",e),this.dispatchStorageError(e)}}async checkStorageQuota(){var e;if((e=navigator.storage)!=null&&e.estimate)try{const{usage:t,quota:i}=await navigator.storage.estimate();if(i&&t){const s=t/i;s>.9&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t,quota:i,percent:Math.round(s*100)}}))}}catch(t){console.warn("Could not check storage quota:",t)}}dispatchStorageError(e){window.dispatchEvent(new CustomEvent("storage-error",{detail:{message:e.message,isQuotaError:e.name==="QuotaExceededError"||e.message.includes("quota")||e.message.includes("storage"),entryCount:this.state.entries.length}}))}pushUndo(e){const t=[...this.state.undoStack,e];t.length>tn&&t.shift(),this.setState({undoStack:t,redoStack:[]},!1)}addEntry(e){const t=[...this.state.entries,e];this.pushUndo({type:"ADD_ENTRY",data:e,timestamp:Date.now()}),this.setState({entries:t,lastRecordedEntry:e,isRecording:!1}),this.state.settings.sync&&this.state.raceId&&this.addToSyncQueue(e)}deleteEntry(e){const t=this.state.entries.find(s=>s.id===e);if(!t)return;this.pushUndo({type:"DELETE_ENTRY",data:t,timestamp:Date.now()});const i=this.state.entries.filter(s=>s.id!==e);this.setState({entries:i})}deleteMultiple(e){const t=this.state.entries.filter(s=>e.includes(s.id));if(t.length===0)return;this.pushUndo({type:"DELETE_MULTIPLE",data:t,timestamp:Date.now()});const i=this.state.entries.filter(s=>!e.includes(s.id));this.setState({entries:i,selectMode:!1,selectedEntries:new Set})}clearAll(){this.state.entries.length!==0&&(this.pushUndo({type:"CLEAR_ALL",data:[...this.state.entries],timestamp:Date.now()}),this.setState({entries:[],selectMode:!1,selectedEntries:new Set}))}updateEntry(e,t){const i=this.state.entries.findIndex(a=>a.id===e);if(i===-1)return!1;const s=this.state.entries[i],r={...s,...t};this.pushUndo({type:"UPDATE_ENTRY",data:s,timestamp:Date.now()});const o=[...this.state.entries];return o[i]=r,this.setState({entries:o}),!0}canUndo(){return this.state.undoStack.length>0}canRedo(){return this.state.redoStack.length>0}peekUndo(){return this.canUndo()?this.state.undoStack[this.state.undoStack.length-1]:null}undo(){if(!this.canUndo())return null;const e=[...this.state.undoStack],t=e.pop(),i=[...this.state.redoStack,t];let s=[...this.state.entries],r=null;switch(t.type){case"ADD_ENTRY":{const o=t.data;s=s.filter(a=>a.id!==o.id),r=o;break}case"DELETE_ENTRY":{const o=t.data;s.push(o),s.sort((a,l)=>new Date(a.timestamp).getTime()-new Date(l.timestamp).getTime()),r=o;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const o=t.data;s=[...s,...o],s.sort((a,l)=>new Date(a.timestamp).getTime()-new Date(l.timestamp).getTime()),r=o;break}case"UPDATE_ENTRY":{const o=t.data,a=s.findIndex(l=>l.id===o.id);a!==-1&&(s[a]=o),r=o;break}}return this.setState({entries:s,undoStack:e,redoStack:i}),r?{type:t.type,data:r}:null}redo(){if(!this.canRedo())return null;const e=[...this.state.redoStack],t=e.pop(),i=[...this.state.undoStack,t];let s=[...this.state.entries],r=null;switch(t.type){case"ADD_ENTRY":{const o=t.data;s.push(o),s.sort((a,l)=>new Date(a.timestamp).getTime()-new Date(l.timestamp).getTime()),r=o;break}case"DELETE_ENTRY":{const o=t.data;s=s.filter(a=>a.id!==o.id),r=o;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const o=t.data,a=new Set(o.map(l=>l.id));s=s.filter(l=>!a.has(l.id)),r=o;break}case"UPDATE_ENTRY":{const o=t.data,a=s.findIndex(l=>l.id===o.id);a!==-1&&(s[a]=o),r=o;break}}return this.setState({entries:s,undoStack:i,redoStack:e}),r}addToSyncQueue(e){const t={entry:e,retryCount:0,lastAttempt:0},i=[...this.state.syncQueue,t];this.setState({syncQueue:i})}removeFromSyncQueue(e){const t=this.state.syncQueue.filter(i=>i.entry.id!==e);this.setState({syncQueue:t})}updateSyncQueueItem(e,t){const i=this.state.syncQueue.map(s=>s.entry.id===e?{...s,...t}:s);this.setState({syncQueue:i})}clearSyncQueue(){this.setState({syncQueue:[]})}setView(e){this.setState({currentView:e},!1)}setLanguage(e){this.setState({currentLang:e})}setBibInput(e){const t=e.replace(/\D/g,"").slice(0,3);this.setState({bibInput:t},!1)}setSelectedPoint(e){this.setState({selectedPoint:e},!1)}setSelectedRun(e){this.setState({selectedRun:e},!1)}setSelectMode(e){this.setState({selectMode:e,selectedEntries:e?this.state.selectedEntries:new Set},!1)}toggleEntrySelection(e){const t=new Set(this.state.selectedEntries);t.has(e)?t.delete(e):t.add(e),this.setState({selectedEntries:t,selectMode:t.size>0},!1)}selectAllEntries(){const e=new Set(this.state.entries.map(t=>t.id));this.setState({selectedEntries:e,selectMode:!0},!1)}clearSelection(){this.setState({selectedEntries:new Set,selectMode:!1},!1)}setRecording(e){this.setState({isRecording:e},!1)}updateSettings(e){const t={...this.state.settings,...e};this.setState({settings:t})}toggleSetting(e){const t={...this.state.settings};t[e]=!t[e],this.setState({settings:t})}setSyncStatus(e){this.setState({syncStatus:e},!1)}setRaceId(e){e!==this.state.raceId?this.setState({raceId:e,undoStack:[],redoStack:[]}):this.setState({raceId:e})}setLastSyncedRaceId(e){this.setState({lastSyncedRaceId:e})}markCurrentRaceAsSynced(){this.setState({lastSyncedRaceId:this.state.raceId})}setDeviceName(e){this.setState({deviceName:e})}addConnectedDevice(e){const t=new Map(this.state.connectedDevices);t.set(e.id,e),this.setState({connectedDevices:t},!1)}removeConnectedDevice(e){const t=new Map(this.state.connectedDevices);t.delete(e),this.setState({connectedDevices:t},!1)}setCloudDeviceCount(e){this.setState({cloudDeviceCount:e},!1)}setCloudHighestBib(e){this.setState({cloudHighestBib:e},!1)}setRaceExistsInCloud(e){this.setState({raceExistsInCloud:e},!1)}setGpsStatus(e,t){this.setState({gpsStatus:e,gpsAccuracy:t??null},!1)}setCameraReady(e,t){this.setState({cameraReady:e,cameraError:t??null},!1)}mergeCloudEntries(e,t=[]){let i=0;const s=new Set(this.state.entries.map(a=>`${a.id}-${a.deviceId}`)),r=new Set(t),o=[];for(const a of e){if(!V(a)||a.deviceId===this.state.deviceId)continue;const l=`${a.id}:${a.deviceId}`;if(r.has(l)||r.has(a.id))continue;const g=`${a.id}-${a.deviceId}`;s.has(g)||(o.push({...a,run:a.run??1}),s.add(g),i++)}if(o.length>0){const a=[...this.state.entries,...o];a.sort((l,g)=>new Date(l.timestamp).getTime()-new Date(g.timestamp).getTime()),this.setState({entries:a})}return i}removeDeletedCloudEntries(e){const t=new Set(e);let i=0;const s=this.state.entries.filter(r=>{const o=`${r.id}:${r.deviceId}`;return t.has(o)||t.has(r.id)?(i++,!1):!0});return i>0&&this.setState({entries:s}),i}exportData(){return JSON.stringify({version:ge,entries:this.state.entries,settings:this.state.settings,deviceId:this.state.deviceId,deviceName:this.state.deviceName,raceId:this.state.raceId,exportedAt:new Date().toISOString()},null,2)}importData(e){try{const t=JSON.parse(e),i=en(t,this.state.deviceId),s=new Set(this.state.entries.map(o=>o.id)),r=i.entries.filter(o=>!s.has(o.id));if(r.length>0){const o=[...this.state.entries,...r];o.sort((a,l)=>new Date(a.timestamp).getTime()-new Date(l.timestamp).getTime()),this.setState({entries:o})}return{success:!0,entriesImported:r.length}}catch(t){return{success:!1,entriesImported:0,error:String(t)}}}}const c=new nn;function pt(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),i=String(n.getSeconds()).padStart(2,"0"),s=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${i}.${s}`}function sn(n,e="de"){const t={weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"};return n.toLocaleDateString(e==="de"?"de-DE":"en-US",t)}function rn(n,e=3){return String(n).padStart(e,"0")}function z(n){const e=document.createElement("div");return e.textContent=String(n),e.innerHTML}function on(n){return{S:"var(--success)",F:"var(--secondary)"}[n]||"var(--text-secondary)"}function Z(n,e="de"){return{en:{S:"Start",F:"Finish"},de:{S:"Start",F:"Ziel"}}[e][n]}function Fe(n,e="de"){return{en:{1:"R1",2:"R2"},de:{1:"L1",2:"L2"}}[e][n]}function me(n){return{1:"var(--primary)",2:"var(--warning)"}[n]||"var(--text-secondary)"}const Ke={en:{timer:"Timer",results:"Results",settings:"Settings",start:"Start",finish:"Finish",bib:"Bib",point:"Point",run:"Run",run1:"R1",run2:"R2",time:"Record time",lastRecorded:"Last recorded",status:"Status",noEntries:"No entries recorded",search:"Search by bib...",filter:"Filter",all:"All",total:"Total",racers:"Racers",finished:"Finished",fastest:"Fastest",average:"Average",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Delete Entry",confirmDeleteText:"Are you sure you want to delete this entry?",confirmClearAll:"Clear All Results",clearAllText:"This will delete all recorded entries. This action cannot be undone.",confirmUndoAdd:"Undo Recording",confirmUndoAddText:"This will delete the recorded entry. Continue?",delete:"Delete",cancel:"Cancel",close:"Close",save:"Save",edit:"Edit",undo:"Undo",export:"Export",clearAll:"Clear All",selectAll:"Select All",deleteSelected:"Delete Selected",connected:"Connected",connecting:"Connecting...",syncing:"Syncing...",offline:"Offline",syncError:"Sync error",syncReceived:"Synced from cloud",raceId:"Race ID",invalidRaceId:"Invalid Race ID. Use letters, numbers, hyphens, underscores only.",deviceName:"Time Keeper ID",cloudSync:"Cloud Sync",syncStatus:"Sync Status",pendingSync:"pending sync",saved:"Saved",deleted:"Deleted",cleared:"All entries cleared",undone:"Undone",copied:"Copied to clipboard",duplicateWarning:"Duplicate entry detected",zeroBibWarning:"Bib 000 - verify entry",exported:"Exported successfully",gps:"GPS",gpsActive:"GPS Active",gpsSearching:"Searching for GPS...",gpsInactive:"GPS Inactive",gpsAccuracy:"Accuracy",simpleMode:"Simple Mode",fullMode:"Full Mode",autoIncrement:"Auto-increment Bib",hapticFeedback:"Haptic Feedback",soundFeedback:"Sound Feedback",language:"Language",backup:"Backup",restore:"Restore",importData:"Import Data",exportData:"Export Data",simpleModeDesc:"Simplified interface for basic timing",cloudSyncDesc:"Sync with other devices",gpsDesc:"Use GPS for accurate timestamps",autoIncrementDesc:"Increase bib number after recording",photoCaptureDesc:"Capture photo on timestamp",hapticFeedbackDesc:"Vibration on actions",soundFeedbackDesc:"Audio confirmation",photoCapture:"Photo Capture",photoCaptured:"Photo captured",photoError:"Photo capture failed",viewPhoto:"View Photo",deletePhoto:"Delete Photo",photoFor:"Photo for Bib",noPhotoAvailable:"No photo available",photoDeleted:"Photo deleted",raceChangeTitle:"Change Race",raceChangeSyncedText:"You have results from another race. Export or delete them before switching?",raceChangeUnsyncedText:"You have existing results. Keep them or delete before switching?",keepResults:"Keep",version:"Version",devices:"Devices",entries:"entries",selected:"selected",raceFound:"Race found",raceNew:"New race",entriesInCloud:"entries in cloud",photoTooLarge:"Photo too large for sync",syncedEntriesFromCloud:"Synced {count} entries from cloud",crossDeviceDuplicate:"Duplicate: Bib {bib} {point} already recorded by {device}",syncPhotos:"Sync Photos",syncPhotosDesc:"Share photos across devices via cloud",syncPhotosWarning:"Enable Photo Sync",syncPhotosWarningText:"Enabling photo sync will transfer the following data:",photosToUpload:"Photos to upload",photosToDownload:"Photos to download",totalDataVolume:"Total data volume",enableSync:"Enable Sync",noPhotosToSync:"No photos to sync",admin:"Admin",adminPin:"Race Management PIN",adminPinDesc:"Required to manage and sync races",manageRaces:"Manage Races",manageRacesDesc:"View and delete synced races",manage:"Manage",enterAdminPin:"Enter Race Management PIN",enterPinText:"Enter your PIN to access race management.",enterPinToJoinRace:"Enter your PIN to join this race.",syncRequiresPin:"Sync disabled. Enable sync and enter PIN to reconnect.",incorrectPin:"Incorrect PIN",verify:"Verify",setPinFirst:"Please set a Race Management PIN first",pinSaved:"PIN saved",pinCleared:"PIN cleared",pinNotSet:"Not set",pinSet:"PIN set",setPin:"Set PIN",changePin:"Change PIN",currentPin:"Current PIN",newPin:"New PIN (4 digits)",confirmPin:"Confirm PIN",pinMismatch:"PINs do not match",pinFormatError:"PIN must be exactly 4 digits",loading:"Loading...",noRaces:"No active races",refresh:"Refresh",raceDeleted:"Race Deleted",raceDeletedText:"This race has been deleted by an administrator.",raceDeletedFor:"Race deleted:",raceDeletedSuccess:"Race deleted:",confirmDeleteRace:"Delete Race",confirmDeleteRaceText:"Are you sure you want to delete race",loadError:"Failed to load races",deleteError:"Failed to delete race",entry:"entry",device:"device",storageError:"Failed to save data - check storage",storageQuotaError:"Storage full! Export data immediately",storageWarning:"Storage almost full",networkError:"Network error - check connection",connectionFailed:"Connection failed",serverUnavailable:"Server unavailable",rateLimitError:"Too many requests - please wait",authError:"Authentication failed",syncFailed:"Sync failed",pinSyncFailed:"PIN not synced to cloud",cameraError:"Camera error",cameraPermissionDenied:"Camera access denied",gpsError:"GPS error",gpsPermissionDenied:"GPS access denied",gpsUnavailable:"GPS unavailable",unknownError:"Unknown error",onboardingWelcome:"Welcome to Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronized timing for ski races",getStarted:"Get Started",onboardingDeviceName:"Name Your Timer",onboardingDeviceNameDesc:"This identifies your device when syncing",onboardingPhoto:"Photo Documentation",onboardingPhotoDesc:"Automatically capture a photo when recording each timestamp. Useful for verifying bib numbers and resolving disputes.",enablePhotoCapture:"Enable Photo Capture",photoCaptureLabel:"Photo Capture",onboardingRaceSetup:"Join a Race",onboardingRaceSetupDesc:"Enter a race ID to sync with other timers",skipForNow:"Skip for now",onboardingReady:"Ready to Time!",onboardingTip:"Tap the big blue button to record timestamps",startTiming:"Start Timing",continue:"Continue",deviceNameLabel:"Device Name",raceIdLabel:"Race ID",syncStatusLabel:"Cloud Sync",enabled:"Enabled",disabled:"Disabled",showTutorial:"Show Tutorial",showTutorialDesc:"Run the setup wizard again",show:"Show",onboardingComplete:"Setup complete!",invalidPin:"Invalid PIN format",recentRaces:"Recent Races",noRecentRaces:"No races from today",errorOccurred:"Something went wrong",errorRecoveryMessage:"The app encountered an error. You can dismiss this and continue, or reload the app.",dismiss:"Dismiss",reload:"Reload",operationFailed:"Operation failed"},de:{timer:"Timer",results:"Ergebnisse",settings:"Einstellungen",start:"Start",finish:"Ziel",bib:"Startnr.",point:"Punkt",run:"Lauf",run1:"L1",run2:"L2",time:"Zeit erfassen",lastRecorded:"Zuletzt erfasst",status:"Status",noEntries:"Keine Einträge vorhanden",search:"Startnr. suchen...",filter:"Filter",all:"Alle",total:"Gesamt",racers:"Fahrer",finished:"Im Ziel",fastest:"Schnellste",average:"Durchschnitt",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Eintrag löschen",confirmDeleteText:"Möchten Sie diesen Eintrag wirklich löschen?",confirmClearAll:"Alle löschen",clearAllText:"Alle Einträge werden gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.",confirmUndoAdd:"Erfassung rückgängig",confirmUndoAddText:"Der erfasste Eintrag wird gelöscht. Fortfahren?",delete:"Löschen",cancel:"Abbrechen",close:"Schließen",save:"Speichern",edit:"Bearbeiten",undo:"Rückgängig",export:"Exportieren",clearAll:"Alle löschen",selectAll:"Alle auswählen",deleteSelected:"Ausgewählte löschen",connected:"Verbunden",connecting:"Verbinde...",syncing:"Synchronisiere...",offline:"Offline",syncError:"Sync-Fehler",syncReceived:"Von Cloud synchronisiert",raceId:"Rennen-ID",invalidRaceId:"Ungültige Rennen-ID. Nur Buchstaben, Zahlen, Bindestriche, Unterstriche.",deviceName:"Zeitnehmer-ID",cloudSync:"Cloud-Sync",syncStatus:"Sync-Status",pendingSync:"ausstehend",saved:"Gespeichert",deleted:"Gelöscht",cleared:"Alle Einträge gelöscht",undone:"Rückgängig gemacht",copied:"In Zwischenablage kopiert",duplicateWarning:"Doppelter Eintrag erkannt",zeroBibWarning:"Startnr. 000 - Eintrag prüfen",exported:"Erfolgreich exportiert",gps:"GPS",gpsActive:"GPS Aktiv",gpsSearching:"GPS wird gesucht...",gpsInactive:"GPS Inaktiv",gpsAccuracy:"Genauigkeit",simpleMode:"Einfacher Modus",fullMode:"Erweiterter Modus",autoIncrement:"Auto-Inkrement",hapticFeedback:"Haptisches Feedback",soundFeedback:"Ton-Feedback",language:"Sprache",backup:"Sichern",restore:"Wiederherstellen",importData:"Daten importieren",exportData:"Daten exportieren",simpleModeDesc:"Vereinfachte Oberfläche für einfache Zeitmessung",cloudSyncDesc:"Mit anderen Geräten synchronisieren",gpsDesc:"GPS für genaue Zeitstempel verwenden",autoIncrementDesc:"Startnummer nach Erfassung erhöhen",photoCaptureDesc:"Foto bei Zeiterfassung aufnehmen",hapticFeedbackDesc:"Vibration bei Aktionen",soundFeedbackDesc:"Akustische Bestätigung",photoCapture:"Foto aufnehmen",photoCaptured:"Foto aufgenommen",photoError:"Foto-Aufnahme fehlgeschlagen",viewPhoto:"Foto anzeigen",deletePhoto:"Foto löschen",photoFor:"Foto für Startnr.",noPhotoAvailable:"Kein Foto verfügbar",photoDeleted:"Foto gelöscht",raceChangeTitle:"Rennen wechseln",raceChangeSyncedText:"Es gibt Ergebnisse von einem anderen Rennen. Exportieren oder löschen?",raceChangeUnsyncedText:"Es gibt bestehende Ergebnisse. Behalten oder löschen?",keepResults:"Behalten",version:"Version",devices:"Geräte",entries:"Einträge",selected:"ausgewählt",raceFound:"Rennen gefunden",raceNew:"Neues Rennen",entriesInCloud:"Einträge in der Cloud",photoTooLarge:"Foto zu groß für Sync",syncedEntriesFromCloud:"{count} Einträge aus Cloud synchronisiert",crossDeviceDuplicate:"Duplikat: Startnr. {bib} {point} bereits von {device} erfasst",syncPhotos:"Fotos synchronisieren",syncPhotosDesc:"Fotos über Cloud mit anderen Geräten teilen",syncPhotosWarning:"Foto-Sync aktivieren",syncPhotosWarningText:"Aktivierung der Foto-Synchronisierung überträgt folgende Daten:",photosToUpload:"Fotos hochzuladen",photosToDownload:"Fotos herunterzuladen",totalDataVolume:"Gesamtes Datenvolumen",enableSync:"Sync aktivieren",noPhotosToSync:"Keine Fotos zu synchronisieren",admin:"Admin",adminPin:"Rennverwaltungs-PIN",adminPinDesc:"Erforderlich für Verwaltung und Sync",manageRaces:"Rennen verwalten",manageRacesDesc:"Synchronisierte Rennen anzeigen und löschen",manage:"Verwalten",enterAdminPin:"Rennverwaltungs-PIN eingeben",enterPinText:"Geben Sie Ihre PIN ein, um die Rennverwaltung zu öffnen.",enterPinToJoinRace:"Geben Sie Ihre PIN ein, um diesem Rennen beizutreten.",syncRequiresPin:"Sync deaktiviert. Aktivieren Sie Sync und geben Sie die PIN ein.",incorrectPin:"Falsche PIN",verify:"Bestätigen",setPinFirst:"Bitte zuerst Rennverwaltungs-PIN festlegen",pinSaved:"PIN gespeichert",pinCleared:"PIN gelöscht",pinNotSet:"Nicht gesetzt",pinSet:"PIN gesetzt",setPin:"PIN setzen",changePin:"PIN ändern",currentPin:"Aktuelle PIN",newPin:"Neue PIN (4 Ziffern)",confirmPin:"PIN bestätigen",pinMismatch:"PINs stimmen nicht überein",pinFormatError:"PIN muss genau 4 Ziffern haben",loading:"Laden...",noRaces:"Keine aktiven Rennen",refresh:"Aktualisieren",raceDeleted:"Rennen gelöscht",raceDeletedText:"Dieses Rennen wurde von einem Administrator gelöscht.",raceDeletedFor:"Rennen gelöscht:",raceDeletedSuccess:"Rennen gelöscht:",confirmDeleteRace:"Rennen löschen",confirmDeleteRaceText:"Möchten Sie das Rennen wirklich löschen",loadError:"Fehler beim Laden der Rennen",deleteError:"Fehler beim Löschen des Rennens",entry:"Eintrag",device:"Gerät",storageError:"Speichern fehlgeschlagen - Speicher prüfen",storageQuotaError:"Speicher voll! Daten sofort exportieren",storageWarning:"Speicher fast voll",networkError:"Netzwerkfehler - Verbindung prüfen",connectionFailed:"Verbindung fehlgeschlagen",serverUnavailable:"Server nicht erreichbar",rateLimitError:"Zu viele Anfragen - bitte warten",authError:"Authentifizierung fehlgeschlagen",syncFailed:"Synchronisierung fehlgeschlagen",pinSyncFailed:"PIN nicht in Cloud gespeichert",cameraError:"Kamerafehler",cameraPermissionDenied:"Kamerazugriff verweigert",gpsError:"GPS-Fehler",gpsPermissionDenied:"GPS-Zugriff verweigert",gpsUnavailable:"GPS nicht verfügbar",unknownError:"Unbekannter Fehler",onboardingWelcome:"Willkommen bei Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronisierte Zeitmessung für Skirennen",getStarted:"Los geht's",onboardingDeviceName:"Timer benennen",onboardingDeviceNameDesc:"Dieser Name identifiziert dein Gerät beim Synchronisieren",onboardingPhoto:"Foto-Dokumentation",onboardingPhotoDesc:"Automatisch ein Foto bei jeder Zeiterfassung aufnehmen. Nützlich zur Überprüfung von Startnummern und bei Unstimmigkeiten.",enablePhotoCapture:"Foto-Aufnahme aktivieren",photoCaptureLabel:"Foto-Aufnahme",onboardingRaceSetup:"Rennen beitreten",onboardingRaceSetupDesc:"Gib eine Rennen-ID ein um mit anderen Timern zu synchronisieren",skipForNow:"Vorerst überspringen",onboardingReady:"Bereit zur Zeitmessung!",onboardingTip:"Tippe auf den großen blauen Button um Zeiten zu erfassen",startTiming:"Zeitmessung starten",continue:"Weiter",deviceNameLabel:"Gerätename",raceIdLabel:"Rennen-ID",syncStatusLabel:"Cloud-Sync",enabled:"Aktiviert",disabled:"Deaktiviert",showTutorial:"Tutorial anzeigen",showTutorialDesc:"Setup-Assistenten erneut starten",show:"Anzeigen",onboardingComplete:"Einrichtung abgeschlossen!",invalidPin:"Ungültiges PIN-Format",recentRaces:"Letzte Rennen",noRecentRaces:"Keine Rennen von heute",errorOccurred:"Ein Fehler ist aufgetreten",errorRecoveryMessage:"Die App hat einen Fehler festgestellt. Sie können diesen Hinweis schließen und fortfahren, oder die App neu laden.",dismiss:"Schließen",reload:"Neu laden",operationFailed:"Vorgang fehlgeschlagen"}};function u(n,e="de"){return Ke[e][n]||Ke.en[n]||n}const P={CRITICAL:"critical",ERROR:"error",WARNING:"warning",INFO:"info"},Y={CRITICAL:8e3,ERROR:5e3,WARNING:4e3,INFO:3e3};function an(n){return`[${n.component}] ${n.operation}`}function cn(n){return n instanceof Error?n.message:typeof n=="string"?n:"Unknown error"}function He(n){const e=an(n),t=n.error?cn(n.error):"No error details",i={code:n.code,message:t,timestamp:new Date().toISOString(),...n.metadata};switch(n.severity){case P.CRITICAL:case P.ERROR:console.error(`${e}:`,t,i);break;case P.WARNING:console.warn(`${e}:`,t,i);break;case P.INFO:console.log(`${e}:`,t,i);break}if(n.userMessageKey){const s=c.getState().currentLang,r=u(n.userMessageKey,s),o=ln(n.severity),a=Y[n.severity.toUpperCase()]||Y.ERROR;v(r,o,a)}n.severity===P.CRITICAL&&window.dispatchEvent(new CustomEvent("critical-error",{detail:n}))}function ln(n){switch(n){case P.CRITICAL:case P.ERROR:return"error";case P.WARNING:return"warning";case P.INFO:return"info";default:return"error"}}function Ie(n,e,t,i){He({component:n,operation:e,severity:P.ERROR,error:t,userMessageKey:i})}function Be(n,e,t,i){He({component:n,operation:e,severity:P.WARNING,error:t,userMessageKey:i})}function dn(n,e,t,i){He({component:n,operation:e,severity:P.CRITICAL,error:t,userMessageKey:i})}const un=1e4;class hn extends Error{constructor(e,t){super(`Request to ${e} timed out after ${t}ms`),this.name="FetchTimeoutError"}}async function N(n,e={},t=un){const i=new AbortController,s=setTimeout(()=>i.abort(),t);try{return await fetch(n,{...e,signal:i.signal})}catch(r){throw r instanceof Error&&r.name==="AbortError"?new hn(n,t):r}finally{clearTimeout(s)}}const Xe={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},gn=.8,ne=1280,ie=720,et=200;class mn{constructor(){d(this,"stream",null);d(this,"videoElement",null);d(this,"canvasElement",null);d(this,"cameraState","stopped");d(this,"visibilityHandler",null);d(this,"pendingVisibilityChange",null)}async initialize(){if(this.cameraState==="ready")return!0;if(this.cameraState==="initializing")return!1;this.cameraState="initializing";try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not available");return this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.canvasElement=document.createElement("canvas"),this.canvasElement.width=ne,this.canvasElement.height=ie,this.stream=await navigator.mediaDevices.getUserMedia(Xe),this.videoElement.srcObject=this.stream,await new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))}),this.pendingVisibilityChange==="hidden"?(this.pendingVisibilityChange=null,this.pauseCamera(),!1):(this.cameraState="ready",c.setCameraReady(!0),this.visibilityHandler||(this.visibilityHandler=()=>this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.visibilityHandler)),console.log("Camera initialized successfully"),!0)}catch(e){const t=e instanceof Error?e.message:"Camera initialization failed";return console.error("Camera initialization error:",t),this.cameraState="stopped",c.setCameraReady(!1,t),!1}}handleVisibilityChange(){document.hidden?this.cameraState==="initializing"||this.cameraState==="resuming"?(this.pendingVisibilityChange="hidden",console.log("Camera: visibility changed to hidden during init/resume, will pause after")):this.cameraState==="ready"&&this.pauseCamera():this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange=null:this.cameraState==="paused"&&this.reinitializeCamera()}pauseCamera(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.videoElement&&(this.videoElement.srcObject=null)),this.cameraState="paused",c.setCameraReady(!1),console.log("Camera paused (page hidden)")}async reinitializeCamera(){if(this.cameraState==="resuming"){console.log("Camera reinitialization already in progress, skipping");return}this.cameraState="resuming";try{if(this.videoElement||(this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement)),this.stream=await navigator.mediaDevices.getUserMedia(Xe),this.videoElement.srcObject=this.stream,await new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))}),this.pendingVisibilityChange==="hidden"){this.pendingVisibilityChange=null,this.pauseCamera(),console.log("Camera paused immediately after reinit (page hidden during reinit)");return}this.cameraState="ready",c.setCameraReady(!0),console.log("Camera reinitialized (page visible)")}catch(e){console.error("Failed to reinitialize camera:",e),this.cameraState="stopped"}}async capturePhoto(){if(this.cameraState!=="ready"||!this.videoElement||!this.canvasElement)return console.warn("Camera not ready for capture"),null;try{const e=this.canvasElement.getContext("2d");if(!e)throw new Error("Could not get canvas context");const t=this.videoElement.videoWidth,i=this.videoElement.videoHeight;let s=t,r=i;if(s>ne){const h=ne/s;s=ne,r=Math.round(r*h)}if(r>ie){const h=ie/r;r=ie,s=Math.round(s*h)}this.canvasElement.width=s,this.canvasElement.height=r,e.drawImage(this.videoElement,0,0,s,r);const o=new Date().toISOString();e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,r-30,s,30),e.fillStyle="#ffffff",e.font="14px monospace",e.fillText(o,10,r-10);const l=this.canvasElement.toDataURL("image/jpeg",gn).split(",")[1],g=Math.round(l.length/1024);return console.log(`Photo captured: ${g}KB`),g>et?(console.warn(`Photo too large (${g}KB > ${et}KB limit), discarding`),null):l}catch(e){return console.error("Photo capture error:",e),null}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null,this.videoElement.remove(),this.videoElement=null),this.canvasElement&&(this.canvasElement=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.pendingVisibilityChange=null,this.cameraState="stopped",c.setCameraReady(!1),console.log("Camera stopped")}isReady(){return this.cameraState==="ready"}getError(){return c.getState().cameraError}async toggle(e){return e?this.initialize():(this.stop(),!0)}}const O=new mn;async function fn(){return!c.getState().settings.photoCapture||!O.isReady()&&!await O.initialize()?null:O.capturePhoto()}const pn="ski-timer-photos",yn=1,k="photos";class vn{constructor(){d(this,"db",null);d(this,"initPromise",null);d(this,"saveQueue",[]);d(this,"isProcessingQueue",!1)}async initialize(){return this.initPromise?this.initPromise:(this.initPromise=new Promise(e=>{if(!window.indexedDB){console.warn("IndexedDB not supported - photo storage disabled"),e(!1);return}const t=indexedDB.open(pn,yn);t.onerror=()=>{console.error("IndexedDB open error:",t.error),e(!1)},t.onsuccess=()=>{this.db=t.result,console.log("Photo storage initialized"),e(!0)},t.onupgradeneeded=i=>{const s=i.target.result;s.objectStoreNames.contains(k)||(s.createObjectStore(k,{keyPath:"entryId"}).createIndex("timestamp","timestamp",{unique:!1}),console.log("Photo store created"))}}),this.initPromise)}async savePhoto(e,t){return new Promise(i=>{this.saveQueue.push({entryId:e,photoBase64:t,resolve:i}),this.processQueue()})}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{for(;this.saveQueue.length>0;){const e=this.saveQueue.shift(),t=await this.doSavePhoto(e.entryId,e.photoBase64);e.resolve(t)}}finally{this.isProcessingQueue=!1}}}async doSavePhoto(e,t){return!this.db&&!await this.initialize()?!1:new Promise(i=>{if(!this.db){i(!1);return}try{const r=this.db.transaction([k],"readwrite").objectStore(k),o={entryId:e,photo:t,timestamp:Date.now()},a=r.put(o);a.onsuccess=()=>{console.log(`Photo saved for entry ${e}`),i(!0)},a.onerror=()=>{console.error("Photo save error:",a.error),i(!1)}}catch(s){console.error("Photo save transaction error:",s),i(!1)}})}async getPhoto(e){return!this.db&&!await this.initialize()?null:new Promise(t=>{if(!this.db){t(null);return}try{const r=this.db.transaction([k],"readonly").objectStore(k).get(e);r.onsuccess=()=>{const o=r.result;t((o==null?void 0:o.photo)||null)},r.onerror=()=>{console.error("Photo get error:",r.error),t(null)}}catch(i){console.error("Photo get transaction error:",i),t(null)}})}async deletePhoto(e){return!this.db&&!await this.initialize()?!1:new Promise(t=>{if(!this.db){t(!1);return}try{const r=this.db.transaction([k],"readwrite").objectStore(k).delete(e);r.onsuccess=()=>{console.log(`Photo deleted for entry ${e}`),t(!0)},r.onerror=()=>{console.error("Photo delete error:",r.error),t(!1)}}catch(i){console.error("Photo delete transaction error:",i),t(!1)}})}async hasPhoto(e){return await this.getPhoto(e)!==null}async clearAll(){return!this.db&&!await this.initialize()?!1:new Promise(e=>{if(!this.db){e(!1);return}try{const s=this.db.transaction([k],"readwrite").objectStore(k).clear();s.onsuccess=()=>{console.log("All photos cleared"),e(!0)},s.onerror=()=>{console.error("Photo clear error:",s.error),e(!1)}}catch(t){console.error("Photo clear transaction error:",t),e(!1)}})}async deletePhotos(e){for(const t of e)await this.deletePhoto(t)}async getStorageUsage(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{used:e.usage||0,quota:e.quota||0}}catch{return null}return null}async getPhotoCount(){return!this.db&&!await this.initialize()?0:new Promise(e=>{if(!this.db){e(0);return}try{const s=this.db.transaction([k],"readonly").objectStore(k).count();s.onsuccess=()=>{e(s.result)},s.onerror=()=>{e(0)}}catch{e(0)}})}close(){this.db&&(this.db.close(),this.db=null,this.initPromise=null,console.log("Photo storage connection closed"))}}const D=new vn,En=.2,bn=.1;class Sn{constructor(){d(this,"battery",null);d(this,"isInitialized",!1);d(this,"callbacks",new Set);d(this,"currentStatus",{level:1,charging:!0,batteryLevel:"normal"});d(this,"levelChangeHandler",null);d(this,"chargingChangeHandler",null)}isSupported(){return"getBattery"in navigator}async initialize(){if(this.isInitialized)return!0;if(!this.isSupported())return console.log("Battery Status API not supported"),!1;try{return this.battery=await navigator.getBattery(),this.isInitialized=!0,this.updateStatus(),this.levelChangeHandler=()=>this.updateStatus(),this.chargingChangeHandler=()=>this.updateStatus(),this.battery.addEventListener("levelchange",this.levelChangeHandler),this.battery.addEventListener("chargingchange",this.chargingChangeHandler),console.log("Battery service initialized:",this.currentStatus),!0}catch(e){return console.warn("Failed to initialize battery service:",e),!1}}updateStatus(){if(!this.battery)return;const e=this.battery.level,t=this.battery.charging;let i="normal";t||(e<=bn?i="critical":e<=En&&(i="low"));const s={level:e,charging:t,batteryLevel:i},r=this.currentStatus.level!==s.level||this.currentStatus.charging!==s.charging||this.currentStatus.batteryLevel!==s.batteryLevel;this.currentStatus=s,r&&(console.log("Battery status changed:",s),this.notifySubscribers())}notifySubscribers(){for(const e of this.callbacks)try{e(this.currentStatus)}catch(t){console.error("Battery callback error:",t)}}subscribe(e){return this.callbacks.add(e),e(this.currentStatus),()=>{this.callbacks.delete(e)}}getStatus(){return{...this.currentStatus}}isLowBattery(){return this.currentStatus.batteryLevel==="low"||this.currentStatus.batteryLevel==="critical"}isCriticalBattery(){return this.currentStatus.batteryLevel==="critical"}isCharging(){return this.currentStatus.charging}getLevelPercent(){return Math.round(this.currentStatus.level*100)}cleanup(){this.battery&&(this.levelChangeHandler&&(this.battery.removeEventListener("levelchange",this.levelChangeHandler),this.levelChangeHandler=null),this.chargingChangeHandler&&(this.battery.removeEventListener("chargingchange",this.chargingChangeHandler),this.chargingChangeHandler=null),this.battery=null),this.callbacks.clear(),this.isInitialized=!1}}const fe=new Sn,yt="skiTimerRecentRaces",In=10;function vt(){try{const n=localStorage.getItem(yt);return n?JSON.parse(n):[]}catch{return[]}}function ze(n,e,t){try{const i=vt(),s=n.toLowerCase(),r=i.findIndex(a=>a.raceId.toLowerCase()===s);r>=0?(i[r].lastUpdated=e,t!==void 0&&(i[r].entryCount=t)):i.unshift({raceId:n,createdAt:Date.now(),lastUpdated:e,entryCount:t}),i.sort((a,l)=>l.lastUpdated-a.lastUpdated);const o=i.slice(0,In);localStorage.setItem(yt,JSON.stringify(o))}catch(i){console.error("Failed to save recent race:",i)}}function pe(n=5){const e=vt(),t=new Date;t.setHours(0,0,0,0);const i=t.getTime();return e.filter(s=>s.createdAt>=i||s.lastUpdated>=i).slice(0,n)}const G="/api/sync",we="skiTimerAuthToken";function j(){const n=localStorage.getItem(we);return n?{Authorization:`Bearer ${n}`}:{}}function $(){return!!localStorage.getItem(we)}function wn(n){localStorage.setItem(we,n)}function Et(){localStorage.removeItem(we)}async function Ue(n){try{const e=await fetch("/api/auth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:n})}),t=await e.json();return e.ok?t.token?(wn(t.token),{success:!0,token:t.token,isNewPin:t.isNewPin}):{success:!1,error:"No token received"}:{success:!1,error:t.error||"Authentication failed"}}catch(e){return console.error("Token exchange error:",e),{success:!1,error:"Network error"}}}const tt=5e3,nt=3e4,Cn=5,Ln=2e3,kn=1e4,se=8e3,Tn=[5e3,1e4,15e3,2e4,3e4],Pn=6,it=[1e4,2e4,3e4,45e3,6e4],st=[3e4,45e3,6e4],Rn=3,An=[1e4,15e3,2e4,3e4],Dn=1e4;class xn{constructor(){d(this,"pollInterval",null);d(this,"queueInterval",null);d(this,"broadcastChannel",null);d(this,"consecutiveErrors",0);d(this,"lastSyncTimestamp",0);d(this,"isProcessingQueue",!1);d(this,"visibilityHandler",null);d(this,"wasPollingBeforeHidden",!1);d(this,"consecutiveNoChanges",0);d(this,"currentIdleLevel",0);d(this,"currentBatteryLevel","normal");d(this,"batteryUnsubscribe",null);d(this,"isAdjustingInterval",!1);d(this,"isMeteredConnection",!1);d(this,"networkChangeHandler",null)}initialize(){const e=c.getState();if(!e.settings.sync||!e.raceId){this.cleanup();return}this.initBroadcastChannel(e.raceId),this.startPolling(),this.startQueueProcessor(),this.pushLocalEntries(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(this.wasPollingBeforeHidden=this.pollInterval!==null,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null)):this.wasPollingBeforeHidden&&this.startPolling()},document.addEventListener("visibilitychange",this.visibilityHandler)),this.batteryUnsubscribe||fe.initialize().then(()=>{this.batteryUnsubscribe=fe.subscribe(t=>{const i=this.currentBatteryLevel;this.currentBatteryLevel=t.batteryLevel,i!==t.batteryLevel&&this.pollInterval&&(console.log(`Battery level changed: ${i} -> ${t.batteryLevel}`),this.applyBatteryAwarePolling())})}),this.initNetworkMonitoring(),c.setSyncStatus("connecting"),console.log("Sync service initialized for race:",e.raceId)}initBroadcastChannel(e){try{this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(`ski-timer-${e}`),this.broadcastChannel.onmessage=t=>{const{type:i,data:s}=t.data;if(i==="entry"&&V(s))c.mergeCloudEntries([s]);else if(i==="presence"){const r=s;c.addConnectedDevice(r)}}}catch(t){console.warn("BroadcastChannel not supported:",t)}}broadcastEntry(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"entry",data:e})}catch(t){console.error("Broadcast error:",t)}}broadcastPresence(){const e=c.getState();if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"presence",data:{id:e.deviceId,name:e.deviceName,lastSeen:Date.now()}})}catch(t){console.error("Presence broadcast error:",t)}}initNetworkMonitoring(){const e=navigator.connection;if(!e){console.log("Network Information API not available");return}this.updateNetworkState(e),this.networkChangeHandler||(this.networkChangeHandler=()=>{const t=this.isMeteredConnection;this.updateNetworkState(e),t!==this.isMeteredConnection&&this.pollInterval&&(console.log(`Network metered state changed: ${t} -> ${this.isMeteredConnection}`),this.applyBatteryAwarePolling())},e.addEventListener("change",this.networkChangeHandler))}updateNetworkState(e){this.isMeteredConnection=e.saveData===!0||e.type==="cellular"||e.effectiveType==="slow-2g"||e.effectiveType==="2g",console.log(`Network state: metered=${this.isMeteredConnection}, type=${e.type}, effective=${e.effectiveType}`)}startPolling(){this.pollInterval&&clearInterval(this.pollInterval),this.fetchCloudEntries();const e=this.consecutiveErrors>2?nt:tt;this.pollInterval=setInterval(()=>this.fetchCloudEntries(),e)}getPollingIntervals(){return this.currentBatteryLevel==="critical"?st:this.isMeteredConnection?An:this.currentBatteryLevel==="low"?it:Tn}getIdleThreshold(){return this.currentBatteryLevel==="normal"?Pn:Rn}getBasePollingInterval(){return this.currentBatteryLevel==="critical"?st[0]:this.isMeteredConnection?Dn:this.currentBatteryLevel==="low"?it[0]:tt}applyBatteryAwarePolling(){if(this.isAdjustingInterval){console.log("Skipping battery polling adjustment - another adjustment in progress");return}this.isAdjustingInterval=!0;try{const e=this.getPollingIntervals();this.currentIdleLevel=Math.min(this.currentIdleLevel,e.length-1);let t;this.consecutiveNoChanges<this.getIdleThreshold()?t=this.getBasePollingInterval():t=e[this.currentIdleLevel],this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),t),console.log(`Sync polling: battery-adjusted (${t/1e3}s, battery: ${this.currentBatteryLevel})`))}finally{this.isAdjustingInterval=!1}}adjustPollingInterval(e,t=!1){if(this.isAdjustingInterval){console.log("Skipping adaptive polling adjustment - another adjustment in progress");return}this.isAdjustingInterval=!0;try{if(!e){this.consecutiveErrors++,this.consecutiveErrors>2&&this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),nt),console.log("Sync polling: error mode (30s)"));return}this.consecutiveErrors=0;const i=this.getPollingIntervals(),s=this.getIdleThreshold(),r=this.getBasePollingInterval();if(t)this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),r)),console.log(`Sync polling: active mode (${r/1e3}s, battery: ${this.currentBatteryLevel})`);else if(this.consecutiveNoChanges++,this.consecutiveNoChanges>=s){const o=Math.min(this.currentIdleLevel+1,i.length-1);if(o!==this.currentIdleLevel){this.currentIdleLevel=o;const a=i[this.currentIdleLevel];this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),a)),console.log(`Sync polling: idle mode (${a/1e3}s, battery: ${this.currentBatteryLevel})`)}}}finally{this.isAdjustingInterval=!1}}resetToFastPolling(){this.consecutiveNoChanges=0,this.currentIdleLevel=0;const e=this.getBasePollingInterval();this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),e))}async processCloudPhotos(e){const t=c.getState(),i=[];for(const s of e)s.photo&&s.photo!=="indexeddb"&&s.photo.length>20?t.settings.syncPhotos?await D.savePhoto(s.id,s.photo)?i.push({...s,photo:"indexeddb"}):i.push({...s,photo:void 0}):i.push({...s,photo:void 0}):i.push(s);return i}async fetchCloudEntries(){const e=c.getState();if(!e.settings.sync||!e.raceId)return;const t=e.syncStatus;(t==="connected"||t==="connecting")&&c.setSyncStatus("syncing");try{const i=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),s=await N(`${G}?${i}`,{headers:j()},se);if(s.status===401){let h;try{h=await s.json()}catch{h={}}if(h.expired){Et(),c.setSyncStatus("disconnected"),window.dispatchEvent(new CustomEvent("auth-expired",{detail:{message:"Session expired. Please re-enter your PIN."}})),this.cleanup();return}throw new Error(`HTTP ${s.status}: ${h.error||"Unauthorized"}`)}if(!s.ok)throw new Error(`HTTP ${s.status}`);let r;try{r=await s.json()}catch{throw new Error("Invalid response format")}if(!r||typeof r!="object")throw new Error("Invalid data structure");if(r.deleted){console.log("Race was deleted by admin, dispatching race-deleted event"),window.dispatchEvent(new CustomEvent("race-deleted",{detail:{raceId:e.raceId,deletedAt:r.deletedAt,message:r.message}})),this.cleanup();return}const a=(Array.isArray(r.entries)?r.entries:[]).filter(h=>V(h)?!0:(console.warn("Skipping invalid entry from cloud:",h),!1)),l=Array.isArray(r.deletedIds)?r.deletedIds.filter(h=>typeof h=="string"&&h.length>0):[];c.setSyncStatus("connected"),typeof r.deviceCount=="number"&&c.setCloudDeviceCount(r.deviceCount),typeof r.highestBib=="number"&&c.setCloudHighestBib(r.highestBib);let g=!1;if(l.length>0&&(c.removeDeletedCloudEntries(l),g=!0),a.length>0){const h=await this.processCloudPhotos(a),p=c.mergeCloudEntries(h,l);if(p>0){g=!0;const m=c.getState().currentLang;this.showSyncToast(u("syncedEntriesFromCloud",m).replace("{count}",String(p)))}}this.lastSyncTimestamp=r.lastUpdated||Date.now(),e.raceId&&ze(e.raceId,this.lastSyncTimestamp,a.length),this.adjustPollingInterval(!0,g)}catch(i){console.error("Cloud sync fetch error:",i);const s=i instanceof Error?i.message:"Unknown error";(i instanceof Error?i.name:"")==="FetchTimeoutError"||s.includes("timed out")||s.includes("500")||s.includes("503")?c.setSyncStatus("error"):s.includes("Failed to fetch")||s.includes("NetworkError")?c.setSyncStatus("offline"):c.setSyncStatus("error"),this.adjustPollingInterval(!1)}}async deleteEntryFromCloud(e,t){const i=c.getState();if(!i.settings.sync||!i.raceId)return!1;try{const s=await N(`${G}?raceId=${encodeURIComponent(i.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json",...j()},body:JSON.stringify({entryId:e,deviceId:t||i.deviceId,deviceName:i.deviceName})},se);if(!s.ok)throw new Error(`HTTP ${s.status}`);return!0}catch(s){return console.error("Cloud sync delete error:",s),!1}}async sendEntryToCloud(e){const t=c.getState();if(!t.settings.sync||!t.raceId)return!1;try{let i={...e};if(t.settings.syncPhotos&&e.photo==="indexeddb"){const r=await D.getPhoto(e.id);r?i={...e,photo:r}:i={...e,photo:void 0}}else e.photo&&(i={...e,photo:void 0});const s=await N(`${G}?raceId=${encodeURIComponent(t.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json",...j()},body:JSON.stringify({entry:i,deviceId:t.deviceId,deviceName:t.deviceName})},se);if(!s.ok)throw new Error(`HTTP ${s.status}`);try{const r=await s.json(),o=c.getState().currentLang;if(r.photoSkipped&&this.showSyncToast(u("photoTooLarge",o),"warning"),r.crossDeviceDuplicate){const a=r.crossDeviceDuplicate,l=Z(a.point,o);this.showSyncToast(u("crossDeviceDuplicate",o).replace("{bib}",a.bib).replace("{point}",l).replace("{device}",a.deviceName),"warning",5e3),window.dispatchEvent(new CustomEvent("cross-device-duplicate",{detail:a}))}typeof r.deviceCount=="number"&&c.setCloudDeviceCount(r.deviceCount),typeof r.highestBib=="number"&&c.setCloudHighestBib(r.highestBib)}catch{}return c.removeFromSyncQueue(e.id),this.resetToFastPolling(),!0}catch(i){return console.error("Cloud sync send error:",i),!1}}async pushLocalEntries(){const e=c.getState();if(!(!e.settings.sync||!e.raceId)){console.log("Pushing",e.entries.length,"local entries to cloud");for(const t of e.entries)t.deviceId===e.deviceId&&!t.syncedAt&&await this.sendEntryToCloud(t)}}startQueueProcessor(){this.queueInterval&&clearInterval(this.queueInterval),this.queueInterval=setInterval(()=>this.processQueue(),kn)}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{const e=c.getState();if(!e.settings.sync||!e.raceId||e.syncQueue.length===0)return;const t=Date.now();for(const i of e.syncQueue){if(i.retryCount>=Cn){console.warn("Max retries exceeded for entry:",i.entry.id),c.removeFromSyncQueue(i.entry.id);continue}const s=Ln*Math.pow(2,i.retryCount);if(t-i.lastAttempt<s)continue;await this.sendEntryToCloud(i.entry)||c.updateSyncQueueItem(i.entry.id,{retryCount:i.retryCount+1,lastAttempt:t,error:"Failed to sync"})}}finally{this.isProcessingQueue=!1}}}showSyncToast(e,t="success",i){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:e,type:t,duration:i}}))}cleanup(){if(this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null),this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasPollingBeforeHidden=!1,this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.networkChangeHandler){const e=navigator.connection;e&&e.removeEventListener("change",this.networkChangeHandler),this.networkChangeHandler=null}this.consecutiveErrors=0,this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.currentBatteryLevel="normal",this.isMeteredConnection=!1,c.setSyncStatus("disconnected"),console.log("Sync service cleaned up")}async forceRefresh(){await this.fetchCloudEntries()}getQueueLength(){return c.getState().syncQueue.length}getLastSyncTime(){return this.lastSyncTimestamp}async checkRaceExists(e){if(!e)return{exists:!1,entryCount:0};try{const t=await N(`${G}?raceId=${encodeURIComponent(e)}&checkOnly=true`,{headers:j()},5e3);if(!t.ok)return{exists:!1,entryCount:0};const i=await t.json();return{exists:i.exists===!0,entryCount:typeof i.entryCount=="number"?i.entryCount:0}}catch(t){return console.error("Check race exists error:",t),{exists:!1,entryCount:0}}}async getPhotoSyncStats(){const e=c.getState();let t=0,i=0,s=0,r=0;for(const o of e.entries)if(o.photo==="indexeddb"&&o.deviceId===e.deviceId){const a=await D.getPhoto(o.id);a&&(t++,i+=a.length)}if(e.settings.sync&&e.raceId)try{const o=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),a=await N(`${G}?${o}`,{headers:j()},se);if(a.ok){const l=await a.json(),g=Array.isArray(l.entries)?l.entries:[];for(const h of g)if(h.photo&&h.photo!=="indexeddb"&&h.photo.length>20&&h.deviceId!==e.deviceId){const p=e.entries.find(m=>m.id===h.id&&m.deviceId===h.deviceId);(!p||!p.photo)&&(s++,r+=h.photo.length)}}}catch(o){console.warn("Failed to fetch cloud entries for photo stats:",o)}return{uploadCount:t,uploadSize:i,downloadCount:s,downloadSize:r,totalSize:i+r}}}const b=new xn,Pe={enableHighAccuracy:!0,timeout:1e4,maximumAge:1e3},Bn=10,Nn=30;class Mn{constructor(){d(this,"watchId",null);d(this,"lastPosition",null);d(this,"visibilityHandler",null);d(this,"wasActiveBeforeHidden",!1)}start(){if(this.watchId!==null)return!0;if(!navigator.geolocation)return console.error("Geolocation not supported"),c.setGpsStatus("inactive"),!1;c.setGpsStatus("searching");try{return this.watchId=navigator.geolocation.watchPosition(e=>this.handlePosition(e),e=>this.handleError(e),Pe),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(this.wasActiveBeforeHidden=this.watchId!==null,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null,c.setGpsStatus("inactive"))):this.wasActiveBeforeHidden&&(c.setGpsStatus("searching"),this.watchId=navigator.geolocation.watchPosition(e=>this.handlePosition(e),e=>this.handleError(e),Pe))},document.addEventListener("visibilitychange",this.visibilityHandler)),console.log("GPS watching started"),!0}catch(e){return console.error("Failed to start GPS:",e),c.setGpsStatus("inactive"),!1}}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasActiveBeforeHidden=!1,this.lastPosition=null,c.setGpsStatus("inactive"),console.log("GPS watching stopped")}handlePosition(e){this.lastPosition=e;const t=e.coords.accuracy;c.setGpsStatus("active",t),console.log(`GPS position: ${t.toFixed(1)}m accuracy`)}handleError(e){switch(console.error("GPS error:",e.message),e.code){case e.PERMISSION_DENIED:c.setGpsStatus("inactive"),this.stop();break;case e.POSITION_UNAVAILABLE:c.setGpsStatus("searching");break;case e.TIMEOUT:c.setGpsStatus("searching");break}}getPosition(){return this.lastPosition}getCoordinates(){if(this.lastPosition)return{latitude:this.lastPosition.coords.latitude,longitude:this.lastPosition.coords.longitude,accuracy:this.lastPosition.coords.accuracy}}getTimestamp(){var e;return((e=this.lastPosition)==null?void 0:e.timestamp)??null}getAccuracyStatus(){if(!this.lastPosition)return"unknown";const e=this.lastPosition.coords.accuracy;return e<=Bn?"good":e<=Nn?"fair":"poor"}isActive(){return this.watchId!==null&&this.lastPosition!==null}toggle(e){return e?this.start():(this.stop(),!0)}async requestPosition(){return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{this.lastPosition=t,e(t)},()=>e(null),Pe)}):null}}const K=new Mn;class $n{constructor(){d(this,"wakeLock",null);d(this,"isEnabled",!1);d(this,"visibilityHandler",null)}isSupported(){return"wakeLock"in navigator}async enable(){return this.isSupported()?this.isEnabled?!0:(this.isEnabled=!0,this.visibilityHandler||(this.visibilityHandler=()=>{!document.hidden&&this.isEnabled&&!this.wakeLock&&this.requestWakeLock()},document.addEventListener("visibilitychange",this.visibilityHandler)),this.requestWakeLock()):(console.log("Wake Lock API not supported"),!1)}async disable(){this.isEnabled=!1,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),await this.releaseWakeLock()}async requestWakeLock(){if(!this.isSupported()||this.wakeLock)return!!this.wakeLock;try{return this.wakeLock=await navigator.wakeLock.request("screen"),this.wakeLock.addEventListener("release",()=>{this.wakeLock=null,console.log("Wake Lock released")}),console.log("Wake Lock acquired - screen will stay on"),!0}catch(e){const t=e instanceof Error?e.message:"Unknown error";return console.warn("Wake Lock request failed:",t),this.wakeLock=null,!1}}async releaseWakeLock(){if(this.wakeLock){try{await this.wakeLock.release()}catch(e){console.warn("Wake Lock release error:",e)}this.wakeLock=null,console.log("Wake Lock disabled")}}isActive(){return this.wakeLock!==null}isWakeLockEnabled(){return this.isEnabled}}const ye=new $n;let Re=null;function bt(){if(!Re)try{Re=new(window.AudioContext||window.webkitAudioContext)}catch(n){return console.warn("AudioContext not available:",n),null}return Re}function X(n){if(c.getState().settings.haptic&&navigator.vibrate)try{navigator.vibrate(n)}catch(t){console.warn("Vibration failed:",t)}}function Ce(n=880,e=100){if(!c.getState().settings.sound)return;const i=bt();if(i)try{const s=i.createOscillator(),r=i.createGain();s.connect(r),r.connect(i.destination),s.frequency.value=n,s.type="sine",r.gain.setValueAtTime(.3,i.currentTime),r.gain.exponentialRampToValueAtTime(.01,i.currentTime+e/1e3),s.start(i.currentTime),s.stop(i.currentTime+e/1e3)}catch(s){console.warn("Sound playback failed:",s)}}function ee(){X(20),Ce(880,100)}function L(){X([50,50,50]),Ce(440,200)}function C(){X(10)}function Oe(){X([30,30,30]),Ce(330,150)}function St(){X([20,20]),Ce(660,100)}async function rt(){const n=bt();if(n&&n.state==="suspended")try{await n.resume()}catch(e){console.warn("Failed to resume audio:",e)}}const ot=0,Fn=1,Hn=3;class zn{constructor(e){d(this,"container");d(this,"timeElement");d(this,"dateElement");d(this,"dateRow");d(this,"lastTimeStr","");d(this,"animationId",null);d(this,"isRunning",!1);d(this,"visibilityHandler",null);d(this,"frameSkipCount",ot);d(this,"currentFrame",0);d(this,"batteryUnsubscribe",null);d(this,"tick",()=>{if(this.isRunning)try{if(this.currentFrame++,this.frameSkipCount===0||this.currentFrame%(this.frameSkipCount+1)===0){const t=new Date,i=pt(t);if(i!==this.lastTimeStr&&(this.updateDigits(i),this.lastTimeStr=i),t.getSeconds()===0||!this.dateElement.textContent){const r=c.getState();this.dateElement.textContent=sn(t,r.currentLang)}}this.animationId=requestAnimationFrame(this.tick)}catch(e){console.error("Clock tick error:",e);try{this.animationId=requestAnimationFrame(this.tick)}catch(t){console.error("Clock RAF scheduling failed:",t),setTimeout(()=>{this.isRunning&&this.tick()},16)}}});this.container=e,this.container.innerHTML="",this.timeElement=this.createTimeElement(),this.dateRow=this.createDateRow(),this.dateElement=this.dateRow.querySelector(".clock-date"),this.container.appendChild(this.timeElement),this.container.appendChild(this.dateRow),this.moveTimingPointsToDateRow()}moveTimingPointsToDateRow(){const e=document.querySelector(".timing-controls");e&&this.dateRow&&this.dateRow.appendChild(e)}createTimeElement(){const e=document.createElement("div");e.className="clock-time",e.setAttribute("role","timer"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Current time"),e.style.cssText=`
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(32px, 10vw, 48px);
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    `;for(let t=0;t<12;t++){const i=document.createElement("span");i.className="clock-digit",i.dataset.index=String(t),e.appendChild(i)}return e}createDateRow(){const e=document.createElement("div");e.className="clock-date-row",e.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      padding: 0 8px;
      width: 100%;
    `;const t=document.createElement("div");return t.className="clock-date",t.style.cssText=`
      font-size: 0.875rem;
      color: var(--text-secondary);
    `,e.appendChild(t),e}start(){this.isRunning||(this.isRunning=!0,this.tick(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null):this.isRunning&&this.animationId===null&&this.tick()},document.addEventListener("visibilitychange",this.visibilityHandler)),this.batteryUnsubscribe||fe.initialize().then(()=>{this.batteryUnsubscribe=fe.subscribe(e=>{this.updateFrameSkipFromBattery(e.batteryLevel)})}))}updateFrameSkipFromBattery(e){const t=this.frameSkipCount;switch(e){case"critical":this.frameSkipCount=Hn;break;case"low":this.frameSkipCount=Fn;break;default:this.frameSkipCount=ot}t!==this.frameSkipCount&&console.log(`Clock frame rate adjusted: battery=${e}, skip=${this.frameSkipCount}`)}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null)}updateDigits(e){const t=this.timeElement.querySelectorAll(".clock-digit");for(let i=0;i<e.length&&i<t.length;i++){const s=t[i],r=e[i];s.textContent!==r&&(s.textContent=r,s.style.transform="scale(1.02)",requestAnimationFrame(()=>{s.style.transform="scale(1)"}))}}getCurrentTime(){return this.lastTimeStr}getTimestamp(){const e=K.getTimestamp();return e?new Date(e):new Date}destroy(){this.stop(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.container.innerHTML=""}}const U=72,at=5,Un=16,On=100;class _n{constructor(e){d(this,"container");d(this,"scrollContainer");d(this,"contentContainer");d(this,"entries",[]);d(this,"filteredEntries",[]);d(this,"visibleItems",new Map);d(this,"scrollTop",0);d(this,"containerHeight",0);d(this,"options");d(this,"unsubscribe",null);d(this,"resizeObserver",null);d(this,"scrollHandler",null);d(this,"scrollDebounceTimeout",null);d(this,"resizeDebounceTimeout",null);d(this,"isPaused",!1);d(this,"needsRefreshOnResume",!1);this.options=e,this.container=e.container,this.scrollContainer=document.createElement("div"),this.scrollContainer.className="virtual-scroll-container",this.scrollContainer.style.cssText=`
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    `,this.contentContainer=document.createElement("div"),this.contentContainer.className="virtual-scroll-content",this.contentContainer.style.position="relative",this.scrollContainer.appendChild(this.contentContainer),this.container.appendChild(this.scrollContainer),this.scrollHandler=()=>{this.scrollDebounceTimeout!==null&&clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=setTimeout(()=>{this.scrollDebounceTimeout=null;try{this.onScroll()}catch(t){console.error("VirtualList scroll error:",t)}},Un)},this.scrollContainer.addEventListener("scroll",this.scrollHandler,{passive:!0}),this.resizeObserver=new ResizeObserver(()=>{this.resizeDebounceTimeout!==null&&clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=setTimeout(()=>{this.resizeDebounceTimeout=null;try{this.containerHeight=this.scrollContainer.clientHeight,this.render()}catch(t){console.error("VirtualList resize error:",t)}},On)}),this.resizeObserver.observe(this.scrollContainer),this.unsubscribe=c.subscribe((t,i)=>{(i.includes("entries")||i.includes("selectedEntries"))&&this.setEntries(t.entries)}),this.containerHeight=this.scrollContainer.clientHeight}setEntries(e){for(const t of e){const i=this.entries.find(s=>s.id===t.id);if(i&&(i.bib!==t.bib||i.point!==t.point||i.status!==t.status||i.photo!==t.photo)){const r=this.visibleItems.get(t.id);r&&(r.remove(),this.visibleItems.delete(t.id))}}this.entries=e,this.applyFilters()}applyFilters(e,t,i){let s=[...this.entries];if(e){const r=e.toLowerCase();s=s.filter(o=>{var a;return o.bib.toLowerCase().includes(r)||((a=o.deviceName)==null?void 0:a.toLowerCase().includes(r))})}t&&t!=="all"&&(s=s.filter(r=>r.point===t)),i&&i!=="all"&&(s=s.filter(r=>r.status===i)),s.sort((r,o)=>{const a=parseInt(r.bib,10)||0;return(parseInt(o.bib,10)||0)-a}),this.filteredEntries=s,this.updateContentHeight(),this.render()}updateContentHeight(){const e=this.filteredEntries.length*U;this.contentContainer.style.height=`${e}px`}onScroll(){this.scrollTop=this.scrollContainer.scrollTop,this.render()}render(){if(this.filteredEntries.length===0){this.renderEmpty();return}const e=this.contentContainer.querySelector(".empty-state");e&&e.remove();const t=Math.max(0,Math.floor(this.scrollTop/U)-at),i=Math.min(this.filteredEntries.length,Math.ceil((this.scrollTop+this.containerHeight)/U)+at),s=c.getState(),r=new Set;for(let o=t;o<i;o++){const a=this.filteredEntries[o];r.add(a.id);let l=this.visibleItems.get(a.id);const g=s.selectedEntries.has(a.id);l||(l=this.createItem(a),this.visibleItems.set(a.id,l),this.contentContainer.appendChild(l)),l.style.transform=`translateY(${o*U}px)`,l.classList.toggle("selected",g)}for(const[o,a]of this.visibleItems)r.has(o)||(a.remove(),this.visibleItems.delete(o))}createItem(e){const t=document.createElement("div");t.className="result-item",t.setAttribute("role","listitem"),t.setAttribute("data-entry-id",e.id),t.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${U}px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 12px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    `;const i=new Date(e.timestamp),s=pt(i),r=rn(e.bib||"---"),o=c.getState().currentLang,a=on(e.point),l=Z(e.point,o),g=e.run??1,h=me(g),p=Fe(g,o);t.innerHTML=`
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 50px;">
        ${z(r)}
      </div>
      <div class="result-point" style="padding: 4px 8px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; background: ${a}20; color: ${a};">
        ${z(l)}
      </div>
      <span class="result-run" data-advanced style="padding: 4px 8px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; background: ${h}20; color: ${h};">${z(p)}</span>
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
        <div class="result-time" style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); font-size: 0.875rem;">
          ${z(s)}
        </div>
        ${e.deviceName?`
          <div class="result-device" style="font-size: 0.7rem; color: var(--text-tertiary);">
            ${z(e.deviceName)}
          </div>
        `:""}
      </div>
      ${e.status!=="ok"?`
        <span class="result-status" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--error); color: white;">
          ${z(e.status.toUpperCase())}
        </span>
      `:""}
      ${e.photo?`
        <button class="result-photo-btn" aria-label="View photo" style="background: none; border: none; color: var(--primary); padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/>
            <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
          </svg>
        </button>
      `:""}
      <button class="result-delete" aria-label="Delete entry" style="background: none; border: none; color: var(--error); padding: 8px; cursor: pointer; opacity: 0.7;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    `,t.querySelector(".result-delete").addEventListener("click",w=>{var y,f;w.stopPropagation(),(f=(y=this.options).onItemDelete)==null||f.call(y,e)});const E=t.querySelector(".result-photo-btn");return E&&E.addEventListener("click",w=>{var y,f;w.stopPropagation(),(f=(y=this.options).onViewPhoto)==null||f.call(y,e)}),t.addEventListener("click",w=>{var y,f;(f=(y=this.options).onItemClick)==null||f.call(y,e,w)}),t.addEventListener("touchstart",()=>{t.style.background="var(--surface-elevated)"},{passive:!0}),t.addEventListener("touchend",()=>{t.style.background="var(--surface)"},{passive:!0}),t}renderEmpty(){for(const t of this.visibleItems.values())t.remove();this.visibleItems.clear();const e=c.getState();this.contentContainer.innerHTML=`
      <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: var(--text-secondary);">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 16px; opacity: 0.5;">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <span id="empty-state-text">${u("noEntries",e.currentLang)}</span>
      </div>
    `}scrollToTop(){this.scrollContainer.scrollTo({top:0,behavior:"smooth"})}scrollToEntry(e){const t=this.filteredEntries.findIndex(i=>i.id===e);if(t!==-1){const i=t*U;this.scrollContainer.scrollTo({top:i,behavior:"smooth"})}}getVisibleCount(){return this.filteredEntries.length}pause(){this.isPaused||(this.isPaused=!0,this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.resizeObserver&&this.resizeObserver.disconnect(),this.scrollDebounceTimeout!==null&&(clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=null),this.resizeDebounceTimeout!==null&&(clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=null),this.scrollHandler&&this.scrollContainer.removeEventListener("scroll",this.scrollHandler),console.log("VirtualList paused"))}resume(){this.isPaused&&(this.isPaused=!1,this.unsubscribe||(this.unsubscribe=c.subscribe((e,t)=>{(t.includes("entries")||t.includes("selectedEntries"))&&(this.isPaused?this.needsRefreshOnResume=!0:this.setEntries(e.entries))})),this.resizeObserver&&this.resizeObserver.observe(this.scrollContainer),this.scrollHandler&&this.scrollContainer.addEventListener("scroll",this.scrollHandler,{passive:!0}),this.needsRefreshOnResume&&(this.needsRefreshOnResume=!1,this.setEntries(c.getState().entries)),this.containerHeight=this.scrollContainer.clientHeight,this.render(),console.log("VirtualList resumed"))}isPausedState(){return this.isPaused}destroy(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.scrollDebounceTimeout!==null&&(clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=null),this.resizeDebounceTimeout!==null&&(clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=null),this.scrollHandler&&(this.scrollContainer.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null),this.visibleItems.clear(),this.container.innerHTML=""}}const qn=3e3;class Vn{constructor(){d(this,"container");d(this,"queue",[]);d(this,"isShowing",!1);d(this,"toastEventListener");this.container=this.createContainer(),document.body.appendChild(this.container),this.toastEventListener=e=>{this.show(e.detail.message,{type:e.detail.type,duration:e.detail.duration})},window.addEventListener("show-toast",this.toastEventListener)}createContainer(){const e=document.createElement("div");return e.id="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.style.cssText=`
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    `,e}show(e,t={}){this.queue.push({message:e,options:t}),this.isShowing||this.processQueue()}processQueue(){if(this.queue.length===0){this.isShowing=!1;return}this.isShowing=!0;const{message:e,options:t}=this.queue.shift(),i=t.duration||qn,s=t.type||"info",r=this.createToast(e,s);this.container.appendChild(r),requestAnimationFrame(()=>{r.style.opacity="1",r.style.transform="translateY(0)"}),setTimeout(()=>{r.style.opacity="0",r.style.transform="translateY(10px)",setTimeout(()=>{r.remove(),this.processQueue()},200)},i)}createToast(e,t){const i=document.createElement("div");i.className=`toast toast-${t}`;const s={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--primary)"},r={success:'<path d="M20 6L9 17l-5-5"/>',error:'<path d="M18 6L6 18M6 6l12 12"/>',warning:'<path d="M12 9v4M12 17h.01"/>',info:'<path d="M12 16v-4M12 8h.01"/>'};return i.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border-left: 3px solid ${s[t]};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 0.875rem;
      color: var(--text-primary);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: auto;
      max-width: 90vw;
    `,i.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${s[t]}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        ${r[t]}
      </svg>
      <span>${this.escapeHtml(e)}</span>
    `,i}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}clear(){this.queue=[],this.container.innerHTML="",this.isShowing=!1}destroy(){window.removeEventListener("show-toast",this.toastEventListener),this.clear(),this.container.remove()}}let _=null;function It(){return _||(_=new Vn),_}function v(n,e="info",t){It().show(n,{type:e,duration:t})}function Gn(){_&&(_.destroy(),_=null)}const re=80,ct=2.5;class jn{constructor(e){d(this,"container");d(this,"indicator");d(this,"onRefresh");d(this,"startY",0);d(this,"currentY",0);d(this,"isPulling",!1);d(this,"isRefreshing",!1);d(this,"scrollableParent",null);d(this,"onTouchStart",e=>{var i;this.isRefreshing||(((i=this.scrollableParent)==null?void 0:i.scrollTop)??0)>0||(this.startY=e.touches[0].clientY,this.isPulling=!0)});d(this,"onTouchMove",e=>{var t;if(!(!this.isPulling||this.isRefreshing))try{if((((t=this.scrollableParent)==null?void 0:t.scrollTop)??0)>0){this.isPulling=!1;return}this.currentY=e.touches[0].clientY;const s=(this.currentY-this.startY)/ct;s>0&&(e.preventDefault(),this.updateIndicator(s))}catch(i){console.error("PullToRefresh move error:",i),this.isPulling=!1,this.resetIndicator()}});d(this,"onTouchEnd",async()=>{if(!this.isPulling||this.isRefreshing)return;const e=(this.currentY-this.startY)/ct;this.isPulling=!1,e>=re?(this.isRefreshing=!0,await this.triggerRefresh()):this.resetIndicator()});this.container=e.container,this.onRefresh=e.onRefresh,this.indicator=this.createIndicator(),this.container.insertBefore(this.indicator,this.container.firstChild),this.scrollableParent=this.findScrollableParent(this.container),this.bindEvents()}createIndicator(){const e=document.createElement("div");e.className="pull-indicator",e.style.cssText=`
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: transform 0.2s;
      pointer-events: none;
      z-index: 100;
    `,e.innerHTML=`
      <div class="pull-indicator-content" style="display: flex; align-items: center; gap: 8px;">
        <svg class="pull-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
        <span class="pull-text">Pull to refresh</span>
      </div>
      <div class="pull-spinner" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      </div>
    `;const t=document.createElement("style");return t.textContent=`
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(t),e}findScrollableParent(e){let t=e.parentElement;for(;t;){const i=getComputedStyle(t);if(i.overflowY==="auto"||i.overflowY==="scroll")return t;t=t.parentElement}return null}bindEvents(){this.container.addEventListener("touchstart",this.onTouchStart,{passive:!0}),this.container.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.container.addEventListener("touchend",this.onTouchEnd,{passive:!0})}updateIndicator(e){const t=Math.min(e,re*1.5);this.indicator.style.transform=`translateY(${t}px)`;const i=Math.min(e/re,1),s=this.indicator.querySelector(".pull-icon"),r=this.indicator.querySelector(".pull-text");s&&(s.style.transform=`rotate(${i*180}deg)`),r&&(r.textContent=i>=1?"Release to refresh":"Pull to refresh")}async triggerRefresh(){const e=this.indicator.querySelector(".pull-indicator-content"),t=this.indicator.querySelector(".pull-spinner");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.indicator.style.transform=`translateY(${re}px)`;try{await this.onRefresh()}catch(i){console.error("PullToRefresh callback error:",i)}finally{this.isRefreshing=!1,e&&(e.style.display="flex"),t&&(t.style.display="none"),this.resetIndicator()}}resetIndicator(){this.indicator.style.transform="translateY(0)";const e=this.indicator.querySelector(".pull-icon");e&&(e.style.transform="rotate(0deg)")}destroy(){this.container.removeEventListener("touchstart",this.onTouchStart),this.container.removeEventListener("touchmove",this.onTouchMove),this.container.removeEventListener("touchend",this.onTouchEnd),this.indicator.remove()}}var Qn="@vercel/speed-insights",Wn="1.3.1",Yn=()=>{window.si||(window.si=function(...e){(window.siq=window.siq||[]).push(e)})};function Jn(){return typeof window<"u"}function Zn(){try{const n="production"}catch{}return"production"}function wt(){return Zn()==="development"}function Kn(n){return n.scriptSrc?n.scriptSrc:wt()?"https://va.vercel-scripts.com/v1/speed-insights/script.debug.js":n.dsn?"https://va.vercel-scripts.com/v1/speed-insights/script.js":n.basePath?`${n.basePath}/speed-insights/script.js`:"/_vercel/speed-insights/script.js"}function Xn(n={}){var e;if(!Jn()||n.route===null)return null;Yn();const t=Kn(n);if(document.head.querySelector(`script[src*="${t}"]`))return null;n.beforeSend&&((e=window.si)==null||e.call(window,"beforeSend",n.beforeSend));const i=document.createElement("script");return i.src=t,i.defer=!0,i.dataset.sdkn=Qn+(n.framework?`/${n.framework}`:""),i.dataset.sdkv=Wn,n.sampleRate&&(i.dataset.sampleRate=n.sampleRate.toString()),n.route&&(i.dataset.route=n.route),n.endpoint?i.dataset.endpoint=n.endpoint:n.basePath&&(i.dataset.endpoint=`${n.basePath}/speed-insights/vitals`),n.dsn&&(i.dataset.dsn=n.dsn),wt()&&n.debug===!1&&(i.dataset.debug="false"),i.onerror=()=>{console.log(`[Vercel Speed Insights] Failed to load script from ${t}. Please check if any content blockers are enabled and try again.`)},document.head.appendChild(i),{setRoute:s=>{i.dataset.route=s??void 0}}}const Ae="skiTimerHasCompletedOnboarding";function ei(n,e){let t=null;return(...i)=>{t&&clearTimeout(t),t=setTimeout(()=>n(...i),e)}}function ti(n){!n||!n.classList.contains("show")||(n.classList.add("closing"),setTimeout(()=>{n.classList.remove("show","closing")},150))}class ni{constructor(){d(this,"modal");d(this,"currentStep",1);d(this,"totalSteps",5);d(this,"updateTranslationsCallback",null);this.modal=document.getElementById("onboarding-modal"),this.modal&&this.setupEventListeners()}setUpdateTranslationsCallback(e){this.updateTranslationsCallback=e}shouldShow(){return localStorage.getItem(Ae)!=="true"}show(){if(!this.modal)return;this.currentStep=1,this.modal.querySelectorAll(".onboarding-card").forEach((l,g)=>{l.style.display=g===0?"block":"none"});const e=document.getElementById("onboarding-race-id");e&&(e.value="");const t=document.getElementById("onboarding-pin");t&&(t.value="",t.style.display="none");const i=document.getElementById("onboarding-race-status");i&&(i.textContent="",i.className="race-status");const s=document.getElementById("onboarding-sync-toggle");s&&(s.checked=!0);const r=document.getElementById("onboarding-photo-toggle");r&&(r.checked=!1),this.updateUI(),this.modal.classList.add("show");const o=document.getElementById("onboarding-device-name");o&&(o.value=c.getState().deviceName);const a=c.getState().currentLang;this.modal.querySelectorAll(".lang-btn").forEach(l=>{const g=l.dataset.lang;l.classList.toggle("selected",g===a)})}reset(){localStorage.removeItem(Ae)}setupEventListeners(){if(!this.modal)return;this.modal.querySelectorAll(".lang-btn").forEach(r=>{r.addEventListener("click",o=>{const a=o.currentTarget,l=a.dataset.lang;l&&(c.setLanguage(l),this.modal.querySelectorAll(".lang-btn").forEach(g=>g.classList.remove("selected")),a.classList.add("selected"),C(),this.updateTranslationsCallback&&this.updateTranslationsCallback(),this.updateOnboardingTranslations())})}),this.modal.querySelectorAll("[data-action]").forEach(r=>{r.addEventListener("click",async o=>{const l=o.currentTarget.dataset.action;l&&(C(),await this.handleAction(l))})});const e=document.getElementById("onboarding-regenerate-name");e&&e.addEventListener("click",()=>{const r=document.getElementById("onboarding-device-name");r&&(r.value=he(),C())});const t=document.getElementById("onboarding-race-id");if(t){const r=ei(()=>this.checkRaceExists(),500);t.addEventListener("input",()=>{r();const o=document.getElementById("onboarding-pin");o&&(o.style.display=t.value.trim()?"block":"none")})}const i=document.getElementById("onboarding-recent-races-btn"),s=document.getElementById("onboarding-recent-races-dropdown");i&&s&&(i.addEventListener("click",()=>{C(),s.style.display==="none"?this.showRecentRacesDropdown(s,"onboarding-race-id"):s.style.display="none"}),document.addEventListener("click",r=>{const o=r.target;!i.contains(o)&&!s.contains(o)&&(s.style.display="none")}))}async showRecentRacesDropdown(e,t){const i=c.getState().currentLang;e.innerHTML=`<div class="recent-races-empty">${u("loading",i)}</div>`,e.style.display="block";let s=[];if($())try{s=await this.fetchRacesFromApi()}catch(r){console.warn("Failed to fetch races from API:",r),s=pe()}else s=pe();s.length===0?e.innerHTML=`<div class="recent-races-empty">${u("noRecentRaces",i)}</div>`:(e.innerHTML=s.map(r=>this.renderRecentRaceItem(r)).join(""),e.querySelectorAll(".recent-race-item").forEach((r,o)=>{r.addEventListener("click",()=>{const a=s[o];this.selectRecentRace(a,t,e)})}))}async fetchRacesFromApi(){const e=localStorage.getItem("skiTimerAuthToken");if(!e)return[];const t=await N("/api/admin/races",{headers:{Authorization:`Bearer ${e}`}},5e3);if(!t.ok)throw new Error(`API error: ${t.status}`);const s=(await t.json()).races||[],r=new Date;r.setHours(0,0,0,0);const o=r.getTime(),a=s.filter(l=>l.lastUpdated&&l.lastUpdated>=o).map(l=>({raceId:l.raceId,createdAt:l.lastUpdated||Date.now(),lastUpdated:l.lastUpdated||Date.now(),entryCount:l.entryCount})).slice(0,5);return a.forEach(l=>{ze(l.raceId,l.lastUpdated,l.entryCount)}),a}renderRecentRaceItem(e){const t=e.entryCount!==void 0?`${e.entryCount} entries`:"";return`
      <div class="recent-race-item" data-race-id="${e.raceId}">
        <span class="recent-race-id">${e.raceId}</span>
        <span class="recent-race-meta">${t}</span>
      </div>
    `}selectRecentRace(e,t,i){const s=document.getElementById(t);s&&(s.value=e.raceId,s.dispatchEvent(new Event("input",{bubbles:!0})),C()),i.style.display="none"}updateOnboardingTranslations(){if(!this.modal)return;const e=c.getState().currentLang;this.modal.querySelectorAll("[data-i18n]").forEach(t=>{const i=t.getAttribute("data-i18n");i&&(t.textContent=u(i,e))})}async handleAction(e){switch(e){case"next":await this.validateCurrentStep()&&(await this.saveCurrentStep(),this.goToStep(this.currentStep+1));break;case"skip":this.goToStep(this.currentStep+1);break;case"finish":this.complete();break}}async validateCurrentStep(){var t,i,s,r;const e=c.getState().currentLang;switch(this.currentStep){case 2:return((t=document.getElementById("onboarding-device-name"))==null?void 0:t.value.trim())?!0:(v(u("deviceName",e),"warning"),!1);case 3:return!0;case 4:{const o=(i=document.getElementById("onboarding-race-id"))==null?void 0:i.value.trim(),a=(s=document.getElementById("onboarding-sync-toggle"))==null?void 0:s.checked;if(!o||!a)return!0;const l=(r=document.getElementById("onboarding-pin"))==null?void 0:r.value;return l.length!==4?(v(u("invalidPin",e),"warning"),!1):await this.validatePin(l)}default:return!0}}async saveCurrentStep(){var e,t,i,s;switch(this.currentStep){case 2:{const r=(e=document.getElementById("onboarding-device-name"))==null?void 0:e.value.trim();r&&c.setDeviceName(r);break}case 3:{const r=(t=document.getElementById("onboarding-photo-toggle"))==null?void 0:t.checked;c.updateSettings({photoCapture:r});break}case 4:{const r=(i=document.getElementById("onboarding-race-id"))==null?void 0:i.value.trim(),o=(s=document.getElementById("onboarding-sync-toggle"))==null?void 0:s.checked;r&&c.setRaceId(r);const a=o&&!!r;c.updateSettings({sync:a}),a&&b.initialize();break}}}goToStep(e){if(!this.modal||e<1||e>this.totalSteps)return;const t=this.modal.querySelector(`[data-step="${this.currentStep}"]`);t&&(t.style.display="none"),this.currentStep=e;const i=this.modal.querySelector(`[data-step="${e}"]`);i&&(i.style.display="block"),this.updateProgressDots(),e===5&&this.showSummary()}updateProgressDots(){if(!this.modal)return;this.modal.querySelectorAll(".progress-dot").forEach((t,i)=>{t.classList.remove("active","completed"),i+1===this.currentStep?t.classList.add("active"):i+1<this.currentStep&&t.classList.add("completed")})}updateUI(){this.updateProgressDots(),this.updateOnboardingTranslations()}showSummary(){const e=c.getState(),t=e.currentLang,i=document.getElementById("onboarding-summary");i&&(i.innerHTML=`
        <div class="onboarding-summary-item">
          <span>${u("deviceNameLabel",t)}</span>
          <strong>${e.deviceName}</strong>
        </div>
        <div class="onboarding-summary-item">
          <span>${u("photoCaptureLabel",t)}</span>
          <strong>${e.settings.photoCapture?u("enabled",t):u("disabled",t)}</strong>
        </div>
        <div class="onboarding-summary-item">
          <span>${u("raceIdLabel",t)}</span>
          <strong>${e.raceId||"—"}</strong>
        </div>
        <div class="onboarding-summary-item">
          <span>${u("syncStatusLabel",t)}</span>
          <strong>${e.settings.sync?u("enabled",t):u("disabled",t)}</strong>
        </div>
      `)}async checkRaceExists(){const e=document.getElementById("onboarding-race-id"),t=document.getElementById("onboarding-race-status");if(!e||!t)return;const i=e.value.trim();if(!i){t.textContent="",t.className="race-status";return}const s=await b.checkRaceExists(i),r=c.getState().currentLang;s.exists?(t.textContent=`✓ ${u("raceFound",r)} (${s.entryCount} ${u("entries",r)})`,t.className="race-status found"):(t.textContent=`+ ${u("raceNew",r)}`,t.className="race-status new")}async validatePin(e){try{return(await Ue(e)).success}catch{return!0}}complete(){localStorage.setItem(Ae,"true"),ti(this.modal),c.setView("timer"),ee(),v(u("onboardingComplete",c.getState().currentLang),"success")}}function A(n){!n||!n.classList.contains("show")||(n.classList.add("closing"),setTimeout(()=>{n.classList.remove("show","closing")},150))}const ve=new Set;function T(n,e,t){const i=e.getBoundingClientRect();let s,r;typeof TouchEvent<"u"&&n instanceof TouchEvent&&n.touches.length>0?(s=n.touches[0].clientX-i.left,r=n.touches[0].clientY-i.top):typeof MouseEvent<"u"&&n instanceof MouseEvent?(s=n.clientX-i.left,r=n.clientY-i.top):(s=i.width/2,r=i.height/2);const o=document.createElement("span");o.classList.add("ripple"),t&&o.classList.add(`ripple-${t}`);const a=Math.max(i.width,i.height)*2;o.style.width=`${a}px`,o.style.height=`${a}px`,o.style.left=`${s-a/2}px`,o.style.top=`${r-a/2}px`,e.appendChild(o);const l=setTimeout(()=>{o.remove(),ve.delete(l)},500);ve.add(l)}function ii(){document.querySelectorAll(".num-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>T(t,e),{passive:!0}),e.addEventListener("mousedown",t=>T(t,e))});const n=document.querySelector(".timestamp-btn");n&&(n.classList.add("ripple-container"),n.addEventListener("touchstart",e=>T(e,n,"primary"),{passive:!0}),n.addEventListener("mousedown",e=>T(e,n,"primary"))),document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.add("ripple-container");const t=e.getAttribute("data-point")==="S";e.addEventListener("touchstart",i=>T(i,e,t?"success":"secondary"),{passive:!0}),e.addEventListener("mousedown",i=>T(i,e,t?"success":"secondary"))}),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>T(t,e,"primary"),{passive:!0}),e.addEventListener("mousedown",t=>T(t,e,"primary"))}),document.querySelectorAll(".action-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>T(t,e),{passive:!0}),e.addEventListener("mousedown",t=>T(t,e))}),document.querySelectorAll(".modal-btn").forEach(e=>{e.classList.add("ripple-container");const t=e.classList.contains("primary"),i=e.classList.contains("danger"),s=t?"primary":i?"secondary":void 0;e.addEventListener("touchstart",r=>T(r,e,s),{passive:!0}),e.addEventListener("mousedown",r=>T(r,e,s))})}function si(){ve.forEach(n=>clearTimeout(n)),ve.clear()}function ri(n){const e=new Date(n),t=e.getHours().toString().padStart(2,"0"),i=e.getMinutes().toString().padStart(2,"0"),s=e.getSeconds().toString().padStart(2,"0"),r=Math.round(e.getMilliseconds()/10).toString().padStart(2,"0");return`${t}:${i}:${s},${r}`}function lt(n){const e=["=","+","-","@","	","\r",`
`];let t=n;return e.some(i=>t.startsWith(i))&&(t=`'${t}`),t.includes('"')&&(t=t.replace(/"/g,'""')),(t.includes(";")||t.includes('"')||t.includes(`
`))&&(t=`"${t}"`),t}function oi(n){return n==="S"?"ST":"FT"}function ai(n,e){var i;return((i={ok:{en:"OK",de:"OK"},dns:{en:"DNS",de:"DNS"},dnf:{en:"DNF",de:"DNF"},dsq:{en:"DSQ",de:"DSQ"}}[n])==null?void 0:i[e])||n.toUpperCase()}function Ct(){const n=c.getState(),e=n.entries,t=n.currentLang;if(e.length===0){v(u("noEntries",t),"warning");return}const i=[...e].sort((m,E)=>new Date(m.timestamp).getTime()-new Date(E.timestamp).getTime()),s="Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät",r=i.map(m=>{const E=lt(m.bib),w=m.run??1,y=oi(m.point),f=ri(m.timestamp),x=ai(m.status,t),te=lt(m.deviceName||m.deviceId);return`${E};${w};${y};${f};${x};${te}`}),o=[s,...r].join(`
`),a=new Blob([o],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(a),g=document.createElement("a");g.href=l;const h=new Date().toISOString().split("T")[0],p=n.raceId||"race";g.download=`${p}_${h}.csv`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(l),ee(),v(u("exported",t),"success")}Xn();const Lt="/api/admin/races",kt="skiTimerAuthToken";function _e(){const n=localStorage.getItem(kt);return n?{Authorization:`Bearer ${n}`}:{}}async function Le(n){const e=await Ue(n);return e.success&&Se(),e}let M=null,R=null,F=null,B=null,q=null,Q=null,Ne=0,I=null;function dt(){const n=document.getElementById("app-version");n&&(n.textContent="3.4.0"),ci(),li(),di(),ui(),hi(),gi(),vi(),bi(),Si(),Ui(),ii(),c.subscribe(Pi);const e=c.getState().settings;if(e.gps&&K.start(),e.sync&&c.getState().raceId)if($())b.initialize();else{c.updateSettings({sync:!1});const s=document.getElementById("sync-toggle");s&&(s.checked=!1),setTimeout(()=>{const r=c.getState().currentLang;v(u("syncRequiresPin",r),"info",5e3)},500)}e.photoCapture&&O.initialize(),window.addEventListener("race-deleted",zt),window.addEventListener("auth-expired",Ut),window.addEventListener("storage-error",Ot),window.addEventListener("storage-warning",_t),document.addEventListener("click",rt,{once:!0}),document.addEventListener("touchstart",rt,{once:!0}),window.addEventListener("beforeunload",Qi),Ft(),Ri(),c.getState().currentView==="timer"&&ye.enable(),F=new ni,F.setUpdateTranslationsCallback(()=>Ve()),F.shouldShow()&&F.show();const i=document.getElementById("show-tutorial-btn");i&&i.addEventListener("click",()=>{F&&(F.reset(),F.show(),C())}),console.log("Ski Race Timer initialized")}function ci(){M&&(M.destroy(),M=null);const n=document.getElementById("clock-container");n&&(M=new zn(n),M.start())}function li(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-view");t&&(c.setView(t),C())})})}function di(){const n=document.getElementById("number-pad");n&&n.addEventListener("click",e=>{const i=e.target.closest(".num-btn");if(!i)return;const s=i.getAttribute("data-num"),r=i.getAttribute("data-action");if(s){const o=c.getState();o.bibInput.length<3&&(c.setBibInput(o.bibInput+s),C())}else if(r==="clear")c.setBibInput(""),C();else if(r==="delete"){const o=c.getState();c.setBibInput(o.bibInput.slice(0,-1)),C()}})}function ui(){const n=document.getElementById("timing-points");n&&n.addEventListener("click",e=>{const i=e.target.closest(".timing-point-btn");if(!i)return;const s=i.getAttribute("data-point");s&&(c.setSelectedPoint(s),C())})}function hi(){const n=document.getElementById("run-selector");n&&n.addEventListener("click",e=>{const i=e.target.closest(".run-btn");if(!i)return;const s=i.getAttribute("data-run"),r=s?parseInt(s,10):1;c.setSelectedRun(r),C()})}function gi(){const n=document.getElementById("timestamp-btn");n&&(n.addEventListener("click",async()=>{await ut()}),document.addEventListener("keydown",e=>{e.key==="Enter"&&c.getState().currentView==="timer"&&(e.preventDefault(),ut())}))}async function ut(){const n=c.getState();if(n.isRecording)return;const e=new Date().toISOString(),t=K.getCoordinates();c.setRecording(!0);try{const i={id:Qt(n.deviceId),bib:n.bibInput?n.bibInput.padStart(3,"0"):"",point:n.selectedPoint,run:n.selectedRun,timestamp:e,status:"ok",deviceId:n.deviceId,deviceName:n.deviceName,gpsCoords:t};if(n.settings.photoCapture){const o=i.id;fn().then(async a=>{if(a)try{if(!c.getState().entries.some(p=>p.id===o)){console.warn("Entry was deleted before photo could be attached:",o);return}await D.savePhoto(o,a)&&(c.updateEntry(o,{photo:"indexeddb"})||(console.warn("Entry deleted during photo save, removing orphaned photo:",o),await D.deletePhoto(o)))}catch(l){Be("Camera","photo save/update",l,"photoError")}}).catch(a=>{Be("Camera","captureTimingPhoto",a,"photoError")})}const s=i.bib&&n.entries.some(o=>o.bib===i.bib&&o.point===i.point&&(o.run??1)===i.run),r=pi(i.bib);if(c.addEntry(i),s?(L(),mi(i)):r?(L(),fi(i)):(ee(),qe(i)),b.broadcastEntry(i),n.settings.auto&&n.bibInput&&n.selectedPoint==="F"){const o=parseInt(n.bibInput,10)+1,a=n.settings.sync&&n.cloudHighestBib>0?Math.max(o,n.cloudHighestBib+1):o;c.setBibInput(String(a))}else n.bibInput&&n.settings.auto||c.setBibInput("");yi(i)}finally{c.setRecording(!1)}}function qe(n){const e=document.getElementById("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-bib"),i=e.querySelector(".confirmation-point"),s=e.querySelector(".confirmation-run"),r=e.querySelector(".confirmation-time"),o=c.getState();if(t&&(t.textContent=n.bib||"---"),i&&(i.textContent=Z(n.point,o.currentLang),i.style.color=be(n.point)),s&&n.run&&(s.textContent=Fe(n.run,o.currentLang),s.style.color=me(n.run)),r){const a=new Date(n.timestamp);r.textContent=Ge(a)}e.dataset.point=n.point,e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},1500)}function mi(n){const e=document.getElementById("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-duplicate");t&&(t.style.display="flex"),qe(n),setTimeout(()=>{t&&(t.style.display="none")},2500)}function fi(n){const e=document.getElementById("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-zero-bib");t&&(t.style.display="flex"),qe(n),setTimeout(()=>{t&&(t.style.display="none")},2500)}function pi(n){return n?/^0+$/.test(n):!1}function yi(n){const e=document.getElementById("last-recorded");if(!e)return;const t=e.querySelector(".bib"),i=e.querySelector(".point"),s=e.querySelector(".run"),r=e.querySelector(".time"),o=c.getState();if(t&&(t.textContent=n.bib||"---"),i&&(i.textContent=Z(n.point,o.currentLang),i.style.background=`${be(n.point)}20`,i.style.color=be(n.point)),s&&n.run&&(s.textContent=Fe(n.run,o.currentLang),s.style.background=`${me(n.run)}20`,s.style.color=me(n.run)),r){const a=new Date(n.timestamp);r.textContent=Ge(a)}e.classList.add("visible")}function ht(n,e){return console.log("showRaceChangeDialog called:",{type:n,lang:e}),new Promise(t=>{const i=document.getElementById("race-change-modal");if(console.log("Modal element:",i),!i){console.log("Modal not found!"),t("cancel");return}const s=i.querySelector(".modal-title"),r=i.querySelector(".modal-text"),o=document.getElementById("race-change-export-btn"),a=document.getElementById("race-change-delete-btn"),l=document.getElementById("race-change-keep-btn"),g=i.querySelector('[data-action="cancel"]');n==="synced"?(s&&(s.textContent=u("raceChangeTitle",e)),r&&(r.textContent=u("raceChangeSyncedText",e)),o&&(o.style.display=""),l&&(l.style.display="none")):(s&&(s.textContent=u("raceChangeTitle",e)),r&&(r.textContent=u("raceChangeUnsyncedText",e)),o&&(o.style.display="none"),l&&(l.style.display=""));const h=()=>{A(i),o==null||o.removeEventListener("click",p),a==null||a.removeEventListener("click",m),l==null||l.removeEventListener("click",E),g==null||g.removeEventListener("click",w)},p=()=>{h(),t("export")},m=()=>{h(),t("delete")},E=()=>{h(),t("keep")},w=()=>{h(),t("cancel")};o==null||o.addEventListener("click",p),a==null||a.addEventListener("click",m),l==null||l.addEventListener("click",E),g==null||g.addEventListener("click",w),console.log("Adding show class to modal"),i.classList.add("show"),console.log("Modal classes after add:",i.classList.toString())})}function vi(){const n=document.getElementById("results-list");if(!n)return;R=new _n({container:n,onItemClick:o=>Ii(o),onItemDelete:o=>wi(o),onItemSelect:(o,a)=>{c.toggleEntrySelection(o.id)},onViewPhoto:o=>ki(o)});const e=c.getState();R.setEntries(e.entries),ke();const t=document.querySelector(".results-view");t&&new jn({container:t,onRefresh:async()=>{await b.forceRefresh(),v(u("syncReceived",c.getState().currentLang),"success")}});const i=document.getElementById("search-input");i&&(B&&(clearTimeout(B),B=null),Q&&i.removeEventListener("input",Q),Q=()=>{B&&clearTimeout(B),B=setTimeout(()=>{De()},300)},i.addEventListener("input",Q));const s=document.getElementById("filter-point"),r=document.getElementById("filter-status");s&&s.addEventListener("change",De),r&&r.addEventListener("change",De),Ei(),e.currentView!=="results"&&R&&R.pause()}function Ei(){const n=document.getElementById("clear-all-btn");n&&n.addEventListener("click",()=>{const s=c.getState();if(s.entries.length===0){v(u("noEntries",s.currentLang),"info");return}ae("clearAll")});const e=document.getElementById("undo-btn");e&&e.addEventListener("click",()=>{if(c.canUndo()){const s=c.peekUndo();if(s&&s.type==="ADD_ENTRY")ae("undoAdd");else{const r=c.undo();St(),v(u("undone",c.getState().currentLang),"success");const o=c.getState();if(r&&r.type==="ADD_ENTRY"&&o.settings.sync&&o.raceId){const a=r.data;b.deleteEntryFromCloud(a.id,a.deviceId)}}}});const t=document.getElementById("export-btn");t&&t.addEventListener("click",Ct);const i=document.getElementById("delete-selected-btn");i&&i.addEventListener("click",()=>{c.getState().selectedEntries.size>0&&ae("deleteSelected")})}function De(){if(!R)return;const n=document.getElementById("search-input"),e=document.getElementById("filter-point"),t=document.getElementById("filter-status");R.applyFilters((n==null?void 0:n.value)||"",(e==null?void 0:e.value)||"all",(t==null?void 0:t.value)||"all"),ke()}function bi(){const n=document.getElementById("simple-mode-toggle");n&&n.addEventListener("change",()=>{c.updateSettings({simple:n.checked}),Ft();const y=document.getElementById("admin-section");y&&(y.style.display=n.checked?"none":"block")});const e=document.getElementById("gps-toggle");e&&e.addEventListener("change",()=>{c.updateSettings({gps:e.checked}),K.toggle(e.checked)});const t=document.getElementById("sync-toggle");let i=!1;t&&t.addEventListener("change",async()=>{if(i){t.checked=!t.checked;return}i=!0;try{const y=c.getState();if(t.checked&&y.raceId&&!await $e(y.currentLang)){t.checked=!1;return}c.updateSettings({sync:t.checked});const f=document.getElementById("sync-photos-toggle");f&&(f.disabled=!t.checked,t.checked||(f.checked=!1,c.updateSettings({syncPhotos:!1}))),t.checked&&y.raceId?b.initialize():b.cleanup()}finally{i=!1}});const s=document.getElementById("sync-photos-toggle");s&&s.addEventListener("change",async y=>{const f=y.target;f.checked?(y.preventDefault(),f.checked=!1,await Gi()):c.updateSettings({syncPhotos:!1})});const r=document.getElementById("auto-toggle");r&&r.addEventListener("change",()=>{c.updateSettings({auto:r.checked})});const o=document.getElementById("haptic-toggle");o&&o.addEventListener("change",()=>{c.updateSettings({haptic:o.checked})});const a=document.getElementById("sound-toggle");a&&a.addEventListener("change",()=>{c.updateSettings({sound:a.checked})});const l=document.getElementById("photo-toggle");l&&l.addEventListener("change",()=>{c.updateSettings({photoCapture:l.checked}),O.toggle(l.checked)});const g=document.getElementById("lang-toggle");g&&g.addEventListener("click",y=>{const x=y.target.getAttribute("data-lang");x&&x!==c.getState().currentLang&&(c.setLanguage(x),Ve(),$t())});const h=document.getElementById("race-id-input");let p=!1;h&&(h.addEventListener("input",()=>{q&&clearTimeout(q);const y=h.value.trim();y?q=setTimeout(()=>Di(y),500):je(null,0)}),h.addEventListener("change",async()=>{if(!p){p=!0;try{const y=h.value.trim(),f=c.getState(),x=f.entries.length>0,te=f.lastSyncedRaceId!=="",Ye=y!==f.raceId&&y!=="";if(console.log("Race ID change:",{newRaceId:y,currentRaceId:f.raceId,hasEntries:x,wasPreviouslySynced:te,isChangingRace:Ye,entriesCount:f.entries.length}),x&&Ye)if(te){const H=await ht("synced",f.currentLang);if(H==="export")Ct(),c.clearAll();else if(H==="delete")c.clearAll();else{h.value=f.raceId;return}}else{const H=await ht("unsynced",f.currentLang);if(H==="delete")c.clearAll();else if(H==="cancel"){h.value=f.raceId;return}}if(y&&!ft(y)){v(u("invalidRaceId",f.currentLang),"error"),h.value=f.raceId,L();return}if(f.settings.sync&&y&&!await $e(f.currentLang)){h.value=f.raceId;return}f.settings.sync&&f.raceId&&b.cleanup();const Te=y.toLowerCase();h.value=Te,c.setRaceId(Te),f.settings.sync&&Te&&(b.initialize(),c.markCurrentRaceAsSynced())}finally{p=!1}}}));const m=document.getElementById("settings-recent-races-btn"),E=document.getElementById("settings-recent-races-dropdown");m&&E&&(m.addEventListener("click",()=>{C(),E.style.display==="none"?xi(E):E.style.display="none"}),document.addEventListener("click",y=>{const f=y.target;!m.contains(f)&&!E.contains(f)&&(E.style.display="none")}));const w=document.getElementById("device-name-input");w&&w.addEventListener("change",()=>{c.setDeviceName(w.value.trim())})}function Si(){document.querySelectorAll(".modal-overlay").forEach(l=>{l.addEventListener("click",g=>{g.target===l&&J()})}),document.querySelectorAll('[data-action="cancel"]').forEach(l=>{l.addEventListener("click",J)});const n=document.getElementById("confirm-delete-btn");n&&n.addEventListener("click",Ci);const e=document.getElementById("save-edit-btn");e&&e.addEventListener("click",Li);const t=document.getElementById("edit-bib-input");t&&t.addEventListener("input",()=>{t.value=t.value.replace(/[^0-9]/g,"").slice(0,3)});const i=document.getElementById("edit-run-selector");i&&i.addEventListener("click",l=>{const h=l.target.closest(".edit-run-btn");if(!h)return;const p=document.getElementById("edit-modal"),m=h.getAttribute("data-run")||"1";p&&p.setAttribute("data-entry-run",m),document.querySelectorAll(".edit-run-btn").forEach(E=>{E.classList.toggle("active",E===h)})});const s=document.getElementById("photo-viewer-close-btn");s&&s.addEventListener("click",ce);const r=document.getElementById("photo-viewer-close-footer-btn");r&&r.addEventListener("click",ce);const o=document.getElementById("photo-viewer-delete-btn");o&&o.addEventListener("click",Ti);const a=document.getElementById("photo-viewer-modal");a&&a.addEventListener("click",l=>{l.target===a&&ce()})}function Ii(n){const e=document.getElementById("edit-modal");if(!e)return;e.setAttribute("data-entry-id",n.id);const t=document.getElementById("edit-bib-input"),i=document.getElementById("edit-status-select");t&&(t.value=n.bib||""),i&&(i.value=n.status);const s=n.run??1;document.querySelectorAll(".edit-run-btn").forEach(r=>{const o=r.getAttribute("data-run")===String(s);r.classList.toggle("active",o)}),e.setAttribute("data-entry-run",String(s)),e.classList.add("show")}function ae(n){const e=document.getElementById("confirm-modal");if(!e)return;const t=c.getState().currentLang,i=e.querySelector(".modal-title"),s=e.querySelector(".modal-text");if(e.setAttribute("data-action",n),n==="clearAll")i&&(i.textContent=u("confirmClearAll",t)),s&&(s.textContent=u("clearAllText",t));else if(n==="deleteSelected"){const r=c.getState().selectedEntries.size;i&&(i.textContent=u("confirmDelete",t)),s&&(s.textContent=`${r} ${u("entries",t)} ${u("selected",t)}`)}else n==="undoAdd"?(i&&(i.textContent=u("confirmUndoAdd",t)),s&&(s.textContent=u("confirmUndoAddText",t))):(i&&(i.textContent=u("confirmDelete",t)),s&&(s.textContent=u("confirmDeleteText",t)));e.classList.add("show")}function wi(n){const e=document.getElementById("confirm-modal");e&&e.setAttribute("data-entry-id",n.id),ae("delete")}async function Ci(){const n=document.getElementById("confirm-modal");if(!n)return;const e=n.getAttribute("data-action"),t=n.getAttribute("data-entry-id"),i=c.getState();if(e==="clearAll"){const s=[...i.entries];if(c.clearAll(),await D.clearAll(),i.settings.sync&&i.raceId)for(const r of s)b.deleteEntryFromCloud(r.id,r.deviceId);v(u("cleared",i.currentLang),"success")}else if(e==="deleteSelected"){const s=Array.from(i.selectedEntries),r=i.entries.filter(o=>s.includes(o.id));if(c.deleteMultiple(s),await D.deletePhotos(s),i.settings.sync&&i.raceId)for(const o of r)b.deleteEntryFromCloud(o.id,o.deviceId);v(u("deleted",i.currentLang),"success")}else if(e==="undoAdd"){const s=c.undo();if(St(),v(u("undone",i.currentLang),"success"),s&&s.type==="ADD_ENTRY"&&i.settings.sync&&i.raceId){const r=s.data;b.deleteEntryFromCloud(r.id,r.deviceId)}J();return}else if(t){const s=i.entries.find(r=>r.id===t);c.deleteEntry(t),await D.deletePhoto(t),i.settings.sync&&i.raceId&&s&&b.deleteEntryFromCloud(s.id,s.deviceId),v(u("deleted",i.currentLang),"success")}Oe(),J()}function Li(){const n=document.getElementById("edit-modal");if(!n)return;const e=n.getAttribute("data-entry-id");if(!e)return;const t=document.getElementById("edit-bib-input"),i=document.getElementById("edit-status-select"),s=n.getAttribute("data-entry-run"),r=s?parseInt(s,10):1;c.updateEntry(e,{bib:(t==null?void 0:t.value.padStart(3,"0"))||"",status:i==null?void 0:i.value,run:r}),v(u("saved",c.getState().currentLang),"success"),J()}function J(){const n=document.getElementById("admin-pin-modal");if(n!=null&&n.classList.contains("show")&&I){I(!1),I=null;const e=document.getElementById("admin-pin-verify-input");e&&(e.value="")}document.querySelectorAll(".modal-overlay.show").forEach(e=>{A(e)})}let Ee=null;async function ki(n){const e=document.getElementById("photo-viewer-modal");if(!e||!n.photo)return;Ee=n.id;const t=document.getElementById("photo-viewer-image"),i=document.getElementById("photo-viewer-bib"),s=document.getElementById("photo-viewer-point"),r=document.getElementById("photo-viewer-time");if(t)if(n.photo==="indexeddb"){t.src="";const o=await D.getPhoto(n.id);if(o)t.src=`data:image/jpeg;base64,${o}`;else{console.warn("Photo not found in IndexedDB for entry:",n.id);return}}else t.src=`data:image/jpeg;base64,${n.photo}`;if(i&&(i.textContent=n.bib||"---"),s){const o=c.getState();s.textContent=Z(n.point,o.currentLang);const a=be(n.point);s.style.background=a,s.style.color="var(--background)"}if(r){const o=new Date(n.timestamp);r.textContent=Ge(o)}e.classList.add("show")}function ce(){const n=document.getElementById("photo-viewer-modal");A(n),Ee=null}async function Ti(){if(!Ee)return;const n=c.getState(),e=Ee;await D.deletePhoto(e),c.updateEntry(e,{photo:void 0}),ce(),v(u("photoDeleted",n.currentLang),"success"),Oe()}function Pi(n,e){e.includes("currentView")&&(Tt(),n.currentView==="timer"?ye.enable():ye.disable(),R&&(n.currentView==="results"?R.resume():R.pause())),e.includes("bibInput")&&Pt(),e.includes("selectedPoint")&&Rt(),e.includes("selectedRun")&&At(),e.includes("entries")&&(R&&R.setEntries(n.entries),ke(),Dt()),(e.includes("syncStatus")||e.includes("settings")||e.includes("cloudDeviceCount"))&&xt(),(e.includes("gpsStatus")||e.includes("settings"))&&Bt(),e.includes("settings")&&Nt(),e.includes("undoStack")&&Mt()}function Ri(){Tt(),Pt(),Rt(),At(),ke(),Dt(),xt(),Bt(),Nt(),Mt(),Ai(),Ve()}function Tt(){const n=c.getState();document.querySelectorAll(".view").forEach(t=>{t.classList.remove("active")});const e=document.querySelector(`.${n.currentView}-view`);e&&e.classList.add("active"),document.querySelectorAll(".tab-btn").forEach(t=>{t.classList.toggle("active",t.getAttribute("data-view")===n.currentView)})}function Pt(){const n=c.getState(),e=document.querySelector(".bib-value");e&&(e.textContent=n.bibInput?n.bibInput.padStart(3,"0"):"---");const t=document.getElementById("timestamp-btn");t&&t.classList.toggle("ready",n.bibInput.length>0)}function Rt(){const n=c.getState();document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-point")===n.selectedPoint)})}function At(){const n=c.getState();document.querySelectorAll(".run-btn").forEach(e=>{const t=e.getAttribute("data-run")===String(n.selectedRun);e.classList.toggle("active",t),e.setAttribute("aria-checked",String(t))})}function ke(){const e=c.getState().entries,t=e.length,i=new Set(e.map(l=>l.bib)).size,s=e.filter(l=>l.point==="F"&&l.status==="ok").length,r=document.getElementById("stat-total"),o=document.getElementById("stat-racers"),a=document.getElementById("stat-finished");r&&(r.textContent=String(t)),o&&(o.textContent=String(i)),a&&(a.textContent=String(s))}function Dt(){const n=document.getElementById("entry-count-badge");if(n){const e=c.getState().entries.length;n.textContent=String(e),n.style.display=e>0?"inline":"none"}}function xt(){const n=c.getState(),e=document.getElementById("sync-indicator"),t=document.querySelector(".sync-dot"),i=document.querySelector(".sync-status-text"),s=document.getElementById("sync-device-count");e&&(e.style.display=n.settings.sync?"flex":"none"),t&&(t.classList.remove("connected","error","offline","syncing"),n.syncStatus==="connected"?t.classList.add("connected"):n.syncStatus==="syncing"?t.classList.add("syncing"):n.syncStatus==="error"?t.classList.add("error"):n.syncStatus==="offline"&&t.classList.add("offline")),i&&(i.textContent=u(n.syncStatus,n.currentLang)),s&&(n.syncStatus==="connected"&&n.cloudDeviceCount>0?(s.textContent=`(${n.cloudDeviceCount})`,s.style.display="inline"):s.style.display="none")}function Bt(){const n=c.getState(),e=document.getElementById("gps-indicator"),t=document.querySelector(".gps-dot"),i=document.querySelector(".gps-status-text");e&&(e.style.display=n.settings.gps?"flex":"none"),t&&(t.classList.remove("active","searching"),n.gpsStatus==="active"?t.classList.add("active"):n.gpsStatus==="searching"&&t.classList.add("searching")),i&&(i.textContent="GPS")}function Nt(){const n=c.getState(),e=document.getElementById("timestamp-btn");e&&e.classList.toggle("photo-enabled",n.settings.photoCapture)}function Mt(){const n=document.getElementById("undo-btn");n&&n.toggleAttribute("disabled",!c.canUndo())}function Ai(){const n=c.getState(),{settings:e}=n,t=document.getElementById("simple-mode-toggle"),i=document.getElementById("gps-toggle"),s=document.getElementById("sync-toggle"),r=document.getElementById("auto-toggle"),o=document.getElementById("haptic-toggle"),a=document.getElementById("sound-toggle"),l=document.getElementById("photo-toggle");t&&(t.checked=e.simple);const g=document.getElementById("admin-section");g&&(g.style.display=e.simple?"none":"block"),i&&(i.checked=e.gps),s&&(s.checked=e.sync),r&&(r.checked=e.auto),o&&(o.checked=e.haptic),a&&(a.checked=e.sound),l&&(l.checked=e.photoCapture);const h=document.getElementById("sync-photos-toggle");h&&(h.checked=e.syncPhotos,h.disabled=!e.sync);const p=document.getElementById("race-id-input");p&&(p.value=n.raceId);const m=document.getElementById("device-name-input");m&&(m.value=n.deviceName),$t()}function $t(){const n=c.getState().currentLang,e=document.getElementById("lang-toggle");e&&e.querySelectorAll(".lang-option").forEach(t=>{t.classList.toggle("active",t.getAttribute("data-lang")===n)})}function Ve(){const n=c.getState().currentLang;document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.getAttribute("data-i18n");t&&(e.textContent=u(t,n))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const t=e.getAttribute("data-i18n-placeholder");t&&(e.placeholder=u(t,n))}),je(Me.exists,Me.entryCount)}function Ft(){const n=c.getState().settings;document.querySelectorAll("[data-advanced]").forEach(i=>{i.style.display=n.simple?"none":""});const t=document.querySelector('[data-point="S"]');t&&(t.style.display=n.simple?"none":""),n.simple&&c.setSelectedPoint("F")}function be(n){return{S:"var(--success)",F:"var(--secondary)"}[n]}function Ge(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),i=String(n.getSeconds()).padStart(2,"0"),s=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${i}.${s}`}let Me={exists:null,entryCount:0};async function Di(n){const e=++Ne,t=await b.checkRaceExists(n);e===Ne&&(c.setRaceExistsInCloud(t.exists),je(t.exists,t.entryCount))}async function xi(n){const e=c.getState().currentLang;n.innerHTML=`<div class="recent-races-empty">${u("loading",e)}</div>`,n.style.display="block";let t=[];if($())try{t=await Bi()}catch(i){console.warn("Failed to fetch races from API:",i),t=pe()}else t=pe();t.length===0?n.innerHTML=`<div class="recent-races-empty">${u("noRecentRaces",e)}</div>`:(n.innerHTML=t.map(i=>Ni(i)).join(""),n.querySelectorAll(".recent-race-item").forEach((i,s)=>{i.addEventListener("click",()=>{const r=t[s];Mi(r,n)})}))}async function Bi(){const n=localStorage.getItem(kt);if(!n)return[];const e=await N("/api/admin/races",{headers:{Authorization:`Bearer ${n}`}},5e3);if(!e.ok)throw new Error(`API error: ${e.status}`);const i=(await e.json()).races||[],s=new Date;s.setHours(0,0,0,0);const r=s.getTime(),o=i.filter(a=>a.lastUpdated&&a.lastUpdated>=r).map(a=>({raceId:a.raceId,createdAt:a.lastUpdated||Date.now(),lastUpdated:a.lastUpdated||Date.now(),entryCount:a.entryCount})).slice(0,5);return o.forEach(a=>{ze(a.raceId,a.lastUpdated,a.entryCount)}),o}function Ni(n){const e=n.entryCount!==void 0?`${n.entryCount} entries`:"";return`
    <div class="recent-race-item" data-race-id="${n.raceId}">
      <span class="recent-race-id">${n.raceId}</span>
      <span class="recent-race-meta">${e}</span>
    </div>
  `}function Mi(n,e){const t=document.getElementById("race-id-input");t&&(t.value=n.raceId,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),C()),e.style.display="none"}function je(n,e){Me={exists:n,entryCount:e};const t=document.getElementById("race-exists-indicator"),i=document.getElementById("race-exists-text"),s=c.getState().currentLang;if(!(!t||!i)){if(n===null){t.style.display="none";return}t.style.display="inline-flex",t.classList.remove("found","new"),n?(t.classList.add("found"),i.textContent=e>0?`${e} ${u("entriesInCloud",s)}`:u("raceFound",s)):(t.classList.add("new"),i.textContent=u("raceNew",s))}}const $i="1111";let le=null;async function Fi(){if($()){console.log("Auth token already exists");return}const n=await Le($i);n.success?n.isNewPin?console.log("Default admin PIN initialized"):console.log("Authenticated with default PIN"):console.log("Custom PIN is set, manual authentication required")}function Hi(n){return/^\d{4}$/.test(n)}function zi(n){n.addEventListener("input",()=>{n.value=n.value.replace(/[^0-9]/g,"")})}function Se(){const n=c.getState().currentLang,e=$(),t=document.getElementById("admin-pin-status"),i=document.getElementById("change-pin-btn-text");t&&(t.textContent=u(e?"pinSet":"pinNotSet",n)),i&&(i.textContent=u(e?"changePin":"setPin",n))}function Ui(){Fi().then(()=>{Se()}),Se();const n=document.getElementById("change-pin-btn");n&&n.addEventListener("click",Oi);const e=document.getElementById("save-pin-btn");e&&e.addEventListener("click",_i),["admin-pin-verify-input","current-pin-input","new-pin-input","confirm-pin-input"].forEach(h=>{const p=document.getElementById(h);p&&zi(p)});const i=document.getElementById("manage-races-btn");i&&i.addEventListener("click",Wi);const s=document.getElementById("admin-pin-verify-btn");s&&s.addEventListener("click",()=>{I?mt():gt()});const r=document.getElementById("admin-pin-verify-input");r&&r.addEventListener("keydown",h=>{h.key==="Enter"&&(I?mt():gt())});const o=document.getElementById("admin-pin-modal");o&&o.addEventListener("click",h=>{h.target===o&&I&&Yi()});const a=document.getElementById("race-deleted-ok-btn");a&&a.addEventListener("click",()=>{const h=document.getElementById("race-deleted-modal");A(h)});const l=document.getElementById("refresh-races-btn");l&&l.addEventListener("click",Qe);const g=document.getElementById("confirm-delete-race-btn");g&&g.addEventListener("click",Xi),ji()}function Oi(){const n=c.getState().currentLang,e=$(),t=document.getElementById("change-pin-modal"),i=document.getElementById("change-pin-modal-title"),s=document.getElementById("current-pin-row"),r=document.getElementById("current-pin-input"),o=document.getElementById("new-pin-input"),a=document.getElementById("confirm-pin-input");t&&(r&&(r.value=""),o&&(o.value=""),a&&(a.value=""),Ht(),e?(s&&(s.style.display="block"),i&&(i.textContent=u("changePin",n))):(s&&(s.style.display="none"),i&&(i.textContent=u("setPin",n))),t.classList.add("show"),e&&r?r.focus():o&&o.focus())}function Ht(){["current-pin-error","pin-mismatch-error","pin-format-error"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="none")})}async function _i(){const n=c.getState().currentLang,e=$(),t=document.getElementById("current-pin-input"),i=document.getElementById("new-pin-input"),s=document.getElementById("confirm-pin-input"),r=document.getElementById("current-pin-error"),o=document.getElementById("pin-mismatch-error"),a=document.getElementById("pin-format-error");if(Ht(),e){const p=(t==null?void 0:t.value)||"";if(!(await Ue(p)).success){r&&(r.style.display="block"),t&&(t.value="",t.focus()),L();return}}const l=(i==null?void 0:i.value)||"",g=(s==null?void 0:s.value)||"";if(!Hi(l)){a&&(a.style.display="block"),i&&i.focus(),L();return}if(l!==g){o&&(o.style.display="block"),s&&(s.value="",s.focus()),L();return}const h=await qi(l);try{const p=await fetch("/api/admin/pin",{method:"POST",headers:{..._e(),"Content-Type":"application/json"},body:JSON.stringify({pinHash:h})});if(!p.ok)throw new Error(`HTTP ${p.status}`);if(Et(),!(await Le(l)).success){v(u("pinSyncFailed",n),"error"),L();return}const E=document.getElementById("change-pin-modal");A(E),v(u("pinSaved",n),"success"),ee(),Se()}catch(p){Be("Admin","handleSavePin",p,"pinSyncFailed"),v(u("pinSyncFailed",n),"error"),L()}}async function qi(n){const t=new TextEncoder().encode(n),i=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(i)).map(r=>r.toString(16).padStart(2,"0")).join("")}function zt(n){const{raceId:e,message:t}=n.detail,i=c.getState().currentLang,s=document.getElementById("race-deleted-text");s&&(s.textContent=`${u("raceDeletedFor",i)} "${e}". ${t||u("raceDeletedText",i)}`);const r=document.getElementById("race-deleted-modal");r&&r.classList.add("show"),c.updateSettings({sync:!1}),c.setRaceId("");const o=document.getElementById("sync-toggle");o&&(o.checked=!1);const a=document.getElementById("race-id-input");a&&(a.value=""),L()}function Ut(n){const{message:e}=n.detail,t=c.getState().currentLang;v(e||"Session expired. Please re-enter your PIN.","warning",5e3),$e(t).then(i=>{if(i){const s=c.getState();s.settings.sync&&s.raceId&&b.initialize(),v("Authentication successful","success")}}),L()}function Vi(n){if(n===0)return"0 B";const e=1024,t=["B","KB","MB","GB"],i=Math.floor(Math.log(n)/Math.log(e));return parseFloat((n/Math.pow(e,i)).toFixed(1))+" "+t[i]}async function Gi(){const n=document.getElementById("photo-sync-modal");if(!n)return;const e=c.getState().currentLang,t=document.getElementById("photos-upload-count"),i=document.getElementById("photos-download-count"),s=document.getElementById("photos-total-size");t&&(t.textContent=u("loading",e)),i&&(i.textContent=u("loading",e)),s&&(s.textContent=u("loading",e)),n.classList.add("show");const r=await b.getPhotoSyncStats();t&&(t.textContent=String(r.uploadCount)),i&&(i.textContent=String(r.downloadCount)),s&&(s.textContent=Vi(r.totalSize));const o=document.getElementById("photo-sync-confirm-btn");if(o){const a=r.uploadCount>0||r.downloadCount>0;o.textContent=u("enableSync",e)}}function ji(){const n=document.getElementById("photo-sync-modal"),e=document.getElementById("photo-sync-cancel-btn"),t=document.getElementById("photo-sync-confirm-btn");e&&e.addEventListener("click",()=>{n&&n.classList.remove("show")}),t&&t.addEventListener("click",()=>{c.updateSettings({syncPhotos:!0});const i=document.getElementById("sync-photos-toggle");i&&(i.checked=!0),n&&n.classList.remove("show");const s=c.getState();s.settings.sync&&s.raceId&&b.forceRefresh(),ee()}),n&&n.addEventListener("click",i=>{i.target===n&&n.classList.remove("show")})}function Ot(n){const{isQuotaError:e,entryCount:t}=n.detail,i=c.getState().currentLang;e?v(u("storageQuotaError",i),"error",Y.CRITICAL):v(u("storageError",i),"error",Y.ERROR),L(),console.error("[Storage] saveEntries:",n.detail.message,{entryCount:t,isQuotaError:e})}function _t(n){const{percent:e}=n.detail,t=c.getState().currentLang;sessionStorage.getItem("storage-warning-shown")||(v(`${u("storageWarning",t)} (${e}%)`,"warning",Y.WARNING),sessionStorage.setItem("storage-warning-shown","true"))}function Qi(){if(M){try{M.destroy()}catch(n){console.warn("Clock cleanup error:",n)}M=null}b.cleanup(),O.stop(),K.stop(),ye.disable(),Gn(),si(),document.querySelectorAll(".ripple").forEach(n=>n.remove()),window.removeEventListener("race-deleted",zt),window.removeEventListener("auth-expired",Ut),window.removeEventListener("storage-error",Ot),window.removeEventListener("storage-warning",_t),B&&(clearTimeout(B),B=null),q&&(clearTimeout(q),q=null),Q=null,I&&(I(!1),I=null),Ne=0}function Wi(){const n=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input"),t=document.getElementById("admin-pin-error"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),r=c.getState().currentLang;n&&e&&t&&(e.value="",t.style.display="none",i&&(i.textContent=u("enterAdminPin",r)),s&&(s.textContent=u("enterPinText",r)),n.classList.add("show"),e.focus())}async function gt(){const n=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),t=document.getElementById("admin-pin-modal");if(!n||!t)return;const i=n.value.trim();(await Le(i)).success?(A(t),n.value="",e&&(e.style.display="none"),Ji()):(e&&(e.style.display="block"),n.value="",n.focus(),L())}function $e(n){return new Promise(e=>{if($()){e(!0);return}const t=document.getElementById("admin-pin-modal"),i=document.getElementById("admin-pin-modal-title"),s=document.getElementById("admin-pin-modal-text"),r=document.getElementById("admin-pin-verify-input"),o=document.getElementById("admin-pin-error");if(!t||!r){e(!1);return}i&&(i.textContent=u("enterAdminPin",n)),s&&(s.textContent=u("enterPinToJoinRace",n)),o&&(o.style.display="none"),r.value="",I=e,t.classList.add("show"),setTimeout(()=>r.focus(),100)})}async function mt(){const n=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),t=document.getElementById("admin-pin-modal");if(!n||!t||!I)return;const i=n.value.trim();(await Le(i)).success?(A(t),n.value="",e&&(e.style.display="none"),I(!0),I=null):(e&&(e.style.display="block"),n.value="",n.focus(),L())}function Yi(){const n=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input");A(n),e&&(e.value=""),I&&(I(!1),I=null)}function Ji(){const n=document.getElementById("race-management-modal");n&&(n.classList.add("show"),Qe())}async function Qe(){const n=document.getElementById("race-list"),e=document.getElementById("race-list-loading"),t=document.getElementById("race-list-empty"),i=c.getState().currentLang;if(n){e&&(e.style.display="block"),t&&(t.style.display="none"),n.querySelectorAll(".race-item").forEach(s=>s.remove());try{const s=await N(Lt,{headers:_e()},1e4);if(!s.ok){if(s.status===401){const a=document.getElementById("race-management-modal");A(a),v(u("authError",i),"error"),console.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${s.status}`)}const o=(await s.json()).races||[];if(e&&(e.style.display="none"),o.length===0){t&&(t.style.display="block");return}o.forEach(a=>{const l=Zi(a,i);n.appendChild(l)})}catch(s){Ie("Admin","loadRaceList",s,"loadError"),e&&(e.style.display="none")}}}function Zi(n,e){const t=document.createElement("div");t.className="race-item",t.setAttribute("data-race-id",n.raceId);const i=document.createElement("div");i.className="race-info";const s=document.createElement("span");s.className="race-id",s.textContent=n.raceId.toUpperCase();const r=document.createElement("span");r.className="race-meta";const o=n.entryCount===1?u("entry",e):u("entries",e),a=n.deviceCount===1?u("device",e):u("devices",e);r.textContent=`${n.entryCount} ${o}, ${n.deviceCount} ${a}`,i.appendChild(s),i.appendChild(r);const l=document.createElement("button");return l.className="race-delete-btn danger",l.textContent=u("delete",e),l.addEventListener("click",()=>Ki(n.raceId)),t.appendChild(i),t.appendChild(l),t}function Ki(n){const e=c.getState().currentLang;le=n;const t=document.getElementById("delete-race-confirm-modal"),i=document.getElementById("delete-race-confirm-text");i&&(i.textContent=`${u("confirmDeleteRaceText",e)} "${n.toUpperCase()}"?`),t&&t.classList.add("show")}async function Xi(){if(!le)return;const n=le,e=c.getState().currentLang,t=document.getElementById("delete-race-confirm-modal");A(t);try{const i=await N(`${Lt}?raceId=${encodeURIComponent(n)}`,{method:"DELETE",headers:_e()},1e4);if(!i.ok){if(i.status===401){const r=document.getElementById("race-management-modal");A(r),v(u("authError",e),"error"),console.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${i.status}`)}const s=await i.json();if(s.success)v(`${u("raceDeletedSuccess",e)} ${n.toUpperCase()}`,"success"),Oe(),Qe();else throw new Error(s.error||u("unknownError",e))}catch(i){Ie("Admin","deleteRace",i,"deleteError")}finally{le=null}}let xe=!1,W=[];const es=3,ts=1e4;function ns(){window.addEventListener("error",is),window.addEventListener("unhandledrejection",ss),window.addEventListener("critical-error",rs),console.log("[ErrorBoundary] Global error handlers initialized")}function is(n){const{message:e,filename:t,lineno:i,colno:s,error:r}=n;Ie("Global","uncaught error",r||e,void 0),qt(e),Vt()&&We(e),n.preventDefault()}function ss(n){const e=n.reason,t=e instanceof Error?e.message:String(e);Ie("Global","unhandled rejection",e,void 0),qt(t),Vt()&&We(t),n.preventDefault()}function rs(n){var i;const e=n.detail,t=((i=e==null?void 0:e.error)==null?void 0:i.message)||"Critical error occurred";dn("Global","critical error event",e==null?void 0:e.error,void 0),We(t)}function qt(n){const e=Date.now();W.push({message:n,timestamp:e}),W=W.filter(t=>e-t.timestamp<ts)}function Vt(){return W.length>=es}function We(n){var s,r;if(xe)return;xe=!0;const e=c.getState().currentLang,t=document.createElement("div");t.id="error-boundary-overlay",t.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 24px;
  `;const i=document.createElement("div");i.style.cssText=`
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    text-align: center;
    color: #fff;
  `,i.innerHTML=`
    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
    <h2 style="margin: 0 0 8px; font-size: 1.25rem;">${u("errorOccurred",e)}</h2>
    <p style="color: #999; font-size: 0.875rem; margin: 0 0 16px;">
      ${u("errorRecoveryMessage",e)}
    </p>
    <p style="color: #666; font-size: 0.75rem; font-family: monospace; margin: 0 0 24px; word-break: break-word;">
      ${os(n.substring(0,200))}
    </p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="error-dismiss-btn" style="
        padding: 12px 24px;
        border: 1px solid #444;
        border-radius: 8px;
        background: transparent;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${u("dismiss",e)}</button>
      <button id="error-reload-btn" style="
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #3B82F6;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${u("reload",e)}</button>
    </div>
  `,t.appendChild(i),document.body.appendChild(t),(s=document.getElementById("error-dismiss-btn"))==null||s.addEventListener("click",()=>{t.remove(),xe=!1,W=[]}),(r=document.getElementById("error-reload-btn"))==null||r.addEventListener("click",()=>{window.location.reload()})}function os(n){const e=document.createElement("div");return e.textContent=n,e.innerHTML}ns();It();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",dt):dt();"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const n=await navigator.serviceWorker.register("/sw.js");console.log("Service Worker registered:",n.scope),n.addEventListener("updatefound",()=>{const e=n.installing;e&&e.addEventListener("statechange",()=>{e.state==="installed"&&navigator.serviceWorker.controller&&console.log("New version available")})})}catch(n){console.error("Service Worker registration failed:",n)}});document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&console.log("App resumed")});window.addEventListener("online",()=>{console.log("App is online")});window.addEventListener("offline",()=>{console.log("App is offline")});window.addEventListener("beforeunload",()=>{});console.log("Ski Race Timer v3.4.0");
