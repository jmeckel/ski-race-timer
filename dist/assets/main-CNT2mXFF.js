const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/gate-judge-g1xWkyV9.js","assets/chief-judge-uEHOwmjD.js","assets/vendor-signals-BA-R9xnX.js"])))=>i.map(i=>d[i]);
var ut=Object.defineProperty;var gt=(t,e,n)=>e in t?ut(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var x=(t,e,n)=>gt(t,typeof e!="symbol"?e+"":e,n);import{s as se,o as H,g as z,d as De,c as Z,i as ft,e as mt,f as pt,h as F,j,k as qe,l as Me,r as yt,m as ht,a as bt,b as vt,n as St,p as Et,u as wt,q as It,_ as he}from"./gate-judge-g1xWkyV9.js";import{s as r,T as N,q as R,L as T,n as Lt,a as h,t as c,m as Ct,X as be,ak as kt,U as xt,al as At,d as f,p,ad as Rt,O as k,ae as Bt,u as v,a0 as ve,h as de,f as Pe,af as P,E as Ne,D as Oe,z as Ve,y as Fe,l as Je,a7 as M,am as Q,an as ee,o as J,ao as Tt,ap as te,aq as Se,ar as $t,Y as Ue,as as Ee,ag as Dt,at as qt,au as Mt,av as Pt,aw as $,$ as Nt,ax as He,ay as Ot,az as Vt,Q as Ft,ah as Jt,ai as Ut,aj as Ht,aA as zt,aB as we,aC as _t,aD as Ie,aE as Gt,aF as Wt,aG as jt,aH as Kt,aI as Yt,aJ as Xt,a6 as Le,a2 as Zt,a9 as Qt,aK as en,e as G,r as tn,a1 as nn,a3 as ze,aL as an,aM as sn,aN as on,w as Ce}from"./chief-judge-uEHOwmjD.js";import{c as oe,d as rn,u as _e,a as Ge,b as cn,g as ln,i as dn}from"./results-CQzU4rla.js";import{h as un,c as We,u as gn,a as je,b as Ke,d as Ye,e as fn,s as mn,r as ke,f as pn,g as xe,i as Xe,v as yn,j as hn,k as bn,l as vn,m as Sn,n as Ae,o as En,p as wn}from"./settings-B4htyoIj.js";import{c as In,i as Ln,a as ne,u as Ze,d as Cn,b as kn}from"./timer-B_wLl45f.js";import{m as y,o as Re}from"./vendor-signals-BA-R9xnX.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function n(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(a){if(a.ep)return;a.ep=!0;const i=n(a);fetch(a.href,i)}})();async function Be(t){const e=r.getState(),n=t.map(s=>s.id);if(n.length===1?r.deleteEntry(n[0]):r.deleteMultiple(n),n.length===1?await N.deletePhoto(n[0]):await N.deletePhotos(n),e.settings.sync&&e.raceId)for(const s of t)R.deleteEntryFromCloud(s.id,s.deviceId)}function xn(t,e){t&&(se(t,e),H(t))}function An(t,e,n,s){t&&t.querySelectorAll(e).forEach(a=>{const i=a.getAttribute(n)===s;a.classList.toggle("active",i)})}const C=new T;function Rn(){document.querySelectorAll(".modal-overlay").forEach(u=>{C.add(u,"click",m=>{m.target===u&&_()})}),document.querySelectorAll('[data-action="cancel"]').forEach(u=>{C.add(u,"click",_)});const t=document.getElementById("confirm-delete-btn");t&&C.add(t,"click",$n);const e=document.getElementById("confirm-fault-delete-btn");e&&C.add(e,"click",()=>{var b;const u=document.getElementById("fault-delete-modal"),m=u?(b=z(u))==null?void 0:b.faultId:void 0;if(m){r.markFaultForDeletion(m);const E=r.getState().faultEntries.find(g=>g.id===m);E&&Lt(E),De(),h(c("faultDeleted",r.getState().currentLang),"success")}Z(u)});const n=document.getElementById("save-edit-btn");n&&C.add(n,"click",Dn);const s=document.getElementById("edit-bib-input");s&&Ct(s,3);const a=document.getElementById("edit-run-selector");a&&C.add(a,"click",u=>{const b=u.target.closest(".edit-run-btn");if(!b)return;const E=document.getElementById("edit-modal"),g=b.getAttribute("data-run")||"1";if(E){const S=z(E)||{entryId:"",entryRun:1};se(E,{...S,entryRun:parseInt(g,10)})}document.querySelectorAll(".edit-run-btn").forEach(S=>{S.classList.toggle("active",S===b)})});const i=document.getElementById("photo-viewer-close-btn");i&&C.add(i,"click",oe);const o=document.getElementById("photo-viewer-close-footer-btn");o&&C.add(o,"click",oe);const l=document.getElementById("photo-viewer-delete-btn");l&&C.add(l,"click",rn);const d=document.getElementById("photo-viewer-modal");d&&C.add(d,"click",u=>{u.target===d&&oe()}),ft()}function Bn(t){const e=document.getElementById("edit-modal");if(!e)return;const n=t.run??1,s=document.getElementById("edit-bib-input"),a=document.getElementById("edit-status-select");s&&(s.value=t.bib||""),a&&(a.value=t.status),An(document.body,".edit-run-btn","data-run",String(n)),xn(e,{entryId:t.id,entryRun:n})}function Qe(t){const e=document.getElementById("confirm-modal");if(!e)return;const n=r.getState().currentLang,s=e.querySelector(".modal-title"),a=e.querySelector(".modal-text"),i=z(e)||{};if(se(e,{...i,action:t}),t==="clearAll")s&&(s.textContent=c("confirmClearAll",n)),a&&(a.textContent=c("clearAllText",n));else if(t==="deleteSelected"){const o=r.getState().selectedEntries.size,l=o===1?c("entry",n):c("entries",n);s&&(s.textContent=c("confirmDelete",n)),a&&(a.textContent=`${o} ${l} ${c("selected",n)}`)}else t==="undoAdd"?(s&&(s.textContent=c("confirmUndoAdd",n)),a&&(a.textContent=c("confirmUndoAddText",n))):(s&&(s.textContent=c("confirmDelete",n)),a&&(a.textContent=c("confirmDeleteText",n)));H(e)}function Tn(t){const e=document.getElementById("confirm-modal");e&&se(e,{action:"delete",entryId:t.id}),Qe("delete")}async function $n(){const t=document.getElementById("confirm-modal");if(!t)return;const e=z(t),n=e==null?void 0:e.action,s=e==null?void 0:e.entryId,a=r.getState();if(n==="clearAll"){const i=[...a.entries];if(r.clearAll(),await N.clearAll(),a.settings.sync&&a.raceId)for(const o of i)R.deleteEntryFromCloud(o.id,o.deviceId);h(c("cleared",a.currentLang),"success")}else if(n==="deleteSelected"){const i=Array.from(a.selectedEntries),o=a.entries.filter(l=>i.includes(l.id));await Be(o),h(c("deleted",a.currentLang),"success")}else if(n==="undoAdd"){const i=r.undo();if(be(),h(c("undone",a.currentLang),"success"),i&&i.type==="ADD_ENTRY"){const o=i.data;await N.deletePhoto(o.id),a.settings.sync&&a.raceId&&R.deleteEntryFromCloud(o.id,o.deviceId)}_();return}else if(s){const i=a.entries.find(d=>d.id===s);i&&await Be([i]);const o=a.currentLang;kt();const l={label:c("undoAction",o),callback:()=>{if(r.canUndo()){const d=r.undo();if(be(),d&&d.type==="DELETE_ENTRY"){const u=d.data;At(u).catch(()=>{})}}}};h(c("entryDeleted",o),"success",5e3,{action:l})}xt(),_()}function Dn(){const t=document.getElementById("edit-modal");if(!t)return;const e=z(t),n=e==null?void 0:e.entryId;if(!n)return;const s=document.getElementById("edit-bib-input"),a=document.getElementById("edit-status-select"),i=(e==null?void 0:e.entryRun)??1;r.updateEntry(n,{bib:(s==null?void 0:s.value.padStart(3,"0"))||"",status:a==null?void 0:a.value,run:i}),h(c("saved",r.getState().currentLang),"success"),_()}function _(){const t=document.getElementById("admin-pin-modal");if(t!=null&&t.classList.contains("show")&&un()){We();const e=document.getElementById("admin-pin-verify-input");e&&(e.value="")}document.querySelectorAll(".modal-overlay").forEach(e=>{mt(e)}),pt()}const B=new T;let A=null;const O=new Set;function qn(t){return t?/^0+$/.test(t):!1}function Mn(){A&&(A.destroy(),A=null);const t=p("clock-container");t&&(A=new Rt(t),A.start())}function Pn(){A&&(A.destroy(),A=null)}function Nn(){const t=document.querySelectorAll(".tab-btn"),e=()=>Array.from(t).filter(n=>n.style.display!=="none");t.forEach(n=>{B.add(n,"click",()=>{const s=n.getAttribute("data-view");s&&(r.setView(s),f(),t.forEach(a=>{a.setAttribute("aria-selected",a===n?"true":"false")}))}),B.add(n,"keydown",s=>{const a=s,i=e(),o=i.indexOf(n);let l=o;switch(a.key){case"ArrowLeft":case"ArrowUp":a.preventDefault(),l=o>0?o-1:i.length-1;break;case"ArrowRight":case"ArrowDown":a.preventDefault(),l=o<i.length-1?o+1:0;break;case"Home":a.preventDefault(),l=0;break;case"End":a.preventDefault(),l=i.length-1;break;default:return}if(l!==o){const d=i[l];d.focus(),d.click()}})})}function On(){const t=p("number-pad"),e=p("bib-display");e&&t&&(e.setAttribute("aria-expanded","true"),B.add(e,"click",()=>{const n=t.classList.toggle("collapsed");e.classList.toggle("expanded",!n),e.setAttribute("aria-expanded",String(!n)),f()})),t&&B.add(t,"click",n=>{const a=n.target.closest(".num-btn");if(!a)return;const i=a.getAttribute("data-num"),o=a.getAttribute("data-action");if(i){const l=r.getState();l.bibInput.length<3&&(r.setBibInput(l.bibInput+i),f())}else if(o==="clear")r.setBibInput(""),f();else if(o==="delete"){const l=r.getState();r.setBibInput(l.bibInput.slice(0,-1)),f()}})}function Vn(){const t=p("timing-points");t&&B.add(t,"click",e=>{const s=e.target.closest(".timing-point-btn");if(!s)return;const a=s.getAttribute("data-point");a&&(r.setSelectedPoint(a),f(),t.querySelectorAll(".timing-point-btn").forEach(i=>{i.setAttribute("aria-checked",i===s?"true":"false")}))})}function Fn(){const t=p("run-selector");t&&B.add(t,"click",e=>{const s=e.target.closest(".run-btn");if(!s)return;const a=s.getAttribute("data-run"),i=a?parseInt(a,10):1;r.setSelectedRun(i),f(),t.querySelectorAll(".run-btn").forEach(o=>{o.setAttribute("aria-checked",o===s?"true":"false")})})}function Jn(){const t=p("timestamp-btn");t&&(B.add(t,"click",async()=>{if(k.wasRecentlyExited()){f();return}await Te()}),B.add(document,"keydown",(e=>{var a;const n=(a=document.activeElement)==null?void 0:a.tagName,s=r.getState();if(!(n==="INPUT"||n==="TEXTAREA"||n==="SELECT")&&s.currentView==="timer"){if(/^[0-9]$/.test(e.key)){e.preventDefault(),s.bibInput.length<3&&(r.setBibInput(s.bibInput+e.key),f());return}if(e.key==="Backspace"){e.preventDefault(),r.setBibInput(s.bibInput.slice(0,-1)),f();return}if(e.key==="Delete"||e.key==="Escape"){e.preventDefault(),r.setBibInput(""),f();return}if(e.key==="s"||e.key==="S"){e.preventDefault(),r.setSelectedPoint("S"),f(),document.querySelectorAll(".timing-point-btn").forEach(i=>{i.setAttribute("aria-checked",i.getAttribute("data-point")==="S"?"true":"false")});return}if(e.key==="f"||e.key==="F"){e.preventDefault(),r.setSelectedPoint("F"),f(),document.querySelectorAll(".timing-point-btn").forEach(i=>{i.setAttribute("aria-checked",i.getAttribute("data-point")==="F"?"true":"false")});return}if(e.key==="1"&&e.altKey){e.preventDefault(),r.setSelectedRun(1),f();return}if(e.key==="2"&&e.altKey){e.preventDefault(),r.setSelectedRun(2),f();return}if(e.key===" "||e.key==="Enter"){if(e.preventDefault(),k.wasRecentlyExited()){f();return}Te();return}}})))}async function Te(){const t=r.getState();if(t.isRecording)return;const{entry:e}=In({bib:t.bibInput,point:t.selectedPoint,run:t.selectedRun,deviceId:t.deviceId,deviceName:t.deviceName,gpsService:P});r.setRecording(!0);try{if(t.settings.photoCapture){const a=e.id;Bt().then(async i=>{if(i)try{if(!r.getState().entries.some(u=>u.id===a)){v.warn("Entry was deleted before photo could be attached:",a);return}if(await N.savePhoto(a,i))r.updateEntry(a,{photo:"indexeddb"})||(v.warn("Entry deleted during photo save, removing orphaned photo:",a),await N.deletePhoto(a));else{v.warn("Photo save failed for entry:",a);const u=r.getState().currentLang;h(c("photoSaveFailed",u),"warning")}}catch(o){ve("Camera","photo save/update",o,"photoError")}}).catch(i=>{if(i instanceof Error&&i.name==="PhotoTooLargeError"){const o=r.getState().currentLang;h(c("photoTooLarge",o),"warning")}else ve("Camera","captureTimingPhoto",i,"photoError")})}const n=Ln(e,t.entries),s=qn(e.bib);if(r.addEntry(e),n?(de(),Hn(e)):s?(de(),zn(e)):(Pe(),ge(e)),R.broadcastEntry(e),t.settings.auto&&t.bibInput){const a=parseInt(t.bibInput,10)+1,i=t.settings.sync&&t.cloudHighestBib>0?Math.max(a,t.cloudHighestBib+1):a;r.setBibInput(String(i))}else t.bibInput?t.settings.auto||r.setBibInput(""):r.setBibInput("");_n(e)}finally{r.setRecording(!1)}}function ge(t){const e=p("confirmation-overlay");if(!e)return;const n=e.querySelector(".confirmation-bib"),s=e.querySelector(".confirmation-point"),a=e.querySelector(".confirmation-run"),i=e.querySelector(".confirmation-time"),o=r.getState();if(n&&(n.textContent=t.bib||"---"),s&&(s.textContent=Ne(t.point,o.currentLang),s.style.color=Oe(t.point)),a&&t.run&&(a.textContent=Ve(t.run,o.currentLang),a.style.color=Fe(t.run)),i){const d=new Date(t.timestamp);i.textContent=Je(d)}e.dataset.point=t.point,e.classList.add("show"),Un(t.point);const l=window.setTimeout(()=>{e.classList.remove("show"),O.delete(l)},1500);O.add(l)}function Un(t){const e=document.getElementById("snowflake-burst");if(!e)return;e.innerHTML="";const n=t==="S"?"var(--start-color)":"var(--finish-color)",s=8;for(let a=0;a<s;a++){const i=document.createElement("span");i.className="flake",i.textContent="❄";const o=a/s*2*Math.PI,l=60+Math.random()*40,d=Math.cos(o)*l,u=Math.sin(o)*l,m=Math.random()*360;i.style.cssText=`
      --burst-x: ${d}px;
      --burst-y: ${u}px;
      --burst-rot: ${m}deg;
      color: ${n};
      font-size: ${.6+Math.random()*.6}rem;
      animation-duration: ${.6+Math.random()*.4}s;
      text-shadow: 0 0 6px ${n};
    `,i.addEventListener("animationend",()=>i.remove(),{once:!0}),e.appendChild(i)}}function Hn(t){const e=p("confirmation-overlay");if(!e)return;const n=e.querySelector(".confirmation-duplicate");n&&(n.style.display="flex"),ge(t);const s=window.setTimeout(()=>{n&&(n.style.display="none"),O.delete(s)},2500);O.add(s)}function zn(t){const e=p("confirmation-overlay");if(!e)return;const n=e.querySelector(".confirmation-zero-bib");n&&(n.style.display="flex"),ge(t);const s=window.setTimeout(()=>{n&&(n.style.display="none"),O.delete(s)},2500);O.add(s)}function _n(t){const e=p("last-recorded-inline");if(!e)return;const n=e.querySelector(".bib"),s=e.querySelector(".point"),a=e.querySelector(".run"),i=e.querySelector(".time"),o=r.getState();if(n&&(n.textContent=t.bib||"---"),s&&(s.textContent=Ne(t.point,o.currentLang),s.style.color=Oe(t.point)),a&&t.run&&(a.textContent=Ve(t.run,o.currentLang),a.style.color=Fe(t.run)),i){const l=new Date(t.timestamp);i.textContent=Je(l)}e.classList.add("visible"),e.classList.remove("pulse"),e.offsetWidth,e.classList.add("pulse")}function fe(){const t=r.getState(),e=p("bib-display"),n=e==null?void 0:e.querySelector(".bib-value");n&&(n.textContent=t.bibInput?t.bibInput.padStart(3,"0"):"---");const s=p("timestamp-btn");s&&s.classList.toggle("ready",t.bibInput.length>0)}function me(){const t=r.getState();document.querySelectorAll(".timing-point-btn").forEach(e=>{const n=e.getAttribute("data-point")===t.selectedPoint;e.classList.toggle("active",n),e.setAttribute("aria-checked",String(n))})}function pe(){const t=r.getState();document.querySelectorAll(".run-btn").forEach(e=>{const n=e.getAttribute("data-run")===String(t.selectedRun);e.classList.toggle("active",n),e.setAttribute("aria-checked",String(n))})}function Gn(t){var e,n,s;switch(v.debug("[TimerView] Voice intent:",t.action,t.params),t.action){case"set_bib":(e=t.params)!=null&&e.bib&&(r.setBibInput(t.params.bib),fe(),f());break;case"set_point":(n=t.params)!=null&&n.point&&(r.setSelectedPoint(t.params.point),me(),f());break;case"set_run":(s=t.params)!=null&&s.run&&(r.setSelectedRun(t.params.run),pe(),f());break;default:v.debug("[TimerView] Unhandled voice intent:",t.action)}}function Wn(){et(),ne()?Ze():(fe(),me()),pe(),_e(),Ge(),K(),Y(),F(),tt(),nt(),gn(),je()}function jn(t){return t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}function et(){const t=r.getState();document.querySelectorAll(".view").forEach(s=>{s.classList.remove("active")});const e=jn(t.currentView),n=document.querySelector(`.${e}-view`);n&&n.classList.add("active"),document.querySelectorAll(".tab-btn").forEach(s=>{s.classList.toggle("active",s.getAttribute("data-view")===t.currentView)}),t.currentView==="gateJudge"&&(j(),qe(),Me(),yt())}function K(){var o,l;const t=r.getState(),e=p("sync-indicator"),n=(o=p("sync-indicator"))==null?void 0:o.querySelector(".sync-dot"),s=(l=p("sync-indicator"))==null?void 0:l.querySelector(".sync-status-text"),a=p("sync-device-count");e&&(e.style.display=t.settings.sync?"flex":"none");const i=t.currentLang;if(n){n.classList.remove("connected","error","offline","syncing"),e&&e.classList.remove("connected","error","offline","syncing"),t.syncStatus==="connected"?(n.classList.add("connected"),e==null||e.classList.add("connected")):t.syncStatus==="syncing"?(n.classList.add("syncing"),e==null||e.classList.add("syncing")):t.syncStatus==="error"?(n.classList.add("error"),e==null||e.classList.add("error")):t.syncStatus==="offline"&&(n.classList.add("offline"),e==null||e.classList.add("offline"));const d=t.syncStatus==="connected"?c("syncOnline",i):t.syncStatus==="error"?c("syncError",i):t.syncStatus==="offline"?c("syncOffline",i):c("syncing",i);n.setAttribute("aria-label",d)}if(s){const d={connected:c("syncShortConnected",i),syncing:c("syncShortSyncing",i),error:c("syncShortError",i),offline:c("syncShortOff",i),disconnected:c("syncShortOff",i),connecting:c("syncShortSyncing",i)};s.textContent=d[t.syncStatus]||c(t.syncStatus,i)}if(e){const d=t.syncStatus==="connected"?`${c("syncOnline",i)}${t.cloudDeviceCount>0?` - ${t.cloudDeviceCount} ${c("devices",i)}`:""}`:t.syncStatus==="error"?c("syncError",i):t.syncStatus==="offline"?c("syncOffline",i):c("syncing",i);e.setAttribute("aria-label",d)}a&&(t.syncStatus==="connected"&&t.cloudDeviceCount>0?(a.textContent=`${t.cloudDeviceCount} ${c("syncDeviceAbbrev",i)}`,a.style.display="inline",a.classList.add("status-active")):t.syncStatus==="error"||t.syncStatus==="offline"?(a.textContent=c("syncShortOff",i),a.style.display="inline",a.classList.remove("status-active")):a.style.display="none")}function Y(){const t=r.getState(),e=p("gps-indicator"),n=e==null?void 0:e.querySelector(".gps-dot"),s=e==null?void 0:e.querySelector(".gps-status-text");if(e&&(e.style.display=t.settings.gps?"flex":"none"),n){n.classList.remove("active","searching","paused"),e&&e.classList.remove("active","searching","inactive"),t.gpsStatus==="active"?(n.classList.add("active"),e==null||e.classList.add("active")):t.gpsStatus==="searching"?(n.classList.add("searching"),e==null||e.classList.add("searching")):t.gpsStatus==="paused"?n.classList.add("paused"):e==null||e.classList.add("inactive");const a=t.currentLang,i=t.gpsStatus==="active"||t.gpsStatus==="paused"?"gpsActive":t.gpsStatus==="searching"?"gpsSearching":"gpsInactive";n.setAttribute("aria-label",c(i,a))}if(s&&(t.gpsStatus==="active"||t.gpsStatus==="paused"?(s.textContent="GPS",s.classList.add("status-active"),s.classList.remove("status-inactive","status-searching")):t.gpsStatus==="searching"?(s.textContent="GPS...",s.classList.add("status-searching"),s.classList.remove("status-active","status-inactive")):(s.textContent="GPS Off",s.classList.add("status-inactive"),s.classList.remove("status-active","status-searching"))),e){const a=t.currentLang,i=t.gpsStatus==="active"||t.gpsStatus==="paused"?"gpsActive":t.gpsStatus==="searching"?"gpsSearching":"gpsInactive";e.setAttribute("aria-label",c(i,a))}}function tt(){const t=r.getState(),e=p("camera-indicator");e&&(e.style.display=t.settings.photoCapture?"flex":"none")}function Kn(t){const e=p("voice-indicator"),n=p("voice-status-text");if(e){if(t==="inactive"){e.style.display="none";return}if(e.style.display="flex",e.classList.remove("listening","processing","confirming","offline","error"),e.classList.add(t),n){const s=r.getState().currentLang;switch(t){case"listening":n.textContent=c("voiceListening",s);break;case"processing":n.textContent=c("voiceProcessing",s);break;case"confirming":n.textContent=c("voiceConfirming",s);break;case"offline":n.textContent=c("voiceOffline",s);break;case"error":n.textContent=c("voiceError",s);break}}}}function nt(){const t=p("undo-btn");t&&t.toggleAttribute("disabled",!r.canUndo())}const w=new T,ae=new Set;function I(t,e,n){const s=e.getBoundingClientRect();let a,i;typeof TouchEvent<"u"&&t instanceof TouchEvent&&t.touches.length>0?(a=t.touches[0].clientX-s.left,i=t.touches[0].clientY-s.top):typeof MouseEvent<"u"&&t instanceof MouseEvent?(a=t.clientX-s.left,i=t.clientY-s.top):(a=s.width/2,i=s.height/2);const o=document.createElement("span");o.classList.add("ripple"),n&&o.classList.add(`ripple-${n}`);const l=Math.max(s.width,s.height)*2;o.style.width=`${l}px`,o.style.height=`${l}px`,o.style.left=`${a-l/2}px`,o.style.top=`${i-l/2}px`,e.appendChild(o);const d=setTimeout(()=>{o.remove(),ae.delete(d)},500);ae.add(d)}function Yn(){document.querySelectorAll(".num-btn").forEach(e=>{e.classList.add("ripple-container"),w.add(e,"touchstart",n=>I(n,e),{passive:!0}),w.add(e,"mousedown",n=>I(n,e))});const t=document.querySelector(".timestamp-btn");t&&(t.classList.add("ripple-container"),w.add(t,"touchstart",e=>I(e,t,"primary"),{passive:!0}),w.add(t,"mousedown",e=>I(e,t,"primary"))),document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.add("ripple-container");const n=e.getAttribute("data-point")==="S";w.add(e,"touchstart",s=>I(s,e,n?"success":"secondary"),{passive:!0}),w.add(e,"mousedown",s=>I(s,e,n?"success":"secondary"))}),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.add("ripple-container"),w.add(e,"touchstart",n=>I(n,e,"primary"),{passive:!0}),w.add(e,"mousedown",n=>I(n,e,"primary"))}),document.querySelectorAll(".action-btn").forEach(e=>{e.classList.add("ripple-container"),w.add(e,"touchstart",n=>I(n,e),{passive:!0}),w.add(e,"mousedown",n=>I(n,e))}),document.querySelectorAll(".modal-btn").forEach(e=>{e.classList.add("ripple-container");const n=e.classList.contains("primary"),s=e.classList.contains("danger"),a=n?"primary":s?"secondary":void 0;w.add(e,"touchstart",i=>I(i,e,a),{passive:!0}),w.add(e,"mousedown",i=>I(i,e,a))})}function Xn(){w.removeAll(),ae.forEach(t=>clearTimeout(t)),ae.clear()}const at=new T;function L(t,e){at.add(window,t,e)}function Zn(){L("open-edit-modal",(t=>{Bn(t.detail.entry)})),L("prompt-delete",(t=>{Tn(t.detail.entry)})),L("open-confirm-modal",(t=>{Qe(t.detail.action)})),L("request-photo-sync-warning",(async()=>{try{await mn(),ke()}catch(t){v.error("Photo sync warning modal failed:",t),ke()}})),L("request-race-change-dialog",(async t=>{try{const e=t,n=await pn(e.detail.type,e.detail.lang);xe(n)}catch(e){v.error("Race change dialog failed:",e),xe("cancel")}})),L("update-role-toggle",(()=>{Xe()})),L("request-pin-verification",(async t=>{try{const n=await yn(t.detail.lang);Se(n)}catch(e){v.error("PIN verification failed:",e),Se(!1)}})),L("open-fault-edit-modal",(t=>{bt(t.detail.fault)})),L("open-mark-deletion-modal",(t=>{vt(t.detail.fault)})),L("update-inline-faults-list",(()=>{De()})),L("update-inline-bib-selector",(()=>{St()})),L("update-inline-gate-selector",(()=>{Et()}))}function Qn(){if(!J.isSupported()){v.debug("[VoiceMode] Not supported in this browser");return}const t="/api/v1/voice",e=window.VOICE_LLM_CONFIG,n={endpoint:(e==null?void 0:e.endpoint)||t,apiKey:(e==null?void 0:e.apiKey)||"proxy"};if(!J.initialize(n)){v.warn("[VoiceMode] Failed to initialize");return}J.onStatusChange(a=>{Kn(a)}),J.onAction(a=>{r.getState().deviceRole==="gateJudge"?ht(a):Gn(a)}),v.debug("[VoiceMode] Initialized successfully")}function st(t){const{isQuotaError:e,entryCount:n}=t.detail,s=r.getState().currentLang;e?h(c("storageNearlyFull",s),"error",te.CRITICAL):h(c("storageError",s),"error",te.ERROR),de(),v.error("[Storage] saveEntries:",t.detail.message,{entryCount:n,isQuotaError:e})}function it(t){const{percent:e,critical:n}=t.detail,s=r.getState().currentLang;n?h(`${c("storageQuotaError",s)} (${e}%)`,"error",te.CRITICAL):sessionStorage.getItem("storage-warning-shown")||(h(c("storageNearlyFull",s),"warning",te.WARNING),sessionStorage.setItem("storage-warning-shown","true"))}function ea(){try{M.flush()}catch(t){v.warn("Storage flush error on unload:",t)}try{Pn(),Cn()}catch(t){v.warn("Timer cleanup error:",t)}R.cleanup(),Q.stop(),P.stop(),ee.disable(),k.cleanup(),J.cleanup(),Tt(),Xn(),document.querySelectorAll(".ripple").forEach(t=>t.remove()),window.removeEventListener("race-deleted",Ke),window.removeEventListener("auth-expired",Ye),window.removeEventListener("storage-error",st),window.removeEventListener("storage-warning",it),at.removeAll(),cn(),fn(),We(),$t()}function ue(t){const e=t.currentView==="timer";e&&t.settings.gps?P.start():t.settings.gps?P.pause():P.stop(),e&&t.settings.photoCapture?Q.initialize():Q.stop()}const W=new T;function ta(){if(r.getState().settings.sync&&r.getState().raceId)if(Ue())R.initialize();else{r.updateSettings({sync:!1});const a=document.getElementById("sync-toggle");a&&(a.checked=!1),setTimeout(()=>{const i=r.getState().currentLang;h(c("syncRequiresPin",i),"info",5e3)},500)}ue(r.getState()),W.add(window,"race-deleted",Ke),W.add(window,"auth-expired",Ye),W.add(window,"storage-error",st),W.add(window,"storage-warning",it),document.addEventListener("click",Ee,{once:!0}),document.addEventListener("touchstart",Ee,{once:!0}),hn();const e=r.getState();e.currentView==="timer"&&ee.enable(),e.settings.ambientMode&&(k.initialize(),e.currentView==="timer"&&k.enable()),k.subscribe(a=>{document.body.classList.toggle("ambient-mode",a.isActive),a.triggeredBy?document.body.dataset.ambientTrigger=a.triggeredBy:delete document.body.dataset.ambientTrigger;const i=r.getState();i.settings.gps&&(a.isActive?P.pause():i.currentView==="timer"&&P.start())});let n=e.settings.photoCapture;const s=y(()=>{const a=Dt.value.photoCapture;n&&!a&&queueMicrotask(()=>Q.stop()),n=a});window.addEventListener("beforeunload",()=>s(),{once:!0}),Qn()}function na(){const t=[];return t.push(y(()=>{qt.value,ne()?Ze():fe()})),t.push(y(()=>{Mt.value,ne()||me()})),t.push(y(()=>{Pt.value,pe(),Me(),$.value==="gateJudge"&&j()})),t.push(y(()=>{Nt.value,_e(),Ge(),$.value==="gateJudge"&&j()})),t.push(y(()=>{He.value,Xe(),wt(),F()})),t.push(y(()=>{Ot.value,F()})),t.push(y(()=>{Vt.value,qe()})),t.push(y(()=>{Ft.value,$.value==="gateJudge"&&j()})),t.push(y(()=>{Jt.value,Ut.value,K()})),t.push(y(()=>{Ht.value,Y(),F()})),t.push(y(()=>{zt.value,nt()})),t.push(y(()=>{const e=$.value;et(),Y(),K(),e==="timer"?ee.enable():ee.disable();const n=ln();n&&(e==="results"?n.resume():n.pause())})),t.push(y(()=>{we.value,_t.value,K()})),t.push(y(()=>{Ie.value,$.value,Re(()=>Y()),queueMicrotask(()=>ue(r.getState()))})),t.push(y(()=>{Gt.value,$.value,Re(()=>tt()),queueMicrotask(()=>ue(r.getState()))})),t.push(y(()=>{Wt.value,jt.value,bn()})),t.push(y(()=>{const e=Kt.value,n=$.value;e?(k.initialize(),n==="timer"&&k.enable()):k.disable()})),t.push(y(()=>{we.value,Ie.value,F()})),()=>{for(const e of t)e()}}let ie=!1;const re=new T;function ot(){if(ie)return;const t=document.getElementById("offline-banner");if(t){const e=r.getState().currentLang,n=document.getElementById("offline-banner-text");n&&(n.textContent=c("offlineBanner",e)),t.classList.remove("hidden")}}function rt(){const t=document.getElementById("offline-banner");t&&t.classList.add("hidden")}function aa(){rt(),ie=!1;const t=r.getState().currentLang;h(c("onlineRestored",t),"success",2e3)}function sa(){ie=!1,ot()}function ia(){const t=document.getElementById("offline-banner-dismiss");t&&re.add(t,"click",()=>{ie=!0,rt()}),re.add(window,"online",aa),re.add(window,"offline",sa),navigator.onLine||ot()}const ce="skiTimerHasCompletedOnboarding";class oa{constructor(){x(this,"modal");x(this,"currentStep",1);x(this,"totalSteps",6);x(this,"selectedRole","timer");x(this,"updateTranslationsCallback",null);x(this,"recentRacesDocumentHandler",null);x(this,"listeners",new T);this.modal=document.getElementById("onboarding-modal"),this.modal&&this.setupEventListeners()}setUpdateTranslationsCallback(e){this.updateTranslationsCallback=e}shouldShow(){return M.getRaw(ce)!=="true"}show(){if(!this.modal)return;this.currentStep=1,this.selectedRole="timer",this.modal.querySelectorAll(".onboarding-card").forEach((m,b)=>{m.style.display=b===0?"block":"none"});const e=document.getElementById("onboarding-race-id");e&&(e.value="");const n=document.getElementById("onboarding-pin");n&&(n.value="",n.style.display="none");const s=document.getElementById("onboarding-race-status");s&&(s.textContent="",s.className="race-status");const a=document.getElementById("onboarding-sync-toggle");a&&(a.checked=!0);const i=document.getElementById("onboarding-photo-toggle");i&&(i.checked=!1),this.modal.querySelectorAll(".role-card").forEach(m=>{const b=m.getAttribute("data-role")==="timer";m.classList.toggle("selected",b),m.setAttribute("aria-checked",String(b))});const o=document.getElementById("onboarding-gate-start"),l=document.getElementById("onboarding-gate-end");o&&(o.value="1"),l&&(l.value="10"),this.updateUI(),H(this.modal);const d=document.getElementById("onboarding-device-name");d&&(d.value=r.getState().deviceName);const u=r.getState().currentLang;this.modal.querySelectorAll(".lang-btn").forEach(m=>{const b=m.dataset.lang;m.classList.toggle("selected",b===u)})}reset(){M.remove(ce),M.flush()}setupEventListeners(){if(!this.modal)return;this.listeners.add(document,"keydown",(i=>{var o;i.key==="Escape"&&((o=this.modal)!=null&&o.classList.contains("active"))&&this.dismiss()})),this.modal.querySelectorAll(".lang-btn").forEach(i=>{this.listeners.add(i,"click",o=>{const l=o.currentTarget,d=l.dataset.lang;d&&(r.setLanguage(d),this.modal.querySelectorAll(".lang-btn").forEach(u=>u.classList.remove("selected")),l.classList.add("selected"),f(),this.updateTranslationsCallback&&this.updateTranslationsCallback(),this.updateOnboardingTranslations())})}),this.modal.querySelectorAll("[data-action]").forEach(i=>{this.listeners.add(i,"click",async o=>{const d=o.currentTarget.dataset.action;d&&(f(),await this.handleAction(d))})});const e=document.getElementById("onboarding-regenerate-name");e&&this.listeners.add(e,"click",()=>{const i=document.getElementById("onboarding-device-name");i&&(i.value=Yt(),f())}),this.modal.querySelectorAll(".role-card").forEach(i=>{this.listeners.add(i,"click",()=>{const o=i.getAttribute("data-role");o&&(this.selectedRole=o,this.modal.querySelectorAll(".role-card").forEach(l=>{const d=l===i;l.classList.toggle("selected",d),l.setAttribute("aria-checked",String(d))}),f())})});const n=document.getElementById("onboarding-race-id");if(n){const i=Xt(()=>this.checkRaceExists(),500);this.listeners.add(n,"input",()=>{i();const o=document.getElementById("onboarding-pin");o&&(o.style.display=n.value.trim()?"block":"none")})}const s=document.getElementById("onboarding-recent-races-btn"),a=document.getElementById("onboarding-recent-races-dropdown");s&&a&&(this.listeners.add(s,"click",()=>{f(),a.style.display==="none"?(this.showRecentRacesDropdown(a,"onboarding-race-id"),s.setAttribute("aria-expanded","true")):(a.style.display="none",s.setAttribute("aria-expanded","false"))}),this.recentRacesDocumentHandler||(this.recentRacesDocumentHandler=i=>{const o=i.target;!s.contains(o)&&!a.contains(o)&&(a.style.display="none",s.setAttribute("aria-expanded","false"))},this.listeners.add(document,"click",this.recentRacesDocumentHandler)))}async showRecentRacesDropdown(e,n){const s=r.getState().currentLang;e.innerHTML=`<div class="recent-races-empty">${c("loading",s)}</div>`,e.style.display="block";let a=[];if(Ue())try{a=await this.fetchRacesFromApi()}catch(i){v.warn("Failed to fetch races from API:",i),a=Le()}else a=Le();a.length===0?e.innerHTML=`<div class="recent-races-empty">${c("noRecentRaces",s)}</div>`:(e.innerHTML=vn(a),Sn(e,a,i=>{this.selectRecentRace(i,n,e)}))}async fetchRacesFromApi(){const e=M.getRaw("skiTimerAuthToken");if(!e)return[];const n=await Zt("/api/v1/admin/races",{headers:{Authorization:`Bearer ${e}`}},5e3);if(!n.ok)throw new Error(`API error: ${n.status}`);const a=(await n.json()).races||[],i=new Date;i.setHours(0,0,0,0);const o=i.getTime(),l=a.filter(d=>d.lastUpdated&&d.lastUpdated>=o).map(d=>({raceId:d.raceId,createdAt:d.lastUpdated||Date.now(),lastUpdated:d.lastUpdated||Date.now(),entryCount:d.entryCount})).slice(0,5);return l.forEach(d=>{Qt(d.raceId,d.lastUpdated,d.entryCount)}),l}selectRecentRace(e,n,s){const a=document.getElementById(n);a&&(a.value=e.raceId,a.dispatchEvent(new Event("input",{bubbles:!0})),f()),s.style.display="none"}updateOnboardingTranslations(){if(!this.modal)return;const e=r.getState().currentLang;this.modal.querySelectorAll("[data-i18n]").forEach(n=>{const s=n.getAttribute("data-i18n");s&&(n.textContent=c(s,e))})}async handleAction(e){switch(e){case"next":await this.validateCurrentStep()&&(await this.saveCurrentStep(),r.forceSave(),this.goToStep(this.currentStep+1));break;case"back":this.currentStep>1&&this.goToStep(this.currentStep-1);break;case"skip":r.forceSave(),this.goToStep(this.currentStep+1);break;case"finish":this.complete();break;case"dismiss":this.dismiss();break}}finalize(){if(r.forceSave(),M.setRaw(ce,"true"),M.flush(),Z(this.modal),this.selectedRole==="gateJudge"){r.setView("gateJudge");const e=document.getElementById("gate-judge-tab");e&&(e.style.display="")}else r.setView("timer");this.listeners.removeAll(),this.recentRacesDocumentHandler=null}dismiss(){const e=document.getElementById("onboarding-device-name");e!=null&&e.value.trim()&&r.setDeviceName(e.value.trim()),r.setDeviceRole(this.selectedRole),this.finalize()}async validateCurrentStep(){var n,s,a,i;const e=r.getState().currentLang;switch(this.currentStep){case 2:return!0;case 3:return((n=document.getElementById("onboarding-device-name"))==null?void 0:n.value.trim())?!0:(h(c("deviceName",e),"warning"),!1);case 4:return!0;case 5:{const o=(s=document.getElementById("onboarding-race-id"))==null?void 0:s.value.trim(),l=(a=document.getElementById("onboarding-sync-toggle"))==null?void 0:a.checked;if(!o||!l)return!0;const d=(i=document.getElementById("onboarding-pin"))==null?void 0:i.value;return d.length!==4?(h(c("invalidPin",e),"warning"),!1):await this.validatePin(d)}default:return!0}}async saveCurrentStep(){var e,n,s,a,i,o;switch(this.currentStep){case 2:{r.setDeviceRole(this.selectedRole);break}case 3:{const l=(e=document.getElementById("onboarding-device-name"))==null?void 0:e.value.trim();l&&r.setDeviceName(l);break}case 4:{if(this.selectedRole==="gateJudge"){const l=parseInt(((n=document.getElementById("onboarding-gate-start"))==null?void 0:n.value)||"1",10),d=parseInt(((s=document.getElementById("onboarding-gate-end"))==null?void 0:s.value)||"10",10),u=Math.min(l,d),m=Math.max(l,d);r.setGateAssignment([u,m])}else{const l=(a=document.getElementById("onboarding-photo-toggle"))==null?void 0:a.checked;r.updateSettings({photoCapture:l})}break}case 5:{const l=(i=document.getElementById("onboarding-race-id"))==null?void 0:i.value.trim(),d=(o=document.getElementById("onboarding-sync-toggle"))==null?void 0:o.checked;l&&r.setRaceId(l);const u=d&&!!l;r.updateSettings({sync:u}),u&&R.initialize();break}}}goToStep(e){if(!(!this.modal||e<1||e>this.totalSteps)){if(this.modal.querySelectorAll(`[data-step="${this.currentStep}"]`).forEach(n=>{n.style.display="none"}),this.currentStep=e,e===4){const n=this.modal.querySelector(`[data-step="4"][data-path="${this.selectedRole}"]`);n&&(n.style.display="block")}else{const n=this.modal.querySelector(`[data-step="${e}"]:not([data-path])`);n&&(n.style.display="block")}this.updateUIForRole(),this.updateProgressDots(),e===6&&this.showSummary()}}updateUIForRole(){const e=r.getState().currentLang,n=document.getElementById("onboarding-device-name-title"),s=document.getElementById("onboarding-device-name-desc");this.selectedRole==="gateJudge"?(n&&(n.textContent=c("onboardingDeviceNameJudge",e)),s&&(s.textContent=c("onboardingDeviceNameJudgeDesc",e))):(n&&(n.textContent=c("onboardingDeviceName",e)),s&&(s.textContent=c("onboardingDeviceNameDesc",e)));const a=document.getElementById("onboarding-ready-title"),i=document.getElementById("onboarding-ready-tip"),o=document.getElementById("onboarding-finish-btn");this.selectedRole==="gateJudge"?(a&&(a.textContent=c("onboardingReadyJudge",e)),i&&(i.textContent=c("onboardingTipJudge",e)),o&&(o.textContent=c("startJudging",e))):(a&&(a.textContent=c("onboardingReady",e)),i&&(i.textContent=c("onboardingTip",e)),o&&(o.textContent=c("startTiming",e)))}updateProgressDots(){if(!this.modal)return;const e=this.modal.querySelectorAll(".progress-dot");e.forEach((s,a)=>{s.classList.remove("active","completed"),a+1===this.currentStep?s.classList.add("active"):a+1<this.currentStep&&s.classList.add("completed")});const n=this.modal.querySelector("#onboarding-progress-label");if(n){const s=e.length,a=r.getState().currentLang,i={de:`Schritt ${this.currentStep} von ${s}`,fr:`Étape ${this.currentStep} sur ${s}`,en:`Step ${this.currentStep} of ${s}`};n.textContent=i[a]||i.en}}updateUI(){this.updateProgressDots(),this.updateOnboardingTranslations()}showSummary(){const e=r.getState(),n=e.currentLang,s=document.getElementById("onboarding-summary");if(s){s.innerHTML="";const a=[],i=this.selectedRole==="gateJudge"?c("roleJudgeTitle",n):c("roleTimerTitle",n);a.push({label:c("deviceRole",n),value:i,badge:"role"});const o=this.selectedRole==="gateJudge"?c("onboardingDeviceNameJudge",n):c("deviceNameLabel",n);if(a.push({label:o,value:e.deviceName}),this.selectedRole==="gateJudge"){const u=e.gateAssignment;a.push({label:c("gates",n),value:u?`${u[0]}–${u[1]}`:"—"})}else{const u=e.settings.photoCapture;a.push({label:c("photoCaptureLabel",n),value:u?c("enabled",n):c("disabled",n),badge:u?"enabled":"disabled"})}a.push({label:c("raceIdLabel",n),value:e.raceId||"—"});const l=e.settings.sync;a.push({label:c("syncStatusLabel",n),value:l?c("enabled",n):c("disabled",n),badge:l?"enabled":"disabled"});const d=document.createElement("div");d.className="onboarding-summary-list",a.forEach(({label:u,value:m,badge:b})=>{const E=document.createElement("div");E.className="onboarding-summary-row";const g=document.createElement("span");g.className="onboarding-summary-label",g.textContent=u;const S=document.createElement("span");b?S.className=`onboarding-summary-badge ${b}`:S.className="onboarding-summary-value",S.textContent=m,E.append(g,S),d.appendChild(E)}),s.appendChild(d)}}async checkRaceExists(){const e=document.getElementById("onboarding-race-id"),n=document.getElementById("onboarding-race-status");if(!e||!n)return;const s=e.value.trim(),a=r.getState().currentLang;if(!s){n.textContent="",n.className="race-status";return}n.innerHTML=`${en(14)} ${G(c("loading",a))}`,n.className="race-status loading";const i=await R.checkRaceExists(s);if(i.exists){const o=i.entryCount===1?c("entry",a):c("entries",a);n.innerHTML=`${tn(14)} ${G(c("raceFound",a))} (${G(String(i.entryCount))} ${G(o)})`,n.className="race-status found"}else n.textContent=`+ ${c("raceNew",a)}`,n.className="race-status new"}async validatePin(e){try{return(await nn(e)).success}catch{const n=r.getState().currentLang;return h(`${c("networkError",n)} - ${c("pinVerifyOnline",n)}`,"warning",5e3),!0}}complete(){this.finalize(),Pe(),h(c("onboardingComplete",r.getState().currentLang),"success")}}const D=new T;let q=null;function $e(){const t=document.getElementById("app-version");t&&(t.textContent="5.24.5");const e=Ae("5.24.5",r.getState().currentLang),n=document.getElementById("app-version-name"),s=document.getElementById("app-version-description");e&&n&&(n.textContent=`"${e.name}"`),e&&s&&(s.textContent=e.description);const a=document.getElementById("version-info-btn");a&&D.add(a,"click",async()=>{const g=r.getState(),S=Ae("5.24.5",g.currentLang),dt=[S?`CHRONO v5.24.5 "${S.name}"`:"CHRONO v5.24.5",`Device: ${g.deviceName||"Unknown"}`,`Role: ${g.deviceRole}`,`Race ID: ${g.raceId||"None"}`,`Entries: ${g.entries.length}`,`Sync: ${g.settings.sync?"On":"Off"}`,`Language: ${g.currentLang.toUpperCase()}`,`User Agent: ${navigator.userAgent}`,`Screen: ${window.screen.width}x${window.screen.height}`,`Viewport: ${window.innerWidth}x${window.innerHeight}`,`Online: ${navigator.onLine}`,`Timestamp: ${new Date().toISOString()}`].join(`
`);try{await navigator.clipboard.writeText(dt),h(c("debugInfoCopied",g.currentLang),"success")}catch{h(c("debugInfoCopyFailed",g.currentLang),"warning")}f()}),Nn(),ne()?kn():(Mn(),On(),Vn(),Fn(),Jn()),dn(),En();const i=()=>{he(()=>import("./gate-judge-g1xWkyV9.js").then(g=>g.t),__vite__mapDeps([0,1,2])).then(g=>g.initGateJudgeView()).catch(g=>v.error("Failed to load gateJudgeView:",g)),he(()=>import("./chief-judge-uEHOwmjD.js").then(g=>g.aO),__vite__mapDeps([1,2])).then(g=>g.initChiefJudgeToggle()).catch(g=>v.error("Failed to load chiefJudgeView:",g))},o=r.getState().deviceRole;o==="gateJudge"&&i();let l=o;y(()=>{const g=He.value;g!==l&&(l=g,g==="gateJudge"&&i())}),Zn(),Rn(),wn(),Yn(),ia(),na(),ta(),D.add(window,"beforeunload",ea),Wn(),q=new oa,q.setUpdateTranslationsCallback(()=>je()),q.shouldShow()&&q.show();const d=document.getElementById("show-tutorial-btn");d&&D.add(d,"click",()=>{q&&(q.reset(),q.show(),f())});const u=document.getElementById("keyboard-shortcuts-modal"),m=document.getElementById("show-shortcuts-btn"),b=document.getElementById("shortcuts-close-btn"),E=document.getElementById("shortcuts-done-btn");m&&u&&D.add(m,"click",()=>{H(u),f()}),b&&u&&D.add(b,"click",()=>Z(u)),E&&u&&D.add(E,"click",()=>Z(u)),D.add(document,"keydown",(g=>{if(g.key==="?"&&!It()){const S=g.target;if(S.tagName==="INPUT"||S.tagName==="TEXTAREA"||S.tagName==="SELECT")return;g.preventDefault(),u&&H(u)}}))}let le=!1,U=[],V=null;const ra=3,ca=1e4;function la(){window.addEventListener("error",da),window.addEventListener("unhandledrejection",ua),window.addEventListener("critical-error",ga)}function da(t){const{message:e,error:n}=t;ze("Global","uncaught error",n||e,void 0),ct(e),lt()&&ye(e),t.preventDefault()}function ua(t){const e=t.reason,n=e instanceof Error?e.message:String(e);ze("Global","unhandled rejection",e,void 0),ct(n),lt()&&ye(n),t.preventDefault()}function ga(t){var s;const e=t.detail,n=((s=e==null?void 0:e.error)==null?void 0:s.message)||"Critical error occurred";an("Global","critical error event",e==null?void 0:e.error,void 0),ye(n)}function ct(t){const e=Date.now();U.push({message:t,timestamp:e}),U=U.filter(n=>e-n.timestamp<ca)}function lt(){return U.length>=ra}function ye(t){var a,i;if(le)return;le=!0;const e=r.getState().currentLang,n=document.createElement("div");n.id="error-boundary-overlay",n.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 24px;
  `;const s=document.createElement("div");s.style.cssText=`
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    text-align: center;
    color: #fff;
  `,s.innerHTML=`
    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
    <h2 style="margin: 0 0 8px; font-size: 1.25rem;">${c("errorOccurred",e)}</h2>
    <p style="color: #999; font-size: 0.875rem; margin: 0 0 16px;">
      ${c("errorRecoveryMessage",e)}
    </p>
    <p style="color: #666; font-size: 0.75rem; font-family: monospace; margin: 0 0 24px; word-break: break-word;">
      ${fa(t.substring(0,200))}
    </p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="error-dismiss-btn" style="
        padding: 12px 24px;
        border: 1px solid #444;
        border-radius: 8px;
        background: transparent;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${c("dismiss",e)}</button>
      <button id="error-reload-btn" style="
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #3B82F6;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${c("reload",e)}</button>
    </div>
  `,n.appendChild(s),document.body.appendChild(n),V=setTimeout(()=>{V=null;const o=document.getElementById("error-dismiss-btn");o==null||o.focus()},100),(a=document.getElementById("error-dismiss-btn"))==null||a.addEventListener("click",()=>{V!==null&&(clearTimeout(V),V=null),n.remove(),le=!1,U=[]}),(i=document.getElementById("error-reload-btn"))==null||i.addEventListener("click",()=>{window.location.reload()})}function fa(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}la();sn();on();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",$e):$e();let X=null;Ce.initialize().then(()=>{X=Ce.subscribe(t=>{document.body.classList.toggle("power-saver",t.batteryLevel!=="normal")})}).catch(()=>{});window.addEventListener("beforeunload",()=>{X&&(X(),X=null)});
