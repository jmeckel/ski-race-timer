var Sn=Object.defineProperty;var In=(n,e,t)=>e in n?Sn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var f=(n,e,t)=>In(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function t(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=t(i);fetch(i.href,a)}})();function wn(n){const e=Date.now(),t=crypto.randomUUID().slice(0,8);return`${n}-${e}-${t}`}const pe=["swift","bold","cool","fast","keen","wild","calm","warm","bright","sharp","quick","brave","fresh","grand","prime","clear","snow","ice","frost","peak","alpine","polar","winter","crisp"],ye=["fox","bear","wolf","hawk","eagle","tiger","lion","deer","pine","oak","cedar","birch","maple","spruce","aspen","willow","peak","ridge","slope","trail","summit","valley","glacier","cliff"];function gt(n){return n.charAt(0).toUpperCase()+n.slice(1)}function Cn(){const n=pe[Math.floor(Math.random()*pe.length)],e=ye[Math.floor(Math.random()*ye.length)],t=Math.floor(Math.random()*100);return`dev_${n}-${e}-${t}`}function ve(){const n=pe[Math.floor(Math.random()*pe.length)],e=ye[Math.floor(Math.random()*ye.length)],t=Math.floor(Math.random()*100);return`${gt(n)} ${gt(e)} ${t}`}const be=2,Tn=["S","F"],Ln=["ok","dns","dnf","dsq"];function K(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"&&typeof e.id!="number"||typeof e.id=="string"&&e.id.length===0||typeof e.id=="number"&&e.id<=0||e.bib!==void 0&&typeof e.bib!="string"||typeof e.bib=="string"&&e.bib.length>10||!Tn.includes(e.point)||!e.timestamp||typeof e.timestamp!="string"||isNaN(Date.parse(e.timestamp))||e.status!==void 0&&!Ln.includes(e.status)||e.deviceId!==void 0&&typeof e.deviceId!="string"||e.deviceName!==void 0&&typeof e.deviceName!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||e.syncedAt<0||!Number.isFinite(e.syncedAt))||e.photo!==void 0&&typeof e.photo!="string")return!1;if(e.gpsCoords!==void 0){if(typeof e.gpsCoords!="object"||e.gpsCoords===null)return!1;const t=e.gpsCoords;if(typeof t.latitude!="number"||!Number.isFinite(t.latitude)||typeof t.longitude!="number"||!Number.isFinite(t.longitude)||typeof t.accuracy!="number"||!Number.isFinite(t.accuracy)||t.accuracy<0)return!1}return!0}function Rn(n){if(!n||typeof n!="object")return!1;const e=n;return!(!K(e.entry)||typeof e.retryCount!="number"||e.retryCount<0||typeof e.lastAttempt!="number"||e.lastAttempt<0)}function Nt(n){return!n||typeof n!="string"||n.length>50?!1:/^[a-zA-Z0-9_-]+$/.test(n)}function An(n){return!n||typeof n!="string"?!1:n.startsWith("dev_")&&n.length>4}function ge(n,e=100){return!n||typeof n!="string"?"":n.slice(0,e).replace(/[<>"'&]/g,"").replace(/[\x00-\x1F\x7F]/g,"")}function kn(n,e){if(!K(n))return null;const t=n;return{id:(typeof t.id=="number",String(t.id)),bib:ge(t.bib,10),point:t.point,run:t.run??1,timestamp:t.timestamp,status:t.status||"ok",deviceId:ge(t.deviceId||e,50),deviceName:ge(t.deviceName||"Unknown Device",100),syncedAt:t.syncedAt,photo:t.photo,gpsCoords:t.gpsCoords}}function Bn(n,e){const t={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1};if(!n||typeof n!="object")return{version:be,entries:[],settings:t,deviceId:e,deviceName:ve(),raceId:"",syncQueue:[]};const s=n;let i=[];Array.isArray(s.entries)&&(i=s.entries.map(o=>kn(o,e)).filter(o=>o!==null));let a=t;if(s.settings&&typeof s.settings=="object"){const o=s.settings;a={auto:typeof o.auto=="boolean"?o.auto:t.auto,haptic:typeof o.haptic=="boolean"?o.haptic:t.haptic,sound:typeof o.sound=="boolean"?o.sound:t.sound,sync:typeof o.sync=="boolean"?o.sync:t.sync,syncPhotos:typeof o.syncPhotos=="boolean"?o.syncPhotos:t.syncPhotos,gps:typeof o.gps=="boolean"?o.gps:t.gps,simple:typeof o.simple=="boolean"?o.simple:t.simple,photoCapture:typeof o.photoCapture=="boolean"?o.photoCapture:t.photoCapture,motionEffects:typeof o.motionEffects=="boolean"?o.motionEffects:t.motionEffects,glassEffects:typeof o.glassEffects=="boolean"?o.glassEffects:t.glassEffects,outdoorMode:typeof o.outdoorMode=="boolean"?o.outdoorMode:t.outdoorMode}}let r=[];return Array.isArray(s.syncQueue)&&(r=s.syncQueue.filter(Rn)),{version:be,entries:i,settings:a,deviceId:An(s.deviceId)?s.deviceId:e,deviceName:ge(s.deviceName,100)||ve(),raceId:Nt(s.raceId)?s.raceId:"",syncQueue:r,lastExport:typeof s.lastExport=="number"?s.lastExport:void 0}}const C={ENTRIES:"skiTimerEntries",SETTINGS:"skiTimerSettings",LANG:"skiTimerLang",DEVICE_ID:"skiTimerDeviceId",DEVICE_NAME:"skiTimerDeviceName",RACE_ID:"skiTimerRaceId",LAST_SYNCED_RACE_ID:"skiTimerLastSyncedRaceId",SYNC_QUEUE:"skiTimerSyncQueue",SCHEMA_VERSION:"skiTimerSchemaVersion",DEVICE_ROLE:"skiTimerDeviceRole",GATE_ASSIGNMENT:"skiTimerGateAssignment",FAULT_ENTRIES:"skiTimerFaultEntries"},ht={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1},Pn=50;class Dn{constructor(){f(this,"state");f(this,"listeners",new Set);f(this,"saveTimeout",null);f(this,"isNotifying",!1);f(this,"pendingNotifications",[]);f(this,"listenerErrorCallback",null);f(this,"failedListenerCount",0);this.state=this.loadInitialState()}loadInitialState(){let e=localStorage.getItem(C.DEVICE_ID);e||(e=Cn(),localStorage.setItem(C.DEVICE_ID,e));const t=localStorage.getItem(C.ENTRIES),s=localStorage.getItem(C.SETTINGS),i=localStorage.getItem(C.SYNC_QUEUE);let a=[],r=ht,o=[];try{if(t){const m=JSON.parse(t);Array.isArray(m)&&(a=m.filter(y=>K(y)).map(y=>({...y,run:y.run??1})))}}catch(m){console.error("Failed to parse entries:",m)}try{if(s){const m=JSON.parse(s);r={...ht,...m}}}catch(m){console.error("Failed to parse settings:",m)}try{if(i){const m=JSON.parse(i);Array.isArray(m)&&(o=m)}}catch(m){console.error("Failed to parse sync queue:",m)}const l=localStorage.getItem(C.LANG)||"de";let h=localStorage.getItem(C.DEVICE_NAME);h||(h=ve(),localStorage.setItem(C.DEVICE_NAME,h));const u=localStorage.getItem(C.RACE_ID)||"",g=localStorage.getItem(C.LAST_SYNCED_RACE_ID)||"",p=localStorage.getItem(C.DEVICE_ROLE)||"timer";let v=null,b=[];try{const m=localStorage.getItem(C.GATE_ASSIGNMENT);if(m){const y=JSON.parse(m);Array.isArray(y)&&y.length===2&&(v=y)}}catch(m){console.error("Failed to parse gate assignment:",m)}try{const m=localStorage.getItem(C.FAULT_ENTRIES);if(m){const y=JSON.parse(m);Array.isArray(y)&&(b=y)}}catch(m){console.error("Failed to parse fault entries:",m)}return{currentView:p==="gateJudge"?"gateJudge":"timer",currentLang:l,bibInput:"",selectedPoint:"F",selectedRun:1,selectMode:!1,selectedEntries:new Set,isRecording:!1,lastRecordedEntry:null,entries:a,deviceRole:p,gateAssignment:v,faultEntries:b,selectedFaultBib:"",isJudgeReady:!1,isChiefJudgeView:!1,finalizedRacers:new Set,penaltySeconds:5,usePenaltyMode:!0,undoStack:[],redoStack:[],settings:r,deviceId:e,deviceName:h,raceId:u,lastSyncedRaceId:g,syncStatus:"disconnected",syncQueue:o,connectedDevices:new Map,cloudDeviceCount:0,cloudHighestBib:0,raceExistsInCloud:null,gpsEnabled:r.gps,gpsAccuracy:null,gpsStatus:"inactive",cameraReady:!1,cameraError:null}}getState(){return this.state}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e){if(this.pendingNotifications.push({keys:e,stateSnapshot:this.state}),!this.isNotifying){this.isNotifying=!0;try{for(;this.pendingNotifications.length>0;){const{keys:t,stateSnapshot:s}=this.pendingNotifications.shift(),i=Array.from(this.listeners);for(const a of i)try{a(s,t)}catch(r){if(console.error("State listener error:",r),this.failedListenerCount++,this.listenerErrorCallback)try{this.listenerErrorCallback(r,a)}catch{}}}}finally{this.isNotifying=!1}}}onListenerError(e){this.listenerErrorCallback=e}getListenerFailureCount(){return this.failedListenerCount}setState(e,t=!0){const s=Object.keys(e);this.state={...this.state,...e},this.notify(s),t&&this.scheduleSave()}scheduleSave(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveToStorage(),100)}forceSave(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null),this.saveToStorage()}saveToStorage(){try{this.checkStorageQuota();const e=this.state.entries.map(t=>t.photo&&t.photo!=="indexeddb"&&t.photo.length>20?{...t,photo:"indexeddb"}:t);localStorage.setItem(C.ENTRIES,JSON.stringify(e)),localStorage.setItem(C.SETTINGS,JSON.stringify(this.state.settings)),localStorage.setItem(C.LANG,this.state.currentLang),localStorage.setItem(C.DEVICE_NAME,this.state.deviceName),localStorage.setItem(C.RACE_ID,this.state.raceId),localStorage.setItem(C.LAST_SYNCED_RACE_ID,this.state.lastSyncedRaceId),localStorage.setItem(C.SYNC_QUEUE,JSON.stringify(this.state.syncQueue)),localStorage.setItem(C.SCHEMA_VERSION,String(be)),localStorage.setItem(C.DEVICE_ROLE,this.state.deviceRole),this.state.gateAssignment?localStorage.setItem(C.GATE_ASSIGNMENT,JSON.stringify(this.state.gateAssignment)):localStorage.removeItem(C.GATE_ASSIGNMENT),localStorage.setItem(C.FAULT_ENTRIES,JSON.stringify(this.state.faultEntries))}catch(e){console.error("Failed to save to storage:",e),this.dispatchStorageError(e)}}async checkStorageQuota(){var e;if((e=navigator.storage)!=null&&e.estimate)try{const{usage:t,quota:s}=await navigator.storage.estimate();if(s&&t){const i=t/s;i>.9&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t,quota:s,percent:Math.round(i*100)}}))}}catch(t){console.warn("Could not check storage quota:",t)}}dispatchStorageError(e){window.dispatchEvent(new CustomEvent("storage-error",{detail:{message:e.message,isQuotaError:e.name==="QuotaExceededError"||e.message.includes("quota")||e.message.includes("storage"),entryCount:this.state.entries.length}}))}pushUndo(e){const t=[...this.state.undoStack,e];t.length>Pn&&t.shift(),this.setState({undoStack:t,redoStack:[]},!1)}addEntry(e){const t=[...this.state.entries,e];this.pushUndo({type:"ADD_ENTRY",data:e,timestamp:Date.now()}),this.setState({entries:t,lastRecordedEntry:e,isRecording:!1}),this.state.settings.sync&&this.state.raceId&&this.addToSyncQueue(e)}deleteEntry(e){const t=this.state.entries.find(i=>i.id===e);if(!t)return;this.pushUndo({type:"DELETE_ENTRY",data:t,timestamp:Date.now()});const s=this.state.entries.filter(i=>i.id!==e);this.setState({entries:s})}deleteMultiple(e){const t=this.state.entries.filter(i=>e.includes(i.id));if(t.length===0)return;this.pushUndo({type:"DELETE_MULTIPLE",data:t,timestamp:Date.now()});const s=this.state.entries.filter(i=>!e.includes(i.id));this.setState({entries:s,selectMode:!1,selectedEntries:new Set})}clearAll(){this.state.entries.length!==0&&(this.pushUndo({type:"CLEAR_ALL",data:[...this.state.entries],timestamp:Date.now()}),this.setState({entries:[],selectMode:!1,selectedEntries:new Set}))}updateEntry(e,t){const s=this.state.entries.findIndex(o=>o.id===e);if(s===-1)return!1;const i=this.state.entries[s],a={...i,...t};this.pushUndo({type:"UPDATE_ENTRY",data:i,newData:a,timestamp:Date.now()});const r=[...this.state.entries];return r[s]=a,this.setState({entries:r}),!0}canUndo(){return this.state.undoStack.length>0}canRedo(){return this.state.redoStack.length>0}peekUndo(){return this.canUndo()?this.state.undoStack[this.state.undoStack.length-1]:null}undo(){if(!this.canUndo())return null;const e=[...this.state.undoStack],t=e.pop(),s=[...this.state.redoStack,t];let i=[...this.state.entries],a=null;switch(t.type){case"ADD_ENTRY":{const r=t.data;i=i.filter(o=>o.id!==r.id),a=r;break}case"DELETE_ENTRY":{const r=t.data;i.push(r),i.sort((o,l)=>new Date(o.timestamp).getTime()-new Date(l.timestamp).getTime()),a=r;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const r=t.data;i=[...i,...r],i.sort((o,l)=>new Date(o.timestamp).getTime()-new Date(l.timestamp).getTime()),a=r;break}case"UPDATE_ENTRY":{const r=t.data,o=i.findIndex(l=>l.id===r.id);o!==-1&&(i[o]=r),a=r;break}}return this.setState({entries:i,undoStack:e,redoStack:s}),a?{type:t.type,data:a}:null}redo(){if(!this.canRedo())return null;const e=[...this.state.redoStack],t=e.pop(),s=[...this.state.undoStack,t];let i=[...this.state.entries],a=null;switch(t.type){case"ADD_ENTRY":{const r=t.data;i.push(r),i.sort((o,l)=>new Date(o.timestamp).getTime()-new Date(l.timestamp).getTime()),a=r;break}case"DELETE_ENTRY":{const r=t.data;i=i.filter(o=>o.id!==r.id),a=r;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const r=t.data,o=new Set(r.map(l=>l.id));i=i.filter(l=>!o.has(l.id)),a=r;break}case"UPDATE_ENTRY":{const r=t.data,o=t.newData,l=i.findIndex(h=>h.id===r.id);l!==-1&&o&&(i[l]=o),a=o||r;break}}return this.setState({entries:i,undoStack:s,redoStack:e}),a}addToSyncQueue(e){const t={entry:e,retryCount:0,lastAttempt:0},s=[...this.state.syncQueue,t];this.setState({syncQueue:s})}removeFromSyncQueue(e){const t=this.state.syncQueue.filter(s=>s.entry.id!==e);this.setState({syncQueue:t})}updateSyncQueueItem(e,t){const s=this.state.syncQueue.map(i=>i.entry.id===e?{...i,...t}:i);this.setState({syncQueue:s})}clearSyncQueue(){this.setState({syncQueue:[]})}setView(e){this.setState({currentView:e},!1)}setLanguage(e){this.setState({currentLang:e})}setBibInput(e){const t=e.replace(/\D/g,"").slice(0,3);this.setState({bibInput:t},!1)}setSelectedPoint(e){this.setState({selectedPoint:e},!1)}setSelectedRun(e){this.setState({selectedRun:e},!1)}setSelectMode(e){this.setState({selectMode:e,selectedEntries:e?this.state.selectedEntries:new Set},!1)}toggleEntrySelection(e){const t=new Set(this.state.selectedEntries);t.has(e)?t.delete(e):t.add(e),this.setState({selectedEntries:t,selectMode:t.size>0},!1)}selectAllEntries(){const e=new Set(this.state.entries.map(t=>t.id));this.setState({selectedEntries:e,selectMode:!0},!1)}clearSelection(){this.setState({selectedEntries:new Set,selectMode:!1},!1)}setRecording(e){this.setState({isRecording:e},!1)}setDeviceRole(e){this.setState({deviceRole:e})}setGateAssignment(e){this.setState({gateAssignment:e})}setSelectedFaultBib(e){this.setState({selectedFaultBib:e},!1)}setJudgeReady(e){this.setState({isJudgeReady:e})}toggleJudgeReady(){this.setState({isJudgeReady:!this.state.isJudgeReady})}setChiefJudgeView(e){this.setState({isChiefJudgeView:e},!1)}toggleChiefJudgeView(){this.setState({isChiefJudgeView:!this.state.isChiefJudgeView},!1)}finalizeRacer(e,t){const s=`${e}-${t}`,i=new Set(this.state.finalizedRacers);i.add(s),this.setState({finalizedRacers:i},!1)}unfinalizeRacer(e,t){const s=`${e}-${t}`,i=new Set(this.state.finalizedRacers);i.delete(s),this.setState({finalizedRacers:i},!1)}isRacerFinalized(e,t){const s=`${e}-${t}`;return this.state.finalizedRacers.has(s)}clearFinalizedRacers(){this.setState({finalizedRacers:new Set},!1)}setPenaltySeconds(e){this.setState({penaltySeconds:Math.max(0,Math.min(60,e))},!1)}setUsePenaltyMode(e){this.setState({usePenaltyMode:e},!1)}addFaultEntry(e){const t=[...this.state.faultEntries,e];this.setState({faultEntries:t})}deleteFaultEntry(e){const t=this.state.faultEntries.filter(s=>s.id!==e);this.setState({faultEntries:t})}updateFaultEntry(e,t){const s=this.state.faultEntries.findIndex(a=>a.id===e);if(s===-1)return!1;const i=[...this.state.faultEntries];return i[s]={...i[s],...t},this.setState({faultEntries:i}),!0}clearFaultEntries(){this.setState({faultEntries:[]})}getFaultsForBib(e,t){return this.state.faultEntries.filter(s=>s.bib===e&&s.run===t)}mergeFaultsFromCloud(e,t=[]){let s=0;const i=new Set(this.state.faultEntries.map(o=>`${o.id}-${o.deviceId}`)),a=new Set(t),r=[];for(const o of e){if(o.deviceId===this.state.deviceId)continue;const l=`${o.id}:${o.deviceId}`;if(a.has(l)||a.has(o.id))continue;const h=`${o.id}-${o.deviceId}`;i.has(h)||(r.push(o),i.add(h),s++)}if(r.length>0){const o=[...this.state.faultEntries,...r];o.sort((l,h)=>new Date(l.timestamp).getTime()-new Date(h.timestamp).getTime()),this.setState({faultEntries:o})}return s}removeDeletedCloudFaults(e){const t=new Set(e);let s=0;const i=this.state.faultEntries.filter(a=>{const r=`${a.id}:${a.deviceId}`;return t.has(r)||t.has(a.id)?(s++,!1):!0});return s>0&&this.setState({faultEntries:i}),s}markFaultSynced(e){const t=this.state.faultEntries.findIndex(s=>s.id===e);if(t!==-1){const s=[...this.state.faultEntries];s[t]={...s[t],syncedAt:Date.now()},this.setState({faultEntries:s})}}getActiveBibs(e){const t=this.state.entries,s=t.filter(r=>r.point==="S"&&r.run===e),i=t.filter(r=>r.point==="F"&&r.run===e),a=new Set(i.map(r=>r.bib));return s.filter(r=>!a.has(r.bib)).map(r=>r.bib).sort((r,o)=>parseInt(r,10)-parseInt(o,10))}updateSettings(e){const t={...this.state.settings,...e};this.setState({settings:t})}toggleSetting(e){const t={...this.state.settings};t[e]=!t[e],this.setState({settings:t})}setSyncStatus(e){this.setState({syncStatus:e},!1)}setRaceId(e){e!==this.state.raceId?this.setState({raceId:e,undoStack:[],redoStack:[]}):this.setState({raceId:e})}setLastSyncedRaceId(e){this.setState({lastSyncedRaceId:e})}markCurrentRaceAsSynced(){this.setState({lastSyncedRaceId:this.state.raceId})}setDeviceName(e){this.setState({deviceName:e})}addConnectedDevice(e){const t=new Map(this.state.connectedDevices);t.set(e.id,e),this.setState({connectedDevices:t},!1)}removeConnectedDevice(e){const t=new Map(this.state.connectedDevices);t.delete(e),this.setState({connectedDevices:t},!1)}setCloudDeviceCount(e){this.setState({cloudDeviceCount:e},!1)}setCloudHighestBib(e){this.setState({cloudHighestBib:e},!1)}setRaceExistsInCloud(e){this.setState({raceExistsInCloud:e},!1)}setGpsStatus(e,t){this.setState({gpsStatus:e,gpsAccuracy:t??null},!1)}setCameraReady(e,t){this.setState({cameraReady:e,cameraError:t??null},!1)}mergeCloudEntries(e,t=[]){let s=0;const i=new Set(this.state.entries.map(o=>`${o.id}-${o.deviceId}`)),a=new Set(t),r=[];for(const o of e){if(!K(o)||o.deviceId===this.state.deviceId)continue;const l=`${o.id}:${o.deviceId}`;if(a.has(l)||a.has(o.id))continue;const h=`${o.id}-${o.deviceId}`;i.has(h)||(r.push({...o,run:o.run??1}),i.add(h),s++)}if(r.length>0){const o=[...this.state.entries,...r];o.sort((l,h)=>new Date(l.timestamp).getTime()-new Date(h.timestamp).getTime()),this.setState({entries:o})}return s}removeDeletedCloudEntries(e){const t=new Set(e);let s=0;const i=this.state.entries.filter(a=>{const r=`${a.id}:${a.deviceId}`;return t.has(r)||t.has(a.id)?(s++,!1):!0});return s>0&&this.setState({entries:i}),s}exportData(){return JSON.stringify({version:be,entries:this.state.entries,settings:this.state.settings,deviceId:this.state.deviceId,deviceName:this.state.deviceName,raceId:this.state.raceId,exportedAt:new Date().toISOString()},null,2)}importData(e){try{const t=JSON.parse(e),s=Bn(t,this.state.deviceId),i=new Set(this.state.entries.map(r=>r.id)),a=s.entries.filter(r=>!i.has(r.id));if(a.length>0){const r=[...this.state.entries,...a];r.sort((o,l)=>new Date(o.timestamp).getTime()-new Date(l.timestamp).getTime()),this.setState({entries:r})}return{success:!0,entriesImported:a.length}}catch(t){return{success:!1,entriesImported:0,error:String(t)}}}}const c=new Dn;function Ft(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),s=String(n.getSeconds()).padStart(2,"0"),i=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${s}.${i}`}function xn(n,e="de"){const t={weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"};return n.toLocaleDateString(e==="de"?"de-DE":"en-US",t)}function ft(n,e=3){return String(n).padStart(e,"0")}function F(n){const e=document.createElement("div");return e.textContent=String(n),e.innerHTML}function Nn(n){return{S:"var(--success)",F:"var(--secondary)"}[n]||"var(--text-secondary)"}function X(n,e="de"){return{en:{S:"Start",F:"Finish"},de:{S:"Start",F:"Ziel"}}[e][n]}function Ee(n,e="de"){return{en:{1:"R1",2:"R2"},de:{1:"L1",2:"L2"}}[e][n]}function ie(n){return{1:"var(--primary)",2:"var(--warning)"}[n]||"var(--text-secondary)"}const mt={en:{timer:"Timer",results:"Results",settings:"Settings",start:"Start",finish:"Finish",bib:"Bib",point:"Point",run:"Run",run1:"R1",run2:"R2",time:"Record time",lastRecorded:"Last recorded",status:"Status",noEntries:"No entries recorded",search:"Search by bib...",filter:"Filter",all:"All",total:"Total",racers:"Racers",finished:"Finished",fastest:"Fastest",average:"Average",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Delete Entry",confirmDeleteText:"Are you sure you want to delete this entry?",confirmClearAll:"Clear All Results",clearAllText:"This will delete all recorded entries. This action cannot be undone.",confirmUndoAdd:"Undo Recording",confirmUndoAddText:"This will delete the recorded entry. Continue?",delete:"Delete",cancel:"Cancel",close:"Close",save:"Save",edit:"Edit",undo:"Undo",export:"Export",clearAll:"Clear All",selectAll:"Select All",deleteSelected:"Delete Selected",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Synced from cloud",raceId:"Race ID",invalidRaceId:"Invalid Race ID. Use letters, numbers, hyphens, underscores only.",deviceName:"Time Keeper ID",cloudSync:"Cloud Sync",syncStatus:"Sync Status",pendingSync:"pending sync",saved:"Saved",deleted:"Deleted",cleared:"All entries cleared",undone:"Undone",copied:"Copied to clipboard",duplicateWarning:"Duplicate entry detected",zeroBibWarning:"Bib 000 - verify entry",exported:"Exported successfully",gps:"GPS",gpsActive:"GPS Active",gpsSearching:"Searching for GPS...",gpsInactive:"GPS Inactive",gpsAccuracy:"Accuracy",simpleMode:"Simple Mode",fullMode:"Full Mode",autoIncrement:"Auto-increment Bib",hapticFeedback:"Haptic Feedback",soundFeedback:"Sound Feedback",language:"Language",backup:"Backup",restore:"Restore",importData:"Import Data",exportData:"Export Data",simpleModeDesc:"Simplified interface for basic timing",cloudSyncDesc:"Sync with other devices",gpsDesc:"Use GPS for accurate timestamps",autoIncrementDesc:"Increase bib number after recording",photoCaptureDesc:"Capture photo on timestamp",hapticFeedbackDesc:"Vibration on actions",soundFeedbackDesc:"Audio confirmation",photoCapture:"Photo Capture",photoCaptured:"Photo captured",photoError:"Photo capture failed",photoSaveFailed:"Photo storage failed",viewPhoto:"View Photo",deletePhoto:"Delete Photo",photoFor:"Photo for Bib",noPhotoAvailable:"No photo available",photoDeleted:"Photo deleted",raceChangeTitle:"Change Race",raceChangeSyncedText:"You have results from another race. Export or delete them before switching?",raceChangeUnsyncedText:"You have existing results. Keep them or delete before switching?",keepResults:"Keep",version:"Version",devices:"Devices",entries:"entries",selected:"selected",raceFound:"Race found",raceNew:"New race",entriesInCloud:"entries in cloud",photoTooLarge:"Photo too large for sync",syncedEntriesFromCloud:"Synced {count} entries from cloud",syncedFaultsFromCloud:"Synced {count} faults from cloud",crossDeviceDuplicate:"Duplicate: Bib {bib} {point} already recorded by {device}",syncPhotos:"Sync Photos",syncPhotosDesc:"Share photos across devices via cloud",syncPhotosWarning:"Enable Photo Sync",syncPhotosWarningText:"Enabling photo sync will transfer the following data:",photosToUpload:"Photos to upload",photosToDownload:"Photos to download",totalDataVolume:"Total data volume",enableSync:"Enable Sync",noPhotosToSync:"No photos to sync",admin:"Admin",adminPin:"Race Management PIN",adminPinDesc:"Required to manage and sync races",manageRaces:"Manage Races",manageRacesDesc:"View and delete synced races",manage:"Manage",enterAdminPin:"Enter Race Management PIN",enterPinText:"Enter your PIN to access race management.",enterPinToJoinRace:"Enter your PIN to join this race.",syncRequiresPin:"Sync disabled. Enable sync and enter PIN to reconnect.",incorrectPin:"Incorrect PIN",verify:"Verify",setPinFirst:"Please set a Race Management PIN first",pinSaved:"PIN saved",pinCleared:"PIN cleared",pinNotSet:"Not set",pinSet:"PIN set",setPin:"Set PIN",changePin:"Change PIN",currentPin:"Current PIN",newPin:"New PIN (4 digits)",confirmPin:"Confirm PIN",pinMismatch:"PINs do not match",pinFormatError:"PIN must be exactly 4 digits",loading:"Loading...",noRaces:"No active races",refresh:"Refresh",raceDeleted:"Race Deleted",raceDeletedText:"This race has been deleted by an administrator.",raceDeletedFor:"Race deleted:",raceDeletedSuccess:"Race deleted:",confirmDeleteRace:"Delete Race",confirmDeleteRaceText:"Are you sure you want to delete race",loadError:"Failed to load races",deleteError:"Failed to delete race",entry:"entry",device:"device",storageError:"Failed to save data - check storage",storageQuotaError:"Storage full! Export data immediately",storageWarning:"Storage almost full",networkError:"Network error - check connection",connectionFailed:"Connection failed",serverUnavailable:"Server unavailable",rateLimitError:"Too many requests - please wait",authError:"Authentication failed",syncFailed:"Sync failed",pinSyncFailed:"PIN not synced to cloud",cameraError:"Camera error",cameraPermissionDenied:"Camera access denied",gpsError:"GPS error",gpsPermissionDenied:"GPS access denied",gpsUnavailable:"GPS unavailable",unknownError:"Unknown error",onboardingWelcome:"Welcome to Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronized timing for ski races",getStarted:"Get Started",onboardingRole:"What's Your Role?",onboardingRoleDesc:"Choose how you'll be helping at the race",roleTimerTitle:"Timer",roleTimerDesc:"Record start and finish times",roleJudgeTitle:"Gate Judge",roleJudgeDesc:"Record gate faults (Torrichter)",onboardingDeviceName:"Name Your Timer",onboardingDeviceNameDesc:"This identifies your device when syncing",onboardingDeviceNameJudge:"Your Name",onboardingDeviceNameJudgeDesc:"This identifies you as the gate judge",onboardingPhoto:"Photo Documentation",onboardingPhotoDesc:"Automatically capture a photo when recording each timestamp. Useful for verifying bib numbers and resolving disputes.",enablePhotoCapture:"Enable Photo Capture",photoCaptureLabel:"Photo Capture",onboardingGates:"Your Gate Assignment",onboardingGatesDesc:"Enter the gate numbers you'll be watching. You can change this later.",onboardingRaceSetup:"Join a Race",onboardingRaceSetupDesc:"Enter a race ID to sync with other timers",skipForNow:"Skip for now",onboardingReady:"Ready to Time!",onboardingReadyJudge:"Ready to Judge!",onboardingTip:"Tap the big blue button to record timestamps",onboardingTipJudge:"Tap a racer's bib to record a fault",startTiming:"Start Timing",startJudging:"Start Judging",continue:"Continue",deviceNameLabel:"Device Name",raceIdLabel:"Race ID",syncStatusLabel:"Cloud Sync",enabled:"Enabled",disabled:"Disabled",showTutorial:"Show Tutorial",showTutorialDesc:"Run the setup wizard again",show:"Show",onboardingComplete:"Setup complete!",invalidPin:"Invalid PIN format",recentRaces:"Recent Races",noRecentRaces:"No races from today",errorOccurred:"Something went wrong",errorRecoveryMessage:"The app encountered an error. You can dismiss this and continue, or reload the app.",dismiss:"Dismiss",reload:"Reload",operationFailed:"Operation failed",raceIdPlaceholder:"RACE-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Photo for bib",gateJudge:"Gate Judge",gateJudgeTab:"Gate",deviceRole:"Device Role",deviceRoleDesc:"Timer records times, Gate Judge records faults",roleTimer:"Timer",roleGateJudge:"Gate Judge",gateAssignment:"Gate Assignment",gates:"Gates",gatesFrom:"From",gatesTo:"To",changeGates:"Change",otherJudges:"Other judges:",activeBibs:"On Course",noBibsOnCourse:"No racers on course",recordFault:"Record Fault",faultType:"Fault Type",faultMG:"Missed Gate",faultSTR:"Straddling",faultBR:"Binding Release",faultMGShort:"MG",faultSTRShort:"STR",faultBRShort:"BR",faultRecorded:"Fault recorded",signalReady:"Ready",judgeReady:"Ready for race!",judgeNotReady:"Ready status cleared",faultDeleted:"Fault deleted",selectBib:"Select Bib",selectGate:"Gate",gate:"Gate",noFaults:"No faults recorded",faultsFor:"Faults for",faultSummary:"Fault Summary",penaltyTime:"Penalty",faultCount:"faults",markOk:"Mark OK",flt:"FLT",statusFlt:"Fault Penalty",chiefJudge:"Chief Judge",noFaultsRecorded:"No faults recorded",finalize:"Finalize",finalized:"Finalized",chiefJudgeMode:"Chief Judge Mode",chiefJudgeModeEnabled:"Chief Judge mode enabled",chiefJudgeModeDisabled:"Chief Judge mode disabled",racersWithFaults:"Racers with faults",penaltyMode:"+Time",gateJudges:"Gate Judges",noJudgesConnected:"No gate judges connected",summary:"Summary",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"No faults to export",copiedToClipboard:"Copied to clipboard",gateJudgeCard:"Gate Judge Card",race:"Race",date:"Date",gateJudgeLabel:"Gate Judge",runLabel:"Run",noFaultsEntered:"No faults entered",signature:"Signature",legend:"Legend",missedGateLegend:"Missed",straddlingLegend:"Straddling",bindingLegend:"Binding",gateFaults:"Gate Faults",penaltyLabel:"PENALTY",faultSummaryTitle:"GATE FAULT SUMMARY",faults:"Faults",penalty:"Penalty",sec:"sec",generated:"Generated"},de:{timer:"Timer",results:"Ergebnisse",settings:"Einstellungen",start:"Start",finish:"Ziel",bib:"Startnummer",point:"Punkt",run:"Lauf",run1:"L1",run2:"L2",time:"Zeit erfassen",lastRecorded:"Zuletzt erfasst",status:"Status",noEntries:"Keine Einträge vorhanden",search:"Startnr. suchen...",filter:"Filter",all:"Alle",total:"Gesamt",racers:"Fahrer",finished:"Im Ziel",fastest:"Schnellste",average:"Durchschnitt",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Eintrag löschen",confirmDeleteText:"Möchten Sie diesen Eintrag wirklich löschen?",confirmClearAll:"Alle löschen",clearAllText:"Alle Einträge werden gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.",confirmUndoAdd:"Erfassung rückgängig",confirmUndoAddText:"Der erfasste Eintrag wird gelöscht. Fortfahren?",delete:"Löschen",cancel:"Abbrechen",close:"Schließen",save:"Speichern",edit:"Bearbeiten",undo:"Rückgängig",export:"Exportieren",clearAll:"Alle löschen",selectAll:"Alle auswählen",deleteSelected:"Ausgewählte löschen",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Von Cloud synchronisiert",raceId:"Rennen-ID",invalidRaceId:"Ungültige Rennen-ID. Nur Buchstaben, Zahlen, Bindestriche, Unterstriche.",deviceName:"Zeitnehmer-ID",cloudSync:"Cloud-Sync",syncStatus:"Sync-Status",pendingSync:"ausstehend",saved:"Gespeichert",deleted:"Gelöscht",cleared:"Alle Einträge gelöscht",undone:"Rückgängig gemacht",copied:"In Zwischenablage kopiert",duplicateWarning:"Doppelter Eintrag erkannt",zeroBibWarning:"Startnr. 000 - Eintrag prüfen",exported:"Erfolgreich exportiert",gps:"GPS",gpsActive:"GPS Aktiv",gpsSearching:"GPS wird gesucht...",gpsInactive:"GPS Inaktiv",gpsAccuracy:"Genauigkeit",simpleMode:"Einfacher Modus",fullMode:"Erweiterter Modus",autoIncrement:"Auto-Inkrement",hapticFeedback:"Haptisches Feedback",soundFeedback:"Ton-Feedback",language:"Sprache",backup:"Sichern",restore:"Wiederherstellen",importData:"Daten importieren",exportData:"Daten exportieren",simpleModeDesc:"Vereinfachte Oberfläche für einfache Zeitmessung",cloudSyncDesc:"Mit anderen Geräten synchronisieren",gpsDesc:"GPS für genaue Zeitstempel verwenden",autoIncrementDesc:"Startnummer nach Erfassung erhöhen",photoCaptureDesc:"Foto bei Zeiterfassung aufnehmen",hapticFeedbackDesc:"Vibration bei Aktionen",soundFeedbackDesc:"Akustische Bestätigung",photoCapture:"Foto aufnehmen",photoCaptured:"Foto aufgenommen",photoError:"Foto-Aufnahme fehlgeschlagen",photoSaveFailed:"Foto-Speicherung fehlgeschlagen",viewPhoto:"Foto anzeigen",deletePhoto:"Foto löschen",photoFor:"Foto für Startnr.",noPhotoAvailable:"Kein Foto verfügbar",photoDeleted:"Foto gelöscht",raceChangeTitle:"Rennen wechseln",raceChangeSyncedText:"Es gibt Ergebnisse von einem anderen Rennen. Exportieren oder löschen?",raceChangeUnsyncedText:"Es gibt bestehende Ergebnisse. Behalten oder löschen?",keepResults:"Behalten",version:"Version",devices:"Geräte",entries:"Einträge",selected:"ausgewählt",raceFound:"Rennen gefunden",raceNew:"Neues Rennen",entriesInCloud:"Einträge in der Cloud",photoTooLarge:"Foto zu groß für Sync",syncedEntriesFromCloud:"{count} Einträge aus Cloud synchronisiert",syncedFaultsFromCloud:"{count} Torfehler aus Cloud synchronisiert",crossDeviceDuplicate:"Duplikat: Startnr. {bib} {point} bereits von {device} erfasst",syncPhotos:"Fotos synchronisieren",syncPhotosDesc:"Fotos über Cloud mit anderen Geräten teilen",syncPhotosWarning:"Foto-Sync aktivieren",syncPhotosWarningText:"Aktivierung der Foto-Synchronisierung überträgt folgende Daten:",photosToUpload:"Fotos hochzuladen",photosToDownload:"Fotos herunterzuladen",totalDataVolume:"Gesamtes Datenvolumen",enableSync:"Sync aktivieren",noPhotosToSync:"Keine Fotos zu synchronisieren",admin:"Admin",adminPin:"Rennverwaltungs-PIN",adminPinDesc:"Erforderlich für Verwaltung und Sync",manageRaces:"Rennen verwalten",manageRacesDesc:"Synchronisierte Rennen anzeigen und löschen",manage:"Verwalten",enterAdminPin:"Rennverwaltungs-PIN eingeben",enterPinText:"Geben Sie Ihre PIN ein, um die Rennverwaltung zu öffnen.",enterPinToJoinRace:"Geben Sie Ihre PIN ein, um diesem Rennen beizutreten.",syncRequiresPin:"Sync deaktiviert. Aktivieren Sie Sync und geben Sie die PIN ein.",incorrectPin:"Falsche PIN",verify:"Bestätigen",setPinFirst:"Bitte zuerst Rennverwaltungs-PIN festlegen",pinSaved:"PIN gespeichert",pinCleared:"PIN gelöscht",pinNotSet:"Nicht gesetzt",pinSet:"PIN gesetzt",setPin:"PIN setzen",changePin:"PIN ändern",currentPin:"Aktuelle PIN",newPin:"Neue PIN (4 Ziffern)",confirmPin:"PIN bestätigen",pinMismatch:"PINs stimmen nicht überein",pinFormatError:"PIN muss genau 4 Ziffern haben",loading:"Laden...",noRaces:"Keine aktiven Rennen",refresh:"Aktualisieren",raceDeleted:"Rennen gelöscht",raceDeletedText:"Dieses Rennen wurde von einem Administrator gelöscht.",raceDeletedFor:"Rennen gelöscht:",raceDeletedSuccess:"Rennen gelöscht:",confirmDeleteRace:"Rennen löschen",confirmDeleteRaceText:"Möchten Sie das Rennen wirklich löschen",loadError:"Fehler beim Laden der Rennen",deleteError:"Fehler beim Löschen des Rennens",entry:"Eintrag",device:"Gerät",storageError:"Speichern fehlgeschlagen - Speicher prüfen",storageQuotaError:"Speicher voll! Daten sofort exportieren",storageWarning:"Speicher fast voll",networkError:"Netzwerkfehler - Verbindung prüfen",connectionFailed:"Verbindung fehlgeschlagen",serverUnavailable:"Server nicht erreichbar",rateLimitError:"Zu viele Anfragen - bitte warten",authError:"Authentifizierung fehlgeschlagen",syncFailed:"Synchronisierung fehlgeschlagen",pinSyncFailed:"PIN nicht in Cloud gespeichert",cameraError:"Kamerafehler",cameraPermissionDenied:"Kamerazugriff verweigert",gpsError:"GPS-Fehler",gpsPermissionDenied:"GPS-Zugriff verweigert",gpsUnavailable:"GPS nicht verfügbar",unknownError:"Unbekannter Fehler",onboardingWelcome:"Willkommen bei Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronisierte Zeitmessung für Skirennen",getStarted:"Los geht's",onboardingRole:"Was ist deine Aufgabe?",onboardingRoleDesc:"Wähle aus, wie du beim Rennen hilfst",roleTimerTitle:"Zeitnehmer",roleTimerDesc:"Start- und Zielzeiten erfassen",roleJudgeTitle:"Torrichter",roleJudgeDesc:"Torfehler erfassen",onboardingDeviceName:"Timer benennen",onboardingDeviceNameDesc:"Dieser Name identifiziert dein Gerät beim Synchronisieren",onboardingDeviceNameJudge:"Dein Name",onboardingDeviceNameJudgeDesc:"Dies identifiziert dich als Torrichter",onboardingPhoto:"Foto-Dokumentation",onboardingPhotoDesc:"Automatisch ein Foto bei jeder Zeiterfassung aufnehmen. Nützlich zur Überprüfung von Startnummern und bei Unstimmigkeiten.",enablePhotoCapture:"Foto-Aufnahme aktivieren",photoCaptureLabel:"Foto-Aufnahme",onboardingGates:"Deine Tor-Zuweisung",onboardingGatesDesc:"Gib die Tornummern ein, die du beobachtest. Du kannst dies später ändern.",onboardingRaceSetup:"Rennen beitreten",onboardingRaceSetupDesc:"Gib eine Rennen-ID ein um mit anderen Timern zu synchronisieren",skipForNow:"Vorerst überspringen",onboardingReady:"Bereit zur Zeitmessung!",onboardingReadyJudge:"Bereit zum Torrichtern!",onboardingTip:"Tippe auf den großen blauen Button um Zeiten zu erfassen",onboardingTipJudge:"Tippe auf eine Startnummer um einen Fehler zu erfassen",startTiming:"Zeitmessung starten",startJudging:"Torrichtern starten",continue:"Weiter",deviceNameLabel:"Gerätename",raceIdLabel:"Rennen-ID",syncStatusLabel:"Cloud-Sync",enabled:"Aktiviert",disabled:"Deaktiviert",showTutorial:"Tutorial anzeigen",showTutorialDesc:"Setup-Assistenten erneut starten",show:"Anzeigen",onboardingComplete:"Einrichtung abgeschlossen!",invalidPin:"Ungültiges PIN-Format",recentRaces:"Letzte Rennen",noRecentRaces:"Keine Rennen von heute",errorOccurred:"Ein Fehler ist aufgetreten",errorRecoveryMessage:"Die App hat einen Fehler festgestellt. Sie können diesen Hinweis schließen und fortfahren, oder die App neu laden.",dismiss:"Schließen",reload:"Neu laden",operationFailed:"Vorgang fehlgeschlagen",raceIdPlaceholder:"RENNEN-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Foto für Startnr.",gateJudge:"Torrichter",gateJudgeTab:"Torr",deviceRole:"Geräte-Rolle",deviceRoleDesc:"Timer erfasst Zeiten, Torrichter erfasst Fehler",roleTimer:"Zeitnehmer",roleGateJudge:"Torrichter",gateAssignment:"Tor-Zuweisung",gates:"Tore",gatesFrom:"Von",gatesTo:"Bis",changeGates:"Ändern",otherJudges:"Andere Torrichter:",activeBibs:"Auf der Strecke",noBibsOnCourse:"Keine Fahrer auf der Strecke",recordFault:"Fehler erfassen",faultType:"Fehlerart",faultMG:"Tor verfehlt",faultSTR:"Einfädler",faultBR:"Bindung offen",faultMGShort:"MG",faultSTRShort:"EF",faultBRShort:"AB",faultRecorded:"Fehler erfasst",signalReady:"Bereit",judgeReady:"Bereit für Rennen!",judgeNotReady:"Bereit-Status zurückgesetzt",faultDeleted:"Fehler gelöscht",selectBib:"Startnr. wählen",selectGate:"Tor",gate:"Tor",noFaults:"Keine Fehler erfasst",faultsFor:"Fehler für",faultSummary:"Fehler-Übersicht",penaltyTime:"Strafzeit",faultCount:"Fehler",markOk:"OK markieren",flt:"STR",statusFlt:"Strafzeit",chiefJudge:"Obmann",noFaultsRecorded:"Keine Fehler erfasst",finalize:"Bestätigen",finalized:"Bestätigt",chiefJudgeMode:"Obmann-Ansicht",chiefJudgeModeEnabled:"Obmann-Ansicht aktiviert",chiefJudgeModeDisabled:"Obmann-Ansicht deaktiviert",racersWithFaults:"Fahrer mit Fehlern",penaltyMode:"+Zeit",gateJudges:"Torrichter",noJudgesConnected:"Keine Torrichter verbunden",summary:"Übersicht",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"Keine Fehler zum Exportieren",copiedToClipboard:"In Zwischenablage kopiert",gateJudgeCard:"Torrichterkarte",race:"Rennen",date:"Datum",gateJudgeLabel:"Torrichter",runLabel:"Lauf",noFaultsEntered:"Keine Fehler erfasst",signature:"Unterschrift",legend:"Legende",missedGateLegend:"Verfehlt",straddlingLegend:"Einfädler",bindingLegend:"Bindung",gateFaults:"Torfehler",penaltyLabel:"STRAFZEIT",faultSummaryTitle:"ZUSAMMENFASSUNG TORFEHLER",faults:"Fehler",penalty:"Strafzeit",sec:"Sek",generated:"Erstellt"}};function d(n,e="de"){return mt[e][n]||mt.en[n]||n}const M={CRITICAL:"critical",ERROR:"error",WARNING:"warning",INFO:"info"},ae={CRITICAL:8e3,ERROR:5e3,WARNING:4e3,INFO:3e3};function Fn(n){return`[${n.component}] ${n.operation}`}function $n(n){return n instanceof Error?n.message:typeof n=="string"?n:"Unknown error"}function Ze(n){const e=Fn(n),t=n.error?$n(n.error):"No error details",s={code:n.code,message:t,timestamp:new Date().toISOString(),...n.metadata};switch(n.severity){case M.CRITICAL:case M.ERROR:console.error(`${e}:`,t,s);break;case M.WARNING:console.warn(`${e}:`,t,s);break;case M.INFO:console.log(`${e}:`,t,s);break}if(n.userMessageKey){const i=c.getState().currentLang,a=d(n.userMessageKey,i),r=Mn(n.severity),o=ae[n.severity.toUpperCase()]||ae.ERROR;E(a,r,o)}n.severity===M.CRITICAL&&window.dispatchEvent(new CustomEvent("critical-error",{detail:n}))}function Mn(n){switch(n){case M.CRITICAL:case M.ERROR:return"error";case M.WARNING:return"warning";case M.INFO:return"info";default:return"error"}}function ke(n,e,t,s){Ze({component:n,operation:e,severity:M.ERROR,error:t,userMessageKey:s})}function Ge(n,e,t,s){Ze({component:n,operation:e,severity:M.WARNING,error:t,userMessageKey:s})}function Hn(n,e,t,s){Ze({component:n,operation:e,severity:M.CRITICAL,error:t,userMessageKey:s})}const zn=1e4;class On extends Error{constructor(e,t){super(`Request to ${e} timed out after ${t}ms`),this.name="FetchTimeoutError"}}async function $(n,e={},t=zn){const s=new AbortController,i=setTimeout(()=>s.abort(),t);try{return await fetch(n,{...e,signal:s.signal})}catch(a){throw a instanceof Error&&a.name==="AbortError"?new On(n,t):a}finally{clearTimeout(i)}}const pt={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},Un=.8,le=1280,de=720,yt=200;class Jn{constructor(){f(this,"stream",null);f(this,"videoElement",null);f(this,"canvasElement",null);f(this,"cameraState","stopped");f(this,"visibilityHandler",null);f(this,"pendingVisibilityChange",null);f(this,"previewElement",null);f(this,"ownsVideoElement",!1)}async initialize(){if(this.cameraState==="ready")return!0;if(this.cameraState==="initializing")return!1;this.cameraState="initializing";try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not available");return this.previewElement?(this.videoElement=this.previewElement,this.ownsVideoElement=!1):(this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.ownsVideoElement=!0),this.canvasElement=document.createElement("canvas"),this.canvasElement.width=le,this.canvasElement.height=de,this.stream=await navigator.mediaDevices.getUserMedia(pt),this.videoElement.srcObject=this.stream,await new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))}),this.pendingVisibilityChange==="hidden"?(this.pendingVisibilityChange=null,this.pauseCamera(),!1):(this.cameraState="ready",c.setCameraReady(!0),this.visibilityHandler||(this.visibilityHandler=()=>this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.visibilityHandler)),!0)}catch(e){const t=e instanceof Error?e.message:"Camera initialization failed";return console.error("Camera initialization error:",t),this.cameraState="stopped",c.setCameraReady(!1,t),!1}}handleVisibilityChange(){document.hidden?this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange="hidden":this.cameraState==="ready"&&this.pauseCamera():this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange=null:this.cameraState==="paused"&&this.reinitializeCamera()}pauseCamera(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.videoElement&&(this.videoElement.srcObject=null)),this.cameraState="paused",c.setCameraReady(!1)}async reinitializeCamera(){if(this.cameraState!=="resuming"){this.cameraState="resuming";try{if(this.videoElement||(this.previewElement?(this.videoElement=this.previewElement,this.ownsVideoElement=!1):(this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.ownsVideoElement=!0)),this.stream=await navigator.mediaDevices.getUserMedia(pt),this.videoElement.srcObject=this.stream,await new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))}),this.pendingVisibilityChange==="hidden"){this.pendingVisibilityChange=null,this.pauseCamera();return}this.cameraState="ready",c.setCameraReady(!0)}catch(e){console.error("Failed to reinitialize camera:",e),this.cameraState="stopped"}}}async capturePhoto(){if(this.cameraState!=="ready"||!this.videoElement||!this.canvasElement)return console.warn("Camera not ready for capture"),null;try{const e=this.canvasElement.getContext("2d");if(!e)throw new Error("Could not get canvas context");const t=this.videoElement.videoWidth,s=this.videoElement.videoHeight;let i=t,a=s;if(i>le){const u=le/i;i=le,a=Math.round(a*u)}if(a>de){const u=de/a;a=de,i=Math.round(i*u)}this.canvasElement.width=i,this.canvasElement.height=a,e.drawImage(this.videoElement,0,0,i,a);const r=new Date().toISOString();e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,a-30,i,30),e.fillStyle="#ffffff",e.font="14px monospace",e.fillText(r,10,a-10);const l=this.canvasElement.toDataURL("image/jpeg",Un).split(",")[1],h=Math.round(l.length/1024);if(h>yt){const u=new Error(`Photo too large (${h}KB > ${yt}KB limit)`);throw u.name="PhotoTooLargeError",u}return l}catch(e){return console.error("Photo capture error:",e),null}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null,this.ownsVideoElement&&(this.videoElement.remove(),this.videoElement=null)),this.canvasElement&&(this.canvasElement=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.pendingVisibilityChange=null,this.cameraState="stopped",c.setCameraReady(!1)}isReady(){return this.cameraState==="ready"}setPreviewElement(e){if(this.previewElement=e,!e){this.videoElement&&!this.ownsVideoElement&&(this.videoElement.srcObject=null,this.videoElement=null);return}this.videoElement!==e&&(this.videoElement&&this.ownsVideoElement&&this.videoElement.remove(),this.videoElement=e,this.ownsVideoElement=!1),this.stream&&(this.videoElement.srcObject=this.stream,this.videoElement.play().catch(()=>null))}getVideoElement(){return this.videoElement}getError(){return c.getState().cameraError}async toggle(e){return e?this.initialize():(this.stop(),!0)}}const j=new Jn;async function Vn(){return!c.getState().settings.photoCapture||!j.isReady()&&!await j.initialize()?null:j.capturePhoto()}const qn="ski-timer-photos",Gn=1,x="photos";class _n{constructor(){f(this,"db",null);f(this,"initPromise",null);f(this,"saveQueue",[]);f(this,"isProcessingQueue",!1)}async initialize(){return this.initPromise?this.initPromise:(this.initPromise=new Promise(e=>{if(!window.indexedDB){console.warn("IndexedDB not supported - photo storage disabled"),e(!1);return}const t=indexedDB.open(qn,Gn);t.onerror=()=>{console.error("IndexedDB open error:",t.error),e(!1)},t.onsuccess=()=>{this.db=t.result,e(!0)},t.onupgradeneeded=s=>{const i=s.target.result;i.objectStoreNames.contains(x)||i.createObjectStore(x,{keyPath:"entryId"}).createIndex("timestamp","timestamp",{unique:!1})}}),this.initPromise)}async savePhoto(e,t){return new Promise(s=>{this.saveQueue.push({entryId:e,photoBase64:t,resolve:s}),this.processQueue()})}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{for(;this.saveQueue.length>0;){const e=this.saveQueue.shift(),t=await this.doSavePhoto(e.entryId,e.photoBase64);e.resolve(t)}}finally{this.isProcessingQueue=!1}}}async doSavePhoto(e,t){return!this.db&&!await this.initialize()?!1:new Promise(s=>{if(!this.db){s(!1);return}try{const a=this.db.transaction([x],"readwrite").objectStore(x),r={entryId:e,photo:t,timestamp:Date.now()},o=a.put(r);o.onsuccess=()=>{s(!0)},o.onerror=()=>{console.error("Photo save error:",o.error),s(!1)}}catch(i){console.error("Photo save transaction error:",i),s(!1)}})}async getPhoto(e){return!this.db&&!await this.initialize()?null:new Promise(t=>{if(!this.db){t(null);return}try{const a=this.db.transaction([x],"readonly").objectStore(x).get(e);a.onsuccess=()=>{const r=a.result;t((r==null?void 0:r.photo)||null)},a.onerror=()=>{console.error("Photo get error:",a.error),t(null)}}catch(s){console.error("Photo get transaction error:",s),t(null)}})}async deletePhoto(e){return!this.db&&!await this.initialize()?!1:new Promise(t=>{if(!this.db){t(!1);return}try{const a=this.db.transaction([x],"readwrite").objectStore(x).delete(e);a.onsuccess=()=>{t(!0)},a.onerror=()=>{console.error("Photo delete error:",a.error),t(!1)}}catch(s){console.error("Photo delete transaction error:",s),t(!1)}})}async hasPhoto(e){return await this.getPhoto(e)!==null}async clearAll(){return!this.db&&!await this.initialize()?!1:new Promise(e=>{if(!this.db){e(!1);return}try{const i=this.db.transaction([x],"readwrite").objectStore(x).clear();i.onsuccess=()=>{e(!0)},i.onerror=()=>{console.error("Photo clear error:",i.error),e(!1)}}catch(t){console.error("Photo clear transaction error:",t),e(!1)}})}async deletePhotos(e){for(const t of e)await this.deletePhoto(t)}async getStorageUsage(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{used:e.usage||0,quota:e.quota||0}}catch{return null}return null}async getPhotoCount(){return!this.db&&!await this.initialize()?0:new Promise(e=>{if(!this.db){e(0);return}try{const i=this.db.transaction([x],"readonly").objectStore(x).count();i.onsuccess=()=>{e(i.result)},i.onerror=()=>{e(0)}}catch{e(0)}})}close(){this.db&&(this.db.close(),this.db=null,this.initPromise=null)}}const D=new _n,jn=.2,Wn=.1;class Qn{constructor(){f(this,"battery",null);f(this,"isInitialized",!1);f(this,"callbacks",new Set);f(this,"currentStatus",{level:1,charging:!0,batteryLevel:"normal"});f(this,"levelChangeHandler",null);f(this,"chargingChangeHandler",null)}isSupported(){return"getBattery"in navigator}async initialize(){if(this.isInitialized)return!0;if(!this.isSupported())return!1;try{return this.battery=await navigator.getBattery(),this.isInitialized=!0,this.updateStatus(),this.levelChangeHandler=()=>this.updateStatus(),this.chargingChangeHandler=()=>this.updateStatus(),this.battery.addEventListener("levelchange",this.levelChangeHandler),this.battery.addEventListener("chargingchange",this.chargingChangeHandler),!0}catch(e){return console.warn("Failed to initialize battery service:",e),!1}}updateStatus(){if(!this.battery)return;const e=this.battery.level,t=this.battery.charging;let s="normal";t||(e<=Wn?s="critical":e<=jn&&(s="low"));const i={level:e,charging:t,batteryLevel:s},a=this.currentStatus.level!==i.level||this.currentStatus.charging!==i.charging||this.currentStatus.batteryLevel!==i.batteryLevel;this.currentStatus=i,a&&this.notifySubscribers()}notifySubscribers(){for(const e of this.callbacks)try{e(this.currentStatus)}catch(t){console.error("Battery callback error:",t)}}subscribe(e){return this.callbacks.add(e),e(this.currentStatus),()=>{this.callbacks.delete(e)}}getStatus(){return{...this.currentStatus}}isLowBattery(){return this.currentStatus.batteryLevel==="low"||this.currentStatus.batteryLevel==="critical"}isCriticalBattery(){return this.currentStatus.batteryLevel==="critical"}isCharging(){return this.currentStatus.charging}getLevelPercent(){return Math.round(this.currentStatus.level*100)}cleanup(){this.battery&&(this.levelChangeHandler&&(this.battery.removeEventListener("levelchange",this.levelChangeHandler),this.levelChangeHandler=null),this.chargingChangeHandler&&(this.battery.removeEventListener("chargingchange",this.chargingChangeHandler),this.chargingChangeHandler=null),this.battery=null),this.callbacks.clear(),this.isInitialized=!1}}const Se=new Qn,$t="skiTimerRecentRaces",Yn=10;function Mt(){try{const n=localStorage.getItem($t);return n?JSON.parse(n):[]}catch{return[]}}function Ke(n,e,t){try{const s=Mt(),i=n.toLowerCase(),a=s.findIndex(o=>o.raceId.toLowerCase()===i);a>=0?(s[a].lastUpdated=e,t!==void 0&&(s[a].entryCount=t)):s.unshift({raceId:n,createdAt:Date.now(),lastUpdated:e,entryCount:t}),s.sort((o,l)=>l.lastUpdated-o.lastUpdated);const r=s.slice(0,Yn);localStorage.setItem($t,JSON.stringify(r))}catch(s){console.error("Failed to save recent race:",s)}}function Ie(n=5){const e=Mt(),t=new Date;t.setHours(0,0,0,0);const s=t.getTime();return e.filter(i=>i.createdAt>=s||i.lastUpdated>=s).slice(0,n)}const ee="/api/sync",Me="/api/faults",Be="skiTimerAuthToken";function U(){const n=localStorage.getItem(Be);return n?{Authorization:`Bearer ${n}`}:{}}function V(){return!!localStorage.getItem(Be)}function Zn(n){localStorage.setItem(Be,n)}function Ht(){localStorage.removeItem(Be)}async function Xe(n){try{const e=await fetch("/api/auth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:n})}),t=await e.json();return e.ok?t.token?(Zn(t.token),{success:!0,token:t.token,isNewPin:t.isNewPin}):{success:!1,error:"No token received"}:{success:!1,error:t.error||"Authentication failed"}}catch(e){return console.error("Token exchange error:",e),{success:!1,error:"Network error"}}}const vt=5e3,bt=3e4,Kn=5,Xn=2e3,es=1e4,q=8e3,ts=[5e3,1e4,15e3,2e4,3e4],ns=6,Et=[1e4,2e4,3e4,45e3,6e4],St=[3e4,45e3,6e4],ss=3,is=[1e4,15e3,2e4,3e4],as=1e4;class rs{constructor(){f(this,"pollInterval",null);f(this,"queueInterval",null);f(this,"broadcastChannel",null);f(this,"consecutiveErrors",0);f(this,"lastSyncTimestamp",0);f(this,"isProcessingQueue",!1);f(this,"visibilityHandler",null);f(this,"wasPollingBeforeHidden",!1);f(this,"wasQueueProcessingBeforeHidden",!1);f(this,"consecutiveNoChanges",0);f(this,"currentIdleLevel",0);f(this,"currentBatteryLevel","normal");f(this,"batteryUnsubscribe",null);f(this,"isAdjustingInterval",!1);f(this,"isMeteredConnection",!1);f(this,"networkChangeHandler",null);f(this,"otherGateAssignments",[])}initialize(){const e=c.getState();if(!e.settings.sync||!e.raceId){this.cleanup();return}this.initBroadcastChannel(e.raceId),this.startPolling(),this.startQueueProcessor(),this.pushLocalEntries(),this.pushLocalFaults(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(this.wasPollingBeforeHidden=this.pollInterval!==null,this.wasQueueProcessingBeforeHidden=this.queueInterval!==null,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null)):(this.wasPollingBeforeHidden&&this.startPolling(),this.wasQueueProcessingBeforeHidden&&this.startQueueProcessor())},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.visibilityHandler()),this.batteryUnsubscribe||Se.initialize().then(()=>{this.batteryUnsubscribe=Se.subscribe(t=>{const s=this.currentBatteryLevel;this.currentBatteryLevel=t.batteryLevel,s!==t.batteryLevel&&this.pollInterval&&this.applyBatteryAwarePolling()})}),this.initNetworkMonitoring(),c.setSyncStatus("connecting")}initBroadcastChannel(e){try{this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(`ski-timer-${e}`),this.broadcastChannel.onmessage=t=>{const{type:s,data:i}=t.data;if(s==="entry"&&K(i))c.mergeCloudEntries([i]);else if(s==="presence"){const a=i;c.addConnectedDevice(a)}}}catch(t){console.warn("BroadcastChannel not supported:",t)}}broadcastEntry(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"entry",data:e})}catch(t){console.error("Broadcast error:",t)}}broadcastPresence(){const e=c.getState();if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"presence",data:{id:e.deviceId,name:e.deviceName,lastSeen:Date.now()}})}catch(t){console.error("Presence broadcast error:",t)}}initNetworkMonitoring(){const e=navigator.connection;e&&(this.updateNetworkState(e),this.networkChangeHandler||(this.networkChangeHandler=()=>{const t=this.isMeteredConnection;this.updateNetworkState(e),t!==this.isMeteredConnection&&this.pollInterval&&this.applyBatteryAwarePolling()},e.addEventListener("change",this.networkChangeHandler)))}updateNetworkState(e){this.isMeteredConnection=e.saveData===!0||e.type==="cellular"||e.effectiveType==="slow-2g"||e.effectiveType==="2g"}startPolling(){this.pollInterval&&clearInterval(this.pollInterval),this.fetchCloudEntries();const e=this.consecutiveErrors>2?bt:vt;this.pollInterval=setInterval(()=>this.fetchCloudEntries(),e)}getPollingIntervals(){return this.currentBatteryLevel==="critical"?St:this.isMeteredConnection?is:this.currentBatteryLevel==="low"?Et:ts}getIdleThreshold(){return this.currentBatteryLevel==="normal"?ns:ss}getBasePollingInterval(){return this.currentBatteryLevel==="critical"?St[0]:this.isMeteredConnection?as:this.currentBatteryLevel==="low"?Et[0]:vt}applyBatteryAwarePolling(){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{const e=this.getPollingIntervals();this.currentIdleLevel=Math.min(this.currentIdleLevel,e.length-1);let t;this.consecutiveNoChanges<this.getIdleThreshold()?t=this.getBasePollingInterval():t=e[this.currentIdleLevel],this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),t))}finally{this.isAdjustingInterval=!1}}}adjustPollingInterval(e,t=!1){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{if(!e){this.consecutiveErrors++,this.consecutiveErrors>2&&this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),bt));return}this.consecutiveErrors=0;const s=this.getPollingIntervals(),i=this.getIdleThreshold(),a=this.getBasePollingInterval();if(t)this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),a));else if(this.consecutiveNoChanges++,this.consecutiveNoChanges>=i){const r=Math.min(this.currentIdleLevel+1,s.length-1);if(r!==this.currentIdleLevel){this.currentIdleLevel=r;const o=s[this.currentIdleLevel];this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),o))}}}finally{this.isAdjustingInterval=!1}}}resetToFastPolling(){this.consecutiveNoChanges=0,this.currentIdleLevel=0;const e=this.getBasePollingInterval();this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),e))}async processCloudPhotos(e){const t=c.getState(),s=[];for(const i of e)i.photo&&i.photo!=="indexeddb"&&i.photo.length>20?t.settings.syncPhotos?await D.savePhoto(i.id,i.photo)?s.push({...i,photo:"indexeddb"}):(console.warn("Sync: Photo storage failed for entry:",i.id),s.push({...i,photo:void 0})):s.push({...i,photo:void 0}):s.push(i);return s}async fetchCloudEntries(){const e=c.getState();if(!e.settings.sync||!e.raceId)return;const t=e.syncStatus;(t==="connected"||t==="connecting")&&c.setSyncStatus("syncing");try{const s=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),i=await $(`${ee}?${s}`,{headers:U()},q);if(i.status===401){let u;try{u=await i.json()}catch{u={}}if(u.expired){Ht(),c.setSyncStatus("disconnected"),window.dispatchEvent(new CustomEvent("auth-expired",{detail:{message:"Session expired. Please re-enter your PIN."}})),this.cleanup();return}throw new Error(`HTTP ${i.status}: ${u.error||"Unauthorized"}`)}if(!i.ok)throw new Error(`HTTP ${i.status}`);let a;try{a=await i.json()}catch{throw new Error("Invalid response format")}if(!a||typeof a!="object")throw new Error("Invalid data structure");if(a.deleted){window.dispatchEvent(new CustomEvent("race-deleted",{detail:{raceId:e.raceId,deletedAt:a.deletedAt,message:a.message}})),this.cleanup();return}const o=(Array.isArray(a.entries)?a.entries:[]).filter(u=>K(u)?!0:(console.warn("Skipping invalid entry from cloud:",u),!1)),l=Array.isArray(a.deletedIds)?a.deletedIds.filter(u=>typeof u=="string"&&u.length>0):[];c.setSyncStatus("connected"),typeof a.deviceCount=="number"&&c.setCloudDeviceCount(a.deviceCount),typeof a.highestBib=="number"&&c.setCloudHighestBib(a.highestBib);let h=!1;if(l.length>0&&(c.removeDeletedCloudEntries(l),h=!0),o.length>0){const u=await this.processCloudPhotos(o),g=c.mergeCloudEntries(u,l);if(g>0){h=!0;const p=c.getState().currentLang;this.showSyncToast(d("syncedEntriesFromCloud",p).replace("{count}",String(g)))}}this.lastSyncTimestamp=a.lastUpdated||Date.now(),e.raceId&&Ke(e.raceId,this.lastSyncTimestamp,o.length),await this.fetchCloudFaults(),this.adjustPollingInterval(!0,h)}catch(s){console.error("Cloud sync fetch error:",s);const i=s instanceof Error?s.message:"Unknown error";(s instanceof Error?s.name:"")==="FetchTimeoutError"||i.includes("timed out")||i.includes("500")||i.includes("503")?c.setSyncStatus("error"):i.includes("Failed to fetch")||i.includes("NetworkError")?c.setSyncStatus("offline"):c.setSyncStatus("error"),this.adjustPollingInterval(!1)}}async deleteEntryFromCloud(e,t){const s=c.getState();if(!s.settings.sync||!s.raceId)return!1;try{const i=await $(`${ee}?raceId=${encodeURIComponent(s.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json",...U()},body:JSON.stringify({entryId:e,deviceId:t||s.deviceId,deviceName:s.deviceName})},q);if(!i.ok)throw new Error(`HTTP ${i.status}`);return!0}catch(i){return console.error("Cloud sync delete error:",i),!1}}async sendEntryToCloud(e){const t=c.getState();if(!t.settings.sync||!t.raceId)return!1;try{let s={...e};if(t.settings.syncPhotos&&e.photo==="indexeddb"){const a=await D.getPhoto(e.id);a?s={...e,photo:a}:s={...e,photo:void 0}}else e.photo&&(s={...e,photo:void 0});const i=await $(`${ee}?raceId=${encodeURIComponent(t.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json",...U()},body:JSON.stringify({entry:s,deviceId:t.deviceId,deviceName:t.deviceName})},q);if(!i.ok)throw new Error(`HTTP ${i.status}`);try{const a=await i.json(),r=c.getState().currentLang;if(a.photoSkipped&&this.showSyncToast(d("photoTooLarge",r),"warning"),a.crossDeviceDuplicate){const o=a.crossDeviceDuplicate,l=X(o.point,r);this.showSyncToast(d("crossDeviceDuplicate",r).replace("{bib}",o.bib).replace("{point}",l).replace("{device}",o.deviceName),"warning",5e3),window.dispatchEvent(new CustomEvent("cross-device-duplicate",{detail:o}))}typeof a.deviceCount=="number"&&c.setCloudDeviceCount(a.deviceCount),typeof a.highestBib=="number"&&c.setCloudHighestBib(a.highestBib)}catch{}return c.removeFromSyncQueue(e.id),this.resetToFastPolling(),!0}catch(s){return console.error("Cloud sync send error:",s),!1}}async pushLocalEntries(){const e=c.getState();if(!(!e.settings.sync||!e.raceId))for(const t of e.entries)t.deviceId===e.deviceId&&!t.syncedAt&&await this.sendEntryToCloud(t)}startQueueProcessor(){this.queueInterval&&clearInterval(this.queueInterval),this.queueInterval=setInterval(()=>this.processQueue(),es)}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{const e=c.getState();if(!e.settings.sync||!e.raceId||e.syncQueue.length===0)return;const t=Date.now();for(const s of e.syncQueue){if(s.retryCount>=Kn){console.warn("Max retries exceeded for entry:",s.entry.id),c.removeFromSyncQueue(s.entry.id);continue}const i=Xn*Math.pow(2,s.retryCount);if(t-s.lastAttempt<i)continue;await this.sendEntryToCloud(s.entry)||c.updateSyncQueueItem(s.entry.id,{retryCount:s.retryCount+1,lastAttempt:t,error:"Failed to sync"})}}finally{this.isProcessingQueue=!1}}}showSyncToast(e,t="success",s){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:e,type:t,duration:s}}))}cleanup(){if(this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null),this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasPollingBeforeHidden=!1,this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.networkChangeHandler){const e=navigator.connection;e&&e.removeEventListener("change",this.networkChangeHandler),this.networkChangeHandler=null}this.consecutiveErrors=0,this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.currentBatteryLevel="normal",this.isMeteredConnection=!1,c.setSyncStatus("disconnected")}async forceRefresh(){await this.fetchCloudEntries()}getQueueLength(){return c.getState().syncQueue.length}getLastSyncTime(){return this.lastSyncTimestamp}async checkRaceExists(e){if(!e)return{exists:!1,entryCount:0};try{const t=await $(`${ee}?raceId=${encodeURIComponent(e)}&checkOnly=true`,{headers:U()},5e3);if(!t.ok)return{exists:!1,entryCount:0};const s=await t.json();return{exists:s.exists===!0,entryCount:typeof s.entryCount=="number"?s.entryCount:0}}catch(t){return console.error("Check race exists error:",t),{exists:!1,entryCount:0}}}async getPhotoSyncStats(){const e=c.getState();let t=0,s=0,i=0,a=0;for(const r of e.entries)if(r.photo==="indexeddb"&&r.deviceId===e.deviceId){const o=await D.getPhoto(r.id);o&&(t++,s+=o.length)}if(e.settings.sync&&e.raceId)try{const r=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),o=await $(`${ee}?${r}`,{headers:U()},q);if(o.ok){const l=await o.json(),h=Array.isArray(l.entries)?l.entries:[];for(const u of h)if(u.photo&&u.photo!=="indexeddb"&&u.photo.length>20&&u.deviceId!==e.deviceId){const g=e.entries.find(p=>p.id===u.id&&p.deviceId===u.deviceId);(!g||!g.photo)&&(i++,a+=u.photo.length)}}}catch(r){console.warn("Failed to fetch cloud entries for photo stats:",r)}return{uploadCount:t,uploadSize:s,downloadCount:i,downloadSize:a,totalSize:s+a}}async fetchCloudFaults(){const e=c.getState();if(!(!e.settings.sync||!e.raceId))try{const t=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName});e.deviceRole==="gateJudge"&&e.gateAssignment&&(t.set("gateStart",String(e.gateAssignment[0])),t.set("gateEnd",String(e.gateAssignment[1])),t.set("isReady",String(e.isJudgeReady)));const s=await $(`${Me}?${t}`,{headers:U()},q);if(!s.ok){if(s.status===401)return;throw new Error(`HTTP ${s.status}`)}const i=await s.json();if(!i||typeof i!="object")throw new Error("Invalid fault data structure");const a=Array.isArray(i.faults)?i.faults:[],r=Array.isArray(i.deletedIds)?i.deletedIds.filter(o=>typeof o=="string"):[];if(r.length>0&&c.removeDeletedCloudFaults(r),a.length>0){const o=c.mergeFaultsFromCloud(a,r);if(o>0){const l=c.getState().currentLang;this.showSyncToast(d("syncedFaultsFromCloud",l).replace("{count}",String(o)))}}Array.isArray(i.gateAssignments)&&this.updateGateAssignments(i.gateAssignments)}catch(t){console.error("Fault sync fetch error:",t)}}async sendFaultToCloud(e){const t=c.getState();if(!t.settings.sync||!t.raceId)return!1;try{const s=await $(`${Me}?raceId=${encodeURIComponent(t.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json",...U()},body:JSON.stringify({fault:e,deviceId:t.deviceId,deviceName:t.deviceName,gateRange:t.gateAssignment,isReady:t.isJudgeReady})},q);if(!s.ok)throw new Error(`HTTP ${s.status}`);return c.markFaultSynced(e.id),this.resetToFastPolling(),!0}catch(s){return console.error("Fault sync send error:",s),!1}}async deleteFaultFromCloud(e,t){const s=c.getState();if(!s.settings.sync||!s.raceId)return!1;try{const i=await $(`${Me}?raceId=${encodeURIComponent(s.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json",...U()},body:JSON.stringify({faultId:e,deviceId:t||s.deviceId})},q);if(!i.ok)throw new Error(`HTTP ${i.status}`);return!0}catch(i){return console.error("Fault sync delete error:",i),!1}}async pushLocalFaults(){const e=c.getState();if(!(!e.settings.sync||!e.raceId))for(const t of e.faultEntries)t.deviceId===e.deviceId&&!t.syncedAt&&await this.sendFaultToCloud(t)}updateGateAssignments(e){const t=c.getState();this.otherGateAssignments=e.filter(s=>s.deviceId!==t.deviceId)}getOtherGateAssignments(){return this.otherGateAssignments}}const L=new rs;async function os(n){const e=c.getState();e.settings.sync&&e.raceId&&await L.sendFaultToCloud(n)}const He={enableHighAccuracy:!0,timeout:1e4,maximumAge:1e3},cs=10,ls=30;class ds{constructor(){f(this,"watchId",null);f(this,"lastPosition",null);f(this,"visibilityHandler",null);f(this,"wasActiveBeforeHidden",!1)}start(){if(this.watchId!==null)return!0;if(!navigator.geolocation)return console.error("Geolocation not supported"),c.setGpsStatus("inactive"),!1;c.setGpsStatus("searching");try{return this.watchId=navigator.geolocation.watchPosition(e=>this.handlePosition(e),e=>this.handleError(e),He),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(this.wasActiveBeforeHidden=this.watchId!==null,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null,c.setGpsStatus("inactive"))):this.wasActiveBeforeHidden&&(c.setGpsStatus("searching"),this.watchId=navigator.geolocation.watchPosition(e=>this.handlePosition(e),e=>this.handleError(e),He))},document.addEventListener("visibilitychange",this.visibilityHandler)),!0}catch(e){return console.error("Failed to start GPS:",e),c.setGpsStatus("inactive"),!1}}pause(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.wasActiveBeforeHidden=!1,c.setGpsStatus("inactive")}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasActiveBeforeHidden=!1,this.lastPosition=null,c.setGpsStatus("inactive")}handlePosition(e){this.lastPosition=e;const t=e.coords.accuracy;c.setGpsStatus("active",t)}handleError(e){switch(console.error("GPS error:",e.message),e.code){case e.PERMISSION_DENIED:c.setGpsStatus("inactive"),this.stop();break;case e.POSITION_UNAVAILABLE:c.setGpsStatus("searching");break;case e.TIMEOUT:c.setGpsStatus("searching");break}}getPosition(){return this.lastPosition}getCoordinates(){if(this.lastPosition)return{latitude:this.lastPosition.coords.latitude,longitude:this.lastPosition.coords.longitude,accuracy:this.lastPosition.coords.accuracy}}getTimestamp(){var e;return((e=this.lastPosition)==null?void 0:e.timestamp)??null}getAccuracyStatus(){if(!this.lastPosition)return"unknown";const e=this.lastPosition.coords.accuracy;return e<=cs?"good":e<=ls?"fair":"poor"}isActive(){return this.watchId!==null&&this.lastPosition!==null}toggle(e){return e?this.start():(this.stop(),!0)}async requestPosition(){return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{this.lastPosition=t,e(t)},()=>e(null),He)}):null}}const W=new ds;class us{constructor(){f(this,"wakeLock",null);f(this,"isEnabled",!1);f(this,"visibilityHandler",null)}isSupported(){return"wakeLock"in navigator}async enable(){return this.isSupported()?this.isEnabled?!0:(this.isEnabled=!0,this.visibilityHandler||(this.visibilityHandler=()=>{!document.hidden&&this.isEnabled&&!this.wakeLock&&this.requestWakeLock()},document.addEventListener("visibilitychange",this.visibilityHandler)),this.requestWakeLock()):!1}async disable(){this.isEnabled=!1,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),await this.releaseWakeLock()}async requestWakeLock(){if(!this.isSupported()||this.wakeLock)return!!this.wakeLock;try{return this.wakeLock=await navigator.wakeLock.request("screen"),this.wakeLock.addEventListener("release",()=>{this.wakeLock=null}),!0}catch(e){const t=e instanceof Error?e.message:"Unknown error";return console.warn("Wake Lock request failed:",t),this.wakeLock=null,!1}}async releaseWakeLock(){if(this.wakeLock){try{await this.wakeLock.release()}catch(e){console.warn("Wake Lock release error:",e)}this.wakeLock=null}}isActive(){return this.wakeLock!==null}isWakeLockEnabled(){return this.isEnabled}}const we=new us;let ze=null;function zt(){if(!ze)try{ze=new(window.AudioContext||window.webkitAudioContext)}catch(n){return console.warn("AudioContext not available:",n),null}return ze}function oe(n){if(c.getState().settings.haptic&&navigator.vibrate)try{navigator.vibrate(n)}catch(t){console.warn("Vibration failed:",t)}}function Pe(n=880,e=100){if(!c.getState().settings.sound)return;const s=zt();if(s)try{const i=s.createOscillator(),a=s.createGain();i.connect(a),a.connect(s.destination),i.frequency.value=n,i.type="sine",a.gain.setValueAtTime(.3,s.currentTime),a.gain.exponentialRampToValueAtTime(.01,s.currentTime+e/1e3),i.start(s.currentTime),i.stop(s.currentTime+e/1e3)}catch(i){console.warn("Sound playback failed:",i)}}function z(){oe(20),Pe(880,100)}function P(){oe([50,50,50]),Pe(440,200)}function S(){oe(10)}function et(){oe([30,30,30]),Pe(330,150)}function Ot(){oe([20,20]),Pe(660,100)}async function It(){const n=zt();if(n&&n.state==="suspended")try{await n.resume()}catch(e){console.warn("Failed to resume audio:",e)}}const wt=0,gs=1,hs=3;class fs{constructor(e){f(this,"container");f(this,"timeElement");f(this,"dateElement");f(this,"dateRow");f(this,"lastTimeStr","");f(this,"animationId",null);f(this,"isRunning",!1);f(this,"visibilityHandler",null);f(this,"frameSkipCount",wt);f(this,"currentFrame",0);f(this,"batteryUnsubscribe",null);f(this,"tick",()=>{if(this.isRunning)try{if(this.currentFrame++,this.frameSkipCount===0||this.currentFrame%(this.frameSkipCount+1)===0){const t=new Date,s=Ft(t);if(s!==this.lastTimeStr&&(this.updateDigits(s),this.lastTimeStr=s),t.getSeconds()===0||!this.dateElement.textContent){const a=c.getState();this.dateElement.textContent=xn(t,a.currentLang)}}this.animationId=requestAnimationFrame(this.tick)}catch(e){console.error("Clock tick error:",e);try{this.animationId=requestAnimationFrame(this.tick)}catch(t){console.error("Clock RAF scheduling failed:",t),setTimeout(()=>{this.isRunning&&this.tick()},16)}}});this.container=e,this.container.innerHTML="",this.timeElement=this.createTimeElement(),this.dateRow=this.createDateRow(),this.dateElement=this.dateRow.querySelector(".clock-date"),this.container.appendChild(this.timeElement),this.container.appendChild(this.dateRow),this.moveTimingPointsToDateRow()}moveTimingPointsToDateRow(){const e=document.querySelector(".timing-controls");e&&this.dateRow&&this.dateRow.appendChild(e)}createTimeElement(){const e=document.createElement("div");e.className="clock-time",e.setAttribute("role","timer"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Current time"),e.style.cssText=`
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(32px, 10vw, 48px);
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    `;for(let t=0;t<12;t++){const s=document.createElement("span");s.className="clock-digit",s.dataset.index=String(t),e.appendChild(s)}return e}createDateRow(){const e=document.createElement("div");e.className="clock-date-row",e.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      padding: 0 8px;
      width: 100%;
    `;const t=document.createElement("div");return t.className="clock-date",t.style.cssText=`
      font-size: 0.875rem;
      color: var(--text-secondary);
    `,e.appendChild(t),e}start(){this.isRunning||(this.isRunning=!0,this.tick(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null):this.isRunning&&this.animationId===null&&this.tick()},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)),this.batteryUnsubscribe||Se.initialize().then(()=>{this.batteryUnsubscribe=Se.subscribe(e=>{this.updateFrameSkipFromBattery(e.batteryLevel)})}))}updateFrameSkipFromBattery(e){switch(this.frameSkipCount,e){case"critical":this.frameSkipCount=hs;break;case"low":this.frameSkipCount=gs;break;default:this.frameSkipCount=wt}}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null)}updateDigits(e){const t=this.timeElement.querySelectorAll(".clock-digit");for(let s=0;s<e.length&&s<t.length;s++){const i=t[s],a=e[s];i.textContent!==a&&(i.textContent=a,i.style.transform="scale(1.02)",requestAnimationFrame(()=>{i.style.transform="scale(1)"}))}}getCurrentTime(){return this.lastTimeStr}getTimestamp(){const e=W.getTimestamp();return e?new Date(e):new Date}destroy(){this.stop(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.container.innerHTML=""}}const G=72,Ct=5,ms=16,ps=100;class ys{constructor(e){f(this,"container");f(this,"scrollContainer");f(this,"contentContainer");f(this,"entries",[]);f(this,"filteredItems",[]);f(this,"visibleItems",new Map);f(this,"scrollTop",0);f(this,"containerHeight",0);f(this,"options");f(this,"unsubscribe",null);f(this,"resizeObserver",null);f(this,"scrollHandler",null);f(this,"scrollDebounceTimeout",null);f(this,"resizeDebounceTimeout",null);f(this,"isPaused",!1);f(this,"needsRefreshOnResume",!1);this.options=e,this.container=e.container,this.scrollContainer=document.createElement("div"),this.scrollContainer.className="virtual-scroll-container",this.scrollContainer.style.cssText=`
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    `,this.contentContainer=document.createElement("div"),this.contentContainer.className="virtual-scroll-content",this.contentContainer.style.position="relative",this.scrollContainer.appendChild(this.contentContainer),this.container.appendChild(this.scrollContainer),this.scrollHandler=()=>{this.scrollDebounceTimeout!==null&&clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=setTimeout(()=>{this.scrollDebounceTimeout=null;try{this.onScroll()}catch(t){console.error("VirtualList scroll error:",t)}},ms)},this.scrollContainer.addEventListener("scroll",this.scrollHandler,{passive:!0}),this.resizeObserver=new ResizeObserver(()=>{this.resizeDebounceTimeout!==null&&clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=setTimeout(()=>{this.resizeDebounceTimeout=null;try{this.containerHeight=this.scrollContainer.clientHeight,this.render()}catch(t){console.error("VirtualList resize error:",t)}},ps)}),this.resizeObserver.observe(this.scrollContainer),this.unsubscribe=c.subscribe((t,s)=>{(s.includes("entries")||s.includes("selectedEntries")||s.includes("faultEntries"))&&this.setEntries(t.entries)}),this.containerHeight=this.scrollContainer.clientHeight}setEntries(e){for(const t of e){const s=this.entries.find(i=>i.id===t.id);if(s&&(s.bib!==t.bib||s.point!==t.point||s.status!==t.status||s.photo!==t.photo)){const a=this.visibleItems.get(t.id);a&&(a.remove(),this.visibleItems.delete(t.id))}}this.entries=e,this.applyFilters()}applyFilters(e,t,s){var h;const i=c.getState();let a=[...this.entries];if(e){const u=e.toLowerCase();a=a.filter(g=>{var p;return g.bib.toLowerCase().includes(u)||((p=g.deviceName)==null?void 0:p.toLowerCase().includes(u))})}t&&t!=="all"&&(a=a.filter(u=>u.point===t)),s&&s!=="all"&&(a=a.filter(u=>u.status===s));const r=a.map(u=>({id:u.id,type:"entry",bib:u.bib,run:u.run??1,timestamp:u.timestamp,entry:u,deviceName:u.deviceName})),o=new Map;for(const u of i.faultEntries){const g=`${u.bib}-${u.run}`;o.has(g)||o.set(g,[]),o.get(g).push(u)}const l=new Set(this.entries.filter(u=>u.point==="F").map(u=>`${u.bib}-${u.run??1}`));for(const[u,g]of o)if(!l.has(u)){const[p,v]=u.split("-"),b=parseInt(v,10),m=g.reduce((y,I)=>new Date(y.timestamp)>new Date(I.timestamp)?y:I);if(e){const y=e.toLowerCase();if(!p.toLowerCase().includes(y)&&!((h=m.deviceName)!=null&&h.toLowerCase().includes(y)))continue}if(t&&t!=="all"||s&&s!=="all"&&s!=="dsq"&&s!=="flt")continue;r.push({id:`fault-${u}`,type:"fault",bib:p,run:b,timestamp:m.timestamp,faults:g,deviceName:m.deviceName})}r.sort((u,g)=>{const p=parseInt(u.bib,10)||0;return(parseInt(g.bib,10)||0)-p}),this.filteredItems=r,this.updateContentHeight(),this.render()}updateContentHeight(){const e=this.filteredItems.length*G;this.contentContainer.style.height=`${e}px`}onScroll(){this.scrollTop=this.scrollContainer.scrollTop,this.render()}render(){if(this.filteredItems.length===0){this.renderEmpty();return}const e=this.contentContainer.querySelector(".empty-state");e&&e.remove();const t=Math.max(0,Math.floor(this.scrollTop/G)-Ct),s=Math.min(this.filteredItems.length,Math.ceil((this.scrollTop+this.containerHeight)/G)+Ct),i=c.getState(),a=new Set;for(let r=t;r<s;r++){const o=this.filteredItems[r];a.add(o.id);let l=this.visibleItems.get(o.id);const h=o.entry?i.selectedEntries.has(o.entry.id):!1;l||(l=o.type==="entry"&&o.entry?this.createItem(o.entry):this.createFaultItem(o),this.visibleItems.set(o.id,l),this.contentContainer.appendChild(l)),l.style.transform=`translateY(${r*G}px)`,o.type==="entry"&&l.classList.toggle("selected",h)}for(const[r,o]of this.visibleItems)a.has(r)||(o.remove(),this.visibleItems.delete(r))}createItem(e){const t=document.createElement("div");t.className="result-item",t.setAttribute("role","listitem"),t.setAttribute("data-entry-id",e.id),t.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${G}px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 12px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    `;const s=new Date(e.timestamp),i=Ft(s),a=ft(e.bib||"---"),r=c.getState(),o=r.currentLang,l=Nn(e.point),h=X(e.point,o),u=e.run??1,g=ie(u),p=Ee(u,o),v=e.point==="F"?r.faultEntries.filter(T=>T.bib===e.bib&&T.run===u):[],m=v.length>0?`
      <span class="result-fault-badge" title="${v.map(T=>`T${T.gateNumber} (${T.faultType})`).join(", ")}" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">
        ${v.length>1?`${v.length}× FLT`:`T${v[0].gateNumber}`}
      </span>
    `:"";t.innerHTML=`
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 50px;">
        ${F(a)}
      </div>
      <div class="result-point" style="padding: 4px 8px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; background: ${l}20; color: ${l};">
        ${F(h)}
      </div>
      <span class="result-run" data-advanced style="padding: 4px 8px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; background: ${g}20; color: ${g};">${F(p)}</span>
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
        <div class="result-time" style="font-family: 'JetBrains Mono', monospace; color: var(--text-secondary); font-size: 0.875rem;">
          ${F(i)}
        </div>
        ${e.deviceName?`
          <div class="result-device" style="font-size: 0.7rem; color: var(--text-tertiary);">
            ${F(e.deviceName)}
          </div>
        `:""}
      </div>
      ${m}
      ${e.status!=="ok"?`
        <span class="result-status" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--error); color: white;">
          ${F(e.status.toUpperCase())}
        </span>
      `:""}
      ${e.photo?`
        <button class="result-photo-btn" aria-label="View photo" style="background: none; border: none; color: var(--primary); padding: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/>
            <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
          </svg>
        </button>
      `:""}
      <button class="result-delete" aria-label="Delete entry" style="background: none; border: none; color: var(--error); padding: 8px; cursor: pointer; opacity: 0.7;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    `,t.querySelector(".result-delete").addEventListener("click",T=>{var R,w;T.stopPropagation(),(w=(R=this.options).onItemDelete)==null||w.call(R,e)});const I=t.querySelector(".result-photo-btn");return I&&I.addEventListener("click",T=>{var R,w;T.stopPropagation(),(w=(R=this.options).onViewPhoto)==null||w.call(R,e)}),t.addEventListener("click",T=>{var R,w;(w=(R=this.options).onItemClick)==null||w.call(R,e,T)}),t.addEventListener("touchstart",()=>{t.style.background="var(--surface-elevated)"},{passive:!0}),t.addEventListener("touchend",()=>{t.style.background="var(--surface)"},{passive:!0}),t}createFaultItem(e){var b;const t=document.createElement("div");t.className="result-item fault-only-item",t.setAttribute("role","listitem"),t.setAttribute("data-fault-id",e.id),t.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${G}px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 12px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      border-left: 3px solid var(--warning);
    `;const s=ft(e.bib||"---"),i=c.getState(),a=i.currentLang,r=e.run,o=ie(r),l=Ee(r,a),h=e.faults||[],u=h.sort((m,y)=>m.gateNumber-y.gateNumber).map(m=>`T${m.gateNumber} (${m.faultType})`).join(", "),g=`
      <span class="result-fault-badge" title="${u}" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">
        ${h.length>1?`${h.length}× FLT`:`T${((b=h[0])==null?void 0:b.gateNumber)||"?"}`}
      </span>
    `,p=i.usePenaltyMode?d("flt",a):"DSQ",v=i.usePenaltyMode?"var(--warning)":"var(--error)";return t.innerHTML=`
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 50px;">
        ${F(s)}
      </div>
      <div class="result-point" style="padding: 4px 8px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; background: var(--warning)20; color: var(--warning);">
        ${d("gate",a)}
      </div>
      <span class="result-run" data-advanced style="padding: 4px 8px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; background: ${o}20; color: ${o};">${F(l)}</span>
      <div class="result-info" style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
        <div class="result-fault-details" style="font-size: 0.8rem; color: var(--text-secondary);">
          ${F(u)}
        </div>
        ${e.deviceName?`
          <div class="result-device" style="font-size: 0.7rem; color: var(--text-tertiary);">
            ${F(e.deviceName)}
          </div>
        `:""}
      </div>
      ${g}
      <span class="result-status" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: ${v}; color: ${v==="var(--warning)"?"#000":"white"};">
        ${F(p)}
      </span>
    `,t.addEventListener("touchstart",()=>{t.style.background="var(--surface-elevated)"},{passive:!0}),t.addEventListener("touchend",()=>{t.style.background="var(--surface)"},{passive:!0}),t}renderEmpty(){for(const t of this.visibleItems.values())t.remove();this.visibleItems.clear();const e=c.getState();this.contentContainer.innerHTML=`
      <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: var(--text-secondary);">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 16px; opacity: 0.5;">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <span id="empty-state-text">${d("noEntries",e.currentLang)}</span>
      </div>
    `}scrollToTop(){this.scrollContainer.scrollTo({top:0,behavior:"smooth"})}scrollToEntry(e){const t=this.filteredItems.findIndex(s=>s.id===e);if(t!==-1){const s=t*G;this.scrollContainer.scrollTo({top:s,behavior:"smooth"})}}getVisibleCount(){return this.filteredItems.length}pause(){this.isPaused||(this.isPaused=!0,this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.resizeObserver&&this.resizeObserver.disconnect(),this.scrollDebounceTimeout!==null&&(clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=null),this.resizeDebounceTimeout!==null&&(clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=null),this.scrollHandler&&this.scrollContainer.removeEventListener("scroll",this.scrollHandler))}resume(){this.isPaused&&(this.isPaused=!1,this.unsubscribe||(this.unsubscribe=c.subscribe((e,t)=>{(t.includes("entries")||t.includes("selectedEntries")||t.includes("faultEntries"))&&(this.isPaused?this.needsRefreshOnResume=!0:this.setEntries(e.entries))})),this.resizeObserver&&this.resizeObserver.observe(this.scrollContainer),this.scrollHandler&&this.scrollContainer.addEventListener("scroll",this.scrollHandler,{passive:!0}),this.needsRefreshOnResume&&(this.needsRefreshOnResume=!1,this.setEntries(c.getState().entries)),this.containerHeight=this.scrollContainer.clientHeight,this.render())}isPausedState(){return this.isPaused}destroy(){this.unsubscribe&&(this.unsubscribe(),this.unsubscribe=null),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.scrollDebounceTimeout!==null&&(clearTimeout(this.scrollDebounceTimeout),this.scrollDebounceTimeout=null),this.resizeDebounceTimeout!==null&&(clearTimeout(this.resizeDebounceTimeout),this.resizeDebounceTimeout=null),this.scrollHandler&&(this.scrollContainer.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null),this.visibleItems.clear(),this.container.innerHTML=""}}const vs=3e3;class bs{constructor(){f(this,"container");f(this,"queue",[]);f(this,"isShowing",!1);f(this,"toastEventListener");this.container=this.createContainer(),document.body.appendChild(this.container),this.toastEventListener=e=>{this.show(e.detail.message,{type:e.detail.type,duration:e.detail.duration})},window.addEventListener("show-toast",this.toastEventListener)}createContainer(){const e=document.createElement("div");return e.id="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.style.cssText=`
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    `,e}show(e,t={}){this.queue.push({message:e,options:t}),this.isShowing||this.processQueue()}processQueue(){if(this.queue.length===0){this.isShowing=!1;return}this.isShowing=!0;const{message:e,options:t}=this.queue.shift(),s=t.duration||vs,i=t.type||"info",a=this.createToast(e,i);this.container.appendChild(a),requestAnimationFrame(()=>{a.style.opacity="1",a.style.transform="translateY(0)"}),setTimeout(()=>{a.style.opacity="0",a.style.transform="translateY(10px)",setTimeout(()=>{a.remove(),this.processQueue()},200)},s)}createToast(e,t){const s=document.createElement("div");s.className=`toast toast-${t}`;const i={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--primary)"},a={success:'<path d="M20 6L9 17l-5-5"/>',error:'<path d="M18 6L6 18M6 6l12 12"/>',warning:'<path d="M12 9v4M12 17h.01"/>',info:'<path d="M12 16v-4M12 8h.01"/>'};return s.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border-left: 3px solid ${i[t]};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 0.875rem;
      color: var(--text-primary);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: auto;
      max-width: 90vw;
    `,s.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${i[t]}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        ${a[t]}
      </svg>
      <span>${this.escapeHtml(e)}</span>
    `,s}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}clear(){this.queue=[],this.container.innerHTML="",this.isShowing=!1}destroy(){window.removeEventListener("show-toast",this.toastEventListener),this.clear(),this.container.remove()}}let Q=null;function Ut(){return Q||(Q=new bs),Q}function E(n,e="info",t){Ut().show(n,{type:e,duration:t})}function Es(){Q&&(Q.destroy(),Q=null)}const ue=80,Tt=2.5;class Ss{constructor(e){f(this,"container");f(this,"indicator");f(this,"onRefresh");f(this,"startY",0);f(this,"currentY",0);f(this,"isPulling",!1);f(this,"isRefreshing",!1);f(this,"scrollableParent",null);f(this,"onTouchStart",e=>{var s;this.isRefreshing||(((s=this.scrollableParent)==null?void 0:s.scrollTop)??0)>0||(this.startY=e.touches[0].clientY,this.isPulling=!0)});f(this,"onTouchMove",e=>{var t;if(!(!this.isPulling||this.isRefreshing))try{if((((t=this.scrollableParent)==null?void 0:t.scrollTop)??0)>0){this.isPulling=!1;return}this.currentY=e.touches[0].clientY;const i=(this.currentY-this.startY)/Tt;i>0&&(e.preventDefault(),this.updateIndicator(i))}catch(s){console.error("PullToRefresh move error:",s),this.isPulling=!1,this.resetIndicator()}});f(this,"onTouchEnd",async()=>{if(!this.isPulling||this.isRefreshing)return;const e=(this.currentY-this.startY)/Tt;this.isPulling=!1,e>=ue?(this.isRefreshing=!0,await this.triggerRefresh()):this.resetIndicator()});this.container=e.container,this.onRefresh=e.onRefresh,this.indicator=this.createIndicator(),this.container.insertBefore(this.indicator,this.container.firstChild),this.scrollableParent=this.findScrollableParent(this.container),this.bindEvents()}createIndicator(){const e=document.createElement("div");e.className="pull-indicator",e.style.cssText=`
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: transform 0.2s;
      pointer-events: none;
      z-index: 100;
    `,e.innerHTML=`
      <div class="pull-indicator-content" style="display: flex; align-items: center; gap: 8px;">
        <svg class="pull-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
        <span class="pull-text">Pull to refresh</span>
      </div>
      <div class="pull-spinner" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      </div>
    `;const t=document.createElement("style");return t.textContent=`
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(t),e}findScrollableParent(e){let t=e.parentElement;for(;t;){const s=getComputedStyle(t);if(s.overflowY==="auto"||s.overflowY==="scroll")return t;t=t.parentElement}return null}bindEvents(){this.container.addEventListener("touchstart",this.onTouchStart,{passive:!0}),this.container.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.container.addEventListener("touchend",this.onTouchEnd,{passive:!0})}updateIndicator(e){const t=Math.min(e,ue*1.5);this.indicator.style.transform=`translateY(${t}px)`;const s=Math.min(e/ue,1),i=this.indicator.querySelector(".pull-icon"),a=this.indicator.querySelector(".pull-text");i&&(i.style.transform=`rotate(${s*180}deg)`),a&&(a.textContent=s>=1?"Release to refresh":"Pull to refresh")}async triggerRefresh(){const e=this.indicator.querySelector(".pull-indicator-content"),t=this.indicator.querySelector(".pull-spinner");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.indicator.style.transform=`translateY(${ue}px)`;try{await this.onRefresh()}catch(s){console.error("PullToRefresh callback error:",s)}finally{this.isRefreshing=!1,e&&(e.style.display="flex"),t&&(t.style.display="none"),this.resetIndicator()}}resetIndicator(){this.indicator.style.transform="translateY(0)";const e=this.indicator.querySelector(".pull-icon");e&&(e.style.transform="rotate(0deg)")}destroy(){this.container.removeEventListener("touchstart",this.onTouchStart),this.container.removeEventListener("touchmove",this.onTouchMove),this.container.removeEventListener("touchend",this.onTouchEnd),this.indicator.remove()}}function Is(n){const e=n.entryCount!==void 0?`${n.entryCount} entries`:"",t=F(n.raceId);return`
    <div class="recent-race-item" data-race-id="${t}">
      <span class="recent-race-id">${t}</span>
      <span class="recent-race-meta">${e}</span>
    </div>
  `}function Jt(n){return n.map(Is).join("")}function Vt(n,e,t){n.querySelectorAll(".recent-race-item").forEach((s,i)=>{s.addEventListener("click",()=>{const a=e[i];a&&t(a)})})}function qt(n){const e=n.currentView==="timer";e&&n.settings.gps?W.start():n.settings.gps?W.pause():W.stop(),e&&n.settings.photoCapture?j.initialize():j.stop()}var ws="@vercel/speed-insights",Cs="1.3.1",Ts=()=>{window.si||(window.si=function(...e){(window.siq=window.siq||[]).push(e)})};function Ls(){return typeof window<"u"}function Rs(){try{const n="production"}catch{}return"production"}function Gt(){return Rs()==="development"}function As(n){return n.scriptSrc?n.scriptSrc:Gt()?"https://va.vercel-scripts.com/v1/speed-insights/script.debug.js":n.dsn?"https://va.vercel-scripts.com/v1/speed-insights/script.js":n.basePath?`${n.basePath}/speed-insights/script.js`:"/_vercel/speed-insights/script.js"}function ks(n={}){var e;if(!Ls()||n.route===null)return null;Ts();const t=As(n);if(document.head.querySelector(`script[src*="${t}"]`))return null;n.beforeSend&&((e=window.si)==null||e.call(window,"beforeSend",n.beforeSend));const s=document.createElement("script");return s.src=t,s.defer=!0,s.dataset.sdkn=ws+(n.framework?`/${n.framework}`:""),s.dataset.sdkv=Cs,n.sampleRate&&(s.dataset.sampleRate=n.sampleRate.toString()),n.route&&(s.dataset.route=n.route),n.endpoint?s.dataset.endpoint=n.endpoint:n.basePath&&(s.dataset.endpoint=`${n.basePath}/speed-insights/vitals`),n.dsn&&(s.dataset.dsn=n.dsn),Gt()&&n.debug===!1&&(s.dataset.debug="false"),s.onerror=()=>{console.log(`[Vercel Speed Insights] Failed to load script from ${t}. Please check if any content blockers are enabled and try again.`)},document.head.appendChild(s),{setRoute:i=>{s.dataset.route=i??void 0}}}const Bs=["a[href]","button:not([disabled])","textarea:not([disabled])","input:not([disabled])","select:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(","),Ce=new WeakMap;function _t(n){return Array.from(n.querySelectorAll(Bs)).filter(e=>!e.hasAttribute("disabled")&&e.tabIndex!==-1)}function Ps(n){const e=_t(n);if(e.length>0){e[0].focus();return}n.hasAttribute("tabindex")||n.setAttribute("tabindex","-1"),n.focus()}function Ds(n){const e=t=>{if(t.key==="Escape"){B(n);return}if(t.key!=="Tab")return;const s=_t(n);if(s.length===0){t.preventDefault();return}const i=s[0],a=s[s.length-1],r=document.activeElement;if(t.shiftKey){(!r||r===i||r===n)&&(t.preventDefault(),a.focus());return}r===a&&(t.preventDefault(),i.focus())};n.addEventListener("keydown",e),Ce.set(n,{previousFocus:document.activeElement,keydownHandler:e})}function xs(n){const e=Ce.get(n);if(!e)return;n.removeEventListener("keydown",e.keydownHandler),Ce.delete(n);const t=e.previousFocus;t&&typeof t.focus=="function"&&t.focus()}function B(n){!n||!n.classList.contains("show")||(n.classList.add("closing"),setTimeout(()=>{n.classList.remove("show","closing"),xs(n)},150))}function De(n){if(!n)return;n.hasAttribute("role")||n.setAttribute("role","dialog"),n.setAttribute("aria-modal","true");const e=n.classList.contains("show");n.classList.add("show"),Ce.has(n)||Ds(n),e||setTimeout(()=>Ps(n),0)}const Oe="skiTimerHasCompletedOnboarding";function Ns(n,e){let t=null;return(...s)=>{t&&clearTimeout(t),t=setTimeout(()=>n(...s),e)}}class Fs{constructor(){f(this,"modal");f(this,"currentStep",1);f(this,"totalSteps",6);f(this,"selectedRole","timer");f(this,"updateTranslationsCallback",null);f(this,"recentRacesDocumentHandler",null);this.modal=document.getElementById("onboarding-modal"),this.modal&&this.setupEventListeners()}setUpdateTranslationsCallback(e){this.updateTranslationsCallback=e}shouldShow(){return localStorage.getItem(Oe)!=="true"}show(){if(!this.modal)return;this.currentStep=1,this.selectedRole="timer",this.modal.querySelectorAll(".onboarding-card").forEach((u,g)=>{u.style.display=g===0?"block":"none"});const e=document.getElementById("onboarding-race-id");e&&(e.value="");const t=document.getElementById("onboarding-pin");t&&(t.value="",t.style.display="none");const s=document.getElementById("onboarding-race-status");s&&(s.textContent="",s.className="race-status");const i=document.getElementById("onboarding-sync-toggle");i&&(i.checked=!0);const a=document.getElementById("onboarding-photo-toggle");a&&(a.checked=!1),this.modal.querySelectorAll(".role-card").forEach(u=>{u.classList.toggle("selected",u.getAttribute("data-role")==="timer")});const r=document.getElementById("onboarding-gate-start"),o=document.getElementById("onboarding-gate-end");r&&(r.value="1"),o&&(o.value="10"),this.updateUI(),De(this.modal);const l=document.getElementById("onboarding-device-name");l&&(l.value=c.getState().deviceName);const h=c.getState().currentLang;this.modal.querySelectorAll(".lang-btn").forEach(u=>{const g=u.dataset.lang;u.classList.toggle("selected",g===h)})}reset(){localStorage.removeItem(Oe)}setupEventListeners(){if(!this.modal)return;this.modal.querySelectorAll(".lang-btn").forEach(a=>{a.addEventListener("click",r=>{const o=r.currentTarget,l=o.dataset.lang;l&&(c.setLanguage(l),this.modal.querySelectorAll(".lang-btn").forEach(h=>h.classList.remove("selected")),o.classList.add("selected"),S(),this.updateTranslationsCallback&&this.updateTranslationsCallback(),this.updateOnboardingTranslations())})}),this.modal.querySelectorAll("[data-action]").forEach(a=>{a.addEventListener("click",async r=>{const l=r.currentTarget.dataset.action;l&&(S(),await this.handleAction(l))})});const e=document.getElementById("onboarding-regenerate-name");e&&e.addEventListener("click",()=>{const a=document.getElementById("onboarding-device-name");a&&(a.value=ve(),S())}),this.modal.querySelectorAll(".role-card").forEach(a=>{a.addEventListener("click",()=>{const r=a.getAttribute("data-role");r&&(this.selectedRole=r,this.modal.querySelectorAll(".role-card").forEach(o=>o.classList.remove("selected")),a.classList.add("selected"),S())})});const t=document.getElementById("onboarding-race-id");if(t){const a=Ns(()=>this.checkRaceExists(),500);t.addEventListener("input",()=>{a();const r=document.getElementById("onboarding-pin");r&&(r.style.display=t.value.trim()?"block":"none")})}const s=document.getElementById("onboarding-recent-races-btn"),i=document.getElementById("onboarding-recent-races-dropdown");s&&i&&(s.addEventListener("click",()=>{S(),i.style.display==="none"?this.showRecentRacesDropdown(i,"onboarding-race-id"):i.style.display="none"}),this.recentRacesDocumentHandler||(this.recentRacesDocumentHandler=a=>{const r=a.target;!s.contains(r)&&!i.contains(r)&&(i.style.display="none")},document.addEventListener("click",this.recentRacesDocumentHandler)))}async showRecentRacesDropdown(e,t){const s=c.getState().currentLang;e.innerHTML=`<div class="recent-races-empty">${d("loading",s)}</div>`,e.style.display="block";let i=[];if(V())try{i=await this.fetchRacesFromApi()}catch(a){console.warn("Failed to fetch races from API:",a),i=Ie()}else i=Ie();i.length===0?e.innerHTML=`<div class="recent-races-empty">${d("noRecentRaces",s)}</div>`:(e.innerHTML=Jt(i),Vt(e,i,a=>{this.selectRecentRace(a,t,e)}))}async fetchRacesFromApi(){const e=localStorage.getItem("skiTimerAuthToken");if(!e)return[];const t=await $("/api/admin/races",{headers:{Authorization:`Bearer ${e}`}},5e3);if(!t.ok)throw new Error(`API error: ${t.status}`);const i=(await t.json()).races||[],a=new Date;a.setHours(0,0,0,0);const r=a.getTime(),o=i.filter(l=>l.lastUpdated&&l.lastUpdated>=r).map(l=>({raceId:l.raceId,createdAt:l.lastUpdated||Date.now(),lastUpdated:l.lastUpdated||Date.now(),entryCount:l.entryCount})).slice(0,5);return o.forEach(l=>{Ke(l.raceId,l.lastUpdated,l.entryCount)}),o}selectRecentRace(e,t,s){const i=document.getElementById(t);i&&(i.value=e.raceId,i.dispatchEvent(new Event("input",{bubbles:!0})),S()),s.style.display="none"}updateOnboardingTranslations(){if(!this.modal)return;const e=c.getState().currentLang;this.modal.querySelectorAll("[data-i18n]").forEach(t=>{const s=t.getAttribute("data-i18n");s&&(t.textContent=d(s,e))})}async handleAction(e){switch(e){case"next":await this.validateCurrentStep()&&(await this.saveCurrentStep(),c.forceSave(),this.goToStep(this.currentStep+1));break;case"skip":c.forceSave(),this.goToStep(this.currentStep+1);break;case"finish":this.complete();break}}async validateCurrentStep(){var t,s,i,a;const e=c.getState().currentLang;switch(this.currentStep){case 2:return!0;case 3:return((t=document.getElementById("onboarding-device-name"))==null?void 0:t.value.trim())?!0:(E(d("deviceName",e),"warning"),!1);case 4:return!0;case 5:{const r=(s=document.getElementById("onboarding-race-id"))==null?void 0:s.value.trim(),o=(i=document.getElementById("onboarding-sync-toggle"))==null?void 0:i.checked;if(!r||!o)return!0;const l=(a=document.getElementById("onboarding-pin"))==null?void 0:a.value;return l.length!==4?(E(d("invalidPin",e),"warning"),!1):await this.validatePin(l)}default:return!0}}async saveCurrentStep(){var e,t,s,i,a,r;switch(this.currentStep){case 2:{c.setDeviceRole(this.selectedRole);break}case 3:{const o=(e=document.getElementById("onboarding-device-name"))==null?void 0:e.value.trim();o&&c.setDeviceName(o);break}case 4:{if(this.selectedRole==="gateJudge"){const o=parseInt(((t=document.getElementById("onboarding-gate-start"))==null?void 0:t.value)||"1",10),l=parseInt(((s=document.getElementById("onboarding-gate-end"))==null?void 0:s.value)||"10",10),h=Math.min(o,l),u=Math.max(o,l);c.setGateAssignment([h,u])}else{const o=(i=document.getElementById("onboarding-photo-toggle"))==null?void 0:i.checked;c.updateSettings({photoCapture:o})}break}case 5:{const o=(a=document.getElementById("onboarding-race-id"))==null?void 0:a.value.trim(),l=(r=document.getElementById("onboarding-sync-toggle"))==null?void 0:r.checked;o&&c.setRaceId(o);const h=l&&!!o;c.updateSettings({sync:h}),h&&L.initialize();break}}}goToStep(e){if(!(!this.modal||e<1||e>this.totalSteps)){if(this.modal.querySelectorAll(`[data-step="${this.currentStep}"]`).forEach(t=>{t.style.display="none"}),this.currentStep=e,e===4){const t=this.modal.querySelector(`[data-step="4"][data-path="${this.selectedRole}"]`);t&&(t.style.display="block")}else{const t=this.modal.querySelector(`[data-step="${e}"]:not([data-path])`);t&&(t.style.display="block")}this.updateUIForRole(),this.updateProgressDots(),e===6&&this.showSummary()}}updateUIForRole(){const e=c.getState().currentLang,t=document.getElementById("onboarding-device-name-title"),s=document.getElementById("onboarding-device-name-desc");this.selectedRole==="gateJudge"?(t&&(t.textContent=d("onboardingDeviceNameJudge",e)),s&&(s.textContent=d("onboardingDeviceNameJudgeDesc",e))):(t&&(t.textContent=d("onboardingDeviceName",e)),s&&(s.textContent=d("onboardingDeviceNameDesc",e)));const i=document.getElementById("onboarding-ready-title"),a=document.getElementById("onboarding-ready-tip"),r=document.getElementById("onboarding-finish-btn");this.selectedRole==="gateJudge"?(i&&(i.textContent=d("onboardingReadyJudge",e)),a&&(a.textContent=d("onboardingTipJudge",e)),r&&(r.textContent=d("startJudging",e))):(i&&(i.textContent=d("onboardingReady",e)),a&&(a.textContent=d("onboardingTip",e)),r&&(r.textContent=d("startTiming",e)))}updateProgressDots(){if(!this.modal)return;this.modal.querySelectorAll(".progress-dot").forEach((t,s)=>{t.classList.remove("active","completed"),s+1===this.currentStep?t.classList.add("active"):s+1<this.currentStep&&t.classList.add("completed")})}updateUI(){this.updateProgressDots(),this.updateOnboardingTranslations()}showSummary(){const e=c.getState(),t=e.currentLang,s=document.getElementById("onboarding-summary");if(s){s.innerHTML="";const i=[];if(i.push([d("deviceRole",t),this.selectedRole==="gateJudge"?d("roleJudgeTitle",t):d("roleTimerTitle",t)]),i.push([this.selectedRole==="gateJudge"?d("onboardingDeviceNameJudge",t):d("deviceNameLabel",t),e.deviceName]),this.selectedRole==="gateJudge"){const a=e.gateAssignment;i.push([d("gates",t),a?`${a[0]}–${a[1]}`:"—"])}else i.push([d("photoCaptureLabel",t),e.settings.photoCapture?d("enabled",t):d("disabled",t)]);i.push([d("raceIdLabel",t),e.raceId||"—"]),i.push([d("syncStatusLabel",t),e.settings.sync?d("enabled",t):d("disabled",t)]),i.forEach(([a,r])=>{const o=document.createElement("div");o.className="onboarding-summary-item";const l=document.createElement("span");l.textContent=a;const h=document.createElement("strong");h.textContent=r,o.append(l,h),s.appendChild(o)})}}async checkRaceExists(){const e=document.getElementById("onboarding-race-id"),t=document.getElementById("onboarding-race-status");if(!e||!t)return;const s=e.value.trim();if(!s){t.textContent="",t.className="race-status";return}const i=await L.checkRaceExists(s),a=c.getState().currentLang;i.exists?(t.textContent=`✓ ${d("raceFound",a)} (${i.entryCount} ${d("entries",a)})`,t.className="race-status found"):(t.textContent=`+ ${d("raceNew",a)}`,t.className="race-status new")}async validatePin(e){try{return(await Xe(e)).success}catch{return!0}}complete(){if(c.forceSave(),localStorage.setItem(Oe,"true"),B(this.modal),this.selectedRole==="gateJudge"){c.setView("gateJudge");const e=document.getElementById("gate-judge-tab");e&&(e.style.display="")}else c.setView("timer");z(),E(d("onboardingComplete",c.getState().currentLang),"success"),this.recentRacesDocumentHandler&&(document.removeEventListener("click",this.recentRacesDocumentHandler),this.recentRacesDocumentHandler=null)}}const Te=new Set;function N(n,e,t){const s=e.getBoundingClientRect();let i,a;typeof TouchEvent<"u"&&n instanceof TouchEvent&&n.touches.length>0?(i=n.touches[0].clientX-s.left,a=n.touches[0].clientY-s.top):typeof MouseEvent<"u"&&n instanceof MouseEvent?(i=n.clientX-s.left,a=n.clientY-s.top):(i=s.width/2,a=s.height/2);const r=document.createElement("span");r.classList.add("ripple"),t&&r.classList.add(`ripple-${t}`);const o=Math.max(s.width,s.height)*2;r.style.width=`${o}px`,r.style.height=`${o}px`,r.style.left=`${i-o/2}px`,r.style.top=`${a-o/2}px`,e.appendChild(r);const l=setTimeout(()=>{r.remove(),Te.delete(l)},500);Te.add(l)}function $s(){document.querySelectorAll(".num-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>N(t,e),{passive:!0}),e.addEventListener("mousedown",t=>N(t,e))});const n=document.querySelector(".timestamp-btn");n&&(n.classList.add("ripple-container"),n.addEventListener("touchstart",e=>N(e,n,"primary"),{passive:!0}),n.addEventListener("mousedown",e=>N(e,n,"primary"))),document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.add("ripple-container");const t=e.getAttribute("data-point")==="S";e.addEventListener("touchstart",s=>N(s,e,t?"success":"secondary"),{passive:!0}),e.addEventListener("mousedown",s=>N(s,e,t?"success":"secondary"))}),document.querySelectorAll(".tab-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>N(t,e,"primary"),{passive:!0}),e.addEventListener("mousedown",t=>N(t,e,"primary"))}),document.querySelectorAll(".action-btn").forEach(e=>{e.classList.add("ripple-container"),e.addEventListener("touchstart",t=>N(t,e),{passive:!0}),e.addEventListener("mousedown",t=>N(t,e))}),document.querySelectorAll(".modal-btn").forEach(e=>{e.classList.add("ripple-container");const t=e.classList.contains("primary"),s=e.classList.contains("danger"),i=t?"primary":s?"secondary":void 0;e.addEventListener("touchstart",a=>N(a,e,i),{passive:!0}),e.addEventListener("mousedown",a=>N(a,e,i))})}function Ms(){Te.forEach(n=>clearTimeout(n)),Te.clear()}function Hs(n){const e=new Date(n),t=e.getHours().toString().padStart(2,"0"),s=e.getMinutes().toString().padStart(2,"0"),i=e.getSeconds().toString().padStart(2,"0"),a=Math.round(e.getMilliseconds()/10).toString().padStart(2,"0");return`${t}:${s}:${i},${a}`}function Lt(n){const e=["=","+","-","@","	","\r",`
`];let t=n;return e.some(s=>t.startsWith(s))&&(t=`'${t}`),t.includes('"')&&(t=t.replace(/"/g,'""')),(t.includes(";")||t.includes('"')||t.includes(`
`))&&(t=`"${t}"`),t}function zs(n){return n==="S"?"ST":"FT"}function Ue(n,e){var s;return((s={ok:{en:"OK",de:"OK"},dns:{en:"DNS",de:"DNS"},dnf:{en:"DNF",de:"DNF"},dsq:{en:"DSQ",de:"DSQ"},flt:{en:"FLT",de:"STR"}}[n])==null?void 0:s[e])||n.toUpperCase()}function tt(n,e){var s;return((s={MG:{en:"MG",de:"MG"},STR:{en:"STR",de:"EF"},BR:{en:"BR",de:"AB"}}[n])==null?void 0:s[e])||n}function Os(n,e){return n.length===0?"":n.sort((t,s)=>t.gateNumber-s.gateNumber).map(t=>`T${t.gateNumber}(${tt(t.faultType,e)})`).join(",")}function nt(){const n=c.getState(),e=n.entries,t=n.faultEntries,s=n.currentLang;if(e.length===0){E(d("noEntries",s),"warning");return}const i=[...e].sort((b,m)=>new Date(b.timestamp).getTime()-new Date(m.timestamp).getTime()),a=t.length>0,r=a?"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Torstrafzeit;Torfehler":"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät",o=i.map(b=>{const m=Lt(b.bib),y=b.run??1,I=zs(b.point),T=Hs(b.timestamp),R=Lt(b.deviceName||b.deviceId),w=b.point==="F"?t.filter(ce=>ce.bib===b.bib&&ce.run===y):[];let A;if(b.point==="F"&&w.length>0?A=n.usePenaltyMode?Ue("flt",s):Ue("dsq",s):A=Ue(b.status,s),a){const ce=w.length>0&&n.usePenaltyMode?w.length*n.penaltySeconds:0,En=Os(w,s);return`${m};${y};${I};${T};${A};${R};${ce};${En}`}else return`${m};${y};${I};${T};${A};${R}`}),l=[r,...o].join(`
`),h=new Blob([l],{type:"text/csv;charset=utf-8;"}),u=URL.createObjectURL(h),g=document.createElement("a");g.href=u;const p=new Date().toISOString().split("T")[0],v=n.raceId||"race";g.download=`${v}_${p}.csv`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(u),z(),E(d("exported",s),"success")}function _e(n,e="csv"){const t=new Date().toISOString().split("T")[0];return`${n.replace(/[^a-zA-Z0-9-_]/g,"_")||"race"}_${t}.${e}`}function Us(){const n=c.getState(),e=n.currentLang,t=n.faultEntries,s=n.raceId||"RACE";if(t.length===0){E(d("noFaultsToExport",e),"warning");return}const i=new Map;for(const g of t){const p=`${g.bib}-${g.run}`;i.has(p)||i.set(p,[]),i.get(p).push(g)}const a=[];a.push(`📋 ${d("gateFaults",e)} - ${s}`),a.push("");const r=Array.from(i.entries()).filter(([g])=>g.endsWith("-1")),o=Array.from(i.entries()).filter(([g])=>g.endsWith("-2")),l=(g,p)=>{const[v]=g.split("-"),b=v.padStart(3,"0"),m=p.sort((I,T)=>I.gateNumber-T.gateNumber).map(I=>`T${I.gateNumber}`).join("+"),y=p.map(I=>tt(I.faultType,e)).join(", ");if(n.usePenaltyMode){const I=p.length*n.penaltySeconds;return`#${b}: ${m} (${y}) → +${I}s`}else return`#${b}: ${m} (${y})`};r.length>0&&(a.push(`🏁 ${d("runLabel",e)} 1:`),n.usePenaltyMode?a.push(`🟡 ${d("penaltyLabel",e)}:`):a.push("🔴 DSQ:"),r.sort((g,p)=>parseInt(g[0].split("-")[0])-parseInt(p[0].split("-")[0])).forEach(([g,p])=>{a.push(l(g,p))}),a.push("")),o.length>0&&(a.push(`🏁 ${d("runLabel",e)} 2:`),n.usePenaltyMode?a.push(`🟡 ${d("penaltyLabel",e)}:`):a.push("🔴 DSQ:"),o.sort((g,p)=>parseInt(g[0].split("-")[0])-parseInt(p[0].split("-")[0])).forEach(([g,p])=>{a.push(l(g,p))}),a.push(""));const h=new Date;a.push(`📅 ${h.toLocaleDateString(e==="de"?"de-DE":"en-US")} ${h.toLocaleTimeString(e==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"})}`);const u=a.join(`
`);navigator.clipboard?navigator.clipboard.writeText(u).then(()=>{z(),E(d("copiedToClipboard",e),"success")}).catch(()=>{je(u,_e(`${s}_WhatsApp`,"txt"))}):je(u,_e(`${s}_WhatsApp`,"txt"))}function Js(){const n=c.getState(),e=n.currentLang,t=n.faultEntries,s=n.raceId||"RACE";if(t.length===0){E(d("noFaultsToExport",e),"warning");return}const i=new Map;for(const g of t){const p=`${g.bib}-${g.run}`;i.has(p)||i.set(p,[]),i.get(p).push(g)}const a=[],r="══════════════════════════════════════════════════════",o=Array.from(i.entries()).filter(([g])=>g.endsWith("-1")),l=Array.from(i.entries()).filter(([g])=>g.endsWith("-2")),h=(g,p)=>{g.length!==0&&(a.push(`${d("faultSummaryTitle",e)} - ${d("runLabel",e)} ${p}`),a.push(r),a.push(`${d("bib",e).substring(0,7).padEnd(7)} │ ${d("faults",e).padEnd(16)} │ ${d("penalty",e).padStart(9)} │ Status`),a.push("────────┼──────────────────┼───────────┼────────"),g.sort((v,b)=>parseInt(v[0].split("-")[0])-parseInt(b[0].split("-")[0])).forEach(([v,b])=>{const[m]=v.split("-"),y=m.padStart(5),I=b.sort((w,A)=>w.gateNumber-A.gateNumber).map(w=>`T${w.gateNumber}(${tt(w.faultType,e)})`).join(", ").padEnd(16);let T,R;n.usePenaltyMode?(T=`${b.length*n.penaltySeconds} ${d("sec",e)}`.padStart(9),R=d("flt",e)):(T="-".padStart(9),R="DSQ"),a.push(`  ${y}   │ ${I} │ ${T} │ ${R}`)}),a.push(""))};a.push(`${s} - ${new Date().toLocaleDateString(e==="de"?"de-DE":"en-US")}`),a.push(""),h(o,1),h(l,2),a.push(r),a.push(`${d("generated",e)}: ${new Date().toLocaleString(e==="de"?"de-DE":"en-US")}`);const u=a.join(`
`);je(u,_e(`${s}_${d("summary",e)}`,"txt")),z(),E(d("exported",e),"success")}function je(n,e){const t=new Blob([n],{type:"text/plain;charset=utf-8;"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=e,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}ks();const jt="/api/admin/races",Wt="skiTimerAuthToken";function st(){const n=localStorage.getItem(Wt);return n?{Authorization:`Bearer ${n}`}:{}}async function xe(n){const e=await Xe(n);return e.success&&Ae(),e}let J=null,H=null,_=null,O=null,Y=null,te=null,Je=null,We=0,k=null;function Rt(){const n=document.getElementById("app-version");if(n&&(n.textContent="4.1.0"),Vs(),qs(),Gs(),_s(),js(),Ws(),Xs(),ri(),ci(),pi(),Fi(),$s(),c.subscribe(wi),c.getState().settings.sync&&c.getState().raceId)if(V())L.initialize();else{c.updateSettings({sync:!1});const i=document.getElementById("sync-toggle");i&&(i.checked=!1),setTimeout(()=>{const a=c.getState().currentLang;E(d("syncRequiresPin",a),"info",5e3)},500)}qt(c.getState()),window.addEventListener("race-deleted",fn),window.addEventListener("auth-expired",mn),window.addEventListener("storage-error",pn),window.addEventListener("storage-warning",yn),document.addEventListener("click",It,{once:!0}),document.addEventListener("touchstart",It,{once:!0}),window.addEventListener("beforeunload",Ji),un(),Ci(),c.getState().currentView==="timer"&&we.enable(),_=new Fs,_.setUpdateTranslationsCallback(()=>ct()),_.shouldShow()&&_.show();const s=document.getElementById("show-tutorial-btn");s&&s.addEventListener("click",()=>{_&&(_.reset(),_.show(),S())})}function Vs(){J&&(J.destroy(),J=null);const n=document.getElementById("clock-container");n&&(J=new fs(n),J.start())}function qs(){const n=document.querySelectorAll(".tab-btn");n.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-view");t&&(c.setView(t),S(),n.forEach(s=>{s.setAttribute("aria-selected",s===e?"true":"false")}))})})}function Gs(){const n=document.getElementById("number-pad");n&&n.addEventListener("click",e=>{const s=e.target.closest(".num-btn");if(!s)return;const i=s.getAttribute("data-num"),a=s.getAttribute("data-action");if(i){const r=c.getState();r.bibInput.length<3&&(c.setBibInput(r.bibInput+i),S())}else if(a==="clear")c.setBibInput(""),S();else if(a==="delete"){const r=c.getState();c.setBibInput(r.bibInput.slice(0,-1)),S()}})}function _s(){const n=document.getElementById("timing-points");n&&n.addEventListener("click",e=>{const s=e.target.closest(".timing-point-btn");if(!s)return;const i=s.getAttribute("data-point");i&&(c.setSelectedPoint(i),S(),n.querySelectorAll(".timing-point-btn").forEach(a=>{a.setAttribute("aria-checked",a===s?"true":"false")}))})}function js(){const n=document.getElementById("run-selector");n&&n.addEventListener("click",e=>{const s=e.target.closest(".run-btn");if(!s)return;const i=s.getAttribute("data-run"),a=i?parseInt(i,10):1;c.setSelectedRun(a),S(),n.querySelectorAll(".run-btn").forEach(r=>{r.setAttribute("aria-checked",r===s?"true":"false")})})}function Ws(){const n=document.getElementById("timestamp-btn");n&&(n.addEventListener("click",async()=>{await At()}),document.addEventListener("keydown",e=>{var s;const t=(s=document.activeElement)==null?void 0:s.tagName;e.key==="Enter"&&c.getState().currentView==="timer"&&t!=="INPUT"&&t!=="TEXTAREA"&&(e.preventDefault(),At())}))}async function At(){const n=c.getState();if(n.isRecording)return;const e=new Date().toISOString(),t=W.getCoordinates();c.setRecording(!0);try{const s={id:wn(n.deviceId),bib:n.bibInput?n.bibInput.padStart(3,"0"):"",point:n.selectedPoint,run:n.selectedRun,timestamp:e,status:"ok",deviceId:n.deviceId,deviceName:n.deviceName,gpsCoords:t};if(n.settings.photoCapture){const r=s.id;Vn().then(async o=>{if(o)try{if(!c.getState().entries.some(g=>g.id===r)){console.warn("Entry was deleted before photo could be attached:",r);return}if(await D.savePhoto(r,o))c.updateEntry(r,{photo:"indexeddb"})||(console.warn("Entry deleted during photo save, removing orphaned photo:",r),await D.deletePhoto(r));else{console.warn("Photo save failed for entry:",r);const g=c.getState().currentLang;E(d("photoSaveFailed",g),"warning")}}catch(l){Ge("Camera","photo save/update",l,"photoError")}}).catch(o=>{if(o instanceof Error&&o.name==="PhotoTooLargeError"){const l=c.getState().currentLang;E(d("photoTooLarge",l),"warning")}else Ge("Camera","captureTimingPhoto",o,"photoError")})}const i=s.bib&&n.entries.some(r=>r.bib===s.bib&&r.point===s.point&&(r.run??1)===s.run),a=Zs(s.bib);if(c.addEntry(s),i?(P(),Qs(s)):a?(P(),Ys(s)):(z(),it(s)),L.broadcastEntry(s),n.settings.auto&&n.bibInput){const r=parseInt(n.bibInput,10)+1,o=n.settings.sync&&n.cloudHighestBib>0?Math.max(r,n.cloudHighestBib+1):r;c.setBibInput(String(o))}else n.bibInput&&n.settings.auto||c.setBibInput("");Ks(s)}finally{c.setRecording(!1)}}function it(n){const e=document.getElementById("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-bib"),s=e.querySelector(".confirmation-point"),i=e.querySelector(".confirmation-run"),a=e.querySelector(".confirmation-time"),r=c.getState();if(t&&(t.textContent=n.bib||"---"),s&&(s.textContent=X(n.point,r.currentLang),s.style.color=Re(n.point)),i&&n.run&&(i.textContent=Ee(n.run,r.currentLang),i.style.color=ie(n.run)),a){const o=new Date(n.timestamp);a.textContent=$e(o)}e.dataset.point=n.point,e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},1500)}function Qs(n){const e=document.getElementById("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-duplicate");t&&(t.style.display="flex"),it(n),setTimeout(()=>{t&&(t.style.display="none")},2500)}function Ys(n){const e=document.getElementById("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-zero-bib");t&&(t.style.display="flex"),it(n),setTimeout(()=>{t&&(t.style.display="none")},2500)}function Zs(n){return n?/^0+$/.test(n):!1}function Ks(n){const e=document.getElementById("last-recorded");if(!e)return;const t=e.querySelector(".bib"),s=e.querySelector(".point"),i=e.querySelector(".run"),a=e.querySelector(".time"),r=c.getState();if(t&&(t.textContent=n.bib||"---"),s&&(s.textContent=X(n.point,r.currentLang),s.style.background=`${Re(n.point)}20`,s.style.color=Re(n.point)),i&&n.run&&(i.textContent=Ee(n.run,r.currentLang),i.style.background=`${ie(n.run)}20`,i.style.color=ie(n.run)),a){const o=new Date(n.timestamp);a.textContent=$e(o)}e.classList.add("visible"),e.classList.remove("pulse"),e.offsetWidth,e.classList.add("pulse")}function kt(n,e){return new Promise(t=>{const s=document.getElementById("race-change-modal");if(!s){t("cancel");return}const i=s.querySelector(".modal-title"),a=s.querySelector(".modal-text"),r=document.getElementById("race-change-export-btn"),o=document.getElementById("race-change-delete-btn"),l=document.getElementById("race-change-keep-btn"),h=s.querySelector('[data-action="cancel"]');n==="synced"?(i&&(i.textContent=d("raceChangeTitle",e)),a&&(a.textContent=d("raceChangeSyncedText",e)),r&&(r.style.display=""),l&&(l.style.display="none")):(i&&(i.textContent=d("raceChangeTitle",e)),a&&(a.textContent=d("raceChangeUnsyncedText",e)),r&&(r.style.display="none"),l&&(l.style.display=""));const u=()=>{B(s),r==null||r.removeEventListener("click",g),o==null||o.removeEventListener("click",p),l==null||l.removeEventListener("click",v),h==null||h.removeEventListener("click",b)},g=()=>{u(),t("export")},p=()=>{u(),t("delete")},v=()=>{u(),t("keep")},b=()=>{u(),t("cancel")};r==null||r.addEventListener("click",g),o==null||o.addEventListener("click",p),l==null||l.addEventListener("click",v),h==null||h.addEventListener("click",b),s.classList.add("show")})}function Xs(){const n=document.getElementById("results-list");if(!n)return;H=new ys({container:n,onItemClick:r=>yi(r),onItemDelete:r=>vi(r),onItemSelect:(r,o)=>{c.toggleEntrySelection(r.id)},onViewPhoto:r=>Si(r)});const e=c.getState();H.setEntries(e.entries),Fe();const t=document.querySelector(".results-view");t&&new Ss({container:t,onRefresh:async()=>{await L.forceRefresh(),E(d("syncReceived",c.getState().currentLang),"success")}});const s=document.getElementById("search-input");s&&(O&&(clearTimeout(O),O=null),te&&s.removeEventListener("input",te),te=()=>{O&&clearTimeout(O),O=setTimeout(()=>{Ve()},300)},s.addEventListener("input",te));const i=document.getElementById("filter-point"),a=document.getElementById("filter-status");i&&i.addEventListener("change",Ve),a&&a.addEventListener("change",Ve),ei(),e.currentView!=="results"&&H&&H.pause()}function ei(){const n=document.getElementById("clear-all-btn");n&&n.addEventListener("click",()=>{const i=c.getState();if(i.entries.length===0){E(d("noEntries",i.currentLang),"info");return}he("clearAll")});const e=document.getElementById("undo-btn");e&&e.addEventListener("click",()=>{if(c.canUndo()){const i=c.peekUndo();if(i&&i.type==="ADD_ENTRY")he("undoAdd");else{const a=c.undo();Ot(),E(d("undone",c.getState().currentLang),"success");const r=c.getState();if(a&&a.type==="ADD_ENTRY"&&r.settings.sync&&r.raceId){const o=a.data;L.deleteEntryFromCloud(o.id,o.deviceId)}}}});const t=document.getElementById("export-btn");t&&t.addEventListener("click",nt);const s=document.getElementById("delete-selected-btn");s&&s.addEventListener("click",()=>{c.getState().selectedEntries.size>0&&he("deleteSelected")}),ti()}function ti(){const n=document.getElementById("chief-judge-toggle-btn");n&&(n.addEventListener("click",()=>{c.toggleChiefJudgeView(),ii(),S();const e=c.getState(),t=e.currentLang;E(e.isChiefJudgeView?d("chiefJudgeModeEnabled",t):d("chiefJudgeModeDisabled",t),"info")}),Bt(),c.subscribe((e,t)=>{(t.includes("settings")||t.includes("faultEntries"))&&Bt(),(t.includes("faultEntries")||t.includes("penaltySeconds")||t.includes("usePenaltyMode"))&&e.isChiefJudgeView&&at(),(t.includes("penaltySeconds")||t.includes("usePenaltyMode"))&&Qt(),(t.includes("entries")||t.includes("faultEntries")||t.includes("isJudgeReady"))&&e.isChiefJudgeView&&Yt()}),si(),ni())}function ni(){const n=document.getElementById("export-csv-btn");n&&n.addEventListener("click",()=>{S(),nt()});const e=document.getElementById("export-summary-btn");e&&e.addEventListener("click",()=>{S(),Js()});const t=document.getElementById("export-whatsapp-btn");t&&t.addEventListener("click",()=>{S(),Us()})}function si(){const n=document.getElementById("penalty-mode-toggle");n&&n.addEventListener("click",t=>{const s=t.target.closest(".penalty-mode-btn");if(!s)return;const i=s.getAttribute("data-mode");i==="penalty"?c.setUsePenaltyMode(!0):i==="dsq"&&c.setUsePenaltyMode(!1),S()});const e=document.getElementById("penalty-seconds-selector");e&&e.addEventListener("click",t=>{const s=t.target.closest(".penalty-adj-btn");if(!s)return;const i=s.getAttribute("data-adj"),r=c.getState().penaltySeconds;i==="+1"?c.setPenaltySeconds(r+1):i==="-1"&&c.setPenaltySeconds(r-1),S()}),Qt()}function Qt(){const n=c.getState(),e=document.getElementById("penalty-config-row"),t=document.getElementById("penalty-seconds-value"),s=document.getElementById("penalty-mode-toggle");e&&e.classList.toggle("dsq-mode",!n.usePenaltyMode),t&&(t.textContent=String(n.penaltySeconds)),s&&s.querySelectorAll(".penalty-mode-btn").forEach(a=>{const r=a.getAttribute("data-mode"),o=r==="penalty"&&n.usePenaltyMode||r==="dsq"&&!n.usePenaltyMode;a.classList.toggle("active",o)})}function Bt(){const n=document.getElementById("chief-judge-toggle-row");if(!n)return;const t=c.getState().settings.sync;n.style.display=t?"block":"none"}function ii(){const n=c.getState(),e=document.querySelector(".results-view"),t=document.getElementById("chief-judge-toggle-btn");!e||!t||(t.classList.toggle("active",n.isChiefJudgeView),e.classList.toggle("chief-mode",n.isChiefJudgeView),n.isChiefJudgeView&&(at(),Yt()))}function Yt(){const n=document.getElementById("judges-overview-list"),e=document.getElementById("judges-overview-count"),t=document.getElementById("judges-overview-empty");if(!n||!e)return;const s=L.getOtherGateAssignments(),i=c.getState(),a=[...s];if(i.deviceRole==="gateJudge"&&i.gateAssignment&&a.push({deviceId:i.deviceId,deviceName:i.deviceName,gateStart:i.gateAssignment[0],gateEnd:i.gateAssignment[1],lastSeen:Date.now(),isReady:i.isJudgeReady}),e.textContent=String(a.length),t&&(t.style.display=a.length===0?"block":"none"),n.querySelectorAll(".judge-card").forEach(l=>l.remove()),a.length===0)return;a.sort((l,h)=>l.gateStart-h.gateStart);const o=a.map(l=>`
    <div class="judge-card${l.isReady?" ready":""}">
      <span class="judge-ready-indicator"></span>
      <span class="judge-name" title="${l.deviceName}">${l.deviceName}</span>
      <span class="judge-gates">${l.gateStart}–${l.gateEnd}</span>
    </div>
  `).join("");t?t.insertAdjacentHTML("beforebegin",o):n.innerHTML=o}function at(){const n=document.getElementById("fault-summary-list"),e=document.getElementById("fault-summary-count"),t=document.getElementById("chief-empty-state");if(!n||!e)return;const s=c.getState(),i=s.currentLang,a=s.faultEntries,r=new Map;for(const g of a){const p=`${g.bib}-${g.run}`;r.has(p)||r.set(p,[]),r.get(p).push(g)}if(e.textContent=String(r.size),t&&(t.style.display=r.size===0?"flex":"none"),r.size===0){n.querySelectorAll(".fault-summary-card").forEach(p=>p.remove());return}const o=[],l=Array.from(r.entries()).sort((g,p)=>{const[v]=g,[b]=p,m=parseInt(v.split("-")[0],10)||0,y=parseInt(b.split("-")[0],10)||0;return m-y});for(const[g,p]of l){const[v,b]=g.split("-"),m=parseInt(b,10),y=c.isRacerFinalized(v,m),I=s.usePenaltyMode?p.length*s.penaltySeconds:0;s.usePenaltyMode;const T=p.map(A=>`
      <div class="fault-entry-row">
        <div class="fault-gate-info">
          <span class="fault-gate-num">${d("gate",i)} ${A.gateNumber}</span>
          <span class="fault-type-badge">${Kt(A.faultType,i)}</span>
        </div>
        <span class="fault-judge-name">${A.deviceName}</span>
      </div>
    `).join(""),R=y?`<div class="finalized-badge">
           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
             <path d="M20 6L9 17l-5-5"/>
           </svg>
           ${d("finalized",i)}
         </div>`:`<button class="finalize-btn" data-bib="${v}" data-run="${m}">
           <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
             <path d="M20 6L9 17l-5-5"/>
           </svg>
           ${d("finalize",i)}
         </button>`,w=s.usePenaltyMode?`<span class="fault-card-penalty">+${I}s</span>
         <span class="fault-card-result flt">${d("flt",i)}</span>`:'<span class="fault-card-result dsq">DSQ</span>';o.push(`
      <div class="fault-summary-card${y?" finalized":""}" data-bib="${v}" data-run="${m}">
        <div class="fault-card-header">
          <span class="fault-card-bib">#${v.padStart(3,"0")}</span>
          <div class="fault-card-status">
            ${w}
          </div>
        </div>
        <div class="fault-card-body">
          ${T}
        </div>
        <div class="fault-card-actions">
          ${R}
        </div>
      </div>
    `)}n.querySelectorAll(".fault-summary-card").forEach(g=>g.remove()),t?t.insertAdjacentHTML("beforebegin",o.join("")):n.innerHTML=o.join(""),n.querySelectorAll(".finalize-btn").forEach(g=>{g.addEventListener("click",ai)})}function ai(n){const e=n.currentTarget,t=e.dataset.bib,s=e.dataset.run;if(!t||!s)return;const i=parseInt(s,10);c.finalizeRacer(t,i),z();const a=c.getState();E(`#${t.padStart(3,"0")} ${d("finalized",a.currentLang)}`,"success"),at()}function Ve(){if(!H)return;const n=document.getElementById("search-input"),e=document.getElementById("filter-point"),t=document.getElementById("filter-status");H.applyFilters((n==null?void 0:n.value)||"",(e==null?void 0:e.value)||"all",(t==null?void 0:t.value)||"all"),Fe()}function ri(){const n=document.getElementById("simple-mode-toggle");n&&n.addEventListener("change",()=>{c.updateSettings({simple:n.checked}),un();const m=document.getElementById("admin-section");m&&(m.style.display="block")});const e=document.getElementById("gps-toggle");e&&e.addEventListener("change",()=>{c.updateSettings({gps:e.checked})});const t=document.getElementById("sync-toggle");let s=!1;t&&t.addEventListener("change",async()=>{if(s){t.checked=!t.checked;return}s=!0;try{const m=c.getState();if(t.checked&&m.raceId&&!await Ye(m.currentLang)){t.checked=!1;return}c.updateSettings({sync:t.checked});const y=document.getElementById("sync-photos-toggle");y&&(y.disabled=!t.checked,t.checked||(y.checked=!1,c.updateSettings({syncPhotos:!1}))),t.checked&&m.raceId?L.initialize():L.cleanup()}finally{s=!1}});const i=document.getElementById("sync-photos-toggle");i&&i.addEventListener("change",async m=>{const y=m.target;y.checked?(m.preventDefault(),y.checked=!1,await Oi()):c.updateSettings({syncPhotos:!1})});const a=document.getElementById("auto-toggle");a&&a.addEventListener("change",()=>{c.updateSettings({auto:a.checked})});const r=document.getElementById("haptic-toggle");r&&r.addEventListener("change",()=>{c.updateSettings({haptic:r.checked})});const o=document.getElementById("sound-toggle");o&&o.addEventListener("change",()=>{c.updateSettings({sound:o.checked})});const l=document.getElementById("photo-toggle");l&&l.addEventListener("change",()=>{c.updateSettings({photoCapture:l.checked})});const h=document.getElementById("lang-toggle");h&&h.addEventListener("click",m=>{const I=m.target.getAttribute("data-lang");I&&I!==c.getState().currentLang&&(c.setLanguage(I),ct(),dn())});const u=document.getElementById("race-id-input");let g=!1;u&&(u.addEventListener("input",()=>{Y&&clearTimeout(Y);const m=u.value.trim();m?Y=setTimeout(()=>Ri(m),500):lt(null,0)}),u.addEventListener("change",async()=>{if(!g){g=!0;try{const m=u.value.trim(),y=c.getState(),I=y.entries.length>0,T=y.lastSyncedRaceId!=="",R=m!==y.raceId&&m!=="";if(I&&R)if(T){const A=await kt("synced",y.currentLang);if(A==="export")nt(),c.clearAll(),await D.clearAll();else if(A==="delete")c.clearAll(),await D.clearAll();else{u.value=y.raceId;return}}else{const A=await kt("unsynced",y.currentLang);if(A==="delete")c.clearAll(),await D.clearAll();else if(A==="cancel"){u.value=y.raceId;return}}if(m&&!Nt(m)){E(d("invalidRaceId",y.currentLang),"error"),u.value=y.raceId,P();return}if(y.settings.sync&&m&&!await Ye(y.currentLang)){u.value=y.raceId;return}y.settings.sync&&y.raceId&&L.cleanup();const w=m.toLowerCase();u.value=w,c.setRaceId(w),y.settings.sync&&w&&(L.initialize(),c.markCurrentRaceAsSynced())}finally{g=!1}}}));const p=document.getElementById("settings-recent-races-btn"),v=document.getElementById("settings-recent-races-dropdown");p&&v&&(p.addEventListener("click",()=>{S(),v.style.display==="none"?Ai(v):v.style.display="none"}),Je||(Je=m=>{const y=m.target;!p.contains(y)&&!v.contains(y)&&(v.style.display="none")},document.addEventListener("click",Je)));const b=document.getElementById("device-name-input");b&&b.addEventListener("change",()=>{c.setDeviceName(b.value.trim())}),oi()}function oi(){const n=document.getElementById("role-toggle");n&&n.addEventListener("click",e=>{const s=e.target.closest(".role-card-setting");if(!s)return;const i=s.getAttribute("data-role");i&&i!==c.getState().deviceRole&&(c.setDeviceRole(i),rt(),ot(),S(),i==="gateJudge"&&!c.getState().gateAssignment&&De(document.getElementById("gate-assignment-modal")),i==="gateJudge"?c.setView("gateJudge"):c.getState().currentView==="gateJudge"&&c.setView("timer"))})}function rt(){const n=document.getElementById("role-toggle");if(!n)return;const e=c.getState();n.querySelectorAll(".role-card-setting").forEach(t=>{const s=t.getAttribute("data-role");t.classList.toggle("active",s===e.deviceRole)})}function ot(){const n=document.getElementById("timer-tab"),e=document.getElementById("gate-judge-tab"),t=document.querySelector(".tab-bar"),i=c.getState().deviceRole==="gateJudge";n&&(n.style.display=i?"none":""),e&&(e.style.display=i?"":"none"),t&&t.classList.toggle("gate-judge-mode",i)}function ci(){rt(),ot();const n=document.getElementById("gate-change-btn");n&&n.addEventListener("click",()=>{S(),li()});const e=document.getElementById("gate-judge-run-selector");e&&e.addEventListener("click",i=>{const r=i.target.closest(".run-btn");if(!r)return;const o=r.getAttribute("data-run"),l=o?parseInt(o,10):1;c.setSelectedRun(l),S(),e.querySelectorAll(".run-btn").forEach(h=>{h.classList.toggle("active",h===r),h.setAttribute("aria-checked",h===r?"true":"false")}),Z()});const t=document.getElementById("record-fault-btn");t&&t.addEventListener("click",()=>{S(),Zt()});const s=document.getElementById("ready-toggle-btn");s&&(s.addEventListener("click",()=>{const i=c.getState(),a=!i.isJudgeReady;c.setJudgeReady(a),z(),Pt();const r=i.currentLang;E(d(a?"judgeReady":"judgeNotReady",r),"success")}),Pt()),di(),hi(),Ne()}function li(){const n=c.getState(),e=document.getElementById("gate-start-input"),t=document.getElementById("gate-end-input");e&&t&&(n.gateAssignment?(e.value=String(n.gateAssignment[0]),t.value=String(n.gateAssignment[1])):(e.value="1",t.value="10")),De(document.getElementById("gate-assignment-modal"))}function di(){const n=document.getElementById("save-gate-assignment-btn");n&&n.addEventListener("click",()=>{const e=document.getElementById("gate-start-input"),t=document.getElementById("gate-end-input"),s=parseInt(e.value,10)||1,i=parseInt(t.value,10)||10,a=Math.min(s,i),r=Math.max(s,i);c.setGateAssignment([a,r]),Ne(),B(document.getElementById("gate-assignment-modal")),z();const o=c.getState().currentLang;E(d("saved",o),"success")})}function Ne(){const n=document.getElementById("gate-range-display");if(!n)return;const e=c.getState();e.gateAssignment?n.textContent=`${e.gateAssignment[0]}–${e.gateAssignment[1]}`:n.textContent="--",ui()}function ui(){const n=document.getElementById("other-judges-coverage"),e=document.getElementById("other-judges-list");if(!n||!e)return;if(!c.getState().settings.sync){n.style.display="none";return}const s=L.getOtherGateAssignments();if(s.length===0){n.style.display="none";return}n.style.display="flex",e.innerHTML=s.map(i=>`
    <div class="coverage-badge ${i.isReady?"ready":""}" title="${i.deviceName}${i.isReady?" - Ready":""}">
      ${i.isReady?'<span class="ready-check">✓</span>':""}
      <span class="device-name">${i.deviceName.slice(0,15)}</span>
      <span class="gate-range">${i.gateStart}–${i.gateEnd}</span>
    </div>
  `).join(""),gi(s),ne()}function Pt(){const n=document.getElementById("ready-toggle-btn");if(!n)return;const e=c.getState();n.classList.toggle("ready",e.isJudgeReady)}function gi(n){const e=document.getElementById("judges-ready-indicator"),t=document.getElementById("judges-ready-count");if(!e||!t)return;const s=c.getState();if(!s.settings.sync){e.style.display="none";return}const i=n||L.getOtherGateAssignments();let a=i.length,r=i.filter(o=>o.isReady).length;if(s.deviceRole==="gateJudge"&&s.gateAssignment&&(a++,s.isJudgeReady&&r++),a===0){e.style.display="none";return}e.style.display="flex",t.textContent=`${r}/${a}`,e.classList.toggle("all-ready",r===a&&a>0)}function ne(){const n=document.getElementById("gps-indicator"),e=document.getElementById("judge-ready-indicator");if(!e)return;const t=c.getState(),s=t.deviceRole==="gateJudge";if(n&&(n.style.display=!s&&t.settings.gps?"flex":"none"),!s){e.style.display="none";return}e.style.display="flex";const i=L.getOtherGateAssignments();let a=i.length,r=i.filter(o=>o.isReady).length;t.gateAssignment&&(a++,t.isJudgeReady&&r++),e.classList.remove("none-ready","some-ready","all-ready"),a===0||r===0?e.classList.add("none-ready"):r===a?e.classList.add("all-ready"):e.classList.add("some-ready")}function Zt(n){const e=c.getState(),t=c.getActiveBibs(e.selectedRun),s=document.getElementById("fault-bib-selector");s&&(s.innerHTML=t.map(o=>`
      <button class="fault-bib-btn ${o===n?"selected":""}" data-bib="${o}">${o}</button>
    `).join(""),s.querySelectorAll(".fault-bib-btn").forEach(o=>{o.addEventListener("click",()=>{s.querySelectorAll(".fault-bib-btn").forEach(h=>h.classList.remove("selected")),o.classList.add("selected");const l=document.getElementById("fault-bib-input");l&&(l.value=""),c.setSelectedFaultBib(o.getAttribute("data-bib")||"")})}));const i=document.getElementById("fault-bib-input");i&&(i.value=n||"",i.addEventListener("input",()=>{s==null||s.querySelectorAll(".fault-bib-btn").forEach(o=>o.classList.remove("selected")),c.setSelectedFaultBib(i.value.padStart(3,"0"))})),n?c.setSelectedFaultBib(n):c.setSelectedFaultBib("");const a=document.getElementById("fault-gate-selector");if(a&&e.gateAssignment){const[o,l]=e.gateAssignment;let h="";for(let u=o;u<=l;u++)h+=`<button class="fault-gate-btn" data-gate="${u}">${u}</button>`;a.innerHTML=h,a.querySelectorAll(".fault-gate-btn").forEach(u=>{u.addEventListener("click",()=>{a.querySelectorAll(".fault-gate-btn").forEach(g=>g.classList.remove("selected")),u.classList.add("selected")})})}const r=document.getElementById("fault-type-buttons");r&&r.querySelectorAll(".fault-type-btn").forEach(o=>{o.classList.remove("selected")}),De(document.getElementById("fault-modal"))}function hi(){const n=document.getElementById("fault-type-buttons");n&&n.addEventListener("click",t=>{const i=t.target.closest(".fault-type-btn");if(!i)return;const a=i.getAttribute("data-fault");a&&(n.querySelectorAll(".fault-type-btn").forEach(r=>r.classList.remove("selected")),i.classList.add("selected"),fi(a))});const e=document.getElementById("mark-ok-btn");e&&e.addEventListener("click",()=>{B(document.getElementById("fault-modal")),S()})}function fi(n){const e=c.getState();let t=e.selectedFaultBib;if(!t){const o=document.getElementById("fault-bib-input");t=(o==null?void 0:o.value.padStart(3,"0"))||""}if(!t){const o=e.currentLang;E(d("selectBib",o),"warning");return}const s=document.querySelector("#fault-gate-selector .fault-gate-btn.selected"),i=s?parseInt(s.getAttribute("data-gate")||"0",10):0;if(!i){const o=e.currentLang;E(d("selectGate",o),"warning");return}const a={id:`fault-${Date.now()}-${Math.random().toString(36).slice(2,9)}`,bib:t,run:e.selectedRun,gateNumber:i,faultType:n,timestamp:new Date().toISOString(),deviceId:e.deviceId,deviceName:e.deviceName,gateRange:e.gateAssignment||[1,1]};c.addFaultEntry(a),P(),os(a),mi(a),B(document.getElementById("fault-modal")),Z();const r=e.currentLang;E(d("faultRecorded",r),"success")}function mi(n){const e=document.getElementById("fault-confirmation-overlay");if(!e)return;const t=e.querySelector(".fault-confirmation-bib"),s=e.querySelector(".fault-confirmation-gate"),i=e.querySelector(".fault-confirmation-type"),a=c.getState();t&&(t.textContent=n.bib),s&&(s.textContent=`${d("gate",a.currentLang)} ${n.gateNumber}`),i&&(i.textContent=Kt(n.faultType,a.currentLang)),e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},1500)}function Kt(n,e){return{MG:d("faultMGShort",e),STR:d("faultSTRShort",e),BR:d("faultBRShort",e)}[n]||n}function Z(){const n=document.getElementById("active-bibs-list"),e=document.getElementById("no-active-bibs");if(!n)return;const t=c.getState(),s=c.getActiveBibs(t.selectedRun);if(n.querySelectorAll(".active-bib-card").forEach(r=>r.remove()),s.length===0){e&&(e.style.display="");return}e&&(e.style.display="none");const i=new Map;t.entries.forEach(r=>{r.point==="S"&&r.run===t.selectedRun&&i.set(r.bib,new Date(r.timestamp))}),[...s].sort((r,o)=>{var u,g;const l=((u=i.get(r))==null?void 0:u.getTime())||0;return(((g=i.get(o))==null?void 0:g.getTime())||0)-l}).forEach(r=>{const o=i.get(r),l=c.getFaultsForBib(r,t.selectedRun),h=l.length>0,u=document.createElement("div");u.className=`active-bib-card${h?" has-fault":""}`,u.setAttribute("data-bib",r),u.setAttribute("role","listitem");const g=o?$e(o):"--:--:--";u.innerHTML=`
      <div class="bib-card-info">
        <span class="bib-card-number">${r}</span>
        <span class="bib-card-time">${g}</span>
        ${h?`<span class="bib-fault-indicator">${l.length} ${d("faultCount",t.currentLang)}</span>`:""}
      </div>
      <div class="bib-card-actions">
        <button class="bib-action-btn fault" data-action="fault">${d("faultMGShort",t.currentLang)}</button>
        <button class="bib-action-btn ok" data-action="ok">${d("ok",t.currentLang)}</button>
      </div>
    `,u.addEventListener("click",p=>{const b=p.target.closest(".bib-action-btn");if(b){const m=b.getAttribute("data-action");m==="fault"?(S(),Zt(r)):m==="ok"&&(S(),E(d("ok",t.currentLang),"success",1e3))}}),n.appendChild(u)})}function pi(){document.querySelectorAll(".modal-overlay").forEach(l=>{l.addEventListener("click",h=>{h.target===l&&re()})}),document.querySelectorAll('[data-action="cancel"]').forEach(l=>{l.addEventListener("click",re)});const n=document.getElementById("confirm-delete-btn");n&&n.addEventListener("click",bi);const e=document.getElementById("save-edit-btn");e&&e.addEventListener("click",Ei);const t=document.getElementById("edit-bib-input");t&&t.addEventListener("input",()=>{t.value=t.value.replace(/[^0-9]/g,"").slice(0,3)});const s=document.getElementById("edit-run-selector");s&&s.addEventListener("click",l=>{const u=l.target.closest(".edit-run-btn");if(!u)return;const g=document.getElementById("edit-modal"),p=u.getAttribute("data-run")||"1";g&&g.setAttribute("data-entry-run",p),document.querySelectorAll(".edit-run-btn").forEach(v=>{v.classList.toggle("active",v===u)})});const i=document.getElementById("photo-viewer-close-btn");i&&i.addEventListener("click",fe);const a=document.getElementById("photo-viewer-close-footer-btn");a&&a.addEventListener("click",fe);const r=document.getElementById("photo-viewer-delete-btn");r&&r.addEventListener("click",Ii);const o=document.getElementById("photo-viewer-modal");o&&o.addEventListener("click",l=>{l.target===o&&fe()})}function yi(n){const e=document.getElementById("edit-modal");if(!e)return;e.setAttribute("data-entry-id",n.id);const t=document.getElementById("edit-bib-input"),s=document.getElementById("edit-status-select");t&&(t.value=n.bib||""),s&&(s.value=n.status);const i=n.run??1;document.querySelectorAll(".edit-run-btn").forEach(a=>{const r=a.getAttribute("data-run")===String(i);a.classList.toggle("active",r)}),e.setAttribute("data-entry-run",String(i)),e.classList.add("show")}function he(n){const e=document.getElementById("confirm-modal");if(!e)return;const t=c.getState().currentLang,s=e.querySelector(".modal-title"),i=e.querySelector(".modal-text");if(e.setAttribute("data-action",n),n==="clearAll")s&&(s.textContent=d("confirmClearAll",t)),i&&(i.textContent=d("clearAllText",t));else if(n==="deleteSelected"){const a=c.getState().selectedEntries.size;s&&(s.textContent=d("confirmDelete",t)),i&&(i.textContent=`${a} ${d("entries",t)} ${d("selected",t)}`)}else n==="undoAdd"?(s&&(s.textContent=d("confirmUndoAdd",t)),i&&(i.textContent=d("confirmUndoAddText",t))):(s&&(s.textContent=d("confirmDelete",t)),i&&(i.textContent=d("confirmDeleteText",t)));e.classList.add("show")}function vi(n){const e=document.getElementById("confirm-modal");e&&e.setAttribute("data-entry-id",n.id),he("delete")}async function bi(){const n=document.getElementById("confirm-modal");if(!n)return;const e=n.getAttribute("data-action"),t=n.getAttribute("data-entry-id"),s=c.getState();if(e==="clearAll"){const i=[...s.entries];if(c.clearAll(),await D.clearAll(),s.settings.sync&&s.raceId)for(const a of i)L.deleteEntryFromCloud(a.id,a.deviceId);E(d("cleared",s.currentLang),"success")}else if(e==="deleteSelected"){const i=Array.from(s.selectedEntries),a=s.entries.filter(r=>i.includes(r.id));if(c.deleteMultiple(i),await D.deletePhotos(i),s.settings.sync&&s.raceId)for(const r of a)L.deleteEntryFromCloud(r.id,r.deviceId);E(d("deleted",s.currentLang),"success")}else if(e==="undoAdd"){const i=c.undo();if(Ot(),E(d("undone",s.currentLang),"success"),i&&i.type==="ADD_ENTRY"){const a=i.data;await D.deletePhoto(a.id),s.settings.sync&&s.raceId&&L.deleteEntryFromCloud(a.id,a.deviceId)}re();return}else if(t){const i=s.entries.find(a=>a.id===t);c.deleteEntry(t),await D.deletePhoto(t),s.settings.sync&&s.raceId&&i&&L.deleteEntryFromCloud(i.id,i.deviceId),E(d("deleted",s.currentLang),"success")}et(),re()}function Ei(){const n=document.getElementById("edit-modal");if(!n)return;const e=n.getAttribute("data-entry-id");if(!e)return;const t=document.getElementById("edit-bib-input"),s=document.getElementById("edit-status-select"),i=n.getAttribute("data-entry-run"),a=i?parseInt(i,10):1;c.updateEntry(e,{bib:(t==null?void 0:t.value.padStart(3,"0"))||"",status:s==null?void 0:s.value,run:a}),E(d("saved",c.getState().currentLang),"success"),re()}function re(){const n=document.getElementById("admin-pin-modal");if(n!=null&&n.classList.contains("show")&&k){k(!1),k=null;const e=document.getElementById("admin-pin-verify-input");e&&(e.value="")}document.querySelectorAll(".modal-overlay.show").forEach(e=>{B(e)})}let Le=null;async function Si(n){const e=document.getElementById("photo-viewer-modal");if(!e||!n.photo)return;Le=n.id;const t=document.getElementById("photo-viewer-image"),s=document.getElementById("photo-viewer-bib"),i=document.getElementById("photo-viewer-point"),a=document.getElementById("photo-viewer-time"),o=c.getState().currentLang;if(t){const l=X(n.point,o);if(t.alt=`${d("photoForBib",o)} ${n.bib||"---"} - ${l}`,n.photo==="indexeddb"){t.src="";const h=await D.getPhoto(n.id);if(h)t.src=`data:image/jpeg;base64,${h}`;else{console.warn("Photo not found in IndexedDB for entry:",n.id);return}}else t.src=`data:image/jpeg;base64,${n.photo}`}if(s&&(s.textContent=n.bib||"---"),i){i.textContent=X(n.point,o);const l=Re(n.point);i.style.background=l,i.style.color="var(--background)"}if(a){const l=new Date(n.timestamp);a.textContent=$e(l)}e.classList.add("show")}function fe(){const n=document.getElementById("photo-viewer-modal");B(n),Le=null}async function Ii(){if(!Le)return;const n=c.getState(),e=Le;await D.deletePhoto(e),c.updateEntry(e,{photo:void 0}),fe(),E(d("photoDeleted",n.currentLang),"success"),et()}function wi(n,e){e.includes("currentView")&&(Xt(),n.currentView==="timer"?we.enable():we.disable(),H&&(n.currentView==="results"?H.resume():H.pause())),(e.includes("currentView")||e.includes("settings"))&&qt(n),e.includes("bibInput")&&en(),e.includes("selectedPoint")&&tn(),e.includes("selectedRun")&&(nn(),sn(),n.currentView==="gateJudge"&&Z()),e.includes("entries")&&n.currentView==="gateJudge"&&Z(),e.includes("deviceRole")&&(rt(),ot(),ne()),e.includes("isJudgeReady")&&ne(),e.includes("gateAssignment")&&Ne(),e.includes("faultEntries")&&n.currentView==="gateJudge"&&Z(),e.includes("entries")&&(H&&H.setEntries(n.entries),Fe(),an()),(e.includes("syncStatus")||e.includes("settings")||e.includes("cloudDeviceCount"))&&rn(),(e.includes("gpsStatus")||e.includes("settings"))&&(on(),ne()),e.includes("settings")&&(cn(),gn()),e.includes("undoStack")&&ln()}function Ci(){Xt(),en(),tn(),nn(),Fe(),an(),rn(),on(),ne(),cn(),ln(),Li(),ct()}function Ti(n){return n.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}function Xt(){const n=c.getState();document.querySelectorAll(".view").forEach(s=>{s.classList.remove("active")});const e=Ti(n.currentView),t=document.querySelector(`.${e}-view`);t&&t.classList.add("active"),document.querySelectorAll(".tab-btn").forEach(s=>{s.classList.toggle("active",s.getAttribute("data-view")===n.currentView)}),n.currentView==="gateJudge"&&(Z(),Ne(),sn())}function en(){const n=c.getState(),e=document.querySelector(".bib-value");e&&(e.textContent=n.bibInput?n.bibInput.padStart(3,"0"):"---");const t=document.getElementById("timestamp-btn");t&&t.classList.toggle("ready",n.bibInput.length>0)}function tn(){const n=c.getState();document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-point")===n.selectedPoint)})}function nn(){const n=c.getState();document.querySelectorAll(".run-btn").forEach(e=>{const t=e.getAttribute("data-run")===String(n.selectedRun);e.classList.toggle("active",t),e.setAttribute("aria-checked",String(t))})}function sn(){const n=c.getState(),e=document.getElementById("gate-judge-run-selector");e&&e.querySelectorAll(".run-btn").forEach(t=>{const s=t.getAttribute("data-run")===String(n.selectedRun);t.classList.toggle("active",s),t.setAttribute("aria-checked",String(s))})}function Fe(){const e=c.getState().entries,t=e.length,s=new Set(e.map(l=>l.bib)).size,i=e.filter(l=>l.point==="F"&&l.status==="ok").length,a=document.getElementById("stat-total"),r=document.getElementById("stat-racers"),o=document.getElementById("stat-finished");a&&(a.textContent=String(t)),r&&(r.textContent=String(s)),o&&(o.textContent=String(i))}function an(){const n=document.getElementById("entry-count-badge");if(n){const e=c.getState().entries.length;n.textContent=String(e),n.style.display=e>0?"inline":"none"}}function rn(){const n=c.getState(),e=document.getElementById("sync-indicator"),t=document.querySelector(".sync-dot"),s=document.querySelector(".sync-status-text"),i=document.getElementById("sync-device-count");e&&(e.style.display=n.settings.sync?"flex":"none"),t&&(t.classList.remove("connected","error","offline","syncing"),n.syncStatus==="connected"?t.classList.add("connected"):n.syncStatus==="syncing"?t.classList.add("syncing"):n.syncStatus==="error"?t.classList.add("error"):n.syncStatus==="offline"&&t.classList.add("offline")),s&&(s.textContent=d(n.syncStatus,n.currentLang)),i&&(n.syncStatus==="connected"&&n.cloudDeviceCount>0?(i.textContent=`(${n.cloudDeviceCount})`,i.style.display="inline"):i.style.display="none")}function on(){const n=c.getState(),e=document.getElementById("gps-indicator"),t=document.querySelector(".gps-dot"),s=document.querySelector(".gps-status-text");e&&(e.style.display=n.settings.gps?"flex":"none"),t&&(t.classList.remove("active","searching"),n.gpsStatus==="active"?t.classList.add("active"):n.gpsStatus==="searching"&&t.classList.add("searching")),s&&(s.textContent="GPS")}function cn(){const n=c.getState(),e=document.getElementById("camera-indicator");e&&(e.style.display=n.settings.photoCapture?"flex":"none")}function ln(){const n=document.getElementById("undo-btn");n&&n.toggleAttribute("disabled",!c.canUndo())}function Li(){const n=c.getState(),{settings:e}=n,t=document.getElementById("simple-mode-toggle"),s=document.getElementById("gps-toggle"),i=document.getElementById("sync-toggle"),a=document.getElementById("auto-toggle"),r=document.getElementById("haptic-toggle"),o=document.getElementById("sound-toggle"),l=document.getElementById("photo-toggle");t&&(t.checked=e.simple);const h=document.getElementById("admin-section");h&&(h.style.display="block"),s&&(s.checked=e.gps),i&&(i.checked=e.sync),a&&(a.checked=e.auto),r&&(r.checked=e.haptic),o&&(o.checked=e.sound),l&&(l.checked=e.photoCapture);const u=document.getElementById("sync-photos-toggle");u&&(u.checked=e.syncPhotos,u.disabled=!e.sync);const g=document.getElementById("race-id-input");g&&(g.value=n.raceId);const p=document.getElementById("device-name-input");p&&(p.value=n.deviceName),dn()}function dn(){const n=c.getState().currentLang,e=document.getElementById("lang-toggle");e&&e.querySelectorAll(".lang-option").forEach(t=>{t.classList.toggle("active",t.getAttribute("data-lang")===n)})}function ct(){const n=c.getState().currentLang;document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.getAttribute("data-i18n");t&&(e.textContent=d(t,n))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const t=e.getAttribute("data-i18n-placeholder");t&&(e.placeholder=d(t,n))}),lt(Qe.exists,Qe.entryCount)}function un(){document.querySelectorAll("[data-advanced]").forEach(t=>{t.style.display=""});const e=document.querySelector('[data-point="S"]');e&&(e.style.display=""),gn()}function gn(){const n=c.getState().settings,e=document.documentElement;n.glassEffects?(e.classList.remove("no-glass-effects"),document.querySelectorAll(".glass-enable-target").forEach(t=>{t.classList.add("glass-enabled")})):(e.classList.add("no-glass-effects"),document.querySelectorAll(".glass-enabled").forEach(t=>{t.classList.remove("glass-enabled")})),e.classList.add("no-motion-effects"),n.outdoorMode?e.classList.add("outdoor-mode"):e.classList.remove("outdoor-mode")}function Re(n){return{S:"var(--success)",F:"var(--secondary)"}[n]}function $e(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),s=String(n.getSeconds()).padStart(2,"0"),i=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${s}.${i}`}let Qe={exists:null,entryCount:0};async function Ri(n){const e=++We,t=await L.checkRaceExists(n);e===We&&(c.setRaceExistsInCloud(t.exists),lt(t.exists,t.entryCount))}async function Ai(n){const e=c.getState().currentLang;n.innerHTML=`<div class="recent-races-empty">${d("loading",e)}</div>`,n.style.display="block";let t=[];if(V())try{t=await ki()}catch(s){console.warn("Failed to fetch races from API:",s),t=Ie()}else t=Ie();t.length===0?n.innerHTML=`<div class="recent-races-empty">${d("noRecentRaces",e)}</div>`:(n.innerHTML=Jt(t),Vt(n,t,s=>{Bi(s,n)}))}async function ki(){const n=localStorage.getItem(Wt);if(!n)return[];const e=await $("/api/admin/races",{headers:{Authorization:`Bearer ${n}`}},5e3);if(!e.ok)throw new Error(`API error: ${e.status}`);const s=(await e.json()).races||[],i=new Date;i.setHours(0,0,0,0);const a=i.getTime(),r=s.filter(o=>o.lastUpdated&&o.lastUpdated>=a).map(o=>({raceId:o.raceId,createdAt:o.lastUpdated||Date.now(),lastUpdated:o.lastUpdated||Date.now(),entryCount:o.entryCount})).slice(0,5);return r.forEach(o=>{Ke(o.raceId,o.lastUpdated,o.entryCount)}),r}function Bi(n,e){const t=document.getElementById("race-id-input");t&&(t.value=n.raceId,t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),S()),e.style.display="none"}function lt(n,e){Qe={exists:n,entryCount:e};const t=document.getElementById("race-exists-indicator"),s=document.getElementById("race-exists-text"),i=c.getState().currentLang;if(!(!t||!s)){if(n===null){t.style.display="none";return}t.style.display="inline-flex",t.classList.remove("found","new"),n?(t.classList.add("found"),s.textContent=e>0?`${e} ${d("entriesInCloud",i)}`:d("raceFound",i)):(t.classList.add("new"),s.textContent=d("raceNew",i))}}const Pi="1111";let me=null;async function Di(){V()||await xe(Pi)}function xi(n){return/^\d{4}$/.test(n)}function Ni(n){n.addEventListener("input",()=>{n.value=n.value.replace(/[^0-9]/g,"")})}function Ae(){const n=c.getState().currentLang,e=V(),t=document.getElementById("admin-pin-status"),s=document.getElementById("change-pin-btn-text");t&&(t.textContent=d(e?"pinSet":"pinNotSet",n)),s&&(s.textContent=d(e?"changePin":"setPin",n))}function Fi(){Di().then(()=>{Ae()}),Ae();const n=document.getElementById("change-pin-btn");n&&n.addEventListener("click",$i);const e=document.getElementById("save-pin-btn");e&&e.addEventListener("click",Mi),["admin-pin-verify-input","current-pin-input","new-pin-input","confirm-pin-input"].forEach(u=>{const g=document.getElementById(u);g&&Ni(g)});const s=document.getElementById("manage-races-btn");s&&s.addEventListener("click",Vi);const i=document.getElementById("admin-pin-verify-btn");i&&i.addEventListener("click",()=>{k?xt():Dt()});const a=document.getElementById("admin-pin-verify-input");a&&a.addEventListener("keydown",u=>{u.key==="Enter"&&(k?xt():Dt())});const r=document.getElementById("admin-pin-modal");r&&r.addEventListener("click",u=>{u.target===r&&k&&qi()});const o=document.getElementById("race-deleted-ok-btn");o&&o.addEventListener("click",()=>{const u=document.getElementById("race-deleted-modal");B(u)});const l=document.getElementById("refresh-races-btn");l&&l.addEventListener("click",dt);const h=document.getElementById("confirm-delete-race-btn");h&&h.addEventListener("click",Wi),Ui()}function $i(){const n=c.getState().currentLang,e=V(),t=document.getElementById("change-pin-modal"),s=document.getElementById("change-pin-modal-title"),i=document.getElementById("current-pin-row"),a=document.getElementById("current-pin-input"),r=document.getElementById("new-pin-input"),o=document.getElementById("confirm-pin-input");t&&(a&&(a.value=""),r&&(r.value=""),o&&(o.value=""),hn(),e?(i&&(i.style.display="block"),s&&(s.textContent=d("changePin",n))):(i&&(i.style.display="none"),s&&(s.textContent=d("setPin",n))),t.classList.add("show"),e&&a?a.focus():r&&r.focus())}function hn(){["current-pin-error","pin-mismatch-error","pin-format-error"].forEach(e=>{const t=document.getElementById(e);t&&(t.style.display="none")})}async function Mi(){const n=c.getState().currentLang,e=V(),t=document.getElementById("current-pin-input"),s=document.getElementById("new-pin-input"),i=document.getElementById("confirm-pin-input"),a=document.getElementById("current-pin-error"),r=document.getElementById("pin-mismatch-error"),o=document.getElementById("pin-format-error");if(hn(),e){const g=(t==null?void 0:t.value)||"";if(!(await Xe(g)).success){a&&(a.style.display="block"),t&&(t.value="",t.focus()),P();return}}const l=(s==null?void 0:s.value)||"",h=(i==null?void 0:i.value)||"";if(!xi(l)){o&&(o.style.display="block"),s&&s.focus(),P();return}if(l!==h){r&&(r.style.display="block"),i&&(i.value="",i.focus()),P();return}const u=await Hi(l);try{const g=await fetch("/api/admin/pin",{method:"POST",headers:{...st(),"Content-Type":"application/json"},body:JSON.stringify({pinHash:u})});if(!g.ok)throw new Error(`HTTP ${g.status}`);if(Ht(),!(await xe(l)).success){E(d("pinSyncFailed",n),"error"),P();return}const v=document.getElementById("change-pin-modal");B(v),E(d("pinSaved",n),"success"),z(),Ae()}catch(g){Ge("Admin","handleSavePin",g,"pinSyncFailed"),E(d("pinSyncFailed",n),"error"),P()}}async function Hi(n){const t=new TextEncoder().encode(n),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map(a=>a.toString(16).padStart(2,"0")).join("")}function fn(n){const{raceId:e,message:t}=n.detail,s=c.getState().currentLang,i=document.getElementById("race-deleted-text");i&&(i.textContent=`${d("raceDeletedFor",s)} "${e}". ${t||d("raceDeletedText",s)}`);const a=document.getElementById("race-deleted-modal");a&&a.classList.add("show"),c.updateSettings({sync:!1}),c.setRaceId("");const r=document.getElementById("sync-toggle");r&&(r.checked=!1);const o=document.getElementById("race-id-input");o&&(o.value=""),P()}function mn(n){const{message:e}=n.detail,t=c.getState().currentLang;E(e||"Session expired. Please re-enter your PIN.","warning",5e3),Ye(t).then(s=>{if(s){const i=c.getState();i.settings.sync&&i.raceId&&L.initialize(),E("Authentication successful","success")}}),P()}function zi(n){if(n===0)return"0 B";const e=1024,t=["B","KB","MB","GB"],s=Math.floor(Math.log(n)/Math.log(e));return parseFloat((n/Math.pow(e,s)).toFixed(1))+" "+t[s]}async function Oi(){const n=document.getElementById("photo-sync-modal");if(!n)return;const e=c.getState().currentLang,t=document.getElementById("photos-upload-count"),s=document.getElementById("photos-download-count"),i=document.getElementById("photos-total-size");t&&(t.textContent=d("loading",e)),s&&(s.textContent=d("loading",e)),i&&(i.textContent=d("loading",e)),n.classList.add("show");const a=await L.getPhotoSyncStats();t&&(t.textContent=String(a.uploadCount)),s&&(s.textContent=String(a.downloadCount)),i&&(i.textContent=zi(a.totalSize));const r=document.getElementById("photo-sync-confirm-btn");if(r){const o=a.uploadCount>0||a.downloadCount>0;r.textContent=d("enableSync",e)}}function Ui(){const n=document.getElementById("photo-sync-modal"),e=document.getElementById("photo-sync-cancel-btn"),t=document.getElementById("photo-sync-confirm-btn");e&&e.addEventListener("click",()=>{n&&n.classList.remove("show")}),t&&t.addEventListener("click",()=>{c.updateSettings({syncPhotos:!0});const s=document.getElementById("sync-photos-toggle");s&&(s.checked=!0),n&&n.classList.remove("show");const i=c.getState();i.settings.sync&&i.raceId&&L.forceRefresh(),z()}),n&&n.addEventListener("click",s=>{s.target===n&&n.classList.remove("show")})}function pn(n){const{isQuotaError:e,entryCount:t}=n.detail,s=c.getState().currentLang;e?E(d("storageQuotaError",s),"error",ae.CRITICAL):E(d("storageError",s),"error",ae.ERROR),P(),console.error("[Storage] saveEntries:",n.detail.message,{entryCount:t,isQuotaError:e})}function yn(n){const{percent:e}=n.detail,t=c.getState().currentLang;sessionStorage.getItem("storage-warning-shown")||(E(`${d("storageWarning",t)} (${e}%)`,"warning",ae.WARNING),sessionStorage.setItem("storage-warning-shown","true"))}function Ji(){if(J){try{J.destroy()}catch(n){console.warn("Clock cleanup error:",n)}J=null}L.cleanup(),j.stop(),W.stop(),we.disable(),Es(),Ms(),document.querySelectorAll(".ripple").forEach(n=>n.remove()),window.removeEventListener("race-deleted",fn),window.removeEventListener("auth-expired",mn),window.removeEventListener("storage-error",pn),window.removeEventListener("storage-warning",yn),O&&(clearTimeout(O),O=null),Y&&(clearTimeout(Y),Y=null),te=null,k&&(k(!1),k=null),We=0}function Vi(){const n=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input"),t=document.getElementById("admin-pin-error"),s=document.getElementById("admin-pin-modal-title"),i=document.getElementById("admin-pin-modal-text"),a=c.getState().currentLang;n&&e&&t&&(e.value="",t.style.display="none",s&&(s.textContent=d("enterAdminPin",a)),i&&(i.textContent=d("enterPinText",a)),n.classList.add("show"),e.focus())}async function Dt(){const n=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),t=document.getElementById("admin-pin-modal");if(!n||!t)return;const s=n.value.trim();(await xe(s)).success?(B(t),n.value="",e&&(e.style.display="none"),Gi()):(e&&(e.style.display="block"),n.value="",n.focus(),P())}function Ye(n){return new Promise(e=>{if(V()){e(!0);return}const t=document.getElementById("admin-pin-modal"),s=document.getElementById("admin-pin-modal-title"),i=document.getElementById("admin-pin-modal-text"),a=document.getElementById("admin-pin-verify-input"),r=document.getElementById("admin-pin-error");if(!t||!a){e(!1);return}s&&(s.textContent=d("enterAdminPin",n)),i&&(i.textContent=d("enterPinToJoinRace",n)),r&&(r.style.display="none"),a.value="",k=e,t.classList.add("show"),setTimeout(()=>a.focus(),100)})}async function xt(){const n=document.getElementById("admin-pin-verify-input"),e=document.getElementById("admin-pin-error"),t=document.getElementById("admin-pin-modal");if(!n||!t||!k)return;const s=n.value.trim();(await xe(s)).success?(B(t),n.value="",e&&(e.style.display="none"),k(!0),k=null):(e&&(e.style.display="block"),n.value="",n.focus(),P())}function qi(){const n=document.getElementById("admin-pin-modal"),e=document.getElementById("admin-pin-verify-input");B(n),e&&(e.value=""),k&&(k(!1),k=null)}function Gi(){const n=document.getElementById("race-management-modal");n&&(n.classList.add("show"),dt())}async function dt(){const n=document.getElementById("race-list"),e=document.getElementById("race-list-loading"),t=document.getElementById("race-list-empty"),s=c.getState().currentLang;if(n){n.setAttribute("aria-busy","true"),e&&(e.style.display="block"),t&&(t.style.display="none"),n.querySelectorAll(".race-item").forEach(i=>i.remove());try{const i=await $(jt,{headers:st()},1e4);if(!i.ok){if(i.status===401){const o=document.getElementById("race-management-modal");B(o),E(d("authError",s),"error"),console.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${i.status}`)}const r=(await i.json()).races||[];if(n.setAttribute("aria-busy","false"),e&&(e.style.display="none"),r.length===0){t&&(t.style.display="block");return}r.forEach(o=>{const l=_i(o,s);n.appendChild(l)})}catch(i){ke("Admin","loadRaceList",i,"loadError"),n.setAttribute("aria-busy","false"),e&&(e.style.display="none")}}}function _i(n,e){const t=document.createElement("div");t.className="race-item",t.setAttribute("data-race-id",n.raceId);const s=document.createElement("div");s.className="race-info";const i=document.createElement("span");i.className="race-id",i.textContent=n.raceId.toUpperCase();const a=document.createElement("span");a.className="race-meta";const r=n.entryCount===1?d("entry",e):d("entries",e),o=n.deviceCount===1?d("device",e):d("devices",e);a.textContent=`${n.entryCount} ${r}, ${n.deviceCount} ${o}`,s.appendChild(i),s.appendChild(a);const l=document.createElement("button");return l.className="race-delete-btn danger",l.textContent=d("delete",e),l.addEventListener("click",()=>ji(n.raceId)),t.appendChild(s),t.appendChild(l),t}function ji(n){const e=c.getState().currentLang;me=n;const t=document.getElementById("delete-race-confirm-modal"),s=document.getElementById("delete-race-confirm-text");s&&(s.textContent=`${d("confirmDeleteRaceText",e)} "${n.toUpperCase()}"?`),t&&t.classList.add("show")}async function Wi(){if(!me)return;const n=me,e=c.getState().currentLang,t=document.getElementById("delete-race-confirm-modal");B(t);try{const s=await $(`${jt}?raceId=${encodeURIComponent(n)}`,{method:"DELETE",headers:st()},1e4);if(!s.ok){if(s.status===401){const a=document.getElementById("race-management-modal");B(a),E(d("authError",e),"error"),console.error("API auth failed - check ADMIN_PIN env variable matches SERVER_API_PIN");return}throw new Error(`HTTP ${s.status}`)}const i=await s.json();if(i.success)E(`${d("raceDeletedSuccess",e)} ${n.toUpperCase()}`,"success"),et(),dt();else throw new Error(i.error||d("unknownError",e))}catch(s){ke("Admin","deleteRace",s,"deleteError")}finally{me=null}}let qe=!1,se=[];const Qi=3,Yi=1e4;function Zi(){window.addEventListener("error",Ki),window.addEventListener("unhandledrejection",Xi),window.addEventListener("critical-error",ea)}function Ki(n){const{message:e,filename:t,lineno:s,colno:i,error:a}=n;ke("Global","uncaught error",a||e,void 0),vn(e),bn()&&ut(e),n.preventDefault()}function Xi(n){const e=n.reason,t=e instanceof Error?e.message:String(e);ke("Global","unhandled rejection",e,void 0),vn(t),bn()&&ut(t),n.preventDefault()}function ea(n){var s;const e=n.detail,t=((s=e==null?void 0:e.error)==null?void 0:s.message)||"Critical error occurred";Hn("Global","critical error event",e==null?void 0:e.error,void 0),ut(t)}function vn(n){const e=Date.now();se.push({message:n,timestamp:e}),se=se.filter(t=>e-t.timestamp<Yi)}function bn(){return se.length>=Qi}function ut(n){var i,a;if(qe)return;qe=!0;const e=c.getState().currentLang,t=document.createElement("div");t.id="error-boundary-overlay",t.style.cssText=`
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 24px;
  `;const s=document.createElement("div");s.style.cssText=`
    background: #1a1a1a;
    border: 1px solid #333;
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    text-align: center;
    color: #fff;
  `,s.innerHTML=`
    <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
    <h2 style="margin: 0 0 8px; font-size: 1.25rem;">${d("errorOccurred",e)}</h2>
    <p style="color: #999; font-size: 0.875rem; margin: 0 0 16px;">
      ${d("errorRecoveryMessage",e)}
    </p>
    <p style="color: #666; font-size: 0.75rem; font-family: monospace; margin: 0 0 24px; word-break: break-word;">
      ${ta(n.substring(0,200))}
    </p>
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button id="error-dismiss-btn" style="
        padding: 12px 24px;
        border: 1px solid #444;
        border-radius: 8px;
        background: transparent;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${d("dismiss",e)}</button>
      <button id="error-reload-btn" style="
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: #3B82F6;
        color: #fff;
        font-size: 0.875rem;
        cursor: pointer;
      ">${d("reload",e)}</button>
    </div>
  `,t.appendChild(s),document.body.appendChild(t),(i=document.getElementById("error-dismiss-btn"))==null||i.addEventListener("click",()=>{t.remove(),qe=!1,se=[]}),(a=document.getElementById("error-reload-btn"))==null||a.addEventListener("click",()=>{window.location.reload()})}function ta(n){const e=document.createElement("div");return e.textContent=n,e.innerHTML}Zi();Ut();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Rt):Rt();"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{await navigator.serviceWorker.register("/sw.js")}catch(n){console.error("Service Worker registration failed:",n)}});document.addEventListener("visibilitychange",()=>{});window.addEventListener("beforeunload",()=>{});
