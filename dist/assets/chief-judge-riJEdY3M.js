var tn=Object.defineProperty;var nn=(n,e,t)=>e in n?tn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>nn(n,typeof e!="symbol"?e+"":e,t);import{b as E,c as sn,m as W}from"./vendor-signals-BA-R9xnX.js";const at={en:{timer:"Timer",results:"Results",settings:"Settings",start:"Start",finish:"Finish",startShort:"S",finishShort:"F",bib:"Bib",point:"Point",run:"Run",run1:"R1",run2:"R2",runLabel1:"Run 1",runLabel2:"Run 2",time:"Record time",lastRecorded:"Last recorded",lastRecordedShort:"Last:",advancedSettings:"Advanced Settings",status:"Status",noEntries:"No entries recorded",noEntriesHint:"Record times on the Timer tab",search:"Search by bib...",searchResults:"Search results",filter:"Filter",all:"All",total:"Total",racers:"Racers",finished:"Finished",entriesRecorded:"entries recorded",fastest:"Fastest",average:"Average",timeEntry:"time",timeEntries:"times",faultEntry:"fault",faultEntries:"faults",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Delete Entry",confirmDeleteText:"Are you sure you want to delete this entry?",confirmDeleteFault:"Delete this fault?",confirmClearAll:"Clear All Results",clearAllText:"This will delete all recorded entries. This action cannot be undone.",confirmUndoAdd:"Undo Recording",confirmUndoAddText:"This will delete the recorded entry. Continue?",delete:"Delete",cancel:"Cancel",close:"Close",back:"Back",save:"Save",saving:"Saving...",edit:"Edit",undo:"Undo",export:"Export",clearAll:"Clear All",clearBibLabel:"Clear bib number",copyDebugInfo:"Copy debug info",faultNotes:"Notes",judgesReadyCount:"Judges ready",selectAll:"Select All",deleteSelected:"Delete Selected",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Synced from cloud",faultSyncError:"Fault sync failed — data may be stale",filterByPoint:"Filter by point",filterByStatus:"Filter by status",raceId:"Race ID",invalidRaceId:"Invalid Race ID. Use letters, numbers, hyphens, underscores only.",deviceName:"Time Keeper ID",cloudSync:"Cloud Sync",syncStatus:"Sync Status",pendingSync:"pending sync",raceSetup:"Race Setup",raceSetupDesc:"Required for multi-device timing and syncing.",firstGateLabel:"First gate",saved:"Saved",deleted:"Deleted",cleared:"All entries cleared",undone:"Undone",copied:"Copied to clipboard",debugInfoCopied:"Debug info copied to clipboard",debugInfoCopyFailed:"Tap and hold to copy debug info",duplicateWarning:"Duplicate entry detected",zeroBibWarning:"Bib 000 - verify entry",exported:"Exported successfully",gps:"GPS",gpsActive:"GPS Active",gpsSearching:"Searching for GPS...",gpsInactive:"GPS Inactive",gpsAccuracy:"Accuracy",settingsRaceSetup:"Race Setup",settingsTimingGroup:"Timing",settingsSyncGroup:"Sync",settingsFeedbackGroup:"Feedback",settingsDisplayGroup:"Display",simpleMode:"Simple Mode",fullMode:"Full Mode",autoIncrement:"Auto-increment Bib",hapticFeedback:"Haptic Feedback",soundFeedback:"Sound Feedback",language:"Language",advancedSettingsHint:"These options can affect timing accuracy. Change only if needed.",simpleModeDesc:"Simplified interface for basic timing",cloudSyncDesc:"Sync with other devices",gpsDesc:"Use GPS for accurate timestamps",autoIncrementDesc:"Increase bib number after recording",photoCaptureDesc:"Capture photo on timestamp",hapticFeedbackDesc:"Vibration on actions",soundFeedbackDesc:"Audio confirmation",ambientMode:"Ambient Mode",ambientModeDesc:"Auto-dim after 30s inactivity",photoCapture:"Photo Capture",photoCaptureActive:"Photo capture active",photoCaptured:"Photo captured",photoError:"Photo capture failed",photoSaveFailed:"Photo storage failed",viewPhoto:"View Photo",deletePhoto:"Delete Photo",photoFor:"Photo for Bib",noPhotoAvailable:"No photo available",photoDeleted:"Photo deleted",raceChangeTitle:"Change Race",raceChangeSyncedText:"You have results from another race. Export or delete them before switching?",raceChangeUnsyncedText:"You have existing results. Keep them or delete before switching?",keepResults:"Keep",version:"Version",devices:"Devices",entries:"entries",selected:"selected",raceFound:"Race found",raceNew:"New race",entryInCloud:"entry in cloud",entriesInCloud:"entries in cloud",photoTooLarge:"Photo too large for sync",syncedEntriesFromCloud:"Synced {count} entries from cloud",syncedFaultsFromCloud:"Synced {count} faults from cloud",crossDeviceDuplicate:"Duplicate: Bib {bib} {point} already recorded by {device}",syncPhotos:"Sync Photos",syncPhotosDesc:"Share photos across devices via cloud",syncPhotosWarning:"Enable Photo Sync",syncPhotosWarningText:"Enabling photo sync will transfer the following data:",photosToUpload:"Photos to upload",photosToDownload:"Photos to download",totalDataVolume:"Total data volume",enableSync:"Enable Sync",noPhotosToSync:"No photos to sync",admin:"Admin",adminPin:"Race Management PIN",adminPinDesc:"Required to manage and sync races",manageRaces:"Manage Races",manageRacesDesc:"View and delete synced races",manage:"Manage",enterAdminPin:"Enter Race Management PIN",enterPinText:"Enter your PIN to access race management.",enterPinToJoinRace:"Enter your PIN to join this race.",enterPinForChiefJudge:"Enter your PIN to access Chief Judge mode.",enterChiefJudgePin:"Enter Chief Judge PIN",enterPinForChiefJudgeInfo:"Chief Judge mode requires a separate PIN. First use sets the PIN.",syncRequiresPin:"Sync disabled. Enable sync and enter PIN to reconnect.",incorrectPin:"Incorrect PIN",verify:"Verify",setPinFirst:"Please set a Race Management PIN first",pinSaved:"PIN saved",pinCleared:"PIN cleared",pinNotSet:"Not set",pinSet:"PIN set",setPin:"Set PIN",changePin:"Change PIN",currentPin:"Current PIN",newPin:"New PIN (4 digits)",confirmPin:"Confirm PIN",pinMismatch:"PINs do not match",pinFormatError:"PIN must be exactly 4 digits",loading:"Loading...",noRaces:"No active races",noRacesHint:"Create one in Settings",cleanRunHint:"Clean run so far",refresh:"Refresh",raceDeleted:"Race Deleted",raceDeletedText:"This race has been deleted by an administrator.",raceDeletedFor:"Race deleted:",raceDeletedSuccess:"Race deleted:",confirmDeleteRace:"Delete Race",confirmDeleteRaceText:"Are you sure you want to delete race",loadError:"Failed to load races. Check your connection and try again.",deleteError:"Failed to delete race",entry:"entry",device:"device",storageError:"Failed to save data - check storage",storageQuotaError:"Storage full! Export data immediately",storageWarning:"Storage almost full",storageNearlyFull:"Storage nearly full. Export data and clear old entries.",storageSaveGaveUp:"Data NOT saved to disk! Export entries now to prevent data loss.",networkError:"Network error - check connection",connectionFailed:"Connection failed",serverUnavailable:"Server unavailable",rateLimitError:"Too many requests - please wait",authError:"Authentication failed. Try re-entering your PIN.",syncFailed:"Sync failed",pinSyncFailed:"PIN not synced to cloud",cameraError:"Camera error",cameraPermissionDenied:"Camera access denied",gpsError:"GPS error",gpsPermissionDenied:"GPS access denied",gpsUnavailable:"GPS unavailable",wakeLockFailed:"Screen may dim during timing",wakeLockIdleTimeout:"Screen will dim to save battery. Tap to keep awake.",unknownError:"Unknown error",onboardingWelcome:"Welcome to CHRONO",onboardingWelcomeDesc:"GPS-synchronized timing for ski races",getStarted:"Get Started",skipSetup:"Skip",onboardingRole:"What's Your Role?",onboardingRoleDesc:"Choose how you'll be helping at the race",roleTimerTitle:"Timer",roleTimerDesc:"You will record start and finish times",roleJudgeTitle:"Gate Judge",roleJudgeDesc:"You will record gate faults (Torrichter)",onboardingDeviceName:"Name Your Timer",onboardingDeviceNameDesc:"This identifies your device when syncing",onboardingDeviceNameJudge:"Your Name",onboardingDeviceNameJudgeDesc:"This identifies you as the gate judge",onboardingPhoto:"Photo Documentation",onboardingPhotoDesc:"Automatically capture a photo when recording each timestamp. Useful for verifying bib numbers and resolving disputes.",enablePhotoCapture:"Enable Photo Capture",photoCaptureLabel:"Photo Capture",onboardingGates:"Your Gate Assignment",onboardingGatesDesc:"Enter the gate numbers you'll be watching. You can change this later.",onboardingRaceSetup:"Join a Race",onboardingRaceSetupDesc:"Enter a race ID to sync with other timers",onboardingRaceIdPlaceholder:"e.g. RACE-2024",onboardingPinPlaceholder:"PIN (4 digits)",onboardingStepOf:"Step {current} of {total}",skipForNow:"Skip for now",onboardingReady:"Ready to Time!",onboardingReadyJudge:"Ready to Judge!",onboardingTip:"Tap the big blue button to record timestamps",onboardingTipJudge:"Tap a racer's bib to record a fault",startTiming:"Start Timing",startJudging:"Start Judging",continue:"Continue",deviceNameLabel:"Device Name",raceIdLabel:"Race ID",syncStatusLabel:"Cloud Sync",enabled:"Enabled",disabled:"Disabled",showTutorial:"Show Tutorial",showTutorialDesc:"Run the setup wizard again",show:"Show",onboardingComplete:"Setup complete!",invalidPin:"PIN must be 4 digits",recentRaces:"Recent Races",noRecentRaces:"No races from today",errorOccurred:"Something went wrong",errorRecoveryMessage:"The app encountered an error. You can dismiss this and continue, or reload the app.",dismiss:"Dismiss",skipToMain:"Skip to main content",reload:"Reload",updateAvailable:"Update available! Reload to get the latest version.",operationFailed:"Operation failed. Please try again.",raceIdPlaceholder:"RACE-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Photo for bib",gateJudge:"Gate Judge",gateJudgeTab:"Gate",deviceRole:"Device Role",deviceRoleDesc:"Timer records times, Gate Judge records faults",roleTimer:"Timer",roleGateJudge:"Gate Judge",gateAssignment:"Gate Assignment",noGateAssignment:"No gate assignment. Please set your gate range first.",gates:"Gates",gatesFrom:"From",gatesTo:"To",firstGateColor:"Color of first gate",colorRed:"Red",colorBlue:"Blue",changeGates:"Change",otherJudges:"Other judges:",activeBibs:"On Course",noBibsOnCourse:"No racers on course",recordFault:"Record Fault",faultType:"Fault Type",faultMG:"Missed Gate",faultSTR:"Straddling",faultBR:"Binding Release",faultMGShort:"MG",faultSTRShort:"STR",faultBRShort:"BR",orEnterManually:"or enter:",faultRecorded:"Fault recorded",signalReady:"Ready",judgeReady:"Ready for race!",judgeNotReady:"Ready status cleared",faultDeleted:"Fault deleted",recordedFaults:"Recorded Faults",selectBib:"Select Bib",selectGate:"Gate",gate:"Gate",noFaults:"No faults recorded",faultsFor:"Faults for",faultSummary:"Fault Summary",penaltyTime:"Penalty",faultCount:"faults",markOk:"Mark OK",saveFault:"Save Fault",selectFaultType:"Please select a fault type",gateOutOfRange:"Gate is outside assigned range",flt:"FLT",statusFlt:"Fault Penalty",chiefJudge:"Chief Judge",noFaultsRecorded:"No faults recorded",finalize:"Finalize",finalized:"Finalized",chiefJudgeMode:"Chief Judge Mode",chiefJudgeModeEnabled:"Chief Judge mode enabled",chiefJudgeModeDisabled:"Chief Judge mode disabled",racersWithFaults:"Racers with faults",penaltyMode:"+Time",gateJudges:"Gate Judges",noJudgesConnected:"No gate judges connected",summary:"Summary",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"No faults to export",copiedToClipboard:"Copied to clipboard",gateJudgeCard:"Gate Judge Card",race:"Race",date:"Date",gateJudgeLabel:"Gate Judge",runLabel:"Run",noFaultsEntered:"No faults entered",signature:"Signature",legend:"Legend",missedGateLegend:"Missed",straddlingLegend:"Straddling",bindingLegend:"Binding",gateFaults:"Gate Faults",penaltyLabel:"PENALTY",faultSummaryTitle:"GATE FAULT SUMMARY",faults:"Faults",penalty:"Penalty",sec:"sec",generated:"Generated",editFault:"Edit Fault",versionHistory:"Version History",restoreVersion:"Restore Selected Version",currentVersion:"Current",originalVersion:"Original",restored:"Restored",versionRestored:"Version restored",markForDeletion:"Mark for Deletion",markForDeletionText:"This fault will be marked for deletion and requires Chief Judge approval to permanently delete.",markedForDeletion:"Marked for deletion",deletionPending:"Deletion pending",pendingDeletions:"Pending Deletions",approveDeletion:"Approve Deletion",rejectDeletion:"Reject Deletion",deletionMarkedBy:"Marked by",deletionApproved:"Deletion approved",deletionRejected:"Deletion rejected",cannotEditPendingDeletion:"Cannot edit fault pending deletion",voiceMode:"Voice Mode",voiceModeDesc:"Hands-free voice commands (requires internet)",voiceListening:"Listening...",voiceProcessing:"Processing...",voiceConfirming:"Confirm?",voiceOffline:"Voice unavailable offline",voiceNotSupported:"Voice not supported in this browser",voicePermissionDenied:"Microphone access denied",voiceOK:"OK",voiceRecorded:"Recorded",voiceNotUnderstood:"Not understood",voiceCancelled:"Cancelled",voiceError:"Voice error",voiceApiKeyRequired:"API key required for voice mode",pullToRefresh:"Pull to refresh",releaseToRefresh:"Release to refresh",synced:"Synced",syncingStatus:"Syncing...",gateAssignmentInstructions:"Enter the gate range you are responsible for:",readySuffix:" - Ready",viewPhotoLabel:"View photo",editEntryLabel:"Edit entry",deleteEntryLabel:"Delete entry",editFaultLabel:"Edit fault",deleteFaultLabel:"Delete fault",deleteLabel:"Delete",gateNumberLabel:"Gate",numberLabel:"Number",currentTime:"Current time",pinVerifyOnline:"PIN will be verified when online",addNote:"Add Note",done:"Done",recordNote:"Record Note",listening:"Listening...",noteSaved:"Note saved",noteDeleted:"Note deleted",noteCharCount:"characters",voiceNoteUnsupported:"Voice input not supported in this browser",voiceNoteError:"Voice input error",typeNote:"Type or speak your note...",hasNote:"Has note",noteTextLabel:"Note text",recordVoiceNoteLabel:"Record voice note",syncOnline:"Sync online",syncOffline:"Offline",syncShortConnected:"Sync",syncShortSyncing:"Sync...",syncShortError:"Error",syncShortOff:"Off",syncDeviceAbbrev:"dev",sessionExpired:"Session expired. Please re-enter your PIN.",sessionExpiryWarning:"Session expires soon. Re-enter PIN to stay connected.",authSuccess:"Authentication successful",keyboardShortcuts:"Keyboard Shortcuts",keyboardShortcutsDesc:"Show all keyboard shortcuts",shortcutSection_timer:"Timer",shortcutSection_gateJudge:"Gate Judge",shortcutSection_results:"Results",shortcutSection_global:"Global",shortcut_enterDigit:"Enter bib digit",shortcut_selectStart:"Select Start",shortcut_selectFinish:"Select Finish",shortcut_selectRun1:"Select Run 1",shortcut_selectRun2:"Select Run 2",shortcut_recordTime:"Record timestamp",shortcut_clearBib:"Clear bib",shortcut_deleteLastDigit:"Delete last digit",shortcut_missedGate:"Missed Gate",shortcut_straddled:"Straddled",shortcut_broken:"Broken gate",shortcut_selectGate:"Select gate",shortcut_navigateBtns:"Navigate buttons",shortcut_confirmSelection:"Confirm selection",shortcut_navigateItems:"Navigate items",shortcut_editItem:"Edit item",shortcut_deleteItem:"Delete item",shortcut_moveTab:"Move between tabs",shortcut_closeModal:"Close modal",shortcut_navigateInComponent:"Navigate in component",shortcut_showShortcuts:"Show shortcuts",offlineBanner:"You are offline. Times will be saved locally.",onlineRestored:"Back online",entryDeleted:"Entry deleted",undoAction:"Undo",multiDeviceDuplicate:"Multi-device",duplicateDevices:"{count} devices",duplicateCount:"{count} duplicates"},de:{timer:"Timer",results:"Ergebnisse",settings:"Einstellungen",start:"Start",finish:"Ziel",startShort:"S",finishShort:"Z",bib:"Startnr.",point:"Punkt",run:"Lauf",run1:"L1",run2:"L2",runLabel1:"Lauf 1",runLabel2:"Lauf 2",time:"Zeit erfassen",lastRecorded:"Zuletzt erfasst",lastRecordedShort:"Letzter:",advancedSettings:"Erweiterte Einstellungen",status:"Status",noEntries:"Keine Einträge vorhanden",noEntriesHint:"Zeiten im Timer-Tab aufnehmen",search:"Startnr. suchen...",searchResults:"Ergebnisse durchsuchen",filter:"Filter",all:"Alle",total:"Gesamt",racers:"Fahrer",finished:"Im Ziel",entriesRecorded:"Einträge erfasst",fastest:"Schnellste",average:"Durchschnitt",timeEntry:"Zeit",timeEntries:"Zeiten",faultEntry:"Fehler",faultEntries:"Fehler",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Eintrag löschen",confirmDeleteText:"Möchten Sie diesen Eintrag wirklich löschen?",confirmDeleteFault:"Diesen Fehler löschen?",confirmClearAll:"Alle löschen",clearAllText:"Alle Einträge werden gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.",confirmUndoAdd:"Erfassung rückgängig",confirmUndoAddText:"Der erfasste Eintrag wird gelöscht. Fortfahren?",delete:"Löschen",cancel:"Abbrechen",close:"Schließen",back:"Zurück",save:"Speichern",saving:"Speichern...",edit:"Bearbeiten",undo:"Rückgängig",export:"Exportieren",clearAll:"Alle löschen",clearBibLabel:"Startnummer löschen",copyDebugInfo:"Debug-Info kopieren",faultNotes:"Notizen",judgesReadyCount:"Torrichter bereit",selectAll:"Alle auswählen",deleteSelected:"Ausgewählte löschen",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Von Cloud synchronisiert",faultSyncError:"Fehlersync fehlgeschlagen — Daten evtl. veraltet",filterByPoint:"Nach Messpunkt filtern",filterByStatus:"Nach Status filtern",raceId:"Rennen-ID",invalidRaceId:"Ungültige Rennen-ID. Nur Buchstaben, Zahlen, Bindestriche, Unterstriche.",deviceName:"Zeitnehmer-ID",cloudSync:"Cloud-Sync",syncStatus:"Sync-Status",pendingSync:"ausstehend",raceSetup:"Rennen einrichten",raceSetupDesc:"Erforderlich für Timing und Sync über mehrere Geräte.",firstGateLabel:"Erstes Tor",saved:"Gespeichert",deleted:"Gelöscht",cleared:"Alle Einträge gelöscht",undone:"Rückgängig gemacht",copied:"In Zwischenablage kopiert",debugInfoCopied:"Debug-Info in Zwischenablage kopiert",debugInfoCopyFailed:"Lange drücken um Debug-Info zu kopieren",duplicateWarning:"Doppelter Eintrag erkannt",zeroBibWarning:"Startnr. 000 - Eintrag prüfen",exported:"Erfolgreich exportiert",gps:"GPS",gpsActive:"GPS Aktiv",gpsSearching:"GPS wird gesucht...",gpsInactive:"GPS Inaktiv",gpsAccuracy:"Genauigkeit",settingsRaceSetup:"Rennen einrichten",settingsTimingGroup:"Zeitmessung",settingsSyncGroup:"Synchronisation",settingsFeedbackGroup:"Rückmeldung",settingsDisplayGroup:"Anzeige",simpleMode:"Einfacher Modus",fullMode:"Erweiterter Modus",autoIncrement:"Startnr. automatisch",hapticFeedback:"Vibration",soundFeedback:"Signalton",language:"Sprache",advancedSettingsHint:"Diese Optionen beeinflussen die Zeitmessung. Nur bei Bedarf ändern.",simpleModeDesc:"Vereinfachte Oberfläche für einfache Zeitmessung",cloudSyncDesc:"Mit anderen Geräten synchronisieren",gpsDesc:"GPS für genaue Zeitstempel verwenden",autoIncrementDesc:"Startnr. nach Erfassung erhöhen",photoCaptureDesc:"Foto bei Zeiterfassung aufnehmen",hapticFeedbackDesc:"Vibration bei Aktionen",soundFeedbackDesc:"Akustische Bestätigung",ambientMode:"Ruhemodus",ambientModeDesc:"Nach 30s Inaktivität abdunkeln",photoCapture:"Foto aufnehmen",photoCaptureActive:"Foto-Aufnahme aktiv",photoCaptured:"Foto aufgenommen",photoError:"Foto-Aufnahme fehlgeschlagen",photoSaveFailed:"Foto-Speicherung fehlgeschlagen",viewPhoto:"Foto anzeigen",deletePhoto:"Foto löschen",photoFor:"Foto für Startnr.",noPhotoAvailable:"Kein Foto verfügbar",photoDeleted:"Foto gelöscht",raceChangeTitle:"Rennen wechseln",raceChangeSyncedText:"Es gibt Ergebnisse von einem anderen Rennen. Exportieren oder löschen?",raceChangeUnsyncedText:"Es gibt bestehende Ergebnisse. Behalten oder löschen?",keepResults:"Behalten",version:"Version",devices:"Geräte",entries:"Einträge",selected:"ausgewählt",raceFound:"Rennen gefunden",raceNew:"Neues Rennen",entryInCloud:"Eintrag in der Cloud",entriesInCloud:"Einträge in der Cloud",photoTooLarge:"Foto zu groß für Sync",syncedEntriesFromCloud:"{count} Einträge aus Cloud synchronisiert",syncedFaultsFromCloud:"{count} Torfehler aus Cloud synchronisiert",crossDeviceDuplicate:"Duplikat: Startnr. {bib} {point} bereits von {device} erfasst",syncPhotos:"Fotos synchronisieren",syncPhotosDesc:"Fotos über Cloud mit anderen Geräten teilen",syncPhotosWarning:"Foto-Sync aktivieren",syncPhotosWarningText:"Aktivierung der Foto-Synchronisierung überträgt folgende Daten:",photosToUpload:"Fotos hochzuladen",photosToDownload:"Fotos herunterzuladen",totalDataVolume:"Gesamtes Datenvolumen",enableSync:"Sync aktivieren",noPhotosToSync:"Keine Fotos zu synchronisieren",admin:"Admin",adminPin:"Rennverwaltungs-PIN",adminPinDesc:"Erforderlich für Verwaltung und Sync",manageRaces:"Rennen verwalten",manageRacesDesc:"Synchronisierte Rennen anzeigen und löschen",manage:"Verwalten",enterAdminPin:"Rennverwaltungs-PIN eingeben",enterPinText:"Geben Sie Ihre PIN ein, um die Rennverwaltung zu öffnen.",enterPinToJoinRace:"Geben Sie Ihre PIN ein, um diesem Rennen beizutreten.",enterPinForChiefJudge:"Geben Sie Ihre PIN ein, um die Obmann-Ansicht zu öffnen.",enterChiefJudgePin:"Obmann-PIN eingeben",enterPinForChiefJudgeInfo:"Der Obmann-Modus erfordert eine separate PIN. Erste Eingabe setzt die PIN.",syncRequiresPin:"Sync deaktiviert. Aktivieren Sie Sync und geben Sie die PIN ein.",incorrectPin:"Falsche PIN",verify:"Bestätigen",setPinFirst:"Bitte zuerst Rennverwaltungs-PIN festlegen",pinSaved:"PIN gespeichert",pinCleared:"PIN gelöscht",pinNotSet:"Nicht gesetzt",pinSet:"PIN gesetzt",setPin:"PIN setzen",changePin:"PIN ändern",currentPin:"Aktuelle PIN",newPin:"Neue PIN (4 Ziffern)",confirmPin:"PIN bestätigen",pinMismatch:"PINs stimmen nicht überein",pinFormatError:"PIN muss genau 4 Ziffern haben",loading:"Laden...",noRaces:"Keine aktiven Rennen",noRacesHint:"In Einstellungen erstellen",cleanRunHint:"Bisher fehlerfreie Fahrt",refresh:"Aktualisieren",raceDeleted:"Rennen gelöscht",raceDeletedText:"Dieses Rennen wurde von einem Administrator gelöscht.",raceDeletedFor:"Rennen gelöscht:",raceDeletedSuccess:"Rennen gelöscht:",confirmDeleteRace:"Rennen löschen",confirmDeleteRaceText:"Möchten Sie das Rennen wirklich löschen",loadError:"Fehler beim Laden der Rennen. Verbindung prüfen und erneut versuchen.",deleteError:"Fehler beim Löschen des Rennens",entry:"Eintrag",device:"Gerät",storageError:"Speichern fehlgeschlagen - Speicher prüfen",storageQuotaError:"Speicher voll! Daten sofort exportieren",storageWarning:"Speicher fast voll",storageNearlyFull:"Speicher fast voll. Daten exportieren und alte Einträge löschen.",storageSaveGaveUp:"Daten NICHT auf Gerät gespeichert! Einträge jetzt exportieren.",networkError:"Netzwerkfehler - Verbindung prüfen",connectionFailed:"Verbindung fehlgeschlagen",serverUnavailable:"Server nicht erreichbar",rateLimitError:"Zu viele Anfragen - bitte warten",authError:"Authentifizierung fehlgeschlagen. PIN erneut eingeben.",syncFailed:"Synchronisierung fehlgeschlagen",pinSyncFailed:"PIN nicht in Cloud gespeichert",cameraError:"Kamerafehler",cameraPermissionDenied:"Kamerazugriff verweigert",gpsError:"GPS-Fehler",gpsPermissionDenied:"GPS-Zugriff verweigert",gpsUnavailable:"GPS nicht verfügbar",wakeLockFailed:"Bildschirm kann während Zeitmessung abdunkeln",wakeLockIdleTimeout:"Bildschirm wird gedimmt um Akku zu sparen. Tippen zum Wachhalten.",unknownError:"Unbekannter Fehler",onboardingWelcome:"Willkommen bei CHRONO",onboardingWelcomeDesc:"GPS-synchronisierte Zeitmessung für Skirennen",getStarted:"Los geht's",skipSetup:"Überspringen",onboardingRole:"Was ist deine Aufgabe?",onboardingRoleDesc:"Wähle aus, wie du beim Rennen hilfst",roleTimerTitle:"Zeitnehmer",roleTimerDesc:"Du erfasst Start- und Zielzeiten",roleJudgeTitle:"Torrichter",roleJudgeDesc:"Du erfasst Torfehler",onboardingDeviceName:"Timer benennen",onboardingDeviceNameDesc:"Dieser Name identifiziert dein Gerät beim Synchronisieren",onboardingDeviceNameJudge:"Dein Name",onboardingDeviceNameJudgeDesc:"Dies identifiziert dich als Torrichter",onboardingPhoto:"Foto-Dokumentation",onboardingPhotoDesc:"Automatisch ein Foto bei jeder Zeiterfassung aufnehmen. Nützlich zur Überprüfung von Startnr. und bei Unstimmigkeiten.",enablePhotoCapture:"Foto-Aufnahme aktivieren",photoCaptureLabel:"Foto-Aufnahme",onboardingGates:"Deine Tor-Zuweisung",onboardingGatesDesc:"Gib die Tornummern ein, die du beobachtest. Du kannst dies später ändern.",onboardingRaceSetup:"Rennen beitreten",onboardingRaceSetupDesc:"Gib eine Rennen-ID ein um mit anderen Timern zu synchronisieren",onboardingRaceIdPlaceholder:"z.B. RENNEN-2024",onboardingPinPlaceholder:"PIN (4 Ziffern)",onboardingStepOf:"Schritt {current} von {total}",skipForNow:"Vorerst überspringen",onboardingReady:"Bereit zur Zeitmessung!",onboardingReadyJudge:"Bereit als Torrichter!",onboardingTip:"Tippe auf den großen blauen Button um Zeiten zu erfassen",onboardingTipJudge:"Tippe auf eine Startnr. um einen Fehler zu erfassen",startTiming:"Zeitmessung starten",startJudging:"Starten",continue:"Weiter",deviceNameLabel:"Gerätename",raceIdLabel:"Rennen-ID",syncStatusLabel:"Cloud-Sync",enabled:"Aktiviert",disabled:"Deaktiviert",showTutorial:"Tutorial anzeigen",showTutorialDesc:"Setup-Assistenten erneut starten",show:"Anzeigen",onboardingComplete:"Einrichtung abgeschlossen!",invalidPin:"PIN muss 4 Ziffern haben",recentRaces:"Letzte Rennen",noRecentRaces:"Keine Rennen von heute",errorOccurred:"Ein Fehler ist aufgetreten",errorRecoveryMessage:"Die App hat einen Fehler festgestellt. Sie können diesen Hinweis schließen und fortfahren, oder die App neu laden.",dismiss:"Schließen",skipToMain:"Zum Hauptinhalt springen",reload:"Neu laden",updateAvailable:"Update verfügbar! Neu laden für die neueste Version.",operationFailed:"Vorgang fehlgeschlagen. Bitte erneut versuchen.",raceIdPlaceholder:"RENNEN-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Foto für Startnr.",gateJudge:"Torrichter",gateJudgeTab:"Tor",deviceRole:"Geräte-Rolle",deviceRoleDesc:"Timer erfasst Zeiten, Torrichter erfasst Fehler",roleTimer:"Zeitnehmer",roleGateJudge:"Torrichter",gateAssignment:"Tor-Zuweisung",noGateAssignment:"Keine Tor-Zuweisung. Bitte zuerst den Torbereich festlegen.",gates:"Tore",gatesFrom:"Von",gatesTo:"Bis",firstGateColor:"Farbe des ersten Tors",colorRed:"Rot",colorBlue:"Blau",changeGates:"Ändern",otherJudges:"Andere Torrichter:",activeBibs:"Auf der Strecke",noBibsOnCourse:"Keine Fahrer auf der Strecke",recordFault:"Fehler erfassen",faultType:"Fehlerart",faultMG:"Tor ausgelassen",faultSTR:"Einfädler",faultBR:"Bindung offen",faultMGShort:"TF",faultSTRShort:"EF",faultBRShort:"BO",orEnterManually:"oder eingeben:",faultRecorded:"Fehler erfasst",signalReady:"Bereit",judgeReady:"Bereit für Rennen!",judgeNotReady:"Bereit-Status zurückgesetzt",faultDeleted:"Fehler gelöscht",recordedFaults:"Erfasste Fehler",selectBib:"Startnr. wählen",selectGate:"Tor",gate:"Tor",noFaults:"Keine Fehler erfasst",faultsFor:"Fehler für",faultSummary:"Fehler-Übersicht",penaltyTime:"Strafzeit",faultCount:"Fehler",markOk:"OK markieren",saveFault:"Fehler speichern",selectFaultType:"Bitte Fehlerart wählen",gateOutOfRange:"Tor liegt außerhalb des zugewiesenen Bereichs",flt:"SZT",statusFlt:"Strafzeit",chiefJudge:"Obmann",noFaultsRecorded:"Keine Fehler erfasst",finalize:"Bestätigen",finalized:"Bestätigt",chiefJudgeMode:"Obmann-Ansicht",chiefJudgeModeEnabled:"Obmann-Ansicht aktiviert",chiefJudgeModeDisabled:"Obmann-Ansicht deaktiviert",racersWithFaults:"Fahrer mit Fehlern",penaltyMode:"+Zeit",gateJudges:"Torrichter",noJudgesConnected:"Keine Torrichter verbunden",summary:"Übersicht",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"Keine Fehler zum Exportieren",copiedToClipboard:"In Zwischenablage kopiert",gateJudgeCard:"Torrichterkarte",race:"Rennen",date:"Datum",gateJudgeLabel:"Torrichter",runLabel:"Lauf",noFaultsEntered:"Keine Fehler erfasst",signature:"Unterschrift",legend:"Legende",missedGateLegend:"Ausgelassen",straddlingLegend:"Einfädler",bindingLegend:"Bindung",gateFaults:"Torfehler",penaltyLabel:"STRAFZEIT",faultSummaryTitle:"ZUSAMMENFASSUNG TORFEHLER",faults:"Fehler",penalty:"Strafzeit",sec:"Sek",generated:"Erstellt",editFault:"Fehler bearbeiten",versionHistory:"Versionshistorie",restoreVersion:"Version wiederherstellen",currentVersion:"Aktuell",originalVersion:"Original",restored:"Wiederhergestellt",versionRestored:"Version wiederhergestellt",markForDeletion:"Zum Löschen markieren",markForDeletionText:"Dieser Fehler wird zum Löschen markiert und benötigt die Genehmigung des Obmanns für die endgültige Löschung.",markedForDeletion:"Zum Löschen markiert",deletionPending:"Löschung ausstehend",pendingDeletions:"Ausstehende Löschungen",approveDeletion:"Löschung genehmigen",rejectDeletion:"Löschung ablehnen",deletionMarkedBy:"Markiert von",deletionApproved:"Löschung genehmigt",deletionRejected:"Löschung abgelehnt",cannotEditPendingDeletion:"Fehler mit ausstehender Löschung kann nicht bearbeitet werden",voiceMode:"Sprachsteuerung",voiceModeDesc:"Freihändige Sprachbefehle (Internet erforderlich)",voiceListening:"Höre zu...",voiceProcessing:"Verarbeite...",voiceConfirming:"Bestätigen?",voiceOffline:"Sprache offline nicht verfügbar",voiceNotSupported:"Spracheingabe in diesem Browser nicht unterstützt",voicePermissionDenied:"Mikrofonzugriff verweigert",voiceOK:"OK",voiceRecorded:"Erfasst",voiceNotUnderstood:"Nicht verstanden",voiceCancelled:"Abgebrochen",voiceError:"Sprachfehler",voiceApiKeyRequired:"API-Schlüssel für Sprachsteuerung erforderlich",pullToRefresh:"Zum Aktualisieren ziehen",releaseToRefresh:"Loslassen zum Aktualisieren",synced:"Synchronisiert",syncingStatus:"Synchronisiere...",gateAssignmentInstructions:"Gib den Torbereich ein, für den du verantwortlich bist:",readySuffix:" - Bereit",viewPhotoLabel:"Foto anzeigen",editEntryLabel:"Eintrag bearbeiten",deleteEntryLabel:"Eintrag löschen",editFaultLabel:"Fehler bearbeiten",deleteFaultLabel:"Fehler löschen",deleteLabel:"Löschen",gateNumberLabel:"Tor",numberLabel:"Zahl",currentTime:"Aktuelle Uhrzeit",pinVerifyOnline:"PIN wird online überprüft",addNote:"Notiz hinzufügen",done:"Fertig",recordNote:"Notiz aufnehmen",listening:"Höre zu...",noteSaved:"Notiz gespeichert",noteDeleted:"Notiz gelöscht",noteCharCount:"Zeichen",voiceNoteUnsupported:"Spracheingabe in diesem Browser nicht unterstützt",voiceNoteError:"Spracheingabe-Fehler",typeNote:"Notiz eintippen oder sprechen...",hasNote:"Hat Notiz",noteTextLabel:"Notiztext",recordVoiceNoteLabel:"Sprachnotiz aufnehmen",syncOnline:"Sync online",syncOffline:"Offline",syncShortConnected:"Sync",syncShortSyncing:"Sync...",syncShortError:"Fehler",syncShortOff:"Aus",syncDeviceAbbrev:"G",sessionExpired:"Sitzung abgelaufen. Bitte PIN erneut eingeben.",sessionExpiryWarning:"Sitzung läuft bald ab. PIN erneut eingeben, um verbunden zu bleiben.",authSuccess:"Authentifizierung erfolgreich",keyboardShortcuts:"Tastenkürzel",keyboardShortcutsDesc:"Alle Tastenkürzel anzeigen",shortcutSection_timer:"Timer",shortcutSection_gateJudge:"Torrichter",shortcutSection_results:"Ergebnisse",shortcutSection_global:"Allgemein",shortcut_enterDigit:"Startnr.-Ziffer eingeben",shortcut_selectStart:"Start wählen",shortcut_selectFinish:"Ziel wählen",shortcut_selectRun1:"Lauf 1 wählen",shortcut_selectRun2:"Lauf 2 wählen",shortcut_recordTime:"Zeitstempel erfassen",shortcut_clearBib:"Startnr. löschen",shortcut_deleteLastDigit:"Letzte Ziffer löschen",shortcut_missedGate:"Tor ausgelassen",shortcut_straddled:"Einfädler",shortcut_broken:"Bindung offen",shortcut_selectGate:"Tor wählen",shortcut_navigateBtns:"Buttons navigieren",shortcut_confirmSelection:"Auswahl bestätigen",shortcut_navigateItems:"Einträge navigieren",shortcut_editItem:"Eintrag bearbeiten",shortcut_deleteItem:"Eintrag löschen",shortcut_moveTab:"Zwischen Tabs wechseln",shortcut_closeModal:"Dialog schließen",shortcut_navigateInComponent:"In Komponente navigieren",shortcut_showShortcuts:"Tastenkürzel anzeigen",offlineBanner:"Offline. Zeiten werden lokal gespeichert.",onlineRestored:"Wieder online",entryDeleted:"Eintrag gelöscht",undoAction:"Rückgängig",multiDeviceDuplicate:"Mehrere Geräte",duplicateDevices:"{count} Geräte",duplicateCount:"{count} Duplikate"},fr:{timer:"Chrono",results:"Résultats",settings:"Paramètres",start:"Départ",finish:"Arrivée",startShort:"D",finishShort:"A",bib:"Dossard",point:"Point",run:"Manche",run1:"M1",run2:"M2",runLabel1:"Manche 1",runLabel2:"Manche 2",time:"Enregistrer le temps",lastRecorded:"Dernier enregistré",lastRecordedShort:"Dernier :",advancedSettings:"Paramètres avancés",status:"Statut",noEntries:"Aucune entrée enregistrée",noEntriesHint:"Enregistrez des temps dans l'onglet Chrono",search:"Rechercher par dossard...",searchResults:"Résultats de recherche",filter:"Filtrer",all:"Tous",total:"Total",racers:"Coureurs",finished:"À l'arrivée",entriesRecorded:"entrées enregistrées",fastest:"Plus rapide",average:"Moyenne",timeEntry:"temps",timeEntries:"temps",faultEntry:"faute",faultEntries:"fautes",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Supprimer l'entrée",confirmDeleteText:"Voulez-vous vraiment supprimer cette entrée ?",confirmDeleteFault:"Supprimer cette faute ?",confirmClearAll:"Tout effacer",clearAllText:"Toutes les entrées seront supprimées. Cette action est irréversible.",confirmUndoAdd:"Annuler l'enregistrement",confirmUndoAddText:"L'entrée enregistrée sera supprimée. Continuer ?",delete:"Supprimer",cancel:"Annuler",close:"Fermer",back:"Retour",save:"Enregistrer",saving:"Enregistrement...",edit:"Modifier",undo:"Annuler",export:"Exporter",clearAll:"Tout effacer",clearBibLabel:"Effacer le dossard",copyDebugInfo:"Copier les infos de débogage",faultNotes:"Notes",judgesReadyCount:"Juges prêts",selectAll:"Tout sélectionner",deleteSelected:"Supprimer la sélection",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Synchronisé depuis le cloud",faultSyncError:"Sync des fautes échoué — données peut-être obsolètes",filterByPoint:"Filtrer par point",filterByStatus:"Filtrer par statut",raceId:"ID de course",invalidRaceId:"ID de course invalide. Utilisez uniquement lettres, chiffres, tirets et underscores.",deviceName:"ID du chronométreur",cloudSync:"Sync cloud",syncStatus:"État de la sync",pendingSync:"sync en attente",raceSetup:"Configuration de course",raceSetupDesc:"Requis pour le chronométrage multi-appareils et la synchronisation.",firstGateLabel:"Première porte",saved:"Enregistré",deleted:"Supprimé",cleared:"Toutes les entrées effacées",undone:"Annulé",copied:"Copié dans le presse-papiers",debugInfoCopied:"Infos de débogage copiées dans le presse-papiers",debugInfoCopyFailed:"Appuyez longuement pour copier les infos de débogage",duplicateWarning:"Doublon détecté",zeroBibWarning:"Dossard 000 - vérifiez l'entrée",exported:"Exporté avec succès",gps:"GPS",gpsActive:"GPS actif",gpsSearching:"Recherche GPS...",gpsInactive:"GPS inactif",gpsAccuracy:"Précision",settingsRaceSetup:"Configuration de course",settingsTimingGroup:"Chronométrage",settingsSyncGroup:"Synchronisation",settingsFeedbackGroup:"Retour",settingsDisplayGroup:"Affichage",simpleMode:"Mode simplifié",fullMode:"Mode complet",autoIncrement:"Dossard auto-incrémenté",hapticFeedback:"Retour haptique",soundFeedback:"Retour sonore",language:"Langue",advancedSettingsHint:"Ces options peuvent affecter la précision du chronométrage. Modifier uniquement si nécessaire.",simpleModeDesc:"Interface simplifiée pour un chronométrage basique",cloudSyncDesc:"Synchroniser avec d'autres appareils",gpsDesc:"Utiliser le GPS pour des horodatages précis",autoIncrementDesc:"Augmenter le numéro de dossard après l'enregistrement",photoCaptureDesc:"Capturer une photo à l'enregistrement du temps",hapticFeedbackDesc:"Vibration lors des actions",soundFeedbackDesc:"Confirmation sonore",ambientMode:"Mode veille",ambientModeDesc:"Atténuer après 30s d'inactivité",photoCapture:"Capture photo",photoCaptureActive:"Capture photo active",photoCaptured:"Photo capturée",photoError:"Échec de la capture photo",photoSaveFailed:"Échec de la sauvegarde photo",viewPhoto:"Voir la photo",deletePhoto:"Supprimer la photo",photoFor:"Photo pour dossard",noPhotoAvailable:"Aucune photo disponible",photoDeleted:"Photo supprimée",raceChangeTitle:"Changer de course",raceChangeSyncedText:"Vous avez des résultats d'une autre course. Les exporter ou les supprimer avant de changer ?",raceChangeUnsyncedText:"Vous avez des résultats existants. Les garder ou les supprimer avant de changer ?",keepResults:"Garder",version:"Version",devices:"Appareils",entries:"entrées",selected:"sélectionné(s)",raceFound:"Course trouvée",raceNew:"Nouvelle course",entryInCloud:"entrée dans le cloud",entriesInCloud:"entrées dans le cloud",photoTooLarge:"Photo trop volumineuse pour la sync",syncedEntriesFromCloud:"{count} entrées synchronisées depuis le cloud",syncedFaultsFromCloud:"{count} fautes synchronisées depuis le cloud",crossDeviceDuplicate:"Doublon : Dossard {bib} {point} déjà enregistré par {device}",syncPhotos:"Synchroniser les photos",syncPhotosDesc:"Partager les photos entre appareils via le cloud",syncPhotosWarning:"Activer la sync des photos",syncPhotosWarningText:"L'activation de la synchronisation des photos transférera les données suivantes :",photosToUpload:"Photos à envoyer",photosToDownload:"Photos à télécharger",totalDataVolume:"Volume total de données",enableSync:"Activer la sync",noPhotosToSync:"Aucune photo à synchroniser",admin:"Admin",adminPin:"PIN de gestion des courses",adminPinDesc:"Requis pour gérer et synchroniser les courses",manageRaces:"Gérer les courses",manageRacesDesc:"Afficher et supprimer les courses synchronisées",manage:"Gérer",enterAdminPin:"Entrez le PIN de gestion des courses",enterPinText:"Entrez votre PIN pour accéder à la gestion des courses.",enterPinToJoinRace:"Entrez votre PIN pour rejoindre cette course.",enterPinForChiefJudge:"Entrez votre PIN pour accéder au mode Directeur de course.",enterChiefJudgePin:"Entrez le PIN Directeur de course",enterPinForChiefJudgeInfo:"Le mode Directeur de course nécessite un PIN séparé. La première saisie définit le PIN.",syncRequiresPin:"Sync désactivée. Activez la sync et entrez le PIN pour vous reconnecter.",incorrectPin:"PIN incorrect",verify:"Vérifier",setPinFirst:"Veuillez d'abord définir un PIN de gestion des courses",pinSaved:"PIN enregistré",pinCleared:"PIN effacé",pinNotSet:"Non défini",pinSet:"PIN défini",setPin:"Définir le PIN",changePin:"Changer le PIN",currentPin:"PIN actuel",newPin:"Nouveau PIN (4 chiffres)",confirmPin:"Confirmer le PIN",pinMismatch:"Les PIN ne correspondent pas",pinFormatError:"Le PIN doit comporter exactement 4 chiffres",loading:"Chargement...",noRaces:"Aucune course active",noRacesHint:"Créez-en une dans les Paramètres",cleanRunHint:"Manche sans faute jusqu'ici",refresh:"Actualiser",raceDeleted:"Course supprimée",raceDeletedText:"Cette course a été supprimée par un administrateur.",raceDeletedFor:"Course supprimée :",raceDeletedSuccess:"Course supprimée :",confirmDeleteRace:"Supprimer la course",confirmDeleteRaceText:"Voulez-vous vraiment supprimer la course",loadError:"Échec du chargement des courses. Vérifiez votre connexion et réessayez.",deleteError:"Échec de la suppression de la course",entry:"entrée",device:"appareil",storageError:"Échec de la sauvegarde - vérifiez le stockage",storageQuotaError:"Stockage plein ! Exportez les données immédiatement",storageWarning:"Stockage presque plein",storageNearlyFull:"Stockage presque plein. Exportez les données et supprimez les anciennes entrées.",storageSaveGaveUp:"Données NON enregistrées ! Exportez les entrées maintenant.",networkError:"Erreur réseau - vérifiez la connexion",connectionFailed:"Connexion échouée",serverUnavailable:"Serveur indisponible",rateLimitError:"Trop de requêtes - veuillez patienter",authError:"Authentification échouée. Veuillez ressaisir votre PIN.",syncFailed:"Synchronisation échouée",pinSyncFailed:"PIN non synchronisé avec le cloud",cameraError:"Erreur caméra",cameraPermissionDenied:"Accès à la caméra refusé",gpsError:"Erreur GPS",gpsPermissionDenied:"Accès GPS refusé",gpsUnavailable:"GPS indisponible",wakeLockFailed:"L'écran peut s'éteindre pendant le chronométrage",wakeLockIdleTimeout:"L'écran va s'atténuer pour économiser la batterie. Touchez pour maintenir l'écran actif.",unknownError:"Erreur inconnue",onboardingWelcome:"Bienvenue sur CHRONO",onboardingWelcomeDesc:"Chronométrage synchronisé par GPS pour les courses de ski",getStarted:"C'est parti",skipSetup:"Passer",onboardingRole:"Quel est votre rôle ?",onboardingRoleDesc:"Choisissez comment vous aiderez à la course",roleTimerTitle:"Chronométreur",roleTimerDesc:"Vous enregistrerez les temps de départ et d'arrivée",roleJudgeTitle:"Juge de porte",roleJudgeDesc:"Vous enregistrerez les fautes de porte",onboardingDeviceName:"Nommez votre chronomètre",onboardingDeviceNameDesc:"Ce nom identifie votre appareil lors de la synchronisation",onboardingDeviceNameJudge:"Votre nom",onboardingDeviceNameJudgeDesc:"Ceci vous identifie en tant que juge de porte",onboardingPhoto:"Documentation photo",onboardingPhotoDesc:"Capturer automatiquement une photo à chaque enregistrement de temps. Utile pour vérifier les numéros de dossard et résoudre les litiges.",enablePhotoCapture:"Activer la capture photo",photoCaptureLabel:"Capture photo",onboardingGates:"Votre affectation de portes",onboardingGatesDesc:"Entrez les numéros de portes que vous surveillerez. Vous pourrez les modifier plus tard.",onboardingRaceSetup:"Rejoindre une course",onboardingRaceSetupDesc:"Entrez un ID de course pour synchroniser avec d'autres chronométreurs",onboardingRaceIdPlaceholder:"ex. COURSE-2024",onboardingPinPlaceholder:"PIN (4 chiffres)",onboardingStepOf:"Étape {current} sur {total}",skipForNow:"Passer pour le moment",onboardingReady:"Prêt à chronométrer !",onboardingReadyJudge:"Prêt à juger !",onboardingTip:"Appuyez sur le grand bouton bleu pour enregistrer les temps",onboardingTipJudge:"Appuyez sur le dossard d'un coureur pour enregistrer une faute",startTiming:"Démarrer le chronométrage",startJudging:"Commencer à juger",continue:"Continuer",deviceNameLabel:"Nom de l'appareil",raceIdLabel:"ID de course",syncStatusLabel:"Sync cloud",enabled:"Activé",disabled:"Désactivé",showTutorial:"Afficher le tutoriel",showTutorialDesc:"Relancer l'assistant de configuration",show:"Afficher",onboardingComplete:"Configuration terminée !",invalidPin:"Le PIN doit comporter 4 chiffres",recentRaces:"Courses récentes",noRecentRaces:"Aucune course aujourd'hui",errorOccurred:"Une erreur s'est produite",errorRecoveryMessage:"L'application a rencontré une erreur. Vous pouvez ignorer cet avis et continuer, ou recharger l'application.",dismiss:"Ignorer",skipToMain:"Aller au contenu principal",reload:"Recharger",updateAvailable:"Mise à jour disponible ! Rechargez pour obtenir la dernière version.",operationFailed:"Opération échouée. Veuillez réessayer.",raceIdPlaceholder:"COURSE-001",deviceNamePlaceholder:"Chrono 1",photoForBib:"Photo pour dossard",gateJudge:"Juge de porte",gateJudgeTab:"Porte",deviceRole:"Rôle de l'appareil",deviceRoleDesc:"Le chronométreur enregistre les temps, le juge de porte enregistre les fautes",roleTimer:"Chronométreur",roleGateJudge:"Juge de porte",gateAssignment:"Affectation de portes",noGateAssignment:"Aucune affectation de portes. Veuillez d'abord définir votre zone de portes.",gates:"Portes",gatesFrom:"De",gatesTo:"À",firstGateColor:"Couleur de la première porte",colorRed:"Rouge",colorBlue:"Bleu",changeGates:"Modifier",otherJudges:"Autres juges :",activeBibs:"Sur la piste",noBibsOnCourse:"Aucun coureur sur la piste",recordFault:"Enregistrer une faute",faultType:"Type de faute",faultMG:"Porte manquée",faultSTR:"Enfourché",faultBR:"Fixation ouverte",faultMGShort:"PM",faultSTRShort:"ENF",faultBRShort:"FO",orEnterManually:"ou saisir :",faultRecorded:"Faute enregistrée",signalReady:"Prêt",judgeReady:"Prêt pour la course !",judgeNotReady:"Statut prêt effacé",faultDeleted:"Faute supprimée",recordedFaults:"Fautes enregistrées",selectBib:"Sélectionner le dossard",selectGate:"Porte",gate:"Porte",noFaults:"Aucune faute enregistrée",faultsFor:"Fautes pour",faultSummary:"Résumé des fautes",penaltyTime:"Pénalité",faultCount:"fautes",markOk:"Marquer OK",saveFault:"Enregistrer la faute",selectFaultType:"Veuillez sélectionner un type de faute",gateOutOfRange:"La porte est en dehors de la zone assignée",flt:"PEN",statusFlt:"Pénalité de faute",chiefJudge:"Directeur de course",noFaultsRecorded:"Aucune faute enregistrée",finalize:"Valider",finalized:"Validé",chiefJudgeMode:"Mode Directeur de course",chiefJudgeModeEnabled:"Mode Directeur de course activé",chiefJudgeModeDisabled:"Mode Directeur de course désactivé",racersWithFaults:"Coureurs avec fautes",penaltyMode:"+Temps",gateJudges:"Juges de porte",noJudgesConnected:"Aucun juge de porte connecté",summary:"Résumé",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"Aucune faute à exporter",copiedToClipboard:"Copié dans le presse-papiers",gateJudgeCard:"Carte de juge de porte",race:"Course",date:"Date",gateJudgeLabel:"Juge de porte",runLabel:"Manche",noFaultsEntered:"Aucune faute enregistrée",signature:"Signature",legend:"Légende",missedGateLegend:"Manquée",straddlingLegend:"Enfourché",bindingLegend:"Fixation",gateFaults:"Fautes de porte",penaltyLabel:"PÉNALITÉ",faultSummaryTitle:"RÉSUMÉ DES FAUTES DE PORTE",faults:"Fautes",penalty:"Pénalité",sec:"sec",generated:"Généré",editFault:"Modifier la faute",versionHistory:"Historique des versions",restoreVersion:"Restaurer la version sélectionnée",currentVersion:"Actuelle",originalVersion:"Originale",restored:"Restaurée",versionRestored:"Version restaurée",markForDeletion:"Marquer pour suppression",markForDeletionText:"Cette faute sera marquée pour suppression et nécessite l'approbation du Directeur de course pour être définitivement supprimée.",markedForDeletion:"Marquée pour suppression",deletionPending:"Suppression en attente",pendingDeletions:"Suppressions en attente",approveDeletion:"Approuver la suppression",rejectDeletion:"Rejeter la suppression",deletionMarkedBy:"Marquée par",deletionApproved:"Suppression approuvée",deletionRejected:"Suppression rejetée",cannotEditPendingDeletion:"Impossible de modifier une faute en attente de suppression",voiceMode:"Mode vocal",voiceModeDesc:"Commandes vocales mains libres (Internet requis)",voiceListening:"Écoute...",voiceProcessing:"Traitement...",voiceConfirming:"Confirmer ?",voiceOffline:"Voix indisponible hors ligne",voiceNotSupported:"Voix non supportée dans ce navigateur",voicePermissionDenied:"Accès au microphone refusé",voiceOK:"OK",voiceRecorded:"Enregistré",voiceNotUnderstood:"Non compris",voiceCancelled:"Annulé",voiceError:"Erreur vocale",voiceApiKeyRequired:"Clé API requise pour le mode vocal",pullToRefresh:"Tirez pour actualiser",releaseToRefresh:"Relâchez pour actualiser",synced:"Synchronisé",syncingStatus:"Synchronisation...",gateAssignmentInstructions:"Entrez la zone de portes dont vous êtes responsable :",readySuffix:" - Prêt",viewPhotoLabel:"Voir la photo",editEntryLabel:"Modifier l'entrée",deleteEntryLabel:"Supprimer l'entrée",editFaultLabel:"Modifier la faute",deleteFaultLabel:"Supprimer la faute",deleteLabel:"Supprimer",gateNumberLabel:"Porte",numberLabel:"Numéro",currentTime:"Heure actuelle",pinVerifyOnline:"Le PIN sera vérifié une fois en ligne",addNote:"Ajouter une note",done:"Terminé",recordNote:"Enregistrer une note",listening:"Écoute...",noteSaved:"Note enregistrée",noteDeleted:"Note supprimée",noteCharCount:"caractères",voiceNoteUnsupported:"Saisie vocale non supportée dans ce navigateur",voiceNoteError:"Erreur de saisie vocale",typeNote:"Tapez ou dictez votre note...",hasNote:"A une note",noteTextLabel:"Texte de la note",recordVoiceNoteLabel:"Enregistrer une note vocale",syncOnline:"Sync en ligne",syncOffline:"Hors ligne",syncShortConnected:"Sync",syncShortSyncing:"Sync...",syncShortError:"Erreur",syncShortOff:"Off",syncDeviceAbbrev:"app",sessionExpired:"Session expirée. Veuillez ressaisir votre PIN.",sessionExpiryWarning:"Session expire bientôt. Ressaisir le PIN pour rester connecté.",authSuccess:"Authentification réussie",keyboardShortcuts:"Raccourcis clavier",keyboardShortcutsDesc:"Afficher tous les raccourcis clavier",shortcutSection_timer:"Chrono",shortcutSection_gateJudge:"Juge de porte",shortcutSection_results:"Résultats",shortcutSection_global:"Général",shortcut_enterDigit:"Entrer un chiffre de dossard",shortcut_selectStart:"Sélectionner Départ",shortcut_selectFinish:"Sélectionner Arrivée",shortcut_selectRun1:"Sélectionner Manche 1",shortcut_selectRun2:"Sélectionner Manche 2",shortcut_recordTime:"Enregistrer le temps",shortcut_clearBib:"Effacer le dossard",shortcut_deleteLastDigit:"Supprimer le dernier chiffre",shortcut_missedGate:"Porte manquée",shortcut_straddled:"Enfourché",shortcut_broken:"Fixation ouverte",shortcut_selectGate:"Sélectionner la porte",shortcut_navigateBtns:"Naviguer entre les boutons",shortcut_confirmSelection:"Confirmer la sélection",shortcut_navigateItems:"Naviguer entre les éléments",shortcut_editItem:"Modifier l'élément",shortcut_deleteItem:"Supprimer l'élément",shortcut_moveTab:"Changer d'onglet",shortcut_closeModal:"Fermer la modale",shortcut_navigateInComponent:"Naviguer dans le composant",shortcut_showShortcuts:"Afficher les raccourcis",offlineBanner:"Vous êtes hors ligne. Les temps seront sauvegardés localement.",onlineRestored:"De retour en ligne",entryDeleted:"Entrée supprimée",undoAction:"Annuler",multiDeviceDuplicate:"Multi-appareils",duplicateDevices:"{count} appareils",duplicateCount:"{count} doublons"}};function p(n,e="de"){const t=at[e],i=at.en;return t[n]||i[n]||n}const d={debug:()=>{},log:()=>{},info:()=>{},warn:console.warn.bind(console),error:console.error.bind(console)},rn=.3,an=.15,on=.05;class cn{constructor(){c(this,"battery",null);c(this,"isInitialized",!1);c(this,"callbacks",new Set);c(this,"currentStatus",{level:1,charging:!0,batteryLevel:"normal"});c(this,"levelChangeHandler",null);c(this,"chargingChangeHandler",null)}isSupported(){return"getBattery"in navigator}async initialize(){if(this.isInitialized)return!0;if(!this.isSupported())return!1;try{return this.battery=await navigator.getBattery(),this.isInitialized=!0,this.updateStatus(),this.levelChangeHandler=()=>this.updateStatus(),this.chargingChangeHandler=()=>this.updateStatus(),this.battery.addEventListener("levelchange",this.levelChangeHandler),this.battery.addEventListener("chargingchange",this.chargingChangeHandler),!0}catch(e){return d.warn("Failed to initialize battery service:",e),!1}}updateStatus(){if(!this.battery)return;const e=this.battery.level,t=this.battery.charging;let i="normal";t||(e<=on?i="critical":e<=an?i="low":e<=rn&&(i="medium"));const s={level:e,charging:t,batteryLevel:i},r=this.currentStatus.level!==s.level||this.currentStatus.charging!==s.charging||this.currentStatus.batteryLevel!==s.batteryLevel;this.currentStatus=s,r&&this.notifySubscribers()}notifySubscribers(){for(const e of this.callbacks)try{e(this.currentStatus)}catch(t){d.error("Battery callback error:",t)}}subscribe(e){return this.callbacks.add(e),e(this.currentStatus),()=>{this.callbacks.delete(e)}}getStatus(){return{...this.currentStatus}}isLowBattery(){return this.currentStatus.batteryLevel==="low"||this.currentStatus.batteryLevel==="critical"}isCriticalBattery(){return this.currentStatus.batteryLevel==="critical"}isCharging(){return this.currentStatus.charging}getLevelPercent(){return Math.round(this.currentStatus.level*100)}cleanup(){this.battery&&(this.levelChangeHandler&&(this.battery.removeEventListener("levelchange",this.levelChangeHandler),this.levelChangeHandler=null),this.chargingChangeHandler&&(this.battery.removeEventListener("chargingchange",this.chargingChangeHandler),this.chargingChangeHandler=null),this.battery=null),this.callbacks.clear(),this.isInitialized=!1}}const A=new cn;class ln{constructor(){c(this,"isInitialized",!1);c(this,"isEnabled",!1);c(this,"isAmbientActive",!1);c(this,"triggeredBy",null);c(this,"lastActivityTimestamp",Date.now());c(this,"inactivityCheckId",null);c(this,"batteryUnsubscribe",null);c(this,"callbacks",new Set);c(this,"lastExitTimestamp",0);c(this,"activityHandler",null);c(this,"visibilityHandler",null);c(this,"INACTIVITY_THRESHOLD_MS",3e4)}initialize(){this.isInitialized||(this.isInitialized=!0,this.batteryUnsubscribe=A.subscribe(e=>{e.batteryLevel==="critical"&&!e.charging&&this.isEnabled&&this.enterAmbientMode("battery"),e.charging&&this.isAmbientActive&&this.triggeredBy==="battery"&&this.exitAmbientMode()}),this.activityHandler=()=>this.resetInactivityTimer(),document.addEventListener("touchstart",this.activityHandler,{passive:!0}),document.addEventListener("click",this.activityHandler,{passive:!0}),document.addEventListener("keydown",this.activityHandler,{passive:!0}),this.visibilityHandler=()=>{document.hidden?this.stopInactivityMonitor():this.isEnabled&&(this.lastActivityTimestamp=Date.now(),this.startInactivityMonitor())},document.addEventListener("visibilitychange",this.visibilityHandler))}cleanup(){this.disable(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.activityHandler&&(document.removeEventListener("touchstart",this.activityHandler),document.removeEventListener("click",this.activityHandler),document.removeEventListener("keydown",this.activityHandler),this.activityHandler=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.callbacks.clear(),this.isInitialized=!1}enable(){this.isEnabled||(this.isEnabled=!0,this.lastActivityTimestamp=Date.now(),this.startInactivityMonitor(),A.isCriticalBattery()&&this.enterAmbientMode("battery"))}disable(){this.isEnabled&&(this.isEnabled=!1,this.stopInactivityMonitor(),this.isAmbientActive&&this.exitAmbientMode())}isActive(){return this.isAmbientActive}getState(){return{isActive:this.isAmbientActive,triggeredBy:this.triggeredBy}}subscribe(e){return this.callbacks.add(e),e(this.getState()),()=>{this.callbacks.delete(e)}}exitAmbientMode(){this.isAmbientActive&&(this.isAmbientActive=!1,this.triggeredBy=null,this.lastActivityTimestamp=Date.now(),this.lastExitTimestamp=Date.now(),this.notifySubscribers(),d.debug("[Ambient] Exited ambient mode"))}wasRecentlyExited(){return Date.now()-this.lastExitTimestamp<500}resetInactivityTimer(){this.lastActivityTimestamp=Date.now(),this.isAmbientActive&&this.exitAmbientMode()}enterAmbientMode(e){this.isAmbientActive||!this.isEnabled||(this.isAmbientActive=!0,this.triggeredBy=e,this.notifySubscribers(),d.debug(`[Ambient] Entered ambient mode (trigger: ${e})`))}startInactivityMonitor(){this.inactivityCheckId===null&&(this.inactivityCheckId=setInterval(()=>{if(!this.isEnabled)return;Date.now()-this.lastActivityTimestamp>=this.INACTIVITY_THRESHOLD_MS&&!this.isAmbientActive&&this.enterAmbientMode("inactivity")},5e3))}stopInactivityMonitor(){this.inactivityCheckId!==null&&(clearInterval(this.inactivityCheckId),this.inactivityCheckId=null)}notifySubscribers(){const e=this.getState();for(const t of this.callbacks)try{t(e)}catch(i){d.error("[Ambient] Callback error:",i)}}}const ea=new ln,un=typeof requestIdleCallback=="function"?n=>requestIdleCallback(n):n=>setTimeout(n,50),ot=typeof cancelIdleCallback=="function"?n=>cancelIdleCallback(n):n=>clearTimeout(n);class dn{constructor(){c(this,"cache",new Map);c(this,"pendingWrites",new Map);c(this,"flushId",null)}get(e){if(this.cache.has(e)){const t=this.cache.get(e);try{return JSON.parse(t)}catch{return null}}try{const t=localStorage.getItem(e);return t===null?null:(this.cache.set(e,t),JSON.parse(t))}catch{return null}}set(e,t){const i=JSON.stringify(t);this.cache.set(e,i),this.pendingWrites.set(e,i),this.scheduleFlush()}remove(e){this.cache.delete(e),this.pendingWrites.set(e,null),this.scheduleFlush()}setRaw(e,t){this.cache.set(e,t),this.pendingWrites.set(e,t),this.scheduleFlush()}getRaw(e){if(this.cache.has(e))return this.cache.get(e);try{const t=localStorage.getItem(e);return t!==null&&this.cache.set(e,t),t}catch{return null}}scheduleFlush(){this.flushId===null&&(this.flushId=un(()=>{try{this.flush()}catch(e){d.error("Deferred storage flush failed:",e)}}))}flush(){this.flushId!==null&&(ot(this.flushId),this.flushId=null);const e=new Map(this.pendingWrites);this.pendingWrites.clear();let t=null;for(const[i,s]of e)try{s===null?localStorage.removeItem(i):localStorage.setItem(i,s)}catch(r){d.error(`Storage write failed for key "${i}":`,r),t===null&&(t=r)}if(t!==null)throw t}hasPendingWrites(){return this.pendingWrites.size>0}clearCache(){this.cache.clear(),this.pendingWrites.clear(),this.flushId!==null&&(ot(this.flushId),this.flushId=null)}}const y=new dn,Ce=2;function hn(n){const e=new Uint8Array(Math.ceil(n/2));return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("").slice(0,n)}function ta(n){var i;const e=Date.now(),t=((i=crypto.randomUUID)==null?void 0:i.call(crypto).slice(0,8))??hn(8);return`${n}-${e}-${t}`}const Re=["swift","bold","cool","fast","keen","wild","calm","warm","bright","sharp","quick","brave","fresh","grand","prime","clear","snow","ice","frost","peak","alpine","polar","winter","crisp"],Ae=["fox","bear","wolf","hawk","eagle","tiger","lion","deer","pine","oak","cedar","birch","maple","spruce","aspen","willow","peak","ridge","slope","trail","summit","valley","glacier","cliff"];function ct(n){return n.charAt(0).toUpperCase()+n.slice(1)}function fn(){const n=Re[Math.floor(Math.random()*Re.length)],e=Ae[Math.floor(Math.random()*Ae.length)],t=Math.floor(Math.random()*100);return`dev_${n}-${e}-${t}`}function xe(){const n=Re[Math.floor(Math.random()*Re.length)],e=Ae[Math.floor(Math.random()*Ae.length)],t=Math.floor(Math.random()*100);return`${ct(n)} ${ct(e)} ${t}`}const gn=20;function Bt(n){return n==="indexeddb"}function _t(n){return!!n&&n!=="indexeddb"&&n.length>gn}const lt=5*1024*1024,pn=80;function mn(){let n=0;try{for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);if(t){const i=localStorage.getItem(t);n+=(t.length+((i==null?void 0:i.length)??0))*2}}}catch{}return n}function $t(){const n=mn(),e=Math.round(n/lt*100),t=e>=pn;return{usageBytes:n,estimatedQuota:lt,usagePercent:e,warning:t}}function na(){const{usageBytes:n,usagePercent:e}=$t(),t=(n/1024).toFixed(1);d.debug(`[Storage] localStorage usage: ${t} KB (${e}% of ~5MB)`)}const yn=["S","F"],vn=["ok","dns","dnf","dsq","flt"],xt=["MG","STR","BR"],bn=50,Sn=10;function En(n){return!n||typeof n!="string"||n.length>bn?!1:/^[a-zA-Z0-9_-]+$/.test(n)}function le(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"&&typeof e.id!="number"||typeof e.id=="string"&&e.id.length===0||typeof e.id=="number"&&e.id<=0||e.bib!==void 0&&typeof e.bib!="string"||typeof e.bib=="string"&&e.bib.length>Sn||!yn.includes(e.point)||!e.timestamp||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||e.status!==void 0&&!vn.includes(e.status)||e.deviceId!==void 0&&typeof e.deviceId!="string"||e.deviceName!==void 0&&typeof e.deviceName!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||e.syncedAt<0||!Number.isFinite(e.syncedAt))||e.photo!==void 0&&typeof e.photo!="string"||e.timeSource!==void 0&&e.timeSource!=="gps"&&e.timeSource!=="system"||e.gpsTimestamp!==void 0&&(typeof e.gpsTimestamp!="number"||!Number.isFinite(e.gpsTimestamp)))return!1;if(e.gpsCoords!==void 0){if(typeof e.gpsCoords!="object"||e.gpsCoords===null)return!1;const t=e.gpsCoords;if(typeof t.latitude!="number"||!Number.isFinite(t.latitude)||typeof t.longitude!="number"||!Number.isFinite(t.longitude)||typeof t.accuracy!="number"||!Number.isFinite(t.accuracy)||t.accuracy<0)return!1}return!0}function wn(n){return!n||typeof n!="string"?!1:n.startsWith("dev_")&&n.length>4}function Ot(n){return n===1||n===2}const In=["create","edit","restore"];function Tn(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.version!="number"||!Number.isInteger(e.version)||e.version<1||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||typeof e.editedBy!="string"||e.editedBy.length>100||typeof e.editedByDeviceId!="string"||e.editedByDeviceId.length>100||!In.includes(e.changeType)||!e.data||typeof e.data!="object")return!1;const t=e.data;return!(typeof t.id!="string"||typeof t.bib!="string"||t.bib.length>10||!Ot(t.run)||typeof t.gateNumber!="number"||!Number.isInteger(t.gateNumber)||t.gateNumber<0||!xt.includes(t.faultType)||typeof t.timestamp!="string"||Number.isNaN(Date.parse(t.timestamp))||typeof t.deviceId!="string"||typeof t.deviceName!="string"||t.deviceName.length>100||!Array.isArray(t.gateRange)||t.gateRange.length!==2||typeof t.gateRange[0]!="number"||typeof t.gateRange[1]!="number"||!Number.isInteger(t.gateRange[0])||!Number.isInteger(t.gateRange[1])||e.changeDescription!==void 0&&typeof e.changeDescription!="string"||typeof e.changeDescription=="string"&&e.changeDescription.length>500)}function zt(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"||e.id.length===0||typeof e.bib!="string"||e.bib.length>10||typeof e.deviceId!="string"||typeof e.deviceName!="string"||e.deviceName.length>100||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||!Ot(e.run)||typeof e.gateNumber!="number"||!Number.isInteger(e.gateNumber)||e.gateNumber<0||!xt.includes(e.faultType)||!Array.isArray(e.gateRange)||e.gateRange.length!==2||typeof e.gateRange[0]!="number"||typeof e.gateRange[1]!="number"||!Number.isInteger(e.gateRange[0])||!Number.isInteger(e.gateRange[1])||typeof e.currentVersion!="number"||!Number.isInteger(e.currentVersion)||e.currentVersion<1||!Array.isArray(e.versionHistory))return!1;for(const t of e.versionHistory)if(!Tn(t))return!1;return!(typeof e.markedForDeletion!="boolean"||e.markedForDeletionAt!==void 0&&(typeof e.markedForDeletionAt!="string"||Number.isNaN(Date.parse(e.markedForDeletionAt)))||e.deletionApprovedAt!==void 0&&(typeof e.deletionApprovedAt!="string"||Number.isNaN(Date.parse(e.deletionApprovedAt)))||e.markedForDeletionBy!==void 0&&typeof e.markedForDeletionBy!="string"||e.markedForDeletionByDeviceId!==void 0&&typeof e.markedForDeletionByDeviceId!="string"||e.deletionApprovedBy!==void 0&&typeof e.deletionApprovedBy!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||!Number.isFinite(e.syncedAt)))}function Cn(n){if(!zt(n))return null;const e=n,t=e.versionHistory.map(i=>({...i,editedBy:L(i.editedBy,100),editedByDeviceId:L(i.editedByDeviceId,100),changeDescription:i.changeDescription?L(i.changeDescription,500):void 0,data:{...i.data,bib:L(i.data.bib,10),deviceId:L(i.data.deviceId,100),deviceName:L(i.data.deviceName,100)}}));return{...e,bib:L(e.bib,10),deviceId:L(e.deviceId,100),deviceName:L(e.deviceName,100),markedForDeletionBy:e.markedForDeletionBy?L(e.markedForDeletionBy,100):void 0,markedForDeletionByDeviceId:e.markedForDeletionByDeviceId?L(e.markedForDeletionByDeviceId,100):void 0,deletionApprovedBy:e.deletionApprovedBy?L(e.deletionApprovedBy,100):void 0,versionHistory:t}}function Rn(n){if(!n||typeof n!="object")return!1;const e=n;return!(!le(e.entry)||typeof e.retryCount!="number"||e.retryCount<0||typeof e.lastAttempt!="number"||e.lastAttempt<0)}function L(n,e=100){return!n||typeof n!="string"?"":n.slice(0,e).replace(/[<>&]/g,"").replace(/[\x00-\x1F\x7F]/g,"")}function An(n,e){if(!le(n))return null;const t=n;return{id:(typeof t.id=="number",String(t.id)),bib:L(t.bib,10),point:t.point,run:t.run??1,timestamp:t.timestamp,status:t.status||"ok",deviceId:L(t.deviceId||e,50),deviceName:L(t.deviceName||"Unknown Device",100),syncedAt:t.syncedAt,photo:t.photo,gpsCoords:t.gpsCoords}}function Dn(n,e){const t={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};if(!n||typeof n!="object")return{version:Ce,entries:[],settings:t,deviceId:e,deviceName:xe(),raceId:"",syncQueue:[]};const i=n;let s=[];Array.isArray(i.entries)&&(s=i.entries.map(o=>An(o,e)).filter(o=>o!==null));let r=t;if(i.settings&&typeof i.settings=="object"){const o=i.settings;r={auto:typeof o.auto=="boolean"?o.auto:t.auto,haptic:typeof o.haptic=="boolean"?o.haptic:t.haptic,sound:typeof o.sound=="boolean"?o.sound:t.sound,sync:typeof o.sync=="boolean"?o.sync:t.sync,syncPhotos:typeof o.syncPhotos=="boolean"?o.syncPhotos:t.syncPhotos,gps:typeof o.gps=="boolean"?o.gps:t.gps,simple:typeof o.simple=="boolean"?o.simple:t.simple,photoCapture:typeof o.photoCapture=="boolean"?o.photoCapture:t.photoCapture,motionEffects:typeof o.motionEffects=="boolean"?o.motionEffects:t.motionEffects,glassEffects:typeof o.glassEffects=="boolean"?o.glassEffects:t.glassEffects,outdoorMode:typeof o.outdoorMode=="boolean"?o.outdoorMode:t.outdoorMode,ambientMode:typeof o.ambientMode=="boolean"?o.ambientMode:t.ambientMode}}let a=[];return Array.isArray(i.syncQueue)&&(a=i.syncQueue.filter(Rn)),{version:Ce,entries:s,settings:r,deviceId:wn(i.deviceId)?i.deviceId:e,deviceName:L(i.deviceName,100)||xe(),raceId:En(i.raceId)?i.raceId:"",syncQueue:a,lastExport:typeof i.lastExport=="number"?i.lastExport:void 0}}function ia(n,e){n.addEventListener("input",()=>{n.value=n.value.replace(/[^0-9]/g,""),e!==void 0&&(n.value=n.value.slice(0,e))})}const Pn=50;function kn(n,e,t){const i=[...n,e],s=ge(t,{type:"ADD_ENTRY",data:e,timestamp:Date.now()});return{entries:i,undoStack:s,redoStack:[]}}function Ln(n,e,t){const i=n.find(r=>r.id===e);if(!i)return null;const s=ge(t,{type:"DELETE_ENTRY",data:i,timestamp:Date.now()});return{entries:n.filter(r=>r.id!==e),undoStack:s,redoStack:[]}}function Fn(n,e,t){const i=n.filter(r=>e.includes(r.id));if(i.length===0)return null;const s=ge(t,{type:"DELETE_MULTIPLE",data:i,timestamp:Date.now()});return{entries:n.filter(r=>!e.includes(r.id)),undoStack:s,redoStack:[]}}function Nn(n,e){if(n.length===0)return null;const t=ge(e,{type:"CLEAR_ALL",data:[...n],timestamp:Date.now()});return{entries:[],undoStack:t,redoStack:[]}}function Mn(n,e,t,i){const s=n.findIndex(h=>h.id===e);if(s===-1)return null;const r=n[s],a={...r,...t},o=ge(i,{type:"UPDATE_ENTRY",data:r,newData:a,timestamp:Date.now()}),u=[...n];return u[s]=a,{entries:u,undoStack:o,redoStack:[]}}function ge(n,e){const t=[...n,e];return t.length>Pn&&t.shift(),t}function Bn(n,e,t){if(e.length===0)return{entries:n,undoStack:e,redoStack:t,result:null};const i=[...e],s=i.pop(),r=[...t,s];let a=[...n],o=null;switch(s.type){case"ADD_ENTRY":{const u=s.data;a=a.filter(h=>h.id!==u.id),o=u;break}case"DELETE_ENTRY":{const u=s.data;a.push(u),a.sort((h,g)=>new Date(h.timestamp).getTime()-new Date(g.timestamp).getTime()),o=u;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const u=s.data;a=[...a,...u],a.sort((h,g)=>new Date(h.timestamp).getTime()-new Date(g.timestamp).getTime()),o=u;break}case"UPDATE_ENTRY":{const u=s.data,h=a.findIndex(g=>g.id===u.id);h!==-1&&(a[h]=u,o=u);break}}return{entries:a,undoStack:i,redoStack:r,result:o?{type:s.type,data:o}:null}}function _n(n,e,t){if(t.length===0)return{entries:n,undoStack:e,redoStack:t,result:null};const i=[...t],s=i.pop(),r=[...e,s];let a=[...n],o=null;switch(s.type){case"ADD_ENTRY":{const u=s.data;a.push(u),a.sort((h,g)=>new Date(h.timestamp).getTime()-new Date(g.timestamp).getTime()),o=u;break}case"DELETE_ENTRY":{const u=s.data;a=a.filter(h=>h.id!==u.id),o=u;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const u=s.data,h=new Set(u.map(g=>g.id));a=a.filter(g=>!h.has(g.id)),o=u;break}case"UPDATE_ENTRY":{const u=s.data,h=s.newData,g=a.findIndex(f=>f.id===u.id);g!==-1&&h&&(a[g]=h),o=h||u;break}}return{entries:a,undoStack:r,redoStack:i,result:o}}function $n(n,e){const t={entry:e,retryCount:0,lastAttempt:0};return[...n,t]}function xn(n,e){return n.filter(t=>t.entry.id!==e)}function On(n,e,t){return n.map(i=>i.entry.id===e?{...i,...t}:i)}function zn(n,e,t,i){let s=0;const r=new Set(n.map(u=>`${u.id}:${u.deviceId}`)),a=new Set(t),o=[];for(const u of e){if(!le(u)||u.deviceId===i)continue;const h=`${u.id}:${u.deviceId}`;if(a.has(h)||a.has(u.id))continue;const g=`${u.id}:${u.deviceId}`;r.has(g)||(o.push({...u,run:u.run??1}),r.add(g),s++)}if(o.length>0){const u=[...n,...o];return u.sort((h,g)=>new Date(h.timestamp).getTime()-new Date(g.timestamp).getTime()),{entries:u,addedCount:s}}return{entries:n,addedCount:s}}function Hn(n,e){const t=new Set(e);let i=0;return{entries:n.filter(r=>{const a=`${r.id}:${r.deviceId}`;return t.has(a)||t.has(r.id)?(i++,!1):!0}),removedCount:i}}const ut=50;function We(n){return{id:n.id,bib:n.bib,run:n.run,gateNumber:n.gateNumber,faultType:n.faultType,timestamp:n.timestamp,deviceId:n.deviceId,deviceName:n.deviceName,gateRange:n.gateRange,syncedAt:n.syncedAt,notes:n.notes,notesSource:n.notesSource,notesTimestamp:n.notesTimestamp}}function Pe(n,e,t,i,s,r){return{version:n,timestamp:new Date().toISOString(),editedBy:i,editedByDeviceId:s,changeType:e,data:t,changeDescription:r}}function Ye(n,e){const t=[...n||[],e];return t.length>ut?t.slice(-ut):t}function Vn(n,e){const t=Pe(1,"create",We(e),e.deviceName,e.deviceId),i={...e,currentVersion:1,versionHistory:[t],markedForDeletion:!1};return[...n,i]}function Gn(n,e){return n.filter(t=>t.id!==e)}function Un(n,e,t){const i=n.findIndex(r=>r.id===e);if(i===-1)return null;const s=[...n];return s[i]={...s[i],...t},s}function Jn(n,e,t,i,s,r){const a=n.findIndex(m=>m.id===e);if(a===-1)return null;const o=n[a];if(o.markedForDeletion)return null;const u=o.currentVersion+1,h={...o,...t},g=Pe(u,"edit",We(h),i,s,r),f=[...n];return f[a]={...h,currentVersion:u,versionHistory:Ye(o.versionHistory,g)},f}function jn(n,e,t,i,s){var f;const r=n.findIndex(m=>m.id===e);if(r===-1)return null;const a=n[r];if(a.markedForDeletion)return null;const o=(f=a.versionHistory)==null?void 0:f.find(m=>m.version===t);if(!o)return null;const u=a.currentVersion+1,h=Pe(u,"restore",{...o.data},i,s,`Restored to version ${t}`),g=[...n];return g[r]={...a,bib:o.data.bib,run:o.data.run,gateNumber:o.data.gateNumber,faultType:o.data.faultType,notes:o.data.notes,notesSource:o.data.notesSource,notesTimestamp:o.data.notesTimestamp,currentVersion:u,versionHistory:Ye(a.versionHistory,h)},g}function qn(n,e,t,i){const s=n.findIndex(a=>a.id===e);if(s===-1)return null;const r=[...n];return r[s]={...r[s],markedForDeletion:!0,markedForDeletionAt:new Date().toISOString(),markedForDeletionBy:t,markedForDeletionByDeviceId:i},r}function Qn(n,e,t){const i=n.find(r=>r.id===e);if(!i||!i.markedForDeletion)return{faultEntries:n,approvedFault:null};const s={...i,deletionApprovedAt:new Date().toISOString(),deletionApprovedBy:t};return{faultEntries:n.filter(r=>r.id!==e),approvedFault:s}}function Wn(n,e,t,i){const s=n.findIndex(h=>h.id===e);if(s===-1)return null;const r=n[s],a=r.currentVersion+1,o=Pe(a,"edit",We(r),t,i,"Deletion rejected by Chief Judge"),u=[...n];return u[s]={...u[s],markedForDeletion:!1,markedForDeletionAt:void 0,markedForDeletionBy:void 0,markedForDeletionByDeviceId:void 0,currentVersion:a,versionHistory:Ye(r.versionHistory,o)},u}function Yn(n){return n.filter(e=>e.markedForDeletion)}function Kn(n,e,t){return n.filter(i=>i.bib===e&&i.run===t)}function Zn(n,e){const t=n.findIndex(s=>s.id===e);if(t===-1)return n;const i=[...n];return i[t]={...i[t],syncedAt:Date.now()},i}function Xn(n,e,t,i){let s=0,r=0;const a=new Map(n.map(g=>[`${g.id}-${g.deviceId}`,g])),o=new Set(t),u=[],h=[];for(const g of e){const f=Cn(g);if(!f){d.warn("Skipping invalid fault from cloud:",g);continue}if(f.deviceId===i)continue;const m=`${f.id}:${f.deviceId}`;if(o.has(m)||o.has(f.id))continue;const T=`${f.id}-${f.deviceId}`,v=a.get(T);if(v){const C=f.currentVersion||1,F=v.currentVersion||1;(C>F||f.markedForDeletion!==v.markedForDeletion)&&(h.push(f),r++)}else u.push(f),s++}if(u.length>0||h.length>0){let g=[...n];for(const f of h){const m=`${f.id}-${f.deviceId}`,T=g.findIndex(v=>`${v.id}-${v.deviceId}`===m);T!==-1&&(g[T]=f)}return g=[...g,...u],g.sort((f,m)=>new Date(f.timestamp).getTime()-new Date(m.timestamp).getTime()),{faultEntries:g,addedCount:s+r}}return{faultEntries:n,addedCount:0}}function ei(n,e){const t=new Set(e);let i=0;return{faultEntries:n.filter(r=>{const a=`${r.id}:${r.deviceId}`;return t.has(a)||t.has(r.id)?(i++,!1):!0}),removedCount:i}}function ti(n){return{deviceRole:n}}function ni(n){return{gateAssignment:n}}function ii(n){return{firstGateColor:n}}function si(n,e,t){if(!e)return t;const[i]=e;return(n-i)%2===0?t:t==="red"?"blue":"red"}function ri(n){return{selectedFaultBib:n}}function ai(n){return{isJudgeReady:n}}function oi(n){return{isJudgeReady:!n}}function ci(n){return{isChiefJudgeView:n}}function li(n){return{isChiefJudgeView:!n}}function ui(n,e,t){const i=`${n}-${e}`,s=new Set(t);return s.add(i),{finalizedRacers:s}}function di(n,e,t){const i=`${n}-${e}`,s=new Set(t);return s.delete(i),{finalizedRacers:s}}function hi(n,e,t){const i=`${n}-${e}`;return t.has(i)}function fi(){return{finalizedRacers:new Set}}function gi(n){return{penaltySeconds:Math.max(0,Math.min(60,n))}}function pi(n){return{usePenaltyMode:n}}function mi(n,e){const t=n.filter(a=>a.point==="S"&&a.run===e),i=n.filter(a=>a.point==="F"&&a.run===e),s=new Set(i.map(a=>a.bib)),r=new Set(t.filter(a=>!s.has(a.bib)).map(a=>a.bib));return Array.from(r).sort((a,o)=>parseInt(a,10)-parseInt(o,10))}const dt={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};function yi(n,e){return{...n,...e}}function vi(n,e){return{...n,[e]:!n[e]}}function bi(n){return{syncStatus:n}}function Si(n,e){return{raceId:n,clearUndoRedo:n!==e}}function Ei(n){return{lastSyncedRaceId:n}}function wi(n){return{deviceName:n}}const Ii=12e4;function Ti(n,e){const t=Date.now(),i=new Map;for(const[s,r]of e)t-r.lastSeen<Ii&&i.set(s,r);return i.set(n.id,n),{connectedDevices:i}}function Ci(n,e){const t=new Map(e);return t.delete(n),{connectedDevices:t}}function Ri(n){return{cloudDeviceCount:n}}function Ai(n){return{cloudHighestBib:n}}function Di(n){return{raceExistsInCloud:n}}function Pi(n){return{currentView:n}}function ki(n){return{currentLang:n}}function Li(n){return{bibInput:n.replace(/\D/g,"").slice(0,3)}}function Fi(n){return{selectedPoint:n}}function Ni(n){return{selectedRun:n}}function Mi(n,e){return{selectMode:n,selectedEntries:n?e:new Set}}function Bi(n,e){const t=new Set(e);return t.has(n)?t.delete(n):t.add(n),{selectedEntries:t,selectMode:t.size>0}}function _i(n){return{selectedEntries:new Set(n),selectMode:!0}}function $i(){return{selectedEntries:new Set,selectMode:!1}}function xi(n){return{isRecording:n}}const S={ENTRIES:"skiTimerEntries",SETTINGS:"skiTimerSettings",LANG:"skiTimerLang",DEVICE_ID:"skiTimerDeviceId",DEVICE_NAME:"skiTimerDeviceName",RACE_ID:"skiTimerRaceId",LAST_SYNCED_RACE_ID:"skiTimerLastSyncedRaceId",SYNC_QUEUE:"skiTimerSyncQueue",SCHEMA_VERSION:"skiTimerSchemaVersion",DEVICE_ROLE:"skiTimerDeviceRole",GATE_ASSIGNMENT:"skiTimerGateAssignment",FIRST_GATE_COLOR:"skiTimerFirstGateColor",FAULT_ENTRIES:"skiTimerFaultEntries",PENALTY_SECONDS:"skiTimerPenaltySeconds",USE_PENALTY_MODE:"skiTimerUsePenaltyMode",FINALIZED_RACERS:"skiTimerFinalizedRacers"},Oi=["entries","settings","currentLang","deviceName","raceId","lastSyncedRaceId","syncQueue","deviceRole","gateAssignment","firstGateColor","faultEntries","penaltySeconds","usePenaltyMode","finalizedRacers"];function te(n,e,t){try{const i=y.getRaw(n);if(!i)return e;const s=JSON.parse(i);return t?t(s):s}catch(i){return d.error(`Failed to parse ${n}:`,i),e}}const de=class de{constructor(){c(this,"state");c(this,"$state");c(this,"saveTimeout",null);c(this,"dirtySlices",new Set);c(this,"saveRetryCount",0);this.state=this.loadInitialState(),this.$state=sn(this.state)}loadInitialState(){let e=y.getRaw(S.DEVICE_ID);e||(e=fn(),y.setRaw(S.DEVICE_ID,e),y.flush());const t=te(S.ENTRIES,[],I=>Array.isArray(I)?I.filter(D=>le(D)).map(D=>({...D,run:D.run??1})):[]),i=te(S.SETTINGS,dt,I=>({...dt,...I})),s=te(S.SYNC_QUEUE,[],I=>Array.isArray(I)?I:[]),r=y.getRaw(S.LANG)||"de";let a=y.getRaw(S.DEVICE_NAME);a||(a=xe(),y.setRaw(S.DEVICE_NAME,a),y.flush());const o=y.getRaw(S.RACE_ID)||"",u=y.getRaw(S.LAST_SYNCED_RACE_ID)||"",h=y.getRaw(S.DEVICE_ROLE)||"timer",g=te(S.GATE_ASSIGNMENT,null,I=>Array.isArray(I)&&I.length===2?I:null),f=y.getRaw(S.FIRST_GATE_COLOR),m=f==="red"||f==="blue"?f:"red",T=te(S.FAULT_ENTRIES,[],I=>Array.isArray(I)?I:[]),v=y.getRaw(S.PENALTY_SECONDS),C=v?Math.max(0,Math.min(60,Number(v)||5)):5,F=y.getRaw(S.USE_PENALTY_MODE),k=F!==null?F!=="false":!0,_=te(S.FINALIZED_RACERS,[],I=>Array.isArray(I)?I.filter(D=>typeof D=="string"):[]);return{currentView:h==="gateJudge"?"gateJudge":"timer",currentLang:r,bibInput:"",selectedPoint:"F",selectedRun:1,selectMode:!1,selectedEntries:new Set,isRecording:!1,lastRecordedEntry:null,entries:t,deviceRole:h,gateAssignment:g,firstGateColor:m,faultEntries:T,selectedFaultBib:"",isJudgeReady:!1,isChiefJudgeView:!1,finalizedRacers:new Set(_),penaltySeconds:C,usePenaltyMode:k,undoStack:[],redoStack:[],settings:i,deviceId:e,deviceName:a,raceId:o,lastSyncedRaceId:u,syncStatus:"disconnected",syncQueue:s,connectedDevices:new Map,cloudDeviceCount:0,cloudHighestBib:0,raceExistsInCloud:null,gpsAccuracy:null,gpsStatus:"inactive",cameraReady:!1,cameraError:null}}getState(){return this.$state.value}setState(e,t=!0){if(this.state={...this.state,...e},this.$state.value=this.state,t){for(const i of Object.keys(e))this.dirtySlices.add(i);this.scheduleSave()}}scheduleSave(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveToStorage(),100)}forceSave(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null);for(const e of Oi)this.dirtySlices.add(e);this.saveToStorage()}saveToStorage(){const e=new Set(this.dirtySlices);if(this.dirtySlices.clear(),e.size!==0)try{if(e.has("entries")){const i=this.state.entries.map(s=>_t(s.photo)?{...s,photo:"indexeddb"}:s);y.setRaw(S.ENTRIES,JSON.stringify(i))}e.has("settings")&&y.setRaw(S.SETTINGS,JSON.stringify(this.state.settings)),e.has("currentLang")&&y.setRaw(S.LANG,this.state.currentLang),e.has("deviceName")&&y.setRaw(S.DEVICE_NAME,this.state.deviceName),e.has("raceId")&&y.setRaw(S.RACE_ID,this.state.raceId),e.has("lastSyncedRaceId")&&y.setRaw(S.LAST_SYNCED_RACE_ID,this.state.lastSyncedRaceId),e.has("syncQueue")&&y.setRaw(S.SYNC_QUEUE,JSON.stringify(this.state.syncQueue)),e.has("deviceRole")&&y.setRaw(S.DEVICE_ROLE,this.state.deviceRole),e.has("gateAssignment")&&(this.state.gateAssignment?y.setRaw(S.GATE_ASSIGNMENT,JSON.stringify(this.state.gateAssignment)):y.remove(S.GATE_ASSIGNMENT)),e.has("firstGateColor")&&y.setRaw(S.FIRST_GATE_COLOR,this.state.firstGateColor),e.has("faultEntries")&&y.setRaw(S.FAULT_ENTRIES,JSON.stringify(this.state.faultEntries)),e.has("penaltySeconds")&&y.setRaw(S.PENALTY_SECONDS,String(this.state.penaltySeconds)),e.has("usePenaltyMode")&&y.setRaw(S.USE_PENALTY_MODE,String(this.state.usePenaltyMode)),e.has("finalizedRacers")&&y.setRaw(S.FINALIZED_RACERS,JSON.stringify(Array.from(this.state.finalizedRacers))),(e.has("entries")||e.has("settings"))&&y.setRaw(S.SCHEMA_VERSION,String(Ce)),y.flush(),this.saveRetryCount=0;const t=$t();t.warning&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t.usageBytes,quota:t.estimatedQuota,percent:t.usagePercent,critical:t.usagePercent>90}}))}catch(t){for(const i of e)this.dirtySlices.add(i);d.error("Failed to save to storage:",t),this.dispatchStorageError(t),this.saveRetryCount++,this.saveRetryCount<=de.MAX_SAVE_RETRIES?this.scheduleSave():(d.error(`Storage save failed after ${de.MAX_SAVE_RETRIES} retries, giving up until next state change`),this.dispatchStorageError(t,!0),this.saveRetryCount=0)}}dispatchStorageError(e,t=!1){window.dispatchEvent(new CustomEvent("storage-error",{detail:{message:e.message,isQuotaError:e.name==="QuotaExceededError"||e.message.includes("quota")||e.message.includes("storage"),entryCount:this.state.entries.length,retriesExhausted:t}}))}addEntry(e){const t=kn(this.state.entries,e,this.state.undoStack);this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack,lastRecordedEntry:e,isRecording:!1}),this.state.settings.sync&&this.state.raceId&&this.addToSyncQueue(e)}deleteEntry(e){const t=Ln(this.state.entries,e,this.state.undoStack);t&&this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack})}deleteMultiple(e){const t=Fn(this.state.entries,e,this.state.undoStack);t&&this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack,selectMode:!1,selectedEntries:new Set})}clearAll(){const e=Nn(this.state.entries,this.state.undoStack);e&&this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack,selectMode:!1,selectedEntries:new Set})}updateEntry(e,t){const i=Mn(this.state.entries,e,t,this.state.undoStack);return i?(this.setState({entries:i.entries,undoStack:i.undoStack,redoStack:i.redoStack}),!0):!1}canUndo(){return this.state.undoStack.length>0}canRedo(){return this.state.redoStack.length>0}peekUndo(){return this.canUndo()?this.state.undoStack[this.state.undoStack.length-1]??null:null}undo(){const e=Bn(this.state.entries,this.state.undoStack,this.state.redoStack);return this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack}),e.result}redo(){const e=_n(this.state.entries,this.state.undoStack,this.state.redoStack);return this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack}),e.result}addToSyncQueue(e){const t=$n(this.state.syncQueue,e);this.setState({syncQueue:t})}removeFromSyncQueue(e){const t=xn(this.state.syncQueue,e);this.setState({syncQueue:t})}updateSyncQueueItem(e,t){const i=On(this.state.syncQueue,e,t);this.setState({syncQueue:i})}clearSyncQueue(){this.setState({syncQueue:[]})}setView(e){this.setState(Pi(e),!1)}setLanguage(e){this.setState(ki(e))}setBibInput(e){this.setState(Li(e),!1)}setSelectedPoint(e){this.setState(Fi(e),!1)}setSelectedRun(e){this.setState(Ni(e),!1)}setSelectMode(e){this.setState(Mi(e,this.state.selectedEntries),!1)}toggleEntrySelection(e){this.setState(Bi(e,this.state.selectedEntries),!1)}selectAllEntries(){this.setState(_i(this.state.entries.map(e=>e.id)),!1)}clearSelection(){this.setState($i(),!1)}setRecording(e){this.setState(xi(e),!1)}setDeviceRole(e){this.setState(ti(e))}setGateAssignment(e){this.setState(ni(e))}setFirstGateColor(e){this.setState(ii(e))}getGateColor(e){return si(e,this.state.gateAssignment,this.state.firstGateColor)}setSelectedFaultBib(e){this.setState(ri(e),!1)}setJudgeReady(e){this.setState(ai(e))}toggleJudgeReady(){this.setState(oi(this.state.isJudgeReady))}setChiefJudgeView(e){this.setState(ci(e),!1)}toggleChiefJudgeView(){this.setState(li(this.state.isChiefJudgeView),!1)}finalizeRacer(e,t){this.setState(ui(e,t,this.state.finalizedRacers))}unfinalizeRacer(e,t){this.setState(di(e,t,this.state.finalizedRacers))}isRacerFinalized(e,t){return hi(e,t,this.state.finalizedRacers)}clearFinalizedRacers(){this.setState(fi())}setPenaltySeconds(e){this.setState(gi(e))}setUsePenaltyMode(e){this.setState(pi(e))}getActiveBibs(e){return mi(this.state.entries,e)}addFaultEntry(e){const t=Vn(this.state.faultEntries,e);this.setState({faultEntries:t})}deleteFaultEntry(e){const t=Gn(this.state.faultEntries,e);this.setState({faultEntries:t})}updateFaultEntry(e,t){const i=Un(this.state.faultEntries,e,t);return i?(this.setState({faultEntries:i}),!0):!1}updateFaultEntryWithHistory(e,t,i){const s=Jn(this.state.faultEntries,e,t,this.state.deviceName,this.state.deviceId,i);return s?(this.setState({faultEntries:s}),!0):!1}restoreFaultVersion(e,t){const i=jn(this.state.faultEntries,e,t,this.state.deviceName,this.state.deviceId);return i?(this.setState({faultEntries:i}),!0):!1}markFaultForDeletion(e){const t=qn(this.state.faultEntries,e,this.state.deviceName,this.state.deviceId);return t?(this.setState({faultEntries:t}),!0):!1}approveFaultDeletion(e){const t=Qn(this.state.faultEntries,e,this.state.deviceName);return t.approvedFault&&this.setState({faultEntries:t.faultEntries}),t.approvedFault}rejectFaultDeletion(e){const t=Wn(this.state.faultEntries,e,this.state.deviceName,this.state.deviceId);return t?(this.setState({faultEntries:t}),!0):!1}getPendingDeletions(){return Yn(this.state.faultEntries)}clearFaultEntries(){this.setState({faultEntries:[]})}getFaultsForBib(e,t){return Kn(this.state.faultEntries,e,t)}mergeFaultsFromCloud(e,t=[]){const i=Xn(this.state.faultEntries,e,t,this.state.deviceId);return i.addedCount>0&&this.setState({faultEntries:i.faultEntries}),i.addedCount}removeDeletedCloudFaults(e){const t=ei(this.state.faultEntries,e);return t.removedCount>0&&this.setState({faultEntries:t.faultEntries}),t.removedCount}markFaultSynced(e){const t=Zn(this.state.faultEntries,e);this.setState({faultEntries:t})}updateSettings(e){const t=yi(this.state.settings,e);this.setState({settings:t})}toggleSetting(e){const t=vi(this.state.settings,e);this.setState({settings:t})}setSyncStatus(e){this.setState(bi(e),!1)}setRaceId(e){const t=Si(e,this.state.raceId);t.clearUndoRedo?this.setState({raceId:t.raceId,undoStack:[],redoStack:[]}):this.setState({raceId:t.raceId})}setLastSyncedRaceId(e){this.setState(Ei(e))}markCurrentRaceAsSynced(){this.setState({lastSyncedRaceId:this.state.raceId})}setDeviceName(e){this.setState(wi(e))}addConnectedDevice(e){this.setState(Ti(e,this.state.connectedDevices),!1)}removeConnectedDevice(e){this.setState(Ci(e,this.state.connectedDevices),!1)}setCloudDeviceCount(e){this.setState(Ri(e),!1)}setCloudHighestBib(e){this.setState(Ai(e),!1)}setRaceExistsInCloud(e){this.setState(Di(e),!1)}setGpsStatus(e,t){this.setState({gpsStatus:e,gpsAccuracy:t??null},!1)}setCameraReady(e,t){this.setState({cameraReady:e,cameraError:t??null},!1)}mergeCloudEntries(e,t=[]){const i=zn(this.state.entries,e,t,this.state.deviceId);return i.addedCount>0&&this.setState({entries:i.entries}),i.addedCount}removeDeletedCloudEntries(e){const t=Hn(this.state.entries,e);return t.removedCount>0&&this.setState({entries:t.entries}),t.removedCount}exportData(){return JSON.stringify({version:Ce,entries:this.state.entries,settings:this.state.settings,deviceId:this.state.deviceId,deviceName:this.state.deviceName,raceId:this.state.raceId,exportedAt:new Date().toISOString()},null,2)}importData(e){try{const t=JSON.parse(e),i=Dn(t,this.state.deviceId),s=new Set(this.state.entries.map(a=>a.id)),r=i.entries.filter(a=>!s.has(a.id));if(r.length>0){const a=[...this.state.entries,...r];a.sort((o,u)=>new Date(o.timestamp).getTime()-new Date(u.timestamp).getTime()),this.setState({entries:a})}return{success:!0,entriesImported:r.length}}catch(t){return{success:!1,entriesImported:0,error:String(t)}}}};c(de,"MAX_SAVE_RETRIES",3);let Oe=de;const l=new Oe,ht=E(()=>l.$state.value.entries),zi=E(()=>l.$state.value.settings),sa=E(()=>l.$state.value.syncStatus);E(()=>l.$state.value.currentLang);const ra=E(()=>l.$state.value.gpsStatus),Fe=E(()=>l.$state.value.deviceRole),be=E(()=>l.$state.value.faultEntries);E(()=>l.$state.value.entries.length);const aa=E(()=>l.$state.value.cloudDeviceCount),oa=E(()=>l.$state.value.currentView),ca=E(()=>l.$state.value.bibInput),la=E(()=>l.$state.value.selectedPoint),ua=E(()=>l.$state.value.selectedRun),da=E(()=>l.$state.value.undoStack),Hi=E(()=>l.$state.value.isJudgeReady),Vi=E(()=>l.$state.value.gateAssignment),ft=E(()=>l.$state.value.isChiefJudgeView),gt=E(()=>l.$state.value.penaltySeconds),pt=E(()=>l.$state.value.usePenaltyMode),ha=E(()=>l.$state.value.selectedEntries);E(()=>l.$state.value.syncStatus==="syncing");const fa=E(()=>l.$state.value.settings.sync),ga=E(()=>l.$state.value.settings.syncPhotos),pa=E(()=>l.$state.value.settings.gps),ma=E(()=>l.$state.value.settings.photoCapture),ya=E(()=>l.$state.value.settings.glassEffects),va=E(()=>l.$state.value.settings.outdoorMode),ba=E(()=>l.$state.value.settings.ambientMode);E(()=>{const n=l.$state.value;return n.entries.some(e=>!e.syncedAt)||n.syncQueue.length>0});E(()=>{const n=l.$state.value.entries;return{run1:n.filter(e=>e.run===1),run2:n.filter(e=>e.run===2)}});const mt={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},yt={video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}},audio:!1},Gi=.8,Se=1280,Ee=720,vt=200,Ui=5e3,Ne=3,Ji=12e4;class ji{constructor(){c(this,"stream",null);c(this,"videoElement",null);c(this,"canvasElement",null);c(this,"cameraState","stopped");c(this,"visibilityHandler",null);c(this,"pendingVisibilityChange",null);c(this,"previewElement",null);c(this,"ownsVideoElement",!1);c(this,"resumingStartedAt",null);c(this,"reinitRetryCount",0);c(this,"idleTimeoutId",null)}createVideoElement(){if(this.previewElement)return this.ownsVideoElement=!1,this.previewElement;const e=document.createElement("video");return e.setAttribute("autoplay",""),e.setAttribute("playsinline",""),e.style.position="absolute",e.style.left="-9999px",e.style.top="-9999px",document.body.appendChild(e),this.ownsVideoElement=!0,e}waitForVideoReady(){return new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}if(this.videoElement.readyState>=1){this.videoElement.play().then(()=>e()).catch(t);return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))})}async initialize(){if(this.cameraState==="ready")return!0;if(this.cameraState==="initializing")return!1;this.cameraState="initializing",this.reinitRetryCount=0;try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not available");if(A.isCriticalBattery())return d.debug("[Camera] Critical battery, skipping initialization"),this.cameraState="stopped",l.setCameraReady(!1,"Camera disabled on critical battery"),!1;this.videoElement=this.createVideoElement(),this.canvasElement=document.createElement("canvas"),this.canvasElement.width=Se,this.canvasElement.height=Ee;const e=A.isLowBattery()?yt:mt;return this.stream=await navigator.mediaDevices.getUserMedia(e),this.videoElement.srcObject=this.stream,await this.waitForVideoReady(),this.pendingVisibilityChange==="hidden"?(this.pendingVisibilityChange=null,this.canvasElement=null,this.pauseCamera(),!1):(this.cameraState="ready",l.setCameraReady(!0),this.resetIdleTimeout(),this.visibilityHandler||(this.visibilityHandler=()=>this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.visibilityHandler)),!0)}catch(e){const t=e instanceof Error?e.message:"Camera initialization failed";return d.error("Camera initialization error:",t),this.stream&&(this.stream.getTracks().forEach(i=>i.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null),this.cameraState="stopped",l.setCameraReady(!1,t),!1}}handleVisibilityChange(){document.hidden?this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange="hidden":this.cameraState==="ready"&&this.pauseCamera():this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange=null:this.cameraState==="paused"&&this.reinitializeCamera()}pauseCamera(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.videoElement&&(this.videoElement.srcObject=null)),this.cameraState="paused",l.setCameraReady(!1)}async reinitializeCamera(){if(this.cameraState==="resuming")if(this.resumingStartedAt&&Date.now()-this.resumingStartedAt>Ui)d.warn("Camera stuck in resuming state, resetting for retry"),this.cameraState="paused",this.resumingStartedAt=null;else return;if(this.reinitRetryCount>=Ne){d.warn(`Camera reinit failed after ${Ne} attempts, giving up`),this.cameraState="stopped",this.resumingStartedAt=null,l.setCameraReady(!1,"Camera reinitialization failed");return}this.cameraState="resuming",this.resumingStartedAt=Date.now(),this.reinitRetryCount++;try{this.videoElement||(this.videoElement=this.createVideoElement());const e=A.isLowBattery()?yt:mt;if(this.stream=await navigator.mediaDevices.getUserMedia(e),this.videoElement.srcObject=this.stream,await this.waitForVideoReady(),this.pendingVisibilityChange==="hidden"){this.pendingVisibilityChange=null,this.resumingStartedAt=null,this.pauseCamera();return}this.cameraState="ready",this.resumingStartedAt=null,this.reinitRetryCount=0,l.setCameraReady(!0),this.resetIdleTimeout()}catch(e){const t=e instanceof Error?e.message:"Reinitialize failed";d.error("Failed to reinitialize camera:",e),this.stream&&(this.stream.getTracks().forEach(i=>i.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null),this.resumingStartedAt=null,this.reinitRetryCount>=Ne?(this.cameraState="stopped",this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null)):this.cameraState="paused",l.setCameraReady(!1,t)}}async capturePhoto(){if(this.cameraState!=="ready"||!this.videoElement||!this.canvasElement)return d.warn("Camera not ready for capture"),null;this.resetIdleTimeout();try{const e=this.canvasElement.getContext("2d");if(!e)throw new Error("Could not get canvas context");const t=this.videoElement.videoWidth,i=this.videoElement.videoHeight;let s=t,r=i;if(s>Se){const g=Se/s;s=Se,r=Math.round(r*g)}if(r>Ee){const g=Ee/r;r=Ee,s=Math.round(s*g)}this.canvasElement.width=s,this.canvasElement.height=r,e.drawImage(this.videoElement,0,0,s,r);const a=new Date().toISOString();e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,r-30,s,30),e.fillStyle="#ffffff",e.font="14px monospace",e.fillText(a,10,r-10);const u=this.canvasElement.toDataURL("image/jpeg",Gi).split(",")[1]??null;if(!u)return null;const h=Math.round(u.length/1024);if(h>vt){const g=new Error(`Photo too large (${h}KB > ${vt}KB limit)`);throw g.name="PhotoTooLargeError",g}return u}catch(e){if(e instanceof Error&&e.name==="PhotoTooLargeError")throw e;return d.error("Photo capture error:",e),null}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null,this.ownsVideoElement&&this.videoElement.remove(),this.videoElement=null),this.canvasElement=null,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.pendingVisibilityChange=null,this.resumingStartedAt=null,this.clearIdleTimeout(),this.cameraState="stopped",l.setCameraReady(!1)}isReady(){return this.cameraState==="ready"}setPreviewElement(e){if(this.previewElement=e,!e){this.videoElement&&!this.ownsVideoElement&&(this.videoElement.srcObject=null,this.videoElement=null);return}this.videoElement!==e&&(this.videoElement&&this.ownsVideoElement&&this.videoElement.remove(),this.videoElement=e,this.ownsVideoElement=!1),this.stream&&(this.videoElement.srcObject=this.stream,this.videoElement.play().catch(()=>null))}getVideoElement(){return this.videoElement}getError(){return l.getState().cameraError}resetIdleTimeout(){this.clearIdleTimeout(),this.idleTimeoutId=setTimeout(()=>{this.cameraState==="ready"&&(d.debug("[Camera] Idle timeout, pausing stream to save battery"),this.pauseCamera())},Ji)}clearIdleTimeout(){this.idleTimeoutId!==null&&(clearTimeout(this.idleTimeoutId),this.idleTimeoutId=null)}async toggle(e){return e?this.initialize():(this.stop(),!0)}}const Me=new ji;async function Sa(){return!l.getState().settings.photoCapture||!Me.isReady()&&!await Me.initialize()?null:Me.capturePhoto()}let H=null,Y=null;const qi=5e3;function Ht(){if(!H)try{H=new(window.AudioContext||window.webkitAudioContext)}catch(n){return d.warn("AudioContext not available:",n),null}return H}function bt(){Y!==null&&clearTimeout(Y),Y=window.setTimeout(()=>{H&&H.state==="running"&&H.suspend().catch(()=>{}),Y=null},qi)}function Qi(n){const{batteryLevel:e}=A.getStatus();if(e==="critical")return null;const t=e==="low"?.5:e==="medium"?.75:1;return t===1?n:typeof n=="number"?Math.round(n*t):n.map(i=>Math.round(i*t))}function Z(n){if(!l.getState().settings.haptic)return;const t=Qi(n);if(t!==null&&navigator.vibrate)try{navigator.vibrate(t)}catch(i){d.warn("Vibration failed:",i)}}function ke(n=880,e=100){if(!l.getState().settings.sound)return;const i=Ht();if(i){if(i.state==="suspended"){i.resume().then(()=>{St(i,n,e),bt()}).catch(()=>{});return}St(i,n,e),bt()}}function St(n,e,t){try{const i=n.createOscillator(),s=n.createGain();i.connect(s),s.connect(n.destination),i.frequency.value=e,i.type="sine",s.gain.setValueAtTime(.3,n.currentTime),s.gain.exponentialRampToValueAtTime(.01,n.currentTime+t/1e3),i.start(n.currentTime),i.stop(n.currentTime+t/1e3)}catch(i){d.warn("Sound playback failed:",i)}}function pe(){Z(40),ke(880,100)}function Ea(){Z([60,40,60]),ke(440,200)}function K(){Z(30)}function wa(){Z(10)}function Ia(){Z(20)}function Wi(){Z([40,30,40]),ke(330,150)}function Ta(){Z([35,35]),ke(660,100)}function Ca(){if(Y!==null&&(clearTimeout(Y),Y=null),typeof speechSynthesis<"u")try{speechSynthesis.cancel()}catch{}H&&(H.close().catch(()=>{}),H=null)}async function Ra(){const n=Ht();if(n&&n.state==="suspended")try{await n.resume()}catch(e){d.warn("Failed to resume audio:",e)}}const Yi={enableHighAccuracy:!0,timeout:1e4,maximumAge:3e4},Ki={enableHighAccuracy:!1,timeout:15e3,maximumAge:3e4},Et={enableHighAccuracy:!1,timeout:3e4,maximumAge:12e4},Zi=10,Xi=30;class es{constructor(){c(this,"watchId",null);c(this,"lastPosition",null);c(this,"visibilityHandler",null);c(this,"wasActiveBeforeHidden",!1);c(this,"batteryUnsubscribe",null);c(this,"usingLowPowerMode",!1);c(this,"dutyCycleIntervalId",null);c(this,"isDutyCycling",!1);c(this,"pausedByView",!1);c(this,"timeOffset",null)}getGpsOptions(){const e=A.isLowBattery();return this.usingLowPowerMode=e,e?Ki:Yi}startDutyCycling(){this.isDutyCycling||(this.isDutyCycling=!0,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),d.debug("[GPS] Starting duty cycling (60s interval)"),this.dutyCycleIntervalId=setInterval(()=>{navigator.geolocation.getCurrentPosition(e=>this.handlePosition(e),e=>this.handleError(e),Et)},6e4),navigator.geolocation.getCurrentPosition(e=>this.handlePosition(e),e=>this.handleError(e),Et))}stopDutyCycling(){this.dutyCycleIntervalId!==null&&(clearInterval(this.dutyCycleIntervalId),this.dutyCycleIntervalId=null),this.isDutyCycling=!1}start(){if(this.watchId!==null||this.isDutyCycling)return!0;if(!navigator.geolocation)return d.error("Geolocation not supported"),l.setGpsStatus("inactive"),!1;this.pausedByView=!1,l.setGpsStatus("searching");try{const e=this.getGpsOptions();return this.watchId=navigator.geolocation.watchPosition(t=>this.handlePosition(t),t=>this.handleError(t),e),this.visibilityHandler||(this.visibilityHandler=()=>{if(document.hidden)this.wasActiveBeforeHidden=this.watchId!==null||this.isDutyCycling,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.wasActiveBeforeHidden&&l.setGpsStatus("inactive");else if(this.wasActiveBeforeHidden&&!this.pausedByView)if(l.setGpsStatus("searching"),A.isCriticalBattery())this.startDutyCycling();else{const t=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(i=>this.handlePosition(i),i=>this.handleError(i),t)}},document.addEventListener("visibilitychange",this.visibilityHandler)),this.batteryUnsubscribe||(this.batteryUnsubscribe=A.subscribe(()=>{if(this.watchId===null&&!this.isDutyCycling)return;const t=A.isCriticalBattery();if(t&&!this.isDutyCycling){d.debug("[GPS] Switching to duty-cycle mode (critical battery)"),this.startDutyCycling();return}if(!t&&this.isDutyCycling){d.debug("[GPS] Resuming continuous GPS from duty-cycle mode"),this.stopDutyCycling();const r=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(a=>this.handlePosition(a),a=>this.handleError(a),r);return}if(this.watchId===null)return;const i=A.isLowBattery();if(i===this.usingLowPowerMode)return;d.debug(`[GPS] Switching to ${i?"low-power":"high-accuracy"} mode`),navigator.geolocation.clearWatch(this.watchId);const s=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(r=>this.handlePosition(r),r=>this.handleError(r),s)})),!0}catch(e){return d.error("Failed to start GPS:",e),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),l.setGpsStatus("inactive"),!1}}pause(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.pausedByView=!0,this.wasActiveBeforeHidden=!1,l.setGpsStatus(this.lastPosition?"paused":"inactive")}resume(){if(this.pausedByView){if(this.pausedByView=!1,document.hidden){this.wasActiveBeforeHidden=!0;return}A.isCriticalBattery()?this.startDutyCycling():this.start()}}isPaused(){return this.pausedByView}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasActiveBeforeHidden=!1,this.pausedByView=!1,this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.lastPosition=null,this.timeOffset=null,l.setGpsStatus("inactive")}handlePosition(e){this.lastPosition=e;const t=e.timestamp-Date.now();Math.abs(t)>500&&d.warn(`[GPS] Clock offset ${t}ms - system clock may be inaccurate`),this.timeOffset=t;const i=e.coords.accuracy;l.setGpsStatus("active",i)}handleError(e){d.error("GPS error:",e.message),e.code===e.PERMISSION_DENIED?(l.setGpsStatus("inactive"),this.stop()):l.setGpsStatus("searching")}getPosition(){return this.lastPosition}getCoordinates(){if(this.lastPosition)return{latitude:this.lastPosition.coords.latitude,longitude:this.lastPosition.coords.longitude,accuracy:this.lastPosition.coords.accuracy}}getTimestamp(){var e;return((e=this.lastPosition)==null?void 0:e.timestamp)??null}getTimeOffset(){return this.timeOffset}getAccuracyStatus(){if(!this.lastPosition)return"unknown";const e=this.lastPosition.coords.accuracy;return e<=Zi?"good":e<=Xi?"fair":"poor"}isActive(){return(this.watchId!==null||this.isDutyCycling)&&this.lastPosition!==null}toggle(e){return e?this.start():(this.stop(),!0)}async requestPosition(){return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{this.lastPosition=t,e(t)},()=>e(null),this.getGpsOptions())}):null}}const ts=new es,ns=`You are a voice command processor for a ski race timing app.
Parse the user's spoken command and return a structured JSON response.

Context provided:
- role: "timer" (sets bib/point/run) or "gateJudge" (records faults)
- language: User's language (de/en)
- activeBibs: Racers currently on course (gate judge only)
- gateRange: Gates this judge is watching [start, end]
- pendingConfirmation: If set, user is responding to a confirmation prompt

For TIMER role, recognize:
- Bib numbers: spoken digits or number words (e.g., "forty-five" = 45, "fünfundvierzig" = 45)
- Timing point: "Start" / "Ziel" / "Finish"
- Run selection: "Lauf 1/2", "Run 1/2", "erster Lauf", "zweiter Lauf"
NOTE: Timer role does NOT support recording timestamps via voice (latency too high for timing)

For GATE JUDGE role, recognize:
- Fault recording with bib + gate + type
- Fault types: MG (missed gate/ausgelassen), STR (straddling/eingefädelt), BR (binding release/Bindung offen)
- Ready status: "Bereit", "Ready", "Fertig"
- Confirmation: "Ja", "Yes", "Correct", "Richtig", "Stimmt"
- Cancellation: "Nein", "No", "Cancel", "Abbrechen", "Falsch"

Return ONLY valid JSON (no markdown, no explanation):
{
  "action": "record_fault" | "set_bib" | "set_gate" | "set_point" | "set_run" | "toggle_ready" | "confirm" | "cancel" | "unknown",
  "confidence": 0.0-1.0,
  "params": {
    "bib": "string (3 digits, zero-padded)",
    "gate": number,
    "faultType": "MG" | "STR" | "BR",
    "point": "S" | "F",
    "run": number (positive integer, typically 1 or 2)
  },
  "confirmationNeeded": boolean,
  "confirmationPrompt": "string (spoken confirmation request in user's language)"
}

IMPORTANT:
- For gate judge faults, set confirmationNeeded=true with a clear prompt
- Confirmation prompts should be in the user's language
- If user tries to record time via voice, return action="unknown" (voice timing disabled)
- If unsure, set action="unknown" with low confidence`,is={model:"claude-3-haiku-20240307",maxTokens:256};function ss(n){return n.includes("/api/v1/voice")}async function rs(n,e,t){const{endpoint:i,apiKey:s,model:r,maxTokens:a}={...is,...t};if(!i)throw new Error("LLM endpoint is required");if(ss(i))return as(n,e,i);if(!s)throw new Error("API key is required for direct LLM calls");return os(n,e,i,s,r,a)}async function as(n,e,t){try{const i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcript:n,context:e})});if(!i.ok){const r=await i.text();throw d.error("[LLMProvider] Proxy error:",i.status,r),new Error(`Proxy error: ${i.status}`)}const s=await i.json();if(s.success&&s.intent)return d.debug("[LLMProvider] Proxy intent:",s.intent),s.intent;throw new Error("Invalid proxy response")}catch(i){return d.error("[LLMProvider] Proxy processing error:",i),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function os(n,e,t,i,s,r){var u;const o=`Context: ${JSON.stringify({role:e.role,language:e.language,currentRun:e.currentRun,activeBibs:e.activeBibs,gateRange:e.gateRange,pendingConfirmation:e.pendingConfirmation?{action:e.pendingConfirmation.action,params:e.pendingConfirmation.params}:null})}

Transcript: "${n}"`;try{const h=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:s,max_tokens:r,system:ns,messages:[{role:"user",content:o}]})});if(!h.ok){const v=await h.text();throw d.error("[LLMProvider] API error:",h.status,v),new Error(`LLM API error: ${h.status}`)}const g=await h.json();let f="";if(g.content&&Array.isArray(g.content)?f=((u=g.content[0])==null?void 0:u.text)||"":typeof g.content=="string"&&(f=g.content),!f)throw new Error("Empty response from LLM");let m=f.trim();m.startsWith("```")&&(m=m.replace(/```json?\n?/g,"").replace(/```$/g,"").trim());const T=JSON.parse(m);if(!T.action||typeof T.confidence!="number")throw new Error("Invalid intent structure");return d.debug("[LLMProvider] Parsed intent:",T),T}catch(h){return d.error("[LLMProvider] Processing error:",h),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function cs(n,e,t,i=5e3){const s=new Promise((r,a)=>{setTimeout(()=>a(new Error("LLM request timeout")),i)});return Promise.race([rs(n,e,t),s]).catch(r=>(d.warn("[LLMProvider] Timeout or error:",r),{action:"unknown",confidence:0,confirmationNeeded:!1}))}const ls="ski-timer-photos",us=1,$="photos",ds=3,hs=5e3;class fs{constructor(){c(this,"db",null);c(this,"initPromise",null);c(this,"saveQueue",[]);c(this,"activeSaves",0)}async initialize(){return this.initPromise?this.initPromise:(this.initPromise=new Promise(e=>{if(!window.indexedDB){d.warn("IndexedDB not supported - photo storage disabled"),e(!1);return}const t=indexedDB.open(ls,us);t.onerror=()=>{d.error("IndexedDB open error:",t.error),this.initPromise=null,e(!1)},t.onsuccess=()=>{this.db=t.result,e(!0)},t.onupgradeneeded=i=>{const s=i.target.result;s.objectStoreNames.contains($)||s.createObjectStore($,{keyPath:"entryId"}).createIndex("timestamp","timestamp",{unique:!1})}}),this.initPromise)}async savePhoto(e,t){return new Promise(i=>{this.saveQueue.push({entryId:e,photoBase64:t,resolve:i}),this.processQueue()})}processQueue(){for(;this.saveQueue.length>0&&this.activeSaves<ds;){const e=this.saveQueue.shift();this.activeSaves++,this.doSavePhotoWithTimeout(e.entryId,e.photoBase64).then(t=>{e.resolve(t)}).catch(()=>{e.resolve(!1)}).finally(()=>{this.activeSaves--,this.processQueue()})}}async doSavePhotoWithTimeout(e,t){return!this.db&&!await this.initialize()?!1:new Promise(i=>{if(!this.db){i(!1);return}try{const s=this.db.transaction([$],"readwrite"),r=s.objectStore($),a={entryId:e,photo:t,timestamp:Date.now()},o=setTimeout(()=>{try{s.abort()}catch{}},hs);s.onabort=()=>{clearTimeout(o),i(!1)};const u=r.put(a);u.onsuccess=()=>{clearTimeout(o),i(!0)},u.onerror=()=>{clearTimeout(o),d.error("Photo save error:",u.error),i(!1)}}catch(s){d.error("Photo save transaction error:",s),i(!1)}})}async getPhoto(e){return!this.db&&!await this.initialize()?null:new Promise(t=>{if(!this.db){t(null);return}try{const r=this.db.transaction([$],"readonly").objectStore($).get(e);r.onsuccess=()=>{const a=r.result;t((a==null?void 0:a.photo)||null)},r.onerror=()=>{d.error("Photo get error:",r.error),t(null)}}catch(i){d.error("Photo get transaction error:",i),t(null)}})}async deletePhoto(e){return!this.db&&!await this.initialize()?!1:new Promise(t=>{if(!this.db){t(!1);return}try{const r=this.db.transaction([$],"readwrite").objectStore($).delete(e);r.onsuccess=()=>{t(!0)},r.onerror=()=>{d.error("Photo delete error:",r.error),t(!1)}}catch(i){d.error("Photo delete transaction error:",i),t(!1)}})}async hasPhoto(e){return await this.getPhoto(e)!==null}async clearAll(){return!this.db&&!await this.initialize()?!1:new Promise(e=>{if(!this.db){e(!1);return}try{const s=this.db.transaction([$],"readwrite").objectStore($).clear();s.onsuccess=()=>{e(!0)},s.onerror=()=>{d.error("Photo clear error:",s.error),e(!1)}}catch(t){d.error("Photo clear transaction error:",t),e(!1)}})}async deletePhotos(e){for(const t of e)await this.deletePhoto(t)}async getStorageUsage(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{used:e.usage||0,quota:e.quota||0}}catch{return null}return null}async getPhotoCount(){return!this.db&&!await this.initialize()?0:new Promise(e=>{if(!this.db){e(0);return}try{const s=this.db.transaction([$],"readonly").objectStore($).count();s.onsuccess=()=>{e(s.result)},s.onerror=()=>{e(0)}}catch{e(0)}})}close(){this.db&&(this.db.close(),this.db=null,this.initPromise=null)}}const De=new fs;class gs{constructor(){c(this,"synth",null);c(this,"voice",null);c(this,"voicesLoaded",!1);typeof window<"u"&&"speechSynthesis"in window&&(this.synth=window.speechSynthesis,this.loadVoices())}isSupported(){return this.synth!==null}loadVoices(){if(!this.synth)return;this.synth.getVoices().length>0?(this.voicesLoaded=!0,this.selectVoiceForLanguage(l.getState().currentLang)):this.synth.addEventListener("voiceschanged",()=>{this.voicesLoaded=!0,this.selectVoiceForLanguage(l.getState().currentLang)},{once:!0})}selectVoiceForLanguage(e){if(!this.synth)return;const t=this.synth.getVoices(),i=e;this.voice=t.find(s=>s.lang.startsWith(i)&&s.name.toLowerCase().includes("female"))||t.find(s=>s.lang.startsWith(i))||t.find(s=>s.lang.startsWith("en"))||null,this.voice&&d.debug("[SpeechSynthesis] Selected voice:",this.voice.name,this.voice.lang)}setLanguage(e){this.voicesLoaded&&this.selectVoiceForLanguage(e)}speak(e,t){return new Promise((i,s)=>{if(!this.synth){s(new Error("Speech synthesis not supported"));return}this.synth.cancel();const r=new SpeechSynthesisUtterance(e);this.voice&&(r.voice=this.voice),r.rate=(t==null?void 0:t.rate)??1.1,r.pitch=(t==null?void 0:t.pitch)??1,r.volume=1,r.onend=()=>i(),r.onerror=a=>{a.error==="interrupted"?i():(d.warn("[SpeechSynthesis] Error:",a.error),s(new Error(a.error)))},this.synth.speak(r)})}sayOK(){return this.speak("OK",{rate:1.2})}sayRecorded(){const e=l.getState().currentLang;return this.speak(p("voiceRecorded",e),{rate:1.1})}sayNotUnderstood(){const e=l.getState().currentLang;return this.speak(p("voiceNotUnderstood",e),{rate:1})}cancel(){var e;(e=this.synth)==null||e.cancel()}}const J=new gs,x={CRITICAL:"critical",ERROR:"error",WARNING:"warning",INFO:"info"},wt={CRITICAL:8e3,ERROR:5e3,WARNING:4e3,INFO:3e3};function ps(n){return`[${n.component}] ${n.operation}`}function ms(n){return n instanceof Error?n.message:typeof n=="string"?n:"Unknown error"}function Ke(n){const e=ps(n),t=n.error?ms(n.error):"No error details",i={code:n.code,message:t,timestamp:new Date().toISOString(),...n.metadata};switch(n.severity){case x.CRITICAL:case x.ERROR:console.error(`${e}:`,t,i);break;case x.WARNING:console.warn(`${e}:`,t,i);break;case x.INFO:console.log(`${e}:`,t,i);break}if(n.userMessageKey){const s=l.getState().currentLang,r=p(n.userMessageKey,s),a=ys(n.severity),o=wt[n.severity.toUpperCase()]||wt.ERROR;N(r,a,o)}n.severity===x.CRITICAL&&window.dispatchEvent(new CustomEvent("critical-error",{detail:n}))}function ys(n){switch(n){case x.CRITICAL:case x.ERROR:return"error";case x.WARNING:return"warning";case x.INFO:return"info";default:return"error"}}function Aa(n,e,t,i){Ke({component:n,operation:e,severity:x.ERROR,error:t,userMessageKey:i})}function Da(n,e,t,i){Ke({component:n,operation:e,severity:x.WARNING,error:t,userMessageKey:i})}function Pa(n,e,t,i){Ke({component:n,operation:e,severity:x.CRITICAL,error:t,userMessageKey:i})}const vs=1e4;class bs extends Error{constructor(e,t){super(`Request to ${e} timed out after ${t}ms`),this.name="FetchTimeoutError"}}async function G(n,e={},t=vs){const i=new AbortController,s=setTimeout(()=>i.abort(),t);try{return await fetch(n,{...e,signal:i.signal})}catch(r){throw r instanceof Error&&r.name==="AbortError"?new bs(n,t):r}finally{clearTimeout(s)}}const me="skiTimerAuthToken";function Vt(n){let e=n.replace(/-/g,"+").replace(/_/g,"/");const t=e.length%4;return t&&(e+="=".repeat(4-t)),atob(e)}function U(){const n=y.getRaw(me);return n?{Authorization:`Bearer ${n}`}:{}}function ka(){const n=y.getRaw(me);if(!n)return!1;try{const e=n.split(".");if(e.length===3){const t=JSON.parse(Vt(e[1]));if(t.exp&&t.exp*1e3<Date.now())return!1}}catch{}return!0}function Ss(n){y.setRaw(me,n),y.flush()}function Es(){y.remove(me),y.flush()}const ws=1e4;async function La(n,e){const t=new AbortController,i=setTimeout(()=>t.abort(),ws);try{const s=await fetch("/api/v1/auth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:n,role:e}),signal:t.signal});clearTimeout(i);const r=await s.json();return s.ok?r.token?(Ss(r.token),{success:!0,token:r.token,isNewPin:r.isNewPin}):{success:!1,error:"No token received"}:{success:!1,error:r.error||"Authentication failed"}}catch(s){return clearTimeout(i),s instanceof Error&&s.name==="AbortError"?(d.error("Token exchange timeout"),{success:!1,error:"Request timeout"}):(d.error("Token exchange error:",s),{success:!1,error:"Network error"})}}function Is(n="Session expired. Please re-enter your PIN."){window.dispatchEvent(new CustomEvent("auth-expired",{detail:{message:n}}))}function Ts(){const n=y.getRaw(me);if(!n)return 1/0;try{const e=n.split(".");if(e.length===3){const t=JSON.parse(Vt(e[1]));if(t.exp)return t.exp*1e3-Date.now()}}catch{}return 1/0}class Cs{constructor(){c(this,"broadcastChannel",null)}initialize(e){if(typeof BroadcastChannel>"u"){d.info("BroadcastChannel not supported - cross-tab sync disabled (graceful degradation)");return}try{this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(`ski-timer-${e}`),this.broadcastChannel.onmessage=t=>{try{const{type:i,data:s}=t.data||{};if(i==="entry"&&le(s))l.mergeCloudEntries([s]);else if(i==="presence")s&&typeof s.id=="string"&&typeof s.name=="string"&&typeof s.lastSeen=="number"&&l.addConnectedDevice(s);else if(i==="fault")zt(s)&&l.mergeFaultsFromCloud([s]);else if(i==="fault-deleted"){const r=s;typeof r=="string"&&r&&l.markFaultForDeletion(r)}}catch(i){d.error("Error processing broadcast message:",i)}}}catch(t){d.warn("BroadcastChannel initialization failed:",t)}}broadcastEntry(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"entry",data:e})}catch(t){d.error("Broadcast error:",t)}}broadcastPresence(){const e=l.getState();if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"presence",data:{id:e.deviceId,name:e.deviceName,lastSeen:Date.now()}})}catch(t){d.error("Presence broadcast error:",t)}}broadcastFault(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"fault",data:e})}catch(t){d.error("Fault broadcast error:",t)}}broadcastFaultDeletion(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"fault-deleted",data:e})}catch(t){d.error("Fault deletion broadcast error:",t)}}cleanup(){if(this.broadcastChannel){try{this.broadcastChannel.close()}catch{}this.broadcastChannel=null}}}const se=new Cs,Rs={en:"en-US",de:"de-DE",fr:"fr-FR"};function Q(n){return Rs[n]}function As(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),i=String(n.getSeconds()).padStart(2,"0"),s=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${i}.${s}`}function Ds(n,e="de"){const t={weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"};return n.toLocaleDateString(Q(e),t)}function Fa(n,e=3){return String(n).padStart(e,"0")}function P(n){const e=document.createElement("div");return e.textContent=String(n),e.innerHTML}function w(n){return P(n).replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Na(n){return{S:"var(--start-color)",F:"var(--finish-color)"}[n]||"var(--text-secondary)"}function Ps(n,e="de"){return{en:{S:"Start",F:"Finish"},de:{S:"Start",F:"Ziel"},fr:{S:"Départ",F:"Arrivée"}}[e][n]}const ks={de:"L",en:"R",fr:"M"};function Ma(n,e="de"){return`${ks[e]}${n}`}function Ba(n){return n===1?"var(--primary)":n===2?"var(--warning)":"var(--text-secondary)"}function Ze(n,e){return{MG:p("faultMGShort",e),STR:p("faultSTRShort",e),BR:p("faultBRShort",e)}[n]||n}function _a(n){return n<1024?`${n} B`:n<1024*1024?`${(n/1024).toFixed(1)} KB`:`${(n/(1024*1024)).toFixed(1)} MB`}function $a(n,e){let t;const i=(...s)=>{clearTimeout(t),t=setTimeout(()=>n(...s),e)};return i.cancel=()=>clearTimeout(t),i}const Gt="skiTimerRecentRaces",Ls=50;function Ut(){try{return y.get(Gt)??[]}catch{return[]}}function Fs(n,e,t){try{const i=Ut(),s=n.toLowerCase(),r=i.findIndex(o=>o.raceId.toLowerCase()===s);r>=0?(i[r].lastUpdated=e,t!==void 0&&(i[r].entryCount=t)):i.unshift({raceId:n,createdAt:Date.now(),lastUpdated:e,entryCount:t}),i.sort((o,u)=>u.lastUpdated-o.lastUpdated);const a=i.slice(0,Ls);y.set(Gt,a)}catch(i){d.error("Failed to save recent race:",i)}}function xa(n=5){const e=Ut(),t=new Date;t.setHours(0,0,0,0);const i=t.getTime();return e.filter(s=>s.createdAt>=i||s.lastUpdated>=i).slice(0,n)}class Ns{constructor(){c(this,"isMetered",!1);c(this,"currentQuality","good");c(this,"networkChangeHandler",null);c(this,"onlineHandler",null);c(this,"offlineHandler",null);c(this,"changeListeners",new Set);c(this,"qualityListeners",new Set)}getConnection(){return navigator.connection}initialize(){this.currentQuality=navigator.onLine?"good":"offline";const e=this.getConnection();e&&(this.updateNetworkState(e),this.networkChangeHandler||(this.networkChangeHandler=()=>{const t=this.isMetered,i=this.currentQuality;this.updateNetworkState(e),t!==this.isMetered&&this.notifyListeners(),i!==this.currentQuality&&this.notifyQualityListeners()},e.addEventListener("change",this.networkChangeHandler)))}updateNetworkState(e){this.isMetered=e.saveData===!0||e.type==="cellular"||e.effectiveType==="slow-2g"||e.effectiveType==="2g",this.currentQuality=this.detectConnectionQuality(e)}detectConnectionQuality(e){return navigator.onLine?e&&(e.effectiveType==="2g"||e.effectiveType==="slow-2g"||e.saveData)?"slow":"good":"offline"}isMeteredConnection(){return this.isMetered}getEffectiveRtt(){const e=this.getConnection();return(e==null?void 0:e.rtt)??0}getConnectionQuality(){return this.currentQuality}onMeteredChange(e){return this.changeListeners.add(e),()=>{this.changeListeners.delete(e)}}onQualityChange(e){return this.qualityListeners.add(e),()=>{this.qualityListeners.delete(e)}}notifyListeners(){for(const e of this.changeListeners)e(this.isMetered)}notifyQualityListeners(){for(const e of this.qualityListeners)e(this.currentQuality)}registerOnlineHandlers(e,t){this.onlineHandler=()=>{const i=this.currentQuality,s=this.getConnection();this.currentQuality=this.detectConnectionQuality(s),i!==this.currentQuality&&this.notifyQualityListeners(),e()},this.offlineHandler=()=>{const i=this.currentQuality;this.currentQuality="offline",i!==this.currentQuality&&this.notifyQualityListeners(),t()},window.addEventListener("online",this.onlineHandler),window.addEventListener("offline",this.offlineHandler)}cleanup(){const e=this.getConnection();this.networkChangeHandler&&e&&(e.removeEventListener("change",this.networkChangeHandler),this.networkChangeHandler=null),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.offlineHandler&&(window.removeEventListener("offline",this.offlineHandler),this.offlineHandler=null),this.changeListeners.clear(),this.qualityListeners.clear()}}const z=new Ns,ce="/api/v1/sync",Xe="/api/v1/faults",Jt=15e3,It=3e4,Ms=5,Bs=2e3,_s=1e4,$s=25e3,ye=8e3,xs=15e3,jt=10,Os=[15e3,2e4,3e4,45e3,6e4],qt=6,Tt=[2e4,3e4,45e3,6e4,9e4],zs=4,Ct=[3e4,45e3,6e4,9e4,12e4],Rt=[3e4,6e4],At=3,Dt=3e5,Hs=[3e4,45e3,6e4,9e4,12e4],Vs=3e4,Gs=3e4,Pt=6e4,kt=3e4,Us={normal:{intervals:Os,threshold:qt,baseInterval:Jt},medium:{intervals:Tt,threshold:zs,baseInterval:Tt[0]},low:{intervals:Ct,threshold:At,baseInterval:Ct[0]},critical:{intervals:Rt,threshold:At,baseInterval:Rt[0]}},Js=1e3;function Le(){return z.getEffectiveRtt()>Js?xs:ye}function js(n){const e=n instanceof Error?n.message:"";return(n instanceof Error?n.name:"")==="FetchTimeoutError"||e.includes("timed out")||e.includes("500")||e.includes("503")?"error":e.includes("Failed to fetch")||e.includes("NetworkError")?"offline":"error"}async function Qt(n,e){if(e&&Bt(n.photo)){const t=await De.getPhoto(n.id);return{...n,photo:t||void 0}}return n.photo?{...n,photo:void 0}:{...n}}let b=null,re=0,ie=null,ze=!1;const qs=3600*1e3;function Qs(n){b=n,ae=!1}function Ws(){return re}async function Ys(n){const e=[];for(const t of n)if(_t(t.photo)){const{syncPhotos:i}=l.getState().settings;if(i){if(await De.hasPhoto(t.id)){e.push({...t,photo:"indexeddb"});continue}await De.savePhoto(t.id,t.photo)?e.push({...t,photo:"indexeddb"}):(d.warn("Sync: Photo storage failed for entry:",t.id),e.push({...t,photo:void 0}))}else e.push({...t,photo:void 0})}else e.push(t);return e}async function Lt(){if(ae)return;const n=l.getState();if(!(!n.settings.sync||!n.raceId)){if(ie)return ie;ie=Ks();try{await ie}finally{ie=null}}}async function Ks(){const n=l.getState();if(!ze){const t=Ts();if(t>0&&t<qs){ze=!0;const i=n.currentLang;b==null||b.showToast(p("sessionExpiryWarning",i),"warning",1e4)}}const e=l.getState().syncStatus;(e==="connected"||e==="connecting")&&l.setSyncStatus("syncing");try{const t=new URLSearchParams({raceId:n.raceId,deviceId:n.deviceId,deviceName:n.deviceName});re>0&&t.set("since",String(re));const i=await G(`${ce}?${t}`,{headers:{"Accept-Encoding":"gzip, deflate",...U()}},Le());if(i.status===401){let h={};try{h=await i.json()}catch{h={}}if(h.expired){Es(),l.setSyncStatus("disconnected"),Is(),b==null||b.onCleanup();return}throw new Error(`HTTP ${i.status}: ${h.error||"Unauthorized"}`)}if(ae)return;if(!i.ok)throw new Error(`HTTP ${i.status}`);let s;try{s=await i.json()}catch{throw new Error("Invalid response format")}if(!s||typeof s!="object")throw new Error("Invalid data structure");if(s.deleted){window.dispatchEvent(new CustomEvent("race-deleted",{detail:{raceId:n.raceId,deletedAt:s.deletedAt,message:s.message}})),b==null||b.onCleanup();return}const a=(Array.isArray(s.entries)?s.entries:[]).filter(h=>le(h)?!0:(d.warn("Skipping invalid entry from cloud:",h),!1)),o=Array.isArray(s.deletedIds)?s.deletedIds.filter(h=>typeof h=="string"&&h.length>0):[];if(ae||l.getState().raceId!==n.raceId)return;l.setSyncStatus("connected"),typeof s.deviceCount=="number"&&l.setCloudDeviceCount(s.deviceCount),typeof s.highestBib=="number"&&l.setCloudHighestBib(s.highestBib);let u=!1;if(o.length>0&&(l.removeDeletedCloudEntries(o),u=!0),a.length>0){const h=await Ys(a);if(ae||l.getState().raceId!==n.raceId)return;const g=l.mergeCloudEntries(h,o);if(g>0){u=!0;const f=l.getState().currentLang;b==null||b.showToast(p("syncedEntriesFromCloud",f).replace("{count}",String(g)))}}re=s.lastUpdated||0,n.raceId&&Fs(n.raceId,re,a.length),b==null||b.onPollingAdjust(!0,u)}catch(t){d.error("Cloud sync fetch error:",t),l.setSyncStatus(js(t)),b==null||b.onPollingAdjust(!1)}}async function Zs(n,e){const t=l.getState();if(!t.settings.sync||!t.raceId)return!1;try{const i=await G(`${ce}?raceId=${encodeURIComponent(t.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...U()},body:JSON.stringify({entryId:n,deviceId:e||t.deviceId,deviceName:t.deviceName})},Le());if(!i.ok)throw new Error(`HTTP ${i.status}`);return!0}catch(i){return d.error("Cloud sync delete error:",i),!1}}async function He(n){const e=l.getState();if(!e.settings.sync||!e.raceId)return!1;try{const t=await Qt(n,e.settings.syncPhotos),i=l.getState().raceId;if(!i||i!==e.raceId)return!1;const s=await G(`${ce}?raceId=${encodeURIComponent(i)}`,{method:"POST",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...U()},body:JSON.stringify({entry:t,deviceId:e.deviceId,deviceName:e.deviceName})},Le());if(!s.ok)throw new Error(`HTTP ${s.status}`);try{const r=await s.json(),a=l.getState().currentLang;if(r.deleted)return d.warn("Race was deleted on server, entry not saved:",n.id),b==null||b.showToast(p("raceDeleted",a),"error",5e3),!1;if(r.photoSkipped&&(b==null||b.showToast(p("photoTooLarge",a),"warning")),r.crossDeviceDuplicate){const o=r.crossDeviceDuplicate,u=Ps(o.point,a);b==null||b.showToast(p("crossDeviceDuplicate",a).replace("{bib}",o.bib).replace("{point}",u).replace("{device}",o.deviceName),"warning",5e3)}typeof r.deviceCount=="number"&&l.setCloudDeviceCount(r.deviceCount),typeof r.highestBib=="number"&&l.setCloudHighestBib(r.highestBib)}catch(r){d.warn("Failed to parse send response body:",r)}return l.removeFromSyncQueue(n.id),b==null||b.onResetFastPolling(),!0}catch(t){return d.error("Cloud sync send error:",t),!1}}async function Xs(n){const e=new Map,t=l.getState();if(!t.settings.sync||!t.raceId||n.length===0){for(const s of n)e.set(s.id,!1);return e}const i=n.slice(0,jt);try{const s=[];for(const u of i)s.push(await Qt(u,t.settings.syncPhotos));const r=l.getState();if(!r.raceId||r.raceId!==t.raceId){for(const u of i)e.set(u.id,!1);return e}const a=await G(`${ce}?raceId=${encodeURIComponent(r.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...U()},body:JSON.stringify({entries:s,deviceId:r.deviceId,deviceName:r.deviceName})},Le());if(!a.ok)throw new Error(`HTTP ${a.status}`);const o=await a.json();if(Array.isArray(o.results))for(const u of o.results)e.set(String(u.entryId),u.success===!0);for(const u of i)e.get(u.id)===!0&&l.removeFromSyncQueue(u.id);return typeof o.deviceCount=="number"&&l.setCloudDeviceCount(o.deviceCount),typeof o.highestBib=="number"&&l.setCloudHighestBib(o.highestBib),b==null||b.onResetFastPolling(),e}catch(s){d.error("Cloud sync batch send error:",s);for(const r of i)e.set(r.id,!1);return e}}async function er(){const n=l.getState();if(!(!n.settings.sync||!n.raceId))for(const e of n.entries)e.deviceId===n.deviceId&&!e.syncedAt&&await He(e)}let ae=!1;function tr(){ae=!0,b=null,re=0,ie=null,ze=!1}let q=null,et=[],Ie=!1;function nr(n){q=n}function ir(n){const e=l.getState();et=n.filter(t=>t.deviceId!==e.deviceId)}function sr(){return et}async function Ft(){const n=l.getState();if(!(!n.settings.sync||!n.raceId))try{const e=new URLSearchParams({raceId:n.raceId,deviceId:n.deviceId,deviceName:n.deviceName});n.deviceRole==="gateJudge"&&n.gateAssignment&&(e.set("gateStart",String(n.gateAssignment[0])),e.set("gateEnd",String(n.gateAssignment[1])),e.set("isReady",String(n.isJudgeReady)),e.set("firstGateColor",n.firstGateColor));const t=await G(`${Xe}?${e}`,{headers:{"Accept-Encoding":"gzip, deflate",...U()}},ye);if(!t.ok){if(t.status===401)return;throw new Error(`HTTP ${t.status}`)}const i=await t.json();if(!i||typeof i!="object")throw new Error("Invalid fault data structure");const s=Array.isArray(i.faults)?i.faults:[],r=Array.isArray(i.deletedIds)?i.deletedIds.filter(a=>typeof a=="string"):[];if(r.length>0&&l.removeDeletedCloudFaults(r),s.length>0){const a=l.mergeFaultsFromCloud(s,r);if(a>0){const o=l.getState().currentLang;q==null||q.showToast(p("syncedFaultsFromCloud",o).replace("{count}",String(a)))}}Array.isArray(i.gateAssignments)&&ir(i.gateAssignments),Ve().catch(a=>{d.error("Failed to push local faults after fetch:",a)})}catch(e){d.error("Fault sync fetch error:",e),window.dispatchEvent(new CustomEvent("fault-sync-error",{detail:{error:e instanceof Error?e.message:"Unknown error"}}))}}async function Wt(n){const e=l.getState();if(!e.settings.sync||!e.raceId)return!1;const t=e.raceId;try{const i=await G(`${Xe}?raceId=${encodeURIComponent(t)}`,{method:"POST",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...U()},body:JSON.stringify({fault:n,deviceId:e.deviceId,deviceName:e.deviceName,gateRange:e.gateAssignment,isReady:e.isJudgeReady,firstGateColor:e.firstGateColor})},ye);if(!i.ok)throw new Error(`HTTP ${i.status}`);const s=l.getState().raceId;return!s||s!==t?!1:(l.markFaultSynced(n.id),q==null||q.onResetFastPolling(),!0)}catch(i){return d.error("Fault sync send error:",i),!1}}async function rr(n,e,t){const i=l.getState();if(!i.settings.sync||!i.raceId)return!1;try{const s=await G(`${Xe}?raceId=${encodeURIComponent(i.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",...U()},body:JSON.stringify({faultId:n,deviceId:e||i.deviceId,deviceName:i.deviceName,approvedBy:t||i.deviceName})},ye);if(!s.ok)throw new Error(`HTTP ${s.status}`);return!0}catch(s){return d.error("Fault sync delete error:",s),!1}}async function Ve(){if(!Ie){Ie=!0;try{const n=l.getState();if(!n.settings.sync||!n.raceId)return;for(const e of n.faultEntries)e.deviceId===n.deviceId&&!e.syncedAt&&await Wt(e)}finally{Ie=!1}}}function ar(){q=null,et=[],Ie=!1}class or{constructor(){c(this,"pollInterval",null);c(this,"consecutiveErrors",0);c(this,"consecutiveNoChanges",0);c(this,"currentIdleLevel",0);c(this,"currentBatteryLevel","normal");c(this,"currentBatteryRawLevel",1);c(this,"currentConnectionQuality","good");c(this,"isTabHidden",!1);c(this,"batteryUnsubscribe",null);c(this,"meteredUnsubscribe",null);c(this,"qualityUnsubscribe",null);c(this,"isAdjustingInterval",!1);c(this,"currentPollingIntervalMs",0);c(this,"pollCallback",null)}initialize(e){this.pollCallback=e,this.batteryUnsubscribe=A.subscribe(t=>{const i=this.currentBatteryLevel,s=this.currentBatteryRawLevel;this.currentBatteryLevel=t.batteryLevel,this.currentBatteryRawLevel=t.level;const r=s>=.05&&t.level<.05||s<.05&&t.level>=.05;(i!==t.batteryLevel||r)&&this.pollInterval&&this.applyBatteryAwarePolling()}),this.meteredUnsubscribe=z.onMeteredChange(()=>{this.pollInterval&&this.applyBatteryAwarePolling()}),this.currentConnectionQuality=z.getConnectionQuality(),this.qualityUnsubscribe=z.onQualityChange(t=>{const i=this.currentConnectionQuality;this.currentConnectionQuality=t,i!==t&&this.pollInterval&&this.applyBatteryAwarePolling()})}start(){this.currentPollingIntervalMs=0,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.pollCallback&&this.pollCallback();const e=this.consecutiveErrors>2?It:Jt;this.setPollingInterval(e)}stop(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.currentPollingIntervalMs=0}isPolling(){return this.pollInterval!==null}getPollingConfig(){const e=z.isMeteredConnection();return this.currentConnectionQuality==="offline"?{intervals:[Pt],threshold:1,baseInterval:Pt}:this.isTabHidden?{intervals:[kt],threshold:1,baseInterval:kt}:this.currentBatteryRawLevel<.05&&!A.isCharging()?{intervals:[Dt],threshold:1,baseInterval:Dt}:this.currentConnectionQuality==="slow"||e?{intervals:Hs,threshold:qt,baseInterval:this.currentConnectionQuality==="slow"?Gs:Vs}:Us[this.currentBatteryLevel]}setPollingInterval(e){this.currentPollingIntervalMs===e&&this.pollInterval||(this.pollInterval&&clearInterval(this.pollInterval),this.currentPollingIntervalMs=e,this.pollCallback&&(this.pollInterval=setInterval(this.pollCallback,e)))}applyBatteryAwarePolling(){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{const e=this.getPollingConfig();if(!e.intervals||e.intervals.length===0){this.setPollingInterval(e.baseInterval);return}this.currentIdleLevel=Math.min(Math.max(0,this.currentIdleLevel),e.intervals.length-1);const t=this.consecutiveNoChanges<e.threshold?e.baseInterval:e.intervals[this.currentIdleLevel];this.setPollingInterval(t)}finally{this.isAdjustingInterval=!1}}}adjustPollingInterval(e,t=!1){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{if(!e){this.consecutiveErrors++,this.consecutiveErrors>2&&this.pollInterval&&this.setPollingInterval(It);return}this.consecutiveErrors=0;const i=this.getPollingConfig();if(!i.intervals||i.intervals.length===0){this.pollInterval&&this.setPollingInterval(i.baseInterval);return}if(t)this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval&&this.setPollingInterval(i.baseInterval);else if(this.consecutiveNoChanges++,this.consecutiveNoChanges>=i.threshold){const s=Math.min(Math.max(0,this.currentIdleLevel+1),i.intervals.length-1);s!==this.currentIdleLevel&&(this.currentIdleLevel=s,this.pollInterval&&this.setPollingInterval(i.intervals[this.currentIdleLevel]))}}finally{this.isAdjustingInterval=!1}}}resetToFastPolling(){if(this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval){const e=this.getPollingConfig();this.setPollingInterval(e.baseInterval)}}setTabHidden(e){this.isTabHidden!==e&&(this.isTabHidden=e,this.pollInterval&&(e?this.applyBatteryAwarePolling():(this.pollCallback&&this.pollCallback(),this.applyBatteryAwarePolling())))}cleanup(){this.stop(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.meteredUnsubscribe&&(this.meteredUnsubscribe(),this.meteredUnsubscribe=null),this.qualityUnsubscribe&&(this.qualityUnsubscribe(),this.qualityUnsubscribe=null),this.pollCallback=null,this.consecutiveErrors=0,this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.isTabHidden=!1,this.currentConnectionQuality="good"}}const O=new or;class cr{constructor(){c(this,"queueInterval",null);c(this,"isProcessingQueue",!1);c(this,"sendEntryCallback",null);c(this,"sendBatchCallback",null)}initialize(e){this.sendEntryCallback=e}initializeBatch(e){this.sendBatchCallback=e}start(e=_s){this.queueInterval&&clearInterval(this.queueInterval),this.queueInterval=setInterval(()=>this.processQueue(),e)}stop(){this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null)}isProcessing(){return this.queueInterval!==null}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{const e=l.getState();if(!e.settings.sync||!e.raceId||e.syncQueue.length===0)return;if(!this.sendEntryCallback){d.warn("Queue processor: No send callback configured");return}const t=Date.now(),i=[],s=[];for(const r of e.syncQueue){if(r.retryCount>=Ms){d.warn("Max retries exceeded for entry:",r.entry.id),s.push(r.entry.id);continue}const o=Bs*2**r.retryCount*(.5+Math.random());if(!(t-r.lastAttempt<o)&&(i.push({entry:r.entry,retryCount:r.retryCount}),i.length>=jt))break}for(const r of s)l.removeFromSyncQueue(r);if(i.length===0)return;if(i.length>=2&&this.sendBatchCallback){const r=i.map(o=>o.entry),a=await this.sendBatchCallback(r);for(const o of i)a.get(o.entry.id)!==!0&&l.updateSyncQueueItem(o.entry.id,{retryCount:o.retryCount+1,lastAttempt:t,error:"Failed to sync"})}else for(const r of i)await this.sendEntryCallback(r.entry)||l.updateSyncQueueItem(r.entry.id,{retryCount:r.retryCount+1,lastAttempt:t,error:"Failed to sync"})}finally{this.isProcessingQueue=!1}}}getQueueLength(){return l.getState().syncQueue.length}cleanup(){this.stop(),this.sendEntryCallback=null,this.sendBatchCallback=null}}const j=new cr,lr=12e4;class ur{constructor(){c(this,"visibilityHandler",null);c(this,"wasQueueProcessingBeforeHidden",!1);c(this,"faultPollInterval",null)}initialize(){const e=l.getState();if(!e.settings.sync||!e.raceId){this.cleanup();return}this.initializeModules(),se.initialize(e.raceId),z.initialize(),O.start(),this.startFaultPolling(),j.start(this.getQueueInterval()),er().catch(t=>{d.error("Failed to push local entries during sync init:",t)}),Ve().catch(t=>{d.error("Failed to push local faults during sync init:",t)}),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(O.setTabHidden(!0),this.wasQueueProcessingBeforeHidden=j.isProcessing(),j.stop(),this.stopFaultPolling()):(O.setTabHidden(!1),this.wasQueueProcessingBeforeHidden&&j.start(this.getQueueInterval()),this.startFaultPolling())},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.visibilityHandler()),A.initialize().catch(t=>{d.warn("[Sync] Battery service init failed:",t)}),z.registerOnlineHandlers(()=>{l.getState().syncStatus==="offline"&&(l.setSyncStatus("connecting"),O.start(),Ve().catch(t=>{d.error("Failed to push local faults on reconnect:",t)}))},()=>{l.setSyncStatus("offline")}),navigator.onLine?l.setSyncStatus("connecting"):l.setSyncStatus("offline")}initializeModules(){O.initialize(()=>{Lt().catch(e=>{d.error("Poll fetch failed:",e)})}),j.initialize(He),j.initializeBatch(Xs),Qs({onPollingAdjust:(e,t)=>{O.adjustPollingInterval(e,t)},onResetFastPolling:()=>{O.resetToFastPolling()},onCleanup:()=>this.cleanup(),showToast:(e,t,i)=>this.showSyncToast(e,t,i)}),nr({onResetFastPolling:()=>{O.resetToFastPolling()},showToast:(e,t,i)=>this.showSyncToast(e,t,i)})}getQueueInterval(){return z.isMeteredConnection()?$s:void 0}startFaultPolling(){this.stopFaultPolling(),Ft().catch(e=>{d.error("Initial fault fetch failed:",e)}),this.faultPollInterval=setInterval(()=>{Ft().catch(e=>{d.error("Fault poll failed:",e)})},lr)}stopFaultPolling(){this.faultPollInterval&&(clearInterval(this.faultPollInterval),this.faultPollInterval=null)}showSyncToast(e,t="success",i){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:e,type:t,duration:i}}))}cleanup(){O.cleanup(),this.stopFaultPolling(),j.cleanup(),se.cleanup(),z.cleanup(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasQueueProcessingBeforeHidden=!1,tr(),ar(),l.setSyncStatus("disconnected")}async forceRefresh(){await Lt()}getQueueLength(){return j.getQueueLength()}getLastSyncTime(){return Ws()}broadcastEntry(e){se.broadcastEntry(e)}broadcastPresence(){se.broadcastPresence()}resetToFastPolling(){O.resetToFastPolling()}sendEntryToCloud(e){return He(e)}deleteEntryFromCloud(e,t){return Zs(e,t)}sendFaultToCloud(e){return Wt(e)}async deleteFaultFromCloud(e,t,i){return rr(e,t,i)}getOtherGateAssignments(){return sr()}async checkRaceExists(e){if(!e)return{exists:!1,entryCount:0};try{const t=await G(`${ce}?raceId=${encodeURIComponent(e)}&checkOnly=true`,{headers:{"Accept-Encoding":"gzip, deflate",...U()}},5e3);if(!t.ok)return{exists:!1,entryCount:0};const i=await t.json();return{exists:i.exists===!0,entryCount:typeof i.entryCount=="number"?i.entryCount:0}}catch(t){return d.error("Check race exists error:",t),{exists:!1,entryCount:0}}}async getPhotoSyncStats(){const e=l.getState();let t=0,i=0,s=0,r=0;for(const a of e.entries)if(Bt(a.photo)&&a.deviceId===e.deviceId){const o=await De.getPhoto(a.id);o&&(t++,i+=o.length)}if(e.settings.sync&&e.raceId)try{const a=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName,statsOnly:"true"}),o=await G(`${ce}?${a}`,{headers:{"Accept-Encoding":"gzip, deflate",...U()}},ye);if(o.ok){const u=await o.json();s=typeof u.photoCount=="number"?u.photoCount:0,r=typeof u.photoTotalSize=="number"?u.photoTotalSize:0}}catch(a){d.warn("Failed to fetch cloud photo stats:",a)}return{uploadCount:t,uploadSize:i,downloadCount:s,downloadSize:r,totalSize:i+r}}}const he=new ur;async function Oa(n){const e=l.getState();he.broadcastEntry(n),e.settings.sync&&e.raceId&&(await he.sendEntryToCloud(n)||l.addToSyncQueue(n))}async function dr(n){const e=l.getState();se.broadcastFault(n),e.settings.sync&&e.raceId&&(await he.sendFaultToCloud(n)||d.warn("Failed to sync fault to cloud, will retry on next poll:",n.id))}async function hr(n){const e=l.getState();return se.broadcastFaultDeletion(n.id),e.settings.sync&&e.raceId?he.deleteFaultFromCloud(n.id,n.deviceId,n.markedForDeletionBy):!0}class fr{constructor(){c(this,"recognition",null);c(this,"llmConfig",null);c(this,"isEnabled",!1);c(this,"isPaused",!1);c(this,"isOnline",typeof navigator<"u"?navigator.onLine:!0);c(this,"pendingIntent",null);c(this,"status","inactive");c(this,"confirmationTimeout",null);c(this,"restartTimeout",null);c(this,"stateCallbacks",new Set);c(this,"actionCallbacks",new Set);c(this,"CONFIRMATION_TIMEOUT_MS",1e4);c(this,"LLM_TIMEOUT_MS",5e3);c(this,"RESTART_DELAY_MS",500);c(this,"handleOnline",()=>{var e;if(this.isOnline=!0,this.isEnabled){this.setStatus("listening");try{(e=this.recognition)==null||e.start()}catch{}}});c(this,"handleOffline",()=>{var e;this.isOnline=!1,this.isEnabled&&(this.setStatus("offline"),(e=this.recognition)==null||e.stop())})}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(e){if(!this.isSupported())return d.warn("[Voice] Speech Recognition not supported"),!1;if(!J.isSupported())return d.warn("[Voice] Speech Synthesis not supported"),!1;this.llmConfig=e;const t=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new t,this.recognition.continuous=!0,this.recognition.interimResults=!1,this.updateRecognitionLanguage(),this.setupRecognitionHandlers(),window.addEventListener("online",this.handleOnline),window.addEventListener("offline",this.handleOffline),d.debug("[Voice] Initialized successfully"),!0}updateRecognitionLanguage(){if(!this.recognition)return;const e=l.getState().currentLang;this.recognition.lang=Q(e),J.setLanguage(e)}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{d.debug("[Voice] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{const t=e.results[e.resultIndex];if(t.isFinal){const i=t[0].transcript.trim();d.debug("[Voice] Transcript:",i),this.processTranscript(i)}},this.recognition.onerror=e=>{switch(d.warn("[Voice] Recognition error:",e.error),e.error){case"network":this.setStatus("offline");break;case"not-allowed":case"service-not-allowed":this.setStatus("error"),this.disable();break;case"no-speech":case"audio-capture":break;case"aborted":return;default:this.setStatus("error")}},this.recognition.onend=()=>{d.debug("[Voice] Recognition ended"),this.isEnabled&&this.isOnline&&!this.isPaused&&this.status!=="error"&&this.scheduleRestart()})}scheduleRestart(){this.restartTimeout&&clearTimeout(this.restartTimeout),this.restartTimeout=setTimeout(()=>{var e;if(this.isEnabled&&this.isOnline&&!this.isPaused)try{(e=this.recognition)==null||e.start()}catch{}},this.RESTART_DELAY_MS)}async processTranscript(e){if(!e||!this.llmConfig)return;this.setStatus("processing");const t=l.getState(),i={role:t.deviceRole,language:t.currentLang,currentRun:t.selectedRun,activeBibs:t.deviceRole==="gateJudge"?this.getActiveBibs(t.selectedRun):void 0,gateRange:t.gateAssignment||void 0,pendingConfirmation:this.pendingIntent||void 0};try{const s=await cs(e,i,this.llmConfig,this.LLM_TIMEOUT_MS);await this.handleIntent(s)}catch(s){d.error("[Voice] Processing error:",s),this.setStatus("error"),await J.sayNotUnderstood(),this.setStatus("listening")}}getActiveBibs(e){const t=l.getState(),i=new Set,s=new Set;for(const r of t.entries)r.run===e&&(r.point==="S"?i.add(r.bib):r.point==="F"&&s.add(r.bib));return Array.from(i).filter(r=>!s.has(r))}async handleIntent(e){if(this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.pendingIntent&&(e.action==="confirm"||e.action==="cancel")){if(e.action==="confirm")this.executeIntent(this.pendingIntent),await J.sayRecorded();else{const t=l.getState().currentLang;await J.speak(p("voiceCancelled",t))}this.pendingIntent=null,this.setStatus("listening");return}if(e.action==="unknown"||e.confidence<.5){await J.sayNotUnderstood(),this.setStatus("listening");return}if(e.confirmationNeeded&&e.confirmationPrompt){this.pendingIntent=e,this.setStatus("confirming"),await J.speak(e.confirmationPrompt),this.confirmationTimeout=setTimeout(()=>{this.pendingIntent&&(d.debug("[Voice] Confirmation timeout"),this.pendingIntent=null,this.setStatus("listening"))},this.CONFIRMATION_TIMEOUT_MS);return}this.executeIntent(e),this.setStatus("listening")}executeIntent(e){d.debug("[Voice] Executing intent:",e.action);for(const t of this.actionCallbacks)t(e)}setStatus(e){if(this.status!==e){this.status=e;for(const t of this.stateCallbacks)t(e)}}enable(){if(!this.recognition||!this.llmConfig)return d.warn("[Voice] Not initialized"),!1;if(!this.isOnline)return this.setStatus("offline"),!1;this.isEnabled=!0,this.updateRecognitionLanguage();try{return this.recognition.start(),!0}catch(e){return d.warn("[Voice] Failed to start recognition:",e),this.setStatus("error"),!1}}disable(){var e;this.isEnabled=!1,this.isPaused=!1,this.pendingIntent=null,this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.stop()}catch{}J.cancel(),this.setStatus("inactive")}pause(){var e;if(!(!this.isEnabled||this.isPaused)){this.isPaused=!0,this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.abort()}catch{}d.debug("[Voice] Paused")}}resume(){!this.isEnabled||!this.isPaused||(this.isPaused=!1,this.isOnline&&this.status!=="error"&&this.scheduleRestart(),d.debug("[Voice] Resumed"))}getStatus(){return this.status}isActive(){return this.isEnabled}onStatusChange(e){return this.stateCallbacks.add(e),()=>this.stateCallbacks.delete(e)}onAction(e){return this.actionCallbacks.add(e),()=>this.actionCallbacks.delete(e)}isPausedState(){return this.isPaused}cleanup(){this.disable(),this.stateCallbacks.clear(),this.actionCallbacks.clear(),window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),this.recognition=null,this.llmConfig=null}}const za=new fr;class gr{constructor(){c(this,"recognition",null);c(this,"status","idle");c(this,"isDestroyed",!1);c(this,"statusCallbacks",new Set);c(this,"transcriptCallbacks",new Set);c(this,"MAX_DURATION_MS",3e4);c(this,"recordingTimeout",null)}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(){if(this.recognition)return!0;if(!this.isSupported())return d.warn("[VoiceNote] Speech Recognition not supported"),this.setStatus("unsupported"),!1;const e=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new e,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.setupRecognitionHandlers(),this.updateLanguage(),d.debug("[VoiceNote] Initialized successfully"),!0}updateLanguage(){if(!this.recognition)return;const e=l.getState().currentLang;this.recognition.lang=Q(e)}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{d.debug("[VoiceNote] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{let t="",i="";for(let s=e.resultIndex;s<e.results.length;s++){const r=e.results[s];r.isFinal?i+=r[0].transcript:t+=r[0].transcript}t&&this.notifyTranscript(t,!1),i&&this.notifyTranscript(i,!0)},this.recognition.onerror=e=>{switch(d.warn("[VoiceNote] Recognition error:",e.error),e.error){case"not-allowed":case"service-not-allowed":this.setStatus("error");break;case"no-speech":case"audio-capture":this.setStatus("idle");break;case"aborted":this.setStatus("idle");break;default:this.setStatus("error")}this.clearRecordingTimeout()},this.recognition.onend=()=>{d.debug("[VoiceNote] Recognition ended"),this.clearRecordingTimeout(),this.status==="listening"&&this.setStatus("idle")})}start(){var e;if(this.isDestroyed||!this.initialize())return!1;this.updateLanguage();try{return(e=this.recognition)==null||e.start(),this.recordingTimeout=setTimeout(()=>{d.debug("[VoiceNote] Max duration reached, stopping"),this.stop()},this.MAX_DURATION_MS),!0}catch(t){return d.warn("[VoiceNote] Failed to start:",t),this.setStatus("error"),!1}}stop(){var e;this.clearRecordingTimeout();try{(e=this.recognition)==null||e.stop()}catch{}this.setStatus("idle")}abort(){var e;this.clearRecordingTimeout();try{(e=this.recognition)==null||e.abort()}catch{}this.setStatus("idle")}clearRecordingTimeout(){this.recordingTimeout&&(clearTimeout(this.recordingTimeout),this.recordingTimeout=null)}setStatus(e){if(this.status!==e){this.status=e;for(const t of this.statusCallbacks)try{t(e)}catch(i){d.error("[VoiceNote] Status callback error:",i)}}}notifyTranscript(e,t){for(const i of this.transcriptCallbacks)try{i(e,t)}catch(s){d.error("[VoiceNote] Transcript callback error:",s)}}getStatus(){return this.status}isRecording(){return this.status==="listening"}onStatusChange(e){return this.statusCallbacks.add(e),()=>this.statusCallbacks.delete(e)}onTranscript(e){return this.transcriptCallbacks.add(e),()=>this.transcriptCallbacks.delete(e)}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.abort(),this.statusCallbacks.clear(),this.transcriptCallbacks.clear(),this.recognition=null)}}const Ha=new gr,pr=600*1e3,mr=60*1e3;class yr{constructor(){c(this,"wakeLock",null);c(this,"isEnabled",!1);c(this,"visibilityHandler",null);c(this,"lastInteraction",Date.now());c(this,"idleCheckInterval",null);c(this,"interactionHandler",null);c(this,"hasShownFailureToast",!1)}isSupported(){return"wakeLock"in navigator}async enable(){return this.isSupported()?this.isEnabled?!0:(this.isEnabled=!0,this.lastInteraction=Date.now(),this.visibilityHandler||(this.visibilityHandler=()=>{!document.hidden&&this.isEnabled&&!this.wakeLock&&this.requestWakeLock()},document.addEventListener("visibilitychange",this.visibilityHandler)),this.startIdleTracking(),this.requestWakeLock()):!1}async disable(){this.isEnabled=!1,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.stopIdleTracking(),await this.releaseWakeLock()}resetIdleTimer(){this.lastInteraction=Date.now(),this.isEnabled&&!this.wakeLock&&this.requestWakeLock()}startIdleTracking(){this.interactionHandler||(this.interactionHandler=()=>this.resetIdleTimer(),document.addEventListener("touchstart",this.interactionHandler,{passive:!0}),document.addEventListener("mousedown",this.interactionHandler),document.addEventListener("keydown",this.interactionHandler)),this.idleCheckInterval===null&&(this.idleCheckInterval=setInterval(()=>this.checkIdle(),mr))}stopIdleTracking(){this.interactionHandler&&(document.removeEventListener("touchstart",this.interactionHandler),document.removeEventListener("mousedown",this.interactionHandler),document.removeEventListener("keydown",this.interactionHandler),this.interactionHandler=null),this.idleCheckInterval!==null&&(clearInterval(this.idleCheckInterval),this.idleCheckInterval=null)}checkIdle(){if(!this.isEnabled)return;if(Date.now()-this.lastInteraction>=pr&&this.wakeLock){d.debug("[WakeLock] Idle timeout reached, releasing wake lock"),this.releaseWakeLock();const t=l.getState().currentLang;N(p("wakeLockIdleTimeout",t),"warning",5e3)}}async requestWakeLock(){if(!this.isSupported()||this.wakeLock)return!!this.wakeLock;if(A.isCriticalBattery())return d.debug("[WakeLock] Critical battery, skipping wake lock request"),!1;try{return this.wakeLock=await navigator.wakeLock.request("screen"),this.wakeLock.addEventListener("release",()=>{this.wakeLock=null}),!0}catch(e){const t=e instanceof Error?e.message:"Unknown error";if(d.warn("Wake Lock request failed:",t),this.wakeLock=null,!this.hasShownFailureToast){this.hasShownFailureToast=!0;const i=l.getState().currentLang;N(p("wakeLockFailed",i),"warning",2e3)}return!1}}async releaseWakeLock(){if(this.wakeLock){try{await this.wakeLock.release()}catch(e){d.warn("Wake Lock release error:",e)}this.wakeLock=null}}isActive(){return this.wakeLock!==null}isWakeLockEnabled(){return this.isEnabled}}const Va=new yr,Be=new Map;function Ga(n){return Be.has(n)||Be.set(n,document.getElementById(n)),Be.get(n)}function tt(n=18){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`}function vr(n=14){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="9" y1="11" x2="9" y2="17"/><line x1="15" y1="11" x2="15" y2="17"/></svg>`}function nt(n=18){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`}function Ge(n=16,e=2.5){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${e}"><path d="M20 6L9 17l-5-5"/></svg>`}function br(n=16,e=2){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${e}"><path d="M18 6L6 18M6 6l12 12"/></svg>`}function Ua(n=16,e=!1){return`<svg class="group-chevron" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true" style="flex-shrink: 0; transition: transform 0.2s; ${e?"transform: rotate(90deg);":""}"><path d="M9 18l6-6-6-6"/></svg>`}function Sr(n=12){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>`}function Er(n=18){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>`}function Yt(n=12){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 9v4M12 17h.01"/><circle cx="12" cy="12" r="10"/></svg>`}function wr(n=14){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`}function Ja(n=16){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2v6l4 4-4 4v6h12v-6l-4-4 4-4V2H6z"/></svg>`}function ja(n){return`<button class="${n.className||"result-edit-btn"}" aria-label="${w(n.ariaLabel)}" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; opacity: 0.7;">${nt(n.size||18)}</button>`}function qa(n){return`<button class="${n.className||"result-delete"}" aria-label="${w(n.ariaLabel)}" style="background: none; border: none; color: var(--error); padding: 6px; cursor: pointer; opacity: 0.7;">${tt(n.size||18)}</button>`}function Qa(n){return`<button class="result-photo-btn" aria-label="${w(n)}" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">${Er()}</button>`}function Wa(n){return`<span class="result-duplicate-badge" title="${w(p("multiDeviceDuplicate",n))}" aria-label="${w(p("multiDeviceDuplicate",n))}">${Sr()} ${P(p("multiDeviceDuplicate",n))}</span>`}function Ya(n){var r;const{faults:e,lang:t}=n;if(e.length===0)return"";const i=e.map(a=>`T${a.gateNumber} (${Ze(a.faultType,t)})`).join(", "),s=e.length>1?`${e.length}× ${p("flt",t)}`:`T${((r=e[0])==null?void 0:r.gateNumber)||"?"}`;return`<span class="result-fault-badge" title="${w(i)}" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">${P(s)}</span>`}const Ir={dns:"#8899aa",dnf:"#ffd700",dsq:"#ff4757",flt:"#ffd700"};function Ka(n,e="",t="0.65rem"){return`<span class="result-status" style="--item-color: ${Ir[n.toLowerCase()]||e||"#ef4444"}; font-size: ${t};">${P(n)}</span>`}function Za(n="0.7rem"){return`<span class="deletion-pending-status" style="display: flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: var(--radius); font-size: ${n}; font-weight: 600; background: var(--error); color: white;">${Yt()} DEL</span>`}function Xa(n,e){return`<span class="result-run" data-advanced style="--item-color: ${e};">${P(n)}</span>`}function eo(n,e){return`<div class="result-point" style="--item-color: ${e};">${P(n)}</div>`}const _e=0,Tr=1,Cr=3,Rr=7;class to{constructor(e){c(this,"container");c(this,"timeElement");c(this,"dateElement");c(this,"dateRow");c(this,"lastTimeStr","");c(this,"animationId",null);c(this,"isRunning",!1);c(this,"visibilityHandler",null);c(this,"frameSkipCount",_e);c(this,"currentFrame",0);c(this,"batteryUnsubscribe",null);c(this,"isDestroyed",!1);c(this,"cachedDigits",[]);c(this,"tickCallbacks",new Set);c(this,"tick",()=>{if(this.isRunning)try{if(this.currentFrame++,this.frameSkipCount===0||this.currentFrame%(this.frameSkipCount+1)===0){const t=new Date,i=As(t);if(i!==this.lastTimeStr&&(this.updateDigits(i),this.lastTimeStr=i,this.tickCallbacks.size>0)){const r=i.substring(0,2),a=i.substring(3,5),o=i.substring(6,8),u=i.substring(9,12);for(const h of this.tickCallbacks)try{h(r,a,o,u)}catch(g){d.error("Clock tick callback error:",g)}}if(t.getSeconds()===0||!this.dateElement.textContent){const r=l.getState();this.dateElement.textContent=Ds(t,r.currentLang)}}this.animationId=requestAnimationFrame(this.tick)}catch(e){if(d.error("Clock tick error:",e),this.animationId===null)try{this.animationId=requestAnimationFrame(this.tick)}catch(t){d.error("Clock RAF scheduling failed:",t),setTimeout(()=>{this.isRunning&&this.animationId===null&&this.tick()},16)}}});this.container=e,this.container.innerHTML="",this.timeElement=this.createTimeElement(),this.dateRow=this.createDateRow(),this.dateElement=this.dateRow.querySelector(".clock-date"),this.container.appendChild(this.timeElement),this.container.appendChild(this.dateRow),this.cachedDigits=Array.from(this.timeElement.querySelectorAll(".clock-digit")),this.moveTimingPointsToDateRow()}moveTimingPointsToDateRow(){const e=document.querySelector(".timing-controls");e&&this.dateRow&&this.dateRow.appendChild(e)}createTimeElement(){const e=document.createElement("div");e.className="clock-time",e.setAttribute("role","timer"),e.setAttribute("aria-live","polite");const t=l.getState().currentLang;e.setAttribute("aria-label",p("currentTime",t));for(let i=0;i<12;i++){const s=document.createElement("span");s.className="clock-digit",s.dataset.index=String(i),e.appendChild(s)}return e}createDateRow(){const e=document.createElement("div");e.className="clock-date-row";const t=document.createElement("div");return t.className="clock-date",e.appendChild(t),e}start(){this.isRunning||(this.isRunning=!0,this.tick(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null):this.isRunning&&this.animationId===null&&this.tick()},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)),this.batteryUnsubscribe||A.initialize().then(()=>{this.batteryUnsubscribe=A.subscribe(e=>{this.updateFrameSkipFromBattery(e.batteryLevel)})}).catch(e=>d.debug("Battery API unavailable:",e)))}updateFrameSkipFromBattery(e){switch(e){case"critical":this.frameSkipCount=Rr;break;case"low":this.frameSkipCount=Cr;break;case"medium":this.frameSkipCount=Tr;break;default:this.frameSkipCount=_e}}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null)}updateDigits(e){for(let t=0;t<e.length&&t<this.cachedDigits.length;t++){const i=this.cachedDigits[t],s=e[t];i.textContent!==s&&(i.textContent=s,this.frameSkipCount===_e&&!document.hidden&&t<9&&(i.classList.remove("digit-pop"),i.offsetWidth,i.classList.add("digit-pop")))}}getCurrentTime(){return this.lastTimeStr}getTimestamp(){const e=ts.getTimestamp();return e?new Date(e):new Date}onTick(e){return this.tickCallbacks.add(e),()=>{this.tickCallbacks.delete(e)}}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.stop(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.tickCallbacks.clear(),this.container.innerHTML="")}}class it{constructor(){c(this,"listeners",[])}add(e,t,i,s){e.addEventListener(t,i,s),this.listeners.push([e,t,i,s])}removeAll(){for(const[e,t,i,s]of this.listeners)e.removeEventListener(t,i,s);this.listeners=[]}get count(){return this.listeners.length}}const we=80,Nt=2.5;class no{constructor(e){c(this,"container");c(this,"indicator");c(this,"styleElement",null);c(this,"onRefresh");c(this,"startY",0);c(this,"currentY",0);c(this,"isPulling",!1);c(this,"isRefreshing",!1);c(this,"scrollableParent",null);c(this,"listeners",new it);c(this,"onTouchStart",e=>{var i;this.isRefreshing||(((i=this.scrollableParent)==null?void 0:i.scrollTop)??0)>0||(this.startY=e.touches[0].clientY,this.isPulling=!0)});c(this,"onTouchMove",e=>{var t;if(!(!this.isPulling||this.isRefreshing))try{if((((t=this.scrollableParent)==null?void 0:t.scrollTop)??0)>0){this.isPulling=!1;return}this.currentY=e.touches[0].clientY;const s=(this.currentY-this.startY)/Nt;s>0&&(e.preventDefault(),this.updateIndicator(s))}catch(i){d.error("PullToRefresh move error:",i),this.isPulling=!1,this.resetIndicator()}});c(this,"onTouchEnd",async()=>{if(!this.isPulling||this.isRefreshing)return;const e=(this.currentY-this.startY)/Nt;this.isPulling=!1,e>=we?(this.isRefreshing=!0,await this.triggerRefresh()):this.resetIndicator()});this.container=e.container,this.onRefresh=e.onRefresh,this.indicator=this.createIndicator(),this.container.insertBefore(this.indicator,this.container.firstChild),this.scrollableParent=e.scrollElement??this.findScrollableParent(this.container)??this.findScrollableChild(this.container),this.bindEvents()}createIndicator(){const e=document.createElement("div");e.className="pull-indicator",e.style.cssText=`
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: transform 0.2s;
      pointer-events: none;
      z-index: 100;
    `;const t=l.getState().currentLang;return e.innerHTML=`
      <div class="pull-indicator-content" style="display: flex; align-items: center; gap: 8px;">
        <svg class="pull-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
        <span class="pull-text">${p("pullToRefresh",t)}</span>
      </div>
      <div class="pull-spinner" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      </div>
    `,this.styleElement=document.createElement("style"),this.styleElement.textContent=`
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(this.styleElement),e}findScrollableParent(e){let t=e.parentElement;for(;t;){const i=getComputedStyle(t);if(i.overflowY==="auto"||i.overflowY==="scroll")return t;t=t.parentElement}return null}findScrollableChild(e){const t=e.querySelectorAll("*");for(const i of t)if(i instanceof HTMLElement){const s=getComputedStyle(i);if(s.overflowY==="auto"||s.overflowY==="scroll")return i}return null}bindEvents(){this.listeners.add(this.container,"touchstart",this.onTouchStart,{passive:!0}),this.listeners.add(this.container,"touchmove",this.onTouchMove,{passive:!1}),this.listeners.add(this.container,"touchend",this.onTouchEnd,{passive:!0})}updateIndicator(e){const t=Math.min(e,we*1.5);this.indicator.style.transform=`translateY(${t}px)`;const i=Math.min(e/we,1),s=this.indicator.querySelector(".pull-icon"),r=this.indicator.querySelector(".pull-text");if(s&&(s.style.transform=`rotate(${i*180}deg)`),r){const a=l.getState().currentLang;r.textContent=i>=1?p("releaseToRefresh",a):p("pullToRefresh",a)}}async triggerRefresh(){const e=this.indicator.querySelector(".pull-indicator-content"),t=this.indicator.querySelector(".pull-spinner");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.indicator.style.transform=`translateY(${we}px)`;try{await this.onRefresh()}catch(i){d.error("PullToRefresh callback error:",i)}finally{this.isRefreshing=!1,e&&(e.style.display="flex"),t&&(t.style.display="none"),this.resetIndicator()}}resetIndicator(){this.indicator.style.transform="translateY(0)";const e=this.indicator.querySelector(".pull-icon");e&&(e.style.transform="rotate(0deg)")}destroy(){this.isRefreshing=!1,this.isPulling=!1,this.listeners.removeAll(),this.indicator.remove(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}}const ne=64,Ar=.35;class io{constructor(e){c(this,"element");c(this,"wrapper");c(this,"leftAction");c(this,"rightAction");c(this,"options");c(this,"startX",0);c(this,"startY",0);c(this,"currentX",0);c(this,"startTime",0);c(this,"isHorizontalSwipe",null);c(this,"pointerId",null);c(this,"suppressClickUntil",0);c(this,"pendingActionTimeoutId",null);c(this,"usePointerEvents",typeof window<"u"&&"PointerEvent"in window);c(this,"listeners",new it);c(this,"onTouchStart",e=>{this.startGesture(e.touches[0].clientX,e.touches[0].clientY)});c(this,"onTouchMove",e=>{this.moveGesture(e.touches[0].clientX,e.touches[0].clientY,e)});c(this,"onTouchEnd",()=>{this.endGesture()});c(this,"onTouchCancel",()=>{this.pendingActionTimeoutId!==null&&(clearTimeout(this.pendingActionTimeoutId),this.pendingActionTimeoutId=null),this.reset()});c(this,"onPointerDown",e=>{var t,i;e.pointerType==="mouse"&&e.button!==0||(this.pointerId=e.pointerId,(i=(t=this.wrapper).setPointerCapture)==null||i.call(t,e.pointerId),this.startGesture(e.clientX,e.clientY))});c(this,"onPointerMove",e=>{this.pointerId===e.pointerId&&this.moveGesture(e.clientX,e.clientY,e)});c(this,"onPointerUp",e=>{var t,i;this.pointerId===e.pointerId&&(this.pointerId=null,(i=(t=this.wrapper).hasPointerCapture)!=null&&i.call(t,e.pointerId)&&this.wrapper.releasePointerCapture(e.pointerId),this.endGesture())});c(this,"onPointerCancel",e=>{var t,i;this.pointerId===e.pointerId&&(this.pointerId=null,(i=(t=this.wrapper).hasPointerCapture)!=null&&i.call(t,e.pointerId)&&this.wrapper.releasePointerCapture(e.pointerId),this.pendingActionTimeoutId!==null&&(clearTimeout(this.pendingActionTimeoutId),this.pendingActionTimeoutId=null),this.reset())});c(this,"onClickCapture",e=>{Date.now()<this.suppressClickUntil&&(e.preventDefault(),e.stopPropagation())});this.options=e,this.element=e.element,this.wrapper=this.createWrapper(),this.leftAction=this.createLeftAction(),this.rightAction=this.createRightAction(),this.setupDOM(),this.bindEvents()}createWrapper(){const e=document.createElement("div");return e.className="swipe-content",e.style.cssText=`
      position: relative;
      height: 100%;
      transform: translateX(0);
      transition: transform 0.2s ease-out;
      background: inherit;
      z-index: 1;
      touch-action: pan-y;
      user-select: none;
      -webkit-user-select: none;
    `,e}createLeftAction(){const e=document.createElement("div");return e.className="swipe-action swipe-action-left",e.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: ${ne}px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      color: white;
      font-weight: 600;
      z-index: 0;
    `,e.innerHTML=this.options.leftContent||nt(24),e}createRightAction(){const e=document.createElement("div");return e.className="swipe-action swipe-action-right",e.style.cssText=`
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: ${ne}px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--error);
      color: white;
      font-weight: 600;
      z-index: 0;
    `,e.innerHTML=this.options.rightContent||tt(24),e}setupDOM(){const e=this.element.style;for(e.display&&(this.wrapper.style.display=e.display),e.alignItems&&(this.wrapper.style.alignItems=e.alignItems),e.justifyContent&&(this.wrapper.style.justifyContent=e.justifyContent),e.gap&&(this.wrapper.style.gap=e.gap),e.gridTemplateColumns&&(this.wrapper.style.gridTemplateColumns=e.gridTemplateColumns),e.gridTemplateRows&&(this.wrapper.style.gridTemplateRows=e.gridTemplateRows),e.gridTemplateAreas&&(this.wrapper.style.gridTemplateAreas=e.gridTemplateAreas),e.gridAutoFlow&&(this.wrapper.style.gridAutoFlow=e.gridAutoFlow),this.wrapper.style.width="100%",e.padding&&(this.wrapper.style.padding=e.padding,e.padding="0"),e.display&&(e.display="block"),e.gridTemplateColumns&&(e.gridTemplateColumns=""),e.gridTemplateRows&&(e.gridTemplateRows=""),e.gridTemplateAreas&&(e.gridTemplateAreas=""),e.gridAutoFlow&&(e.gridAutoFlow=""),e.gap&&(e.gap="");this.element.firstChild;)this.wrapper.appendChild(this.element.firstChild);const t=this.element.style.position;(!t||t==="static")&&(this.element.style.position="relative"),this.element.style.overflow="hidden",this.element.appendChild(this.leftAction),this.element.appendChild(this.rightAction),this.element.appendChild(this.wrapper)}bindEvents(){this.usePointerEvents?(this.listeners.add(this.wrapper,"pointerdown",this.onPointerDown,{passive:!0}),this.listeners.add(this.wrapper,"pointermove",this.onPointerMove,{passive:!1}),this.listeners.add(this.wrapper,"pointerup",this.onPointerUp,{passive:!0}),this.listeners.add(this.wrapper,"pointercancel",this.onPointerCancel,{passive:!0})):(this.listeners.add(this.wrapper,"touchstart",this.onTouchStart,{passive:!0}),this.listeners.add(this.wrapper,"touchmove",this.onTouchMove,{passive:!1}),this.listeners.add(this.wrapper,"touchend",this.onTouchEnd,{passive:!0}),this.listeners.add(this.wrapper,"touchcancel",this.onTouchCancel,{passive:!0})),this.listeners.add(this.wrapper,"click",this.onClickCapture,{capture:!0})}startGesture(e,t){this.startX=e,this.startY=t,this.currentX=0,this.startTime=Date.now(),this.isHorizontalSwipe=null,this.wrapper.style.transition="none"}moveGesture(e,t,i){const s=e-this.startX,r=t-this.startY;if(this.isHorizontalSwipe===null&&(Math.abs(s)>10||Math.abs(r)>10)&&(this.isHorizontalSwipe=Math.abs(s)>Math.abs(r)),!this.isHorizontalSwipe)return;i.preventDefault();const a=ne*1.2;this.currentX=Math.max(-a,Math.min(a,s)),this.wrapper.style.transform=`translateX(${this.currentX}px)`}endGesture(){if(!this.isHorizontalSwipe){this.wrapper.style.transition="transform 0.2s ease-out";return}const e=Math.max(Date.now()-this.startTime,1),t=Math.abs(this.currentX)/e,i=Math.abs(this.currentX)>=24&&t>Ar;this.wrapper.style.transition="transform 0.2s ease-out",Math.abs(this.currentX)>10&&(this.suppressClickUntil=Date.now()+300),this.pendingActionTimeoutId!==null&&(clearTimeout(this.pendingActionTimeoutId),this.pendingActionTimeoutId=null),Math.abs(this.currentX)>=ne||i?this.currentX<0&&this.options.onSwipeLeft?(this.wrapper.style.transform=`translateX(-${ne}px)`,this.pendingActionTimeoutId=window.setTimeout(()=>{var s,r;this.pendingActionTimeoutId=null,(r=(s=this.options).onSwipeLeft)==null||r.call(s),this.reset()},200)):this.currentX>0&&this.options.onSwipeRight?(this.wrapper.style.transform=`translateX(${ne}px)`,this.pendingActionTimeoutId=window.setTimeout(()=>{var s,r;this.pendingActionTimeoutId=null,(r=(s=this.options).onSwipeRight)==null||r.call(s),this.reset()},200)):this.reset():this.reset()}reset(){this.wrapper.style.transition="transform 0.2s ease-out",this.wrapper.style.transform="translateX(0)",this.currentX=0}destroy(){for(this.pendingActionTimeoutId!==null&&(clearTimeout(this.pendingActionTimeoutId),this.pendingActionTimeoutId=null),this.listeners.removeAll();this.wrapper.firstChild;)this.element.appendChild(this.wrapper.firstChild);this.wrapper.remove(),this.leftAction.remove(),this.rightAction.remove()}}const Dr=3e3,Pr=1e3,kr=5;class Lr{constructor(){c(this,"container");c(this,"queue",[]);c(this,"isShowing",!1);c(this,"toastEventListener");c(this,"lastCopyTime",0);c(this,"isDestroyed",!1);this.container=this.createContainer(),document.body.appendChild(this.container),this.toastEventListener=(e=>{this.show(e.detail.message,{type:e.detail.type,duration:e.detail.duration})}),window.addEventListener("show-toast",this.toastEventListener)}createContainer(){const e=document.createElement("div");return e.id="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e}show(e,t={}){for(;this.queue.length>=kr;){const i=this.queue.findIndex(s=>!s.options.action);if(i>=0)this.queue.splice(i,1);else break}this.queue.push({message:e,options:t}),this.isShowing||this.processQueue()}processQueue(){if(this.queue.length===0){this.isShowing=!1;return}this.isShowing=!0;const{message:e,options:t}=this.queue.shift(),i=t.duration||Dr,s=t.type||"info",r=this.createToast(e,s,t.action);this.container.appendChild(r),requestAnimationFrame(()=>{r.style.opacity="1",r.style.transform="translateY(0)"});let a=!1;const o=()=>{a||(a=!0,r.style.opacity="0",r.style.transform="translateY(10px)",setTimeout(()=>{r.remove(),this.processQueue()},200))};r._dismiss=o,setTimeout(o,i)}createToast(e,t,i){const s=document.createElement("div");s.className=`toast toast-${t}`;const r={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--primary)"},a={success:'<path d="M20 6L9 17l-5-5"/>',error:'<path d="M18 6L6 18M6 6l12 12"/>',warning:'<path d="M12 9v4M12 17h.01"/>',info:'<path d="M12 16v-4M12 8h.01"/>'};if(s.style.borderInlineStartColor=r[t],s.innerHTML=`<svg aria-hidden="true" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${r[t]}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/>${a[t]}</svg><span>${P(e)}</span>`,i){const o=document.createElement("button");o.textContent=i.label,o.className="toast-action-btn",o.style.borderColor=r[t],o.style.color=r[t],o.addEventListener("click",u=>{u.stopPropagation(),u.preventDefault(),i.callback();const h=s._dismiss;h&&h()}),s.appendChild(o)}else s.addEventListener("click",o=>{o.stopPropagation(),o.preventDefault(),this.copyToClipboard(e)});return s.addEventListener("mousedown",o=>o.stopPropagation()),s.addEventListener("touchstart",o=>o.stopPropagation(),{passive:!0}),s}async copyToClipboard(e){const t=Date.now(),i=t-this.lastCopyTime>Pr;this.lastCopyTime=t;try{await navigator.clipboard.writeText(e),i&&this.show(p("copied",l.getState().currentLang),{type:"success",duration:1500})}catch{}}clear(){this.queue=[],this.container.innerHTML="",this.isShowing=!1}destroy(){this.isDestroyed||(this.isDestroyed=!0,window.removeEventListener("show-toast",this.toastEventListener),this.clear(),this.container.remove())}}let oe=null;function Kt(){return oe||(oe=new Lr),oe}function N(n,e="info",t,i){Kt().show(n,{type:e,duration:t,action:i==null?void 0:i.action})}function so(){Kt().clear()}function ro(){oe&&(oe.destroy(),oe=null)}function Fr(n){const e=new Date(n);let t=e.getHours(),i=e.getMinutes(),s=e.getSeconds(),r=Math.round(e.getMilliseconds()/10),a=!1;return r>=100&&(r=0,s++,s>=60&&(s=0,i++),i>=60&&(i=0,t++),t>=24&&(t=0,a=!0)),{time:`${String(t).padStart(2,"0")}:${String(i).padStart(2,"0")}:${String(s).padStart(2,"0")},${String(r).padStart(2,"0")}`,dateRollover:a}}function B(n){const e=["=","+","-","@","|","	","\r",`
`];let t=n,i=!1;return e.some(s=>t.startsWith(s))&&(t=`'${t}`,i=!0),/^[+]?0x/i.test(t)&&(t=`'${t}`,i=!0),t.includes('"')&&(t=t.replace(/"/g,'""')),(i||t.includes(";")||t.includes('"')||t.includes(`
`)||t.includes("\r")||t.includes("	")||t.includes("|"))&&(t=`"${t}"`),t}function Nr(n,e=!1){const t=new Date(n);e&&t.setDate(t.getDate()+1);const i=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${i}-${s}-${r}`}function Mr(n){return n==="S"?"ST":"FT"}function $e(n,e){var i;return((i={ok:{en:"OK",de:"OK",fr:"OK"},dns:{en:"DNS",de:"DNS",fr:"DNS"},dnf:{en:"DNF",de:"DNF",fr:"DNF"},dsq:{en:"DSQ",de:"DSQ",fr:"DSQ"},flt:{en:"FLT",de:"SZT",fr:"PEN"}}[n])==null?void 0:i[e])||n.toUpperCase()}function Br(n){return n.length===0?"":n.sort((e,t)=>e.gateNumber-t.gateNumber).map(e=>`T${e.gateNumber}(${e.faultType})`).join("+")}function _r(){const n=l.getState(),e=n.entries,t=n.faultEntries,i=n.currentLang;if(e.length===0){N(p("noEntries",i),"warning");return}try{const s=[...e].sort((v,C)=>new Date(v.timestamp).getTime()-new Date(C.timestamp).getTime()),r=t.length>0,a=r?"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Torstrafzeit;Torfehler;Datum":"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Datum",o=s.map(v=>{const C=B(v.bib),F=v.run??1,k=Mr(v.point),{time:_,dateRollover:I}=Fr(v.timestamp),D=B(v.deviceName||v.deviceId),R=B(Nr(v.timestamp,I)),M=v.point==="F"?t.filter(ee=>ee.bib===v.bib&&ee.run===F):[];let X;if(v.point==="F"&&M.length>0?X=n.usePenaltyMode?$e("flt",i):$e("dsq",i):X=$e(v.status,i),r){const ee=M.length>0&&n.usePenaltyMode?M.length*n.penaltySeconds:0,en=Br(M);return`${C};${B(String(F))};${B(k)};${B(_)};${B(X)};${D};${B(String(ee))};${B(en)};${R}`}else return`${C};${B(String(F))};${B(k)};${B(_)};${B(X)};${D};${R}`}),u=[a,...o].join(`
`),h=new Blob(["\uFEFF"+u],{type:"text/csv;charset=utf-8;"}),g=URL.createObjectURL(h),f=document.createElement("a");f.href=g;const m=new Date().toISOString().split("T")[0],T=n.raceId||"race";f.download=`${T}_${m}.csv`,document.body.appendChild(f),f.click(),document.body.removeChild(f),URL.revokeObjectURL(g),pe(),N(p("exported",i),"success")}catch(s){d.error("CSV export failed:",s),N(p("operationFailed",i),"error")}}function Ue(n,e="csv"){const t=new Date().toISOString().split("T")[0];return`${n.replace(/[^a-zA-Z0-9-_]/g,"_")||"race"}_${t}.${e}`}function $r(){const n=l.getState(),e=n.currentLang,t=n.faultEntries,i=n.raceId||"RACE";if(t.length===0){N(p("noFaultsToExport",e),"warning");return}const s=new Map;for(const f of t){const m=`${f.bib}-${f.run}`;s.has(m)||s.set(m,[]),s.get(m).push(f)}const r=[];r.push(`📋 ${p("gateFaults",e)} - ${i}`),r.push("");const a=Array.from(s.entries()).filter(([f])=>f.endsWith("-1")),o=Array.from(s.entries()).filter(([f])=>f.endsWith("-2")),u=(f,m)=>{const[T]=f.split("-"),v=T.padStart(3,"0"),C=m.sort((k,_)=>k.gateNumber-_.gateNumber).map(k=>`T${k.gateNumber}`).join("+"),F=m.map(k=>k.faultType).join(", ");if(n.usePenaltyMode){const k=m.length*n.penaltySeconds;return`#${v}: ${C} (${F}) → +${k}s`}else return`#${v}: ${C} (${F})`};a.length>0&&(r.push(`🏁 ${p("runLabel",e)} 1:`),n.usePenaltyMode?r.push(`🟡 ${p("penaltyLabel",e)}:`):r.push(`🔴 ${p("dsq",e)}:`),a.sort((f,m)=>parseInt(f[0].split("-")[0],10)-parseInt(m[0].split("-")[0],10)).forEach(([f,m])=>{r.push(u(f,m))}),r.push("")),o.length>0&&(r.push(`🏁 ${p("runLabel",e)} 2:`),n.usePenaltyMode?r.push(`🟡 ${p("penaltyLabel",e)}:`):r.push(`🔴 ${p("dsq",e)}:`),o.sort((f,m)=>parseInt(f[0].split("-")[0],10)-parseInt(m[0].split("-")[0],10)).forEach(([f,m])=>{r.push(u(f,m))}),r.push(""));const h=new Date;r.push(`📅 ${h.toLocaleDateString(Q(e))} ${h.toLocaleTimeString(Q(e),{hour:"2-digit",minute:"2-digit"})}`);const g=r.join(`
`);navigator.clipboard?navigator.clipboard.writeText(g).then(()=>{pe(),N(p("copiedToClipboard",e),"success")}).catch(()=>{Je(g,Ue(`${i}_WhatsApp`,"txt"))}):Je(g,Ue(`${i}_WhatsApp`,"txt"))}function xr(){const n=l.getState(),e=n.currentLang,t=n.faultEntries,i=n.raceId||"RACE";if(t.length===0){N(p("noFaultsToExport",e),"warning");return}const s=new Map;for(const f of t){const m=`${f.bib}-${f.run}`;s.has(m)||s.set(m,[]),s.get(m).push(f)}const r=[],a="══════════════════════════════════════════════════════",o=Array.from(s.entries()).filter(([f])=>f.endsWith("-1")),u=Array.from(s.entries()).filter(([f])=>f.endsWith("-2")),h=(f,m)=>{f.length!==0&&(r.push(`${p("faultSummaryTitle",e)} - ${p("runLabel",e)} ${m}`),r.push(a),r.push(`${p("bib",e).substring(0,7).padEnd(7)} │ ${p("faults",e).padEnd(16)} │ ${p("penalty",e).padStart(9)} │ Status`),r.push("────────┼──────────────────┼───────────┼────────"),f.sort((T,v)=>parseInt(T[0].split("-")[0],10)-parseInt(v[0].split("-")[0],10)).forEach(([T,v])=>{const[C]=T.split("-"),F=C.padStart(5),k=v.sort((D,R)=>D.gateNumber-R.gateNumber).map(D=>`T${D.gateNumber}(${D.faultType})`).join(", ").padEnd(16);let _,I;n.usePenaltyMode?(_=`${v.length*n.penaltySeconds} ${p("sec",e)}`.padStart(9),I=p("flt",e)):(_="-".padStart(9),I=p("dsq",e)),r.push(`  ${F}   │ ${k} │ ${_} │ ${I}`)}),r.push(""))};r.push(`${i} - ${new Date().toLocaleDateString(Q(e))}`),r.push(""),h(o,1),h(u,2),r.push(a),r.push(`${p("generated",e)}: ${new Date().toLocaleString(Q(e))}`);const g=r.join(`
`);Je(g,Ue(`${i}_${p("summary",e)}`,"txt")),pe(),N(p("exported",e),"success")}function Je(n,e){const t=new Blob([n],{type:"text/plain;charset=utf-8;"}),i=URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}const V=new it,je=[];let Te=null;async function Or(n){return new Promise(e=>{Te=e,window.dispatchEvent(new CustomEvent("request-pin-verification",{detail:{lang:n}}))})}function zr(n){Te&&(Te(n),Te=null)}function Hr(n){window.dispatchEvent(new CustomEvent("open-fault-edit-modal",{detail:{fault:n}}))}function Vr(n){window.dispatchEvent(new CustomEvent("open-mark-deletion-modal",{detail:{fault:n}}))}function Gr(){window.dispatchEvent(new CustomEvent("update-inline-faults-list"))}function Mt(){window.dispatchEvent(new CustomEvent("update-inline-bib-selector"))}function Ur(){window.dispatchEvent(new CustomEvent("update-inline-gate-selector"))}function Jr(){Xt();const n=document.getElementById("chief-judge-toggle-btn");n&&(V.add(n,"click",async()=>{const e=l.getState(),t=e.currentLang;if(e.isChiefJudgeView){l.toggleChiefJudgeView(),Qe(),K(),N(p("chiefJudgeModeDisabled",t),"info");return}e.settings.sync&&e.raceId&&!await Or(t)||(l.toggleChiefJudgeView(),Qe(),K(),N(p("chiefJudgeModeEnabled",t),"info"))}),qe(),je.push(W(()=>{zi.value,be.value,qe()}),W(()=>{be.value,gt.value,pt.value,ft.value&&(ue(),ve())}),W(()=>{gt.value,pt.value,st()}),W(()=>{ht.value,be.value,Hi.value,ft.value&&rt()}),W(()=>{be.value,Fe.value==="gateJudge"&&(Gr(),Mt())}),W(()=>{ht.value,Fe.value==="gateJudge"&&Mt()}),W(()=>{Vi.value,Fe.value==="gateJudge"&&Ur()})),qr(),jr())}function jr(){const n=document.getElementById("export-csv-btn");n&&V.add(n,"click",()=>{K(),_r()});const e=document.getElementById("export-summary-btn");e&&V.add(e,"click",()=>{K(),xr()});const t=document.getElementById("export-whatsapp-btn");t&&V.add(t,"click",()=>{K(),$r()})}function qr(){const n=document.getElementById("penalty-mode-toggle");n&&V.add(n,"click",t=>{const i=t.target.closest(".penalty-mode-btn");if(!i)return;const s=i.getAttribute("data-mode");s==="penalty"?l.setUsePenaltyMode(!0):s==="dsq"&&l.setUsePenaltyMode(!1),K()});const e=document.getElementById("penalty-seconds-selector");e&&V.add(e,"click",t=>{const i=t.target.closest(".penalty-adj-btn");if(!i)return;const s=i.getAttribute("data-adj"),a=l.getState().penaltySeconds;s==="+1"?l.setPenaltySeconds(a+1):s==="-1"&&l.setPenaltySeconds(a-1),K()}),st()}function st(){const n=l.getState(),e=document.getElementById("penalty-config-row"),t=document.getElementById("penalty-seconds-value"),i=document.getElementById("penalty-mode-toggle");e&&e.classList.toggle("dsq-mode",!n.usePenaltyMode),t&&(t.textContent=String(n.penaltySeconds)),i&&i.querySelectorAll(".penalty-mode-btn").forEach(r=>{const a=r.getAttribute("data-mode"),o=a==="penalty"&&n.usePenaltyMode||a==="dsq"&&!n.usePenaltyMode;r.classList.toggle("active",o),r.setAttribute("aria-pressed",String(o))})}function qe(){const n=document.getElementById("chief-judge-toggle-row");if(!n)return;const t=l.getState().settings.sync;n.style.display=t?"block":"none"}function Qe(){const n=l.getState(),e=document.querySelector(".results-view"),t=document.getElementById("chief-judge-toggle-btn");!e||!t||(t.classList.toggle("active",n.isChiefJudgeView),t.setAttribute("aria-pressed",String(n.isChiefJudgeView)),e.classList.toggle("chief-mode",n.isChiefJudgeView),n.isChiefJudgeView&&(ue(),ve(),rt()))}function rt(){const n=document.getElementById("judges-overview-list"),e=document.getElementById("judges-overview-count"),t=document.getElementById("judges-overview-empty");if(!n||!e)return;const i=he.getOtherGateAssignments(),s=l.getState(),r=[...i];if(s.deviceRole==="gateJudge"&&s.gateAssignment&&r.push({deviceId:s.deviceId,deviceName:s.deviceName,gateStart:s.gateAssignment[0],gateEnd:s.gateAssignment[1],lastSeen:Date.now(),isReady:s.isJudgeReady}),e.textContent=String(r.length),t&&(t.style.display=r.length===0?"block":"none"),n.querySelectorAll(".judge-card").forEach(u=>u.remove()),r.length===0)return;r.sort((u,h)=>u.gateStart-h.gateStart);const o=r.map(u=>`
    <div class="judge-card${u.isReady?" ready":""}">
      <span class="judge-ready-indicator"></span>
      <span class="judge-name" title="${w(u.deviceName)}">${P(u.deviceName)}</span>
      <span class="judge-gates">${P(String(u.gateStart))}–${P(String(u.gateEnd))}</span>
    </div>
  `).join("");t?t.insertAdjacentHTML("beforebegin",o):n.innerHTML=o}function ue(){const n=document.getElementById("fault-summary-list"),e=document.getElementById("fault-summary-count"),t=document.getElementById("chief-empty-state");if(!n||!e)return;const i=l.getState(),s=i.currentLang,r=i.faultEntries,a=new Map;for(const g of r){const f=`${g.bib}-${g.run}`;a.has(f)||a.set(f,[]),a.get(f).push(g)}if(e.textContent=String(a.size),t&&(t.style.display=a.size===0?"flex":"none"),a.size===0){n.querySelectorAll(".fault-summary-card").forEach(f=>f.remove());return}const o=[],u=Array.from(a.entries()).sort((g,f)=>{const[m]=g,[T]=f,v=parseInt(m.split("-")[0],10)||0,C=parseInt(T.split("-")[0],10)||0;return v-C});for(const[g,f]of u){const[m,T]=g.split("-"),v=parseInt(T,10),C=l.isRacerFinalized(m,v),F=f.filter(R=>!R.markedForDeletion),k=i.usePenaltyMode?F.length*i.penaltySeconds:0,_=f.map(R=>{const M=R.markedForDeletion,X=M&&R.markedForDeletionBy?`${p("deletionPending",s)} (${R.markedForDeletionBy})`:"",ee=R.notes&&R.notes.length>0;return`
        <div class="fault-entry-row${M?" marked-for-deletion":""}" data-fault-id="${w(R.id)}">
          <div class="fault-gate-info">
            <span class="fault-gate-num${M?" strikethrough":""}">${p("gate",s)} ${P(String(R.gateNumber))}</span>
            <span class="fault-type-badge${M?" marked":""}">${Ze(R.faultType,s)}</span>
            ${ee?`<span class="fault-note-icon" title="${w(p("hasNote",s))}" aria-label="${w(p("hasNote",s))}">${wr(14)}</span>`:""}
            ${M?`<span class="deletion-pending-badge" title="${w(X)}">${Yt(14)}</span>`:""}
          </div>
          <span class="fault-judge-name">${P(R.deviceName)}</span>
          <div class="fault-row-actions">
            <button class="fault-row-btn edit-fault-btn" data-fault-id="${w(R.id)}" title="${w(p("edit",s))}" aria-label="${w(p("edit",s))}" ${M?"disabled":""}>
              ${nt(14)}
            </button>
            <button class="fault-row-btn delete-fault-btn" data-fault-id="${w(R.id)}" title="${w(p(M?"rejectDeletion":"markForDeletion",s))}" aria-label="${w(p(M?"rejectDeletion":"markForDeletion",s))}">
              ${M?vr(14):tt(14)}
            </button>
          </div>
        </div>
      `}).join(""),I=C?`<div class="finalized-badge">
           ${Ge(16,2.5)}
           ${p("finalized",s)}
         </div>`:`<button class="finalize-btn" data-bib="${w(m)}" data-run="${w(String(v))}">
           ${Ge(16)}
           ${p("finalize",s)}
         </button>`,D=i.usePenaltyMode?`<span class="fault-card-penalty">+${k}s</span>
         <span class="fault-card-result flt">${p("flt",s)}</span>`:`<span class="fault-card-result dsq">${p("dsq",s)}</span>`;o.push(`
      <div class="fault-summary-card${C?" finalized":""}" data-bib="${w(m)}" data-run="${w(String(v))}">
        <div class="fault-card-header">
          <span class="fault-card-bib">#${P(m.padStart(3,"0"))}</span>
          <div class="fault-card-status">
            ${D}
          </div>
        </div>
        <div class="fault-card-body">
          ${_}
        </div>
        <div class="fault-card-actions">
          ${I}
        </div>
      </div>
    `)}n.querySelectorAll(".fault-summary-card").forEach(g=>g.remove()),t?t.insertAdjacentHTML("beforebegin",o.join("")):n.innerHTML=o.join(""),Qr(n)}const fe=new Set;function Qr(n){fe.has(n)||(fe.add(n),V.add(n,"click",e=>{const t=e.target,i=t.closest(".finalize-btn");if(i){Kr(i);return}const s=t.closest(".edit-fault-btn");if(s){e.stopPropagation();const a=s.dataset.faultId;if(a){const o=l.getState().faultEntries.find(u=>u.id===a);o&&Hr(o)}return}const r=t.closest(".delete-fault-btn");if(r){e.stopPropagation();const a=r.dataset.faultId;if(a){const o=l.getState().faultEntries.find(u=>u.id===a);o&&(o.markedForDeletion?Zt(o):Vr(o))}}}))}function Wr(n,e){fe.has(n)||(fe.add(n),V.add(n,"click",t=>{const i=t.target,s=e(),r=i.closest(".pending-deletion-btn.approve");if(r){t.stopPropagation();const o=r.dataset.faultId;if(o){const u=s.find(h=>h.id===o);u&&Yr(u)}return}const a=i.closest(".pending-deletion-btn.reject");if(a){t.stopPropagation();const o=a.dataset.faultId;if(o){const u=s.find(h=>h.id===o);u&&Zt(u)}}}))}function Zt(n){if(l.rejectFaultDeletion(n.id)){const t=l.getState().faultEntries.find(s=>s.id===n.id);t&&dr(t).catch(()=>{});const i=l.getState().currentLang;N(p("deletionRejected",i),"success"),pe(),ue(),ve()}}function Yr(n){const e=l.approveFaultDeletion(n.id);if(e){hr(e).catch(()=>{});const t=l.getState().currentLang;N(p("deletionApproved",t),"success"),Wi(),ue(),ve()}}function ve(){const n=document.getElementById("pending-deletions-section"),e=document.getElementById("pending-deletions-list"),t=document.getElementById("pending-deletions-count");if(!n||!e||!t)return;const i=l.getPendingDeletions(),r=l.getState().currentLang;if(t.textContent=String(i.length),n.style.display=i.length>0?"block":"none",i.length===0){e.innerHTML="";return}const a=i.map(o=>{const u=o.markedForDeletionAt?new Date(o.markedForDeletionAt).toLocaleTimeString(Q(r),{hour:"2-digit",minute:"2-digit"}):"";return`
      <div class="pending-deletion-item" data-fault-id="${w(o.id)}">
        <div class="pending-deletion-info">
          <span class="pending-deletion-fault">
            #${P(o.bib.padStart(3,"0"))} T${P(String(o.gateNumber))} (${Ze(o.faultType,r)}) - ${p(o.run===1?"run1":"run2",r)}
          </span>
          <span class="pending-deletion-meta">
            ${p("deletionMarkedBy",r)}: ${P(o.markedForDeletionBy||"?")} (${P(u)})
          </span>
        </div>
        <div class="pending-deletion-actions">
          <button class="pending-deletion-btn approve" data-fault-id="${w(o.id)}" title="${w(p("approveDeletion",r))}" aria-label="${w(p("approveDeletion",r))}">
            ${Ge(16,2.5)}
          </button>
          <button class="pending-deletion-btn reject" data-fault-id="${w(o.id)}" title="${w(p("rejectDeletion",r))}" aria-label="${w(p("rejectDeletion",r))}">
            ${br(16)}
          </button>
        </div>
      </div>
    `}).join("");e.innerHTML=a,Wr(e,()=>l.getPendingDeletions())}function Kr(n){const e=n.dataset.bib,t=n.dataset.run;if(!e||!t)return;const i=parseInt(t,10);l.finalizeRacer(e,i),pe();const s=l.getState();N(`#${e.padStart(3,"0")} ${p("finalized",s.currentLang)}`,"success"),ue()}function Xt(){for(const n of je)n();je.length=0,V.removeAll(),fe.clear()}const ao=Object.freeze(Object.defineProperty({__proto__:null,cleanupChiefJudgeView:Xt,initChiefJudgeToggle:Jr,resolvePinVerification:zr,updateChiefJudgeToggleVisibility:qe,updateChiefJudgeView:Qe,updateFaultSummaryPanel:ue,updateJudgesOverview:rt,updatePenaltyConfigUI:st,updatePendingDeletionsPanel:ve},Symbol.toStringTag,{value:"Module"}));export{ht as $,Ua as A,Wa as B,Xa as C,Na as D,Ps as E,Ya as F,Ka as G,Qa as H,eo as I,ja as J,qa as K,it as L,Za as M,ea as N,ha as O,be as P,Bt as Q,De as R,io as S,Wi as T,no as U,_r as V,Ta as W,ka as X,U as Y,Es as Z,Da as _,N as a,La as a0,G as a1,Aa as a2,_a as a3,En as a4,xa as a5,y as a6,me as a7,Fs as a8,wa as a9,Vi as aA,da as aB,ga as aC,ya as aD,va as aE,ba as aF,xe as aG,$a as aH,Ja as aI,Pa as aJ,na as aK,Kt as aL,ao as aM,Ia as aa,ta as ab,to as ac,Sa as ad,Oa as ae,ts as af,pa as ag,fa as ah,sa as ai,aa as aj,la as ak,ua as al,ra as am,Me as an,Ra as ao,Va as ap,ma as aq,so as ar,ro as as,Ca as at,wt as au,zr as av,ca as aw,oa as ax,Fe as ay,Hi as az,Ze as b,dr as c,K as d,P as e,pe as f,Q as g,Ea as h,w as i,wr as j,tt as k,As as l,ia as m,hr as n,za as o,Ga as p,he as q,Ge as r,l as s,p as t,d as u,Ha as v,A as w,Fa as x,Ba as y,Ma as z};
