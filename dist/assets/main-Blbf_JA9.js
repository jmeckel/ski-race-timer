var he=Object.defineProperty;var me=(n,e,t)=>e in n?he(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var l=(n,e,t)=>me(n,typeof e!="symbol"?e+"":e,t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&s(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();function ge(n){const e=Date.now(),t=crypto.randomUUID().slice(0,8);return`${n}-${e}-${t}`}function pe(){return`dev_${crypto.randomUUID().slice(0,12)}`}const D=2,fe=["S","I1","I2","I3","F"],ye=["ok","dns","dnf","dsq"];function b(n){if(!n||typeof n!="object")return!1;const e=n;return!(typeof e.id!="string"&&typeof e.id!="number"||typeof e.id=="string"&&e.id.length===0||typeof e.id=="number"&&e.id<=0||e.bib!==void 0&&typeof e.bib!="string"||typeof e.bib=="string"&&e.bib.length>10||!fe.includes(e.point)||!e.timestamp||typeof e.timestamp!="string"||isNaN(Date.parse(e.timestamp))||e.status&&!ye.includes(e.status))}function ve(n){if(!n||typeof n!="object")return!1;const e=n;return!(!b(e.entry)||typeof e.retryCount!="number"||e.retryCount<0||typeof e.lastAttempt!="number"||e.lastAttempt<0)}function Se(n){return!n||typeof n!="string"||n.length>50?!1:/^[a-zA-Z0-9_-]+$/.test(n)}function Ee(n){return!n||typeof n!="string"?!1:n.startsWith("dev_")&&n.length>4}function L(n,e=100){return!n||typeof n!="string"?"":n.slice(0,e).replace(/[<>]/g,"")}function be(n,e){if(!b(n))return null;const t=n;return{id:(typeof t.id=="number",String(t.id)),bib:L(t.bib,10),point:t.point,timestamp:t.timestamp,status:t.status||"ok",deviceId:L(t.deviceId||e,50),deviceName:L(t.deviceName||"Unknown Device",100),syncedAt:t.syncedAt,photo:t.photo,gpsCoords:t.gpsCoords}}function Ie(n,e){const t={auto:!0,haptic:!0,sound:!1,sync:!1,gps:!1,simple:!0,photoCapture:!1};if(!n||typeof n!="object")return{version:D,entries:[],settings:t,deviceId:e,deviceName:"Timer 1",raceId:"",syncQueue:[]};const s=n;let i=[];Array.isArray(s.entries)&&(i=s.entries.map(c=>be(c,e)).filter(c=>c!==null));let o=t;if(s.settings&&typeof s.settings=="object"){const c=s.settings;o={auto:typeof c.auto=="boolean"?c.auto:t.auto,haptic:typeof c.haptic=="boolean"?c.haptic:t.haptic,sound:typeof c.sound=="boolean"?c.sound:t.sound,sync:typeof c.sync=="boolean"?c.sync:t.sync,gps:typeof c.gps=="boolean"?c.gps:t.gps,simple:typeof c.simple=="boolean"?c.simple:t.simple,photoCapture:typeof c.photoCapture=="boolean"?c.photoCapture:t.photoCapture}}let a=[];return Array.isArray(s.syncQueue)&&(a=s.syncQueue.filter(ve)),{version:D,entries:i,settings:o,deviceId:Ee(s.deviceId)?s.deviceId:e,deviceName:L(s.deviceName,100)||"Timer 1",raceId:Se(s.raceId)?s.raceId:"",syncQueue:a,lastExport:typeof s.lastExport=="number"?s.lastExport:void 0}}const p={ENTRIES:"skiTimerEntries",SETTINGS:"skiTimerSettings",LANG:"skiTimerLang",DEVICE_ID:"skiTimerDeviceId",DEVICE_NAME:"skiTimerDeviceName",RACE_ID:"skiTimerRaceId",SYNC_QUEUE:"skiTimerSyncQueue",SCHEMA_VERSION:"skiTimerSchemaVersion"},q={auto:!0,haptic:!0,sound:!1,sync:!1,gps:!1,simple:!0,photoCapture:!1},we=50;class Ce{constructor(){l(this,"state");l(this,"listeners",new Set);l(this,"saveTimeout",null);this.state=this.loadInitialState()}loadInitialState(){let e=localStorage.getItem(p.DEVICE_ID);e||(e=pe(),localStorage.setItem(p.DEVICE_ID,e));const t=localStorage.getItem(p.ENTRIES),s=localStorage.getItem(p.SETTINGS),i=localStorage.getItem(p.SYNC_QUEUE);let o=[],a=q,c=[];try{if(t){const u=JSON.parse(t);Array.isArray(u)&&(o=u.filter(ue=>b(ue)))}}catch(u){console.error("Failed to parse entries:",u)}try{if(s){const u=JSON.parse(s);a={...q,...u}}}catch(u){console.error("Failed to parse settings:",u)}try{if(i){const u=JSON.parse(i);Array.isArray(u)&&(c=u)}}catch(u){console.error("Failed to parse sync queue:",u)}const d=localStorage.getItem(p.LANG)||"de",h=localStorage.getItem(p.DEVICE_NAME)||"Timer 1",g=localStorage.getItem(p.RACE_ID)||"";return{currentView:"timer",currentLang:d,bibInput:"",selectedPoint:"F",selectMode:!1,selectedEntries:new Set,isRecording:!1,lastRecordedEntry:null,entries:o,undoStack:[],redoStack:[],settings:a,deviceId:e,deviceName:h,raceId:g,syncStatus:"disconnected",syncQueue:c,connectedDevices:new Map,gpsEnabled:a.gps,gpsAccuracy:null,gpsStatus:"inactive",cameraReady:!1,cameraError:null}}getState(){return this.state}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notify(e){this.listeners.forEach(t=>{try{t(this.state,e)}catch(s){console.error("State listener error:",s)}})}setState(e,t=!0){const s=Object.keys(e);this.state={...this.state,...e},this.notify(s),t&&this.scheduleSave()}scheduleSave(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveToStorage(),100)}saveToStorage(){try{localStorage.setItem(p.ENTRIES,JSON.stringify(this.state.entries)),localStorage.setItem(p.SETTINGS,JSON.stringify(this.state.settings)),localStorage.setItem(p.LANG,this.state.currentLang),localStorage.setItem(p.DEVICE_NAME,this.state.deviceName),localStorage.setItem(p.RACE_ID,this.state.raceId),localStorage.setItem(p.SYNC_QUEUE,JSON.stringify(this.state.syncQueue)),localStorage.setItem(p.SCHEMA_VERSION,String(D))}catch(e){console.error("Failed to save to storage:",e)}}pushUndo(e){const t=[...this.state.undoStack,e];t.length>we&&t.shift(),this.setState({undoStack:t,redoStack:[]},!1)}addEntry(e){const t=[...this.state.entries,e];this.pushUndo({type:"ADD_ENTRY",data:e,timestamp:Date.now()}),this.setState({entries:t,lastRecordedEntry:e,isRecording:!1}),this.state.settings.sync&&this.state.raceId&&this.addToSyncQueue(e)}deleteEntry(e){const t=this.state.entries.find(i=>i.id===e);if(!t)return;this.pushUndo({type:"DELETE_ENTRY",data:t,timestamp:Date.now()});const s=this.state.entries.filter(i=>i.id!==e);this.setState({entries:s})}deleteMultiple(e){const t=this.state.entries.filter(i=>e.includes(i.id));if(t.length===0)return;this.pushUndo({type:"DELETE_MULTIPLE",data:t,timestamp:Date.now()});const s=this.state.entries.filter(i=>!e.includes(i.id));this.setState({entries:s,selectMode:!1,selectedEntries:new Set})}clearAll(){this.state.entries.length!==0&&(this.pushUndo({type:"CLEAR_ALL",data:[...this.state.entries],timestamp:Date.now()}),this.setState({entries:[],selectMode:!1,selectedEntries:new Set}))}updateEntry(e,t){const s=this.state.entries.findIndex(c=>c.id===e);if(s===-1)return;const i=this.state.entries[s],o={...i,...t};this.pushUndo({type:"UPDATE_ENTRY",data:i,timestamp:Date.now()});const a=[...this.state.entries];a[s]=o,this.setState({entries:a})}canUndo(){return this.state.undoStack.length>0}canRedo(){return this.state.redoStack.length>0}undo(){if(!this.canUndo())return null;const e=[...this.state.undoStack],t=e.pop(),s=[...this.state.redoStack,t];let i=[...this.state.entries],o=null;switch(t.type){case"ADD_ENTRY":{const a=t.data;i=i.filter(c=>c.id!==a.id),o=a;break}case"DELETE_ENTRY":{const a=t.data;i.push(a),i.sort((c,d)=>new Date(c.timestamp).getTime()-new Date(d.timestamp).getTime()),o=a;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const a=t.data;i=[...i,...a],i.sort((c,d)=>new Date(c.timestamp).getTime()-new Date(d.timestamp).getTime()),o=a;break}case"UPDATE_ENTRY":{const a=t.data,c=i.findIndex(d=>d.id===a.id);c!==-1&&(i[c]=a),o=a;break}}return this.setState({entries:i,undoStack:e,redoStack:s}),o}redo(){if(!this.canRedo())return null;const e=[...this.state.redoStack],t=e.pop(),s=[...this.state.undoStack,t];let i=[...this.state.entries],o=null;switch(t.type){case"ADD_ENTRY":{const a=t.data;i.push(a),i.sort((c,d)=>new Date(c.timestamp).getTime()-new Date(d.timestamp).getTime()),o=a;break}case"DELETE_ENTRY":{const a=t.data;i=i.filter(c=>c.id!==a.id),o=a;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const a=t.data,c=new Set(a.map(d=>d.id));i=i.filter(d=>!c.has(d.id)),o=a;break}case"UPDATE_ENTRY":{const a=t.data,c=i.findIndex(d=>d.id===a.id);c!==-1&&(i[c]=a),o=a;break}}return this.setState({entries:i,undoStack:s,redoStack:e}),o}addToSyncQueue(e){const t={entry:e,retryCount:0,lastAttempt:0},s=[...this.state.syncQueue,t];this.setState({syncQueue:s})}removeFromSyncQueue(e){const t=this.state.syncQueue.filter(s=>s.entry.id!==e);this.setState({syncQueue:t})}updateSyncQueueItem(e,t){const s=this.state.syncQueue.map(i=>i.entry.id===e?{...i,...t}:i);this.setState({syncQueue:s})}clearSyncQueue(){this.setState({syncQueue:[]})}setView(e){this.setState({currentView:e},!1)}setLanguage(e){this.setState({currentLang:e})}setBibInput(e){const t=e.replace(/\D/g,"").slice(0,3);this.setState({bibInput:t},!1)}setSelectedPoint(e){this.setState({selectedPoint:e},!1)}setSelectMode(e){this.setState({selectMode:e,selectedEntries:e?this.state.selectedEntries:new Set},!1)}toggleEntrySelection(e){const t=new Set(this.state.selectedEntries);t.has(e)?t.delete(e):t.add(e),this.setState({selectedEntries:t,selectMode:t.size>0},!1)}selectAllEntries(){const e=new Set(this.state.entries.map(t=>t.id));this.setState({selectedEntries:e,selectMode:!0},!1)}clearSelection(){this.setState({selectedEntries:new Set,selectMode:!1},!1)}setRecording(e){this.setState({isRecording:e},!1)}updateSettings(e){const t={...this.state.settings,...e};this.setState({settings:t})}toggleSetting(e){const t={...this.state.settings};t[e]=!t[e],this.setState({settings:t})}setSyncStatus(e){this.setState({syncStatus:e},!1)}setRaceId(e){this.setState({raceId:e})}setDeviceName(e){this.setState({deviceName:e})}addConnectedDevice(e){const t=new Map(this.state.connectedDevices);t.set(e.id,e),this.setState({connectedDevices:t},!1)}removeConnectedDevice(e){const t=new Map(this.state.connectedDevices);t.delete(e),this.setState({connectedDevices:t},!1)}setGpsStatus(e,t){this.setState({gpsStatus:e,gpsAccuracy:t??null},!1)}setCameraReady(e,t){this.setState({cameraReady:e,cameraError:t??null},!1)}mergeCloudEntries(e){let t=0;const s=new Set(this.state.entries.map(o=>`${o.id}-${o.deviceId}`)),i=[];for(const o of e){if(!b(o)||o.deviceId===this.state.deviceId)continue;const a=`${o.id}-${o.deviceId}`;s.has(a)||(i.push(o),s.add(a),t++)}if(i.length>0){const o=[...this.state.entries,...i];o.sort((a,c)=>new Date(a.timestamp).getTime()-new Date(c.timestamp).getTime()),this.setState({entries:o})}return t}exportData(){return JSON.stringify({version:D,entries:this.state.entries,settings:this.state.settings,deviceId:this.state.deviceId,deviceName:this.state.deviceName,raceId:this.state.raceId,exportedAt:new Date().toISOString()},null,2)}importData(e){try{const t=JSON.parse(e),s=Ie(t,this.state.deviceId),i=new Set(this.state.entries.map(a=>a.id)),o=s.entries.filter(a=>!i.has(a.id));if(o.length>0){const a=[...this.state.entries,...o];a.sort((c,d)=>new Date(c.timestamp).getTime()-new Date(d.timestamp).getTime()),this.setState({entries:a})}return{success:!0,entriesImported:o.length}}catch(t){return{success:!1,entriesImported:0,error:String(t)}}}}const r=new Ce;function Z(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),s=String(n.getSeconds()).padStart(2,"0"),i=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${s}.${i}`}function Te(n,e="de"){const t={weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"};return n.toLocaleDateString(e==="de"?"de-DE":"en-US",t)}function Ae(n,e=3){return String(n).padStart(e,"0")}function T(n){const e=document.createElement("div");return e.textContent=String(n),e.innerHTML}function xe(n){return{S:"var(--success)",I1:"var(--primary)",I2:"var(--primary)",I3:"var(--primary)",F:"var(--secondary)"}[n]||"var(--text-secondary)"}function ke(n,e){let t;return(...s)=>{clearTimeout(t),t=setTimeout(()=>n(...s),e)}}const Le={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},De=.8,A=1280,x=720;class Pe{constructor(){l(this,"stream",null);l(this,"videoElement",null);l(this,"canvasElement",null);l(this,"isInitialized",!1)}async initialize(){if(this.isInitialized)return!0;try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not available");return this.videoElement=document.createElement("video"),this.videoElement.setAttribute("autoplay",""),this.videoElement.setAttribute("playsinline",""),this.videoElement.style.position="absolute",this.videoElement.style.left="-9999px",this.videoElement.style.top="-9999px",document.body.appendChild(this.videoElement),this.canvasElement=document.createElement("canvas"),this.canvasElement.width=A,this.canvasElement.height=x,this.stream=await navigator.mediaDevices.getUserMedia(Le),this.videoElement.srcObject=this.stream,await new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))}),this.isInitialized=!0,r.setCameraReady(!0),console.log("Camera initialized successfully"),!0}catch(e){const t=e instanceof Error?e.message:"Camera initialization failed";return console.error("Camera initialization error:",t),r.setCameraReady(!1,t),!1}}async capturePhoto(){if(!this.isInitialized||!this.videoElement||!this.canvasElement)return console.warn("Camera not initialized"),null;try{const e=this.canvasElement.getContext("2d");if(!e)throw new Error("Could not get canvas context");const t=this.videoElement.videoWidth,s=this.videoElement.videoHeight;let i=t,o=s;if(i>A){const h=A/i;i=A,o=Math.round(o*h)}if(o>x){const h=x/o;o=x,i=Math.round(i*h)}this.canvasElement.width=i,this.canvasElement.height=o,e.drawImage(this.videoElement,0,0,i,o);const a=new Date().toISOString();e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,o-30,i,30),e.fillStyle="#ffffff",e.font="14px monospace",e.fillText(a,10,o-10);const d=this.canvasElement.toDataURL("image/jpeg",De).split(",")[1];return console.log(`Photo captured: ${Math.round(d.length/1024)}KB`),d}catch(e){return console.error("Photo capture error:",e),null}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null,this.videoElement.remove(),this.videoElement=null),this.isInitialized=!1,r.setCameraReady(!1),console.log("Camera stopped")}isReady(){return this.isInitialized}getError(){return r.getState().cameraError}async toggle(e){return e?this.initialize():(this.stop(),!0)}}const S=new Pe;async function Re(){return!r.getState().settings.photoCapture||!S.isReady()&&!await S.initialize()?null:S.capturePhoto()}const $="/api/sync",F=5e3,V=3e4,Be=5,Me=2e3,Ne=1e4;class Oe{constructor(){l(this,"pollInterval",null);l(this,"queueInterval",null);l(this,"broadcastChannel",null);l(this,"consecutiveErrors",0);l(this,"lastSyncTimestamp",0);l(this,"isProcessingQueue",!1)}initialize(){const e=r.getState();if(!e.settings.sync||!e.raceId){this.cleanup();return}this.initBroadcastChannel(e.raceId),this.startPolling(),this.startQueueProcessor(),this.pushLocalEntries(),r.setSyncStatus("connecting"),console.log("Sync service initialized for race:",e.raceId)}initBroadcastChannel(e){try{this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(`ski-timer-${e}`),this.broadcastChannel.onmessage=t=>{const{type:s,data:i}=t.data;if(s==="entry"&&b(i))r.mergeCloudEntries([i]);else if(s==="presence"){const o=i;r.addConnectedDevice(o)}}}catch(t){console.warn("BroadcastChannel not supported:",t)}}broadcastEntry(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"entry",data:e})}catch(t){console.error("Broadcast error:",t)}}broadcastPresence(){const e=r.getState();if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"presence",data:{id:e.deviceId,name:e.deviceName,lastSeen:Date.now()}})}catch(t){console.error("Presence broadcast error:",t)}}startPolling(){this.pollInterval&&clearInterval(this.pollInterval),this.fetchCloudEntries();const e=this.consecutiveErrors>2?V:F;this.pollInterval=setInterval(()=>this.fetchCloudEntries(),e)}adjustPollingInterval(e){e?(this.consecutiveErrors=0,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),F))):(this.consecutiveErrors++,this.consecutiveErrors>2&&this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=setInterval(()=>this.fetchCloudEntries(),V)))}async fetchCloudEntries(){const e=r.getState();if(!(!e.settings.sync||!e.raceId))try{const t=await fetch(`${$}?raceId=${encodeURIComponent(e.raceId)}`);if(!t.ok)throw new Error(`HTTP ${t.status}`);let s;try{s=await t.json()}catch{throw new Error("Invalid response format")}if(!s||typeof s!="object")throw new Error("Invalid data structure");const i=Array.isArray(s.entries)?s.entries:[];if(r.setSyncStatus("connected"),i.length>0){const o=r.mergeCloudEntries(i);o>0&&this.showSyncToast(`Synced ${o} entries from cloud`)}this.lastSyncTimestamp=s.lastUpdated||Date.now(),this.adjustPollingInterval(!0)}catch(t){console.error("Cloud sync fetch error:",t);const s=t instanceof Error?t.message:"Unknown error";s.includes("500")||s.includes("503")?r.setSyncStatus("error"):s.includes("Failed to fetch")?r.setSyncStatus("offline"):r.setSyncStatus("error"),this.adjustPollingInterval(!1)}}async sendEntryToCloud(e){const t=r.getState();if(!t.settings.sync||!t.raceId)return!1;try{const s=await fetch(`${$}?raceId=${encodeURIComponent(t.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({entry:e,deviceId:t.deviceId,deviceName:t.deviceName})});if(!s.ok)throw new Error(`HTTP ${s.status}`);return r.removeFromSyncQueue(e.id),!0}catch(s){return console.error("Cloud sync send error:",s),!1}}async pushLocalEntries(){const e=r.getState();if(!(!e.settings.sync||!e.raceId)){console.log("Pushing",e.entries.length,"local entries to cloud");for(const t of e.entries)t.deviceId===e.deviceId&&!t.syncedAt&&await this.sendEntryToCloud(t)}}startQueueProcessor(){this.queueInterval&&clearInterval(this.queueInterval),this.queueInterval=setInterval(()=>this.processQueue(),Ne)}async processQueue(){if(this.isProcessingQueue)return;const e=r.getState();if(!(!e.settings.sync||!e.raceId||e.syncQueue.length===0)){this.isProcessingQueue=!0;try{const t=Date.now();for(const s of e.syncQueue){if(s.retryCount>=Be){console.warn("Max retries exceeded for entry:",s.entry.id),r.removeFromSyncQueue(s.entry.id);continue}const i=Me*Math.pow(2,s.retryCount);if(t-s.lastAttempt<i)continue;await this.sendEntryToCloud(s.entry)||r.updateSyncQueueItem(s.entry.id,{retryCount:s.retryCount+1,lastAttempt:t,error:"Failed to sync"})}}finally{this.isProcessingQueue=!1}}}showSyncToast(e){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:e,type:"success"}}))}cleanup(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null),this.broadcastChannel&&(this.broadcastChannel.close(),this.broadcastChannel=null),this.consecutiveErrors=0,r.setSyncStatus("disconnected"),console.log("Sync service cleaned up")}async forceRefresh(){await this.fetchCloudEntries()}getQueueLength(){return r.getState().syncQueue.length}getLastSyncTime(){return this.lastSyncTimestamp}}const v=new Oe,z={enableHighAccuracy:!0,timeout:1e4,maximumAge:1e3},_e=10,Ue=30;class qe{constructor(){l(this,"watchId",null);l(this,"lastPosition",null)}start(){if(this.watchId!==null)return!0;if(!navigator.geolocation)return console.error("Geolocation not supported"),r.setGpsStatus("inactive"),!1;r.setGpsStatus("searching");try{return this.watchId=navigator.geolocation.watchPosition(e=>this.handlePosition(e),e=>this.handleError(e),z),console.log("GPS watching started"),!0}catch(e){return console.error("Failed to start GPS:",e),r.setGpsStatus("inactive"),!1}}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.lastPosition=null,r.setGpsStatus("inactive"),console.log("GPS watching stopped")}handlePosition(e){this.lastPosition=e;const t=e.coords.accuracy;r.setGpsStatus("active",t),console.log(`GPS position: ${t.toFixed(1)}m accuracy`)}handleError(e){switch(console.error("GPS error:",e.message),e.code){case e.PERMISSION_DENIED:r.setGpsStatus("inactive"),this.stop();break;case e.POSITION_UNAVAILABLE:r.setGpsStatus("searching");break;case e.TIMEOUT:r.setGpsStatus("searching");break}}getPosition(){return this.lastPosition}getCoordinates(){if(this.lastPosition)return{latitude:this.lastPosition.coords.latitude,longitude:this.lastPosition.coords.longitude,accuracy:this.lastPosition.coords.accuracy}}getTimestamp(){var e;return((e=this.lastPosition)==null?void 0:e.timestamp)??null}getAccuracyStatus(){if(!this.lastPosition)return"unknown";const e=this.lastPosition.coords.accuracy;return e<=_e?"good":e<=Ue?"fair":"poor"}isActive(){return this.watchId!==null&&this.lastPosition!==null}toggle(e){return e?this.start():(this.stop(),!0)}async requestPosition(){return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{this.lastPosition=t,e(t)},()=>e(null),z)}):null}}const I=new qe;let B=null;function X(){if(!B)try{B=new(window.AudioContext||window.webkitAudioContext)}catch(n){return console.warn("AudioContext not available:",n),null}return B}function C(n){if(r.getState().settings.haptic&&navigator.vibrate)try{navigator.vibrate(n)}catch(t){console.warn("Vibration failed:",t)}}function R(n=880,e=100){if(!r.getState().settings.sound)return;const s=X();if(s)try{const i=s.createOscillator(),o=s.createGain();i.connect(o),o.connect(s.destination),i.frequency.value=n,i.type="sine",o.gain.setValueAtTime(.3,s.currentTime),o.gain.exponentialRampToValueAtTime(.01,s.currentTime+e/1e3),i.start(s.currentTime),i.stop(s.currentTime+e/1e3)}catch(i){console.warn("Sound playback failed:",i)}}function $e(){C(20),R(880,100)}function Fe(){C([50,50,50]),R(440,200)}function E(){C(10)}function Ve(){C([30,30,30]),R(330,150)}function ze(){C([20,20]),R(660,100)}async function H(){const n=X();if(n&&n.state==="suspended")try{await n.resume()}catch(e){console.warn("Failed to resume audio:",e)}}class He{constructor(e){l(this,"container");l(this,"timeElement");l(this,"dateElement");l(this,"lastTimeStr","");l(this,"animationId",null);l(this,"isRunning",!1);l(this,"tick",()=>{if(!this.isRunning)return;const e=I.getTimestamp(),t=e?new Date(e):new Date,s=Z(t);if(s!==this.lastTimeStr&&(this.updateDigits(s),this.lastTimeStr=s),t.getSeconds()===0||!this.dateElement.textContent){const o=r.getState();this.dateElement.textContent=Te(t,o.currentLang)}this.animationId=requestAnimationFrame(this.tick)});this.container=e,this.timeElement=this.createTimeElement(),this.dateElement=this.createDateElement(),this.container.appendChild(this.timeElement),this.container.appendChild(this.dateElement)}createTimeElement(){const e=document.createElement("div");e.className="clock-time",e.setAttribute("role","timer"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Current time"),e.style.cssText=`
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(32px, 10vw, 48px);
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
    `;for(let t=0;t<12;t++){const s=document.createElement("span");s.className="clock-digit",s.dataset.index=String(t),e.appendChild(s)}return e}createDateElement(){const e=document.createElement("div");return e.className="clock-date",e.style.cssText=`
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 4px;
      text-align: center;
    `,e}start(){this.isRunning||(this.isRunning=!0,this.tick())}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)}updateDigits(e){const t=this.timeElement.querySelectorAll(".clock-digit");for(let s=0;s<e.length&&s<t.length;s++){const i=t[s],o=e[s];i.textContent!==o&&(i.textContent=o,i.style.transform="scale(1.02)",requestAnimationFrame(()=>{i.style.transform="scale(1)"}))}}getCurrentTime(){return this.lastTimeStr}getTimestamp(){const e=I.getTimestamp();return e?new Date(e):new Date}destroy(){this.stop(),this.container.innerHTML=""}}const y=72,G=5,Ge=16;class Qe{constructor(e){l(this,"container");l(this,"scrollContainer");l(this,"contentContainer");l(this,"entries",[]);l(this,"filteredEntries",[]);l(this,"visibleItems",new Map);l(this,"scrollTop",0);l(this,"containerHeight",0);l(this,"options");l(this,"unsubscribe",null);this.options=e,this.container=e.container,this.scrollContainer=document.createElement("div"),this.scrollContainer.className="virtual-scroll-container",this.scrollContainer.style.cssText=`
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
    `,this.contentContainer=document.createElement("div"),this.contentContainer.className="virtual-scroll-content",this.contentContainer.style.position="relative",this.scrollContainer.appendChild(this.contentContainer),this.container.appendChild(this.scrollContainer);const t=ke(()=>this.onScroll(),Ge);this.scrollContainer.addEventListener("scroll",t,{passive:!0}),new ResizeObserver(()=>{this.containerHeight=this.scrollContainer.clientHeight,this.render()}).observe(this.scrollContainer),this.unsubscribe=r.subscribe((i,o)=>{(o.includes("entries")||o.includes("selectedEntries"))&&this.setEntries(i.entries)}),this.containerHeight=this.scrollContainer.clientHeight}setEntries(e){this.entries=e,this.applyFilters()}applyFilters(e,t,s){let i=[...this.entries];if(e){const o=e.toLowerCase();i=i.filter(a=>{var c;return a.bib.toLowerCase().includes(o)||((c=a.deviceName)==null?void 0:c.toLowerCase().includes(o))})}t&&t!=="all"&&(i=i.filter(o=>o.point===t)),s&&s!=="all"&&(i=i.filter(o=>o.status===s)),i.sort((o,a)=>new Date(a.timestamp).getTime()-new Date(o.timestamp).getTime()),this.filteredEntries=i,this.updateContentHeight(),this.render()}updateContentHeight(){const e=this.filteredEntries.length*y;this.contentContainer.style.height=`${e}px`}onScroll(){this.scrollTop=this.scrollContainer.scrollTop,this.render()}render(){if(this.filteredEntries.length===0){this.renderEmpty();return}const e=Math.max(0,Math.floor(this.scrollTop/y)-G),t=Math.min(this.filteredEntries.length,Math.ceil((this.scrollTop+this.containerHeight)/y)+G),s=r.getState(),i=new Set;for(let o=e;o<t;o++){const a=this.filteredEntries[o];i.add(a.id);let c=this.visibleItems.get(a.id);const d=s.selectedEntries.has(a.id);c||(c=this.createItem(a),this.visibleItems.set(a.id,c),this.contentContainer.appendChild(c)),c.style.transform=`translateY(${o*y}px)`,c.classList.toggle("selected",d);const h=c.querySelector(".result-checkbox");h&&(h.checked=d)}for(const[o,a]of this.visibleItems)i.has(o)||(a.remove(),this.visibleItems.delete(o))}createItem(e){const t=document.createElement("div");t.className="result-item",t.setAttribute("role","listitem"),t.setAttribute("data-entry-id",e.id),t.style.cssText=`
      position: absolute;
      left: 0;
      right: 0;
      height: ${y}px;
      display: flex;
      align-items: center;
      padding: 0 16px;
      gap: 12px;
      background: var(--surface);
      border-bottom: 1px solid var(--surface-elevated);
      cursor: pointer;
      transition: background 0.2s;
    `;const s=new Date(e.timestamp),i=Z(s),o=Ae(e.bib||"---"),a=xe(e.point);t.innerHTML=`
      <input type="checkbox" class="result-checkbox" aria-label="Select entry"
        style="width: 20px; height: 20px; accent-color: var(--primary);">
      <div class="result-bib" style="font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 600; min-width: 50px;">
        ${T(o)}
      </div>
      <div class="result-point" style="padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; background: ${a}20; color: ${a};">
        ${T(e.point)}
      </div>
      <div class="result-time" style="flex: 1; font-family: 'JetBrains Mono', monospace; color: var(--text-secondary);">
        ${T(i)}
      </div>
      ${e.status!=="ok"?`
        <span class="result-status" style="padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; background: var(--error); color: white;">
          ${T(e.status.toUpperCase())}
        </span>
      `:""}
      ${e.photo?`
        <span class="result-photo-indicator" style="color: var(--primary);">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/>
            <path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/>
          </svg>
        </span>
      `:""}
      <button class="result-delete" aria-label="Delete entry" style="background: none; border: none; color: var(--error); padding: 8px; cursor: pointer; opacity: 0.7;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
        </svg>
      </button>
    `;const c=t.querySelector(".result-checkbox");return c.addEventListener("click",h=>{var g,u;h.stopPropagation(),(u=(g=this.options).onItemSelect)==null||u.call(g,e,c.checked)}),t.querySelector(".result-delete").addEventListener("click",h=>{var g,u;h.stopPropagation(),(u=(g=this.options).onItemDelete)==null||u.call(g,e)}),t.addEventListener("click",h=>{var g,u;(u=(g=this.options).onItemClick)==null||u.call(g,e,h)}),t.addEventListener("touchstart",()=>{t.style.background="var(--surface-elevated)"},{passive:!0}),t.addEventListener("touchend",()=>{t.style.background="var(--surface)"},{passive:!0}),t}renderEmpty(){for(const e of this.visibleItems.values())e.remove();this.visibleItems.clear(),this.contentContainer.innerHTML=`
      <div class="empty-state" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 200px; color: var(--text-secondary);">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom: 16px; opacity: 0.5;">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
        <span id="empty-state-text">No entries recorded</span>
      </div>
    `}scrollToTop(){this.scrollContainer.scrollTo({top:0,behavior:"smooth"})}scrollToEntry(e){const t=this.filteredEntries.findIndex(s=>s.id===e);if(t!==-1){const s=t*y;this.scrollContainer.scrollTo({top:s,behavior:"smooth"})}}getVisibleCount(){return this.filteredEntries.length}destroy(){this.unsubscribe&&this.unsubscribe(),this.visibleItems.clear(),this.container.innerHTML=""}}const Ye=3e3;class je{constructor(){l(this,"container");l(this,"queue",[]);l(this,"isShowing",!1);this.container=this.createContainer(),document.body.appendChild(this.container),window.addEventListener("show-toast",e=>{this.show(e.detail.message,{type:e.detail.type})})}createContainer(){const e=document.createElement("div");return e.id="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.style.cssText=`
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    `,e}show(e,t={}){this.queue.push({message:e,options:t}),this.isShowing||this.processQueue()}processQueue(){if(this.queue.length===0){this.isShowing=!1;return}this.isShowing=!0;const{message:e,options:t}=this.queue.shift(),s=t.duration||Ye,i=t.type||"info",o=this.createToast(e,i);this.container.appendChild(o),requestAnimationFrame(()=>{o.style.opacity="1",o.style.transform="translateY(0)"}),setTimeout(()=>{o.style.opacity="0",o.style.transform="translateY(10px)",setTimeout(()=>{o.remove(),this.processQueue()},200)},s)}createToast(e,t){const s=document.createElement("div");s.className=`toast toast-${t}`;const i={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--primary)"},o={success:'<path d="M20 6L9 17l-5-5"/>',error:'<path d="M18 6L6 18M6 6l12 12"/>',warning:'<path d="M12 9v4M12 17h.01"/>',info:'<path d="M12 16v-4M12 8h.01"/>'};return s.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border-left: 3px solid ${i[t]};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 0.875rem;
      color: var(--text-primary);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: auto;
      max-width: 90vw;
    `,s.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${i[t]}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        ${o[t]}
      </svg>
      <span>${this.escapeHtml(e)}</span>
    `,s}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}clear(){this.queue=[],this.container.innerHTML="",this.isShowing=!1}}let M=null;function K(){return M||(M=new je),M}function f(n,e="info",t){K().show(n,{type:e,duration:t})}const k=80,Q=2.5;class We{constructor(e){l(this,"container");l(this,"indicator");l(this,"onRefresh");l(this,"startY",0);l(this,"currentY",0);l(this,"isPulling",!1);l(this,"isRefreshing",!1);l(this,"scrollableParent",null);l(this,"onTouchStart",e=>{var s;this.isRefreshing||(((s=this.scrollableParent)==null?void 0:s.scrollTop)??0)>0||(this.startY=e.touches[0].clientY,this.isPulling=!0)});l(this,"onTouchMove",e=>{var i;if(!this.isPulling||this.isRefreshing)return;if((((i=this.scrollableParent)==null?void 0:i.scrollTop)??0)>0){this.isPulling=!1;return}this.currentY=e.touches[0].clientY;const s=(this.currentY-this.startY)/Q;s>0&&(e.preventDefault(),this.updateIndicator(s))});l(this,"onTouchEnd",async()=>{if(!this.isPulling)return;const e=(this.currentY-this.startY)/Q;this.isPulling=!1,e>=k&&!this.isRefreshing?await this.triggerRefresh():this.resetIndicator()});this.container=e.container,this.onRefresh=e.onRefresh,this.indicator=this.createIndicator(),this.container.insertBefore(this.indicator,this.container.firstChild),this.scrollableParent=this.findScrollableParent(this.container),this.bindEvents()}createIndicator(){const e=document.createElement("div");e.className="pull-indicator",e.style.cssText=`
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: transform 0.2s;
      pointer-events: none;
      z-index: 100;
    `,e.innerHTML=`
      <div class="pull-indicator-content" style="display: flex; align-items: center; gap: 8px;">
        <svg class="pull-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
        <span class="pull-text">Pull to refresh</span>
      </div>
      <div class="pull-spinner" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      </div>
    `;const t=document.createElement("style");return t.textContent=`
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(t),e}findScrollableParent(e){let t=e.parentElement;for(;t;){const s=getComputedStyle(t);if(s.overflowY==="auto"||s.overflowY==="scroll")return t;t=t.parentElement}return null}bindEvents(){this.container.addEventListener("touchstart",this.onTouchStart,{passive:!0}),this.container.addEventListener("touchmove",this.onTouchMove,{passive:!1}),this.container.addEventListener("touchend",this.onTouchEnd,{passive:!0})}updateIndicator(e){const t=Math.min(e,k*1.5);this.indicator.style.transform=`translateY(${t}px)`;const s=Math.min(e/k,1),i=this.indicator.querySelector(".pull-icon"),o=this.indicator.querySelector(".pull-text");i&&(i.style.transform=`rotate(${s*180}deg)`),o&&(o.textContent=s>=1?"Release to refresh":"Pull to refresh")}async triggerRefresh(){this.isRefreshing=!0;const e=this.indicator.querySelector(".pull-indicator-content"),t=this.indicator.querySelector(".pull-spinner");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.indicator.style.transform=`translateY(${k}px)`;try{await this.onRefresh()}finally{this.isRefreshing=!1,e&&(e.style.display="flex"),t&&(t.style.display="none"),this.resetIndicator()}}resetIndicator(){this.indicator.style.transform="translateY(0)";const e=this.indicator.querySelector(".pull-icon");e&&(e.style.transform="rotate(0deg)")}destroy(){this.container.removeEventListener("touchstart",this.onTouchStart),this.container.removeEventListener("touchmove",this.onTouchMove),this.container.removeEventListener("touchend",this.onTouchEnd),this.indicator.remove()}}const Y={en:{timer:"Timer",results:"Results",settings:"Settings",start:"Start",finish:"Finish",bib:"Bib",point:"Point",time:"Time",lastRecorded:"Last recorded",status:"Status",noEntries:"No entries recorded",search:"Search by bib...",filter:"Filter",all:"All",total:"Total",racers:"Racers",finished:"Finished",fastest:"Fastest",average:"Average",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Delete Entry",confirmDeleteText:"Are you sure you want to delete this entry?",confirmClearAll:"Clear All Results",clearAllText:"This will delete all recorded entries. This action cannot be undone.",delete:"Delete",cancel:"Cancel",save:"Save",edit:"Edit",undo:"Undo",export:"Export",clearAll:"Clear All",selectAll:"Select All",deleteSelected:"Delete Selected",connected:"Connected",connecting:"Connecting...",offline:"Offline",syncError:"Sync error",syncReceived:"Synced from cloud",raceId:"Race ID",deviceName:"Device Name",cloudSync:"Cloud Sync",syncStatus:"Sync Status",pendingSync:"pending sync",saved:"Saved",deleted:"Deleted",cleared:"All entries cleared",undone:"Undone",copied:"Copied to clipboard",duplicateWarning:"Duplicate entry detected",exported:"Exported successfully",gps:"GPS",gpsActive:"GPS Active",gpsSearching:"Searching for GPS...",gpsInactive:"GPS Inactive",gpsAccuracy:"Accuracy",simpleMode:"Simple Mode",fullMode:"Full Mode",autoIncrement:"Auto-increment Bib",hapticFeedback:"Haptic Feedback",soundFeedback:"Sound Feedback",language:"Language",backup:"Backup",restore:"Restore",importData:"Import Data",exportData:"Export Data",photoCapture:"Photo Capture",photoCaptured:"Photo captured",photoError:"Photo capture failed",viewPhoto:"View Photo",version:"Version",devices:"Devices",entries:"entries",selected:"selected"},de:{timer:"Timer",results:"Ergebnisse",settings:"Einstellungen",start:"Start",finish:"Ziel",bib:"Startnr.",point:"Punkt",time:"Zeit",lastRecorded:"Zuletzt erfasst",status:"Status",noEntries:"Keine Einträge vorhanden",search:"Startnr. suchen...",filter:"Filter",all:"Alle",total:"Gesamt",racers:"Fahrer",finished:"Im Ziel",fastest:"Schnellste",average:"Durchschnitt",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Eintrag löschen",confirmDeleteText:"Möchten Sie diesen Eintrag wirklich löschen?",confirmClearAll:"Alle löschen",clearAllText:"Alle Einträge werden gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.",delete:"Löschen",cancel:"Abbrechen",save:"Speichern",edit:"Bearbeiten",undo:"Rückgängig",export:"Exportieren",clearAll:"Alle löschen",selectAll:"Alle auswählen",deleteSelected:"Ausgewählte löschen",connected:"Verbunden",connecting:"Verbinde...",offline:"Offline",syncError:"Sync-Fehler",syncReceived:"Von Cloud synchronisiert",raceId:"Rennen-ID",deviceName:"Gerätename",cloudSync:"Cloud-Sync",syncStatus:"Sync-Status",pendingSync:"ausstehend",saved:"Gespeichert",deleted:"Gelöscht",cleared:"Alle Einträge gelöscht",undone:"Rückgängig gemacht",copied:"In Zwischenablage kopiert",duplicateWarning:"Doppelter Eintrag erkannt",exported:"Erfolgreich exportiert",gps:"GPS",gpsActive:"GPS Aktiv",gpsSearching:"GPS wird gesucht...",gpsInactive:"GPS Inaktiv",gpsAccuracy:"Genauigkeit",simpleMode:"Einfacher Modus",fullMode:"Erweiterter Modus",autoIncrement:"Auto-Inkrement",hapticFeedback:"Haptisches Feedback",soundFeedback:"Ton-Feedback",language:"Sprache",backup:"Sichern",restore:"Wiederherstellen",importData:"Daten importieren",exportData:"Daten exportieren",photoCapture:"Foto aufnehmen",photoCaptured:"Foto aufgenommen",photoError:"Foto-Aufnahme fehlgeschlagen",viewPhoto:"Foto anzeigen",version:"Version",devices:"Geräte",entries:"Einträge",selected:"ausgewählt"}};function m(n,e="de"){return Y[e][n]||Y.en[n]||n}let j=null,w=null;function W(){Je(),Ze(),Xe(),Ke(),et(),st(),ot(),rt(),r.subscribe(ht);const n=r.getState().settings;n.gps&&I.start(),n.sync&&r.getState().raceId&&v.initialize(),n.photoCapture&&S.initialize(),document.addEventListener("click",H,{once:!0}),document.addEventListener("touchstart",H,{once:!0}),le(),mt(),console.log("Ski Race Timer initialized")}function Je(){const n=document.getElementById("clock-container");n&&(j=new He(n),j.start())}function Ze(){document.querySelectorAll(".tab-btn").forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-view");t&&(r.setView(t),E())})})}function Xe(){const n=document.getElementById("number-pad");n&&n.addEventListener("click",e=>{const s=e.target.closest(".num-btn");if(!s)return;const i=s.getAttribute("data-num"),o=s.getAttribute("data-action");if(i){const a=r.getState();a.bibInput.length<3&&(r.setBibInput(a.bibInput+i),E())}else if(o==="clear")r.setBibInput(""),E();else if(o==="delete"){const a=r.getState();r.setBibInput(a.bibInput.slice(0,-1)),E()}})}function Ke(){const n=document.getElementById("timing-points");n&&n.addEventListener("click",e=>{const s=e.target.closest(".timing-point-btn");if(!s)return;const i=s.getAttribute("data-point");i&&(r.setSelectedPoint(i),E())})}function et(){const n=document.getElementById("timestamp-btn");n&&(n.addEventListener("click",async()=>{await J()}),document.addEventListener("keydown",e=>{e.key==="Enter"&&r.getState().currentView==="timer"&&(e.preventDefault(),J())}))}async function J(){const n=r.getState();if(!n.isRecording){r.setRecording(!0);try{let e=null;n.settings.photoCapture&&(e=await Re());const t=I.getCoordinates(),s={id:ge(n.deviceId),bib:n.bibInput.padStart(3,"0"),point:n.selectedPoint,timestamp:new Date().toISOString(),status:"ok",deviceId:n.deviceId,deviceName:n.deviceName,photo:e||void 0,gpsCoords:t},i=n.entries.some(o=>o.bib===s.bib&&o.point===s.point);if(r.addEntry(s),i?(Fe(),tt(s)):($e(),ee(s)),v.broadcastEntry(s),n.settings.auto){const o=String(parseInt(n.bibInput||"0",10)+1);r.setBibInput(o)}else r.setBibInput("");nt(s)}finally{r.setRecording(!1)}}}function ee(n){const e=document.getElementById("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-bib"),s=e.querySelector(".confirmation-point"),i=e.querySelector(".confirmation-time");if(t&&(t.textContent=n.bib||"---"),s&&(s.textContent=n.point,s.style.color=_(n.point)),i){const o=new Date(n.timestamp);i.textContent=de(o)}e.classList.add("show"),setTimeout(()=>{e.classList.remove("show")},1500)}function tt(n){const e=document.getElementById("confirmation-overlay");if(!e)return;const t=e.querySelector(".confirmation-duplicate");t&&(t.style.display="flex"),ee(n),setTimeout(()=>{t&&(t.style.display="none")},2500)}function nt(n){const e=document.getElementById("last-recorded");if(!e)return;const t=e.querySelector(".bib"),s=e.querySelector(".point"),i=e.querySelector(".time");if(t&&(t.textContent=n.bib||"---"),s&&(s.textContent=n.point,s.style.background=`${_(n.point)}20`,s.style.color=_(n.point)),i){const o=new Date(n.timestamp);i.textContent=de(o)}e.classList.add("visible")}function st(){const n=document.getElementById("results-list");if(!n)return;w=new Qe({container:n,onItemClick:o=>at(o),onItemDelete:o=>ct(o),onItemSelect:(o,a)=>{r.toggleEntrySelection(o.id)}});const e=document.querySelector(".results-view");e&&new We({container:e,onRefresh:async()=>{await v.forceRefresh(),f(m("syncReceived",r.getState().currentLang),"success")}});const t=document.getElementById("search-input");if(t){let o;t.addEventListener("input",()=>{clearTimeout(o),o=setTimeout(()=>{N()},300)})}const s=document.getElementById("filter-point"),i=document.getElementById("filter-status");s&&s.addEventListener("change",N),i&&i.addEventListener("change",N),it()}function it(){const n=document.getElementById("clear-all-btn");n&&n.addEventListener("click",()=>{const i=r.getState();if(i.entries.length===0){f(m("noEntries",i.currentLang),"info");return}O("clearAll")});const e=document.getElementById("undo-btn");e&&e.addEventListener("click",()=>{r.canUndo()&&(r.undo(),ze(),f(m("undone",r.getState().currentLang),"success"))});const t=document.getElementById("export-btn");t&&t.addEventListener("click",ut);const s=document.getElementById("delete-selected-btn");s&&s.addEventListener("click",()=>{r.getState().selectedEntries.size>0&&O("deleteSelected")})}function N(){if(!w)return;const n=document.getElementById("search-input"),e=document.getElementById("filter-point"),t=document.getElementById("filter-status");w.applyFilters((n==null?void 0:n.value)||"",(e==null?void 0:e.value)||"all",(t==null?void 0:t.value)||"all"),U()}function ot(){const n=document.getElementById("simple-mode-toggle");n&&n.addEventListener("change",()=>{r.updateSettings({simple:n.checked}),le()});const e=document.getElementById("gps-toggle");e&&e.addEventListener("change",()=>{r.updateSettings({gps:e.checked}),I.toggle(e.checked)});const t=document.getElementById("sync-toggle");t&&t.addEventListener("change",()=>{r.updateSettings({sync:t.checked}),t.checked&&r.getState().raceId?v.initialize():v.cleanup()});const s=document.getElementById("auto-toggle");s&&s.addEventListener("change",()=>{r.updateSettings({auto:s.checked})});const i=document.getElementById("haptic-toggle");i&&i.addEventListener("change",()=>{r.updateSettings({haptic:i.checked})});const o=document.getElementById("sound-toggle");o&&o.addEventListener("change",()=>{r.updateSettings({sound:o.checked})});const a=document.getElementById("photo-toggle");a&&a.addEventListener("change",()=>{r.updateSettings({photoCapture:a.checked}),S.toggle(a.checked)});const c=document.getElementById("lang-toggle");c&&c.addEventListener("click",()=>{const g=r.getState().currentLang==="de"?"en":"de";r.setLanguage(g),ce()});const d=document.getElementById("race-id-input");d&&d.addEventListener("change",()=>{r.setRaceId(d.value.trim()),r.getState().settings.sync&&v.initialize()});const h=document.getElementById("device-name-input");h&&h.addEventListener("change",()=>{r.setDeviceName(h.value.trim())})}function rt(){document.querySelectorAll(".modal-overlay").forEach(t=>{t.addEventListener("click",s=>{s.target===t&&P()})}),document.querySelectorAll('[data-action="cancel"]').forEach(t=>{t.addEventListener("click",P)});const n=document.getElementById("confirm-delete-btn");n&&n.addEventListener("click",lt);const e=document.getElementById("save-edit-btn");e&&e.addEventListener("click",dt)}function at(n){const e=document.getElementById("edit-modal");if(!e)return;e.setAttribute("data-entry-id",n.id);const t=document.getElementById("edit-bib-input"),s=document.getElementById("edit-status-select");t&&(t.value=n.bib||""),s&&(s.value=n.status),e.classList.add("show")}function O(n){const e=document.getElementById("confirm-modal");if(!e)return;const t=r.getState().currentLang,s=e.querySelector(".modal-title"),i=e.querySelector(".modal-text");if(e.setAttribute("data-action",n),n==="clearAll")s&&(s.textContent=m("confirmClearAll",t)),i&&(i.textContent=m("clearAllText",t));else if(n==="deleteSelected"){const o=r.getState().selectedEntries.size;s&&(s.textContent=m("confirmDelete",t)),i&&(i.textContent=`${o} ${m("entries",t)} ${m("selected",t)}`)}else s&&(s.textContent=m("confirmDelete",t)),i&&(i.textContent=m("confirmDeleteText",t));e.classList.add("show")}function ct(n){const e=document.getElementById("confirm-modal");e&&e.setAttribute("data-entry-id",n.id),O("delete")}function lt(){const n=document.getElementById("confirm-modal");if(!n)return;const e=n.getAttribute("data-action"),t=n.getAttribute("data-entry-id");if(e==="clearAll")r.clearAll(),f(m("cleared",r.getState().currentLang),"success");else if(e==="deleteSelected"){const s=Array.from(r.getState().selectedEntries);r.deleteMultiple(s),f(m("deleted",r.getState().currentLang),"success")}else t&&(r.deleteEntry(t),f(m("deleted",r.getState().currentLang),"success"));Ve(),P()}function dt(){const n=document.getElementById("edit-modal");if(!n)return;const e=n.getAttribute("data-entry-id");if(!e)return;const t=document.getElementById("edit-bib-input"),s=document.getElementById("edit-status-select");r.updateEntry(e,{bib:(t==null?void 0:t.value.padStart(3,"0"))||"",status:s==null?void 0:s.value}),f(m("saved",r.getState().currentLang),"success"),P()}function P(){document.querySelectorAll(".modal-overlay.show").forEach(n=>{n.classList.remove("show")})}function ut(){const n=r.getState();if(n.entries.length===0){f(m("noEntries",n.currentLang),"info");return}const e=["Startnummer","Messpunkt","Zeit","Status","Gerät"],t=n.entries.map(c=>[c.bib,c.point,c.timestamp,c.status.toUpperCase(),c.deviceName||""]),s=[e.join(";"),...t.map(c=>c.join(";"))].join(`
`),i=new Blob([s],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(i),a=document.createElement("a");a.href=o,a.download=`race-horology-${new Date().toISOString().slice(0,10)}.csv`,a.click(),URL.revokeObjectURL(o),f(m("exported",n.currentLang),"success")}function ht(n,e){e.includes("currentView")&&te(),e.includes("bibInput")&&ne(),e.includes("selectedPoint")&&se(),e.includes("entries")&&(w&&w.setEntries(n.entries),U(),ie()),e.includes("syncStatus")&&oe(),e.includes("gpsStatus")&&re(),e.includes("undoStack")&&ae()}function mt(){te(),ne(),se(),U(),ie(),oe(),re(),ae(),gt(),ce()}function te(){const n=r.getState();document.querySelectorAll(".view").forEach(t=>{t.classList.remove("active")});const e=document.querySelector(`.${n.currentView}-view`);e&&e.classList.add("active"),document.querySelectorAll(".tab-btn").forEach(t=>{t.classList.toggle("active",t.getAttribute("data-view")===n.currentView)})}function ne(){const n=r.getState(),e=document.querySelector(".bib-value");e&&(e.textContent=n.bibInput?n.bibInput.padStart(3,"0"):"---");const t=document.getElementById("timestamp-btn");t&&t.classList.toggle("ready",n.bibInput.length>0)}function se(){const n=r.getState();document.querySelectorAll(".timing-point-btn").forEach(e=>{e.classList.toggle("active",e.getAttribute("data-point")===n.selectedPoint)})}function U(){const e=r.getState().entries,t=e.length,s=new Set(e.map(d=>d.bib)).size,i=e.filter(d=>d.point==="F"&&d.status==="ok").length,o=document.getElementById("stat-total"),a=document.getElementById("stat-racers"),c=document.getElementById("stat-finished");o&&(o.textContent=String(t)),a&&(a.textContent=String(s)),c&&(c.textContent=String(i))}function ie(){const n=document.getElementById("entry-count-badge");if(n){const e=r.getState().entries.length;n.textContent=String(e),n.style.display=e>0?"inline":"none"}}function oe(){const n=r.getState(),e=document.querySelector(".sync-dot"),t=document.querySelector(".sync-status-text");e&&(e.classList.remove("connected","error","offline"),n.syncStatus==="connected"?e.classList.add("connected"):n.syncStatus==="error"?e.classList.add("error"):n.syncStatus==="offline"&&e.classList.add("offline")),t&&(t.textContent=m(n.syncStatus,n.currentLang))}function re(){const n=r.getState(),e=document.querySelector(".gps-dot"),t=document.querySelector(".gps-status-text");e&&(e.classList.remove("active","searching"),n.gpsStatus==="active"?e.classList.add("active"):n.gpsStatus==="searching"&&e.classList.add("searching")),t&&(n.gpsStatus==="active"&&n.gpsAccuracy?t.textContent=`${n.gpsAccuracy.toFixed(0)}m`:t.textContent=m(`gps${n.gpsStatus.charAt(0).toUpperCase()+n.gpsStatus.slice(1)}`,n.currentLang))}function ae(){const n=document.getElementById("undo-btn");n&&n.toggleAttribute("disabled",!r.canUndo())}function gt(){var i,o,a,c,d,h,g;const n=r.getState(),{settings:e}=n;(i=document.getElementById("simple-mode-toggle"))==null||i.setAttribute("checked",String(e.simple)),(o=document.getElementById("gps-toggle"))==null||o.setAttribute("checked",String(e.gps)),(a=document.getElementById("sync-toggle"))==null||a.setAttribute("checked",String(e.sync)),(c=document.getElementById("auto-toggle"))==null||c.setAttribute("checked",String(e.auto)),(d=document.getElementById("haptic-toggle"))==null||d.setAttribute("checked",String(e.haptic)),(h=document.getElementById("sound-toggle"))==null||h.setAttribute("checked",String(e.sound)),(g=document.getElementById("photo-toggle"))==null||g.setAttribute("checked",String(e.photoCapture));const t=document.getElementById("race-id-input");t&&(t.value=n.raceId);const s=document.getElementById("device-name-input");s&&(s.value=n.deviceName)}function ce(){const n=r.getState().currentLang;document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.getAttribute("data-i18n");t&&(e.textContent=m(t,n))}),document.querySelectorAll("[data-i18n-placeholder]").forEach(e=>{const t=e.getAttribute("data-i18n-placeholder");t&&(e.placeholder=m(t,n))})}function le(){const n=r.getState().settings;document.querySelectorAll("[data-advanced]").forEach(s=>{s.style.display=n.simple?"none":""});const t=document.querySelector('[data-point="S"]');t&&(t.style.display=n.simple?"none":""),n.simple&&r.setSelectedPoint("F")}function _(n){return{S:"var(--success)",I1:"var(--primary)",I2:"var(--primary)",I3:"var(--primary)",F:"var(--secondary)"}[n]}function de(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),s=String(n.getSeconds()).padStart(2,"0"),i=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${s}.${i}`}K();document.readyState==="loading"?document.addEventListener("DOMContentLoaded",W):W();"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const n=await navigator.serviceWorker.register("/sw.js");console.log("Service Worker registered:",n.scope),n.addEventListener("updatefound",()=>{const e=n.installing;e&&e.addEventListener("statechange",()=>{e.state==="installed"&&navigator.serviceWorker.controller&&console.log("New version available")})})}catch(n){console.error("Service Worker registration failed:",n)}});document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&console.log("App resumed")});window.addEventListener("online",()=>{console.log("App is online")});window.addEventListener("offline",()=>{console.log("App is offline")});window.addEventListener("beforeunload",()=>{});console.log("Ski Race Timer v2.0.0");
//# sourceMappingURL=main-Blbf_JA9.js.map
