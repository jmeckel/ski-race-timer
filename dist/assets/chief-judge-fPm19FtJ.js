var Ht=Object.defineProperty;var Vt=(n,e,t)=>e in n?Ht(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var c=(n,e,t)=>Vt(n,typeof e!="symbol"?e+"":e,t);import{b as w,c as zt,m as j}from"./vendor-signals-BzS5ZRDx.js";const Ke={en:{timer:"Timer",results:"Results",settings:"Settings",start:"Start",finish:"Finish",startShort:"S",finishShort:"F",bib:"Bib",point:"Point",run:"Run",run1:"R1",run2:"R2",time:"Record time",lastRecorded:"Last recorded",lastRecordedShort:"Last:",advancedSettings:"Advanced Settings",status:"Status",noEntries:"No entries recorded",noEntriesHint:"Record times on the Timer tab",search:"Search by bib...",searchResults:"Search results",filter:"Filter",all:"All",total:"Total",racers:"Racers",finished:"Finished",fastest:"Fastest",average:"Average",timeEntry:"time",timeEntries:"times",faultEntry:"fault",faultEntries:"faults",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Delete Entry",confirmDeleteText:"Are you sure you want to delete this entry?",confirmDeleteFault:"Delete this fault?",confirmClearAll:"Clear All Results",clearAllText:"This will delete all recorded entries. This action cannot be undone.",confirmUndoAdd:"Undo Recording",confirmUndoAddText:"This will delete the recorded entry. Continue?",delete:"Delete",cancel:"Cancel",close:"Close",back:"Back",save:"Save",saving:"Saving...",edit:"Edit",undo:"Undo",export:"Export",clearAll:"Clear All",selectAll:"Select All",deleteSelected:"Delete Selected",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Synced from cloud",raceId:"Race ID",invalidRaceId:"Invalid Race ID. Use letters, numbers, hyphens, underscores only.",deviceName:"Time Keeper ID",cloudSync:"Cloud Sync",syncStatus:"Sync Status",pendingSync:"pending sync",raceSetup:"Race Setup",raceSetupDesc:"Required for multi-device timing and syncing.",firstGateLabel:"First gate",saved:"Saved",deleted:"Deleted",cleared:"All entries cleared",undone:"Undone",copied:"Copied to clipboard",debugInfoCopied:"Debug info copied to clipboard",debugInfoCopyFailed:"Tap and hold to copy debug info",duplicateWarning:"Duplicate entry detected",zeroBibWarning:"Bib 000 - verify entry",exported:"Exported successfully",gps:"GPS",gpsActive:"GPS Active",gpsSearching:"Searching for GPS...",gpsInactive:"GPS Inactive",gpsAccuracy:"Accuracy",settingsRaceSetup:"Race Setup",settingsTimingGroup:"Timing",settingsSyncGroup:"Sync",settingsFeedbackGroup:"Feedback",settingsDisplayGroup:"Display",simpleMode:"Simple Mode",fullMode:"Full Mode",autoIncrement:"Auto-increment Bib",hapticFeedback:"Haptic Feedback",soundFeedback:"Sound Feedback",language:"Language",advancedSettingsHint:"These options can affect timing accuracy. Change only if needed.",simpleModeDesc:"Simplified interface for basic timing",cloudSyncDesc:"Sync with other devices",gpsDesc:"Use GPS for accurate timestamps",autoIncrementDesc:"Increase bib number after recording",photoCaptureDesc:"Capture photo on timestamp",hapticFeedbackDesc:"Vibration on actions",soundFeedbackDesc:"Audio confirmation",ambientMode:"Ambient Mode",ambientModeDesc:"Auto-dim after 30s inactivity",photoCapture:"Photo Capture",photoCaptured:"Photo captured",photoError:"Photo capture failed",photoSaveFailed:"Photo storage failed",viewPhoto:"View Photo",deletePhoto:"Delete Photo",photoFor:"Photo for Bib",noPhotoAvailable:"No photo available",photoDeleted:"Photo deleted",raceChangeTitle:"Change Race",raceChangeSyncedText:"You have results from another race. Export or delete them before switching?",raceChangeUnsyncedText:"You have existing results. Keep them or delete before switching?",keepResults:"Keep",version:"Version",devices:"Devices",entries:"entries",selected:"selected",raceFound:"Race found",raceNew:"New race",entryInCloud:"entry in cloud",entriesInCloud:"entries in cloud",photoTooLarge:"Photo too large for sync",syncedEntriesFromCloud:"Synced {count} entries from cloud",syncedFaultsFromCloud:"Synced {count} faults from cloud",crossDeviceDuplicate:"Duplicate: Bib {bib} {point} already recorded by {device}",syncPhotos:"Sync Photos",syncPhotosDesc:"Share photos across devices via cloud",syncPhotosWarning:"Enable Photo Sync",syncPhotosWarningText:"Enabling photo sync will transfer the following data:",photosToUpload:"Photos to upload",photosToDownload:"Photos to download",totalDataVolume:"Total data volume",enableSync:"Enable Sync",noPhotosToSync:"No photos to sync",admin:"Admin",adminPin:"Race Management PIN",adminPinDesc:"Required to manage and sync races",manageRaces:"Manage Races",manageRacesDesc:"View and delete synced races",manage:"Manage",enterAdminPin:"Enter Race Management PIN",enterPinText:"Enter your PIN to access race management.",enterPinToJoinRace:"Enter your PIN to join this race.",enterPinForChiefJudge:"Enter your PIN to access Chief Judge mode.",enterChiefJudgePin:"Enter Chief Judge PIN",enterPinForChiefJudgeInfo:"Chief Judge mode requires a separate PIN. First use sets the PIN.",syncRequiresPin:"Sync disabled. Enable sync and enter PIN to reconnect.",incorrectPin:"Incorrect PIN",verify:"Verify",setPinFirst:"Please set a Race Management PIN first",pinSaved:"PIN saved",pinCleared:"PIN cleared",pinNotSet:"Not set",pinSet:"PIN set",setPin:"Set PIN",changePin:"Change PIN",currentPin:"Current PIN",newPin:"New PIN (4 digits)",confirmPin:"Confirm PIN",pinMismatch:"PINs do not match",pinFormatError:"PIN must be exactly 4 digits",loading:"Loading...",noRaces:"No active races",noRacesHint:"Create one in Settings",cleanRunHint:"Clean run so far",refresh:"Refresh",raceDeleted:"Race Deleted",raceDeletedText:"This race has been deleted by an administrator.",raceDeletedFor:"Race deleted:",raceDeletedSuccess:"Race deleted:",confirmDeleteRace:"Delete Race",confirmDeleteRaceText:"Are you sure you want to delete race",loadError:"Failed to load races. Check your connection and try again.",deleteError:"Failed to delete race",entry:"entry",device:"device",storageError:"Failed to save data - check storage",storageQuotaError:"Storage full! Export data immediately",storageWarning:"Storage almost full",storageNearlyFull:"Storage nearly full. Export data and clear old entries.",networkError:"Network error - check connection",connectionFailed:"Connection failed",serverUnavailable:"Server unavailable",rateLimitError:"Too many requests - please wait",authError:"Authentication failed. Try re-entering your PIN.",syncFailed:"Sync failed",pinSyncFailed:"PIN not synced to cloud",cameraError:"Camera error",cameraPermissionDenied:"Camera access denied",gpsError:"GPS error",gpsPermissionDenied:"GPS access denied",gpsUnavailable:"GPS unavailable",wakeLockFailed:"Screen may dim during timing",wakeLockIdleTimeout:"Screen will dim to save battery. Tap to keep awake.",unknownError:"Unknown error",onboardingWelcome:"Welcome to Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronized timing for ski races",getStarted:"Get Started",skipSetup:"Skip",onboardingRole:"What's Your Role?",onboardingRoleDesc:"Choose how you'll be helping at the race",roleTimerTitle:"Timer",roleTimerDesc:"You will record start and finish times",roleJudgeTitle:"Gate Judge",roleJudgeDesc:"You will record gate faults (Torrichter)",onboardingDeviceName:"Name Your Timer",onboardingDeviceNameDesc:"This identifies your device when syncing",onboardingDeviceNameJudge:"Your Name",onboardingDeviceNameJudgeDesc:"This identifies you as the gate judge",onboardingPhoto:"Photo Documentation",onboardingPhotoDesc:"Automatically capture a photo when recording each timestamp. Useful for verifying bib numbers and resolving disputes.",enablePhotoCapture:"Enable Photo Capture",photoCaptureLabel:"Photo Capture",onboardingGates:"Your Gate Assignment",onboardingGatesDesc:"Enter the gate numbers you'll be watching. You can change this later.",onboardingRaceSetup:"Join a Race",onboardingRaceSetupDesc:"Enter a race ID to sync with other timers",skipForNow:"Skip for now",onboardingReady:"Ready to Time!",onboardingReadyJudge:"Ready to Judge!",onboardingTip:"Tap the big blue button to record timestamps",onboardingTipJudge:"Tap a racer's bib to record a fault",startTiming:"Start Timing",startJudging:"Start Judging",continue:"Continue",deviceNameLabel:"Device Name",raceIdLabel:"Race ID",syncStatusLabel:"Cloud Sync",enabled:"Enabled",disabled:"Disabled",showTutorial:"Show Tutorial",showTutorialDesc:"Run the setup wizard again",show:"Show",onboardingComplete:"Setup complete!",invalidPin:"PIN must be 4 digits",recentRaces:"Recent Races",noRecentRaces:"No races from today",errorOccurred:"Something went wrong",errorRecoveryMessage:"The app encountered an error. You can dismiss this and continue, or reload the app.",dismiss:"Dismiss",reload:"Reload",updateAvailable:"Update available! Reload to get the latest version.",operationFailed:"Operation failed. Please try again.",raceIdPlaceholder:"RACE-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Photo for bib",gateJudge:"Gate Judge",gateJudgeTab:"Gate",deviceRole:"Device Role",deviceRoleDesc:"Timer records times, Gate Judge records faults",roleTimer:"Timer",roleGateJudge:"Gate Judge",gateAssignment:"Gate Assignment",noGateAssignment:"No gate assignment. Please set your gate range first.",gates:"Gates",gatesFrom:"From",gatesTo:"To",firstGateColor:"Color of first gate",colorRed:"Red",colorBlue:"Blue",changeGates:"Change",otherJudges:"Other judges:",activeBibs:"On Course",noBibsOnCourse:"No racers on course",recordFault:"Record Fault",faultType:"Fault Type",faultMG:"Missed Gate",faultSTR:"Straddling",faultBR:"Binding Release",faultMGShort:"MG",faultSTRShort:"STR",faultBRShort:"BR",orEnterManually:"or enter:",faultRecorded:"Fault recorded",signalReady:"Ready",judgeReady:"Ready for race!",judgeNotReady:"Ready status cleared",faultDeleted:"Fault deleted",recordedFaults:"Recorded Faults",selectBib:"Select Bib",selectGate:"Gate",gate:"Gate",noFaults:"No faults recorded",faultsFor:"Faults for",faultSummary:"Fault Summary",penaltyTime:"Penalty",faultCount:"faults",markOk:"Mark OK",saveFault:"Save Fault",selectFaultType:"Please select a fault type",gateOutOfRange:"Gate is outside assigned range",flt:"FLT",statusFlt:"Fault Penalty",chiefJudge:"Chief Judge",noFaultsRecorded:"No faults recorded",finalize:"Finalize",finalized:"Finalized",chiefJudgeMode:"Chief Judge Mode",chiefJudgeModeEnabled:"Chief Judge mode enabled",chiefJudgeModeDisabled:"Chief Judge mode disabled",racersWithFaults:"Racers with faults",penaltyMode:"+Time",gateJudges:"Gate Judges",noJudgesConnected:"No gate judges connected",summary:"Summary",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"No faults to export",copiedToClipboard:"Copied to clipboard",gateJudgeCard:"Gate Judge Card",race:"Race",date:"Date",gateJudgeLabel:"Gate Judge",runLabel:"Run",noFaultsEntered:"No faults entered",signature:"Signature",legend:"Legend",missedGateLegend:"Missed",straddlingLegend:"Straddling",bindingLegend:"Binding",gateFaults:"Gate Faults",penaltyLabel:"PENALTY",faultSummaryTitle:"GATE FAULT SUMMARY",faults:"Faults",penalty:"Penalty",sec:"sec",generated:"Generated",editFault:"Edit Fault",versionHistory:"Version History",restoreVersion:"Restore Selected Version",currentVersion:"Current",originalVersion:"Original",restored:"Restored",versionRestored:"Version restored",markForDeletion:"Mark for Deletion",markForDeletionText:"This fault will be marked for deletion and requires Chief Judge approval to permanently delete.",markedForDeletion:"Marked for deletion",deletionPending:"Deletion pending",pendingDeletions:"Pending Deletions",approveDeletion:"Approve Deletion",rejectDeletion:"Reject Deletion",deletionMarkedBy:"Marked by",deletionApproved:"Deletion approved",deletionRejected:"Deletion rejected",cannotEditPendingDeletion:"Cannot edit fault pending deletion",voiceMode:"Voice Mode",voiceModeDesc:"Hands-free voice commands (requires internet)",voiceListening:"Listening...",voiceProcessing:"Processing...",voiceConfirming:"Confirm?",voiceOffline:"Voice unavailable offline",voiceNotSupported:"Voice not supported in this browser",voicePermissionDenied:"Microphone access denied",voiceOK:"OK",voiceRecorded:"Recorded",voiceNotUnderstood:"Not understood",voiceCancelled:"Cancelled",voiceError:"Voice error",voiceApiKeyRequired:"API key required for voice mode",pullToRefresh:"Pull to refresh",releaseToRefresh:"Release to refresh",synced:"Synced",syncingStatus:"Syncing...",gateAssignmentInstructions:"Enter the gate range you are responsible for:",readySuffix:" - Ready",viewPhotoLabel:"View photo",editEntryLabel:"Edit entry",deleteEntryLabel:"Delete entry",editFaultLabel:"Edit fault",deleteFaultLabel:"Delete fault",deleteLabel:"Delete",gateNumberLabel:"Gate",numberLabel:"Number",currentTime:"Current time",pinVerifyOnline:"PIN will be verified when online",addNote:"Add Note",done:"Done",recordNote:"Record Note",listening:"Listening...",noteSaved:"Note saved",noteDeleted:"Note deleted",noteCharCount:"characters",voiceNoteUnsupported:"Voice input not supported in this browser",voiceNoteError:"Voice input error",typeNote:"Type or speak your note...",hasNote:"Has note",noteTextLabel:"Note text",recordVoiceNoteLabel:"Record voice note",syncOnline:"Sync online",syncOffline:"Offline",syncShortConnected:"Sync",syncShortSyncing:"Sync...",syncShortError:"Error",syncShortOff:"Off",syncDeviceAbbrev:"dev",sessionExpired:"Session expired. Please re-enter your PIN.",authSuccess:"Authentication successful",keyboardShortcuts:"Keyboard Shortcuts",keyboardShortcutsDesc:"Show all keyboard shortcuts",shortcutSection_timer:"Timer",shortcutSection_gateJudge:"Gate Judge",shortcutSection_results:"Results",shortcutSection_global:"Global",shortcut_enterDigit:"Enter bib digit",shortcut_selectStart:"Select Start",shortcut_selectFinish:"Select Finish",shortcut_selectRun1:"Select Run 1",shortcut_selectRun2:"Select Run 2",shortcut_recordTime:"Record timestamp",shortcut_clearBib:"Clear bib",shortcut_deleteLastDigit:"Delete last digit",shortcut_missedGate:"Missed Gate",shortcut_straddled:"Straddled",shortcut_broken:"Broken gate",shortcut_selectGate:"Select gate",shortcut_navigateBtns:"Navigate buttons",shortcut_confirmSelection:"Confirm selection",shortcut_navigateItems:"Navigate items",shortcut_editItem:"Edit item",shortcut_deleteItem:"Delete item",shortcut_moveTab:"Move between tabs",shortcut_closeModal:"Close modal",shortcut_navigateInComponent:"Navigate in component",shortcut_showShortcuts:"Show shortcuts",offlineBanner:"You are offline. Times will be saved locally.",onlineRestored:"Back online",entryDeleted:"Entry deleted",undoAction:"Undo",multiDeviceDuplicate:"Multi-device",duplicateDevices:"{count} devices",duplicateCount:"{count} duplicates"},de:{timer:"Timer",results:"Ergebnisse",settings:"Einstellungen",start:"Start",finish:"Ziel",startShort:"S",finishShort:"Z",bib:"Startnr.",point:"Punkt",run:"Lauf",run1:"L1",run2:"L2",time:"Zeit erfassen",lastRecorded:"Zuletzt erfasst",lastRecordedShort:"Letzter:",advancedSettings:"Erweiterte Einstellungen",status:"Status",noEntries:"Keine Einträge vorhanden",noEntriesHint:"Zeiten im Timer-Tab aufnehmen",search:"Startnr. suchen...",searchResults:"Ergebnisse durchsuchen",filter:"Filter",all:"Alle",total:"Gesamt",racers:"Fahrer",finished:"Im Ziel",fastest:"Schnellste",average:"Durchschnitt",timeEntry:"Zeit",timeEntries:"Zeiten",faultEntry:"Fehler",faultEntries:"Fehler",ok:"OK",dns:"DNS",dnf:"DNF",dsq:"DSQ",confirmDelete:"Eintrag löschen",confirmDeleteText:"Möchten Sie diesen Eintrag wirklich löschen?",confirmDeleteFault:"Diesen Fehler löschen?",confirmClearAll:"Alle löschen",clearAllText:"Alle Einträge werden gelöscht. Diese Aktion kann nicht rückgängig gemacht werden.",confirmUndoAdd:"Erfassung rückgängig",confirmUndoAddText:"Der erfasste Eintrag wird gelöscht. Fortfahren?",delete:"Löschen",cancel:"Abbrechen",close:"Schließen",back:"Zurück",save:"Speichern",saving:"Speichern...",edit:"Bearbeiten",undo:"Rückgängig",export:"Exportieren",clearAll:"Alle löschen",selectAll:"Alle auswählen",deleteSelected:"Ausgewählte löschen",connected:"Sync",connecting:"...",syncing:"Sync",offline:"X",syncError:"!",syncReceived:"Von Cloud synchronisiert",raceId:"Rennen-ID",invalidRaceId:"Ungültige Rennen-ID. Nur Buchstaben, Zahlen, Bindestriche, Unterstriche.",deviceName:"Zeitnehmer-ID",cloudSync:"Cloud-Sync",syncStatus:"Sync-Status",pendingSync:"ausstehend",raceSetup:"Rennen einrichten",raceSetupDesc:"Erforderlich für Timing und Sync über mehrere Geräte.",firstGateLabel:"Erstes Tor",saved:"Gespeichert",deleted:"Gelöscht",cleared:"Alle Einträge gelöscht",undone:"Rückgängig gemacht",copied:"In Zwischenablage kopiert",debugInfoCopied:"Debug-Info in Zwischenablage kopiert",debugInfoCopyFailed:"Lange drücken um Debug-Info zu kopieren",duplicateWarning:"Doppelter Eintrag erkannt",zeroBibWarning:"Startnr. 000 - Eintrag prüfen",exported:"Erfolgreich exportiert",gps:"GPS",gpsActive:"GPS Aktiv",gpsSearching:"GPS wird gesucht...",gpsInactive:"GPS Inaktiv",gpsAccuracy:"Genauigkeit",settingsRaceSetup:"Rennen einrichten",settingsTimingGroup:"Zeitmessung",settingsSyncGroup:"Synchronisation",settingsFeedbackGroup:"Rückmeldung",settingsDisplayGroup:"Anzeige",simpleMode:"Einfacher Modus",fullMode:"Erweiterter Modus",autoIncrement:"Startnr. automatisch",hapticFeedback:"Vibration",soundFeedback:"Signalton",language:"Sprache",advancedSettingsHint:"Diese Optionen beeinflussen die Zeitmessung. Nur bei Bedarf ändern.",simpleModeDesc:"Vereinfachte Oberfläche für einfache Zeitmessung",cloudSyncDesc:"Mit anderen Geräten synchronisieren",gpsDesc:"GPS für genaue Zeitstempel verwenden",autoIncrementDesc:"Startnr. nach Erfassung erhöhen",photoCaptureDesc:"Foto bei Zeiterfassung aufnehmen",hapticFeedbackDesc:"Vibration bei Aktionen",soundFeedbackDesc:"Akustische Bestätigung",ambientMode:"Ruhemodus",ambientModeDesc:"Nach 30s Inaktivität abdunkeln",photoCapture:"Foto aufnehmen",photoCaptured:"Foto aufgenommen",photoError:"Foto-Aufnahme fehlgeschlagen",photoSaveFailed:"Foto-Speicherung fehlgeschlagen",viewPhoto:"Foto anzeigen",deletePhoto:"Foto löschen",photoFor:"Foto für Startnr.",noPhotoAvailable:"Kein Foto verfügbar",photoDeleted:"Foto gelöscht",raceChangeTitle:"Rennen wechseln",raceChangeSyncedText:"Es gibt Ergebnisse von einem anderen Rennen. Exportieren oder löschen?",raceChangeUnsyncedText:"Es gibt bestehende Ergebnisse. Behalten oder löschen?",keepResults:"Behalten",version:"Version",devices:"Geräte",entries:"Einträge",selected:"ausgewählt",raceFound:"Rennen gefunden",raceNew:"Neues Rennen",entryInCloud:"Eintrag in der Cloud",entriesInCloud:"Einträge in der Cloud",photoTooLarge:"Foto zu groß für Sync",syncedEntriesFromCloud:"{count} Einträge aus Cloud synchronisiert",syncedFaultsFromCloud:"{count} Torfehler aus Cloud synchronisiert",crossDeviceDuplicate:"Duplikat: Startnr. {bib} {point} bereits von {device} erfasst",syncPhotos:"Fotos synchronisieren",syncPhotosDesc:"Fotos über Cloud mit anderen Geräten teilen",syncPhotosWarning:"Foto-Sync aktivieren",syncPhotosWarningText:"Aktivierung der Foto-Synchronisierung überträgt folgende Daten:",photosToUpload:"Fotos hochzuladen",photosToDownload:"Fotos herunterzuladen",totalDataVolume:"Gesamtes Datenvolumen",enableSync:"Sync aktivieren",noPhotosToSync:"Keine Fotos zu synchronisieren",admin:"Admin",adminPin:"Rennverwaltungs-PIN",adminPinDesc:"Erforderlich für Verwaltung und Sync",manageRaces:"Rennen verwalten",manageRacesDesc:"Synchronisierte Rennen anzeigen und löschen",manage:"Verwalten",enterAdminPin:"Rennverwaltungs-PIN eingeben",enterPinText:"Geben Sie Ihre PIN ein, um die Rennverwaltung zu öffnen.",enterPinToJoinRace:"Geben Sie Ihre PIN ein, um diesem Rennen beizutreten.",enterPinForChiefJudge:"Geben Sie Ihre PIN ein, um die Obmann-Ansicht zu öffnen.",enterChiefJudgePin:"Obmann-PIN eingeben",enterPinForChiefJudgeInfo:"Der Obmann-Modus erfordert eine separate PIN. Erste Eingabe setzt die PIN.",syncRequiresPin:"Sync deaktiviert. Aktivieren Sie Sync und geben Sie die PIN ein.",incorrectPin:"Falsche PIN",verify:"Bestätigen",setPinFirst:"Bitte zuerst Rennverwaltungs-PIN festlegen",pinSaved:"PIN gespeichert",pinCleared:"PIN gelöscht",pinNotSet:"Nicht gesetzt",pinSet:"PIN gesetzt",setPin:"PIN setzen",changePin:"PIN ändern",currentPin:"Aktuelle PIN",newPin:"Neue PIN (4 Ziffern)",confirmPin:"PIN bestätigen",pinMismatch:"PINs stimmen nicht überein",pinFormatError:"PIN muss genau 4 Ziffern haben",loading:"Laden...",noRaces:"Keine aktiven Rennen",noRacesHint:"In Einstellungen erstellen",cleanRunHint:"Bisher fehlerfreie Fahrt",refresh:"Aktualisieren",raceDeleted:"Rennen gelöscht",raceDeletedText:"Dieses Rennen wurde von einem Administrator gelöscht.",raceDeletedFor:"Rennen gelöscht:",raceDeletedSuccess:"Rennen gelöscht:",confirmDeleteRace:"Rennen löschen",confirmDeleteRaceText:"Möchten Sie das Rennen wirklich löschen",loadError:"Fehler beim Laden der Rennen. Verbindung prüfen und erneut versuchen.",deleteError:"Fehler beim Löschen des Rennens",entry:"Eintrag",device:"Gerät",storageError:"Speichern fehlgeschlagen - Speicher prüfen",storageQuotaError:"Speicher voll! Daten sofort exportieren",storageWarning:"Speicher fast voll",storageNearlyFull:"Speicher fast voll. Daten exportieren und alte Einträge löschen.",networkError:"Netzwerkfehler - Verbindung prüfen",connectionFailed:"Verbindung fehlgeschlagen",serverUnavailable:"Server nicht erreichbar",rateLimitError:"Zu viele Anfragen - bitte warten",authError:"Authentifizierung fehlgeschlagen. PIN erneut eingeben.",syncFailed:"Synchronisierung fehlgeschlagen",pinSyncFailed:"PIN nicht in Cloud gespeichert",cameraError:"Kamerafehler",cameraPermissionDenied:"Kamerazugriff verweigert",gpsError:"GPS-Fehler",gpsPermissionDenied:"GPS-Zugriff verweigert",gpsUnavailable:"GPS nicht verfügbar",wakeLockFailed:"Bildschirm kann während Zeitmessung abdunkeln",wakeLockIdleTimeout:"Bildschirm wird gedimmt um Akku zu sparen. Tippen zum Wachhalten.",unknownError:"Unbekannter Fehler",onboardingWelcome:"Willkommen bei Ski Race Timer",onboardingWelcomeDesc:"GPS-synchronisierte Zeitmessung für Skirennen",getStarted:"Los geht's",skipSetup:"Überspringen",onboardingRole:"Was ist deine Aufgabe?",onboardingRoleDesc:"Wähle aus, wie du beim Rennen hilfst",roleTimerTitle:"Zeitnehmer",roleTimerDesc:"Du erfasst Start- und Zielzeiten",roleJudgeTitle:"Torrichter",roleJudgeDesc:"Du erfasst Torfehler",onboardingDeviceName:"Timer benennen",onboardingDeviceNameDesc:"Dieser Name identifiziert dein Gerät beim Synchronisieren",onboardingDeviceNameJudge:"Dein Name",onboardingDeviceNameJudgeDesc:"Dies identifiziert dich als Torrichter",onboardingPhoto:"Foto-Dokumentation",onboardingPhotoDesc:"Automatisch ein Foto bei jeder Zeiterfassung aufnehmen. Nützlich zur Überprüfung von Startnr. und bei Unstimmigkeiten.",enablePhotoCapture:"Foto-Aufnahme aktivieren",photoCaptureLabel:"Foto-Aufnahme",onboardingGates:"Deine Tor-Zuweisung",onboardingGatesDesc:"Gib die Tornummern ein, die du beobachtest. Du kannst dies später ändern.",onboardingRaceSetup:"Rennen beitreten",onboardingRaceSetupDesc:"Gib eine Rennen-ID ein um mit anderen Timern zu synchronisieren",skipForNow:"Vorerst überspringen",onboardingReady:"Bereit zur Zeitmessung!",onboardingReadyJudge:"Bereit als Torrichter!",onboardingTip:"Tippe auf den großen blauen Button um Zeiten zu erfassen",onboardingTipJudge:"Tippe auf eine Startnr. um einen Fehler zu erfassen",startTiming:"Zeitmessung starten",startJudging:"Starten",continue:"Weiter",deviceNameLabel:"Gerätename",raceIdLabel:"Rennen-ID",syncStatusLabel:"Cloud-Sync",enabled:"Aktiviert",disabled:"Deaktiviert",showTutorial:"Tutorial anzeigen",showTutorialDesc:"Setup-Assistenten erneut starten",show:"Anzeigen",onboardingComplete:"Einrichtung abgeschlossen!",invalidPin:"PIN muss 4 Ziffern haben",recentRaces:"Letzte Rennen",noRecentRaces:"Keine Rennen von heute",errorOccurred:"Ein Fehler ist aufgetreten",errorRecoveryMessage:"Die App hat einen Fehler festgestellt. Sie können diesen Hinweis schließen und fortfahren, oder die App neu laden.",dismiss:"Schließen",reload:"Neu laden",updateAvailable:"Update verfügbar! Neu laden für die neueste Version.",operationFailed:"Vorgang fehlgeschlagen. Bitte erneut versuchen.",raceIdPlaceholder:"RENNEN-001",deviceNamePlaceholder:"Timer 1",photoForBib:"Foto für Startnr.",gateJudge:"Torrichter",gateJudgeTab:"Tor",deviceRole:"Geräte-Rolle",deviceRoleDesc:"Timer erfasst Zeiten, Torrichter erfasst Fehler",roleTimer:"Zeitnehmer",roleGateJudge:"Torrichter",gateAssignment:"Tor-Zuweisung",noGateAssignment:"Keine Tor-Zuweisung. Bitte zuerst den Torbereich festlegen.",gates:"Tore",gatesFrom:"Von",gatesTo:"Bis",firstGateColor:"Farbe des ersten Tors",colorRed:"Rot",colorBlue:"Blau",changeGates:"Ändern",otherJudges:"Andere Torrichter:",activeBibs:"Auf der Strecke",noBibsOnCourse:"Keine Fahrer auf der Strecke",recordFault:"Fehler erfassen",faultType:"Fehlerart",faultMG:"Tor ausgelassen",faultSTR:"Einfädler",faultBR:"Bindung offen",faultMGShort:"TF",faultSTRShort:"EF",faultBRShort:"BO",orEnterManually:"oder eingeben:",faultRecorded:"Fehler erfasst",signalReady:"Bereit",judgeReady:"Bereit für Rennen!",judgeNotReady:"Bereit-Status zurückgesetzt",faultDeleted:"Fehler gelöscht",recordedFaults:"Erfasste Fehler",selectBib:"Startnr. wählen",selectGate:"Tor",gate:"Tor",noFaults:"Keine Fehler erfasst",faultsFor:"Fehler für",faultSummary:"Fehler-Übersicht",penaltyTime:"Strafzeit",faultCount:"Fehler",markOk:"OK markieren",saveFault:"Fehler speichern",selectFaultType:"Bitte Fehlerart wählen",gateOutOfRange:"Tor liegt außerhalb des zugewiesenen Bereichs",flt:"SZT",statusFlt:"Strafzeit",chiefJudge:"Obmann",noFaultsRecorded:"Keine Fehler erfasst",finalize:"Bestätigen",finalized:"Bestätigt",chiefJudgeMode:"Obmann-Ansicht",chiefJudgeModeEnabled:"Obmann-Ansicht aktiviert",chiefJudgeModeDisabled:"Obmann-Ansicht deaktiviert",racersWithFaults:"Fahrer mit Fehlern",penaltyMode:"+Zeit",gateJudges:"Torrichter",noJudgesConnected:"Keine Torrichter verbunden",summary:"Übersicht",exportCSV:"CSV",exportWhatsApp:"WhatsApp",noFaultsToExport:"Keine Fehler zum Exportieren",copiedToClipboard:"In Zwischenablage kopiert",gateJudgeCard:"Torrichterkarte",race:"Rennen",date:"Datum",gateJudgeLabel:"Torrichter",runLabel:"Lauf",noFaultsEntered:"Keine Fehler erfasst",signature:"Unterschrift",legend:"Legende",missedGateLegend:"Ausgelassen",straddlingLegend:"Einfädler",bindingLegend:"Bindung",gateFaults:"Torfehler",penaltyLabel:"STRAFZEIT",faultSummaryTitle:"ZUSAMMENFASSUNG TORFEHLER",faults:"Fehler",penalty:"Strafzeit",sec:"Sek",generated:"Erstellt",editFault:"Fehler bearbeiten",versionHistory:"Versionshistorie",restoreVersion:"Version wiederherstellen",currentVersion:"Aktuell",originalVersion:"Original",restored:"Wiederhergestellt",versionRestored:"Version wiederhergestellt",markForDeletion:"Zum Löschen markieren",markForDeletionText:"Dieser Fehler wird zum Löschen markiert und benötigt die Genehmigung des Obmanns für die endgültige Löschung.",markedForDeletion:"Zum Löschen markiert",deletionPending:"Löschung ausstehend",pendingDeletions:"Ausstehende Löschungen",approveDeletion:"Löschung genehmigen",rejectDeletion:"Löschung ablehnen",deletionMarkedBy:"Markiert von",deletionApproved:"Löschung genehmigt",deletionRejected:"Löschung abgelehnt",cannotEditPendingDeletion:"Fehler mit ausstehender Löschung kann nicht bearbeitet werden",voiceMode:"Sprachsteuerung",voiceModeDesc:"Freihändige Sprachbefehle (Internet erforderlich)",voiceListening:"Höre zu...",voiceProcessing:"Verarbeite...",voiceConfirming:"Bestätigen?",voiceOffline:"Sprache offline nicht verfügbar",voiceNotSupported:"Spracheingabe in diesem Browser nicht unterstützt",voicePermissionDenied:"Mikrofonzugriff verweigert",voiceOK:"OK",voiceRecorded:"Erfasst",voiceNotUnderstood:"Nicht verstanden",voiceCancelled:"Abgebrochen",voiceError:"Sprachfehler",voiceApiKeyRequired:"API-Schlüssel für Sprachsteuerung erforderlich",pullToRefresh:"Zum Aktualisieren ziehen",releaseToRefresh:"Loslassen zum Aktualisieren",synced:"Synchronisiert",syncingStatus:"Synchronisiere...",gateAssignmentInstructions:"Gib den Torbereich ein, für den du verantwortlich bist:",readySuffix:" - Bereit",viewPhotoLabel:"Foto anzeigen",editEntryLabel:"Eintrag bearbeiten",deleteEntryLabel:"Eintrag löschen",editFaultLabel:"Fehler bearbeiten",deleteFaultLabel:"Fehler löschen",deleteLabel:"Löschen",gateNumberLabel:"Tor",numberLabel:"Zahl",currentTime:"Aktuelle Uhrzeit",pinVerifyOnline:"PIN wird online überprüft",addNote:"Notiz hinzufügen",done:"Fertig",recordNote:"Notiz aufnehmen",listening:"Höre zu...",noteSaved:"Notiz gespeichert",noteDeleted:"Notiz gelöscht",noteCharCount:"Zeichen",voiceNoteUnsupported:"Spracheingabe in diesem Browser nicht unterstützt",voiceNoteError:"Spracheingabe-Fehler",typeNote:"Notiz eintippen oder sprechen...",hasNote:"Hat Notiz",noteTextLabel:"Notiztext",recordVoiceNoteLabel:"Sprachnotiz aufnehmen",syncOnline:"Sync online",syncOffline:"Offline",syncShortConnected:"Sync",syncShortSyncing:"Sync...",syncShortError:"Fehler",syncShortOff:"Aus",syncDeviceAbbrev:"G",sessionExpired:"Sitzung abgelaufen. Bitte PIN erneut eingeben.",authSuccess:"Authentifizierung erfolgreich",keyboardShortcuts:"Tastenkürzel",keyboardShortcutsDesc:"Alle Tastenkürzel anzeigen",shortcutSection_timer:"Timer",shortcutSection_gateJudge:"Torrichter",shortcutSection_results:"Ergebnisse",shortcutSection_global:"Allgemein",shortcut_enterDigit:"Startnr.-Ziffer eingeben",shortcut_selectStart:"Start wählen",shortcut_selectFinish:"Ziel wählen",shortcut_selectRun1:"Lauf 1 wählen",shortcut_selectRun2:"Lauf 2 wählen",shortcut_recordTime:"Zeitstempel erfassen",shortcut_clearBib:"Startnr. löschen",shortcut_deleteLastDigit:"Letzte Ziffer löschen",shortcut_missedGate:"Tor ausgelassen",shortcut_straddled:"Einfädler",shortcut_broken:"Bindung offen",shortcut_selectGate:"Tor wählen",shortcut_navigateBtns:"Buttons navigieren",shortcut_confirmSelection:"Auswahl bestätigen",shortcut_navigateItems:"Einträge navigieren",shortcut_editItem:"Eintrag bearbeiten",shortcut_deleteItem:"Eintrag löschen",shortcut_moveTab:"Zwischen Tabs wechseln",shortcut_closeModal:"Dialog schließen",shortcut_navigateInComponent:"In Komponente navigieren",shortcut_showShortcuts:"Tastenkürzel anzeigen",offlineBanner:"Offline. Zeiten werden lokal gespeichert.",onlineRestored:"Wieder online",entryDeleted:"Eintrag gelöscht",undoAction:"Rückgängig",multiDeviceDuplicate:"Mehrere Geräte",duplicateDevices:"{count} Geräte",duplicateCount:"{count} Duplikate"}};function p(n,e="de"){const t=Ke[e],i=Ke.en;return t[n]||i[n]||n}const u={debug:()=>{},log:()=>{},info:()=>{},warn:console.warn.bind(console),error:console.error.bind(console)},Ut=.3,Gt=.15,Jt=.05;class jt{constructor(){c(this,"battery",null);c(this,"isInitialized",!1);c(this,"callbacks",new Set);c(this,"currentStatus",{level:1,charging:!0,batteryLevel:"normal"});c(this,"levelChangeHandler",null);c(this,"chargingChangeHandler",null)}isSupported(){return"getBattery"in navigator}async initialize(){if(this.isInitialized)return!0;if(!this.isSupported())return!1;try{return this.battery=await navigator.getBattery(),this.isInitialized=!0,this.updateStatus(),this.levelChangeHandler=()=>this.updateStatus(),this.chargingChangeHandler=()=>this.updateStatus(),this.battery.addEventListener("levelchange",this.levelChangeHandler),this.battery.addEventListener("chargingchange",this.chargingChangeHandler),!0}catch(e){return u.warn("Failed to initialize battery service:",e),!1}}updateStatus(){if(!this.battery)return;const e=this.battery.level,t=this.battery.charging;let i="normal";t||(e<=Jt?i="critical":e<=Gt?i="low":e<=Ut&&(i="medium"));const s={level:e,charging:t,batteryLevel:i},r=this.currentStatus.level!==s.level||this.currentStatus.charging!==s.charging||this.currentStatus.batteryLevel!==s.batteryLevel;this.currentStatus=s,r&&this.notifySubscribers()}notifySubscribers(){for(const e of this.callbacks)try{e(this.currentStatus)}catch(t){u.error("Battery callback error:",t)}}subscribe(e){return this.callbacks.add(e),e(this.currentStatus),()=>{this.callbacks.delete(e)}}getStatus(){return{...this.currentStatus}}isLowBattery(){return this.currentStatus.batteryLevel==="low"||this.currentStatus.batteryLevel==="critical"}isCriticalBattery(){return this.currentStatus.batteryLevel==="critical"}isCharging(){return this.currentStatus.charging}getLevelPercent(){return Math.round(this.currentStatus.level*100)}cleanup(){this.battery&&(this.levelChangeHandler&&(this.battery.removeEventListener("levelchange",this.levelChangeHandler),this.levelChangeHandler=null),this.chargingChangeHandler&&(this.battery.removeEventListener("chargingchange",this.chargingChangeHandler),this.chargingChangeHandler=null),this.battery=null),this.callbacks.clear(),this.isInitialized=!1}}const A=new jt;class Qt{constructor(){c(this,"isInitialized",!1);c(this,"isEnabled",!1);c(this,"isAmbientActive",!1);c(this,"triggeredBy",null);c(this,"lastActivityTimestamp",Date.now());c(this,"inactivityCheckId",null);c(this,"batteryUnsubscribe",null);c(this,"callbacks",new Set);c(this,"activityHandler",null);c(this,"INACTIVITY_THRESHOLD_MS",3e4)}initialize(){this.isInitialized||(this.isInitialized=!0,this.batteryUnsubscribe=A.subscribe(e=>{e.batteryLevel==="critical"&&!e.charging&&this.isEnabled&&this.enterAmbientMode("battery"),e.charging&&this.isAmbientActive&&this.triggeredBy==="battery"&&this.exitAmbientMode()}),this.activityHandler=()=>this.resetInactivityTimer(),document.addEventListener("touchstart",this.activityHandler,{passive:!0}),document.addEventListener("click",this.activityHandler,{passive:!0}),document.addEventListener("keydown",this.activityHandler,{passive:!0}))}cleanup(){this.disable(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.activityHandler&&(document.removeEventListener("touchstart",this.activityHandler),document.removeEventListener("click",this.activityHandler),document.removeEventListener("keydown",this.activityHandler),this.activityHandler=null),this.callbacks.clear(),this.isInitialized=!1}enable(){this.isEnabled||(this.isEnabled=!0,this.lastActivityTimestamp=Date.now(),this.startInactivityMonitor(),A.isCriticalBattery()&&this.enterAmbientMode("battery"))}disable(){this.isEnabled&&(this.isEnabled=!1,this.stopInactivityMonitor(),this.isAmbientActive&&this.exitAmbientMode())}isActive(){return this.isAmbientActive}getState(){return{isActive:this.isAmbientActive,triggeredBy:this.triggeredBy}}subscribe(e){return this.callbacks.add(e),e(this.getState()),()=>{this.callbacks.delete(e)}}exitAmbientMode(){this.isAmbientActive&&(this.isAmbientActive=!1,this.triggeredBy=null,this.lastActivityTimestamp=Date.now(),this.notifySubscribers(),u.debug("[Ambient] Exited ambient mode"))}resetInactivityTimer(){this.lastActivityTimestamp=Date.now(),this.isAmbientActive}enterAmbientMode(e){this.isAmbientActive||!this.isEnabled||(this.isAmbientActive=!0,this.triggeredBy=e,this.notifySubscribers(),u.debug(`[Ambient] Entered ambient mode (trigger: ${e})`))}startInactivityMonitor(){this.inactivityCheckId===null&&(this.inactivityCheckId=setInterval(()=>{if(!this.isEnabled)return;Date.now()-this.lastActivityTimestamp>=this.INACTIVITY_THRESHOLD_MS&&!this.isAmbientActive&&this.enterAmbientMode("inactivity")},5e3))}stopInactivityMonitor(){this.inactivityCheckId!==null&&(clearInterval(this.inactivityCheckId),this.inactivityCheckId=null)}notifySubscribers(){const e=this.getState();for(const t of this.callbacks)try{t(e)}catch(i){u.error("[Ambient] Callback error:",i)}}}const $r=new Qt,qt=typeof requestIdleCallback=="function"?n=>requestIdleCallback(n):n=>setTimeout(n,50),Xe=typeof cancelIdleCallback=="function"?n=>cancelIdleCallback(n):n=>clearTimeout(n);class Wt{constructor(){c(this,"cache",new Map);c(this,"pendingWrites",new Map);c(this,"flushId",null)}get(e){if(this.cache.has(e)){const t=this.cache.get(e);try{return JSON.parse(t)}catch{return null}}try{const t=localStorage.getItem(e);return t===null?null:(this.cache.set(e,t),JSON.parse(t))}catch{return null}}set(e,t){const i=JSON.stringify(t);this.cache.set(e,i),this.pendingWrites.set(e,i),this.scheduleFlush()}remove(e){this.cache.delete(e),this.pendingWrites.set(e,null),this.scheduleFlush()}setRaw(e,t){this.cache.set(e,t),this.pendingWrites.set(e,t),this.scheduleFlush()}getRaw(e){if(this.cache.has(e))return this.cache.get(e);try{const t=localStorage.getItem(e);return t!==null&&this.cache.set(e,t),t}catch{return null}}scheduleFlush(){this.flushId===null&&(this.flushId=qt(()=>this.flush()))}flush(){this.flushId!==null&&(Xe(this.flushId),this.flushId=null);const e=new Map(this.pendingWrites);this.pendingWrites.clear();let t=null;for(const[i,s]of e)try{s===null?localStorage.removeItem(i):localStorage.setItem(i,s)}catch(r){u.error(`Storage write failed for key "${i}":`,r),t===null&&(t=r)}if(t!==null)throw t}hasPendingWrites(){return this.pendingWrites.size>0}clearCache(){this.cache.clear(),this.pendingWrites.clear(),this.flushId!==null&&(Xe(this.flushId),this.flushId=null)}}const b=new Wt,Se=2;function Yt(n){const e=new Uint8Array(Math.ceil(n/2));return crypto.getRandomValues(e),Array.from(e,t=>t.toString(16).padStart(2,"0")).join("").slice(0,n)}function Br(n){var i;const e=Date.now(),t=((i=crypto.randomUUID)==null?void 0:i.call(crypto).slice(0,8))??Yt(8);return`${n}-${e}-${t}`}const we=["swift","bold","cool","fast","keen","wild","calm","warm","bright","sharp","quick","brave","fresh","grand","prime","clear","snow","ice","frost","peak","alpine","polar","winter","crisp"],Ee=["fox","bear","wolf","hawk","eagle","tiger","lion","deer","pine","oak","cedar","birch","maple","spruce","aspen","willow","peak","ridge","slope","trail","summit","valley","glacier","cliff"];function et(n){return n.charAt(0).toUpperCase()+n.slice(1)}function Zt(){const n=we[Math.floor(Math.random()*we.length)],e=Ee[Math.floor(Math.random()*Ee.length)],t=Math.floor(Math.random()*100);return`dev_${n}-${e}-${t}`}function Pe(){const n=we[Math.floor(Math.random()*we.length)],e=Ee[Math.floor(Math.random()*Ee.length)],t=Math.floor(Math.random()*100);return`${et(n)} ${et(e)} ${t}`}const Kt=20;function Oe(n){return n==="indexeddb"}function He(n){return!!n&&n!=="indexeddb"&&n.length>Kt}const tt=5*1024*1024,Xt=80;function en(){let n=0;try{for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e);if(t){const i=localStorage.getItem(t);n+=(t.length+((i==null?void 0:i.length)??0))*2}}}catch{}return n}function Ct(){const n=en(),e=Math.round(n/tt*100),t=e>=Xt;return{usageBytes:n,estimatedQuota:tt,usagePercent:e,warning:t}}function xr(){const{usageBytes:n,usagePercent:e}=Ct(),t=(n/1024).toFixed(1);u.debug(`[Storage] localStorage usage: ${t} KB (${e}% of ~5MB)`)}const tn=["S","F"],nn=["ok","dns","dnf","dsq","flt"],kt=["MG","STR","BR"],sn=50,rn=10;function an(n){return!n||typeof n!="string"||n.length>sn?!1:/^[a-zA-Z0-9_-]+$/.test(n)}function ae(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"&&typeof e.id!="number"||typeof e.id=="string"&&e.id.length===0||typeof e.id=="number"&&e.id<=0||e.bib!==void 0&&typeof e.bib!="string"||typeof e.bib=="string"&&e.bib.length>rn||!tn.includes(e.point)||!e.timestamp||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||e.status!==void 0&&!nn.includes(e.status)||e.deviceId!==void 0&&typeof e.deviceId!="string"||e.deviceName!==void 0&&typeof e.deviceName!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||e.syncedAt<0||!Number.isFinite(e.syncedAt))||e.photo!==void 0&&typeof e.photo!="string"||e.timeSource!==void 0&&e.timeSource!=="gps"&&e.timeSource!=="system"||e.gpsTimestamp!==void 0&&(typeof e.gpsTimestamp!="number"||!Number.isFinite(e.gpsTimestamp)))return!1;if(e.gpsCoords!==void 0){if(typeof e.gpsCoords!="object"||e.gpsCoords===null)return!1;const t=e.gpsCoords;if(typeof t.latitude!="number"||!Number.isFinite(t.latitude)||typeof t.longitude!="number"||!Number.isFinite(t.longitude)||typeof t.accuracy!="number"||!Number.isFinite(t.accuracy)||t.accuracy<0)return!1}return!0}function on(n){return!n||typeof n!="string"?!1:n.startsWith("dev_")&&n.length>4}function Rt(n){return typeof n=="number"&&Number.isInteger(n)&&n>=1}const cn=["create","edit","restore"];function ln(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.version!="number"||!Number.isInteger(e.version)||e.version<1||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||typeof e.editedBy!="string"||e.editedBy.length>100||typeof e.editedByDeviceId!="string"||e.editedByDeviceId.length>100||!cn.includes(e.changeType)||!e.data||typeof e.data!="object")return!1;const t=e.data;return!(typeof t.id!="string"||typeof t.bib!="string"||t.bib.length>10||!Rt(t.run)||typeof t.gateNumber!="number"||!Number.isInteger(t.gateNumber)||t.gateNumber<0||!kt.includes(t.faultType)||typeof t.timestamp!="string"||Number.isNaN(Date.parse(t.timestamp))||typeof t.deviceId!="string"||typeof t.deviceName!="string"||t.deviceName.length>100||!Array.isArray(t.gateRange)||t.gateRange.length!==2||typeof t.gateRange[0]!="number"||typeof t.gateRange[1]!="number"||!Number.isInteger(t.gateRange[0])||!Number.isInteger(t.gateRange[1])||e.changeDescription!==void 0&&typeof e.changeDescription!="string"||typeof e.changeDescription=="string"&&e.changeDescription.length>500)}function dn(n){if(!n||typeof n!="object")return!1;const e=n;if(typeof e.id!="string"||e.id.length===0||typeof e.bib!="string"||e.bib.length>10||typeof e.deviceId!="string"||typeof e.deviceName!="string"||e.deviceName.length>100||typeof e.timestamp!="string"||Number.isNaN(Date.parse(e.timestamp))||!Rt(e.run)||typeof e.gateNumber!="number"||!Number.isInteger(e.gateNumber)||e.gateNumber<0||!kt.includes(e.faultType)||!Array.isArray(e.gateRange)||e.gateRange.length!==2||typeof e.gateRange[0]!="number"||typeof e.gateRange[1]!="number"||!Number.isInteger(e.gateRange[0])||!Number.isInteger(e.gateRange[1])||typeof e.currentVersion!="number"||!Number.isInteger(e.currentVersion)||e.currentVersion<1||!Array.isArray(e.versionHistory))return!1;for(const t of e.versionHistory)if(!ln(t))return!1;return!(typeof e.markedForDeletion!="boolean"||e.markedForDeletionAt!==void 0&&(typeof e.markedForDeletionAt!="string"||Number.isNaN(Date.parse(e.markedForDeletionAt)))||e.deletionApprovedAt!==void 0&&(typeof e.deletionApprovedAt!="string"||Number.isNaN(Date.parse(e.deletionApprovedAt)))||e.markedForDeletionBy!==void 0&&typeof e.markedForDeletionBy!="string"||e.markedForDeletionByDeviceId!==void 0&&typeof e.markedForDeletionByDeviceId!="string"||e.deletionApprovedBy!==void 0&&typeof e.deletionApprovedBy!="string"||e.syncedAt!==void 0&&(typeof e.syncedAt!="number"||!Number.isFinite(e.syncedAt)))}function un(n){if(!dn(n))return null;const e=n,t=e.versionHistory.map(i=>({...i,editedBy:R(i.editedBy,100),editedByDeviceId:R(i.editedByDeviceId,100),changeDescription:i.changeDescription?R(i.changeDescription,500):void 0,data:{...i.data,bib:R(i.data.bib,10),deviceId:R(i.data.deviceId,100),deviceName:R(i.data.deviceName,100)}}));return{...e,bib:R(e.bib,10),deviceId:R(e.deviceId,100),deviceName:R(e.deviceName,100),markedForDeletionBy:e.markedForDeletionBy?R(e.markedForDeletionBy,100):void 0,markedForDeletionByDeviceId:e.markedForDeletionByDeviceId?R(e.markedForDeletionByDeviceId,100):void 0,deletionApprovedBy:e.deletionApprovedBy?R(e.deletionApprovedBy,100):void 0,versionHistory:t}}function hn(n){if(!n||typeof n!="object")return!1;const e=n;return!(!ae(e.entry)||typeof e.retryCount!="number"||e.retryCount<0||typeof e.lastAttempt!="number"||e.lastAttempt<0)}function R(n,e=100){return!n||typeof n!="string"?"":n.slice(0,e).replace(/[<>"'&]/g,"").replace(/[\x00-\x1F\x7F]/g,"")}function fn(n,e){if(!ae(n))return null;const t=n;return{id:(typeof t.id=="number",String(t.id)),bib:R(t.bib,10),point:t.point,run:t.run??1,timestamp:t.timestamp,status:t.status||"ok",deviceId:R(t.deviceId||e,50),deviceName:R(t.deviceName||"Unknown Device",100),syncedAt:t.syncedAt,photo:t.photo,gpsCoords:t.gpsCoords}}function gn(n,e){const t={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};if(!n||typeof n!="object")return{version:Se,entries:[],settings:t,deviceId:e,deviceName:Pe(),raceId:"",syncQueue:[]};const i=n;let s=[];Array.isArray(i.entries)&&(s=i.entries.map(o=>fn(o,e)).filter(o=>o!==null));let r=t;if(i.settings&&typeof i.settings=="object"){const o=i.settings;r={auto:typeof o.auto=="boolean"?o.auto:t.auto,haptic:typeof o.haptic=="boolean"?o.haptic:t.haptic,sound:typeof o.sound=="boolean"?o.sound:t.sound,sync:typeof o.sync=="boolean"?o.sync:t.sync,syncPhotos:typeof o.syncPhotos=="boolean"?o.syncPhotos:t.syncPhotos,gps:typeof o.gps=="boolean"?o.gps:t.gps,simple:typeof o.simple=="boolean"?o.simple:t.simple,photoCapture:typeof o.photoCapture=="boolean"?o.photoCapture:t.photoCapture,motionEffects:typeof o.motionEffects=="boolean"?o.motionEffects:t.motionEffects,glassEffects:typeof o.glassEffects=="boolean"?o.glassEffects:t.glassEffects,outdoorMode:typeof o.outdoorMode=="boolean"?o.outdoorMode:t.outdoorMode,ambientMode:typeof o.ambientMode=="boolean"?o.ambientMode:t.ambientMode}}let a=[];return Array.isArray(i.syncQueue)&&(a=i.syncQueue.filter(hn)),{version:Se,entries:s,settings:r,deviceId:on(i.deviceId)?i.deviceId:e,deviceName:R(i.deviceName,100)||Pe(),raceId:an(i.raceId)?i.raceId:"",syncQueue:a,lastExport:typeof i.lastExport=="number"?i.lastExport:void 0}}function _r(n,e){n.addEventListener("input",()=>{n.value=n.value.replace(/[^0-9]/g,""),e!==void 0&&(n.value=n.value.slice(0,e))})}const pn=50;function mn(n,e,t,i){const s=[...n,e],r=ue(t,{type:"ADD_ENTRY",data:e,timestamp:Date.now()});return{entries:s,undoStack:r,redoStack:[]}}function yn(n,e,t,i){const s=n.find(a=>a.id===e);if(!s)return null;const r=ue(t,{type:"DELETE_ENTRY",data:s,timestamp:Date.now()});return{entries:n.filter(a=>a.id!==e),undoStack:r,redoStack:[]}}function vn(n,e,t,i){const s=n.filter(a=>e.includes(a.id));if(s.length===0)return null;const r=ue(t,{type:"DELETE_MULTIPLE",data:s,timestamp:Date.now()});return{entries:n.filter(a=>!e.includes(a.id)),undoStack:r,redoStack:[]}}function bn(n,e,t){if(n.length===0)return null;const i=ue(e,{type:"CLEAR_ALL",data:[...n],timestamp:Date.now()});return{entries:[],undoStack:i,redoStack:[]}}function Sn(n,e,t,i,s){const r=n.findIndex(f=>f.id===e);if(r===-1)return null;const a=n[r],o={...a,...t},d=ue(i,{type:"UPDATE_ENTRY",data:a,newData:o,timestamp:Date.now()}),h=[...n];return h[r]=o,{entries:h,undoStack:d,redoStack:[]}}function ue(n,e){const t=[...n,e];return t.length>pn&&t.shift(),t}function wn(n,e,t){if(e.length===0)return{entries:n,undoStack:e,redoStack:t,result:null};const i=[...e],s=i.pop(),r=[...t,s];let a=[...n],o=null;switch(s.type){case"ADD_ENTRY":{const d=s.data;a=a.filter(h=>h.id!==d.id),o=d;break}case"DELETE_ENTRY":{const d=s.data;a.push(d),a.sort((h,f)=>new Date(h.timestamp).getTime()-new Date(f.timestamp).getTime()),o=d;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const d=s.data;a=[...a,...d],a.sort((h,f)=>new Date(h.timestamp).getTime()-new Date(f.timestamp).getTime()),o=d;break}case"UPDATE_ENTRY":{const d=s.data,h=a.findIndex(f=>f.id===d.id);h!==-1&&(a[h]=d),o=d;break}}return{entries:a,undoStack:i,redoStack:r,result:o?{type:s.type,data:o}:null}}function En(n,e,t){if(t.length===0)return{entries:n,undoStack:e,redoStack:t,result:null};const i=[...t],s=i.pop(),r=[...e,s];let a=[...n],o=null;switch(s.type){case"ADD_ENTRY":{const d=s.data;a.push(d),a.sort((h,f)=>new Date(h.timestamp).getTime()-new Date(f.timestamp).getTime()),o=d;break}case"DELETE_ENTRY":{const d=s.data;a=a.filter(h=>h.id!==d.id),o=d;break}case"DELETE_MULTIPLE":case"CLEAR_ALL":{const d=s.data,h=new Set(d.map(f=>f.id));a=a.filter(f=>!h.has(f.id)),o=d;break}case"UPDATE_ENTRY":{const d=s.data,h=s.newData,f=a.findIndex(g=>g.id===d.id);f!==-1&&h&&(a[f]=h),o=h||d;break}}return{entries:a,undoStack:r,redoStack:i,result:o}}function In(n,e){const t={entry:e,retryCount:0,lastAttempt:0};return[...n,t]}function Tn(n,e){return n.filter(t=>t.entry.id!==e)}function Cn(n,e,t){return n.map(i=>i.entry.id===e?{...i,...t}:i)}function kn(n,e,t,i){let s=0;const r=new Set(n.map(d=>`${d.id}-${d.deviceId}`)),a=new Set(t),o=[];for(const d of e){if(!ae(d)||d.deviceId===i)continue;const h=`${d.id}:${d.deviceId}`;if(a.has(h)||a.has(d.id))continue;const f=`${d.id}-${d.deviceId}`;r.has(f)||(o.push({...d,run:d.run??1}),r.add(f),s++)}if(o.length>0){const d=[...n,...o];return d.sort((h,f)=>new Date(h.timestamp).getTime()-new Date(f.timestamp).getTime()),{entries:d,addedCount:s}}return{entries:n,addedCount:s}}function Rn(n,e){const t=new Set(e);let i=0;return{entries:n.filter(r=>{const a=`${r.id}:${r.deviceId}`;return t.has(a)||t.has(r.id)?(i++,!1):!0}),removedCount:i}}const nt=50;function Ve(n){return{id:n.id,bib:n.bib,run:n.run,gateNumber:n.gateNumber,faultType:n.faultType,timestamp:n.timestamp,deviceId:n.deviceId,deviceName:n.deviceName,gateRange:n.gateRange,syncedAt:n.syncedAt,notes:n.notes,notesSource:n.notesSource,notesTimestamp:n.notesTimestamp}}function Ie(n,e,t,i,s,r){return{version:n,timestamp:new Date().toISOString(),editedBy:i,editedByDeviceId:s,changeType:e,data:t,changeDescription:r}}function ze(n,e){const t=[...n||[],e];return t.length>nt?t.slice(-nt):t}function An(n,e){const t=Ie(1,"create",Ve(e),e.deviceName,e.deviceId),i={...e,currentVersion:1,versionHistory:[t],markedForDeletion:!1};return[...n,i]}function Dn(n,e){return n.filter(t=>t.id!==e)}function Ln(n,e,t){const i=n.findIndex(r=>r.id===e);if(i===-1)return null;const s=[...n];return s[i]={...s[i],...t},s}function Pn(n,e,t,i,s,r){const a=n.findIndex(y=>y.id===e);if(a===-1)return null;const o=n[a];if(o.markedForDeletion)return null;const d=o.currentVersion+1,h={...o,...t},f=Ie(d,"edit",Ve(h),i,s,r),g=[...n];return g[a]={...h,currentVersion:d,versionHistory:ze(o.versionHistory,f)},g}function Fn(n,e,t,i,s){var g;const r=n.findIndex(y=>y.id===e);if(r===-1)return null;const a=n[r];if(a.markedForDeletion)return null;const o=(g=a.versionHistory)==null?void 0:g.find(y=>y.version===t);if(!o)return null;const d=a.currentVersion+1,h=Ie(d,"restore",{...o.data},i,s,`Restored to version ${t}`),f=[...n];return f[r]={...a,bib:o.data.bib,run:o.data.run,gateNumber:o.data.gateNumber,faultType:o.data.faultType,notes:o.data.notes,notesSource:o.data.notesSource,notesTimestamp:o.data.notesTimestamp,currentVersion:d,versionHistory:ze(a.versionHistory,h)},f}function Nn(n,e,t,i){const s=n.findIndex(a=>a.id===e);if(s===-1)return null;const r=[...n];return r[s]={...r[s],markedForDeletion:!0,markedForDeletionAt:new Date().toISOString(),markedForDeletionBy:t,markedForDeletionByDeviceId:i},r}function Mn(n,e,t){const i=n.find(r=>r.id===e);if(!i||!i.markedForDeletion)return{faultEntries:n,approvedFault:null};const s={...i,deletionApprovedAt:new Date().toISOString(),deletionApprovedBy:t};return{faultEntries:n.filter(r=>r.id!==e),approvedFault:s}}function $n(n,e,t,i){const s=n.findIndex(h=>h.id===e);if(s===-1)return null;const r=n[s],a=r.currentVersion+1,o=Ie(a,"edit",Ve(r),t,i,"Deletion rejected by Chief Judge"),d=[...n];return d[s]={...d[s],markedForDeletion:!1,markedForDeletionAt:void 0,markedForDeletionBy:void 0,markedForDeletionByDeviceId:void 0,currentVersion:a,versionHistory:ze(r.versionHistory,o)},d}function Bn(n){return n.filter(e=>e.markedForDeletion)}function xn(n,e,t){return n.filter(i=>i.bib===e&&i.run===t)}function _n(n,e){const t=n.findIndex(s=>s.id===e);if(t===-1)return n;const i=[...n];return i[t]={...i[t],syncedAt:Date.now()},i}function On(n,e,t,i){let s=0,r=0;const a=new Map(n.map(f=>[`${f.id}-${f.deviceId}`,f])),o=new Set(t),d=[],h=[];for(const f of e){const g=un(f);if(!g){u.warn("Skipping invalid fault from cloud:",f);continue}if(g.deviceId===i)continue;const y=`${g.id}:${g.deviceId}`;if(o.has(y)||o.has(g.id))continue;const v=`${g.id}-${g.deviceId}`,m=a.get(v);if(m){const E=g.currentVersion||1,C=m.currentVersion||1;(E>C||g.markedForDeletion!==m.markedForDeletion)&&(h.push(g),r++)}else d.push(g),s++}if(d.length>0||h.length>0){let f=[...n];for(const g of h){const y=`${g.id}-${g.deviceId}`,v=f.findIndex(m=>`${m.id}-${m.deviceId}`===y);v!==-1&&(f[v]=g)}return f=[...f,...d],f.sort((g,y)=>new Date(g.timestamp).getTime()-new Date(y.timestamp).getTime()),{faultEntries:f,addedCount:s+r}}return{faultEntries:n,addedCount:0}}function Hn(n,e){const t=new Set(e);let i=0;return{faultEntries:n.filter(r=>{const a=`${r.id}:${r.deviceId}`;return t.has(a)||t.has(r.id)?(i++,!1):!0}),removedCount:i}}function Vn(n){return{deviceRole:n}}function zn(n){return{gateAssignment:n}}function Un(n){return{firstGateColor:n}}function Gn(n,e,t){if(!e)return t;const[i]=e;return(n-i)%2===0?t:t==="red"?"blue":"red"}function Jn(n){return{selectedFaultBib:n}}function jn(n){return{isJudgeReady:n}}function Qn(n){return{isJudgeReady:!n}}function qn(n){return{isChiefJudgeView:n}}function Wn(n){return{isChiefJudgeView:!n}}function Yn(n,e,t){const i=`${n}-${e}`,s=new Set(t);return s.add(i),{finalizedRacers:s}}function Zn(n,e,t){const i=`${n}-${e}`,s=new Set(t);return s.delete(i),{finalizedRacers:s}}function Kn(n,e,t){const i=`${n}-${e}`;return t.has(i)}function Xn(){return{finalizedRacers:new Set}}function ei(n){return{penaltySeconds:Math.max(0,Math.min(60,n))}}function ti(n){return{usePenaltyMode:n}}function ni(n,e){const t=n.filter(a=>a.point==="S"&&a.run===e),i=n.filter(a=>a.point==="F"&&a.run===e),s=new Set(i.map(a=>a.bib)),r=new Set(t.filter(a=>!s.has(a.bib)).map(a=>a.bib));return Array.from(r).sort((a,o)=>parseInt(a,10)-parseInt(o,10))}const it={auto:!0,haptic:!0,sound:!1,sync:!1,syncPhotos:!1,gps:!0,simple:!1,photoCapture:!1,motionEffects:!0,glassEffects:!0,outdoorMode:!1,ambientMode:!0};function ii(n,e){return{...n,...e}}function si(n,e){return{...n,[e]:!n[e]}}function ri(n){return{syncStatus:n}}function ai(n,e){return{raceId:n,clearUndoRedo:n!==e}}function oi(n){return{lastSyncedRaceId:n}}function ci(n){return{deviceName:n}}const li=12e4;function di(n,e){const t=Date.now(),i=new Map;for(const[s,r]of e)t-r.lastSeen<li&&i.set(s,r);return i.set(n.id,n),{connectedDevices:i}}function ui(n,e){const t=new Map(e);return t.delete(n),{connectedDevices:t}}function hi(n){return{cloudDeviceCount:n}}function fi(n){return{cloudHighestBib:n}}function gi(n){return{raceExistsInCloud:n}}function pi(n){return{currentView:n}}function mi(n){return{currentLang:n}}function yi(n){return{bibInput:n.replace(/\D/g,"").slice(0,3)}}function vi(n){return{selectedPoint:n}}function bi(n){return{selectedRun:n}}function Si(n,e){return{selectMode:n,selectedEntries:n?e:new Set}}function wi(n,e){const t=new Set(e);return t.has(n)?t.delete(n):t.add(n),{selectedEntries:t,selectMode:t.size>0}}function Ei(n){return{selectedEntries:new Set(n),selectMode:!0}}function Ii(){return{selectedEntries:new Set,selectMode:!1}}function Ti(n){return{isRecording:n}}const I={ENTRIES:"skiTimerEntries",SETTINGS:"skiTimerSettings",LANG:"skiTimerLang",DEVICE_ID:"skiTimerDeviceId",DEVICE_NAME:"skiTimerDeviceName",RACE_ID:"skiTimerRaceId",LAST_SYNCED_RACE_ID:"skiTimerLastSyncedRaceId",SYNC_QUEUE:"skiTimerSyncQueue",SCHEMA_VERSION:"skiTimerSchemaVersion",DEVICE_ROLE:"skiTimerDeviceRole",GATE_ASSIGNMENT:"skiTimerGateAssignment",FIRST_GATE_COLOR:"skiTimerFirstGateColor",FAULT_ENTRIES:"skiTimerFaultEntries"},Ci=["entries","settings","currentLang","deviceName","raceId","lastSyncedRaceId","syncQueue","deviceRole","gateAssignment","firstGateColor","faultEntries"];function ce(n,e,t){try{const i=b.getRaw(n);if(!i)return e;const s=JSON.parse(i);return t?t(s):s}catch(i){return u.error(`Failed to parse ${n}:`,i),e}}class ki{constructor(){c(this,"state");c(this,"$state");c(this,"saveTimeout",null);c(this,"dirtySlices",new Set);this.state=this.loadInitialState(),this.$state=zt(this.state)}loadInitialState(){let e=b.getRaw(I.DEVICE_ID);e||(e=Zt(),b.setRaw(I.DEVICE_ID,e),b.flush());const t=ce(I.ENTRIES,[],m=>Array.isArray(m)?m.filter(E=>ae(E)).map(E=>({...E,run:E.run??1})):[]),i=ce(I.SETTINGS,it,m=>({...it,...m})),s=ce(I.SYNC_QUEUE,[],m=>Array.isArray(m)?m:[]),r=b.getRaw(I.LANG)||"de";let a=b.getRaw(I.DEVICE_NAME);a||(a=Pe(),b.setRaw(I.DEVICE_NAME,a),b.flush());const o=b.getRaw(I.RACE_ID)||"",d=b.getRaw(I.LAST_SYNCED_RACE_ID)||"",h=b.getRaw(I.DEVICE_ROLE)||"timer",f=ce(I.GATE_ASSIGNMENT,null,m=>Array.isArray(m)&&m.length===2?m:null),g=b.getRaw(I.FIRST_GATE_COLOR),y=g==="red"||g==="blue"?g:"red",v=ce(I.FAULT_ENTRIES,[],m=>Array.isArray(m)?m:[]);return{currentView:h==="gateJudge"?"gateJudge":"timer",currentLang:r,bibInput:"",selectedPoint:"F",selectedRun:1,selectMode:!1,selectedEntries:new Set,isRecording:!1,lastRecordedEntry:null,entries:t,deviceRole:h,gateAssignment:f,firstGateColor:y,faultEntries:v,selectedFaultBib:"",isJudgeReady:!1,isChiefJudgeView:!1,finalizedRacers:new Set,penaltySeconds:5,usePenaltyMode:!0,undoStack:[],redoStack:[],settings:i,deviceId:e,deviceName:a,raceId:o,lastSyncedRaceId:d,syncStatus:"disconnected",syncQueue:s,connectedDevices:new Map,cloudDeviceCount:0,cloudHighestBib:0,raceExistsInCloud:null,gpsEnabled:i.gps,gpsAccuracy:null,gpsStatus:"inactive",cameraReady:!1,cameraError:null}}getState(){return this.$state.value}setState(e,t=!0){if(this.state={...this.state,...e},this.$state.value=this.state,t){for(const i of Object.keys(e))this.dirtySlices.add(i);this.scheduleSave()}}scheduleSave(){this.saveTimeout&&clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout(()=>this.saveToStorage(),100)}forceSave(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null);for(const e of Ci)this.dirtySlices.add(e);this.saveToStorage()}saveToStorage(){const e=this.dirtySlices;if(this.dirtySlices=new Set,e.size!==0)try{if(this.checkStorageQuota(),e.has("entries")){const i=this.state.entries.map(s=>He(s.photo)?{...s,photo:"indexeddb"}:s);b.setRaw(I.ENTRIES,JSON.stringify(i))}e.has("settings")&&b.setRaw(I.SETTINGS,JSON.stringify(this.state.settings)),e.has("currentLang")&&b.setRaw(I.LANG,this.state.currentLang),e.has("deviceName")&&b.setRaw(I.DEVICE_NAME,this.state.deviceName),e.has("raceId")&&b.setRaw(I.RACE_ID,this.state.raceId),e.has("lastSyncedRaceId")&&b.setRaw(I.LAST_SYNCED_RACE_ID,this.state.lastSyncedRaceId),e.has("syncQueue")&&b.setRaw(I.SYNC_QUEUE,JSON.stringify(this.state.syncQueue)),e.has("deviceRole")&&b.setRaw(I.DEVICE_ROLE,this.state.deviceRole),e.has("gateAssignment")&&(this.state.gateAssignment?b.setRaw(I.GATE_ASSIGNMENT,JSON.stringify(this.state.gateAssignment)):b.remove(I.GATE_ASSIGNMENT)),e.has("firstGateColor")&&b.setRaw(I.FIRST_GATE_COLOR,this.state.firstGateColor),e.has("faultEntries")&&b.setRaw(I.FAULT_ENTRIES,JSON.stringify(this.state.faultEntries)),(e.has("entries")||e.has("settings"))&&b.setRaw(I.SCHEMA_VERSION,String(Se)),b.flush();const t=Ct();t.warning&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t.usageBytes,quota:t.estimatedQuota,percent:t.usagePercent,critical:t.usagePercent>90}}))}catch(t){u.error("Failed to save to storage:",t),this.dispatchStorageError(t)}}async checkStorageQuota(){var e;if((e=navigator.storage)!=null&&e.estimate)try{const{usage:t,quota:i}=await navigator.storage.estimate();if(i&&t){const s=t/i;s>.75&&window.dispatchEvent(new CustomEvent("storage-warning",{detail:{usage:t,quota:i,percent:Math.round(s*100),critical:s>.9}}))}}catch(t){u.warn("Could not check storage quota:",t)}}dispatchStorageError(e){window.dispatchEvent(new CustomEvent("storage-error",{detail:{message:e.message,isQuotaError:e.name==="QuotaExceededError"||e.message.includes("quota")||e.message.includes("storage"),entryCount:this.state.entries.length}}))}addEntry(e){const t=mn(this.state.entries,e,this.state.undoStack,this.state.redoStack);this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack,lastRecordedEntry:e,isRecording:!1}),this.state.settings.sync&&this.state.raceId&&this.addToSyncQueue(e)}deleteEntry(e){const t=yn(this.state.entries,e,this.state.undoStack,this.state.redoStack);t&&this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack})}deleteMultiple(e){const t=vn(this.state.entries,e,this.state.undoStack,this.state.redoStack);t&&this.setState({entries:t.entries,undoStack:t.undoStack,redoStack:t.redoStack,selectMode:!1,selectedEntries:new Set})}clearAll(){const e=bn(this.state.entries,this.state.undoStack,this.state.redoStack);e&&this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack,selectMode:!1,selectedEntries:new Set})}updateEntry(e,t){const i=Sn(this.state.entries,e,t,this.state.undoStack,this.state.redoStack);return i?(this.setState({entries:i.entries,undoStack:i.undoStack,redoStack:i.redoStack}),!0):!1}canUndo(){return this.state.undoStack.length>0}canRedo(){return this.state.redoStack.length>0}peekUndo(){return this.canUndo()?this.state.undoStack[this.state.undoStack.length-1]??null:null}undo(){const e=wn(this.state.entries,this.state.undoStack,this.state.redoStack);return this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack}),e.result}redo(){const e=En(this.state.entries,this.state.undoStack,this.state.redoStack);return this.setState({entries:e.entries,undoStack:e.undoStack,redoStack:e.redoStack}),e.result}addToSyncQueue(e){const t=In(this.state.syncQueue,e);this.setState({syncQueue:t})}removeFromSyncQueue(e){const t=Tn(this.state.syncQueue,e);this.setState({syncQueue:t})}updateSyncQueueItem(e,t){const i=Cn(this.state.syncQueue,e,t);this.setState({syncQueue:i})}clearSyncQueue(){this.setState({syncQueue:[]})}setView(e){this.setState(pi(e),!1)}setLanguage(e){this.setState(mi(e))}setBibInput(e){this.setState(yi(e),!1)}setSelectedPoint(e){this.setState(vi(e),!1)}setSelectedRun(e){this.setState(bi(e),!1)}setSelectMode(e){this.setState(Si(e,this.state.selectedEntries),!1)}toggleEntrySelection(e){this.setState(wi(e,this.state.selectedEntries),!1)}selectAllEntries(){this.setState(Ei(this.state.entries.map(e=>e.id)),!1)}clearSelection(){this.setState(Ii(),!1)}setRecording(e){this.setState(Ti(e),!1)}setDeviceRole(e){this.setState(Vn(e))}setGateAssignment(e){this.setState(zn(e))}setFirstGateColor(e){this.setState(Un(e))}getGateColor(e){return Gn(e,this.state.gateAssignment,this.state.firstGateColor)}setSelectedFaultBib(e){this.setState(Jn(e),!1)}setJudgeReady(e){this.setState(jn(e))}toggleJudgeReady(){this.setState(Qn(this.state.isJudgeReady))}setChiefJudgeView(e){this.setState(qn(e),!1)}toggleChiefJudgeView(){this.setState(Wn(this.state.isChiefJudgeView),!1)}finalizeRacer(e,t){this.setState(Yn(e,t,this.state.finalizedRacers),!1)}unfinalizeRacer(e,t){this.setState(Zn(e,t,this.state.finalizedRacers),!1)}isRacerFinalized(e,t){return Kn(e,t,this.state.finalizedRacers)}clearFinalizedRacers(){this.setState(Xn(),!1)}setPenaltySeconds(e){this.setState(ei(e),!1)}setUsePenaltyMode(e){this.setState(ti(e),!1)}getActiveBibs(e){return ni(this.state.entries,e)}addFaultEntry(e){const t=An(this.state.faultEntries,e);this.setState({faultEntries:t})}deleteFaultEntry(e){const t=Dn(this.state.faultEntries,e);this.setState({faultEntries:t})}updateFaultEntry(e,t){const i=Ln(this.state.faultEntries,e,t);return i?(this.setState({faultEntries:i}),!0):!1}updateFaultEntryWithHistory(e,t,i){const s=Pn(this.state.faultEntries,e,t,this.state.deviceName,this.state.deviceId,i);return s?(this.setState({faultEntries:s}),!0):!1}restoreFaultVersion(e,t){const i=Fn(this.state.faultEntries,e,t,this.state.deviceName,this.state.deviceId);return i?(this.setState({faultEntries:i}),!0):!1}markFaultForDeletion(e){const t=Nn(this.state.faultEntries,e,this.state.deviceName,this.state.deviceId);return t?(this.setState({faultEntries:t}),!0):!1}approveFaultDeletion(e){const t=Mn(this.state.faultEntries,e,this.state.deviceName);return t.approvedFault&&this.setState({faultEntries:t.faultEntries}),t.approvedFault}rejectFaultDeletion(e){const t=$n(this.state.faultEntries,e,this.state.deviceName,this.state.deviceId);return t?(this.setState({faultEntries:t}),!0):!1}getPendingDeletions(){return Bn(this.state.faultEntries)}clearFaultEntries(){this.setState({faultEntries:[]})}getFaultsForBib(e,t){return xn(this.state.faultEntries,e,t)}mergeFaultsFromCloud(e,t=[]){const i=On(this.state.faultEntries,e,t,this.state.deviceId);return i.addedCount>0&&this.setState({faultEntries:i.faultEntries}),i.addedCount}removeDeletedCloudFaults(e){const t=Hn(this.state.faultEntries,e);return t.removedCount>0&&this.setState({faultEntries:t.faultEntries}),t.removedCount}markFaultSynced(e){const t=_n(this.state.faultEntries,e);this.setState({faultEntries:t})}updateSettings(e){const t=ii(this.state.settings,e);this.setState({settings:t})}toggleSetting(e){const t=si(this.state.settings,e);this.setState({settings:t})}setSyncStatus(e){this.setState(ri(e),!1)}setRaceId(e){const t=ai(e,this.state.raceId);t.clearUndoRedo?this.setState({raceId:t.raceId,undoStack:[],redoStack:[]}):this.setState({raceId:t.raceId})}setLastSyncedRaceId(e){this.setState(oi(e))}markCurrentRaceAsSynced(){this.setState({lastSyncedRaceId:this.state.raceId})}setDeviceName(e){this.setState(ci(e))}addConnectedDevice(e){this.setState(di(e,this.state.connectedDevices),!1)}removeConnectedDevice(e){this.setState(ui(e,this.state.connectedDevices),!1)}setCloudDeviceCount(e){this.setState(hi(e),!1)}setCloudHighestBib(e){this.setState(fi(e),!1)}setRaceExistsInCloud(e){this.setState(gi(e),!1)}setGpsStatus(e,t){this.setState({gpsStatus:e,gpsAccuracy:t??null},!1)}setCameraReady(e,t){this.setState({cameraReady:e,cameraError:t??null},!1)}mergeCloudEntries(e,t=[]){const i=kn(this.state.entries,e,t,this.state.deviceId);return i.addedCount>0&&this.setState({entries:i.entries}),i.addedCount}removeDeletedCloudEntries(e){const t=Rn(this.state.entries,e);return t.removedCount>0&&this.setState({entries:t.entries}),t.removedCount}exportData(){return JSON.stringify({version:Se,entries:this.state.entries,settings:this.state.settings,deviceId:this.state.deviceId,deviceName:this.state.deviceName,raceId:this.state.raceId,exportedAt:new Date().toISOString()},null,2)}importData(e){try{const t=JSON.parse(e),i=gn(t,this.state.deviceId),s=new Set(this.state.entries.map(a=>a.id)),r=i.entries.filter(a=>!s.has(a.id));if(r.length>0){const a=[...this.state.entries,...r];a.sort((o,d)=>new Date(o.timestamp).getTime()-new Date(d.timestamp).getTime()),this.setState({entries:a})}return{success:!0,entriesImported:r.length}}catch(t){return{success:!1,entriesImported:0,error:String(t)}}}}const l=new ki,st=w(()=>l.$state.value.entries),Ri=w(()=>l.$state.value.settings),Or=w(()=>l.$state.value.syncStatus);w(()=>l.$state.value.currentLang);const Hr=w(()=>l.$state.value.gpsStatus),ke=w(()=>l.$state.value.deviceRole),ge=w(()=>l.$state.value.faultEntries);w(()=>l.$state.value.entries.length);const Vr=w(()=>l.$state.value.cloudDeviceCount),zr=w(()=>l.$state.value.currentView),Ur=w(()=>l.$state.value.bibInput),Gr=w(()=>l.$state.value.selectedPoint),Jr=w(()=>l.$state.value.selectedRun),jr=w(()=>l.$state.value.undoStack),Ai=w(()=>l.$state.value.isJudgeReady),Di=w(()=>l.$state.value.gateAssignment),rt=w(()=>l.$state.value.isChiefJudgeView),at=w(()=>l.$state.value.penaltySeconds),ot=w(()=>l.$state.value.usePenaltyMode),Qr=w(()=>l.$state.value.selectedEntries);w(()=>l.$state.value.syncStatus==="syncing");const qr=w(()=>l.$state.value.settings.sync),Wr=w(()=>l.$state.value.settings.syncPhotos),Yr=w(()=>l.$state.value.settings.gps),Zr=w(()=>l.$state.value.settings.photoCapture),Kr=w(()=>l.$state.value.settings.glassEffects),Xr=w(()=>l.$state.value.settings.outdoorMode),ea=w(()=>l.$state.value.settings.ambientMode);w(()=>{const n=l.$state.value;return n.entries.some(e=>!e.syncedAt)||n.syncQueue.length>0});w(()=>{const n=l.$state.value.entries;return{run1:n.filter(e=>e.run===1),run2:n.filter(e=>e.run===2)}});const ct={video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}},audio:!1},Li={video:{facingMode:"environment",width:{ideal:640},height:{ideal:480}},audio:!1},Pi=.8,pe=1280,me=720,lt=200,Fi=5e3,dt=3,Ni=12e4;class Mi{constructor(){c(this,"stream",null);c(this,"videoElement",null);c(this,"canvasElement",null);c(this,"cameraState","stopped");c(this,"visibilityHandler",null);c(this,"pendingVisibilityChange",null);c(this,"previewElement",null);c(this,"ownsVideoElement",!1);c(this,"resumingStartedAt",null);c(this,"reinitRetryCount",0);c(this,"idleTimeoutId",null)}createVideoElement(){if(this.previewElement)return this.ownsVideoElement=!1,this.previewElement;const e=document.createElement("video");return e.setAttribute("autoplay",""),e.setAttribute("playsinline",""),e.style.position="absolute",e.style.left="-9999px",e.style.top="-9999px",document.body.appendChild(e),this.ownsVideoElement=!0,e}waitForVideoReady(){return new Promise((e,t)=>{if(!this.videoElement){t(new Error("Video element not available"));return}this.videoElement.onloadedmetadata=()=>{this.videoElement.play().then(()=>e()).catch(t)},this.videoElement.onerror=()=>t(new Error("Video load error"))})}async initialize(){if(this.cameraState==="ready")return!0;if(this.cameraState==="initializing")return!1;this.cameraState="initializing",this.reinitRetryCount=0;try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Camera API not available");if(A.isCriticalBattery())return u.debug("[Camera] Critical battery, skipping initialization"),this.cameraState="stopped",l.setCameraReady(!1,"Camera disabled on critical battery"),!1;this.videoElement=this.createVideoElement(),this.canvasElement=document.createElement("canvas"),this.canvasElement.width=pe,this.canvasElement.height=me;const e=A.isLowBattery()?Li:ct;return this.stream=await navigator.mediaDevices.getUserMedia(e),this.videoElement.srcObject=this.stream,await this.waitForVideoReady(),this.pendingVisibilityChange==="hidden"?(this.pendingVisibilityChange=null,this.pauseCamera(),!1):(this.cameraState="ready",l.setCameraReady(!0),this.resetIdleTimeout(),this.visibilityHandler||(this.visibilityHandler=()=>this.handleVisibilityChange(),document.addEventListener("visibilitychange",this.visibilityHandler)),!0)}catch(e){const t=e instanceof Error?e.message:"Camera initialization failed";return u.error("Camera initialization error:",t),this.cameraState="stopped",l.setCameraReady(!1,t),!1}}handleVisibilityChange(){document.hidden?this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange="hidden":this.cameraState==="ready"&&this.pauseCamera():this.cameraState==="initializing"||this.cameraState==="resuming"?this.pendingVisibilityChange=null:this.cameraState==="paused"&&this.reinitializeCamera()}pauseCamera(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null,this.videoElement&&(this.videoElement.srcObject=null)),this.cameraState="paused",l.setCameraReady(!1)}async reinitializeCamera(){if(this.cameraState==="resuming")if(this.resumingStartedAt&&Date.now()-this.resumingStartedAt>Fi)u.warn("Camera stuck in resuming state, resetting for retry"),this.cameraState="paused",this.resumingStartedAt=null;else return;if(this.reinitRetryCount>=dt){u.warn(`Camera reinit failed after ${dt} attempts, giving up`),this.cameraState="stopped",this.resumingStartedAt=null,l.setCameraReady(!1,"Camera reinitialization failed");return}this.cameraState="resuming",this.resumingStartedAt=Date.now(),this.reinitRetryCount++;try{if(this.videoElement||(this.videoElement=this.createVideoElement()),this.stream=await navigator.mediaDevices.getUserMedia(ct),this.videoElement.srcObject=this.stream,await this.waitForVideoReady(),this.pendingVisibilityChange==="hidden"){this.pendingVisibilityChange=null,this.resumingStartedAt=null,this.pauseCamera();return}this.cameraState="ready",this.resumingStartedAt=null,this.reinitRetryCount=0,l.setCameraReady(!0),this.resetIdleTimeout()}catch(e){u.error("Failed to reinitialize camera:",e),this.cameraState="stopped",this.resumingStartedAt=null}}async capturePhoto(){if(this.cameraState!=="ready"||!this.videoElement||!this.canvasElement)return u.warn("Camera not ready for capture"),null;this.resetIdleTimeout();try{const e=this.canvasElement.getContext("2d");if(!e)throw new Error("Could not get canvas context");const t=this.videoElement.videoWidth,i=this.videoElement.videoHeight;let s=t,r=i;if(s>pe){const f=pe/s;s=pe,r=Math.round(r*f)}if(r>me){const f=me/r;r=me,s=Math.round(s*f)}this.canvasElement.width=s,this.canvasElement.height=r,e.drawImage(this.videoElement,0,0,s,r);const a=new Date().toISOString();e.fillStyle="rgba(0, 0, 0, 0.5)",e.fillRect(0,r-30,s,30),e.fillStyle="#ffffff",e.font="14px monospace",e.fillText(a,10,r-10);const d=this.canvasElement.toDataURL("image/jpeg",Pi).split(",")[1]??null;if(!d)return null;const h=Math.round(d.length/1024);if(h>lt){const f=new Error(`Photo too large (${h}KB > ${lt}KB limit)`);throw f.name="PhotoTooLargeError",f}return d}catch(e){return u.error("Photo capture error:",e),null}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null),this.videoElement&&(this.videoElement.srcObject=null,this.ownsVideoElement&&(this.videoElement.remove(),this.videoElement=null)),this.canvasElement=null,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.pendingVisibilityChange=null,this.resumingStartedAt=null,this.clearIdleTimeout(),this.cameraState="stopped",l.setCameraReady(!1)}isReady(){return this.cameraState==="ready"}setPreviewElement(e){if(this.previewElement=e,!e){this.videoElement&&!this.ownsVideoElement&&(this.videoElement.srcObject=null,this.videoElement=null);return}this.videoElement!==e&&(this.videoElement&&this.ownsVideoElement&&this.videoElement.remove(),this.videoElement=e,this.ownsVideoElement=!1),this.stream&&(this.videoElement.srcObject=this.stream,this.videoElement.play().catch(()=>null))}getVideoElement(){return this.videoElement}getError(){return l.getState().cameraError}resetIdleTimeout(){this.clearIdleTimeout(),this.idleTimeoutId=setTimeout(()=>{this.cameraState==="ready"&&(u.debug("[Camera] Idle timeout, pausing stream to save battery"),this.pauseCamera())},Ni)}clearIdleTimeout(){this.idleTimeoutId!==null&&(clearTimeout(this.idleTimeoutId),this.idleTimeoutId=null)}async toggle(e){return e?this.initialize():(this.stop(),!0)}}const Re=new Mi;async function ta(){return!l.getState().settings.photoCapture||!Re.isReady()&&!await Re.initialize()?null:Re.capturePhoto()}let ie=null,ye=null;const $i=5e3;function At(){if(!ie)try{ie=new(window.AudioContext||window.webkitAudioContext)}catch(n){return u.warn("AudioContext not available:",n),null}return ie}function Bi(){ye!==null&&clearTimeout(ye),ye=window.setTimeout(()=>{ie&&ie.state==="running"&&ie.suspend().catch(()=>{}),ye=null},$i)}function xi(n){const{batteryLevel:e}=A.getStatus();if(e==="critical")return null;const t=e==="low"?.5:e==="medium"?.75:1;return t===1?n:typeof n=="number"?Math.round(n*t):n.map(i=>Math.round(i*t))}function Y(n){if(!l.getState().settings.haptic)return;const t=xi(n);if(t!==null&&navigator.vibrate)try{navigator.vibrate(t)}catch(i){u.warn("Vibration failed:",i)}}function Te(n=880,e=100){if(!l.getState().settings.sound)return;const i=At();if(i){i.state==="suspended"&&i.resume().catch(()=>{}),Bi();try{const s=i.createOscillator(),r=i.createGain();s.connect(r),r.connect(i.destination),s.frequency.value=n,s.type="sine",r.gain.setValueAtTime(.3,i.currentTime),r.gain.exponentialRampToValueAtTime(.01,i.currentTime+e/1e3),s.start(i.currentTime),s.stop(i.currentTime+e/1e3)}catch(s){u.warn("Sound playback failed:",s)}}}function he(){Y(40),Te(880,100)}function na(){Y([60,40,60]),Te(440,200)}function q(){Y(30)}function ia(){Y(10)}function sa(){Y(20)}function _i(){Y([40,30,40]),Te(330,150)}function ra(){Y([35,35]),Te(660,100)}async function aa(){const n=At();if(n&&n.state==="suspended")try{await n.resume()}catch(e){u.warn("Failed to resume audio:",e)}}const Oi={enableHighAccuracy:!0,timeout:1e4,maximumAge:3e4},Hi={enableHighAccuracy:!1,timeout:15e3,maximumAge:3e4},ut={enableHighAccuracy:!1,timeout:3e4,maximumAge:12e4},Vi=10,zi=30;class Ui{constructor(){c(this,"watchId",null);c(this,"lastPosition",null);c(this,"visibilityHandler",null);c(this,"wasActiveBeforeHidden",!1);c(this,"batteryUnsubscribe",null);c(this,"usingLowPowerMode",!1);c(this,"dutyCycleIntervalId",null);c(this,"isDutyCycling",!1);c(this,"pausedByView",!1);c(this,"timeOffset",null)}getGpsOptions(){const e=A.isLowBattery();return this.usingLowPowerMode=e,e?Hi:Oi}startDutyCycling(){this.isDutyCycling||(this.isDutyCycling=!0,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),u.debug("[GPS] Starting duty cycling (60s interval)"),this.dutyCycleIntervalId=setInterval(()=>{navigator.geolocation.getCurrentPosition(e=>this.handlePosition(e),e=>this.handleError(e),ut)},6e4),navigator.geolocation.getCurrentPosition(e=>this.handlePosition(e),e=>this.handleError(e),ut))}stopDutyCycling(){this.dutyCycleIntervalId!==null&&(clearInterval(this.dutyCycleIntervalId),this.dutyCycleIntervalId=null),this.isDutyCycling=!1}start(){if(this.watchId!==null||this.isDutyCycling)return!0;if(!navigator.geolocation)return u.error("Geolocation not supported"),l.setGpsStatus("inactive"),!1;this.pausedByView=!1,l.setGpsStatus("searching");try{const e=this.getGpsOptions();return this.watchId=navigator.geolocation.watchPosition(t=>this.handlePosition(t),t=>this.handleError(t),e),this.visibilityHandler||(this.visibilityHandler=()=>{if(document.hidden)this.wasActiveBeforeHidden=this.watchId!==null||this.isDutyCycling,this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.wasActiveBeforeHidden&&l.setGpsStatus("inactive");else if(this.wasActiveBeforeHidden&&!this.pausedByView)if(l.setGpsStatus("searching"),A.isCriticalBattery())this.startDutyCycling();else{const t=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(i=>this.handlePosition(i),i=>this.handleError(i),t)}},document.addEventListener("visibilitychange",this.visibilityHandler)),this.batteryUnsubscribe||(this.batteryUnsubscribe=A.subscribe(()=>{if(this.watchId===null&&!this.isDutyCycling)return;const t=A.isCriticalBattery();if(t&&!this.isDutyCycling){u.debug("[GPS] Switching to duty-cycle mode (critical battery)"),this.startDutyCycling();return}if(!t&&this.isDutyCycling){u.debug("[GPS] Resuming continuous GPS from duty-cycle mode"),this.stopDutyCycling();const r=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(a=>this.handlePosition(a),a=>this.handleError(a),r);return}if(this.watchId===null)return;const i=A.isLowBattery();if(i===this.usingLowPowerMode)return;u.debug(`[GPS] Switching to ${i?"low-power":"high-accuracy"} mode`),navigator.geolocation.clearWatch(this.watchId);const s=this.getGpsOptions();this.watchId=navigator.geolocation.watchPosition(r=>this.handlePosition(r),r=>this.handleError(r),s)})),!0}catch(e){return u.error("Failed to start GPS:",e),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),l.setGpsStatus("inactive"),!1}}pause(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.pausedByView=!0,this.wasActiveBeforeHidden=!1,l.setGpsStatus(this.lastPosition?"paused":"inactive")}resume(){if(this.pausedByView){if(this.pausedByView=!1,document.hidden){this.wasActiveBeforeHidden=!0;return}this.start()}}isPaused(){return this.pausedByView}stop(){this.watchId!==null&&(navigator.geolocation.clearWatch(this.watchId),this.watchId=null),this.stopDutyCycling(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasActiveBeforeHidden=!1,this.pausedByView=!1,this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.lastPosition=null,this.timeOffset=null,l.setGpsStatus("inactive")}handlePosition(e){this.lastPosition=e;const t=e.timestamp-Date.now();Math.abs(t)>500&&u.warn(`[GPS] Clock offset ${t}ms - system clock may be inaccurate`),this.timeOffset=t;const i=e.coords.accuracy;l.setGpsStatus("active",i)}handleError(e){u.error("GPS error:",e.message),e.code===e.PERMISSION_DENIED?(l.setGpsStatus("inactive"),this.stop()):l.setGpsStatus("searching")}getPosition(){return this.lastPosition}getCoordinates(){if(this.lastPosition)return{latitude:this.lastPosition.coords.latitude,longitude:this.lastPosition.coords.longitude,accuracy:this.lastPosition.coords.accuracy}}getTimestamp(){var e;return((e=this.lastPosition)==null?void 0:e.timestamp)??null}getTimeOffset(){return this.timeOffset}getAccuracyStatus(){if(!this.lastPosition)return"unknown";const e=this.lastPosition.coords.accuracy;return e<=Vi?"good":e<=zi?"fair":"poor"}isActive(){return(this.watchId!==null||this.isDutyCycling)&&this.lastPosition!==null}toggle(e){return e?this.start():(this.stop(),!0)}async requestPosition(){return navigator.geolocation?new Promise(e=>{navigator.geolocation.getCurrentPosition(t=>{this.lastPosition=t,e(t)},()=>e(null),this.getGpsOptions())}):null}}const Gi=new Ui,Ji=`You are a voice command processor for a ski race timing app.
Parse the user's spoken command and return a structured JSON response.

Context provided:
- role: "timer" (sets bib/point/run) or "gateJudge" (records faults)
- language: User's language (de/en)
- activeBibs: Racers currently on course (gate judge only)
- gateRange: Gates this judge is watching [start, end]
- pendingConfirmation: If set, user is responding to a confirmation prompt

For TIMER role, recognize:
- Bib numbers: spoken digits or number words (e.g., "forty-five" = 45, "fünfundvierzig" = 45)
- Timing point: "Start" / "Ziel" / "Finish"
- Run selection: "Lauf 1/2", "Run 1/2", "erster Lauf", "zweiter Lauf"
NOTE: Timer role does NOT support recording timestamps via voice (latency too high for timing)

For GATE JUDGE role, recognize:
- Fault recording with bib + gate + type
- Fault types: MG (missed gate/ausgelassen), STR (straddling/eingefädelt), BR (binding release/Bindung offen)
- Ready status: "Bereit", "Ready", "Fertig"
- Confirmation: "Ja", "Yes", "Correct", "Richtig", "Stimmt"
- Cancellation: "Nein", "No", "Cancel", "Abbrechen", "Falsch"

Return ONLY valid JSON (no markdown, no explanation):
{
  "action": "record_fault" | "set_bib" | "set_gate" | "set_point" | "set_run" | "toggle_ready" | "confirm" | "cancel" | "unknown",
  "confidence": 0.0-1.0,
  "params": {
    "bib": "string (3 digits, zero-padded)",
    "gate": number,
    "faultType": "MG" | "STR" | "BR",
    "point": "S" | "F",
    "run": number (positive integer, typically 1 or 2)
  },
  "confirmationNeeded": boolean,
  "confirmationPrompt": "string (spoken confirmation request in user's language)"
}

IMPORTANT:
- For gate judge faults, set confirmationNeeded=true with a clear prompt
- Confirmation prompts should be in the user's language
- If user tries to record time via voice, return action="unknown" (voice timing disabled)
- If unsure, set action="unknown" with low confidence`,ji={model:"claude-3-haiku-20240307",maxTokens:256};function Qi(n){return n.includes("/api/v1/voice")}async function qi(n,e,t){const{endpoint:i,apiKey:s,model:r,maxTokens:a}={...ji,...t};if(!i)throw new Error("LLM endpoint is required");if(Qi(i))return Wi(n,e,i);if(!s)throw new Error("API key is required for direct LLM calls");return Yi(n,e,i,s,r,a)}async function Wi(n,e,t){try{const i=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({transcript:n,context:e})});if(!i.ok){const r=await i.text();throw u.error("[LLMProvider] Proxy error:",i.status,r),new Error(`Proxy error: ${i.status}`)}const s=await i.json();if(s.success&&s.intent)return u.debug("[LLMProvider] Proxy intent:",s.intent),s.intent;throw new Error("Invalid proxy response")}catch(i){return u.error("[LLMProvider] Proxy processing error:",i),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function Yi(n,e,t,i,s,r){var d;const o=`Context: ${JSON.stringify({role:e.role,language:e.language,currentRun:e.currentRun,activeBibs:e.activeBibs,gateRange:e.gateRange,pendingConfirmation:e.pendingConfirmation?{action:e.pendingConfirmation.action,params:e.pendingConfirmation.params}:null})}

Transcript: "${n}"`;try{const h=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`,"anthropic-version":"2023-06-01"},body:JSON.stringify({model:s,max_tokens:r,system:Ji,messages:[{role:"user",content:o}]})});if(!h.ok){const m=await h.text();throw u.error("[LLMProvider] API error:",h.status,m),new Error(`LLM API error: ${h.status}`)}const f=await h.json();let g="";if(f.content&&Array.isArray(f.content)?g=((d=f.content[0])==null?void 0:d.text)||"":typeof f.content=="string"&&(g=f.content),!g)throw new Error("Empty response from LLM");let y=g.trim();y.startsWith("```")&&(y=y.replace(/```json?\n?/g,"").replace(/```$/g,"").trim());const v=JSON.parse(y);if(!v.action||typeof v.confidence!="number")throw new Error("Invalid intent structure");return u.debug("[LLMProvider] Parsed intent:",v),v}catch(h){return u.error("[LLMProvider] Processing error:",h),{action:"unknown",confidence:0,confirmationNeeded:!1}}}async function Zi(n,e,t,i=5e3){const s=new Promise((r,a)=>{setTimeout(()=>a(new Error("LLM request timeout")),i)});return Promise.race([qi(n,e,t),s]).catch(r=>(u.warn("[LLMProvider] Timeout or error:",r),{action:"unknown",confidence:0,confirmationNeeded:!1}))}const Ki="ski-timer-photos",Xi=1,N="photos",es=3,ts=5e3;class ns{constructor(){c(this,"db",null);c(this,"initPromise",null);c(this,"saveQueue",[]);c(this,"activeSaves",0)}async initialize(){return this.initPromise?this.initPromise:(this.initPromise=new Promise(e=>{if(!window.indexedDB){u.warn("IndexedDB not supported - photo storage disabled"),e(!1);return}const t=indexedDB.open(Ki,Xi);t.onerror=()=>{u.error("IndexedDB open error:",t.error),e(!1)},t.onsuccess=()=>{this.db=t.result,e(!0)},t.onupgradeneeded=i=>{const s=i.target.result;s.objectStoreNames.contains(N)||s.createObjectStore(N,{keyPath:"entryId"}).createIndex("timestamp","timestamp",{unique:!1})}}),this.initPromise)}async savePhoto(e,t){return new Promise(i=>{this.saveQueue.push({entryId:e,photoBase64:t,resolve:i}),this.processQueue()})}processQueue(){for(;this.saveQueue.length>0&&this.activeSaves<es;){const e=this.saveQueue.shift();this.activeSaves++,this.doSavePhotoWithTimeout(e.entryId,e.photoBase64).then(t=>{e.resolve(t)}).catch(()=>{e.resolve(!1)}).finally(()=>{this.activeSaves--,this.processQueue()})}}async doSavePhotoWithTimeout(e,t){return Promise.race([this.doSavePhoto(e,t),new Promise((i,s)=>setTimeout(()=>s(new Error("Photo save timeout")),ts))])}async doSavePhoto(e,t){return!this.db&&!await this.initialize()?!1:new Promise(i=>{if(!this.db){i(!1);return}try{const r=this.db.transaction([N],"readwrite").objectStore(N),a={entryId:e,photo:t,timestamp:Date.now()},o=r.put(a);o.onsuccess=()=>{i(!0)},o.onerror=()=>{u.error("Photo save error:",o.error),i(!1)}}catch(s){u.error("Photo save transaction error:",s),i(!1)}})}async getPhoto(e){return!this.db&&!await this.initialize()?null:new Promise(t=>{if(!this.db){t(null);return}try{const r=this.db.transaction([N],"readonly").objectStore(N).get(e);r.onsuccess=()=>{const a=r.result;t((a==null?void 0:a.photo)||null)},r.onerror=()=>{u.error("Photo get error:",r.error),t(null)}}catch(i){u.error("Photo get transaction error:",i),t(null)}})}async deletePhoto(e){return!this.db&&!await this.initialize()?!1:new Promise(t=>{if(!this.db){t(!1);return}try{const r=this.db.transaction([N],"readwrite").objectStore(N).delete(e);r.onsuccess=()=>{t(!0)},r.onerror=()=>{u.error("Photo delete error:",r.error),t(!1)}}catch(i){u.error("Photo delete transaction error:",i),t(!1)}})}async hasPhoto(e){return await this.getPhoto(e)!==null}async clearAll(){return!this.db&&!await this.initialize()?!1:new Promise(e=>{if(!this.db){e(!1);return}try{const s=this.db.transaction([N],"readwrite").objectStore(N).clear();s.onsuccess=()=>{e(!0)},s.onerror=()=>{u.error("Photo clear error:",s.error),e(!1)}}catch(t){u.error("Photo clear transaction error:",t),e(!1)}})}async deletePhotos(e){for(const t of e)await this.deletePhoto(t)}async getStorageUsage(){if("storage"in navigator&&"estimate"in navigator.storage)try{const e=await navigator.storage.estimate();return{used:e.usage||0,quota:e.quota||0}}catch{return null}return null}async getPhotoCount(){return!this.db&&!await this.initialize()?0:new Promise(e=>{if(!this.db){e(0);return}try{const s=this.db.transaction([N],"readonly").objectStore(N).count();s.onsuccess=()=>{e(s.result)},s.onerror=()=>{e(0)}}catch{e(0)}})}close(){this.db&&(this.db.close(),this.db=null,this.initPromise=null)}}const le=new ns;class is{constructor(){c(this,"synth",null);c(this,"voice",null);c(this,"voicesLoaded",!1);typeof window<"u"&&"speechSynthesis"in window&&(this.synth=window.speechSynthesis,this.loadVoices())}isSupported(){return this.synth!==null}loadVoices(){if(!this.synth)return;this.synth.getVoices().length>0?(this.voicesLoaded=!0,this.selectVoiceForLanguage(l.getState().currentLang)):this.synth.addEventListener("voiceschanged",()=>{this.voicesLoaded=!0,this.selectVoiceForLanguage(l.getState().currentLang)},{once:!0})}selectVoiceForLanguage(e){if(!this.synth)return;const t=this.synth.getVoices(),i=e==="de"?"de":"en";this.voice=t.find(s=>s.lang.startsWith(i)&&s.name.toLowerCase().includes("female"))||t.find(s=>s.lang.startsWith(i))||t.find(s=>s.lang.startsWith("en"))||null,this.voice&&u.debug("[SpeechSynthesis] Selected voice:",this.voice.name,this.voice.lang)}setLanguage(e){this.voicesLoaded&&this.selectVoiceForLanguage(e)}speak(e,t){return new Promise((i,s)=>{if(!this.synth){s(new Error("Speech synthesis not supported"));return}this.synth.cancel();const r=new SpeechSynthesisUtterance(e);this.voice&&(r.voice=this.voice),r.rate=(t==null?void 0:t.rate)??1.1,r.pitch=(t==null?void 0:t.pitch)??1,r.volume=1,r.onend=()=>i(),r.onerror=a=>{a.error==="interrupted"?i():(u.warn("[SpeechSynthesis] Error:",a.error),s(new Error(a.error)))},this.synth.speak(r)})}sayOK(){return this.speak("OK",{rate:1.2})}sayRecorded(){const t=l.getState().currentLang==="de"?"Erfasst":"Recorded";return this.speak(t,{rate:1.1})}sayNotUnderstood(){const t=l.getState().currentLang==="de"?"Nicht verstanden":"Not understood";return this.speak(t,{rate:1})}cancel(){var e;(e=this.synth)==null||e.cancel()}}const z=new is,M={CRITICAL:"critical",ERROR:"error",WARNING:"warning",INFO:"info"},ht={CRITICAL:8e3,ERROR:5e3,WARNING:4e3,INFO:3e3};function ss(n){return`[${n.component}] ${n.operation}`}function rs(n){return n instanceof Error?n.message:typeof n=="string"?n:"Unknown error"}function Ue(n){const e=ss(n),t=n.error?rs(n.error):"No error details",i={code:n.code,message:t,timestamp:new Date().toISOString(),...n.metadata};switch(n.severity){case M.CRITICAL:case M.ERROR:console.error(`${e}:`,t,i);break;case M.WARNING:console.warn(`${e}:`,t,i);break;case M.INFO:console.log(`${e}:`,t,i);break}if(n.userMessageKey){const s=l.getState().currentLang,r=p(n.userMessageKey,s),a=as(n.severity),o=ht[n.severity.toUpperCase()]||ht.ERROR;P(r,a,o)}n.severity===M.CRITICAL&&window.dispatchEvent(new CustomEvent("critical-error",{detail:n}))}function as(n){switch(n){case M.CRITICAL:case M.ERROR:return"error";case M.WARNING:return"warning";case M.INFO:return"info";default:return"error"}}function oa(n,e,t,i){Ue({component:n,operation:e,severity:M.ERROR,error:t,userMessageKey:i})}function ca(n,e,t,i){Ue({component:n,operation:e,severity:M.WARNING,error:t,userMessageKey:i})}function la(n,e,t,i){Ue({component:n,operation:e,severity:M.CRITICAL,error:t,userMessageKey:i})}const os=1e4;class cs extends Error{constructor(e,t){super(`Request to ${e} timed out after ${t}ms`),this.name="FetchTimeoutError"}}async function x(n,e={},t=os){const i=new AbortController,s=setTimeout(()=>i.abort(),t);try{return await fetch(n,{...e,signal:i.signal})}catch(r){throw r instanceof Error&&r.name==="AbortError"?new cs(n,t):r}finally{clearTimeout(s)}}const Ce="skiTimerAuthToken";function _(){const n=b.getRaw(Ce);return n?{Authorization:`Bearer ${n}`}:{}}function da(){const n=b.getRaw(Ce);if(!n)return!1;try{const e=n.split(".");if(e.length===3){const t=JSON.parse(atob(e[1]));if(t.exp&&t.exp*1e3<Date.now())return!1}}catch{}return!0}function ls(n){b.setRaw(Ce,n),b.flush()}function ds(){b.remove(Ce),b.flush()}const us=1e4;async function ua(n,e){const t=new AbortController,i=setTimeout(()=>t.abort(),us);try{const s=await fetch("/api/v1/auth/token",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:n,role:e}),signal:t.signal});clearTimeout(i);const r=await s.json();return s.ok?r.token?(ls(r.token),{success:!0,token:r.token,isNewPin:r.isNewPin}):{success:!1,error:"No token received"}:{success:!1,error:r.error||"Authentication failed"}}catch(s){return clearTimeout(i),s instanceof Error&&s.name==="AbortError"?(u.error("Token exchange timeout"),{success:!1,error:"Request timeout"}):(u.error("Token exchange error:",s),{success:!1,error:"Network error"})}}function hs(n="Session expired. Please re-enter your PIN."){window.dispatchEvent(new CustomEvent("auth-expired",{detail:{message:n}}))}class fs{constructor(){c(this,"broadcastChannel",null)}initialize(e){if(typeof BroadcastChannel>"u"){u.info("BroadcastChannel not supported - cross-tab sync disabled (graceful degradation)");return}try{this.broadcastChannel&&this.broadcastChannel.close(),this.broadcastChannel=new BroadcastChannel(`ski-timer-${e}`),this.broadcastChannel.onmessage=t=>{try{const{type:i,data:s}=t.data||{};if(i==="entry"&&ae(s))l.mergeCloudEntries([s]);else if(i==="presence")s&&typeof s.id=="string"&&typeof s.name=="string"&&typeof s.lastSeen=="number"&&l.addConnectedDevice(s);else if(i==="fault"){const r=s;r!=null&&r.id&&l.mergeFaultsFromCloud([r])}else if(i==="fault-deleted"){const r=s;r&&l.markFaultForDeletion(r)}}catch(i){u.error("Error processing broadcast message:",i)}}}catch(t){u.warn("BroadcastChannel initialization failed:",t)}}broadcastEntry(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"entry",data:e})}catch(t){u.error("Broadcast error:",t)}}broadcastPresence(){const e=l.getState();if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"presence",data:{id:e.deviceId,name:e.deviceName,lastSeen:Date.now()}})}catch(t){u.error("Presence broadcast error:",t)}}broadcastFault(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"fault",data:e})}catch(t){u.error("Fault broadcast error:",t)}}broadcastFaultDeletion(e){if(this.broadcastChannel)try{this.broadcastChannel.postMessage({type:"fault-deleted",data:e})}catch(t){u.error("Fault deletion broadcast error:",t)}}cleanup(){if(this.broadcastChannel){try{this.broadcastChannel.close()}catch{}this.broadcastChannel=null}}}const te=new fs;function gs(n){const e=String(n.getHours()).padStart(2,"0"),t=String(n.getMinutes()).padStart(2,"0"),i=String(n.getSeconds()).padStart(2,"0"),s=String(n.getMilliseconds()).padStart(3,"0");return`${e}:${t}:${i}.${s}`}function ps(n,e="de"){const t={weekday:"short",day:"2-digit",month:"2-digit",year:"numeric"};return n.toLocaleDateString(e==="de"?"de-DE":"en-US",t)}function ha(n,e=3){return String(n).padStart(e,"0")}function L(n){const e=document.createElement("div");return e.textContent=String(n),e.innerHTML}function T(n){return L(n).replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function fa(n){return{S:"var(--success)",F:"var(--secondary)"}[n]||"var(--text-secondary)"}function ms(n,e="de"){return{en:{S:"Start",F:"Finish"},de:{S:"Start",F:"Ziel"}}[e][n]}function ga(n,e="de"){return`${e==="de"?"L":"R"}${n}`}function pa(n){return n===1?"var(--primary)":n===2?"var(--warning)":"var(--text-secondary)"}function Ge(n,e){return{MG:p("faultMGShort",e),STR:p("faultSTRShort",e),BR:p("faultBRShort",e)}[n]||n}function ma(n){return n<1024?`${n} B`:n<1024*1024?`${(n/1024).toFixed(1)} KB`:`${(n/(1024*1024)).toFixed(1)} MB`}function ya(n,e){let t;return(...i)=>{clearTimeout(t),t=setTimeout(()=>n(...i),e)}}const Dt="skiTimerRecentRaces",ys=50;function Lt(){try{return b.get(Dt)??[]}catch{return[]}}function vs(n,e,t){try{const i=Lt(),s=n.toLowerCase(),r=i.findIndex(o=>o.raceId.toLowerCase()===s);r>=0?(i[r].lastUpdated=e,t!==void 0&&(i[r].entryCount=t)):i.unshift({raceId:n,createdAt:Date.now(),lastUpdated:e,entryCount:t}),i.sort((o,d)=>d.lastUpdated-o.lastUpdated);const a=i.slice(0,ys);b.set(Dt,a)}catch(i){u.error("Failed to save recent race:",i)}}function va(n=5){const e=Lt(),t=new Date;t.setHours(0,0,0,0);const i=t.getTime();return e.filter(s=>s.createdAt>=i||s.lastUpdated>=i).slice(0,n)}const re="/api/v1/sync",Je="/api/v1/faults",Pt=15e3,ft=3e4,bs=5,Ss=2e3,ws=1e4,J=8e3,Ft=10,Es=[15e3,2e4,3e4,45e3,6e4],Nt=6,gt=[2e4,3e4,45e3,6e4,9e4],Is=4,pt=[3e4,45e3,6e4,9e4,12e4],mt=[3e4,6e4],yt=3,vt=3e5,Ts=[3e4,45e3,6e4,9e4,12e4],Cs=3e4,ks=3e4,bt=6e4,St=3e4,Rs={normal:{intervals:Es,threshold:Nt,baseInterval:Pt},medium:{intervals:gt,threshold:Is,baseInterval:gt[0]},low:{intervals:pt,threshold:yt,baseInterval:pt[0]},critical:{intervals:mt,threshold:yt,baseInterval:mt[0]}};function As(n){const e=n instanceof Error?n.message:"";return(n instanceof Error?n.name:"")==="FetchTimeoutError"||e.includes("timed out")||e.includes("500")||e.includes("503")?"error":e.includes("Failed to fetch")||e.includes("NetworkError")?"offline":"error"}let S=null,ne=0,ee=null;function Ds(n){S=n}function Ls(){return ne}async function Ps(n){const e=l.getState(),t=[];for(const i of n)if(He(i.photo))if(e.settings.syncPhotos){if(await le.hasPhoto(i.id)){t.push({...i,photo:"indexeddb"});continue}await le.savePhoto(i.id,i.photo)?t.push({...i,photo:"indexeddb"}):(u.warn("Sync: Photo storage failed for entry:",i.id),t.push({...i,photo:void 0}))}else t.push({...i,photo:void 0});else t.push(i);return t}async function wt(){const n=l.getState();if(!(!n.settings.sync||!n.raceId)){if(ee)return ee;ee=Fs();try{await ee}finally{ee=null}}}async function Fs(){const n=l.getState(),e=n.syncStatus;(e==="connected"||e==="connecting")&&l.setSyncStatus("syncing");try{const t=new URLSearchParams({raceId:n.raceId,deviceId:n.deviceId,deviceName:n.deviceName});ne>0&&t.set("since",String(ne));const i=await x(`${re}?${t}`,{headers:{"Accept-Encoding":"gzip, deflate",..._()}},J);if(i.status===401){let h={};try{h=await i.json()}catch{h={}}if(h.expired){ds(),l.setSyncStatus("disconnected"),hs(),S==null||S.onCleanup();return}throw new Error(`HTTP ${i.status}: ${h.error||"Unauthorized"}`)}if(!i.ok)throw new Error(`HTTP ${i.status}`);let s;try{s=await i.json()}catch{throw new Error("Invalid response format")}if(!s||typeof s!="object")throw new Error("Invalid data structure");if(s.deleted){window.dispatchEvent(new CustomEvent("race-deleted",{detail:{raceId:n.raceId,deletedAt:s.deletedAt,message:s.message}})),S==null||S.onCleanup();return}const a=(Array.isArray(s.entries)?s.entries:[]).filter(h=>ae(h)?!0:(u.warn("Skipping invalid entry from cloud:",h),!1)),o=Array.isArray(s.deletedIds)?s.deletedIds.filter(h=>typeof h=="string"&&h.length>0):[];l.setSyncStatus("connected"),typeof s.deviceCount=="number"&&l.setCloudDeviceCount(s.deviceCount),typeof s.highestBib=="number"&&l.setCloudHighestBib(s.highestBib);let d=!1;if(o.length>0&&(l.removeDeletedCloudEntries(o),d=!0),a.length>0){const h=await Ps(a),f=l.mergeCloudEntries(h,o);if(f>0){d=!0;const g=l.getState().currentLang;S==null||S.showToast(p("syncedEntriesFromCloud",g).replace("{count}",String(f)))}}ne=s.lastUpdated||Date.now(),n.raceId&&vs(n.raceId,ne,a.length),await(S==null?void 0:S.fetchFaults()),S==null||S.onPollingAdjust(!0,d)}catch(t){u.error("Cloud sync fetch error:",t),l.setSyncStatus(As(t)),S==null||S.onPollingAdjust(!1)}}async function Ns(n,e){const t=l.getState();if(!t.settings.sync||!t.raceId)return!1;try{const i=await x(`${re}?raceId=${encodeURIComponent(t.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",..._()},body:JSON.stringify({entryId:n,deviceId:e||t.deviceId,deviceName:t.deviceName})},J);if(!i.ok)throw new Error(`HTTP ${i.status}`);return!0}catch(i){return u.error("Cloud sync delete error:",i),!1}}async function Fe(n){const e=l.getState();if(!e.settings.sync||!e.raceId)return!1;try{let t={...n};if(e.settings.syncPhotos&&Oe(n.photo)){const s=await le.getPhoto(n.id);s?t={...n,photo:s}:t={...n,photo:void 0}}else n.photo&&(t={...n,photo:void 0});const i=await x(`${re}?raceId=${encodeURIComponent(e.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",..._()},body:JSON.stringify({entry:t,deviceId:e.deviceId,deviceName:e.deviceName})},J);if(!i.ok)throw new Error(`HTTP ${i.status}`);try{const s=await i.json(),r=l.getState().currentLang;if(s.photoSkipped&&(S==null||S.showToast(p("photoTooLarge",r),"warning")),s.crossDeviceDuplicate){const a=s.crossDeviceDuplicate,o=ms(a.point,r);S==null||S.showToast(p("crossDeviceDuplicate",r).replace("{bib}",a.bib).replace("{point}",o).replace("{device}",a.deviceName),"warning",5e3),window.dispatchEvent(new CustomEvent("cross-device-duplicate",{detail:a}))}typeof s.deviceCount=="number"&&l.setCloudDeviceCount(s.deviceCount),typeof s.highestBib=="number"&&l.setCloudHighestBib(s.highestBib)}catch(s){u.warn("Failed to parse send response body:",s)}return l.removeFromSyncQueue(n.id),S==null||S.onResetFastPolling(),!0}catch(t){return u.error("Cloud sync send error:",t),!1}}async function Ms(n){const e=new Map,t=l.getState();if(!t.settings.sync||!t.raceId||n.length===0){for(const s of n)e.set(s.id,!1);return e}const i=n.slice(0,Ft);try{const s=[];for(const o of i){let d={...o};if(t.settings.syncPhotos&&Oe(o.photo)){const h=await le.getPhoto(o.id);h?d={...o,photo:h}:d={...o,photo:void 0}}else o.photo&&(d={...o,photo:void 0});s.push(d)}const r=await x(`${re}?raceId=${encodeURIComponent(t.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",..._()},body:JSON.stringify({entries:s,deviceId:t.deviceId,deviceName:t.deviceName})},J);if(!r.ok)throw new Error(`HTTP ${r.status}`);const a=await r.json();if(Array.isArray(a.results))for(const o of a.results)e.set(String(o.entryId),o.success===!0);for(const o of i)e.get(o.id)===!0&&l.removeFromSyncQueue(o.id);return typeof a.deviceCount=="number"&&l.setCloudDeviceCount(a.deviceCount),typeof a.highestBib=="number"&&l.setCloudHighestBib(a.highestBib),S==null||S.onResetFastPolling(),e}catch(s){u.error("Cloud sync batch send error:",s);for(const r of i)e.set(r.id,!1);return e}}async function $s(){const n=l.getState();if(!(!n.settings.sync||!n.raceId))for(const e of n.entries)e.deviceId===n.deviceId&&!e.syncedAt&&await Fe(e)}function Bs(){S=null,ne=0,ee=null}let G=null,je=[];function xs(n){G=n}function _s(n){const e=l.getState();je=n.filter(t=>t.deviceId!==e.deviceId)}function Os(){return je}async function Hs(){const n=l.getState();if(!(!n.settings.sync||!n.raceId))try{const e=new URLSearchParams({raceId:n.raceId,deviceId:n.deviceId,deviceName:n.deviceName});n.deviceRole==="gateJudge"&&n.gateAssignment&&(e.set("gateStart",String(n.gateAssignment[0])),e.set("gateEnd",String(n.gateAssignment[1])),e.set("isReady",String(n.isJudgeReady)),e.set("firstGateColor",n.firstGateColor));const t=await x(`${Je}?${e}`,{headers:{"Accept-Encoding":"gzip, deflate",..._()}},J);if(!t.ok){if(t.status===401)return;throw new Error(`HTTP ${t.status}`)}const i=await t.json();if(!i||typeof i!="object")throw new Error("Invalid fault data structure");const s=Array.isArray(i.faults)?i.faults:[],r=Array.isArray(i.deletedIds)?i.deletedIds.filter(a=>typeof a=="string"):[];if(r.length>0&&l.removeDeletedCloudFaults(r),s.length>0){const a=l.mergeFaultsFromCloud(s,r);if(a>0){const o=l.getState().currentLang;G==null||G.showToast(p("syncedFaultsFromCloud",o).replace("{count}",String(a)))}}Array.isArray(i.gateAssignments)&&_s(i.gateAssignments)}catch(e){u.error("Fault sync fetch error:",e),window.dispatchEvent(new CustomEvent("fault-sync-error",{detail:{error:e instanceof Error?e.message:"Unknown error"}}))}}async function Mt(n){const e=l.getState();if(!e.settings.sync||!e.raceId)return!1;try{const t=await x(`${Je}?raceId=${encodeURIComponent(e.raceId)}`,{method:"POST",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",..._()},body:JSON.stringify({fault:n,deviceId:e.deviceId,deviceName:e.deviceName,gateRange:e.gateAssignment,isReady:e.isJudgeReady,firstGateColor:e.firstGateColor})},J);if(!t.ok)throw new Error(`HTTP ${t.status}`);return l.markFaultSynced(n.id),G==null||G.onResetFastPolling(),!0}catch(t){return u.error("Fault sync send error:",t),!1}}async function Vs(n,e,t){const i=l.getState();if(!i.settings.sync||!i.raceId)return!1;try{const s=await x(`${Je}?raceId=${encodeURIComponent(i.raceId)}`,{method:"DELETE",headers:{"Content-Type":"application/json","Accept-Encoding":"gzip, deflate",..._()},body:JSON.stringify({faultId:n,deviceId:e||i.deviceId,deviceName:i.deviceName,approvedBy:t||i.deviceName})},J);if(!s.ok)throw new Error(`HTTP ${s.status}`);return!0}catch(s){return u.error("Fault sync delete error:",s),!1}}async function zs(){const n=l.getState();if(!(!n.settings.sync||!n.raceId))for(const e of n.faultEntries)e.deviceId===n.deviceId&&!e.syncedAt&&await Mt(e)}function Us(){G=null,je=[]}class Gs{constructor(){c(this,"isMetered",!1);c(this,"currentQuality","good");c(this,"networkChangeHandler",null);c(this,"onlineHandler",null);c(this,"offlineHandler",null);c(this,"changeListeners",new Set);c(this,"qualityListeners",new Set)}getConnection(){return navigator.connection}initialize(){this.currentQuality=navigator.onLine?"good":"offline";const e=this.getConnection();e&&(this.updateNetworkState(e),this.networkChangeHandler||(this.networkChangeHandler=()=>{const t=this.isMetered,i=this.currentQuality;this.updateNetworkState(e),t!==this.isMetered&&this.notifyListeners(),i!==this.currentQuality&&this.notifyQualityListeners()},e.addEventListener("change",this.networkChangeHandler)))}updateNetworkState(e){this.isMetered=e.saveData===!0||e.type==="cellular"||e.effectiveType==="slow-2g"||e.effectiveType==="2g",this.currentQuality=this.detectConnectionQuality(e)}detectConnectionQuality(e){return navigator.onLine?e&&(e.effectiveType==="2g"||e.effectiveType==="slow-2g"||e.saveData)?"slow":"good":"offline"}isMeteredConnection(){return this.isMetered}getConnectionQuality(){return this.currentQuality}onMeteredChange(e){return this.changeListeners.add(e),()=>{this.changeListeners.delete(e)}}onQualityChange(e){return this.qualityListeners.add(e),()=>{this.qualityListeners.delete(e)}}notifyListeners(){for(const e of this.changeListeners)e(this.isMetered)}notifyQualityListeners(){for(const e of this.qualityListeners)e(this.currentQuality)}registerOnlineHandlers(e,t){this.onlineHandler=()=>{const i=this.currentQuality,s=this.getConnection();this.currentQuality=this.detectConnectionQuality(s),i!==this.currentQuality&&this.notifyQualityListeners(),e()},this.offlineHandler=()=>{const i=this.currentQuality;this.currentQuality="offline",i!==this.currentQuality&&this.notifyQualityListeners(),t()},window.addEventListener("online",this.onlineHandler),window.addEventListener("offline",this.offlineHandler)}cleanup(){const e=this.getConnection();this.networkChangeHandler&&e&&(e.removeEventListener("change",this.networkChangeHandler),this.networkChangeHandler=null),this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.offlineHandler&&(window.removeEventListener("offline",this.offlineHandler),this.offlineHandler=null),this.changeListeners.clear(),this.qualityListeners.clear()}}const Q=new Gs;class Js{constructor(){c(this,"pollInterval",null);c(this,"consecutiveErrors",0);c(this,"consecutiveNoChanges",0);c(this,"currentIdleLevel",0);c(this,"currentBatteryLevel","normal");c(this,"currentBatteryRawLevel",1);c(this,"currentConnectionQuality","good");c(this,"isTabHidden",!1);c(this,"batteryUnsubscribe",null);c(this,"meteredUnsubscribe",null);c(this,"qualityUnsubscribe",null);c(this,"isAdjustingInterval",!1);c(this,"currentPollingIntervalMs",0);c(this,"pollCallback",null)}initialize(e){this.pollCallback=e,this.batteryUnsubscribe=A.subscribe(t=>{const i=this.currentBatteryLevel,s=this.currentBatteryRawLevel;this.currentBatteryLevel=t.batteryLevel,this.currentBatteryRawLevel=t.level;const r=s>=.05&&t.level<.05||s<.05&&t.level>=.05;(i!==t.batteryLevel||r)&&this.pollInterval&&this.applyBatteryAwarePolling()}),this.meteredUnsubscribe=Q.onMeteredChange(()=>{this.pollInterval&&this.applyBatteryAwarePolling()}),this.currentConnectionQuality=Q.getConnectionQuality(),this.qualityUnsubscribe=Q.onQualityChange(t=>{const i=this.currentConnectionQuality;this.currentConnectionQuality=t,i!==t&&this.pollInterval&&this.applyBatteryAwarePolling()})}start(){this.currentPollingIntervalMs=0,this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.pollCallback&&this.pollCallback();const e=this.consecutiveErrors>2?ft:Pt;this.setPollingInterval(e)}stop(){this.pollInterval&&(clearInterval(this.pollInterval),this.pollInterval=null),this.currentPollingIntervalMs=0}isPolling(){return this.pollInterval!==null}getPollingConfig(){const e=Q.isMeteredConnection();return this.currentConnectionQuality==="offline"?{intervals:[bt],threshold:1,baseInterval:bt}:this.isTabHidden?{intervals:[St],threshold:1,baseInterval:St}:this.currentBatteryRawLevel<.05&&!A.isCharging()?{intervals:[vt],threshold:1,baseInterval:vt}:this.currentConnectionQuality==="slow"||e?{intervals:Ts,threshold:Nt,baseInterval:this.currentConnectionQuality==="slow"?ks:Cs}:Rs[this.currentBatteryLevel]}setPollingInterval(e){this.currentPollingIntervalMs===e&&this.pollInterval||(this.pollInterval&&clearInterval(this.pollInterval),this.currentPollingIntervalMs=e,this.pollCallback&&(this.pollInterval=setInterval(this.pollCallback,e)))}applyBatteryAwarePolling(){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{const e=this.getPollingConfig();if(!e.intervals||e.intervals.length===0){this.setPollingInterval(e.baseInterval);return}this.currentIdleLevel=Math.min(Math.max(0,this.currentIdleLevel),e.intervals.length-1);const t=this.consecutiveNoChanges<e.threshold?e.baseInterval:e.intervals[this.currentIdleLevel];this.setPollingInterval(t)}finally{this.isAdjustingInterval=!1}}}adjustPollingInterval(e,t=!1){if(!this.isAdjustingInterval){this.isAdjustingInterval=!0;try{if(!e){this.consecutiveErrors++,this.consecutiveErrors>2&&this.pollInterval&&this.setPollingInterval(ft);return}this.consecutiveErrors=0;const i=this.getPollingConfig();if(!i.intervals||i.intervals.length===0){this.pollInterval&&this.setPollingInterval(i.baseInterval);return}if(t)this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval&&this.setPollingInterval(i.baseInterval);else if(this.consecutiveNoChanges++,this.consecutiveNoChanges>=i.threshold){const s=Math.min(Math.max(0,this.currentIdleLevel+1),i.intervals.length-1);s!==this.currentIdleLevel&&(this.currentIdleLevel=s,this.pollInterval&&this.setPollingInterval(i.intervals[this.currentIdleLevel]))}}finally{this.isAdjustingInterval=!1}}}resetToFastPolling(){if(this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.pollInterval){const e=this.getPollingConfig();this.setPollingInterval(e.baseInterval)}}setTabHidden(e){this.isTabHidden!==e&&(this.isTabHidden=e,this.pollInterval&&(e?this.applyBatteryAwarePolling():(this.pollCallback&&this.pollCallback(),this.applyBatteryAwarePolling())))}cleanup(){this.stop(),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null),this.meteredUnsubscribe&&(this.meteredUnsubscribe(),this.meteredUnsubscribe=null),this.qualityUnsubscribe&&(this.qualityUnsubscribe(),this.qualityUnsubscribe=null),this.pollCallback=null,this.consecutiveErrors=0,this.consecutiveNoChanges=0,this.currentIdleLevel=0,this.isTabHidden=!1,this.currentConnectionQuality="good"}}const B=new Js;class js{constructor(){c(this,"queueInterval",null);c(this,"isProcessingQueue",!1);c(this,"sendEntryCallback",null);c(this,"sendBatchCallback",null)}initialize(e){this.sendEntryCallback=e}initializeBatch(e){this.sendBatchCallback=e}start(){this.queueInterval&&clearInterval(this.queueInterval),this.queueInterval=setInterval(()=>this.processQueue(),ws)}stop(){this.queueInterval&&(clearInterval(this.queueInterval),this.queueInterval=null)}isProcessing(){return this.queueInterval!==null}async processQueue(){if(!this.isProcessingQueue){this.isProcessingQueue=!0;try{const e=l.getState();if(!e.settings.sync||!e.raceId||e.syncQueue.length===0)return;if(!this.sendEntryCallback){u.warn("Queue processor: No send callback configured");return}const t=Date.now(),i=[],s=[];for(const r of e.syncQueue){if(r.retryCount>=bs){u.warn("Max retries exceeded for entry:",r.entry.id),s.push(r.entry.id);continue}const a=Ss*2**r.retryCount;if(!(t-r.lastAttempt<a)&&(i.push({entry:r.entry,retryCount:r.retryCount}),i.length>=Ft))break}for(const r of s)l.removeFromSyncQueue(r);if(i.length===0)return;if(i.length>=2&&this.sendBatchCallback){const r=i.map(o=>o.entry),a=await this.sendBatchCallback(r);for(const o of i)a.get(o.entry.id)!==!0&&l.updateSyncQueueItem(o.entry.id,{retryCount:o.retryCount+1,lastAttempt:t,error:"Failed to sync"})}else for(const r of i)await this.sendEntryCallback(r.entry)||l.updateSyncQueueItem(r.entry.id,{retryCount:r.retryCount+1,lastAttempt:t,error:"Failed to sync"})}finally{this.isProcessingQueue=!1}}}getQueueLength(){return l.getState().syncQueue.length}cleanup(){this.stop(),this.sendEntryCallback=null,this.sendBatchCallback=null}}const U=new js;class Qs{constructor(){c(this,"visibilityHandler",null);c(this,"wasQueueProcessingBeforeHidden",!1)}initialize(){const e=l.getState();if(!e.settings.sync||!e.raceId){this.cleanup();return}this.initializeModules(),te.initialize(e.raceId),Q.initialize(),B.start(),U.start();try{$s()}catch(t){u.error("Failed to push local entries during sync init:",t)}try{zs()}catch(t){u.error("Failed to push local faults during sync init:",t)}this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?(B.setTabHidden(!0),this.wasQueueProcessingBeforeHidden=U.isProcessing(),U.stop()):(B.setTabHidden(!1),this.wasQueueProcessingBeforeHidden&&U.start())},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.visibilityHandler()),A.initialize(),Q.registerOnlineHandlers(()=>{l.getState().syncStatus==="offline"&&(l.setSyncStatus("connecting"),B.start())},()=>{l.setSyncStatus("offline")}),navigator.onLine?l.setSyncStatus("connecting"):l.setSyncStatus("offline")}initializeModules(){B.initialize(()=>{wt()}),U.initialize(Fe),U.initializeBatch(Ms),Ds({onPollingAdjust:(e,t)=>{B.adjustPollingInterval(e,t)},onResetFastPolling:()=>{B.resetToFastPolling()},onCleanup:()=>this.cleanup(),showToast:(e,t,i)=>this.showSyncToast(e,t,i),fetchFaults:()=>Hs()}),xs({onResetFastPolling:()=>{B.resetToFastPolling()},showToast:(e,t,i)=>this.showSyncToast(e,t,i)})}showSyncToast(e,t="success",i){window.dispatchEvent(new CustomEvent("show-toast",{detail:{message:e,type:t,duration:i}}))}cleanup(){B.cleanup(),U.cleanup(),te.cleanup(),Q.cleanup(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.wasQueueProcessingBeforeHidden=!1,Bs(),Us(),l.setSyncStatus("disconnected")}async forceRefresh(){await wt()}getQueueLength(){return U.getQueueLength()}getLastSyncTime(){return Ls()}broadcastEntry(e){te.broadcastEntry(e)}broadcastPresence(){te.broadcastPresence()}resetToFastPolling(){B.resetToFastPolling()}sendEntryToCloud(e){return Fe(e)}deleteEntryFromCloud(e,t){return Ns(e,t)}sendFaultToCloud(e){return Mt(e)}async deleteFaultFromCloud(e,t,i){return Vs(e,t,i)}getOtherGateAssignments(){return Os()}async checkRaceExists(e){if(!e)return{exists:!1,entryCount:0};try{const t=await x(`${re}?raceId=${encodeURIComponent(e)}&checkOnly=true`,{headers:{"Accept-Encoding":"gzip, deflate",..._()}},5e3);if(!t.ok)return{exists:!1,entryCount:0};const i=await t.json();return{exists:i.exists===!0,entryCount:typeof i.entryCount=="number"?i.entryCount:0}}catch(t){return u.error("Check race exists error:",t),{exists:!1,entryCount:0}}}async getPhotoSyncStats(){const e=l.getState();let t=0,i=0,s=0,r=0;for(const a of e.entries)if(Oe(a.photo)&&a.deviceId===e.deviceId){const o=await le.getPhoto(a.id);o&&(t++,i+=o.length)}if(e.settings.sync&&e.raceId)try{const a=new URLSearchParams({raceId:e.raceId,deviceId:e.deviceId,deviceName:e.deviceName}),o=await x(`${re}?${a}`,{headers:{"Accept-Encoding":"gzip, deflate",..._()}},J);if(o.ok){const d=await o.json(),h=Array.isArray(d.entries)?d.entries:[];for(const f of h)if(He(f.photo)&&f.deviceId!==e.deviceId){const g=e.entries.find(y=>y.id===f.id&&y.deviceId===f.deviceId);(!g||!g.photo)&&(s++,r+=f.photo.length)}}}catch(a){u.warn("Failed to fetch cloud entries for photo stats:",a)}return{uploadCount:t,uploadSize:i,downloadCount:s,downloadSize:r,totalSize:i+r}}}const de=new Qs;async function ba(n){const e=l.getState();de.broadcastEntry(n),e.settings.sync&&e.raceId&&(await de.sendEntryToCloud(n)||l.addToSyncQueue(n))}async function qs(n){const e=l.getState();te.broadcastFault(n),e.settings.sync&&e.raceId&&await de.sendFaultToCloud(n)}async function Ws(n){const e=l.getState();return te.broadcastFaultDeletion(n.id),e.settings.sync&&e.raceId?de.deleteFaultFromCloud(n.id,n.deviceId,n.markedForDeletionBy):!0}class Ys{constructor(){c(this,"recognition",null);c(this,"llmConfig",null);c(this,"isEnabled",!1);c(this,"isPaused",!1);c(this,"isOnline",typeof navigator<"u"?navigator.onLine:!0);c(this,"pendingIntent",null);c(this,"status","inactive");c(this,"confirmationTimeout",null);c(this,"restartTimeout",null);c(this,"stateCallbacks",new Set);c(this,"actionCallbacks",new Set);c(this,"CONFIRMATION_TIMEOUT_MS",1e4);c(this,"LLM_TIMEOUT_MS",5e3);c(this,"RESTART_DELAY_MS",500);c(this,"handleOnline",()=>{var e;if(this.isOnline=!0,this.isEnabled){this.setStatus("listening");try{(e=this.recognition)==null||e.start()}catch{}}});c(this,"handleOffline",()=>{var e;this.isOnline=!1,this.isEnabled&&(this.setStatus("offline"),(e=this.recognition)==null||e.stop())})}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(e){if(!this.isSupported())return u.warn("[Voice] Speech Recognition not supported"),!1;if(!z.isSupported())return u.warn("[Voice] Speech Synthesis not supported"),!1;this.llmConfig=e;const t=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new t,this.recognition.continuous=!0,this.recognition.interimResults=!1,this.updateRecognitionLanguage(),this.setupRecognitionHandlers(),window.addEventListener("online",this.handleOnline),window.addEventListener("offline",this.handleOffline),u.debug("[Voice] Initialized successfully"),!0}updateRecognitionLanguage(){if(!this.recognition)return;const e=l.getState().currentLang;this.recognition.lang=e==="de"?"de-DE":"en-US",z.setLanguage(e)}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{u.debug("[Voice] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{const t=e.results[e.resultIndex];if(t.isFinal){const i=t[0].transcript.trim();u.debug("[Voice] Transcript:",i),this.processTranscript(i)}},this.recognition.onerror=e=>{switch(u.warn("[Voice] Recognition error:",e.error),e.error){case"network":this.setStatus("offline");break;case"not-allowed":case"service-not-allowed":this.setStatus("error"),this.disable();break;case"no-speech":case"audio-capture":break;case"aborted":return;default:this.setStatus("error")}},this.recognition.onend=()=>{u.debug("[Voice] Recognition ended"),this.isEnabled&&this.isOnline&&!this.isPaused&&this.status!=="error"&&this.scheduleRestart()})}scheduleRestart(){this.restartTimeout&&clearTimeout(this.restartTimeout),this.restartTimeout=setTimeout(()=>{var e;if(this.isEnabled&&this.isOnline&&!this.isPaused)try{(e=this.recognition)==null||e.start()}catch{}},this.RESTART_DELAY_MS)}async processTranscript(e){if(!e||!this.llmConfig)return;this.setStatus("processing");const t=l.getState(),i={role:t.deviceRole,language:t.currentLang,currentRun:t.selectedRun,activeBibs:t.deviceRole==="gateJudge"?this.getActiveBibs(t.selectedRun):void 0,gateRange:t.gateAssignment||void 0,pendingConfirmation:this.pendingIntent||void 0};try{const s=await Zi(e,i,this.llmConfig,this.LLM_TIMEOUT_MS);await this.handleIntent(s)}catch(s){u.error("[Voice] Processing error:",s),this.setStatus("error"),await z.sayNotUnderstood(),this.setStatus("listening")}}getActiveBibs(e){const t=l.getState(),i=new Set,s=new Set;for(const r of t.entries)r.run===e&&(r.point==="S"?i.add(r.bib):r.point==="F"&&s.add(r.bib));return Array.from(i).filter(r=>!s.has(r))}async handleIntent(e){if(this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.pendingIntent&&(e.action==="confirm"||e.action==="cancel")){if(e.action==="confirm")this.executeIntent(this.pendingIntent),await z.sayRecorded();else{const t=l.getState().currentLang;await z.speak(t==="de"?"Abgebrochen":"Cancelled")}this.pendingIntent=null,this.setStatus("listening");return}if(e.action==="unknown"||e.confidence<.5){await z.sayNotUnderstood(),this.setStatus("listening");return}if(e.confirmationNeeded&&e.confirmationPrompt){this.pendingIntent=e,this.setStatus("confirming"),await z.speak(e.confirmationPrompt),this.confirmationTimeout=setTimeout(()=>{this.pendingIntent&&(u.debug("[Voice] Confirmation timeout"),this.pendingIntent=null,this.setStatus("listening"))},this.CONFIRMATION_TIMEOUT_MS);return}this.executeIntent(e),this.setStatus("listening")}executeIntent(e){u.debug("[Voice] Executing intent:",e.action);for(const t of this.actionCallbacks)t(e)}setStatus(e){if(this.status!==e){this.status=e;for(const t of this.stateCallbacks)t(e)}}enable(){if(!this.recognition||!this.llmConfig)return u.warn("[Voice] Not initialized"),!1;if(!this.isOnline)return this.setStatus("offline"),!1;this.isEnabled=!0,this.updateRecognitionLanguage();try{return this.recognition.start(),!0}catch(e){return u.warn("[Voice] Failed to start recognition:",e),this.setStatus("error"),!1}}disable(){var e;this.isEnabled=!1,this.isPaused=!1,this.pendingIntent=null,this.confirmationTimeout&&(clearTimeout(this.confirmationTimeout),this.confirmationTimeout=null),this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.stop()}catch{}z.cancel(),this.setStatus("inactive")}pause(){var e;if(!(!this.isEnabled||this.isPaused)){this.isPaused=!0,this.restartTimeout&&(clearTimeout(this.restartTimeout),this.restartTimeout=null);try{(e=this.recognition)==null||e.abort()}catch{}u.debug("[Voice] Paused")}}resume(){!this.isEnabled||!this.isPaused||(this.isPaused=!1,this.isOnline&&this.status!=="error"&&this.scheduleRestart(),u.debug("[Voice] Resumed"))}getStatus(){return this.status}isActive(){return this.isEnabled}onStatusChange(e){return this.stateCallbacks.add(e),()=>this.stateCallbacks.delete(e)}onAction(e){return this.actionCallbacks.add(e),()=>this.actionCallbacks.delete(e)}isPausedState(){return this.isPaused}cleanup(){this.disable(),this.stateCallbacks.clear(),this.actionCallbacks.clear(),window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),this.recognition=null,this.llmConfig=null}}const Sa=new Ys;class Zs{constructor(){c(this,"recognition",null);c(this,"status","idle");c(this,"isDestroyed",!1);c(this,"statusCallbacks",new Set);c(this,"transcriptCallbacks",new Set);c(this,"MAX_DURATION_MS",3e4);c(this,"recordingTimeout",null)}isSupported(){return typeof window>"u"?!1:!!(window.SpeechRecognition||window.webkitSpeechRecognition)}initialize(){if(this.recognition)return!0;if(!this.isSupported())return u.warn("[VoiceNote] Speech Recognition not supported"),this.setStatus("unsupported"),!1;const e=window.SpeechRecognition||window.webkitSpeechRecognition;return this.recognition=new e,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.setupRecognitionHandlers(),this.updateLanguage(),u.debug("[VoiceNote] Initialized successfully"),!0}updateLanguage(){if(!this.recognition)return;const e=l.getState().currentLang;this.recognition.lang=e==="de"?"de-DE":"en-US"}setupRecognitionHandlers(){this.recognition&&(this.recognition.onstart=()=>{u.debug("[VoiceNote] Recognition started"),this.setStatus("listening")},this.recognition.onresult=e=>{let t="",i="";for(let s=e.resultIndex;s<e.results.length;s++){const r=e.results[s];r.isFinal?i+=r[0].transcript:t+=r[0].transcript}t&&this.notifyTranscript(t,!1),i&&this.notifyTranscript(i,!0)},this.recognition.onerror=e=>{switch(u.warn("[VoiceNote] Recognition error:",e.error),e.error){case"not-allowed":case"service-not-allowed":this.setStatus("error");break;case"no-speech":case"audio-capture":this.setStatus("idle");break;case"aborted":this.setStatus("idle");break;default:this.setStatus("error")}this.clearRecordingTimeout()},this.recognition.onend=()=>{u.debug("[VoiceNote] Recognition ended"),this.clearRecordingTimeout(),this.status==="listening"&&this.setStatus("idle")})}start(){var e;if(this.isDestroyed||!this.initialize())return!1;this.updateLanguage();try{return(e=this.recognition)==null||e.start(),this.recordingTimeout=setTimeout(()=>{u.debug("[VoiceNote] Max duration reached, stopping"),this.stop()},this.MAX_DURATION_MS),!0}catch(t){return u.warn("[VoiceNote] Failed to start:",t),this.setStatus("error"),!1}}stop(){var e;this.clearRecordingTimeout();try{(e=this.recognition)==null||e.stop()}catch{}this.setStatus("idle")}abort(){var e;this.clearRecordingTimeout();try{(e=this.recognition)==null||e.abort()}catch{}this.setStatus("idle")}clearRecordingTimeout(){this.recordingTimeout&&(clearTimeout(this.recordingTimeout),this.recordingTimeout=null)}setStatus(e){if(this.status!==e){this.status=e;for(const t of this.statusCallbacks)try{t(e)}catch(i){u.error("[VoiceNote] Status callback error:",i)}}}notifyTranscript(e,t){for(const i of this.transcriptCallbacks)try{i(e,t)}catch(s){u.error("[VoiceNote] Transcript callback error:",s)}}getStatus(){return this.status}isRecording(){return this.status==="listening"}onStatusChange(e){return this.statusCallbacks.add(e),()=>this.statusCallbacks.delete(e)}onTranscript(e){return this.transcriptCallbacks.add(e),()=>this.transcriptCallbacks.delete(e)}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.abort(),this.statusCallbacks.clear(),this.transcriptCallbacks.clear(),this.recognition=null)}}const wa=new Zs,Ks=600*1e3,Xs=60*1e3;class er{constructor(){c(this,"wakeLock",null);c(this,"isEnabled",!1);c(this,"visibilityHandler",null);c(this,"lastInteraction",Date.now());c(this,"idleCheckInterval",null);c(this,"interactionHandler",null)}isSupported(){return"wakeLock"in navigator}async enable(){return this.isSupported()?this.isEnabled?!0:(this.isEnabled=!0,this.lastInteraction=Date.now(),this.visibilityHandler||(this.visibilityHandler=()=>{!document.hidden&&this.isEnabled&&!this.wakeLock&&this.requestWakeLock()},document.addEventListener("visibilitychange",this.visibilityHandler)),this.startIdleTracking(),this.requestWakeLock()):!1}async disable(){this.isEnabled=!1,this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.stopIdleTracking(),await this.releaseWakeLock()}resetIdleTimer(){this.lastInteraction=Date.now(),this.isEnabled&&!this.wakeLock&&this.requestWakeLock()}startIdleTracking(){this.interactionHandler||(this.interactionHandler=()=>this.resetIdleTimer(),document.addEventListener("touchstart",this.interactionHandler,{passive:!0}),document.addEventListener("mousedown",this.interactionHandler),document.addEventListener("keydown",this.interactionHandler)),this.idleCheckInterval===null&&(this.idleCheckInterval=setInterval(()=>this.checkIdle(),Xs))}stopIdleTracking(){this.interactionHandler&&(document.removeEventListener("touchstart",this.interactionHandler),document.removeEventListener("mousedown",this.interactionHandler),document.removeEventListener("keydown",this.interactionHandler),this.interactionHandler=null),this.idleCheckInterval!==null&&(clearInterval(this.idleCheckInterval),this.idleCheckInterval=null)}checkIdle(){if(!this.isEnabled)return;if(Date.now()-this.lastInteraction>=Ks&&this.wakeLock){u.debug("[WakeLock] Idle timeout reached, releasing wake lock"),this.releaseWakeLock();const t=l.getState().currentLang;P(p("wakeLockIdleTimeout",t),"warning",5e3)}}async requestWakeLock(){if(!this.isSupported()||this.wakeLock)return!!this.wakeLock;if(A.isCriticalBattery())return u.debug("[WakeLock] Critical battery, skipping wake lock request"),!1;try{return this.wakeLock=await navigator.wakeLock.request("screen"),this.wakeLock.addEventListener("release",()=>{this.wakeLock=null}),!0}catch(e){const t=e instanceof Error?e.message:"Unknown error";u.warn("Wake Lock request failed:",t),this.wakeLock=null;const i=l.getState().currentLang;return P(p("wakeLockFailed",i),"warning",2e3),!1}}async releaseWakeLock(){if(this.wakeLock){try{await this.wakeLock.release()}catch(e){u.warn("Wake Lock release error:",e)}this.wakeLock=null}}isActive(){return this.wakeLock!==null}isWakeLockEnabled(){return this.isEnabled}}const Ea=new er,Ae=new Map;function Ia(n){return Ae.has(n)||Ae.set(n,document.getElementById(n)),Ae.get(n)}function Qe(n=18){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`}function tr(n=14){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/><line x1="9" y1="11" x2="9" y2="17"/><line x1="15" y1="11" x2="15" y2="17"/></svg>`}function qe(n=18){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>`}function Ne(n=16,e=2.5){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${e}"><path d="M20 6L9 17l-5-5"/></svg>`}function nr(n=16,e=2){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${e}"><path d="M18 6L6 18M6 6l12 12"/></svg>`}function Ta(n=16,e=!1){return`<svg class="group-chevron" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true" style="flex-shrink: 0; transition: transform 0.2s; ${e?"transform: rotate(90deg);":""}"><path d="M9 18l6-6-6-6"/></svg>`}function ir(n=12){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>`}function sr(n=18){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="currentColor"><path d="M12 15.2a3.2 3.2 0 100-6.4 3.2 3.2 0 000 6.4z"/><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>`}function $t(n=12){return`<svg width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 9v4M12 17h.01"/><circle cx="12" cy="12" r="10"/></svg>`}function rr(n=14){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>`}function Ca(n=16){return`<svg aria-hidden="true" width="${n}" height="${n}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2v6l4 4-4 4v6h12v-6l-4-4 4-4V2H6z"/></svg>`}function ka(n){return`<button class="${n.className||"result-edit-btn"}" aria-label="${T(n.ariaLabel)}" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; opacity: 0.7;">${qe(n.size||18)}</button>`}function Ra(n){return`<button class="${n.className||"result-delete"}" aria-label="${T(n.ariaLabel)}" style="background: none; border: none; color: var(--error); padding: 6px; cursor: pointer; opacity: 0.7;">${Qe(n.size||18)}</button>`}function Aa(n){return`<button class="result-photo-btn" aria-label="${T(n)}" style="background: none; border: none; color: var(--primary); padding: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;">${sr()}</button>`}function Da(n){return`<span class="result-duplicate-badge" title="${T(p("multiDeviceDuplicate",n))}" aria-label="${T(p("multiDeviceDuplicate",n))}">${ir()} ${L(p("multiDeviceDuplicate",n))}</span>`}function La(n){var r;const{faults:e,lang:t}=n;if(e.length===0)return"";const i=e.map(a=>`T${a.gateNumber} (${Ge(a.faultType,t)})`).join(", "),s=e.length>1?`${e.length}× ${p("flt",t)}`:`T${((r=e[0])==null?void 0:r.gateNumber)||"?"}`;return`<span class="result-fault-badge" title="${T(i)}" style="padding: 2px 6px; border-radius: var(--radius); font-size: 0.7rem; font-weight: 600; background: var(--warning); color: #000;">${L(s)}</span>`}function Pa(n,e="var(--error)",t="white",i="0.7rem"){return`<span class="result-status" style="padding: 2px 6px; border-radius: var(--radius); font-size: ${i}; font-weight: 600; background: ${e}; color: ${t};">${L(n)}</span>`}function Fa(n="0.7rem"){return`<span class="deletion-pending-status" style="display: flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: var(--radius); font-size: ${n}; font-weight: 600; background: var(--error); color: white;">${$t()} DEL</span>`}function Na(n,e){return`<span class="result-run" data-advanced style="padding: 4px 6px; border-radius: var(--radius); font-size: 0.75rem; font-weight: 600; min-width: 36px; text-align: center; background: ${e}20; color: ${e};">${L(n)}</span>`}function Ma(n,e,t="48px",i="0.75rem"){return`<div class="result-point" style="padding: 4px 6px; border-radius: var(--radius); font-size: ${i}; font-weight: 600; min-width: ${t}; text-align: center; background: ${e}20; color: ${e};">${L(n)}</div>`}const Et=0,ar=1,or=3,cr=7;class $a{constructor(e){c(this,"container");c(this,"timeElement");c(this,"dateElement");c(this,"dateRow");c(this,"lastTimeStr","");c(this,"animationId",null);c(this,"isRunning",!1);c(this,"visibilityHandler",null);c(this,"frameSkipCount",Et);c(this,"currentFrame",0);c(this,"batteryUnsubscribe",null);c(this,"isDestroyed",!1);c(this,"cachedDigits",[]);c(this,"tickCallbacks",new Set);c(this,"tick",()=>{if(this.isRunning)try{if(this.currentFrame++,this.frameSkipCount===0||this.currentFrame%(this.frameSkipCount+1)===0){const t=new Date,i=gs(t);if(i!==this.lastTimeStr&&(this.updateDigits(i),this.lastTimeStr=i,this.tickCallbacks.size>0)){const r=i.substring(0,2),a=i.substring(3,5),o=i.substring(6,8),d=i.substring(9,12);for(const h of this.tickCallbacks)try{h(r,a,o,d)}catch(f){u.error("Clock tick callback error:",f)}}if(t.getSeconds()===0||!this.dateElement.textContent){const r=l.getState();this.dateElement.textContent=ps(t,r.currentLang)}}this.animationId=requestAnimationFrame(this.tick)}catch(e){if(u.error("Clock tick error:",e),this.animationId===null)try{this.animationId=requestAnimationFrame(this.tick)}catch(t){u.error("Clock RAF scheduling failed:",t),setTimeout(()=>{this.isRunning&&this.animationId===null&&this.tick()},16)}}});this.container=e,this.container.innerHTML="",this.timeElement=this.createTimeElement(),this.dateRow=this.createDateRow(),this.dateElement=this.dateRow.querySelector(".clock-date"),this.container.appendChild(this.timeElement),this.container.appendChild(this.dateRow),this.cachedDigits=Array.from(this.timeElement.querySelectorAll(".clock-digit")),this.moveTimingPointsToDateRow()}moveTimingPointsToDateRow(){const e=document.querySelector(".timing-controls");e&&this.dateRow&&this.dateRow.appendChild(e)}createTimeElement(){const e=document.createElement("div");e.className="clock-time",e.setAttribute("role","timer"),e.setAttribute("aria-live","polite");const t=l.getState().currentLang;e.setAttribute("aria-label",p("currentTime",t)),e.style.cssText=`
      font-family: 'JetBrains Mono', monospace;
      font-size: clamp(32px, 10vw, 48px);
      font-weight: 700;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--primary-light) 0%, var(--primary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-align: center;
      text-shadow: 0 0 40px rgba(56, 189, 248, 0.3);
    `;for(let i=0;i<12;i++){const s=document.createElement("span");s.className="clock-digit",s.dataset.index=String(i),e.appendChild(s)}return e}createDateRow(){const e=document.createElement("div");e.className="clock-date-row",e.style.cssText=`
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 4px;
      padding: 0 8px;
      width: 100%;
    `;const t=document.createElement("div");return t.className="clock-date",t.style.cssText=`
      font-size: 0.875rem;
      color: var(--text-secondary);
    `,e.appendChild(t),e}start(){this.isRunning||(this.isRunning=!0,this.tick(),this.visibilityHandler||(this.visibilityHandler=()=>{document.hidden?this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null):this.isRunning&&this.animationId===null&&this.tick()},document.addEventListener("visibilitychange",this.visibilityHandler),document.hidden&&this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null)),this.batteryUnsubscribe||A.initialize().then(()=>{this.batteryUnsubscribe=A.subscribe(e=>{this.updateFrameSkipFromBattery(e.batteryLevel)})}).catch(e=>u.debug("Battery API unavailable:",e)))}updateFrameSkipFromBattery(e){switch(e){case"critical":this.frameSkipCount=cr;break;case"low":this.frameSkipCount=or;break;case"medium":this.frameSkipCount=ar;break;default:this.frameSkipCount=Et}}stop(){this.isRunning=!1,this.animationId!==null&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.batteryUnsubscribe&&(this.batteryUnsubscribe(),this.batteryUnsubscribe=null)}updateDigits(e){for(let t=0;t<e.length&&t<this.cachedDigits.length;t++){const i=this.cachedDigits[t],s=e[t];i.textContent!==s&&(i.textContent=s,i.style.transform="scale(1.02)",requestAnimationFrame(()=>{i.style.transform="scale(1)"}))}}getCurrentTime(){return this.lastTimeStr}getTimestamp(){const e=Gi.getTimestamp();return e?new Date(e):new Date}onTick(e){return this.tickCallbacks.add(e),()=>{this.tickCallbacks.delete(e)}}destroy(){this.isDestroyed||(this.isDestroyed=!0,this.stop(),this.visibilityHandler&&(document.removeEventListener("visibilitychange",this.visibilityHandler),this.visibilityHandler=null),this.tickCallbacks.clear(),this.container.innerHTML="")}}class We{constructor(){c(this,"listeners",[])}add(e,t,i,s){e.addEventListener(t,i,s),this.listeners.push([e,t,i,s])}removeAll(){for(const[e,t,i,s]of this.listeners)e.removeEventListener(t,i,s);this.listeners=[]}get count(){return this.listeners.length}}const ve=80,It=2.5;class Ba{constructor(e){c(this,"container");c(this,"indicator");c(this,"styleElement",null);c(this,"onRefresh");c(this,"startY",0);c(this,"currentY",0);c(this,"isPulling",!1);c(this,"isRefreshing",!1);c(this,"scrollableParent",null);c(this,"listeners",new We);c(this,"onTouchStart",e=>{var i;this.isRefreshing||(((i=this.scrollableParent)==null?void 0:i.scrollTop)??0)>0||(this.startY=e.touches[0].clientY,this.isPulling=!0)});c(this,"onTouchMove",e=>{var t;if(!(!this.isPulling||this.isRefreshing))try{if((((t=this.scrollableParent)==null?void 0:t.scrollTop)??0)>0){this.isPulling=!1;return}this.currentY=e.touches[0].clientY;const s=(this.currentY-this.startY)/It;s>0&&(e.preventDefault(),this.updateIndicator(s))}catch(i){u.error("PullToRefresh move error:",i),this.isPulling=!1,this.resetIndicator()}});c(this,"onTouchEnd",async()=>{if(!this.isPulling||this.isRefreshing)return;const e=(this.currentY-this.startY)/It;this.isPulling=!1,e>=ve?(this.isRefreshing=!0,await this.triggerRefresh()):this.resetIndicator()});this.container=e.container,this.onRefresh=e.onRefresh,this.indicator=this.createIndicator(),this.container.insertBefore(this.indicator,this.container.firstChild),this.scrollableParent=e.scrollElement??this.findScrollableParent(this.container)??this.findScrollableChild(this.container),this.bindEvents()}createIndicator(){const e=document.createElement("div");e.className="pull-indicator",e.style.cssText=`
      position: absolute;
      top: -60px;
      left: 0;
      right: 0;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.875rem;
      transition: transform 0.2s;
      pointer-events: none;
      z-index: 100;
    `;const t=l.getState().currentLang;return e.innerHTML=`
      <div class="pull-indicator-content" style="display: flex; align-items: center; gap: 8px;">
        <svg class="pull-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="transition: transform 0.2s;">
          <path d="M12 19V5M5 12l7-7 7 7"/>
        </svg>
        <span class="pull-text">${p("pullToRefresh",t)}</span>
      </div>
      <div class="pull-spinner" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
          <path d="M21 12a9 9 0 11-6.219-8.56"/>
        </svg>
      </div>
    `,this.styleElement=document.createElement("style"),this.styleElement.textContent=`
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    `,document.head.appendChild(this.styleElement),e}findScrollableParent(e){let t=e.parentElement;for(;t;){const i=getComputedStyle(t);if(i.overflowY==="auto"||i.overflowY==="scroll")return t;t=t.parentElement}return null}findScrollableChild(e){const t=e.querySelectorAll("*");for(const i of t)if(i instanceof HTMLElement){const s=getComputedStyle(i);if(s.overflowY==="auto"||s.overflowY==="scroll")return i}return null}bindEvents(){this.listeners.add(this.container,"touchstart",this.onTouchStart,{passive:!0}),this.listeners.add(this.container,"touchmove",this.onTouchMove,{passive:!1}),this.listeners.add(this.container,"touchend",this.onTouchEnd,{passive:!0})}updateIndicator(e){const t=Math.min(e,ve*1.5);this.indicator.style.transform=`translateY(${t}px)`;const i=Math.min(e/ve,1),s=this.indicator.querySelector(".pull-icon"),r=this.indicator.querySelector(".pull-text");if(s&&(s.style.transform=`rotate(${i*180}deg)`),r){const a=l.getState().currentLang;r.textContent=i>=1?p("releaseToRefresh",a):p("pullToRefresh",a)}}async triggerRefresh(){const e=this.indicator.querySelector(".pull-indicator-content"),t=this.indicator.querySelector(".pull-spinner");e&&(e.style.display="none"),t&&(t.style.display="flex"),this.indicator.style.transform=`translateY(${ve}px)`;try{await this.onRefresh()}catch(i){u.error("PullToRefresh callback error:",i)}finally{this.isRefreshing=!1,e&&(e.style.display="flex"),t&&(t.style.display="none"),this.resetIndicator()}}resetIndicator(){this.indicator.style.transform="translateY(0)";const e=this.indicator.querySelector(".pull-icon");e&&(e.style.transform="rotate(0deg)")}destroy(){this.isRefreshing=!1,this.isPulling=!1,this.listeners.removeAll(),this.indicator.remove(),this.styleElement&&(this.styleElement.remove(),this.styleElement=null)}}const X=80,lr=.5;class xa{constructor(e){c(this,"element");c(this,"wrapper");c(this,"leftAction");c(this,"rightAction");c(this,"options");c(this,"startX",0);c(this,"startY",0);c(this,"currentX",0);c(this,"startTime",0);c(this,"isHorizontalSwipe",null);c(this,"listeners",new We);c(this,"onTouchStart",e=>{this.startX=e.touches[0].clientX,this.startY=e.touches[0].clientY,this.currentX=0,this.startTime=Date.now(),this.isHorizontalSwipe=null,this.wrapper.style.transition="none"});c(this,"onTouchMove",e=>{const t=e.touches[0].clientX-this.startX,i=e.touches[0].clientY-this.startY;if(this.isHorizontalSwipe===null&&(Math.abs(t)>10||Math.abs(i)>10)&&(this.isHorizontalSwipe=Math.abs(t)>Math.abs(i)),!this.isHorizontalSwipe)return;e.preventDefault();const s=X*1.2;this.currentX=Math.max(-s,Math.min(s,t)),this.wrapper.style.transform=`translateX(${this.currentX}px)`});c(this,"onTouchEnd",()=>{if(!this.isHorizontalSwipe)return;const e=Date.now()-this.startTime,i=Math.abs(this.currentX)/e>lr;this.wrapper.style.transition="transform 0.2s ease-out",Math.abs(this.currentX)>=X||i?this.currentX<0&&this.options.onSwipeLeft?(this.wrapper.style.transform=`translateX(-${X}px)`,setTimeout(()=>{var s,r;(r=(s=this.options).onSwipeLeft)==null||r.call(s),this.reset()},200)):this.currentX>0&&this.options.onSwipeRight?(this.wrapper.style.transform=`translateX(${X}px)`,setTimeout(()=>{var s,r;(r=(s=this.options).onSwipeRight)==null||r.call(s),this.reset()},200)):this.reset():this.reset()});this.options=e,this.element=e.element,this.wrapper=this.createWrapper(),this.leftAction=this.createLeftAction(),this.rightAction=this.createRightAction(),this.setupDOM(),this.bindEvents()}createWrapper(){const e=document.createElement("div");return e.className="swipe-content",e.style.cssText=`
      position: relative;
      transform: translateX(0);
      transition: transform 0.2s ease-out;
      background: inherit;
      z-index: 1;
    `,e}createLeftAction(){const e=document.createElement("div");return e.className="swipe-action swipe-action-left",e.style.cssText=`
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      width: ${X}px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--primary);
      color: white;
      font-weight: 600;
      z-index: 0;
    `,e.innerHTML=this.options.rightContent||qe(24),e}createRightAction(){const e=document.createElement("div");return e.className="swipe-action swipe-action-right",e.style.cssText=`
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      width: ${X}px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--error);
      color: white;
      font-weight: 600;
      z-index: 0;
    `,e.innerHTML=this.options.leftContent||Qe(24),e}setupDOM(){const e=this.element.style;for((e.display==="flex"||e.display==="inline-flex")&&(this.wrapper.style.display=e.display,e.alignItems&&(this.wrapper.style.alignItems=e.alignItems),e.justifyContent&&(this.wrapper.style.justifyContent=e.justifyContent),e.gap&&(this.wrapper.style.gap=e.gap),this.wrapper.style.width="100%",e.padding&&(this.wrapper.style.padding=e.padding,e.padding="0"));this.element.firstChild;)this.wrapper.appendChild(this.element.firstChild);this.element.style.position="relative",this.element.style.overflow="hidden",this.element.appendChild(this.leftAction),this.element.appendChild(this.rightAction),this.element.appendChild(this.wrapper)}bindEvents(){this.listeners.add(this.wrapper,"touchstart",this.onTouchStart,{passive:!0}),this.listeners.add(this.wrapper,"touchmove",this.onTouchMove,{passive:!1}),this.listeners.add(this.wrapper,"touchend",this.onTouchEnd,{passive:!0})}reset(){this.wrapper.style.transition="transform 0.2s ease-out",this.wrapper.style.transform="translateX(0)",this.currentX=0}destroy(){for(this.listeners.removeAll();this.wrapper.firstChild;)this.element.appendChild(this.wrapper.firstChild);this.wrapper.remove(),this.leftAction.remove(),this.rightAction.remove()}}const dr=3e3,ur=1e3,hr=5;class fr{constructor(){c(this,"container");c(this,"queue",[]);c(this,"isShowing",!1);c(this,"toastEventListener");c(this,"lastCopyTime",0);c(this,"isDestroyed",!1);this.container=this.createContainer(),document.body.appendChild(this.container),this.toastEventListener=(e=>{this.show(e.detail.message,{type:e.detail.type,duration:e.detail.duration})}),window.addEventListener("show-toast",this.toastEventListener)}createContainer(){const e=document.createElement("div");return e.id="toast-container",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-atomic","true"),e.style.cssText=`
      position: fixed;
      bottom: calc(80px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%);
      z-index: 10000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    `,e}show(e,t={}){for(;this.queue.length>=hr;){const i=this.queue.findIndex(s=>!s.options.action);if(i>=0)this.queue.splice(i,1);else break}this.queue.push({message:e,options:t}),this.isShowing||this.processQueue()}processQueue(){if(this.queue.length===0){this.isShowing=!1;return}this.isShowing=!0;const{message:e,options:t}=this.queue.shift(),i=t.duration||dr,s=t.type||"info",r=this.createToast(e,s,t.action);this.container.appendChild(r),requestAnimationFrame(()=>{r.style.opacity="1",r.style.transform="translateY(0)"});let a=!1;const o=()=>{a||(a=!0,r.style.opacity="0",r.style.transform="translateY(10px)",setTimeout(()=>{r.remove(),this.processQueue()},200))};r._dismiss=o,setTimeout(o,i)}createToast(e,t,i){const s=document.createElement("div");s.className=`toast toast-${t}`;const r={success:"var(--success)",error:"var(--error)",warning:"var(--warning)",info:"var(--primary)"},a={success:'<path d="M20 6L9 17l-5-5"/>',error:'<path d="M18 6L6 18M6 6l12 12"/>',warning:'<path d="M12 9v4M12 17h.01"/>',info:'<path d="M12 16v-4M12 8h.01"/>'};if(s.style.cssText=`
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface-elevated);
      border-left: 3px solid ${r[t]};
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-size: 0.875rem;
      color: var(--text-primary);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.2s, transform 0.2s;
      pointer-events: auto;
      max-width: 90vw;
    `,s.innerHTML=`
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="${r[t]}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="10"/>
        ${a[t]}
      </svg>
      <span>${L(e)}</span>
    `,i){const o=document.createElement("button");o.textContent=i.label,o.setAttribute("aria-label",i.label),o.style.cssText=`
        background: none;
        border: 1px solid ${r[t]};
        color: ${r[t]};
        padding: 2px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        margin-left: 4px;
        white-space: nowrap;
      `,o.addEventListener("click",d=>{d.stopPropagation(),d.preventDefault(),i.callback();const h=s._dismiss;h&&h()}),s.appendChild(o)}else s.addEventListener("click",o=>{o.stopPropagation(),o.preventDefault(),this.copyToClipboard(e)});return s.addEventListener("mousedown",o=>o.stopPropagation()),s.addEventListener("touchstart",o=>o.stopPropagation(),{passive:!0}),s}async copyToClipboard(e){const t=Date.now(),i=t-this.lastCopyTime>ur;this.lastCopyTime=t;try{await navigator.clipboard.writeText(e),i&&this.show(p("copied",l.getState().currentLang),{type:"success",duration:1500})}catch{}}clear(){this.queue=[],this.container.innerHTML="",this.isShowing=!1}destroy(){this.isDestroyed||(this.isDestroyed=!0,window.removeEventListener("show-toast",this.toastEventListener),this.clear(),this.container.remove())}}let se=null;function Bt(){return se||(se=new fr),se}function P(n,e="info",t,i){Bt().show(n,{type:e,duration:t,action:i==null?void 0:i.action})}function _a(){Bt().clear()}function Oa(){se&&(se.destroy(),se=null)}function gr(n){const e=new Date(n);let t=e.getHours(),i=e.getMinutes(),s=e.getSeconds(),r=Math.round(e.getMilliseconds()/10);return r>=100&&(r=0,s++,s>=60&&(s=0,i++),i>=60&&(i=0,t++),t>=24&&(t=0)),`${String(t).padStart(2,"0")}:${String(i).padStart(2,"0")}:${String(s).padStart(2,"0")},${String(r).padStart(2,"0")}`}function De(n){const e=["=","+","-","@","|","	","\r",`
`];let t=n;return e.some(i=>t.startsWith(i))&&(t=`'${t}`),/^[+]?0x/i.test(t)&&(t=`'${t}`),t.includes('"')&&(t=t.replace(/"/g,'""')),(t.includes(";")||t.includes('"')||t.includes(`
`)||t.includes("|"))&&(t=`"${t}"`),t}function pr(n){const e=new Date(n),t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${i}-${s}`}function mr(n){return n==="S"?"ST":"FT"}function Le(n,e){var i;return((i={ok:{en:"OK",de:"OK"},dns:{en:"DNS",de:"DNS"},dnf:{en:"DNF",de:"DNF"},dsq:{en:"DSQ",de:"DSQ"},flt:{en:"FLT",de:"SZT"}}[n])==null?void 0:i[e])||n.toUpperCase()}function yr(n){return n.length===0?"":n.sort((e,t)=>e.gateNumber-t.gateNumber).map(e=>`T${e.gateNumber}(${e.faultType})`).join(",")}function vr(){const n=l.getState(),e=n.entries,t=n.faultEntries,i=n.currentLang;if(e.length===0){P(p("noEntries",i),"warning");return}try{const s=[...e].sort((m,E)=>new Date(m.timestamp).getTime()-new Date(E.timestamp).getTime()),r=t.length>0,a=r?"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Torstrafzeit;Torfehler;Datum":"Startnummer;Lauf;Messpunkt;Zeit;Status;Gerät;Datum",o=s.map(m=>{const E=De(m.bib),C=m.run??1,k=mr(m.point),F=gr(m.timestamp),O=De(m.deviceName||m.deviceId),$=De(pr(m.timestamp)),H=m.point==="F"?t.filter(K=>K.bib===m.bib&&K.run===C):[];let Z;if(m.point==="F"&&H.length>0?Z=n.usePenaltyMode?Le("flt",i):Le("dsq",i):Z=Le(m.status,i),r){const K=H.length>0&&n.usePenaltyMode?H.length*n.penaltySeconds:0,D=yr(H);return`${E};${C};${k};${F};${Z};${O};${K};${D};${$}`}else return`${E};${C};${k};${F};${Z};${O};${$}`}),d=[a,...o].join(`
`),h=new Blob([d],{type:"text/csv;charset=utf-8;"}),f=URL.createObjectURL(h),g=document.createElement("a");g.href=f;const y=new Date().toISOString().split("T")[0],v=n.raceId||"race";g.download=`${v}_${y}.csv`,document.body.appendChild(g),g.click(),document.body.removeChild(g),URL.revokeObjectURL(f),he(),P(p("exported",i),"success")}catch(s){u.error("CSV export failed:",s),P(p("operationFailed",i),"error")}}function Me(n,e="csv"){const t=new Date().toISOString().split("T")[0];return`${n.replace(/[^a-zA-Z0-9-_]/g,"_")||"race"}_${t}.${e}`}function br(){const n=l.getState(),e=n.currentLang,t=n.faultEntries,i=n.raceId||"RACE";if(t.length===0){P(p("noFaultsToExport",e),"warning");return}const s=new Map;for(const g of t){const y=`${g.bib}-${g.run}`;s.has(y)||s.set(y,[]),s.get(y).push(g)}const r=[];r.push(`📋 ${p("gateFaults",e)} - ${i}`),r.push("");const a=Array.from(s.entries()).filter(([g])=>g.endsWith("-1")),o=Array.from(s.entries()).filter(([g])=>g.endsWith("-2")),d=(g,y)=>{const[v]=g.split("-"),m=v.padStart(3,"0"),E=y.sort((k,F)=>k.gateNumber-F.gateNumber).map(k=>`T${k.gateNumber}`).join("+"),C=y.map(k=>k.faultType).join(", ");if(n.usePenaltyMode){const k=y.length*n.penaltySeconds;return`#${m}: ${E} (${C}) → +${k}s`}else return`#${m}: ${E} (${C})`};a.length>0&&(r.push(`🏁 ${p("runLabel",e)} 1:`),n.usePenaltyMode?r.push(`🟡 ${p("penaltyLabel",e)}:`):r.push(`🔴 ${p("dsq",e)}:`),a.sort((g,y)=>parseInt(g[0].split("-")[0],10)-parseInt(y[0].split("-")[0],10)).forEach(([g,y])=>{r.push(d(g,y))}),r.push("")),o.length>0&&(r.push(`🏁 ${p("runLabel",e)} 2:`),n.usePenaltyMode?r.push(`🟡 ${p("penaltyLabel",e)}:`):r.push(`🔴 ${p("dsq",e)}:`),o.sort((g,y)=>parseInt(g[0].split("-")[0],10)-parseInt(y[0].split("-")[0],10)).forEach(([g,y])=>{r.push(d(g,y))}),r.push(""));const h=new Date;r.push(`📅 ${h.toLocaleDateString(e==="de"?"de-DE":"en-US")} ${h.toLocaleTimeString(e==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"})}`);const f=r.join(`
`);navigator.clipboard?navigator.clipboard.writeText(f).then(()=>{he(),P(p("copiedToClipboard",e),"success")}).catch(()=>{$e(f,Me(`${i}_WhatsApp`,"txt"))}):$e(f,Me(`${i}_WhatsApp`,"txt"))}function Sr(){const n=l.getState(),e=n.currentLang,t=n.faultEntries,i=n.raceId||"RACE";if(t.length===0){P(p("noFaultsToExport",e),"warning");return}const s=new Map;for(const g of t){const y=`${g.bib}-${g.run}`;s.has(y)||s.set(y,[]),s.get(y).push(g)}const r=[],a="══════════════════════════════════════════════════════",o=Array.from(s.entries()).filter(([g])=>g.endsWith("-1")),d=Array.from(s.entries()).filter(([g])=>g.endsWith("-2")),h=(g,y)=>{g.length!==0&&(r.push(`${p("faultSummaryTitle",e)} - ${p("runLabel",e)} ${y}`),r.push(a),r.push(`${p("bib",e).substring(0,7).padEnd(7)} │ ${p("faults",e).padEnd(16)} │ ${p("penalty",e).padStart(9)} │ Status`),r.push("────────┼──────────────────┼───────────┼────────"),g.sort((v,m)=>parseInt(v[0].split("-")[0],10)-parseInt(m[0].split("-")[0],10)).forEach(([v,m])=>{const[E]=v.split("-"),C=E.padStart(5),k=m.sort(($,H)=>$.gateNumber-H.gateNumber).map($=>`T${$.gateNumber}(${$.faultType})`).join(", ").padEnd(16);let F,O;n.usePenaltyMode?(F=`${m.length*n.penaltySeconds} ${p("sec",e)}`.padStart(9),O=p("flt",e)):(F="-".padStart(9),O=p("dsq",e)),r.push(`  ${C}   │ ${k} │ ${F} │ ${O}`)}),r.push(""))};r.push(`${i} - ${new Date().toLocaleDateString(e==="de"?"de-DE":"en-US")}`),r.push(""),h(o,1),h(d,2),r.push(a),r.push(`${p("generated",e)}: ${new Date().toLocaleString(e==="de"?"de-DE":"en-US")}`);const f=r.join(`
`);$e(f,Me(`${i}_${p("summary",e)}`,"txt")),he(),P(p("exported",e),"success")}function $e(n,e){const t=new Blob([n],{type:"text/plain;charset=utf-8;"}),i=URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}const W=new We,Be=[];let be=null;async function wr(n){return new Promise(e=>{be=e,window.dispatchEvent(new CustomEvent("request-pin-verification",{detail:{lang:n}}))})}function Er(n){be&&(be(n),be=null)}function Ir(n){window.dispatchEvent(new CustomEvent("open-fault-edit-modal",{detail:{fault:n}}))}function Tr(n){window.dispatchEvent(new CustomEvent("open-mark-deletion-modal",{detail:{fault:n}}))}function Cr(){window.dispatchEvent(new CustomEvent("update-inline-faults-list"))}function Tt(){window.dispatchEvent(new CustomEvent("update-inline-bib-selector"))}function kr(){window.dispatchEvent(new CustomEvent("update-inline-gate-selector"))}function Rr(){const n=document.getElementById("chief-judge-toggle-btn");n&&(W.add(n,"click",async()=>{const e=l.getState(),t=e.currentLang;if(e.isChiefJudgeView){l.toggleChiefJudgeView(),_e(),q(),P(p("chiefJudgeModeDisabled",t),"info");return}e.settings.sync&&e.raceId&&!await wr(t)||(l.toggleChiefJudgeView(),_e(),q(),P(p("chiefJudgeModeEnabled",t),"info"))}),xe(),Be.push(j(()=>{Ri.value,ge.value,xe()}),j(()=>{ge.value,at.value,ot.value,rt.value&&(oe(),fe())}),j(()=>{at.value,ot.value,Ye()}),j(()=>{st.value,ge.value,Ai.value,rt.value&&Ze()}),j(()=>{ge.value,ke.value==="gateJudge"&&(Cr(),Tt())}),j(()=>{st.value,ke.value==="gateJudge"&&Tt()}),j(()=>{Di.value,ke.value==="gateJudge"&&kr()})),Dr(),Ar())}function Ar(){const n=document.getElementById("export-csv-btn");n&&W.add(n,"click",()=>{q(),vr()});const e=document.getElementById("export-summary-btn");e&&W.add(e,"click",()=>{q(),Sr()});const t=document.getElementById("export-whatsapp-btn");t&&W.add(t,"click",()=>{q(),br()})}function Dr(){const n=document.getElementById("penalty-mode-toggle");n&&W.add(n,"click",t=>{const i=t.target.closest(".penalty-mode-btn");if(!i)return;const s=i.getAttribute("data-mode");s==="penalty"?l.setUsePenaltyMode(!0):s==="dsq"&&l.setUsePenaltyMode(!1),q()});const e=document.getElementById("penalty-seconds-selector");e&&W.add(e,"click",t=>{const i=t.target.closest(".penalty-adj-btn");if(!i)return;const s=i.getAttribute("data-adj"),a=l.getState().penaltySeconds;s==="+1"?l.setPenaltySeconds(a+1):s==="-1"&&l.setPenaltySeconds(a-1),q()}),Ye()}function Ye(){const n=l.getState(),e=document.getElementById("penalty-config-row"),t=document.getElementById("penalty-seconds-value"),i=document.getElementById("penalty-mode-toggle");e&&e.classList.toggle("dsq-mode",!n.usePenaltyMode),t&&(t.textContent=String(n.penaltySeconds)),i&&i.querySelectorAll(".penalty-mode-btn").forEach(r=>{const a=r.getAttribute("data-mode"),o=a==="penalty"&&n.usePenaltyMode||a==="dsq"&&!n.usePenaltyMode;r.classList.toggle("active",o),r.setAttribute("aria-pressed",String(o))})}function xe(){const n=document.getElementById("chief-judge-toggle-row");if(!n)return;const t=l.getState().settings.sync;n.style.display=t?"block":"none"}function _e(){const n=l.getState(),e=document.querySelector(".results-view"),t=document.getElementById("chief-judge-toggle-btn");!e||!t||(t.classList.toggle("active",n.isChiefJudgeView),t.setAttribute("aria-pressed",String(n.isChiefJudgeView)),e.classList.toggle("chief-mode",n.isChiefJudgeView),n.isChiefJudgeView&&(oe(),fe(),Ze()))}function Ze(){const n=document.getElementById("judges-overview-list"),e=document.getElementById("judges-overview-count"),t=document.getElementById("judges-overview-empty");if(!n||!e)return;const i=de.getOtherGateAssignments(),s=l.getState(),r=[...i];if(s.deviceRole==="gateJudge"&&s.gateAssignment&&r.push({deviceId:s.deviceId,deviceName:s.deviceName,gateStart:s.gateAssignment[0],gateEnd:s.gateAssignment[1],lastSeen:Date.now(),isReady:s.isJudgeReady}),e.textContent=String(r.length),t&&(t.style.display=r.length===0?"block":"none"),n.querySelectorAll(".judge-card").forEach(d=>d.remove()),r.length===0)return;r.sort((d,h)=>d.gateStart-h.gateStart);const o=r.map(d=>`
    <div class="judge-card${d.isReady?" ready":""}">
      <span class="judge-ready-indicator"></span>
      <span class="judge-name" title="${T(d.deviceName)}">${L(d.deviceName)}</span>
      <span class="judge-gates">${d.gateStart}–${d.gateEnd}</span>
    </div>
  `).join("");t?t.insertAdjacentHTML("beforebegin",o):n.innerHTML=o}function oe(){const n=document.getElementById("fault-summary-list"),e=document.getElementById("fault-summary-count"),t=document.getElementById("chief-empty-state");if(!n||!e)return;const i=l.getState(),s=i.currentLang,r=i.faultEntries,a=new Map;for(const v of r){const m=`${v.bib}-${v.run}`;a.has(m)||a.set(m,[]),a.get(m).push(v)}if(e.textContent=String(a.size),t&&(t.style.display=a.size===0?"flex":"none"),a.size===0){n.querySelectorAll(".fault-summary-card").forEach(m=>m.remove());return}const o=[],d=Array.from(a.entries()).sort((v,m)=>{const[E]=v,[C]=m,k=parseInt(E.split("-")[0],10)||0,F=parseInt(C.split("-")[0],10)||0;return k-F});for(const[v,m]of d){const[E,C]=v.split("-"),k=parseInt(C,10),F=l.isRacerFinalized(E,k),O=m.filter(D=>!D.markedForDeletion),$=i.usePenaltyMode?O.length*i.penaltySeconds:0,H=m.map(D=>{const V=D.markedForDeletion,_t=V&&D.markedForDeletionBy?`${p("deletionPending",s)} (${D.markedForDeletionBy})`:"",Ot=D.notes&&D.notes.length>0;return`
        <div class="fault-entry-row${V?" marked-for-deletion":""}" data-fault-id="${T(D.id)}">
          <div class="fault-gate-info">
            <span class="fault-gate-num${V?" strikethrough":""}">${p("gate",s)} ${L(String(D.gateNumber))}</span>
            <span class="fault-type-badge${V?" marked":""}">${Ge(D.faultType,s)}</span>
            ${Ot?`<span class="fault-note-icon" title="${T(p("hasNote",s))}" aria-label="${T(p("hasNote",s))}">${rr(14)}</span>`:""}
            ${V?`<span class="deletion-pending-badge" title="${T(_t)}">${$t(14)}</span>`:""}
          </div>
          <span class="fault-judge-name">${L(D.deviceName)}</span>
          <div class="fault-row-actions">
            <button class="fault-row-btn edit-fault-btn" data-fault-id="${T(D.id)}" title="${T(p("edit",s))}" ${V?"disabled":""}>
              ${qe(14)}
            </button>
            <button class="fault-row-btn delete-fault-btn" data-fault-id="${T(D.id)}" title="${T(p(V?"rejectDeletion":"markForDeletion",s))}">
              ${V?tr(14):Qe(14)}
            </button>
          </div>
        </div>
      `}).join(""),Z=F?`<div class="finalized-badge">
           ${Ne(16,2.5)}
           ${p("finalized",s)}
         </div>`:`<button class="finalize-btn" data-bib="${T(E)}" data-run="${T(String(k))}">
           ${Ne(16)}
           ${p("finalize",s)}
         </button>`,K=i.usePenaltyMode?`<span class="fault-card-penalty">+${$}s</span>
         <span class="fault-card-result flt">${p("flt",s)}</span>`:`<span class="fault-card-result dsq">${p("dsq",s)}</span>`;o.push(`
      <div class="fault-summary-card${F?" finalized":""}" data-bib="${T(E)}" data-run="${T(String(k))}">
        <div class="fault-card-header">
          <span class="fault-card-bib">#${L(E.padStart(3,"0"))}</span>
          <div class="fault-card-status">
            ${K}
          </div>
        </div>
        <div class="fault-card-body">
          ${H}
        </div>
        <div class="fault-card-actions">
          ${Z}
        </div>
      </div>
    `)}n.querySelectorAll(".fault-summary-card").forEach(v=>v.remove()),t?t.insertAdjacentHTML("beforebegin",o.join("")):n.innerHTML=o.join(""),n.querySelectorAll(".finalize-btn").forEach(v=>{v.addEventListener("click",Pr)}),n.querySelectorAll(".edit-fault-btn").forEach(v=>{v.addEventListener("click",m=>{m.stopPropagation();const E=v.dataset.faultId;if(E){const C=l.getState().faultEntries.find(k=>k.id===E);C&&Ir(C)}})}),n.querySelectorAll(".delete-fault-btn").forEach(v=>{v.addEventListener("click",m=>{m.stopPropagation();const E=v.dataset.faultId;if(E){const C=l.getState().faultEntries.find(k=>k.id===E);C&&(C.markedForDeletion?xt(C):Tr(C))}})})}function xt(n){if(l.rejectFaultDeletion(n.id)){const t=l.getState().faultEntries.find(s=>s.id===n.id);t&&qs(t);const i=l.getState().currentLang;P(p("deletionRejected",i),"success"),he(),oe(),fe()}}function Lr(n){const e=l.approveFaultDeletion(n.id);if(e){Ws(e);const t=l.getState().currentLang;P(p("deletionApproved",t),"success"),_i(),oe(),fe()}}function fe(){const n=document.getElementById("pending-deletions-section"),e=document.getElementById("pending-deletions-list"),t=document.getElementById("pending-deletions-count");if(!n||!e||!t)return;const i=l.getPendingDeletions(),r=l.getState().currentLang;if(t.textContent=String(i.length),n.style.display=i.length>0?"block":"none",i.length===0){e.innerHTML="";return}const a=i.map(o=>{const d=o.markedForDeletionAt?new Date(o.markedForDeletionAt).toLocaleTimeString(r==="de"?"de-DE":"en-US",{hour:"2-digit",minute:"2-digit"}):"";return`
      <div class="pending-deletion-item" data-fault-id="${T(o.id)}">
        <div class="pending-deletion-info">
          <span class="pending-deletion-fault">
            #${L(o.bib.padStart(3,"0"))} T${L(String(o.gateNumber))} (${Ge(o.faultType,r)}) - ${p(o.run===1?"run1":"run2",r)}
          </span>
          <span class="pending-deletion-meta">
            ${p("deletionMarkedBy",r)}: ${L(o.markedForDeletionBy||"?")} (${L(d)})
          </span>
        </div>
        <div class="pending-deletion-actions">
          <button class="pending-deletion-btn approve" data-fault-id="${T(o.id)}" title="${T(p("approveDeletion",r))}">
            ${Ne(16,2.5)}
          </button>
          <button class="pending-deletion-btn reject" data-fault-id="${T(o.id)}" title="${T(p("rejectDeletion",r))}">
            ${nr(16)}
          </button>
        </div>
      </div>
    `}).join("");e.innerHTML=a,e.querySelectorAll(".pending-deletion-btn.approve").forEach(o=>{o.addEventListener("click",d=>{d.stopPropagation();const h=o.dataset.faultId;if(h){const f=i.find(g=>g.id===h);f&&Lr(f)}})}),e.querySelectorAll(".pending-deletion-btn.reject").forEach(o=>{o.addEventListener("click",d=>{d.stopPropagation();const h=o.dataset.faultId;if(h){const f=i.find(g=>g.id===h);f&&xt(f)}})})}function Pr(n){const e=n.currentTarget,t=e.dataset.bib,i=e.dataset.run;if(!t||!i)return;const s=parseInt(i,10);l.finalizeRacer(t,s),he();const r=l.getState();P(`#${t.padStart(3,"0")} ${p("finalized",r.currentLang)}`,"success"),oe()}function Fr(){for(const n of Be)n();Be.length=0,W.removeAll()}const Ha=Object.freeze(Object.defineProperty({__proto__:null,cleanupChiefJudgeView:Fr,initChiefJudgeToggle:Rr,resolvePinVerification:Er,updateChiefJudgeToggleVisibility:xe,updateChiefJudgeView:_e,updateFaultSummaryPanel:oe,updateJudgesOverview:Ze,updatePenaltyConfigUI:Ye,updatePendingDeletionsPanel:fe},Symbol.toStringTag,{value:"Module"}));export{st as $,Na as A,Da as B,fa as C,ms as D,La as E,Ma as F,Pa as G,Aa as H,ka as I,Ra as J,Fa as K,We as L,Qr as M,ge as N,Oe as O,le as P,_i as Q,Ba as R,xa as S,ra as T,vr as U,da as V,_ as W,ds as X,ca as Y,ua as Z,x as _,P as a,oa as a0,ma as a1,an as a2,va as a3,b as a4,Ce as a5,vs as a6,ia as a7,sa as a8,Br as a9,Yr as aA,Zr as aB,Kr as aC,Xr as aD,ea as aE,Pe as aF,ya as aG,Ca as aH,la as aI,xr as aJ,Bt as aK,Ha as aL,$a as aa,ta as ab,Gi as ac,Ri as ad,Or as ae,Vr as af,Hr as ag,_a as ah,ba as ai,$r as aj,Re as ak,Ea as al,Oa as am,ht as an,Er as ao,aa as ap,Ur as aq,Gr as ar,Jr as as,zr as at,ke as au,Ai as av,Di as aw,jr as ax,qr as ay,Wr as az,qs as b,q as c,na as d,L as e,he as f,Ge as g,T as h,rr as i,Qe as j,gs as k,Ws as l,_r as m,Sa as n,Ia as o,de as p,Ne as q,u as r,l as s,p as t,A as u,wa as v,ha as w,pa as x,ga as y,Ta as z};
