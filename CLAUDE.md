# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Ski Race Timer is a GPS-synchronized race timing Progressive Web App (PWA) for ski races. It's a TypeScript single-page application designed for mobile use in outdoor race conditions.

## Commands

- **Start dev server**: `npm start` or `npm run dev`
- **Build**: `npm run build` (TypeScript compilation + Vite build)
- **Run tests**: `npm test` (unit tests) or `npm run test:e2e` (Playwright E2E tests)
- **Type check**: `npm run typecheck`

## Architecture

### Source Structure

```
.
├── api/                    # Vercel serverless functions (v1)
│   ├── v1/                 # Versioned API endpoints
│   │   ├── auth/
│   │   │   └── token.js   # JWT token exchange endpoint
│   │   ├── admin/
│   │   │   ├── races.js   # Race management API
│   │   │   ├── pin.js     # PIN management API
│   │   │   └── reset-pin.js # PIN reset (server-side auth)
│   │   ├── sync.js        # Cloud sync API
│   │   └── faults.js      # Fault entries API
│   └── lib/
│       ├── jwt.js         # Shared JWT utilities
│       └── response.js    # Shared API response utilities
├── src/
│   ├── app.ts             # Main application logic
│   ├── main.ts            # App entry point and initialization
│   ├── onboarding.ts      # First-run onboarding wizard
│   ├── store/             # State management (Zustand-like)
│   ├── services/          # GPS, sync, camera, feedback services
│   ├── components/        # UI components (Clock, VirtualList, Toast)
│   ├── features/          # Feature modules (modals, ripple, export)
│   ├── utils/             # Validation, error handling, API utilities
│   ├── i18n/              # Translations (EN/DE)
│   ├── styles/            # CSS stylesheets
│   └── types/             # TypeScript type definitions
├── public/
│   ├── icons/             # App icons (72-512px PNG)
│   ├── manifest.json      # PWA manifest
│   └── sw.js              # Service worker (auto-generated by VitePWA)
├── tests/
│   ├── api/               # API unit tests (Vitest)
│   ├── unit/              # Component/service unit tests
│   └── e2e/               # Playwright E2E tests
└── index.html             # Entry point
```

### Key Components

The app has three tab-based views:
1. **Timer** - Radial dial interface (iPod-style) for bib input, real-time clock display, timing point selection (S/Z), run selection (L1/L2)
2. **Results** - List of recorded times with run indicator, CSV export (Race Horology format), entry editing/deletion, photo thumbnails
3. **Settings** - GPS sync, cloud sync, auto-increment bib, haptic/sound feedback, language toggle (EN/DE), photo capture, race management

### Radial Dial Timer (iPod-style Interface)

The timer view uses a radial dial interface inspired by the iPod click wheel. Located in:
- `src/components/RadialDial.ts` - Core dial component with touch/mouse handling
- `src/features/radialTimerView.ts` - View logic, state management, timestamp recording
- `src/styles/radial-dial.css` - All styling for the radial interface

**Key Features:**
- **Tap-to-enter**: Tap a number (0-9) to append it to the bib
- **Spin-to-increment**: Drag around the dial to increment/decrement the bib number
- **Momentum physics**: Dial continues spinning with friction after release
- **Snap-back**: Dial returns to starting position after 800ms of inactivity
- **Timing point selector**: S (Start) / Z (Ziel/Finish) buttons on left side of dial center
- **Run selector**: L1/L2 buttons on right side of dial center
- **Keyboard shortcuts**: Number keys, S/F for points, Space/Enter for timestamp

**Technical Implementation:**
- Numbers positioned at `radius = containerSize * 0.38` from center
- Dial center is 52% of container size, uses `pointer-events: none` with nested buttons having `pointer-events: auto`
- Tap detection uses angle-based calculation (not `document.elementFromPoint`) to work reliably after dial rotation
- Center exclusion zone (`dist < rect.width * 0.27`) prevents drag initiation when tapping S/Z or L1/L2 buttons
- Synthetic mouse events after touch are ignored for 500ms to prevent duplicate inputs

**CSS Structure:**
```css
.timer-view.radial-mode.active { /* Grid layout for radial view */ }
.dial-container { width: 100vw; height: 100vw; }
.dial-center { width: 52%; height: 52%; /* Contains time display, S/Z, L1/L2 */ }
.dial-number { /* Positioned absolutely around dial ring */ }
```

### Data Storage

- **LocalStorage keys**:
  - `skiTimerEntries` - Race timing entries
  - `skiTimerSettings` - User settings
  - `skiTimerAuthToken` - JWT authentication token
  - `skiTimerRaceId` - Current race ID
  - `skiTimerDeviceId` - Unique device identifier
  - `skiTimerRecentRaces` - Recently synced races (for quick-select)

- **Entry format**: `{ id, bib, point: 'S'|'F', run: 1|2, timestamp, status, deviceId, deviceName, photo? }`
- **Entry status values**: `ok` (normal), `dns` (did not start), `dnf` (did not finish), `dsq` (disqualified), `flt` (finished with fault penalty for U8/U10 categories)

### Feature Modules

Located in `src/features/`, these modules organize UI functionality by domain:

**View modules** (extracted from app.ts):
- **radialTimerView.ts** (~600 lines) - Radial dial timer interface, clock display, timestamp recording
- **timerView.ts** (~470 lines) - Classic timer view (hidden when radial mode active)
- **resultsView.ts** (~250 lines) - VirtualList, filtering, search, pull-to-refresh
- **settingsView.ts** (~550 lines) - Settings toggles, role selection, recent races
- **gateJudgeView.ts** (~350 lines) - Gate judge UI, gate assignment, ready status
- **chiefJudgeView.ts** (~630 lines) - Chief judge panel, fault summaries, deletion approvals
- **faultEntry.ts** (~950 lines) - Fault recording, editing, inline entry, deletion workflow
- **raceManagement.ts** (~950 lines) - PIN management, race CRUD, auth handling

**Utility modules**:
- **modals.ts** - Modal open/close utilities with animation support
- **ripple.ts** - Material Design ripple effect for touch feedback
- **export.ts** - CSV export in Race Horology format
- **photoViewer.ts** (~100 lines) - Photo viewing and deletion from IndexedDB

**Callback injection pattern**: Modules use callback injection to avoid circular dependencies:
```typescript
// In module: define callback type and setter
let openConfirmModalCallback: ((action: string) => void) | null = null;
export function setCallbacks(callbacks: { openConfirmModal: (action: string) => void }) {
  openConfirmModalCallback = callbacks.openConfirmModal;
}

// In app.ts: inject callbacks during initialization
setCallbacks({ openConfirmModal: openConfirmModal });
```

### Utility Modules

Located in `src/utils/`:
- **recentRaces.ts** - Track recently synced races for quick-select dropdown
- **errorBoundary.ts** - Global error handling and user-friendly error display
- **api.ts** - Centralized API client with auth headers
- **validation.ts** - Input validation for race IDs, entries, etc.
- **errors.ts** - Structured error logging
- **format.ts** - Time, date, and number formatting utilities

### Multi-Device Sync

Cross-device sync uses Redis (via ioredis) with polling:
- **API endpoint**: `/api/v1/sync` handles GET (fetch), POST (add), DELETE (remove)
- **Polling interval**: 5 seconds (30 seconds on error)
- **BroadcastChannel**: Used for same-browser tab sync
- **Race ID**: Case-insensitive unique identifier to group synced devices

### Authentication

JWT-based authentication protects sync and admin APIs:

1. **Token Exchange**: User enters 4-digit PIN → `/api/v1/auth/token` returns JWT
2. **Token Storage**: JWT stored in localStorage (`skiTimerAuthToken`)
3. **Token Usage**: API calls include `Authorization: Bearer <token>` header
4. **Token Expiry**: 24-hour expiry, auto-prompts re-authentication
5. **Backwards Compatible**: Legacy PIN hash still accepted for migration

### Role-Based Access Control

JWT tokens include a `role` claim for authorization:

| Role | Description | Permissions |
|------|-------------|-------------|
| `timer` | Default role for timing devices | Read/write entries and faults |
| `gateJudge` | Gate judge devices | Read/write entries and faults |
| `chiefJudge` | Chief judge with elevated privileges | All above + **delete faults** |

- **Fault deletion** requires `chiefJudge` role (server-side enforced)
- Role is specified when exchanging PIN for token: `{ pin: "1234", role: "chiefJudge" }`
- Entering Chief Judge mode in the UI triggers re-authentication with `chiefJudge` role

### CSV Export Format (Race Horology)

Exports use semicolon delimiter and standard timing designators:
- **Columns**: Startnummer, Lauf, Messpunkt, Zeit, Status, Gerät
- **Timing Points**: ST (Start), FT (Finish)
- **Run (Lauf)**: 1 or 2 for multi-run races
- **Time Format**: HH:MM:SS.ss (hundredths of seconds)
- **CSV Injection Protection**: Formula characters escaped with single quote prefix

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `REDIS_URL` | Yes | Redis connection URL (Vercel KV or external Redis) |
| `JWT_SECRET` | **Production** | Secret for signing JWT tokens. **Required in production** - will fail to start without it. |
| `CORS_ORIGIN` | No | Allowed CORS origin (defaults to production domain) |

## API Endpoints

All endpoints use the `/api/v1/` prefix. Legacy `/api/*` paths are rewritten to v1 for backwards compatibility.

### `/api/v1/auth/token` (POST)
Exchange PIN for JWT token with optional role.
- **Body**: `{ pin: "1234", role?: "timer" | "gateJudge" | "chiefJudge" }`
- **Response**: `{ success: true, token: "jwt...", role: "timer", isNewPin?: true }`
- **Default role**: `timer` if not specified

### `/api/v1/sync` (GET/POST/DELETE)
Cloud sync for race entries. Requires JWT token when PIN is set.
- **GET**: Fetch entries for race
- **POST**: Add/update entry
- **DELETE**: Remove entry

### `/api/v1/faults` (GET/POST/DELETE)
Fault entries for gate judges. Requires JWT token.
- **GET**: Fetch faults for race (any authenticated role)
- **POST**: Add/update fault entry (any authenticated role)
- **DELETE**: Remove fault entry (**requires `chiefJudge` role**, returns 403 otherwise)

### `/api/v1/admin/races` (GET/DELETE)
Race management. Requires JWT token.
- **GET**: List all races with metadata
- **DELETE**: Delete race and set tombstone for connected clients

### `/api/v1/admin/pin` (GET/POST)
PIN hash management. Requires JWT token.
- **GET**: Get current PIN hash status
- **POST**: Set PIN hash

### `/api/v1/admin/reset-pin` (POST)
Reset PIN (server-side authentication via X-Server-Pin header).
- **Header**: `X-Server-Pin: <server-pin>`
- **Response**: `{ success: true, message: "PIN has been reset..." }`

## Testing

```bash
# Unit tests (Vitest)
npm test

# E2E tests (Playwright)
npm run test:e2e

# E2E with browser visible
npm run test:e2e:headed

# All tests
npm run test:all
```

## Vercel Deployment

1. Connect repository to Vercel
2. Add Vercel KV (Storage → Create Database → KV)
3. Set `JWT_SECRET` environment variable in Vercel dashboard
4. Deploy - environment variables auto-configured

## Version Management

**Always bump the version number in `package.json` after completing features or fixes.**

Follow semantic versioning (MAJOR.MINOR.PATCH):
- **PATCH** (x.x.1): Bug fixes, small tweaks, typo corrections
- **MINOR** (x.1.0): New features, enhancements, non-breaking changes
- **MAJOR** (1.0.0): Breaking changes, major rewrites, significant API changes

Examples:
- Single bug fix → bump patch (4.1.0 → 4.1.1)
- New feature like "Gate Judge" → bump minor (4.0.0 → 4.1.0)
- Complete rewrite or breaking change → bump major (4.1.0 → 5.0.0)

Commit the version bump separately with a message like "Bump version to X.Y.Z" summarizing what changed.

## Key Implementation Details

- **Translations**: In `src/i18n/translations.ts`, toggled via language setting. Default: German
  - Use `data-i18n` attribute on HTML elements for automatic translation
  - Short keys like `startShort`/`finishShort` for compact UI (S/F in English, S/Z in German)
  - Translations interface uses `[key: string]: string` index signature for flexibility
- **GPS sync**: Uses Geolocation API for real GPS timestamps
- **Haptic feedback**: Uses Navigator.vibrate() API
- **Sound feedback**: Uses Web Audio API for beep sounds
- **Photo capture**: Optional photo on timestamp, synced if <500KB
- **Mobile optimization**: Safe area insets for notches, touch-optimized, portrait lock
- **Service Worker**: Auto-generated by VitePWA with content-based versioning (no manual version bumps)
- **Error Handling**: Global error boundary catches uncaught errors with user-friendly recovery UI
- **TypeScript**: Strict mode enabled for better type safety
- **Motion effects**: Settings exist but currently disabled to save battery (see `src/main.ts:3-4`). The motion service uses device accelerometer for reactive UI effects.
- **Environment-aware logging**: Use `src/utils/logger.ts` - strips debug logs in production, keeps errors/warnings

## Radial Dial Development Notes

When working on the radial dial component, be aware of these common issues:

### Touch Event Handling
- **Synthetic mouse events**: After a touch event, browsers fire synthetic mouse events. Track `lastTouchTime` and ignore mouse events within 500ms of touch.
- **Pointer events**: The dial center has `pointer-events: none` to allow touch-through, but nested buttons (S/Z, L1/L2) need `pointer-events: auto`.
- **Event binding**: Events must be bound to the container (not gesture area) to catch interactions with number buttons.

### Tap Detection
- **Don't use `document.elementFromPoint`**: After dial rotation, the visual position of elements changes but `elementFromPoint` may not find them reliably.
- **Use angle-based detection**: Calculate the tap angle relative to dial center, subtract current rotation, then find the closest number within tolerance (20° = half of 36° spacing).

### State Management
- **Snap-back cleanup**: When snap-back animation completes, clear `spinAnimationId`, `isSpinning`, and remove `momentum` class.
- **Animation cancellation**: When starting a new drag/tap during animation, cancel the animation and reset `isSpinning`.

### Layout Considerations
- **Dial size**: Currently 100vw to fill screen width. Dial center at 52% leaves room for numbers at 38% radius.
- **Overlap prevention**: Use negative margins on `.radial-center-area` and constrained height on record button to prevent overlap.
- **Z-index layers**: dial-ring (base), dial-numbers (z-index: 10), dial-center (z-index: 15), top-row (z-index: 20)
