<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0D0D0D">
  <meta name="description" content="GPS-synchronized ski race timing application">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ski Race Timer">
  <link rel="manifest" href="/manifest.json">
  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" sizes="48x48">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Ski Race Timer">
  <meta property="og:description" content="GPS-synchronized ski race timing application">
  <meta property="og:image" content="/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Ski Race Timer">
  <meta name="twitter:description" content="GPS-synchronized ski race timing application">
  <meta name="twitter:image" content="/twitter-image.png">
  <title>Ski Race Timer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Skip Link -->
  <a href="#main" class="skip-link">Skip to main content</a>

  <div class="app" role="application" aria-label="Ski Race Timer">
    <!-- Header -->
    <header class="header glass-frosted-top glass-enable-target">
      <h1 class="header-title">Ski Race Timer</h1>
      <div class="header-status">
        <div class="sync-indicator" id="sync-indicator" style="display: none;">
          <span class="sync-dot"></span>
          <span class="sync-status-text" data-i18n="connecting">Connecting...</span>
          <span class="sync-device-count" id="sync-device-count" style="display: none;"></span>
        </div>
        <div class="gps-indicator" id="gps-indicator" style="display: none;">
          <span class="gps-dot"></span>
          <span class="gps-status-text" data-i18n="gps">GPS</span>
        </div>
        <div class="camera-indicator" id="camera-indicator" style="display: none;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
        </div>
        <span class="entry-count-badge" id="entry-count-badge" style="display: none;">0</span>
      </div>
    </header>

    <!-- Main Content -->
    <main id="main">
        <!-- Timer View -->
        <div class="view timer-view active">
          <!-- Clock -->
          <div class="clock-container glass-enable-target" id="clock-container"></div>

          <!-- Timing Points and Run Selector -->
          <div class="timing-controls">
            <div class="timing-points glass-enable-target" id="timing-points" role="radiogroup" aria-label="Timing Point">
            <button class="timing-point-btn glass-surface-3 active" data-point="S" role="radio" aria-checked="false" data-advanced>
              <span data-i18n="start">Start</span>
            </button>
            <button class="timing-point-btn glass-surface-3 active" data-point="F" role="radio" aria-checked="true">
              <span data-i18n="finish">Finish</span>
            </button>
          </div>
          <div class="run-selector" id="run-selector" role="radiogroup" aria-label="Run" data-advanced>
            <button class="run-btn glass-surface-3 active" data-run="1" role="radio" aria-checked="true">
              <span data-i18n="run1">L1</span>
            </button>
            <button class="run-btn glass-surface-3" data-run="2" role="radio" aria-checked="false">
              <span data-i18n="run2">L2</span>
            </button>
          </div>
        </div>

        <!-- Timestamp Button -->
        <button class="timestamp-btn glass-surface-1 glass-enable-target breathe-glow" id="timestamp-btn" aria-label="Record timestamp">
          <span data-i18n="time">TIME</span>
        </button>

        <!-- Last Recorded -->
        <div class="last-recorded" id="last-recorded">
          <span data-i18n="lastRecorded">Last recorded:</span>
          <span class="bib">---</span>
          <span class="point">-</span>
          <span class="run" data-advanced>-</span>
          <span class="time">--:--:--.---</span>
        </div>

        <!-- Bib Display -->
        <div class="bib-display glass-surface-2 glass-enable-target">
          <span class="bib-label" data-i18n="bib">Bib</span>
          <span class="bib-value">---</span>
        </div>

        <!-- Number Pad -->
        <div class="number-pad glass-enable-target" id="number-pad" role="group" aria-label="Number pad">
          <button class="num-btn glass-surface-3" data-num="1" aria-label="1">1</button>
          <button class="num-btn glass-surface-3" data-num="2" aria-label="2">2</button>
          <button class="num-btn glass-surface-3" data-num="3" aria-label="3">3</button>
          <button class="num-btn glass-surface-3" data-num="4" aria-label="4">4</button>
          <button class="num-btn glass-surface-3" data-num="5" aria-label="5">5</button>
          <button class="num-btn glass-surface-3" data-num="6" aria-label="6">6</button>
          <button class="num-btn glass-surface-3" data-num="7" aria-label="7">7</button>
          <button class="num-btn glass-surface-3" data-num="8" aria-label="8">8</button>
          <button class="num-btn glass-surface-3" data-num="9" aria-label="9">9</button>
          <button class="num-btn glass-surface-3 action" data-action="clear" aria-label="Clear">C</button>
          <button class="num-btn glass-surface-3" data-num="0" aria-label="0">0</button>
          <button class="num-btn glass-surface-3 action" data-action="delete" aria-label="Delete">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 4H8l-7 8 7 8h13a2 2 0 002-2V6a2 2 0 00-2-2z"/>
              <line x1="18" y1="9" x2="12" y2="15"/>
              <line x1="12" y1="9" x2="18" y2="15"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Results View -->
      <div class="view results-view">
        <div class="results-header">
          <!-- Search & Filter -->
          <div class="search-filter-bar" data-advanced>
            <input type="search" class="search-input" id="search-input" data-i18n-placeholder="search">
            <select class="filter-select" id="filter-point" aria-label="Filter by point">
              <option value="all" data-i18n="all">All</option>
              <option value="S">Start</option>
              <option value="F">Finish</option>
            </select>
            <select class="filter-select" id="filter-status" aria-label="Filter by status">
              <option value="all" data-i18n="all">All</option>
              <option value="ok">OK</option>
              <option value="dns">DNS</option>
              <option value="dnf">DNF</option>
              <option value="dsq">DSQ</option>
            </select>
          </div>

          <!-- Stats -->
          <div class="stats-row">
            <div class="stat-item">
              <div class="stat-value" id="stat-total">0</div>
              <div class="stat-label" data-i18n="total">Total</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-racers">0</div>
              <div class="stat-label" data-i18n="racers">Racers</div>
            </div>
            <div class="stat-item" data-advanced>
              <div class="stat-value" id="stat-finished">0</div>
              <div class="stat-label" data-i18n="finished">Finished</div>
            </div>
          </div>
        </div>

        <!-- Results List (Virtual Scrolling) -->
        <div class="results-list" id="results-list" role="list" aria-label="Results"></div>

        <!-- Select Mode Bar -->
        <div class="select-mode-bar" id="select-mode-bar">
          <span><span id="selected-count">0</span> <span data-i18n="selected">selected</span></span>
          <button class="modal-btn danger" id="delete-selected-btn" data-i18n="deleteSelected">Delete Selected</button>
        </div>

        <!-- Results Actions -->
        <div class="results-actions">
          <button class="action-btn" id="undo-btn" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 10h10a5 5 0 015 5v2M3 10l4-4M3 10l4 4"/>
            </svg>
            <span data-i18n="undo">Undo</span>
          </button>
          <button class="action-btn" id="export-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            <span data-i18n="export">Export</span>
          </button>
          <button class="action-btn danger" id="clear-all-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
            <span data-i18n="clearAll">Clear All</span>
          </button>
        </div>
      </div>

      <!-- Gate Judge View -->
      <div class="view gate-judge-view">
        <!-- Gate Assignment Header -->
        <div class="gate-judge-header">
          <div class="gate-assignment-display">
            <span class="gate-label" data-i18n="gates">Gates</span>
            <span class="gate-range" id="gate-range-display">--</span>
            <button class="gate-change-btn" id="gate-change-btn" data-i18n="changeGates">Change</button>
          </div>
          <div class="run-selector gate-judge-run-selector" id="gate-judge-run-selector" role="radiogroup" aria-label="Run">
            <button class="run-btn glass-surface-3 active" data-run="1" role="radio" aria-checked="true">
              <span data-i18n="run1">L1</span>
            </button>
            <button class="run-btn glass-surface-3" data-run="2" role="radio" aria-checked="false">
              <span data-i18n="run2">L2</span>
            </button>
          </div>
        </div>

        <!-- Active Bibs Section -->
        <div class="active-bibs-section">
          <div class="section-title" data-i18n="activeBibs">On Course</div>
          <div class="active-bibs-list" id="active-bibs-list" role="list">
            <div class="empty-state" id="no-active-bibs">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M8 12h8"/>
              </svg>
              <span data-i18n="noBibsOnCourse">No racers on course</span>
            </div>
          </div>
        </div>

        <!-- Record Fault Button -->
        <button class="record-fault-btn glass-surface-1" id="record-fault-btn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
            <line x1="4" y1="22" x2="4" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
          </svg>
          <span data-i18n="recordFault">Record Fault</span>
        </button>
      </div>

      <!-- Settings View -->
      <div class="view settings-view">
        <!-- Device Role (Prominent at top) -->
        <div class="settings-section role-section">
          <div class="settings-section-title" data-i18n="deviceRole">Device Role</div>
          <div class="role-cards-settings" id="role-toggle">
            <button class="role-card-setting active" data-role="timer">
              <div class="role-card-icon">‚è±Ô∏è</div>
              <div class="role-card-content">
                <span class="role-card-title" data-i18n="roleTimer">Timer</span>
                <span class="role-card-desc" data-i18n="roleTimerDesc">Record start and finish times</span>
              </div>
            </button>
            <button class="role-card-setting" data-role="gateJudge">
              <div class="role-card-icon">üö©</div>
              <div class="role-card-content">
                <span class="role-card-title" data-i18n="roleGateJudge">Gate Judge</span>
                <span class="role-card-desc" data-i18n="roleJudgeDesc">Record gate faults (Torrichter)</span>
              </div>
            </button>
          </div>
        </div>

        <!-- Mode Toggle (hidden - normal mode is now the default) -->
        <div class="settings-section" style="display:none">
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="simpleMode">Simple Mode</span>
              <span class="setting-description" data-i18n="simpleModeDesc">Simplified interface for basic timing</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="simple-mode-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Cloud Sync -->
        <div class="settings-section">
          <div class="settings-section-title" data-i18n="cloudSync">Cloud Sync</div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="cloudSync">Cloud Sync</span>
              <span class="setting-description" data-i18n="cloudSyncDesc">Sync with other devices</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="sync-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="setting-row" id="race-id-input-row-container">
            <div class="setting-label">
              <span class="setting-title" data-i18n="raceId">Race ID</span>
              <span class="race-exists-indicator" id="race-exists-indicator" style="display: none;">
                <svg class="race-exists-check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span class="race-exists-text" id="race-exists-text"></span>
              </span>
            </div>
            <div class="race-id-input-row">
              <input type="text" class="text-input" id="race-id-input" data-i18n-placeholder="raceIdPlaceholder" style="max-width: 120px;">
              <button class="recent-races-btn" id="settings-recent-races-btn" type="button" aria-label="Recent races">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
              </button>
              <div class="recent-races-dropdown" id="settings-recent-races-dropdown" style="display:none"></div>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="deviceName">Device Name</span>
            </div>
            <input type="text" class="text-input" id="device-name-input" data-i18n-placeholder="deviceNamePlaceholder" style="max-width: 150px;">
          </div>
          <div class="setting-row" id="sync-photos-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="syncPhotos">Sync Photos</span>
              <span class="setting-description" data-i18n="syncPhotosDesc">Share photos across devices via cloud</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="sync-photos-toggle" disabled>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Photo Capture -->
        <div class="settings-section">
          <div class="settings-section-title" data-i18n="photoCapture">Photo Capture</div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="photoCapture">Photo Capture</span>
              <span class="setting-description" data-i18n="photoCaptureDesc">Capture photo on timestamp</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="photo-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- GPS Settings -->
        <div class="settings-section" data-advanced id="gps-section">
          <div class="settings-section-title" data-i18n="gps">GPS</div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="gps">GPS Sync</span>
              <span class="setting-description" data-i18n="gpsDesc">Use GPS for accurate timestamps</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="gps-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Timing Settings -->
        <div class="settings-section" id="timing-section">
          <div class="settings-section-title">Timing</div>
          <div class="setting-row" data-advanced>
            <div class="setting-label">
              <span class="setting-title" data-i18n="autoIncrement">Auto-increment Bib</span>
              <span class="setting-description" data-i18n="autoIncrementDesc">Increase bib number after recording</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="auto-toggle" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Feedback Settings -->
        <div class="settings-section" data-advanced>
          <div class="settings-section-title">Feedback</div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="hapticFeedback">Haptic Feedback</span>
              <span class="setting-description" data-i18n="hapticFeedbackDesc">Vibration on actions</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="haptic-toggle" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="soundFeedback">Sound Feedback</span>
              <span class="setting-description" data-i18n="soundFeedbackDesc">Audio confirmation</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="sound-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Language -->
        <div class="settings-section">
          <div class="settings-section-title" data-i18n="language">Language</div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="language">Language</span>
            </div>
            <div class="lang-toggle" id="lang-toggle">
              <span class="lang-option active" data-lang="de">DE</span>
              <span class="lang-option" data-lang="en">EN</span>
            </div>
          </div>
        </div>

        <!-- Tutorial -->
        <div class="settings-section">
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="showTutorial">Show Tutorial</span>
              <span class="setting-description" data-i18n="showTutorialDesc">Run the setup wizard again</span>
            </div>
            <button class="action-btn admin-action-btn" id="show-tutorial-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
              <span data-i18n="show">Show</span>
            </button>
          </div>
        </div>

        <!-- Admin Section (hidden in simple mode) -->
        <div class="settings-section" id="admin-section">
          <div class="settings-section-title" data-i18n="admin">Admin</div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="adminPin">Admin PIN</span>
              <span class="setting-description" id="admin-pin-status" data-i18n="pinNotSet">Not set</span>
            </div>
            <button class="action-btn admin-action-btn" id="change-pin-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0110 0v4"/>
              </svg>
              <span id="change-pin-btn-text" data-i18n="setPin">Set PIN</span>
            </button>
          </div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="manageRaces">Manage Races</span>
              <span class="setting-description" data-i18n="manageRacesDesc">View and delete synced races</span>
            </div>
            <button class="action-btn admin-action-btn" id="manage-races-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
              </svg>
              <span data-i18n="manage">Manage</span>
            </button>
          </div>
        </div>

        <!-- Version -->
        <div class="settings-section">
          <div class="setting-row" style="justify-content: center; color: var(--text-tertiary); font-size: 0.75rem;">
            <span data-i18n="version">Version</span>&nbsp;<span id="app-version"></span>
          </div>
        </div>
      </div>
    </main>

    <!-- Tab Bar -->
    <nav class="tab-bar glass-frosted glass-enable-target" role="tablist" aria-label="Main navigation">
      <button class="tab-btn active" data-view="timer" role="tab" aria-selected="true" id="timer-tab">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span data-i18n="timer">Timer</span>
      </button>
      <button class="tab-btn" data-view="results" role="tab" aria-selected="false">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="8" y1="6" x2="21" y2="6"/>
          <line x1="8" y1="12" x2="21" y2="12"/>
          <line x1="8" y1="18" x2="21" y2="18"/>
          <line x1="3" y1="6" x2="3.01" y2="6"/>
          <line x1="3" y1="12" x2="3.01" y2="12"/>
          <line x1="3" y1="18" x2="3.01" y2="18"/>
        </svg>
        <span data-i18n="results">Results</span>
      </button>
      <button class="tab-btn" data-view="gateJudge" role="tab" aria-selected="false" id="gate-judge-tab" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
          <line x1="4" y1="22" x2="4" y2="15"/>
        </svg>
        <span data-i18n="gateJudgeTab">Gate</span>
      </button>
      <button class="tab-btn" data-view="settings" role="tab" aria-selected="false">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
        <span data-i18n="settings">Settings</span>
      </button>
    </nav>
  </div>

  <!-- Confirmation Overlay (outside app, same level as modals) -->
  <div class="confirmation-overlay" id="confirmation-overlay">
    <div class="confirmation-content">
      <div class="confirmation-bib">---</div>
      <div class="confirmation-point">-</div>
      <div class="confirmation-run" data-advanced>-</div>
      <div class="confirmation-time">--:--:--.---</div>
      <div class="confirmation-duplicate" style="display: none;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 9v4M12 17h.01"/>
          <circle cx="12" cy="12" r="10"/>
        </svg>
        <span data-i18n="duplicateWarning">Duplicate entry</span>
      </div>
      <div class="confirmation-zero-bib" style="display: none;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 9v4M12 17h.01"/>
          <circle cx="12" cy="12" r="10"/>
        </svg>
        <span data-i18n="zeroBibWarning">Bib 000 - verify entry</span>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay glass-enable-target" id="edit-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="edit">Edit Entry</h2>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="bib">Bib</label>
          <input type="text" class="text-input" id="edit-bib-input" maxlength="3" inputmode="numeric" pattern="[0-9]*">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="status">Status</label>
          <select class="filter-select" id="edit-status-select" style="width: 100%;">
            <option value="ok">OK</option>
            <option value="dns">DNS</option>
            <option value="dnf">DNF</option>
            <option value="dsq">DSQ</option>
          </select>
        </div>
        <div style="margin-top: 16px;" data-advanced>
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="run">Run</label>
          <div class="edit-run-selector" id="edit-run-selector">
            <button class="edit-run-btn active" data-run="1" type="button">1</button>
            <button class="edit-run-btn" data-run="2" type="button">2</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="save-edit-btn" data-i18n="save">Save</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay glass-enable-target" id="confirm-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="confirmDelete">Delete Entry</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" data-i18n="confirmDeleteText">Are you sure you want to delete this entry?</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn danger" id="confirm-delete-btn" data-i18n="delete">Delete</button>
      </div>
    </div>
  </div>

  <!-- Race Change Modal -->
  <div class="modal-overlay glass-enable-target" id="race-change-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="raceChangeTitle">Change Race</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" id="race-change-text" data-i18n="raceChangeUnsyncedText">You have existing results. Keep them or delete before switching?</p>
      </div>
      <div class="modal-footer" style="flex-wrap: wrap; gap: 8px;">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="race-change-keep-btn" data-i18n="keepResults">Keep</button>
        <button class="modal-btn primary" id="race-change-export-btn" data-i18n="export">Export</button>
        <button class="modal-btn danger" id="race-change-delete-btn" data-i18n="delete">Delete</button>
      </div>
    </div>
  </div>

  <!-- Photo Viewer Modal -->
  <div class="modal-overlay glass-enable-target" id="photo-viewer-modal">
    <div class="modal-content glass-surface-1 photo-viewer-content">
      <div class="modal-header photo-viewer-header">
        <h2 class="modal-title" data-i18n="viewPhoto">View Photo</h2>
        <button class="photo-viewer-close" id="photo-viewer-close-btn" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="photo-viewer-image-container">
        <img id="photo-viewer-image" class="photo-viewer-image" src="" alt="">
      </div>
      <div class="photo-viewer-metadata">
        <span class="photo-viewer-bib" id="photo-viewer-bib">---</span>
        <span class="photo-viewer-point" id="photo-viewer-point">S</span>
        <span class="photo-viewer-time" id="photo-viewer-time">00:00:00.000</span>
      </div>
      <div class="modal-footer">
        <button class="modal-btn text-danger" id="photo-viewer-delete-btn" data-i18n="deletePhoto">Delete Photo</button>
        <button class="modal-btn primary" id="photo-viewer-close-footer-btn" data-i18n="close">Close</button>
      </div>
    </div>
  </div>

  <!-- Race Deleted Modal -->
  <div class="modal-overlay glass-enable-target" id="race-deleted-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="raceDeleted">Race Deleted</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" id="race-deleted-text" data-i18n="raceDeletedText">This race has been deleted by an administrator.</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn primary" id="race-deleted-ok-btn" data-i18n="ok">OK</button>
      </div>
    </div>
  </div>

  <!-- Photo Sync Warning Modal -->
  <div class="modal-overlay glass-enable-target" id="photo-sync-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="syncPhotosWarning">Enable Photo Sync</h2>
      </div>
      <div class="modal-body">
        <p data-i18n="syncPhotosWarningText">Enabling photo sync will transfer the following data:</p>
        <div class="photo-sync-stats" id="photo-sync-stats">
          <div class="photo-sync-stat">
            <span class="photo-sync-label" data-i18n="photosToUpload">Photos to upload</span>
            <span class="photo-sync-value" id="photos-upload-count">0</span>
          </div>
          <div class="photo-sync-stat">
            <span class="photo-sync-label" data-i18n="photosToDownload">Photos to download</span>
            <span class="photo-sync-value" id="photos-download-count">0</span>
          </div>
          <div class="photo-sync-stat total">
            <span class="photo-sync-label" data-i18n="totalDataVolume">Total data volume</span>
            <span class="photo-sync-value" id="photos-total-size">0 KB</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" id="photo-sync-cancel-btn" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="photo-sync-confirm-btn" data-i18n="enableSync">Enable Sync</button>
      </div>
    </div>
  </div>

  <!-- Race Management Modal -->
  <div class="modal-overlay glass-enable-target" id="race-management-modal">
    <div class="modal-content glass-surface-1 race-management-content">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="manageRaces">Manage Races</h2>
      </div>
      <div class="modal-body">
        <div class="race-list" id="race-list" role="region" aria-live="polite">
          <div class="race-list-loading" id="race-list-loading" aria-busy="true">
            <span data-i18n="loading">Loading...</span>
          </div>
          <div class="race-list-empty" id="race-list-empty" style="display: none;">
            <span data-i18n="noRaces">No active races</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="close">Close</button>
        <button class="modal-btn secondary" id="refresh-races-btn" data-i18n="refresh">Refresh</button>
      </div>
    </div>
  </div>

  <!-- Admin PIN Modal (for verifying PIN to access race management) -->
  <div class="modal-overlay glass-enable-target" id="admin-pin-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" id="admin-pin-modal-title" data-i18n="enterAdminPin">Enter Admin PIN</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" id="admin-pin-modal-text" data-i18n="enterPinText">Enter the admin PIN to access race management.</p>
        <input type="tel" inputmode="numeric" pattern="[0-9]*" class="text-input" id="admin-pin-verify-input" placeholder="0000" maxlength="4" style="margin-top: 12px; text-align: center; font-size: 1.5rem; letter-spacing: 0.3em; width: 120px;">
        <p class="admin-pin-error" id="admin-pin-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 8px;" data-i18n="incorrectPin">Incorrect PIN</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="admin-pin-verify-btn" data-i18n="verify">Verify</button>
      </div>
    </div>
  </div>

  <!-- Set/Change PIN Modal -->
  <div class="modal-overlay glass-enable-target" id="change-pin-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" id="change-pin-modal-title" data-i18n="setPin">Set PIN</h2>
      </div>
      <div class="modal-body">
        <div id="current-pin-row" style="display: none; margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="currentPin">Current PIN</label>
          <input type="tel" inputmode="numeric" pattern="[0-9]*" class="text-input" id="current-pin-input" placeholder="0000" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.3em; width: 120px;">
          <p class="admin-pin-error" id="current-pin-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 8px;" data-i18n="incorrectPin">Incorrect PIN</p>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="newPin">New PIN (4 digits)</label>
          <input type="tel" inputmode="numeric" pattern="[0-9]*" class="text-input" id="new-pin-input" placeholder="0000" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.3em; width: 120px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="confirmPin">Confirm PIN</label>
          <input type="tel" inputmode="numeric" pattern="[0-9]*" class="text-input" id="confirm-pin-input" placeholder="0000" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.3em; width: 120px;">
          <p class="admin-pin-error" id="pin-mismatch-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 8px;" data-i18n="pinMismatch">PINs do not match</p>
          <p class="admin-pin-error" id="pin-format-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 8px;" data-i18n="pinFormatError">PIN must be exactly 4 digits</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="save-pin-btn" data-i18n="save">Save</button>
      </div>
    </div>
  </div>

  <!-- Delete Race Confirmation Modal -->
  <div class="modal-overlay glass-enable-target" id="delete-race-confirm-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="confirmDeleteRace">Delete Race</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" id="delete-race-confirm-text">Are you sure you want to delete this race?</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn danger" id="confirm-delete-race-btn" data-i18n="delete">Delete</button>
      </div>
    </div>
  </div>

  <!-- Gate Assignment Modal -->
  <div class="modal-overlay glass-enable-target" id="gate-assignment-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="gateAssignment">Gate Assignment</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" style="margin-bottom: 16px;">Enter the gate range you are responsible for:</p>
        <div class="gate-range-inputs">
          <div class="gate-input-group">
            <label data-i18n="gatesFrom">From</label>
            <input type="number" class="text-input gate-input" id="gate-start-input" min="1" max="99" value="1">
          </div>
          <span class="gate-range-separator">‚Äì</span>
          <div class="gate-input-group">
            <label data-i18n="gatesTo">To</label>
            <input type="number" class="text-input gate-input" id="gate-end-input" min="1" max="99" value="10">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="save-gate-assignment-btn" data-i18n="save">Save</button>
      </div>
    </div>
  </div>

  <!-- Fault Recording Modal -->
  <div class="modal-overlay glass-enable-target" id="fault-modal">
    <div class="modal-content glass-surface-1 fault-modal-content">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="recordFault">Record Fault</h2>
      </div>
      <div class="modal-body">
        <!-- Bib Selection -->
        <div class="fault-bib-section">
          <label data-i18n="selectBib">Select Bib</label>
          <div class="fault-bib-selector" id="fault-bib-selector">
            <!-- Populated dynamically with active bibs -->
          </div>
          <div class="manual-bib-row">
            <span>or enter manually:</span>
            <input type="text" class="text-input" id="fault-bib-input" maxlength="3" inputmode="numeric" pattern="[0-9]*" placeholder="---">
          </div>
        </div>

        <!-- Gate Selection -->
        <div class="fault-gate-section">
          <label data-i18n="selectGate">Gate</label>
          <div class="fault-gate-selector" id="fault-gate-selector">
            <!-- Populated dynamically based on gate assignment -->
          </div>
        </div>

        <!-- Fault Type Selection -->
        <div class="fault-type-section">
          <label data-i18n="faultType">Fault Type</label>
          <div class="fault-type-buttons" id="fault-type-buttons">
            <button class="fault-type-btn" data-fault="MG">
              <span class="fault-type-short" data-i18n="faultMGShort">MG</span>
              <span class="fault-type-label" data-i18n="faultMG">Missed Gate</span>
            </button>
            <button class="fault-type-btn" data-fault="STR">
              <span class="fault-type-short" data-i18n="faultSTRShort">STR</span>
              <span class="fault-type-label" data-i18n="faultSTR">Straddling</span>
            </button>
            <button class="fault-type-btn" data-fault="BR">
              <span class="fault-type-short" data-i18n="faultBRShort">BR</span>
              <span class="fault-type-label" data-i18n="faultBR">Binding Release</span>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn success" id="mark-ok-btn" data-i18n="markOk">Mark OK</button>
      </div>
    </div>
  </div>

  <!-- Fault Confirmation Overlay -->
  <div class="fault-confirmation-overlay" id="fault-confirmation-overlay">
    <div class="fault-confirmation-content">
      <div class="fault-confirmation-icon">‚ö†Ô∏è</div>
      <div class="fault-confirmation-bib">---</div>
      <div class="fault-confirmation-gate">Gate --</div>
      <div class="fault-confirmation-type">--</div>
    </div>
  </div>

  <!-- Onboarding Modal (Full-screen setup wizard) -->
  <div class="modal-overlay onboarding-fullscreen" id="onboarding-modal">
    <div class="onboarding-container">
      <div class="onboarding-progress" id="onboarding-progress">
        <span class="progress-dot active"></span>
        <span class="progress-dot"></span>
        <span class="progress-dot"></span>
        <span class="progress-dot"></span>
        <span class="progress-dot"></span>
      </div>

      <div class="onboarding-cards">
        <!-- Card 1: Welcome + Language -->
        <div class="onboarding-card" data-step="1">
          <div class="onboarding-icon">‚è±Ô∏è</div>
          <h2 data-i18n="onboardingWelcome">Welcome to Ski Race Timer</h2>
          <p data-i18n="onboardingWelcomeDesc">GPS-synchronized timing for ski races</p>
          <div class="onboarding-lang-select">
            <button class="lang-btn" data-lang="de">Deutsch</button>
            <button class="lang-btn" data-lang="en">English</button>
          </div>
          <button class="onboarding-btn primary" data-action="next" data-i18n="getStarted">Get Started</button>
        </div>

        <!-- Card 2: Role Selection (NEW) -->
        <div class="onboarding-card" data-step="2" style="display:none">
          <h2 data-i18n="onboardingRole">What's Your Role?</h2>
          <p data-i18n="onboardingRoleDesc">Choose how you'll be helping at the race</p>
          <div class="onboarding-role-select">
            <button class="role-card selected" data-role="timer" id="onboarding-role-timer">
              <div class="role-card-icon">‚è±Ô∏è</div>
              <div class="role-card-content">
                <span class="role-card-title" data-i18n="roleTimerTitle">Timer</span>
                <span class="role-card-desc" data-i18n="roleTimerDesc">Record start and finish times</span>
              </div>
              <div class="role-card-check">‚úì</div>
            </button>
            <button class="role-card" data-role="gateJudge" id="onboarding-role-judge">
              <div class="role-card-icon">üö©</div>
              <div class="role-card-content">
                <span class="role-card-title" data-i18n="roleJudgeTitle">Gate Judge</span>
                <span class="role-card-desc" data-i18n="roleJudgeDesc">Record gate faults (Torrichter)</span>
              </div>
              <div class="role-card-check">‚úì</div>
            </button>
          </div>
          <button class="onboarding-btn primary" data-action="next" data-i18n="continue">Continue</button>
        </div>

        <!-- Card 3: Device Name -->
        <div class="onboarding-card" data-step="3" style="display:none">
          <h2 data-i18n="onboardingDeviceName" id="onboarding-device-name-title">Name Your Timer</h2>
          <p data-i18n="onboardingDeviceNameDesc" id="onboarding-device-name-desc">This identifies your device when syncing</p>
          <div class="onboarding-input-row">
            <input type="text" class="text-input" id="onboarding-device-name" maxlength="30">
            <button class="onboarding-regenerate-btn" id="onboarding-regenerate-name" type="button" aria-label="Generate new name">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6M1 20v-6h6"/>
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
              </svg>
            </button>
          </div>
          <button class="onboarding-btn primary" data-action="next" data-i18n="continue">Continue</button>
        </div>

        <!-- Card 4a: Photo Capture (Timer path only) -->
        <div class="onboarding-card" data-step="4" data-path="timer" style="display:none">
          <div class="onboarding-icon">üì∑</div>
          <h2 data-i18n="onboardingPhoto">Photo Documentation</h2>
          <p data-i18n="onboardingPhotoDesc">Automatically capture a photo when recording each timestamp. Useful for verifying bib numbers and resolving disputes.</p>
          <label class="onboarding-toggle-row">
            <span data-i18n="enablePhotoCapture">Enable Photo Capture</span>
            <label class="toggle-switch">
              <input type="checkbox" id="onboarding-photo-toggle">
              <span class="toggle-slider"></span>
            </label>
          </label>
          <button class="onboarding-btn primary" data-action="next" data-i18n="continue">Continue</button>
        </div>

        <!-- Card 4b: Gate Assignment (Gate Judge path only) -->
        <div class="onboarding-card" data-step="4" data-path="gateJudge" style="display:none">
          <div class="onboarding-icon">üö©</div>
          <h2 data-i18n="onboardingGates">Your Gate Assignment</h2>
          <p data-i18n="onboardingGatesDesc">Enter the gate numbers you'll be watching. You can change this later.</p>
          <div class="onboarding-gate-inputs">
            <div class="gate-input-group">
              <label data-i18n="gatesFrom">From</label>
              <input type="number" class="text-input gate-input" id="onboarding-gate-start" min="1" max="99" value="1">
            </div>
            <span class="gate-range-separator">‚Äì</span>
            <div class="gate-input-group">
              <label data-i18n="gatesTo">To</label>
              <input type="number" class="text-input gate-input" id="onboarding-gate-end" min="1" max="99" value="10">
            </div>
          </div>
          <button class="onboarding-btn primary" data-action="next" data-i18n="continue">Continue</button>
        </div>

        <!-- Card 5: Race Setup -->
        <div class="onboarding-card" data-step="5" style="display:none">
          <h2 data-i18n="onboardingRaceSetup">Join a Race</h2>
          <p data-i18n="onboardingRaceSetupDesc">Enter a race ID to sync with other timers</p>
          <div class="race-id-input-row">
            <input type="text" class="text-input" id="onboarding-race-id" placeholder="e.g. RACE-2024">
            <button class="recent-races-btn" id="onboarding-recent-races-btn" type="button" aria-label="Recent races">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
            </button>
            <div class="recent-races-dropdown" id="onboarding-recent-races-dropdown" style="display:none"></div>
          </div>
          <div class="race-status" id="onboarding-race-status"></div>
          <input type="password" class="text-input" id="onboarding-pin" placeholder="PIN (4 digits)" maxlength="4" inputmode="numeric" style="display:none">
          <label class="onboarding-toggle-row">
            <span data-i18n="enableSync">Enable Cloud Sync</span>
            <label class="toggle-switch">
              <input type="checkbox" id="onboarding-sync-toggle" checked>
              <span class="toggle-slider"></span>
            </label>
          </label>
          <button class="onboarding-btn primary" data-action="next" data-i18n="continue">Continue</button>
          <button class="onboarding-btn secondary" data-action="skip" data-i18n="skipForNow">Skip for now</button>
        </div>

        <!-- Card 6: Ready -->
        <div class="onboarding-card" data-step="6" style="display:none">
          <div class="onboarding-icon success">‚úì</div>
          <h2 data-i18n="onboardingReady" id="onboarding-ready-title">Ready to Time!</h2>
          <div class="onboarding-summary" id="onboarding-summary"></div>
          <p class="onboarding-tip" data-i18n="onboardingTip" id="onboarding-ready-tip">Tap the big red button to record timestamps</p>
          <button class="onboarding-btn primary" data-action="finish" data-i18n="startTiming" id="onboarding-finish-btn">Start Timing</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="/src/main.ts"></script>
</body>
</html>
