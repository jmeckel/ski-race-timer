<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#0D0D0D">
  <meta name="description" content="GPS-synchronized ski race timing application">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Ski Race Timer">
  <link rel="manifest" href="/manifest.json">
  <!-- Favicons -->
  <link rel="icon" href="/favicon.ico" sizes="48x48">
  <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/icons/favicon-96x96.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Ski Race Timer">
  <meta property="og:description" content="GPS-synchronized ski race timing application">
  <meta property="og:image" content="/og-image.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Ski Race Timer">
  <meta name="twitter:description" content="GPS-synchronized ski race timing application">
  <meta name="twitter:image" content="/twitter-image.png">
  <title>Ski Race Timer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
  <!-- Skip Link -->
  <a href="#main" class="skip-link">Skip to main content</a>

  <div class="app" role="application" aria-label="Ski Race Timer">
    <!-- Header -->
    <header class="header glass-frosted-top glass-enable-target">
      <h1 class="header-title">Ski Race Timer</h1>
      <div class="header-status">
        <div class="sync-indicator" id="sync-indicator" style="display: none;">
          <span class="sync-dot"></span>
          <span class="sync-status-text" data-i18n="connecting">Connecting...</span>
          <span class="sync-device-count" id="sync-device-count" style="display: none;"></span>
          <span class="judges-ready-indicator" id="judges-ready-indicator" style="display: none;" title="Judges ready">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
            <span class="judges-ready-count" id="judges-ready-count">0/0</span>
          </span>
        </div>
        <div class="gps-indicator" id="gps-indicator" style="display: none;">
          <span class="gps-dot"></span>
          <span class="gps-status-text" data-i18n="gps">GPS</span>
        </div>
        <div class="judge-ready-indicator" id="judge-ready-indicator" style="display: none;">
          <span class="judge-ready-dot"></span>
          <span class="judge-ready-text">Ready</span>
        </div>
        <div class="camera-indicator" id="camera-indicator" style="display: none;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
            <circle cx="12" cy="13" r="4"/>
          </svg>
        </div>
        <div class="voice-indicator" id="voice-indicator" style="display: none;">
          <span class="voice-dot"></span>
          <span class="voice-status-text" id="voice-status-text"></span>
        </div>
        <span class="entry-count-badge" id="entry-count-badge" style="display: none;">0</span>
      </div>
    </header>

    <!-- Main Content -->
    <main id="main">
        <!-- Timer View (Radial Dial Mode) -->
        <div class="view timer-view radial-mode active">
          <!-- Top Row: Bib + Status -->
          <div class="radial-top-row">
            <!-- Top Left: Bib -->
            <div class="radial-bib-corner">
              <div class="radial-bib-label" data-i18n="bib">Bib</div>
              <div class="radial-bib-value" id="radial-bib-value">---<span class="radial-bib-cursor"></span></div>
              <button class="radial-clear-btn" id="radial-clear-btn" data-i18n="clear">Clear</button>
            </div>

            <!-- Top Right: Status -->
            <div class="radial-status-corner">
              <div class="radial-status-row" id="radial-gps-status">
                <span class="radial-status-dot inactive"></span>
                <span>GPS</span>
              </div>
              <div class="radial-status-row" id="radial-sync-status" style="display: none;">
                <span class="radial-status-dot"></span>
                <span class="radial-sync-text">Synced</span>
              </div>
            </div>
          </div>

          <!-- Center: Dial -->
          <div class="radial-center-area">
            <div class="dial-container" id="dial-container">
              <!-- Dial Ring -->
              <div class="dial-ring" id="dial-ring">
                <div class="dial-ticks" id="dial-ticks"></div>
              </div>

              <!-- Rotating numbers -->
              <div class="dial-numbers" id="dial-numbers"></div>

              <!-- Gesture area -->
              <div class="dial-gesture-area" id="dial-gesture"></div>

              <!-- Center with time -->
              <div class="dial-center">
                <div class="radial-time-display" id="radial-time-display">
                  <div class="radial-time-hm" id="radial-time-hm">--:--</div>
                  <div class="radial-time-seconds" id="radial-time-seconds">--</div>
                  <div class="radial-time-subseconds" id="radial-time-subseconds">.---</div>
                </div>
                <!-- Timing Point Toggle in center -->
                <div class="radial-timing-point" id="radial-timing-point">
                  <button class="radial-point-btn start" data-point="S" data-advanced>S</button>
                  <button class="radial-point-btn finish active" data-point="F">F</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Bottom Row: Stats + Time Button -->
          <div class="radial-bottom-row">
            <!-- Bottom Left: Stats -->
            <div class="radial-stats-corner">
              <div class="radial-stats-label" data-i18n="lastRecordedShort">Last</div>
              <div class="radial-stats-last">
                <span class="radial-stats-bib" id="radial-last-bib">---</span>
                <span class="radial-stats-point finish" id="radial-last-point">F</span>
              </div>
              <div class="radial-stats-time" id="radial-last-time">--:--:--.---</div>
              <div class="radial-stats-count" id="radial-stats-count">0 entries</div>
            </div>

            <!-- Bottom Right: Time Button -->
            <div class="radial-time-btn-corner">
              <button class="radial-time-btn" id="radial-time-btn" aria-label="Record timestamp">
                <span class="radial-time-btn-icon">‚óè</span>
                <span data-i18n="time">TIME</span>
              </button>
            </div>
          </div>

          <!-- Confirmation Overlay -->
          <div class="radial-confirmation-overlay" id="radial-confirmation-overlay">
            <div class="radial-confirmation-check">‚úì</div>
            <div class="radial-confirmation-bib" id="radial-confirm-bib">---</div>
            <div class="radial-confirmation-time" id="radial-confirm-time">--:--:--.---</div>
            <div class="radial-confirmation-point finish" id="radial-confirm-point">Finish</div>
          </div>
        </div>

      <!-- Results View -->
      <div class="view results-view">
        <div class="results-header">
          <!-- Chief Judge Toggle -->
          <div class="chief-judge-toggle-row" id="chief-judge-toggle-row">
            <button class="chief-judge-toggle-btn" id="chief-judge-toggle-btn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                <path d="M2 17l10 5 10-5"/>
                <path d="M2 12l10 5 10-5"/>
              </svg>
              <span data-i18n="chiefJudge">Chief Judge</span>
            </button>
          </div>
          <!-- Search & Filter -->
          <div class="search-filter-bar" data-advanced>
            <input type="search" class="search-input" id="search-input" data-i18n-placeholder="search">
            <select class="filter-select" id="filter-point" aria-label="Filter by point">
              <option value="all" data-i18n="all">All</option>
              <option value="S">Start</option>
              <option value="F">Finish</option>
            </select>
            <select class="filter-select" id="filter-status" aria-label="Filter by status">
              <option value="all" data-i18n="all">All</option>
              <option value="ok">OK</option>
              <option value="dns">DNS</option>
              <option value="dnf">DNF</option>
              <option value="dsq">DSQ</option>
            </select>
          </div>

          <!-- Stats -->
          <div class="stats-row">
            <div class="stat-item">
              <div class="stat-value" id="stat-total">0</div>
              <div class="stat-label" data-i18n="total">Total</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-racers">0</div>
              <div class="stat-label" data-i18n="racers">Racers</div>
            </div>
            <div class="stat-item" data-advanced>
              <div class="stat-value" id="stat-finished">0</div>
              <div class="stat-label" data-i18n="finished">Finished</div>
            </div>
          </div>
        </div>

        <!-- Results List (Virtual Scrolling) -->
        <div class="results-list" id="results-list" role="list" aria-label="Results"></div>

        <!-- Chief Judge Panel (shown when chief mode is active) -->
        <div class="chief-judge-panel" id="chief-judge-panel">
          <!-- Gate Judges Overview -->
          <div class="judges-overview" id="judges-overview">
            <div class="judges-overview-header">
              <span class="judges-overview-title" data-i18n="gateJudges">Gate Judges</span>
              <span class="judges-overview-count" id="judges-overview-count">0</span>
            </div>
            <div class="judges-overview-list" id="judges-overview-list">
              <!-- Populated dynamically -->
              <div class="judges-overview-empty" id="judges-overview-empty" data-i18n="noJudgesConnected">
                No gate judges connected
              </div>
            </div>
          </div>

          <!-- Penalty Configuration -->
          <div class="penalty-config-row" id="penalty-config-row">
            <div class="penalty-mode-toggle" id="penalty-mode-toggle">
              <button class="penalty-mode-btn active" data-mode="penalty">
                <span data-i18n="penaltyMode">+Time</span>
              </button>
              <button class="penalty-mode-btn" data-mode="dsq">
                <span>DSQ</span>
              </button>
            </div>
            <div class="penalty-seconds-selector" id="penalty-seconds-selector">
              <button class="penalty-adj-btn" data-adj="-1">‚àí</button>
              <span class="penalty-seconds-value" id="penalty-seconds-value">5</span>
              <span class="penalty-seconds-unit">s</span>
              <button class="penalty-adj-btn" data-adj="+1">+</button>
            </div>
          </div>
          <!-- Pending Deletions Section (Chief Judge approval needed) -->
          <div class="pending-deletions-section" id="pending-deletions-section" style="display: none;">
            <div class="pending-deletions-header">
              <span class="pending-deletions-title">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 9v4M12 17h.01"/>
                  <circle cx="12" cy="12" r="10"/>
                </svg>
                <span data-i18n="pendingDeletions">Pending Deletions</span>
              </span>
              <span class="pending-deletions-count" id="pending-deletions-count">0</span>
            </div>
            <div class="pending-deletions-list" id="pending-deletions-list">
              <!-- Populated dynamically -->
            </div>
          </div>

          <div class="fault-summary-header">
            <span class="fault-summary-title" data-i18n="faultSummary">Fault Summary</span>
            <span class="fault-summary-count" id="fault-summary-count">0</span>
          </div>
          <div class="fault-summary-list" id="fault-summary-list">
            <!-- Fault cards will be populated dynamically -->
            <div class="chief-empty-state empty-state" id="chief-empty-state">
              <span class="empty-icon">üèîÔ∏è</span>
              <span data-i18n="noFaultsRecorded">No faults recorded</span>
              <span class="empty-subtitle" data-i18n="cleanRunHint">Clean run so far</span>
            </div>
          </div>

          <!-- Chief Judge Export Actions -->
          <div class="chief-export-actions" id="chief-export-actions">
            <button class="chief-export-btn" id="export-csv-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
              </svg>
              <span data-i18n="exportCSV">CSV</span>
            </button>
            <button class="chief-export-btn" id="export-summary-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="12" y1="18" x2="12" y2="12"/>
                <line x1="9" y1="15" x2="15" y2="15"/>
              </svg>
              <span data-i18n="summary">Summary</span>
            </button>
            <button class="chief-export-btn whatsapp" id="export-whatsapp-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
              </svg>
              <span data-i18n="exportWhatsApp">WhatsApp</span>
            </button>
          </div>
        </div>

        <!-- Select Mode Bar -->
        <div class="select-mode-bar" id="select-mode-bar">
          <span><span id="selected-count">0</span> <span data-i18n="selected">selected</span></span>
          <button class="modal-btn danger" id="delete-selected-btn" data-i18n="deleteSelected">Delete Selected</button>
        </div>

        <!-- Results Actions -->
        <div class="results-actions">
          <button class="action-btn" id="undo-btn" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 10h10a5 5 0 015 5v2M3 10l4-4M3 10l4 4"/>
            </svg>
            <span data-i18n="undo">Undo</span>
          </button>
          <button class="action-btn" id="export-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            <span data-i18n="export">Export</span>
          </button>
          <button class="action-btn danger" id="clear-all-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
            </svg>
            <span data-i18n="clearAll">Clear All</span>
          </button>
        </div>
      </div>

      <!-- Gate Judge View -->
      <div class="view gate-judge-view">
        <!-- Gate Assignment Header -->
        <div class="gate-judge-header">
          <div class="gate-assignment-display">
            <span class="gate-label" data-i18n="gates">Gates</span>
            <span class="gate-range" id="gate-range-display">--</span>
            <button class="gate-change-btn" id="gate-change-btn" data-i18n="changeGates">Change</button>
          </div>
          <div class="run-selector gate-judge-run-selector" id="gate-judge-run-selector" role="radiogroup" aria-label="Run">
            <button class="run-btn glass-surface-3 active" data-run="1" role="radio" aria-checked="true">
              <span data-i18n="run1">L1</span>
            </button>
            <button class="run-btn glass-surface-3" data-run="2" role="radio" aria-checked="false">
              <span data-i18n="run2">L2</span>
            </button>
          </div>
        </div>

        <!-- Other Judges Coverage (shows when syncing) -->
        <div class="other-judges-coverage" id="other-judges-coverage" style="display: none;">
          <span class="coverage-label" data-i18n="otherJudges">Other judges:</span>
          <div class="coverage-list" id="other-judges-list"></div>
        </div>

        <!-- Split Layout: Fault List + Inline Entry -->
        <div class="gate-judge-split">
          <!-- Recorded Faults List -->
          <div class="gate-judge-faults-section">
            <div class="section-header">
              <span class="section-title" data-i18n="recordedFaults">Recorded Faults</span>
              <span class="fault-count-badge" id="inline-fault-count">0</span>
            </div>
            <div class="gate-judge-faults-list" id="gate-judge-faults-list">
              <div class="empty-state" id="no-faults-recorded-inline">
                <span class="empty-icon">üö©</span>
                <span data-i18n="noFaultsRecorded">No faults recorded</span>
                <span class="empty-subtitle" data-i18n="cleanRunHint">Clean run so far</span>
              </div>
            </div>
          </div>

          <!-- Inline Fault Entry Interface -->
          <div class="gate-judge-entry-section">
            <!-- Bib Selection -->
            <div class="inline-entry-row">
              <label class="inline-entry-label" data-i18n="selectBib">Select Bib</label>
              <div class="inline-bib-selector" id="inline-bib-selector">
                <!-- Populated dynamically -->
              </div>
              <div class="inline-bib-manual-row">
                <span class="inline-bib-manual-label" data-i18n="orEnterManually">or enter:</span>
                <input type="text" class="text-input inline-bib-input" id="inline-bib-input" maxlength="3" inputmode="numeric" pattern="[0-9]*" placeholder="---">
              </div>
            </div>

            <!-- Gate Selection -->
            <div class="inline-entry-row">
              <label class="inline-entry-label" data-i18n="selectGate">Gate</label>
              <div class="inline-gate-selector" id="inline-gate-selector">
                <!-- Populated dynamically based on gate assignment -->
              </div>
            </div>

            <!-- Fault Type Selection -->
            <div class="inline-entry-row">
              <label class="inline-entry-label" data-i18n="faultType">Fault Type</label>
              <div class="inline-fault-types" id="inline-fault-types">
                <button class="inline-fault-type-btn" data-fault="MG">
                  <span class="fault-type-short" data-i18n="faultMGShort">MG</span>
                  <span class="fault-type-long" data-i18n="faultMG">Missed Gate</span>
                </button>
                <button class="inline-fault-type-btn" data-fault="STR">
                  <span class="fault-type-short" data-i18n="faultSTRShort">STR</span>
                  <span class="fault-type-long" data-i18n="faultSTR">Straddling</span>
                </button>
                <button class="inline-fault-type-btn" data-fault="BR">
                  <span class="fault-type-short" data-i18n="faultBRShort">BR</span>
                  <span class="fault-type-long" data-i18n="faultBR">Binding Release</span>
                </button>
              </div>
            </div>

          </div>
        </div>

        <!-- Action Buttons Row (Save Fault + Ready) -->
        <div class="gate-judge-footer">
          <button class="inline-save-fault-btn" id="inline-save-fault-btn" data-i18n="saveFault">Save Fault</button>
          <button class="ready-toggle-btn" id="ready-toggle-btn">
            <svg class="ready-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 6L9 17l-5-5"/>
            </svg>
            <span data-i18n="signalReady">Ready</span>
          </button>
        </div>
      </div>

      <!-- Settings View -->
      <div class="view settings-view">
        <!-- Device Role (Prominent at top) -->
        <div class="settings-section role-section">
          <div class="settings-section-title" data-i18n="deviceRole">Device Role</div>
          <div class="role-cards-settings" id="role-toggle">
            <button class="role-card-setting active" data-role="timer">
              <div class="role-card-icon">‚è±Ô∏è</div>
              <div class="role-card-content">
                <span class="role-card-title" data-i18n="roleTimer">Timer</span>
                <span class="role-card-desc" data-i18n="roleTimerDesc">Record start and finish times</span>
              </div>
            </button>
            <button class="role-card-setting" data-role="gateJudge">
              <div class="role-card-icon">üö©</div>
              <div class="role-card-content">
                <span class="role-card-title" data-i18n="roleGateJudge">Gate Judge</span>
                <span class="role-card-desc" data-i18n="roleJudgeDesc">Record gate faults (Torrichter)</span>
              </div>
            </button>
          </div>
        </div>

        <!-- Mode Toggle (hidden - normal mode is now the default) -->
        <div class="settings-section" style="display:none">
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="simpleMode">Simple Mode</span>
              <span class="setting-description" data-i18n="simpleModeDesc">Simplified interface for basic timing</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="simple-mode-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Cloud Sync -->
        <div class="settings-section">
          <div class="settings-section-title" data-i18n="cloudSync">Cloud Sync</div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="cloudSync">Cloud Sync</span>
              <span class="setting-description" data-i18n="cloudSyncDesc">Sync with other devices</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="sync-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="setting-row" id="race-id-input-row-container">
            <div class="setting-label">
              <span class="setting-title" data-i18n="raceId">Race ID</span>
              <span class="race-exists-indicator" id="race-exists-indicator" style="display: none;">
                <svg class="race-exists-check" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12"/>
                </svg>
                <span class="race-exists-text" id="race-exists-text"></span>
              </span>
            </div>
            <div class="race-id-input-row">
              <input type="text" class="text-input" id="race-id-input" data-i18n-placeholder="raceIdPlaceholder" style="max-width: 120px;">
              <button class="recent-races-btn" id="settings-recent-races-btn" type="button" aria-label="Recent races">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"/>
                  <polyline points="12 6 12 12 16 14"/>
                </svg>
              </button>
              <div class="recent-races-dropdown" id="settings-recent-races-dropdown" style="display:none"></div>
            </div>
          </div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="deviceName">Device Name</span>
            </div>
            <input type="text" class="text-input" id="device-name-input" data-i18n-placeholder="deviceNamePlaceholder" style="max-width: 150px;">
          </div>
          <div class="setting-row" id="sync-photos-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="syncPhotos">Sync Photos</span>
              <span class="setting-description" data-i18n="syncPhotosDesc">Share photos across devices via cloud</span>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="sync-photos-toggle" disabled>
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>

        <!-- Advanced Settings (Collapsible) -->
        <div class="settings-section collapsible expanded" id="advanced-settings-section">
          <div class="settings-section-title" id="advanced-settings-toggle" data-i18n="advancedSettings">Advanced Settings</div>
          <div class="settings-section-content">
            <!-- GPS -->
            <div class="setting-row">
              <div class="setting-label">
                <span class="setting-title" data-i18n="gps">GPS Sync</span>
                <span class="setting-description" data-i18n="gpsDesc">Use GPS for accurate timestamps</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="gps-toggle">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <!-- Auto-increment -->
            <div class="setting-row">
              <div class="setting-label">
                <span class="setting-title" data-i18n="autoIncrement">Auto-increment Bib</span>
                <span class="setting-description" data-i18n="autoIncrementDesc">Increase bib number after recording</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="auto-toggle" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <!-- Haptic Feedback -->
            <div class="setting-row">
              <div class="setting-label">
                <span class="setting-title" data-i18n="hapticFeedback">Haptic Feedback</span>
                <span class="setting-description" data-i18n="hapticFeedbackDesc">Vibration on actions</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="haptic-toggle" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <!-- Sound Feedback -->
            <div class="setting-row">
              <div class="setting-label">
                <span class="setting-title" data-i18n="soundFeedback">Sound Feedback</span>
                <span class="setting-description" data-i18n="soundFeedbackDesc">Audio confirmation</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="sound-toggle">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <!-- Ambient Mode -->
            <div class="setting-row">
              <div class="setting-label">
                <span class="setting-title" data-i18n="ambientMode">Ambient Mode</span>
                <span class="setting-description" data-i18n="ambientModeDesc">Auto-dim after 30s inactivity</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="ambient-mode-toggle" checked>
                <span class="toggle-slider"></span>
              </label>
            </div>
            <!-- Voice Mode -->
            <div class="setting-row" id="voice-mode-row">
              <div class="setting-label">
                <span class="setting-title" data-i18n="voiceMode">Voice Mode</span>
                <span class="setting-description" data-i18n="voiceModeDesc">Hands-free voice commands (requires internet)</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="voice-mode-toggle">
                <span class="toggle-slider"></span>
              </label>
            </div>
            <!-- Photo Capture -->
            <div class="setting-row">
              <div class="setting-label">
                <span class="setting-title" data-i18n="photoCapture">Photo Capture</span>
                <span class="setting-description" data-i18n="photoCaptureDesc">Capture photo on timestamp</span>
              </div>
              <label class="toggle-switch">
                <input type="checkbox" id="photo-toggle">
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
        </div>

        <!-- Language -->
        <div class="settings-section">
          <div class="settings-section-title" data-i18n="language">Language</div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="language">Language</span>
            </div>
            <div class="lang-toggle" id="lang-toggle">
              <span class="lang-option active" data-lang="de">DE</span>
              <span class="lang-option" data-lang="en">EN</span>
            </div>
          </div>
        </div>

        <!-- Tutorial -->
        <div class="settings-section">
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="showTutorial">Show Tutorial</span>
              <span class="setting-description" data-i18n="showTutorialDesc">Run the setup wizard again</span>
            </div>
            <button class="action-btn admin-action-btn" id="show-tutorial-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4M12 8h.01"/>
              </svg>
              <span data-i18n="show">Show</span>
            </button>
          </div>
        </div>

        <!-- Admin Section (hidden in simple mode) -->
        <div class="settings-section" id="admin-section">
          <div class="settings-section-title" data-i18n="admin">Admin</div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="adminPin">Admin PIN</span>
              <span class="setting-description" id="admin-pin-status" data-i18n="pinNotSet">Not set</span>
            </div>
            <button class="action-btn admin-action-btn" id="change-pin-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0110 0v4"/>
              </svg>
              <span id="change-pin-btn-text" data-i18n="setPin">Set PIN</span>
            </button>
          </div>
          <div class="setting-row">
            <div class="setting-label">
              <span class="setting-title" data-i18n="manageRaces">Manage Races</span>
              <span class="setting-description" data-i18n="manageRacesDesc">View and delete synced races</span>
            </div>
            <button class="action-btn admin-action-btn" id="manage-races-btn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 20h9"/>
                <path d="M16.5 3.5a2.121 2.121 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
              </svg>
              <span data-i18n="manage">Manage</span>
            </button>
          </div>
        </div>

        <!-- Version -->
        <div class="settings-section">
          <button class="version-info-btn" id="version-info-btn" title="Tap to copy debug info">
            <span data-i18n="version">Version</span>&nbsp;<span id="app-version"></span>
          </button>
        </div>
      </div>
    </main>

    <!-- Tab Bar -->
    <nav class="tab-bar glass-frosted glass-enable-target" role="tablist" aria-label="Main navigation">
      <button class="tab-btn active" data-view="timer" role="tab" aria-selected="true" id="timer-tab">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span data-i18n="timer">Timer</span>
      </button>
      <button class="tab-btn" data-view="results" role="tab" aria-selected="false">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <line x1="8" y1="6" x2="21" y2="6"/>
          <line x1="8" y1="12" x2="21" y2="12"/>
          <line x1="8" y1="18" x2="21" y2="18"/>
          <line x1="3" y1="6" x2="3.01" y2="6"/>
          <line x1="3" y1="12" x2="3.01" y2="12"/>
          <line x1="3" y1="18" x2="3.01" y2="18"/>
        </svg>
        <span data-i18n="results">Results</span>
      </button>
      <button class="tab-btn" data-view="gateJudge" role="tab" aria-selected="false" id="gate-judge-tab" style="display: none;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
          <line x1="4" y1="22" x2="4" y2="15"/>
        </svg>
        <span data-i18n="gateJudgeTab">Gate</span>
      </button>
      <button class="tab-btn" data-view="settings" role="tab" aria-selected="false">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
        </svg>
        <span data-i18n="settings">Settings</span>
      </button>
    </nav>
  </div>

  <!-- Confirmation Overlay (outside app, same level as modals) -->
  <div class="confirmation-overlay" id="confirmation-overlay">
    <div class="confirmation-content">
      <div class="snowflake-burst" id="snowflake-burst"></div>
      <div class="confirmation-bib">---</div>
      <div class="confirmation-point">-</div>
      <div class="confirmation-run" data-advanced>-</div>
      <div class="confirmation-time">--:--:--.---</div>
      <div class="confirmation-duplicate" style="display: none;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 9v4M12 17h.01"/>
          <circle cx="12" cy="12" r="10"/>
        </svg>
        <span data-i18n="duplicateWarning">Duplicate entry</span>
      </div>
      <div class="confirmation-zero-bib" style="display: none;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 9v4M12 17h.01"/>
          <circle cx="12" cy="12" r="10"/>
        </svg>
        <span data-i18n="zeroBibWarning">Bib 000 - verify entry</span>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay glass-enable-target" id="edit-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="edit">Edit Entry</h2>
      </div>
      <div class="modal-body">
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="bib">Bib</label>
          <input type="text" class="text-input" id="edit-bib-input" maxlength="3" inputmode="numeric" pattern="[0-9]*">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="status">Status</label>
          <select class="filter-select" id="edit-status-select" style="width: 100%;">
            <option value="ok">OK</option>
            <option value="dns">DNS</option>
            <option value="dnf">DNF</option>
            <option value="dsq">DSQ</option>
          </select>
        </div>
        <div style="margin-top: 16px;" data-advanced>
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="run">Run</label>
          <div class="edit-run-selector" id="edit-run-selector">
            <button class="edit-run-btn active" data-run="1" type="button">1</button>
            <button class="edit-run-btn" data-run="2" type="button">2</button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="save-edit-btn" data-i18n="save">Save</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div class="modal-overlay glass-enable-target" id="confirm-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="confirmDelete">Delete Entry</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" data-i18n="confirmDeleteText">Are you sure you want to delete this entry?</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn danger" id="confirm-delete-btn" data-i18n="delete">Delete</button>
      </div>
    </div>
  </div>

  <!-- Fault Delete Confirmation Modal -->
  <div class="modal-overlay glass-enable-target" id="fault-delete-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="confirmDelete">Delete Fault</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" data-i18n="confirmDeleteFault">Delete this fault?</p>
        <p class="delete-fault-info"></p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn danger" id="confirm-fault-delete-btn" data-i18n="delete">Delete</button>
      </div>
    </div>
  </div>

  <!-- Race Change Modal -->
  <div class="modal-overlay glass-enable-target" id="race-change-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="raceChangeTitle">Change Race</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" id="race-change-text" data-i18n="raceChangeUnsyncedText">You have existing results. Keep them or delete before switching?</p>
      </div>
      <div class="modal-footer" style="flex-wrap: wrap; gap: 8px;">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="race-change-keep-btn" data-i18n="keepResults">Keep</button>
        <button class="modal-btn primary" id="race-change-export-btn" data-i18n="export">Export</button>
        <button class="modal-btn danger" id="race-change-delete-btn" data-i18n="delete">Delete</button>
      </div>
    </div>
  </div>

  <!-- Photo Viewer Modal -->
  <div class="modal-overlay glass-enable-target" id="photo-viewer-modal">
    <div class="modal-content glass-surface-1 photo-viewer-content">
      <div class="modal-header photo-viewer-header">
        <h2 class="modal-title" data-i18n="viewPhoto">View Photo</h2>
        <button class="photo-viewer-close" id="photo-viewer-close-btn" aria-label="Close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="photo-viewer-image-container">
        <img id="photo-viewer-image" class="photo-viewer-image" src="" alt="">
      </div>
      <div class="photo-viewer-metadata">
        <span class="photo-viewer-bib" id="photo-viewer-bib">---</span>
        <span class="photo-viewer-point" id="photo-viewer-point">S</span>
        <span class="photo-viewer-time" id="photo-viewer-time">00:00:00.000</span>
      </div>
      <div class="modal-footer">
        <button class="modal-btn text-danger" id="photo-viewer-delete-btn" data-i18n="deletePhoto">Delete Photo</button>
        <button class="modal-btn primary" id="photo-viewer-close-footer-btn" data-i18n="close">Close</button>
      </div>
    </div>
  </div>

  <!-- Race Deleted Modal -->
  <div class="modal-overlay glass-enable-target" id="race-deleted-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="raceDeleted">Race Deleted</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" id="race-deleted-text" data-i18n="raceDeletedText">This race has been deleted by an administrator.</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn primary" id="race-deleted-ok-btn" data-i18n="ok">OK</button>
      </div>
    </div>
  </div>

  <!-- Photo Sync Warning Modal -->
  <div class="modal-overlay glass-enable-target" id="photo-sync-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="syncPhotosWarning">Enable Photo Sync</h2>
      </div>
      <div class="modal-body">
        <p data-i18n="syncPhotosWarningText">Enabling photo sync will transfer the following data:</p>
        <div class="photo-sync-stats" id="photo-sync-stats">
          <div class="photo-sync-stat">
            <span class="photo-sync-label" data-i18n="photosToUpload">Photos to upload</span>
            <span class="photo-sync-value" id="photos-upload-count">0</span>
          </div>
          <div class="photo-sync-stat">
            <span class="photo-sync-label" data-i18n="photosToDownload">Photos to download</span>
            <span class="photo-sync-value" id="photos-download-count">0</span>
          </div>
          <div class="photo-sync-stat total">
            <span class="photo-sync-label" data-i18n="totalDataVolume">Total data volume</span>
            <span class="photo-sync-value" id="photos-total-size">0 KB</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" id="photo-sync-cancel-btn" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="photo-sync-confirm-btn" data-i18n="enableSync">Enable Sync</button>
      </div>
    </div>
  </div>

  <!-- Race Management Modal -->
  <div class="modal-overlay glass-enable-target" id="race-management-modal">
    <div class="modal-content glass-surface-1 race-management-content">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="manageRaces">Manage Races</h2>
      </div>
      <div class="modal-body">
        <div class="race-list" id="race-list" role="region" aria-live="polite">
          <div class="race-list-loading snowflake-loading" id="race-list-loading" aria-busy="true">
            <div class="snowflake-spinner">
              <span class="flake">‚ùÑ</span>
              <span class="flake">‚ùÑ</span>
              <span class="flake">‚ùÑ</span>
            </div>
            <span class="loading-text" data-i18n="loading">Loading...</span>
          </div>
          <div class="race-list-empty empty-state" id="race-list-empty" style="display: none;">
            <span class="empty-icon">‚õ∑Ô∏è</span>
            <span data-i18n="noRaces">No active races</span>
            <span class="empty-subtitle" data-i18n="noRacesHint">Create one in Settings</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="close">Close</button>
        <button class="modal-btn secondary" id="refresh-races-btn" data-i18n="refresh">Refresh</button>
      </div>
    </div>
  </div>

  <!-- Admin PIN Modal (for verifying PIN to access race management) -->
  <div class="modal-overlay glass-enable-target" id="admin-pin-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" id="admin-pin-modal-title" data-i18n="enterAdminPin">Enter Admin PIN</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" id="admin-pin-modal-text" data-i18n="enterPinText">Enter the admin PIN to access race management.</p>
        <input type="tel" inputmode="numeric" pattern="[0-9]*" class="text-input" id="admin-pin-verify-input" placeholder="0000" maxlength="4" style="margin-top: 12px; text-align: center; font-size: 1.5rem; letter-spacing: 0.3em; width: 120px;">
        <p class="admin-pin-error" id="admin-pin-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 8px;" data-i18n="incorrectPin">Incorrect PIN</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="admin-pin-verify-btn" data-i18n="verify">Verify</button>
      </div>
    </div>
  </div>

  <!-- Set/Change PIN Modal -->
  <div class="modal-overlay glass-enable-target" id="change-pin-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" id="change-pin-modal-title" data-i18n="setPin">Set PIN</h2>
      </div>
      <div class="modal-body">
        <div id="current-pin-row" style="display: none; margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="currentPin">Current PIN</label>
          <input type="tel" inputmode="numeric" pattern="[0-9]*" class="text-input" id="current-pin-input" placeholder="0000" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.3em; width: 120px;">
          <p class="admin-pin-error" id="current-pin-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 8px;" data-i18n="incorrectPin">Incorrect PIN</p>
        </div>
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="newPin">New PIN (4 digits)</label>
          <input type="tel" inputmode="numeric" pattern="[0-9]*" class="text-input" id="new-pin-input" placeholder="0000" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.3em; width: 120px;">
        </div>
        <div>
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="confirmPin">Confirm PIN</label>
          <input type="tel" inputmode="numeric" pattern="[0-9]*" class="text-input" id="confirm-pin-input" placeholder="0000" maxlength="4" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.3em; width: 120px;">
          <p class="admin-pin-error" id="pin-mismatch-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 8px;" data-i18n="pinMismatch">PINs do not match</p>
          <p class="admin-pin-error" id="pin-format-error" style="display: none; color: var(--error); font-size: 0.875rem; margin-top: 8px;" data-i18n="pinFormatError">PIN must be exactly 4 digits</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="save-pin-btn" data-i18n="save">Save</button>
      </div>
    </div>
  </div>

  <!-- Delete Race Confirmation Modal -->
  <div class="modal-overlay glass-enable-target" id="delete-race-confirm-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="confirmDeleteRace">Delete Race</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" id="delete-race-confirm-text">Are you sure you want to delete this race?</p>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn danger" id="confirm-delete-race-btn" data-i18n="delete">Delete</button>
      </div>
    </div>
  </div>

  <!-- Gate Assignment Modal -->
  <div class="modal-overlay glass-enable-target" id="gate-assignment-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="gateAssignment">Gate Assignment</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" style="margin-bottom: 16px;">Enter the gate range you are responsible for:</p>
        <div class="gate-range-inputs">
          <div class="gate-input-group">
            <label data-i18n="gatesFrom">From</label>
            <input type="number" class="text-input gate-input" id="gate-start-input" min="1" max="99" value="1">
          </div>
          <span class="gate-range-separator">‚Äì</span>
          <div class="gate-input-group">
            <label data-i18n="gatesTo">To</label>
            <input type="number" class="text-input gate-input" id="gate-end-input" min="1" max="99" value="10">
          </div>
        </div>
        <!-- First Gate Color Selection -->
        <div class="first-gate-color-section" style="margin-top: 20px;">
          <label data-i18n="firstGateColor" style="display: block; margin-bottom: 8px; font-size: 0.9rem;">Color of first gate</label>
          <div class="gate-color-selector" id="gate-color-selector">
            <button type="button" class="gate-color-btn red active" data-color="red">
              <span class="gate-color-dot" style="background: #ef4444;"></span>
              <span data-i18n="colorRed">Red</span>
            </button>
            <button type="button" class="gate-color-btn blue" data-color="blue">
              <span class="gate-color-dot" style="background: #3b82f6;"></span>
              <span data-i18n="colorBlue">Blue</span>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="save-gate-assignment-btn" data-i18n="save">Save</button>
      </div>
    </div>
  </div>

  <!-- Fault Recording Modal -->
  <div class="modal-overlay glass-enable-target" id="fault-modal">
    <div class="modal-content glass-surface-1 fault-modal-content">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="recordFault">Record Fault</h2>
      </div>
      <div class="modal-body">
        <!-- Bib Selection -->
        <div class="fault-bib-section">
          <label data-i18n="selectBib">Select Bib</label>
          <div class="fault-bib-selector" id="fault-bib-selector">
            <!-- Populated dynamically with active bibs -->
          </div>
          <div class="manual-bib-row">
            <span>or enter manually:</span>
            <input type="text" class="text-input" id="fault-bib-input" maxlength="3" inputmode="numeric" pattern="[0-9]*" placeholder="---">
          </div>
        </div>

        <!-- Gate Selection -->
        <div class="fault-gate-section">
          <label data-i18n="selectGate">Gate</label>
          <div class="fault-gate-selector" id="fault-gate-selector">
            <!-- Populated dynamically based on gate assignment -->
          </div>
        </div>

        <!-- Fault Type Selection -->
        <div class="fault-type-section">
          <label data-i18n="faultType">Fault Type</label>
          <div class="fault-type-buttons" id="fault-type-buttons">
            <button class="fault-type-btn" data-fault="MG">
              <span class="fault-type-short" data-i18n="faultMGShort">MG</span>
              <span class="fault-type-label" data-i18n="faultMG">Missed Gate</span>
            </button>
            <button class="fault-type-btn" data-fault="STR">
              <span class="fault-type-short" data-i18n="faultSTRShort">STR</span>
              <span class="fault-type-label" data-i18n="faultSTR">Straddling</span>
            </button>
            <button class="fault-type-btn" data-fault="BR">
              <span class="fault-type-short" data-i18n="faultBRShort">BR</span>
              <span class="fault-type-label" data-i18n="faultBR">Binding Release</span>
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="save-fault-btn" data-i18n="saveFault">Save Fault</button>
      </div>
    </div>
  </div>

  <!-- Fault Edit Modal -->
  <div class="modal-overlay glass-enable-target" id="fault-edit-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="editFault">Edit Fault</h2>
      </div>
      <div class="modal-body">
        <!-- Bib Input -->
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="bib">Bib</label>
          <input type="text" class="text-input" id="fault-edit-bib-input" maxlength="3" inputmode="numeric" pattern="[0-9]*">
        </div>
        <!-- Gate Input -->
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="gate">Gate</label>
          <input type="number" class="text-input" id="fault-edit-gate-input" min="1" max="99" style="width: 80px;">
          <span class="fault-edit-gate-range" id="fault-edit-gate-range" style="font-size: 0.75rem; color: var(--text-tertiary); margin-left: 8px;"></span>
        </div>
        <!-- Fault Type -->
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="faultType">Fault Type</label>
          <select class="filter-select" id="fault-edit-type-select" style="width: 100%;">
            <option value="MG" data-i18n="faultMG">Missed Gate</option>
            <option value="STR" data-i18n="faultSTR">Straddling</option>
            <option value="BR" data-i18n="faultBR">Binding Release</option>
          </select>
        </div>
        <!-- Run Selector -->
        <div style="margin-bottom: 16px;">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="run">Run</label>
          <div class="edit-run-selector" id="fault-edit-run-selector">
            <button class="edit-run-btn active" data-run="1" type="button">1</button>
            <button class="edit-run-btn" data-run="2" type="button">2</button>
          </div>
        </div>
        <!-- Version History -->
        <div class="fault-version-history" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--surface-elevated);">
          <label style="display: block; margin-bottom: 8px; color: var(--text-secondary);" data-i18n="versionHistory">Version History</label>
          <select class="filter-select" id="fault-version-select" style="width: 100%;">
            <!-- Populated dynamically -->
          </select>
          <button class="modal-btn secondary" id="restore-version-btn" style="margin-top: 8px; width: 100%;" data-i18n="restoreVersion">Restore Selected Version</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn primary" id="save-fault-edit-btn" data-i18n="save">Save</button>
      </div>
    </div>
  </div>

  <!-- Mark Fault for Deletion Modal -->
  <div class="modal-overlay glass-enable-target" id="mark-deletion-modal">
    <div class="modal-content glass-surface-1">
      <div class="modal-header">
        <h2 class="modal-title" data-i18n="markForDeletion">Mark for Deletion</h2>
      </div>
      <div class="modal-body">
        <p class="modal-text" data-i18n="markForDeletionText">This fault will be marked for deletion and requires Chief Judge approval to permanently delete.</p>
        <div class="mark-deletion-details" id="mark-deletion-details" style="margin-top: 12px; padding: 12px; background: var(--surface-elevated); border-radius: var(--radius); font-family: 'JetBrains Mono', monospace;">
          <!-- Populated dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-btn secondary" data-action="cancel" data-i18n="cancel">Cancel</button>
        <button class="modal-btn danger" id="confirm-mark-deletion-btn" data-i18n="markForDeletion">Mark for Deletion</button>
      </div>
    </div>
  </div>

  <!-- Fault Confirmation Overlay -->
  <div class="fault-confirmation-overlay" id="fault-confirmation-overlay">
    <div class="fault-confirmation-content">
      <div class="fault-confirmation-icon">‚ö†Ô∏è</div>
      <div class="fault-confirmation-bib">---</div>
      <div class="fault-confirmation-gate">Gate --</div>
      <div class="fault-confirmation-type">--</div>
    </div>
  </div>

  <!-- Onboarding Modal (Full-screen setup wizard) -->
  <div class="modal-overlay onboarding-fullscreen" id="onboarding-modal">
    <div class="onboarding-container">
      <div class="onboarding-progress" id="onboarding-progress">
        <span class="progress-dot active"></span>
        <span class="progress-dot"></span>
        <span class="progress-dot"></span>
        <span class="progress-dot"></span>
        <span class="progress-dot"></span>
      </div>

      <div class="onboarding-cards">
        <!-- Card 1: Welcome + Language -->
        <div class="onboarding-card" data-step="1">
          <div class="onboarding-icon">‚è±Ô∏è</div>
          <h2 data-i18n="onboardingWelcome">Welcome to Ski Race Timer</h2>
          <p data-i18n="onboardingWelcomeDesc">GPS-synchronized timing for ski races</p>
          <div class="onboarding-lang-select">
            <button class="lang-btn" data-lang="de">Deutsch</button>
            <button class="lang-btn" data-lang="en">English</button>
          </div>
          <button class="onboarding-btn primary" data-action="next" data-i18n="getStarted">Get Started</button>
        </div>

        <!-- Card 2: Role Selection (NEW) -->
        <div class="onboarding-card" data-step="2" style="display:none">
          <h2 data-i18n="onboardingRole">What's Your Role?</h2>
          <p data-i18n="onboardingRoleDesc">Choose how you'll be helping at the race</p>
          <div class="onboarding-role-select">
            <button class="role-card selected" data-role="timer" id="onboarding-role-timer">
              <div class="role-card-icon">‚è±Ô∏è</div>
              <div class="role-card-content">
                <span class="role-card-title" data-i18n="roleTimerTitle">Timer</span>
                <span class="role-card-desc" data-i18n="roleTimerDesc">Record start and finish times</span>
              </div>
              <div class="role-card-check">‚úì</div>
            </button>
            <button class="role-card" data-role="gateJudge" id="onboarding-role-judge">
              <div class="role-card-icon">üö©</div>
              <div class="role-card-content">
                <span class="role-card-title" data-i18n="roleJudgeTitle">Gate Judge</span>
                <span class="role-card-desc" data-i18n="roleJudgeDesc">Record gate faults (Torrichter)</span>
              </div>
              <div class="role-card-check">‚úì</div>
            </button>
          </div>
          <div class="onboarding-btn-row">
            <button class="onboarding-btn secondary" data-action="back" data-i18n="back">Back</button>
            <button class="onboarding-btn primary" data-action="next" data-i18n="continue">Continue</button>
          </div>
        </div>

        <!-- Card 3: Device Name -->
        <div class="onboarding-card" data-step="3" style="display:none">
          <h2 data-i18n="onboardingDeviceName" id="onboarding-device-name-title">Name Your Timer</h2>
          <p data-i18n="onboardingDeviceNameDesc" id="onboarding-device-name-desc">This identifies your device when syncing</p>
          <div class="onboarding-input-row">
            <input type="text" class="text-input" id="onboarding-device-name" maxlength="30">
            <button class="onboarding-regenerate-btn" id="onboarding-regenerate-name" type="button" aria-label="Generate new name">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 4v6h-6M1 20v-6h6"/>
                <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
              </svg>
            </button>
          </div>
          <div class="onboarding-btn-row">
            <button class="onboarding-btn secondary" data-action="back" data-i18n="back">Back</button>
            <button class="onboarding-btn primary" data-action="next" data-i18n="continue">Continue</button>
          </div>
        </div>

        <!-- Card 4a: Photo Capture (Timer path only) -->
        <div class="onboarding-card" data-step="4" data-path="timer" style="display:none">
          <div class="onboarding-icon">üì∑</div>
          <h2 data-i18n="onboardingPhoto">Photo Documentation</h2>
          <p data-i18n="onboardingPhotoDesc">Automatically capture a photo when recording each timestamp. Useful for verifying bib numbers and resolving disputes.</p>
          <label class="onboarding-toggle-row">
            <span data-i18n="enablePhotoCapture">Enable Photo Capture</span>
            <label class="toggle-switch">
              <input type="checkbox" id="onboarding-photo-toggle">
              <span class="toggle-slider"></span>
            </label>
          </label>
          <div class="onboarding-btn-row">
            <button class="onboarding-btn secondary" data-action="back" data-i18n="back">Back</button>
            <button class="onboarding-btn primary" data-action="next" data-i18n="continue">Continue</button>
          </div>
        </div>

        <!-- Card 4b: Gate Assignment (Gate Judge path only) -->
        <div class="onboarding-card" data-step="4" data-path="gateJudge" style="display:none">
          <div class="onboarding-icon">üö©</div>
          <h2 data-i18n="onboardingGates">Your Gate Assignment</h2>
          <p data-i18n="onboardingGatesDesc">Enter the gate numbers you'll be watching. You can change this later.</p>
          <div class="onboarding-gate-inputs">
            <div class="gate-input-group">
              <label data-i18n="gatesFrom">From</label>
              <input type="number" class="text-input gate-input" id="onboarding-gate-start" min="1" max="99" value="1">
            </div>
            <span class="gate-range-separator">‚Äì</span>
            <div class="gate-input-group">
              <label data-i18n="gatesTo">To</label>
              <input type="number" class="text-input gate-input" id="onboarding-gate-end" min="1" max="99" value="10">
            </div>
          </div>
          <div class="onboarding-btn-row">
            <button class="onboarding-btn secondary" data-action="back" data-i18n="back">Back</button>
            <button class="onboarding-btn primary" data-action="next" data-i18n="continue">Continue</button>
          </div>
        </div>

        <!-- Card 5: Race Setup -->
        <div class="onboarding-card" data-step="5" style="display:none">
          <h2 data-i18n="onboardingRaceSetup">Join a Race</h2>
          <p data-i18n="onboardingRaceSetupDesc">Enter a race ID to sync with other timers</p>
          <div class="race-id-input-row">
            <input type="text" class="text-input" id="onboarding-race-id" placeholder="e.g. RACE-2024">
            <button class="recent-races-btn" id="onboarding-recent-races-btn" type="button" aria-label="Recent races">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
            </button>
            <div class="recent-races-dropdown" id="onboarding-recent-races-dropdown" style="display:none"></div>
          </div>
          <div class="race-status" id="onboarding-race-status"></div>
          <input type="password" class="text-input" id="onboarding-pin" placeholder="PIN (4 digits)" maxlength="4" inputmode="numeric" style="display:none">
          <label class="onboarding-toggle-row">
            <span data-i18n="enableSync">Enable Cloud Sync</span>
            <label class="toggle-switch">
              <input type="checkbox" id="onboarding-sync-toggle" checked>
              <span class="toggle-slider"></span>
            </label>
          </label>
          <div class="onboarding-btn-row">
            <button class="onboarding-btn secondary" data-action="back" data-i18n="back">Back</button>
            <button class="onboarding-btn primary" data-action="next" data-i18n="continue">Continue</button>
          </div>
          <button class="onboarding-btn text" data-action="skip" data-i18n="skipForNow">Skip for now</button>
        </div>

        <!-- Card 6: Ready -->
        <div class="onboarding-card" data-step="6" style="display:none">
          <div class="onboarding-icon success">‚úì</div>
          <h2 data-i18n="onboardingReady" id="onboarding-ready-title">Ready to Time!</h2>
          <div class="onboarding-summary" id="onboarding-summary"></div>
          <p class="onboarding-tip" data-i18n="onboardingTip" id="onboarding-ready-tip">Tap the big red button to record timestamps</p>
          <button class="onboarding-btn primary" data-action="finish" data-i18n="startTiming" id="onboarding-finish-btn">Start Timing</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module" src="/src/main.ts"></script>
</body>
</html>
