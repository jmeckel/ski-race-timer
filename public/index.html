<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ski Race Timer</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="GPS-synchronisierte Zeitmessung für Skirennen">
    <meta name="theme-color" content="#0A0E14">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RaceTimer">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00D4FF;
            --primary-dark: #0099CC;
            --secondary: #FF6B35;
            --secondary-light: #FF8F5E;
            --accent: #7CFF6B;
            --background: #0A0E14;
            --surface: #151B23;
            --surface-elevated: #1E2732;
            --text-primary: #FFFFFF;
            --text-secondary: #8B9AAB;
            --text-tertiary: #5A6673;
            --success: #4ADE80;
            --warning: #FBBF24;
            --error: #EF4444;
            --gps-active: #4ADE80;
            --gps-searching: #FBBF24;
            --gps-inactive: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 430px;
            margin: 0 auto;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, var(--background) 0%, rgba(21, 27, 35, 0.5) 50%, var(--background) 100%);
        }

        .tab-bar {
            display: flex;
            background: var(--surface);
            border-top: 1px solid var(--surface-elevated);
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: 430px;
            margin: 0 auto;
            z-index: 100;
        }

        .tab-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .tab-item.active { color: var(--primary); }
        .tab-item svg { width: 24px; height: 24px; }
        .tab-item span { font-size: 10px; font-weight: 600; }

        .view {
            display: none;
            flex: 1;
            flex-direction: column;
            padding-bottom: 80px;
        }

        .view.active { display: flex; }

        .gps-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            margin: 12px 16px 0;
            background: rgba(21, 27, 35, 0.5);
            border-radius: 12px;
        }

        .gps-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--gps-searching);
            box-shadow: 0 0 8px var(--gps-searching);
            animation: pulse 2s ease-in-out infinite;
        }

        .gps-dot.active {
            background: var(--gps-active);
            box-shadow: 0 0 8px var(--gps-active);
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .gps-text { font-size: 12px; color: var(--text-secondary); flex: 1; }
        .gps-accuracy {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-secondary);
            background: var(--surface-elevated);
            padding: 4px 8px;
            border-radius: 6px;
        }

        .live-clock {
            text-align: center;
            padding: 16px 0 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 42px;
            font-weight: 600;
            letter-spacing: -1px;
        }

        .live-clock .hours, .live-clock .minutes { color: var(--text-secondary); }
        .live-clock .separator { color: var(--text-tertiary); }
        .live-clock .seconds { color: var(--text-primary); }
        .live-clock .millis { color: var(--primary); }

        .timing-points {
            display: flex;
            gap: 12px;
            padding: 0 16px;
            justify-content: center;
            margin-top: 12px;
        }

        .timing-point {
            flex: 1;
            height: 44px;
            border: none;
            border-radius: 10px;
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .timing-point[data-point="S"] { --point-color: #4ADE80; }
        .timing-point[data-point="F"] { --point-color: #EF4444; }

        .timing-point {
            background: rgba(255, 255, 255, 0.08);
            color: var(--point-color);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timing-point.active {
            background: var(--point-color);
            color: var(--background);
        }

        .bib-display { text-align: center; padding: 24px 0 16px; }
        .bib-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            letter-spacing: 4px;
            margin-bottom: 4px;
        }

        .bib-number {
            font-family: 'Outfit', sans-serif;
            font-size: 96px;
            font-weight: 900;
            color: var(--text-tertiary);
            line-height: 1;
            transition: color 0.15s ease;
        }

        .bib-number.valid { color: var(--text-primary); }

        .number-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 0 24px;
            margin-top: 8px;
        }

        .num-btn {
            height: 64px;
            border: none;
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 32px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.1s ease;
            background: var(--surface);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .num-btn:active { transform: scale(0.95); }
        .num-btn.clear { background: rgba(251, 191, 36, 0.15); color: var(--warning); font-size: 24px; }
        .num-btn.delete { background: rgba(239, 68, 68, 0.15); color: var(--error); font-size: 24px; }

        .timestamp-btn-container { padding: 20px 24px; margin-top: auto; }

        .timestamp-btn {
            width: 100%;
            height: 120px;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.15s ease;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%);
            box-shadow: 0 8px 32px rgba(255, 107, 53, 0.4);
        }

        .timestamp-btn.has-bib {
            background: linear-gradient(135deg, #22c55e 0%, #4ade80 100%);
            box-shadow: 0 8px 32px rgba(34, 197, 94, 0.4);
        }

        .timestamp-btn:active { transform: scale(0.97); }

        .timestamp-btn-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            color: white;
        }

        .timestamp-btn-content svg { width: 36px; height: 36px; }
        .timestamp-btn-content span { font-size: 18px; font-weight: 800; letter-spacing: 3px; }

        .confirmation-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 20, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .confirmation-overlay.show { opacity: 1; pointer-events: auto; }

        .confirmation-card {
            background: var(--surface-elevated);
            padding: 32px 48px;
            border-radius: 24px;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.2s ease;
            box-shadow: 0 0 60px rgba(74, 222, 128, 0.2);
        }

        .confirmation-overlay.show .confirmation-card { transform: scale(1); }
        .confirmation-icon { width: 56px; height: 56px; color: var(--success); margin-bottom: 16px; }
        .confirmation-bib { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .confirmation-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 8px;
        }
        .confirmation-point { font-size: 12px; font-weight: 700; padding: 4px 12px; border-radius: 6px; display: inline-block; }

        .results-header { padding: 12px 16px; }
        .results-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .results-title { font-size: 24px; font-weight: 800; margin: 0; }
        .results-actions { display: flex; gap: 6px; }

        .icon-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface);
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .icon-btn svg {
            width: 18px;
            height: 18px;
        }

        .icon-btn:hover { background: var(--surface-elevated); color: var(--text-primary); }
        .icon-btn:active { transform: scale(0.95); }
        .icon-btn.active { background: var(--primary); color: var(--background); }
        .icon-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .icon-btn:disabled:hover { background: var(--surface); color: var(--text-secondary); }

        .select-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface-elevated);
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .select-bar span { font-size: 12px; color: var(--text-secondary); font-weight: 600; }
        .select-bar-actions { display: flex; gap: 4px; }

        .select-bar-btn {
            background: var(--surface);
            border: none;
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 11px;
            font-weight: 600;
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 3px;
            transition: all 0.15s ease;
        }

        .select-bar-btn svg {
            width: 14px;
            height: 14px;
        }

        .select-bar-btn:hover { background: var(--text-tertiary); color: var(--text-primary); }
        .select-bar-btn.danger { color: var(--error); }
        .select-bar-btn.danger:hover { background: var(--error); color: white; }
        .select-bar-btn.cancel { background: var(--primary); color: var(--background); }

        .export-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--primary);
            border: none;
            color: var(--background);
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            font-weight: 700;
            padding: 10px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .export-btn:disabled { background: var(--surface); color: var(--text-tertiary); cursor: not-allowed; }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: var(--surface);
            border: 1px solid var(--surface-elevated);
            color: var(--text-secondary);
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            font-weight: 600;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .action-btn:hover { background: var(--surface-elevated); color: var(--text-primary); }
        .action-btn.active { background: var(--primary); border-color: var(--primary); color: var(--background); }
        .action-btn.danger { background: rgba(239, 68, 68, 0.15); border-color: var(--error); color: var(--error); }
        .action-btn.danger:hover { background: var(--error); color: white; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .result-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid transparent;
        }

        .result-row.no-bib { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.2); }
        .result-row.selected { background: rgba(0, 212, 255, 0.15); border-color: var(--primary); }

        .result-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid var(--text-tertiary);
            border-radius: 6px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .select-mode .result-checkbox { display: flex; }
        .result-checkbox.checked { background: var(--primary); border-color: var(--primary); }
        .result-checkbox svg { width: 14px; height: 14px; color: var(--background); opacity: 0; }
        .result-checkbox.checked svg { opacity: 1; }

        .result-bib {
            font-size: 18px;
            font-weight: 700;
            background: var(--surface-elevated);
            padding: 8px 12px;
            border-radius: 8px;
            min-width: 56px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }

        .result-bib:hover { border-color: var(--primary); }
        .result-bib.no-bib { color: var(--error); font-style: italic; }
        .select-mode .result-bib { cursor: default; }
        .select-mode .result-bib:hover { border-color: transparent; }
        .select-mode .result-delete { display: none; }

        .result-point { font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 6px; text-align: center; }
        .result-info { flex: 1; }
        .result-time { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 600; color: var(--primary); }
        .result-date { font-size: 11px; color: var(--text-tertiary); }

        .result-delete {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.15s ease;
        }

        .result-delete:hover { background: rgba(239, 68, 68, 0.15); color: var(--error); }

        .results-list { flex: 1; overflow-y: auto; padding: 0 16px 16px; }

        .results-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 64px 16px;
            color: var(--text-tertiary);
        }

        .results-empty svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
        .results-empty-title { font-size: 20px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }

        .summary-cards { display: flex; gap: 8px; }
        .summary-card { flex: 1; background: var(--surface); border-radius: 10px; padding: 8px; text-align: center; }
        .summary-card-label { font-size: 9px; color: var(--text-tertiary); display: flex; align-items: center; justify-content: center; gap: 3px; margin-bottom: 2px; }
        .summary-card-label svg { width: 10px; height: 10px; }
        .summary-card-value { font-size: 20px; font-weight: 700; }
        .summary-card-value.primary { color: var(--primary); }
        .summary-card-value.accent { color: var(--accent); }
        .summary-card-value.secondary { color: var(--secondary); }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 14, 20, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .modal-overlay.show { opacity: 1; pointer-events: auto; }

        .modal-card {
            background: var(--surface-elevated);
            padding: 24px;
            border-radius: 20px;
            width: 90%;
            max-width: 320px;
            transform: scale(0.9);
            transition: transform 0.2s ease;
        }

        .modal-overlay.show .modal-card { transform: scale(1); }
        .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; text-align: center; }
        .modal-subtitle { font-size: 13px; color: var(--text-tertiary); text-align: center; margin-bottom: 20px; }

        .modal-input {
            width: 100%;
            background: var(--surface);
            border: 2px solid var(--surface-elevated);
            border-radius: 12px;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            text-align: center;
            outline: none;
        }

        .modal-input:focus { border-color: var(--primary); }

        .modal-input.text-input {
            font-family: 'Outfit', sans-serif;
            font-size: 18px;
            font-weight: 600;
            text-align: left;
        }

        .modal-buttons { display: flex; gap: 12px; margin-top: 20px; }

        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
        }

        .modal-btn.cancel { background: var(--surface); color: var(--text-secondary); }
        .modal-btn.save { background: var(--primary); color: var(--background); }
        .modal-btn:active { transform: scale(0.96); }

        .settings-header { padding: 16px; }
        .settings-title { font-size: 28px; font-weight: 800; margin-bottom: 8px; }
        .settings-section { padding: 0 16px 16px; }
        .settings-section-title { font-size: 12px; font-weight: 600; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .settings-card { background: var(--surface); border-radius: 12px; overflow: hidden; }

        .settings-row {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border-bottom: 1px solid var(--surface-elevated);
        }

        .settings-row:last-child { border-bottom: none; }
        .settings-row-icon { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; margin-right: 12px; }
        .settings-row-icon svg { width: 18px; height: 18px; }
        .settings-row-label { flex: 1; font-size: 15px; }

        .toggle {
            width: 48px;
            height: 28px;
            background: var(--surface-elevated);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .toggle.on { background: var(--primary); }

        .toggle::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.2s ease;
        }

        .toggle.on::after { transform: translateX(20px); }

        .language-selector {
            display: flex;
            background: var(--surface-elevated);
            border-radius: 8px;
            overflow: hidden;
        }

        .lang-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .lang-btn.active { background: var(--primary); color: var(--background); }

        .gps-detail-card { padding: 16px; }
        .gps-detail-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
        .gps-detail-status { display: flex; align-items: center; gap: 8px; }
        .gps-detail-dot { width: 12px; height: 12px; border-radius: 50%; }
        .gps-sync-btn { background: rgba(0, 212, 255, 0.15); border: none; color: var(--primary); font-size: 12px; font-weight: 700; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .gps-detail-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding-top: 12px; border-top: 1px solid var(--surface-elevated); }
        .gps-detail-item label { font-size: 10px; color: var(--text-tertiary); display: block; margin-bottom: 2px; }
        .gps-detail-item span { font-size: 14px; font-weight: 600; }

        .about-card { text-align: center; padding: 32px 16px; }
        .about-icon { width: 80px; height: 80px; background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
        .about-icon svg { width: 40px; height: 40px; color: white; }
        .about-title { font-size: 24px; font-weight: 800; margin-bottom: 4px; }
        .about-subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 24px; }
        .about-features { text-align: left; background: var(--surface-elevated); border-radius: 12px; padding: 16px; }
        .about-feature { display: flex; align-items: center; gap: 12px; padding: 8px 0; }
        .about-feature svg { width: 18px; height: 18px; color: var(--primary); }
        .about-feature span { font-size: 14px; color: var(--text-secondary); }
        .about-version { margin-top: 24px; font-size: 12px; color: var(--text-tertiary); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Timing View -->
        <div id="timing-view" class="view active">
            <div class="gps-status">
                <div id="gps-dot" class="gps-dot"></div>
                <span id="gps-text" class="gps-text">Syncing GPS time...</span>
                <span id="gps-accuracy" class="gps-accuracy">±20ms</span>
            </div>

            <div class="live-clock">
                <span class="hours" id="clock-hours">00</span><span class="separator">:</span><span class="minutes" id="clock-minutes">00</span><span class="separator">:</span><span class="seconds" id="clock-seconds">00</span><span class="separator">.</span><span class="millis" id="clock-millis">000</span>
            </div>

            <div class="timing-points">
                <button class="timing-point" data-point="S" id="btn-start">Start</button>
                <button class="timing-point active" data-point="F" id="btn-finish">Finish</button>
            </div>

            <div class="bib-display">
                <div class="bib-label" id="bib-label">BIB</div>
                <div id="bib-number" class="bib-number">---</div>
            </div>

            <div class="number-pad">
                <button class="num-btn" data-digit="1">1</button>
                <button class="num-btn" data-digit="2">2</button>
                <button class="num-btn" data-digit="3">3</button>
                <button class="num-btn" data-digit="4">4</button>
                <button class="num-btn" data-digit="5">5</button>
                <button class="num-btn" data-digit="6">6</button>
                <button class="num-btn" data-digit="7">7</button>
                <button class="num-btn" data-digit="8">8</button>
                <button class="num-btn" data-digit="9">9</button>
                <button class="num-btn clear" id="btn-clear">C</button>
                <button class="num-btn" data-digit="0">0</button>
                <button class="num-btn delete" id="btn-delete">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/>
                        <line x1="18" y1="9" x2="12" y2="15"/>
                        <line x1="12" y1="9" x2="18" y2="15"/>
                    </svg>
                </button>
            </div>

            <div class="timestamp-btn-container">
                <button id="timestamp-btn" class="timestamp-btn">
                    <div class="timestamp-btn-content">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
                        </svg>
                        <span id="timestamp-label">TIMESTAMP</span>
                    </div>
                </button>
            </div>
        </div>

        <!-- Results View -->
        <div id="results-view" class="view">
            <div class="results-header">
                <div class="results-header-row">
                    <h1 class="results-title" id="results-title">Results</h1>
                    <div class="results-actions">
                        <button id="select-btn" class="icon-btn" onclick="toggleSelectMode()" title="Select">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM17.99 9l-1.41-1.42-6.59 6.59-2.58-2.57-1.42 1.41 4 3.99z"/>
                            </svg>
                        </button>
                        <button id="export-btn" class="icon-btn" onclick="exportCSV()" disabled title="Export CSV">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="select-bar" class="select-bar" style="display: none;">
                    <span id="select-count">0 selected</span>
                    <div class="select-bar-actions">
                        <button class="select-bar-btn" onclick="selectAll()">All</button>
                        <button class="select-bar-btn" onclick="selectNone()">None</button>
                        <button class="select-bar-btn danger" onclick="deleteSelected()" id="delete-selected-btn">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                            </svg>
                            Delete
                        </button>
                        <button class="select-bar-btn cancel" onclick="toggleSelectMode()">Done</button>
                    </div>
                </div>
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-card-label">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 4h2v16H4zm4 4h2v12H8zm4-4h2v16h-2zm4 8h2v8h-2zm4-4h2v12h-2z"/></svg>
                            <span id="total-label">Total</span>
                        </div>
                        <div id="total-count" class="summary-card-value primary">0</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-label">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                            <span id="racers-label">Racers</span>
                        </div>
                        <div id="racer-count" class="summary-card-value accent">0</div>
                    </div>
                </div>
            </div>
            <div id="results-list" class="results-list"></div>
        </div>

        <!-- Settings View -->
        <div id="settings-view" class="view">
            <div class="settings-header">
                <h1 class="settings-title" id="settings-title">Settings</h1>
            </div>

            <div class="settings-section">
                <div class="settings-section-title" id="race-name-label">Race Name</div>
                <div class="settings-card">
                    <div class="settings-row" onclick="editRaceName()" style="cursor: pointer;">
                        <div class="settings-row-icon" style="color: var(--secondary);">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6z"/></svg>
                        </div>
                        <span class="settings-row-label" id="current-race-name">Ski Race</span>
                        <svg viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px; color: var(--text-tertiary);">
                            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title" id="gps-status-label">GPS Status</div>
                <div class="settings-card">
                    <div class="gps-detail-card">
                        <div class="gps-detail-header">
                            <div class="gps-detail-status">
                                <div id="settings-gps-dot" class="gps-detail-dot" style="background: var(--gps-active); box-shadow: 0 0 8px var(--gps-active);"></div>
                                <span id="settings-gps-status" style="font-weight: 600;">GPS Synced</span>
                            </div>
                            <button class="gps-sync-btn" onclick="simulateGPSSync()">Sync</button>
                        </div>
                        <div class="gps-detail-grid">
                            <div class="gps-detail-item">
                                <label id="accuracy-label">Accuracy</label>
                                <span>5.2m</span>
                            </div>
                            <div class="gps-detail-item">
                                <label id="precision-label">Time Precision</label>
                                <span style="color: var(--primary);">±20ms</span>
                            </div>
                            <div class="gps-detail-item">
                                <label id="quality-label">Quality</label>
                                <span id="quality-value" style="color: var(--success);">Excellent</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title" id="timing-settings-label">Timing Settings</div>
                <div class="settings-card">
                    <div class="settings-row">
                        <div class="settings-row-icon" style="color: var(--primary);">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                        </div>
                        <span class="settings-row-label" id="auto-increment-label">Auto-increment Bib</span>
                        <div id="toggle-auto-increment" class="toggle on" onclick="toggleAutoIncrement(this)"></div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-row-icon" style="color: var(--secondary);">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 9.5C7 8.67 7.67 8 8.5 8s1.5.67 1.5 1.5S9.33 11 8.5 11 7 10.33 7 9.5zm5 8c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5zm3.5-6.5c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5z"/></svg>
                        </div>
                        <span class="settings-row-label" id="haptic-label">Haptic Feedback</span>
                        <div class="toggle on" onclick="toggleSetting(this)"></div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-row-icon" style="color: var(--accent);">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
                        </div>
                        <span class="settings-row-label" id="sound-label">Sound Effects</span>
                        <div class="toggle on" onclick="toggleSetting(this)"></div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-row-icon" style="color: var(--warning);">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/></svg>
                        </div>
                        <span class="settings-row-label" id="screen-label">Keep Screen On</span>
                        <div class="toggle on" onclick="toggleSetting(this)"></div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-row-icon" style="color: var(--primary);">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>
                        </div>
                        <span class="settings-row-label" id="language-label">Language</span>
                        <div class="language-selector">
                            <button class="lang-btn" data-lang="en" onclick="setLanguage('en')">EN</button>
                            <button class="lang-btn active" data-lang="de" onclick="setLanguage('de')">DE</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <div class="settings-section-title" id="about-label">About</div>
                <div class="settings-card">
                    <div class="about-card">
                        <div class="about-icon">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
                            </svg>
                        </div>
                        <h2 class="about-title">Ski Race Timer</h2>
                        <p class="about-subtitle" id="about-subtitle">GPS-Synchronized Race Timing</p>
                        <div class="about-features">
                            <div class="about-feature">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z"/></svg>
                                <span id="feature-gps">GPS-synced timestamps</span>
                            </div>
                            <div class="about-feature">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 2.05v2.02c3.95.49 7 3.85 7 7.93 0 3.21-1.92 6-4.72 7.28L13 17v5h5l-1.22-1.22C19.91 19.07 22 15.76 22 12c0-5.18-3.95-9.45-9-9.95z"/></svg>
                                <span id="feature-precision">Millisecond precision</span>
                            </div>
                            <div class="about-feature">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z"/></svg>
                                <span id="feature-export">CSV & JSON export</span>
                            </div>
                            <div class="about-feature">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M15.5 1h-8C6.12 1 5 2.12 5 3.5v17C5 21.88 6.12 23 7.5 23h8c1.38 0 2.5-1.12 2.5-2.5v-17C18 2.12 16.88 1 15.5 1z"/></svg>
                                <span id="feature-outdoor">Designed for outdoor use</span>
                            </div>
                        </div>
                        <p class="about-version">Version 1.0.0 • Web Prototype</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Bar -->
        <nav class="tab-bar">
            <button class="tab-item active" data-view="timing-view">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
                </svg>
                <span id="tab-timer">Timer</span>
            </button>
            <button class="tab-item" data-view="results-view">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/>
                </svg>
                <span id="tab-results">Results</span>
            </button>
            <button class="tab-item" data-view="settings-view">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/>
                </svg>
                <span id="tab-settings">Settings</span>
            </button>
        </nav>

        <!-- Edit Bib Modal -->
        <div id="edit-modal" class="modal-overlay">
            <div class="modal-card">
                <div class="modal-title" id="edit-modal-title">Edit Bib Number</div>
                <div class="modal-subtitle" id="edit-modal-time">10:30:45.123</div>
                <input type="number" id="edit-bib-input" class="modal-input" placeholder="---" min="1" max="999">
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeEditModal()" id="modal-cancel">Cancel</button>
                    <button class="modal-btn save" onclick="saveEditBib()" id="modal-save">Save</button>
                </div>
            </div>
        </div>

        <!-- Race Name Edit Modal -->
        <div id="race-name-modal" class="modal-overlay">
            <div class="modal-card">
                <div class="modal-title" id="race-name-modal-title">Edit Race Name</div>
                <input type="text" id="race-name-input" class="modal-input text-input" placeholder="Enter race name...">
                <div class="modal-buttons">
                    <button class="modal-btn cancel" onclick="closeRaceNameModal()" id="race-name-modal-cancel">Cancel</button>
                    <button class="modal-btn save" onclick="saveRaceName()" id="race-name-modal-save">Save</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Overlay -->
        <div id="confirmation-overlay" class="confirmation-overlay">
            <div class="confirmation-card">
                <svg class="confirmation-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <div class="confirmation-bib" id="confirm-bib">Bib 001</div>
                <div class="confirmation-time" id="confirm-time">10:30:45.123</div>
                <div class="confirmation-point" id="confirm-point">Start</div>
            </div>
        </div>
    </div>

    <script>
        // State
        let bibInput = '';
        let selectedPoint = 'F';
        let entries = [];
        let autoIncrement = true;
        let selectedEntries = new Set();
        let isSelectMode = false;
        let language = localStorage.getItem('skiTimerLang') || 'de';
        let raceName = localStorage.getItem('skiTimerRaceName') || 'Ski Race';

        // Translations
        const translations = {
            en: {
                start: 'Start',
                finish: 'Finish',
                timestamp: 'TIMESTAMP',
                bib: 'BIB',
                noBib: 'No Bib',
                gpsSyncing: 'Syncing GPS time...',
                gpsSynced: 'GPS Synced',
                results: 'Results',
                total: 'Total',
                racers: 'Racers',
                select: 'Select',
                cancel: 'Cancel',
                delete: 'Delete',
                export: 'Export',
                noTimesRecorded: 'No Times Recorded',
                noTimesDesc: 'Recorded timestamps will appear here',
                editBibNumber: 'Edit Bib Number',
                save: 'Save',
                settings: 'Settings',
                gpsStatus: 'GPS Status',
                accuracy: 'Accuracy',
                timePrecision: 'Time Precision',
                quality: 'Quality',
                excellent: 'Excellent',
                timingSettings: 'Timing Settings',
                autoIncrementBib: 'Auto-increment Bib',
                hapticFeedback: 'Haptic Feedback',
                soundEffects: 'Sound Effects',
                keepScreenOn: 'Keep Screen On',
                language: 'Language',
                about: 'About',
                aboutSubtitle: 'GPS-Synchronized Race Timing',
                featureGps: 'GPS-synced timestamps',
                featurePrecision: 'Millisecond precision',
                featureExport: 'CSV & JSON export',
                featureOutdoor: 'Designed for outdoor use',
                timer: 'Timer',
                raceName: 'Race Name',
                editRaceName: 'Edit Race Name',
                raceNamePlaceholder: 'Enter race name...'
            },
            de: {
                start: 'Start',
                finish: 'Ziel',
                timestamp: 'ZEIT ERFASSEN',
                bib: 'STARTNR',
                noBib: 'Keine Nr.',
                gpsSyncing: 'GPS wird synchronisiert...',
                gpsSynced: 'GPS synchronisiert',
                results: 'Ergebnisse',
                total: 'Gesamt',
                racers: 'Fahrer',
                select: 'Auswählen',
                cancel: 'Abbrechen',
                delete: 'Löschen',
                export: 'Export',
                noTimesRecorded: 'Keine Zeiten erfasst',
                noTimesDesc: 'Erfasste Zeiten erscheinen hier',
                editBibNumber: 'Startnummer bearbeiten',
                save: 'Speichern',
                settings: 'Einstellungen',
                gpsStatus: 'GPS-Status',
                accuracy: 'Genauigkeit',
                timePrecision: 'Zeitpräzision',
                quality: 'Qualität',
                excellent: 'Ausgezeichnet',
                timingSettings: 'Zeitmessung',
                autoIncrementBib: 'Startnr. erhöhen',
                hapticFeedback: 'Haptisches Feedback',
                soundEffects: 'Soundeffekte',
                keepScreenOn: 'Display anlassen',
                language: 'Sprache',
                about: 'Über',
                aboutSubtitle: 'GPS-synchronisierte Zeitmessung',
                featureGps: 'GPS-synchronisierte Zeiten',
                featurePrecision: 'Millisekunden-Präzision',
                featureExport: 'CSV & JSON Export',
                featureOutdoor: 'Für den Außeneinsatz',
                timer: 'Timer',
                raceName: 'Rennbezeichnung',
                editRaceName: 'Rennbezeichnung ändern',
                raceNamePlaceholder: 'Rennname eingeben...'
            }
        };

        function t(key) {
            return translations[language][key] || translations['en'][key] || key;
        }

        const pointColors = { 'S': '#4ADE80', 'F': '#EF4444' };

        // Elements
        const bibDisplay = document.getElementById('bib-number');
        const timestampBtn = document.getElementById('timestamp-btn');
        const confirmationOverlay = document.getElementById('confirmation-overlay');
        const gpsDot = document.getElementById('gps-dot');
        const gpsText = document.getElementById('gps-text');

        // Initialize language
        function updateLanguage() {
            // Timer view
            document.getElementById('btn-start').textContent = t('start');
            document.getElementById('btn-finish').textContent = t('finish');
            document.getElementById('timestamp-label').textContent = t('timestamp');
            document.getElementById('bib-label').textContent = t('bib');
            
            // Results view
            document.getElementById('results-title').textContent = t('results');
            document.getElementById('total-label').textContent = t('total');
            document.getElementById('racers-label').textContent = t('racers');
            
            // Settings view
            document.getElementById('settings-title').textContent = t('settings');
            document.getElementById('gps-status-label').textContent = t('gpsStatus');
            document.getElementById('settings-gps-status').textContent = t('gpsSynced');
            document.getElementById('accuracy-label').textContent = t('accuracy');
            document.getElementById('precision-label').textContent = t('timePrecision');
            document.getElementById('quality-label').textContent = t('quality');
            document.getElementById('quality-value').textContent = t('excellent');
            document.getElementById('timing-settings-label').textContent = t('timingSettings');
            document.getElementById('auto-increment-label').textContent = t('autoIncrementBib');
            document.getElementById('haptic-label').textContent = t('hapticFeedback');
            document.getElementById('sound-label').textContent = t('soundEffects');
            document.getElementById('screen-label').textContent = t('keepScreenOn');
            document.getElementById('language-label').textContent = t('language');
            document.getElementById('about-label').textContent = t('about');
            document.getElementById('about-subtitle').textContent = t('aboutSubtitle');
            document.getElementById('feature-gps').textContent = t('featureGps');
            document.getElementById('feature-precision').textContent = t('featurePrecision');
            document.getElementById('feature-export').textContent = t('featureExport');
            document.getElementById('feature-outdoor').textContent = t('featureOutdoor');
            
            // Tab bar
            document.getElementById('tab-timer').textContent = t('timer');
            document.getElementById('tab-results').textContent = t('results');
            document.getElementById('tab-settings').textContent = t('settings');
            
            // Modal
            document.getElementById('edit-modal-title').textContent = t('editBibNumber');
            document.getElementById('modal-cancel').textContent = t('cancel');
            document.getElementById('modal-save').textContent = t('save');
            
            // Race name modal
            document.getElementById('race-name-label').textContent = t('raceName');
            document.getElementById('race-name-modal-title').textContent = t('editRaceName');
            document.getElementById('race-name-input').placeholder = t('raceNamePlaceholder');
            document.getElementById('race-name-modal-cancel').textContent = t('cancel');
            document.getElementById('race-name-modal-save').textContent = t('save');
            
            // Update select count if in select mode
            if (isSelectMode) {
                updateSelectCount();
            }
            
            // Update language selector
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === language);
            });
            
            // Update results list
            updateResults();
        }

        function setLanguage(lang) {
            language = lang;
            localStorage.setItem('skiTimerLang', lang);
            updateLanguage();
            vibrate(15);
        }

        // Clock update
        function updateClock() {
            const now = new Date();
            document.getElementById('clock-hours').textContent = String(now.getHours()).padStart(2, '0');
            document.getElementById('clock-minutes').textContent = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('clock-seconds').textContent = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('clock-millis').textContent = String(now.getMilliseconds()).padStart(3, '0');
        }

        setInterval(updateClock, 50);
        updateClock();

        // Simulate GPS sync
        setTimeout(() => {
            gpsDot.classList.add('active');
            gpsText.textContent = t('gpsSynced');
        }, 2000);

        // Tab navigation
        document.querySelectorAll('.tab-item').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.view).classList.add('active');
                vibrate(10);
            });
        });

        // Timing point selection
        document.querySelectorAll('.timing-point').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.timing-point').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedPoint = btn.dataset.point;
                vibrate(10);
            });
        });

        // Number pad
        document.querySelectorAll('.num-btn[data-digit]').forEach(btn => {
            btn.addEventListener('click', () => {
                if (bibInput.length < 3) {
                    bibInput += btn.dataset.digit;
                    updateBibDisplay();
                    vibrate(15);
                }
            });
        });

        document.getElementById('btn-clear').addEventListener('click', () => {
            bibInput = '';
            updateBibDisplay();
            vibrate(20);
        });

        document.getElementById('btn-delete').addEventListener('click', () => {
            bibInput = bibInput.slice(0, -1);
            updateBibDisplay();
            vibrate(20);
        });

        function updateBibDisplay() {
            if (bibInput === '') {
                bibDisplay.textContent = '---';
                bibDisplay.classList.remove('valid');
                timestampBtn.classList.remove('has-bib');
            } else {
                bibDisplay.textContent = bibInput.padStart(3, '0');
                bibDisplay.classList.add('valid');
                timestampBtn.classList.add('has-bib');
            }
        }

        // Timestamp button
        timestampBtn.addEventListener('click', () => {
            const now = new Date();
            const hasBib = bibInput !== '';
            const entry = {
                id: Date.now(),
                bib: hasBib ? parseInt(bibInput) : null,
                timestamp: now,
                point: selectedPoint
            };

            entries.unshift(entry);
            
            // Show confirmation
            document.getElementById('confirm-bib').textContent = hasBib ? `Bib ${bibInput.padStart(3, '0')}` : t('noBib');
            document.getElementById('confirm-time').textContent = formatTime(now);
            const pointEl = document.getElementById('confirm-point');
            pointEl.textContent = selectedPoint === 'S' ? t('start') : t('finish');
            pointEl.style.background = pointColors[selectedPoint];
            pointEl.style.color = '#fff';
            
            confirmationOverlay.classList.add('show');
            vibrate([30, 50, 30]);
            
            setTimeout(() => {
                confirmationOverlay.classList.remove('show');
            }, 1500);

            // Auto-increment
            if (autoIncrement && hasBib) {
                const currentBib = parseInt(bibInput);
                bibInput = currentBib < 999 ? String(currentBib + 1) : '1';
            } else if (!autoIncrement) {
                bibInput = '';
            }
            updateBibDisplay();
            updateResults();
        });

        function formatTime(date) {
            return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}.${String(date.getMilliseconds()).padStart(3, '0')}`;
        }

        function formatDate(date) {
            return date.toLocaleDateString(language === 'de' ? 'de-DE' : 'en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function updateResults() {
            const totalEl = document.getElementById('total-count');
            const racerEl = document.getElementById('racer-count');
            const listEl = document.getElementById('results-list');
            const exportBtn = document.getElementById('export-btn');
            const selectBtn = document.getElementById('select-btn');

            totalEl.textContent = entries.length;
            const uniqueRacers = new Set(entries.filter(e => e.bib !== null).map(e => e.bib));
            racerEl.textContent = uniqueRacers.size;
            
            const exportableEntries = entries.filter(e => e.bib !== null);
            exportBtn.disabled = exportableEntries.length === 0;
            selectBtn.disabled = entries.length === 0;

            if (entries.length === 0) {
                listEl.innerHTML = `
                    <div class="results-empty">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/>
                        </svg>
                        <div class="results-empty-title">${t('noTimesRecorded')}</div>
                        <div>${t('noTimesDesc')}</div>
                    </div>
                `;
                return;
            }

            const selectModeClass = isSelectMode ? 'select-mode' : '';
            listEl.className = `results-list ${selectModeClass}`;

            listEl.innerHTML = entries.map(entry => {
                const isSelected = selectedEntries.has(entry.id);
                const noBibClass = entry.bib === null ? 'no-bib' : '';
                const selectedClass = isSelected ? 'selected' : '';
                const bibDisplayText = entry.bib !== null ? String(entry.bib).padStart(3, '0') : t('noBib');
                const bibClass = entry.bib === null ? 'no-bib' : '';
                const pointText = entry.point === 'S' ? t('start') : t('finish');
                
                return `
                <div class="result-row ${noBibClass} ${selectedClass}" data-id="${entry.id}">
                    <div class="result-checkbox ${isSelected ? 'checked' : ''}" onclick="toggleEntrySelection(${entry.id})">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                        </svg>
                    </div>
                    <div class="result-bib ${bibClass}" onclick="editBib(${entry.id})">${bibDisplayText}</div>
                    <div class="result-point" style="background: ${pointColors[entry.point]}; color: #fff;">${pointText}</div>
                    <div class="result-info">
                        <div class="result-time">${formatTime(entry.timestamp)}</div>
                        <div class="result-date">${formatDate(entry.timestamp)}</div>
                    </div>
                    <button class="result-delete" onclick="deleteEntry(${entry.id})">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                        </svg>
                    </button>
                </div>
            `}).join('');
        }

        function deleteEntry(id) {
            entries = entries.filter(e => e.id !== id);
            selectedEntries.delete(id);
            updateResults();
            vibrate(20);
        }

        function toggleSelectMode() {
            isSelectMode = !isSelectMode;
            selectedEntries.clear();
            
            const selectBtn = document.getElementById('select-btn');
            const selectBar = document.getElementById('select-bar');
            
            if (isSelectMode) {
                selectBtn.classList.add('active');
                selectBar.style.display = 'flex';
            } else {
                selectBtn.classList.remove('active');
                selectBar.style.display = 'none';
            }
            
            updateSelectCount();
            updateResults();
            vibrate(15);
        }

        function toggleEntrySelection(id) {
            if (!isSelectMode) return;
            
            if (selectedEntries.has(id)) {
                selectedEntries.delete(id);
            } else {
                selectedEntries.add(id);
            }
            
            updateSelectCount();
            updateResults();
            vibrate(10);
        }

        function updateSelectCount() {
            const count = selectedEntries.size;
            document.getElementById('select-count').textContent = language === 'de' ? `${count} ausgewählt` : `${count} selected`;
        }

        function selectAll() {
            entries.forEach(e => selectedEntries.add(e.id));
            updateSelectCount();
            updateResults();
            vibrate(15);
        }

        function selectNone() {
            selectedEntries.clear();
            updateSelectCount();
            updateResults();
            vibrate(15);
        }

        function deleteSelected() {
            if (selectedEntries.size === 0) return;
            entries = entries.filter(e => !selectedEntries.has(e.id));
            selectedEntries.clear();
            updateSelectCount();
            updateResults();
            vibrate([20, 30, 20]);
        }

        let editingEntryId = null;

        function editBib(id) {
            if (isSelectMode) return;
            
            const entry = entries.find(e => e.id === id);
            if (!entry) return;
            
            editingEntryId = id;
            const modal = document.getElementById('edit-modal');
            const input = document.getElementById('edit-bib-input');
            const subtitle = document.getElementById('edit-modal-time');
            
            input.value = entry.bib !== null ? entry.bib : '';
            subtitle.textContent = formatTime(entry.timestamp);
            
            modal.classList.add('show');
            setTimeout(() => input.focus(), 100);
            vibrate(15);
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('show');
            editingEntryId = null;
            vibrate(10);
        }

        function saveEditBib() {
            if (editingEntryId === null) return;
            
            const input = document.getElementById('edit-bib-input');
            const newBib = input.value.trim();
            
            const entry = entries.find(e => e.id === editingEntryId);
            if (entry) {
                if (newBib === '' || isNaN(parseInt(newBib))) {
                    entry.bib = null;
                } else {
                    const bibNum = parseInt(newBib);
                    entry.bib = bibNum > 0 && bibNum <= 999 ? bibNum : null;
                }
            }
            
            closeEditModal();
            updateResults();
            vibrate([15, 20, 15]);
        }

        document.getElementById('edit-bib-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') saveEditBib();
            else if (e.key === 'Escape') closeEditModal();
        });

        // Race name editing
        function editRaceName() {
            const modal = document.getElementById('race-name-modal');
            const input = document.getElementById('race-name-input');
            
            input.value = raceName;
            modal.classList.add('show');
            setTimeout(() => {
                input.focus();
                input.select();
            }, 100);
            vibrate(15);
        }

        function closeRaceNameModal() {
            document.getElementById('race-name-modal').classList.remove('show');
            vibrate(10);
        }

        function saveRaceName() {
            const input = document.getElementById('race-name-input');
            const newName = input.value.trim();
            
            if (newName) {
                raceName = newName;
                localStorage.setItem('skiTimerRaceName', raceName);
                document.getElementById('current-race-name').textContent = raceName;
            }
            
            closeRaceNameModal();
            vibrate([15, 20, 15]);
        }

        document.getElementById('race-name-input').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') saveRaceName();
            else if (e.key === 'Escape') closeRaceNameModal();
        });

        function exportCSV() {
            const exportableEntries = entries.filter(e => e.bib !== null);
            if (exportableEntries.length === 0) return;
            
            const formatISO8601 = (date) => {
                const pad = (n, len = 2) => String(n).padStart(len, '0');
                const tzOffset = -date.getTimezoneOffset();
                const tzSign = tzOffset >= 0 ? '+' : '-';
                const tzHours = pad(Math.floor(Math.abs(tzOffset) / 60));
                const tzMins = pad(Math.abs(tzOffset) % 60);
                return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}.${pad(date.getMilliseconds(), 3)}${tzSign}${tzHours}:${tzMins}`;
            };
            
            let csv = 'Bib,Timestamp,TimingPoint\n';
            const sortedEntries = [...exportableEntries].sort((a, b) => a.timestamp - b.timestamp);
            
            sortedEntries.forEach(entry => {
                const bib = String(entry.bib).padStart(3, '0');
                const timestamp = formatISO8601(entry.timestamp);
                const point = entry.point === 'S' ? 'Start' : 'Finish';
                csv += `${bib},${timestamp},${point}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `ski-race-times_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            vibrate([20, 30, 20]);
        }

        function toggleSetting(el) {
            el.classList.toggle('on');
            vibrate(15);
        }

        function toggleAutoIncrement(el) {
            el.classList.toggle('on');
            autoIncrement = el.classList.contains('on');
            vibrate(15);
        }

        function simulateGPSSync() {
            const dot = document.getElementById('settings-gps-dot');
            const status = document.getElementById('settings-gps-status');
            
            dot.style.background = 'var(--gps-searching)';
            dot.style.boxShadow = '0 0 8px var(--gps-searching)';
            status.textContent = t('gpsSyncing');
            
            setTimeout(() => {
                dot.style.background = 'var(--gps-active)';
                dot.style.boxShadow = '0 0 8px var(--gps-active)';
                status.textContent = t('gpsSynced');
                vibrate([20, 30, 50]);
            }, 1500);
            
            vibrate(15);
        }

        function vibrate(pattern) {
            if ('vibrate' in navigator) navigator.vibrate(pattern);
        }

        // Initialize
        updateBibDisplay();
        updateLanguage();
        updateResults();
        document.getElementById('current-race-name').textContent = raceName;

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('ServiceWorker registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            });
        }
    </script>
</body>
</html>
